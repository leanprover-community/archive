[
    {
        "content": "<p>What's  <del>m_foreach</del>S_foreach in <a href=\"https://github.com/leanprover/lean4/blob/master/tests/compiler/foreign/myfuns.cpp\">sample code</a> supposed to be? Only two clues is at <a href=\"https://github.com/leanprover/lean4/blob/eb170d1f43e8d30d0149aef0ede2d7c31d5f2a08/src/runtime/object.cpp#L502\">here</a> and <a href=\"https://github.com/leanprover/lean4/blob/eb170d1f43e8d30d0149aef0ede2d7c31d5f2a08/src/runtime/object.cpp#L574\">here</a>.</p>\n<p>edit: I mess up variable name. m_each is in <a href=\"https://github.com/leanprover/lean4/blob/master/src/include/lean/lean.h\">lean.h</a> which is assigned S_foreach in sample.</p>",
        "id": 285535657,
        "sender_full_name": "He-chien Tsai",
        "timestamp": 1654782032
    },
    {
        "content": "<p>I don't see a use of <code>m_foreach</code> in the sample code you linked. However, if you are just generally curious, <code>m_foreach</code> is a field of <code>lean_external_class</code> that is used to iterate over the nested lean objects in an Lean external object. For example, if the struct you are wrapping has fields that are Lean objects (i.e., of type <code>lean_object</code>) you would provide a <code>foreach</code> method that  invokes the passed  function (i.e., the <code>b_lean_obj_arg</code>  on the each of those fields).</p>",
        "id": 285558961,
        "sender_full_name": "Mac",
        "timestamp": 1654791370
    },
    {
        "content": "<p>I mess up variables in original post, edited. In sample code, lean_register_external_class assigns S_finalize and S_foreach to m_finalize and m_foreach at <a href=\"https://github.com/leanprover/lean4/blob/eb170d1f43e8d30d0149aef0ede2d7c31d5f2a08/src/runtime/object.cpp#L2178\">here</a>, but the only two lines which call m_foreach don't explicitly show what's m_foreach supposed to do, sample code literally do nothing. What's S_foreach in sample code supposed to do if it has nested objects?</p>",
        "id": 285622650,
        "sender_full_name": "He-chien Tsai",
        "timestamp": 1654827958
    },
    {
        "content": "<p>Here is a quick example. If you have a structure with nested Lean objects you want to wrap:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Foo</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">bar</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">baz</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">};</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Your foreach function would look like:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">Foo_foreach</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">lean_apply_1</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">Foo</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">foo</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">bar</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">lean_apply_1</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">Foo</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">foo</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">baz</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The point of this function is to allow the object manager to apply properties (e.g., persistence, multi-threading) to nested lean objects within the wrapped struct.</p>",
        "id": 285627715,
        "sender_full_name": "Mac",
        "timestamp": 1654833199
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120163\">He-chien Tsai</span> has marked this topic as resolved.</p>",
        "id": 285628045,
        "sender_full_name": "Notification Bot",
        "timestamp": 1654833553
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120163\">He-chien Tsai</span> has marked this topic as unresolved.</p>",
        "id": 285628205,
        "sender_full_name": "Notification Bot",
        "timestamp": 1654833710
    },
    {
        "content": "<p>That's clear. Thanks for your help.</p>",
        "id": 285628212,
        "sender_full_name": "He-chien Tsai",
        "timestamp": 1654833716
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120163\">He-chien Tsai</span> has marked this topic as resolved.</p>",
        "id": 285628214,
        "sender_full_name": "Notification Bot",
        "timestamp": 1654833720
    }
]