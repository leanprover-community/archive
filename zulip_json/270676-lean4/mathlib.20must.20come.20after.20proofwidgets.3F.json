[
    {
        "content": "<p>I came across some strange behavior. To reproduce, make a fresh Lean4 project with the following lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">Â«</span><span class=\"n\">foo</span><span class=\"bp\">Â»</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Settings applied to both builds and interactive editing</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"o\">âŸ¨</span><span class=\"ss\">`pp.unicode.fun</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">âŸ©,</span><span class=\"w\"> </span><span class=\"c1\">-- pretty-prints `fun a â†¦ b`</span>\n<span class=\"w\">    </span><span class=\"o\">âŸ¨</span><span class=\"ss\">`pp.proofs.withType</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">âŸ©</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add any additional package configuration options here</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span>\n<span class=\"w\">  </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"proofwidgets\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"v0.0.48\"</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"bp\">Â«</span><span class=\"n\">Foo</span><span class=\"bp\">Â»</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add any library configuration options here</span>\n</code></pre></div>\n<p>and <code>leanprover/lean4:v4.15.0-rc1</code> as the toolchain. Running <code>lake exe cache get</code> clones the deps as expected, but then fails (very slowly!) to download the cache. If I put <code>proofwidgets</code> ahead of <code>mathlib</code> in the dependencies, then it works as expected. Is this a known issue?</p>",
        "id": 487144296,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733798352
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span></p>",
        "id": 487174370,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1733813793
    },
    {
        "content": "<p>The failure is curious (and needs ome debugging on my end), but I do question why you are requiring ProofWidgets at all when Mathlib already depends on it?</p>",
        "id": 487174791,
        "sender_full_name": "Mac Malone",
        "timestamp": 1733814003
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> what I actually have is a project <code>A</code> that depends on proofwidgets and a project <code>B</code> that depends on <code>A</code> and on mathlib. If proofwidgets is replaced by such an <code>A</code> then you should get a similar failure</p>",
        "id": 487222276,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733829369
    },
    {
        "content": "<p>I think that non-linear package dependencies graphs are simply not supported by lake.</p>",
        "id": 487222931,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1733829568
    },
    {
        "content": "<p>I would hope that's not the case! But you may need to spend a bit of effort to make the versions match up</p>",
        "id": 487223673,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733829788
    },
    {
        "content": "<p>Yes I did make sure to use the same version of proofwidgets in <code>A</code> as the one used in mathlib (same goes for the toolchain)</p>",
        "id": 487223919,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733829860
    },
    {
        "content": "<p>Then I'm out of my depth :)</p>",
        "id": 487224023,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733829902
    },
    {
        "content": "<p>By not supported I mean not supported unless a miracle makes every version match exactly.</p>",
        "id": 487229497,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1733831572
    },
    {
        "content": "<p>Well, in this case the versions all matched, but this strange issue still occurred.</p>",
        "id": 487230189,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733831780
    },
    {
        "content": "<p>By the way, it seems that <code>proofwidgets</code> has something to do with it. If I try to do the same thing with <code>batteries</code> then there are no issues at all.</p>",
        "id": 487230669,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733831930
    },
    {
        "content": "<p>Possible relevant factors are that there is <a href=\"https://github.com/leanprover-community/mathlib4/blob/bfdd6039bf11a194e78a351b27e21774684a016e/Cache/Requests.lean#L163\">special handling</a> for <code>proofwidgets</code> in the Cache binary, but not for Batteries (as far as I can see). <code>proofwidgets</code> also uses the Lake cloud release feature whereas Batteries does not.</p>",
        "id": 487238747,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1733834386
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> I have found the problem! ProofWidgets and mathlib require different versions of batteries. The order of the dependences in the lake file determines whether Lake ends up using mathlib's or ProofWidget's. In the example case, Lake prefers ProofWidget's over Mathlib's (and the opposite is true in the reverse order).</p>",
        "id": 487345406,
        "sender_full_name": "Mac Malone",
        "timestamp": 1733866697
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 487346798,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1733867265
    },
    {
        "content": "<p>Nice sleuthing!</p>",
        "id": 487352311,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733870168
    },
    {
        "content": "<p>so it seems Patrick was right...</p>",
        "id": 487362033,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733875729
    },
    {
        "content": "<p>This seems very hard to avoid, because Mathlib wants to update to essentially every commit on Batteries <code>master</code>, whereas ProofWidgets wants to update as necessary (or I guess at least monthly when it moves to a new toolchain).</p>",
        "id": 487362521,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733876026
    },
    {
        "content": "<p>Looking forward to being able to specify this (i.e. that ProofWidgets doesn't care much, but Mathlib does) in the lakefiles. :-)</p>",
        "id": 487362615,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733876073
    }
]