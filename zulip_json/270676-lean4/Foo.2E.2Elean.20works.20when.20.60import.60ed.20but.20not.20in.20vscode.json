[
    {
        "content": "<p>If I create <code>MyProject/Foo..lean</code> by accident, then when opened in VSCode the extension complains it can't find <code>MyProject/Foo.lean</code>. However, I can <code>import MyProject.«Foo.»</code> in a downstream file and everything is happy there.</p>",
        "id": 529702293,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753032738
    },
    {
        "content": "<p>Hopefully no sane person would intentionally add this extra <code>.</code>, but an error message that tells me Lean is trying to read a different file to the one I have open in VSCode is very confusing.</p>",
        "id": 529702369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753032814
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lake.modOfFilePath#doc\">docs#Lake.modOfFilePath</a> seems to be the culprit</p>",
        "id": 530446561,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753311716
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, do you know if anything would break if the logic changed to \"just strip the last extension\"?</p>",
        "id": 530446594,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753311734
    },
    {
        "content": "<p>I ran into this again today with some filenames of the form <code>Section_1.1.lean</code></p>",
        "id": 530446682,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753311812
    },
    {
        "content": "<p>Does it even make sense to call this function on any extension other than <code>.lean</code>?</p>",
        "id": 530446922,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753311979
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> The opposite choice has its own problems. For example, <code>modOfFilePath \"Foo/Bar.olean.server\"</code> will return <code> `Foo.Bar.olean </code>, which is definitely not desirable.</p>",
        "id": 530446954,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753312007
    },
    {
        "content": "<p>What if the caller specified the relevant extension?</p>",
        "id": 530447028,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312058
    },
    {
        "content": "<p>Or is the idea that the caller is just the command line recieving an arbitrary file?</p>",
        "id": 530447071,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312094
    },
    {
        "content": "<p>In which case, it seems like you could drop extensions until you hit something in a known list of lean extensions, and fail with \"not a module\" otherwise</p>",
        "id": 530447091,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312121
    },
    {
        "content": "<p>I guess the other way to fix this would be for the vscode extension to compute a module name rather than asking lake to guess it</p>",
        "id": 530447156,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312171
    },
    {
        "content": "<p>I think that dots in a file name (that do not indicate extensions) or a module name (as they already carry a special meaning) should not be encouraged or well-supported. More informative error messages; however, would certainly be nice.</p>",
        "id": 530447326,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753312295
    },
    {
        "content": "<p>I suspect it is easier to make this work than it is to make it propagate an error back to the vscode editor</p>",
        "id": 530447377,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312325
    },
    {
        "content": "<p>I am bit confused how the function leads to this error.</p>",
        "id": 530447767,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753312594
    },
    {
        "content": "<p>vscode is passing the full path to the file, then currently <code>Section_1.1.lean</code> is being stripped into the module name <code>Section_1</code></p>",
        "id": 530447797,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312621
    },
    {
        "content": "<p>That I understand. I am confused, though, why that would cause an error. Lean/Lake and the server can sitll work on files that are not recognized modules.</p>",
        "id": 530448003,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753312755
    },
    {
        "content": "<p>What does \"recognized module\" mean?</p>",
        "id": 530448028,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312777
    },
    {
        "content": "<p>The failure happens during <code>setup-file</code>, in case that helps</p>",
        "id": 530448064,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753312796
    },
    {
        "content": "<p>One should be able to edit a file with any name with the Lean extension. For example, one can create a file called <code>foo..baz</code> and still edited it with Lean. Producing a incorrect module name should not cause an error.</p>",
        "id": 530448341,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753312959
    },
    {
        "content": "<p>(From a quick test, it works for me.)</p>",
        "id": 530448465,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313037
    },
    {
        "content": "<p>My guess is that something is saying \"this ends in .lean so must be a module\", and then something else is saying \"Whoops I screwed up the name and the module doesn't exist)</p>",
        "id": 530448472,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313041
    },
    {
        "content": "<p>Does <code>foo..baz.lean</code> work for you, inside a lean project?</p>",
        "id": 530448499,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313055
    },
    {
        "content": "<p>Yes, both <code>foo..baz.lean</code> and <code>foo..lean</code> work for me.</p>",
        "id": 530448555,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313092
    },
    {
        "content": "<p>While Lake may not correctly deduce the desired module name, it should just fall back to its default support for arbitrary files (i.e., the approach it uses for untitled VS Code files).</p>",
        "id": 530448735,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313214
    },
    {
        "content": "<p>Well, I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">`/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">gitpod</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.22.0-rc3/bin/lake setup-file /workspace/my_repo/MyProject/Paper/foo..baz.lean - --no-build --no-cache` failed:</span>\n\n<span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">QuadraticAndBilinear</span><span class=\"bp\">.</span><span class=\"n\">Paper</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"o\">:</span><span class=\"n\">setup</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">my_repo</span><span class=\"bp\">/</span><span class=\"n\">MyProject</span><span class=\"bp\">/</span><span class=\"n\">Paper</span><span class=\"bp\">/</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">MyProject</span><span class=\"bp\">.</span><span class=\"n\">Paper</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"o\">:</span><span class=\"n\">setup</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">All</span><span class=\"w\"> </span><span class=\"n\">Messages</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 530448787,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313237
    },
    {
        "content": "<p>Maybe this is fixed in the nightly</p>",
        "id": 530448903,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313301
    },
    {
        "content": "<p>No. The problem here is that the <code>foo...baz.lean</code> file is within a library directory. I forgot the Lake's filter here doesn't actually verify if a module within a library exists (in <code>findModule?</code>) -- it just checks for the right prefix.</p>",
        "id": 530449098,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313433
    },
    {
        "content": "<p>In that case, I think you are right, stripping exactly <code>.lean</code> from the module name is the most correct solution here (in <code>LeanLib.findModuleBySrc?</code>). As it will always add back exactly that extension.</p>",
        "id": 530449327,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313615
    },
    {
        "content": "<p>Hard-coding that <code>findModuleBySrc?</code> and not removing extensions at all in <code>modOfFilePath</code> seems like my probable fix.</p>",
        "id": 530449483,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313724
    },
    {
        "content": "<p>Perhaps <code>modOfFilePath</code> should be renamed to <code>modOfFilePathStem</code> or something in that case?</p>",
        "id": 530449555,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313765
    },
    {
        "content": "<p>Or <code>modOfFileStem</code>. A rename sounds good.</p>",
        "id": 530449618,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753313814
    },
    {
        "content": "<p>Are you describing a change that is now (low?) on your TODO list, or saying that this is too niche an issue for you to spend any time on and telling me how to make a PR?</p>",
        "id": 530449716,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753313893
    },
    {
        "content": "<p>Good point! I didn't make that very clear, did i? This is an issue I should be able to address quickly. Feel free to file issue if you would like to get a notification when I close it with a PR.</p>",
        "id": 530450084,
        "sender_full_name": "Mac Malone",
        "timestamp": 1753314151
    }
]