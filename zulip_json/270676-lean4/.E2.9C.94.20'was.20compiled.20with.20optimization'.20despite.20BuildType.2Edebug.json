[
    {
        "content": "<p>A lake project with debug enabled (<code>buildType := BuildType.debug</code> in lean_exe, lean_lib and package) seem to compile binaries with optimization.</p>\n<p>When debugging the binary using lldb, I get the following message:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>warning: leanclang was compiled with optimization - stepping may behave oddly; variables may not be available.\n</code></pre></div>\n<p>And indeed variables seem to have been optimized away and useless. </p>\n<p>I do see lake using <code>-Og -g</code> when compiling the generated .c files, but still ...:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">yuri</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---nightly/bin/leanc -c -o ././.lake/build/ir/Clang/CXSourceLocation.c.o.export ././.lake/build/ir/Clang/CXSourceLocation.c -Og -g -DLEAN_EXPORTING</span>\n</code></pre></div>\n<p>Is there something obvious I am missing?</p>",
        "id": 462563403,
        "sender_full_name": "Yuri",
        "timestamp": 1723732267
    },
    {
        "content": "<p>Well, I am using Nix: <code>/nix/store/wsgvg07q93xmaqp6ln58kzr75rg6jm40-clang-wrapper-16.0.6/bin/clang</code>, which links to a wrapper that is adding <code>-O2 -U_FORTIFY_SOURCE</code>  to the clang execution ...</p>\n<p>So this sounds unrelated to lake. If anyone has an idea of how to make Nix be less opinionated for a debug build, let me know.</p>",
        "id": 462566346,
        "sender_full_name": "Yuri",
        "timestamp": 1723733171
    },
    {
        "content": "<p>For the record, it is possible to disable Nix's hardening with <code>NIX_HARDENING_ENABLE</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nv\">NIX_DEBUG</span><span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"nv\">NIX_HARDENING_ENABLE</span><span class=\"o\">=</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n</code></pre></div>",
        "id": 462569365,
        "sender_full_name": "Yuri",
        "timestamp": 1723734069
    },
    {
        "content": "<p>Unfortunately, I still get the :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanclang</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">compiled</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">optimization</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">stepping</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">behave</span><span class=\"w\"> </span><span class=\"n\">oddly</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">variables</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">available</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 462569800,
        "sender_full_name": "Yuri",
        "timestamp": 1723734132
    },
    {
        "content": "<p>At the very least, the stdlib is of course still compiled with optimizations this way. What is your goal here? Having access to the C variables of a Lean program is hardly useful usually</p>",
        "id": 462572458,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723734748
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> , I have been working a lot with FFI and dealing with related issues at this boundary. For this reason I took a tangent and I am creating custom Lean lldb formatter(s) and synthetic provider(s) for all Lean runtime objects precisely to be able to \"see\" these variables in the debugger automatically. I am now in the process of testing this.</p>",
        "id": 462573625,
        "sender_full_name": "Yuri",
        "timestamp": 1723735086
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/270676-lean4/topic/'was.20compiled.20with.20optimization'.20despite.20BuildType.2Edebug/near/462572458\">said</a>:</p>\n<blockquote>\n<p>At the very least, the stdlib is of course still compiled with optimizations this way. What is your goal here? Having access to the C variables of a Lean program is hardly useful usually</p>\n</blockquote>\n<p>The specific motivation was when I was changing the libclang's <code>visitChildren</code> binding to be in a custom monad instead of IO so I could thread my own stack through the callback:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">CXCursorVisitor</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLiftT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cursor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CXCursor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CXCursor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">CXChildVisitResult</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"shim_clang_visitChildren\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">CXCursor</span><span class=\"bp\">.</span><span class=\"n\">visit</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLiftT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cursor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CXCursor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">visitor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">CXCursorVisitor</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">inst1</span><span class=\"w\"> </span><span class=\"n\">inst2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n</code></pre></div>\n<p>The generated code included more arguments including an extra closure, which raised the complexity of the generated code a bit (at least for me).</p>",
        "id": 462576509,
        "sender_full_name": "Yuri",
        "timestamp": 1723735783
    },
    {
        "content": "<blockquote>\n<p>I am creating custom Lean lldb formatter(s) and synthetic provider(s) for all Lean runtime objects precisely to be able to \"see\" these variables in the debugger automatically</p>\n</blockquote>\n<p>I already have versions of these for things like <code>lean::expr</code> and <code>lean::array_ref</code>, let me see if I can share them</p>",
        "id": 462577317,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723735996
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/'was.20compiled.20with.20optimization'.20despite.20BuildType.2Edebug/near/462577317\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>I am creating custom Lean lldb formatter(s) and synthetic provider(s) for all Lean runtime objects precisely to be able to \"see\" these variables in the debugger automatically</p>\n</blockquote>\n<p>I already have versions of these, let me see if I can share them</p>\n</blockquote>\n<p>I have seen the ones in the Lean repo, and a bunch of others from Rust, Zig, Swift etc for inspiration. But happy to take a look at yours! Thanks</p>",
        "id": 462577935,
        "sender_full_name": "Yuri",
        "timestamp": 1723736164
    },
    {
        "content": "<p>The lean repo only has <a href=\"https://github.com/leanprover/lean4/blob/master/src/bin/lean-gdb.py\">the gdb ones</a>, right?</p>",
        "id": 462578046,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723736178
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/'was.20compiled.20with.20optimization'.20despite.20BuildType.2Edebug/near/462578046\">said</a>:</p>\n<blockquote>\n<p>The lean repo only has the gdb ones, right?</p>\n</blockquote>\n<p>Both.</p>",
        "id": 462578113,
        "sender_full_name": "Yuri",
        "timestamp": 1723736188
    },
    {
        "content": "<p>Where's the lldb one?</p>",
        "id": 462578410,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723736240
    },
    {
        "content": "<p>I guess if you want to show synthetic provides for user-defined <code>inductive</code>s then you need something rather more sophisticated than the gdb script (or my lldb port of it)</p>",
        "id": 462578770,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723736297
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/'was.20compiled.20with.20optimization'.20despite.20BuildType.2Edebug/near/462578410\">said</a>:</p>\n<blockquote>\n<p>Where's the lldb one?</p>\n</blockquote>\n<p>Scratching my head here ... I remember seeing one, but maybe I copied there? This is the one I <strong>thought</strong> was in the Lean4 sources:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">lldb</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">is_scalar</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">box</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">SBValue</span><span class=\"bp\">.</span><span class=\"n\">CreateValueFromExpression</span><span class=\"o\">(</span><span class=\"n\">None</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">((</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"o\">)(</span><span class=\"bp\">%</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unbox</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">to_cnstr</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">lean_ctor_object'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">())</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_tag</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_tag'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">unsigned</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_cnstr_tag</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">get_tag</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">lean_object'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">()))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_num_objs</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_other'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">unsigned</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_rc</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_rc'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">unsigned</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_cnstr_obj_arg</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">lean_ctor_object'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_objs'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetChildAtIndex</span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_closure_arg</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">lean_closure_object'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_objs'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetChildAtIndex</span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">get_c_str</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">lean_string_object'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">GetChildMemberWithName</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">m_data'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">FindFirstType</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">char'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">GetPointerType</span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">GetSummary</span><span class=\"o\">()</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">LeanObjectPrinter</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"Print a lean_object object.\"\"\"</span>\n\n<span class=\"w\">    </span><span class=\"n\">kinds</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">ctor'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">closure'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_arity'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_fun'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_num_fixed'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">array'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_size'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_capacity'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">sarray'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_size'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_capacity'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">string'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_size'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_capacity'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_length'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">mpz'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_value'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">thunk'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_value'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_closure'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">task'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_value'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_imp'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">ref'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_value'</span><span class=\"o\">]),</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">external'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"n\">m_class'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">m_data'</span><span class=\"o\">]),</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">lean_max_ctor_tag</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">244</span>\n</code></pre></div>",
        "id": 462579020,
        "sender_full_name": "Yuri",
        "timestamp": 1723736375
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/'was.20compiled.20with.20optimization'.20despite.20BuildType.2Edebug/near/462578770\">said</a>:</p>\n<blockquote>\n<p>I guess if you want to show synthetic provides for user-defined <code>inductive</code>s then you need something rather more sophisticated than the gdb script (or my lldb port of it)</p>\n</blockquote>\n<p>Yes, we don't have enough runtime metadata  to get 100% visibility (e.g. no way to show scalars in a constructors, just whether there are or arent any scalars). But it goes a long way already with just formatters and synthetic providers.</p>",
        "id": 462579533,
        "sender_full_name": "Yuri",
        "timestamp": 1723736539
    },
    {
        "content": "<p>This is what I have already (barred obvious bugs), and I am now working on showing synthetic children for boxed fields in constructors, fixed arguments in closures, Thunk's value, Array data, etc:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000130788dd0</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Ctor</span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"bp\">|</span><span class=\"n\">RC</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">objs</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">scalars</span><span class=\"bp\">=</span><span class=\"n\">true</span>\n<span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000000000001</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Box</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000000000001</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Box</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000141ee9b68</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Ctor</span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"bp\">|</span><span class=\"n\">RC</span><span class=\"bp\">=∞</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">objs</span><span class=\"bp\">=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">scalars</span><span class=\"bp\">=</span><span class=\"n\">false</span>\n<span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000130788ec0</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Clos</span><span class=\"bp\">|</span><span class=\"n\">RC</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x130788ec8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arity</span><span class=\"bp\">=</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num_fixed</span><span class=\"bp\">=</span><span class=\"mi\">2</span>\n<span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000141ee9b50</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Clos</span><span class=\"bp\">|</span><span class=\"n\">RC</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x141ee9b58</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arity</span><span class=\"bp\">=</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num_fixed</span><span class=\"bp\">=</span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 462579811,
        "sender_full_name": "Yuri",
        "timestamp": 1723736660
    },
    {
        "content": "<p>BTW, the <code>NIX_HARDENING_ENABLE=\"\"</code> worked and I got debug info in the .o files. The issue now seems to be a difference between debugging using straight lldb or using codelldb (does not work as well).</p>",
        "id": 462580086,
        "sender_full_name": "Yuri",
        "timestamp": 1723736774
    },
    {
        "content": "<p>One oddity I am seeing is that LLDB cannot find the <code>lean_string_object</code> typedef even though it can find all the other lean_object subtypes (e.g. <code>lean_ctor_object</code> etc).</p>\n<p>I have built the executable with both a release version and a debug version of lean, but LLDB can never find the <code>lean_string_object</code> type. I am using <code>lldb.target.FindFirstType('lean_string_object')</code>.</p>\n<p>Any ideas why that is the case?</p>",
        "id": 462843145,
        "sender_full_name": "Yuri",
        "timestamp": 1723835619
    },
    {
        "content": "<p>I finally was able to get it to a point it seems stable and reasonably useful.</p>\n<p>Here is an example of a debugging session showing different types of runtime objects.</p>\n<p><a href=\"/user_uploads/3121/EoOQUjJpLmqOONFgnAxXQD8P/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/EoOQUjJpLmqOONFgnAxXQD8P/image.png\" title=\"image.png\"><img data-original-dimensions=\"2050x1026\" src=\"/user_uploads/thumbnail/3121/EoOQUjJpLmqOONFgnAxXQD8P/image.png/840x560.webp\"></a></div>",
        "id": 462871046,
        "sender_full_name": "Yuri",
        "timestamp": 1723852053
    },
    {
        "content": "<p>Ref Counting:</p>\n<ul>\n<li><code>{1}</code>, <code>{3}</code>: single-threaded object</li>\n<li><code>{-1}</code>: multi-threaded object </li>\n<li><code>{∞}</code>: persistent object</li>\n</ul>\n<p>[size/capacity]:</p>\n<ul>\n<li>[3/4]</li>\n<li>[3/3]</li>\n</ul>",
        "id": 462871423,
        "sender_full_name": "Yuri",
        "timestamp": 1723852420
    },
    {
        "content": "<p>Happy to make improvements, if you have specific ideas. For now, I will move on ...</p>",
        "id": 462871499,
        "sender_full_name": "Yuri",
        "timestamp": 1723852487
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> has marked this topic as resolved.</p>",
        "id": 462871505,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723852492
    },
    {
        "content": "<p>This may have an audience of one :-), but just in case here is the project: <a href=\"https://github.com/ydewit/lean-lldb\">lean-lldb</a>.</p>",
        "id": 462976296,
        "sender_full_name": "Yuri",
        "timestamp": 1723897724
    }
]