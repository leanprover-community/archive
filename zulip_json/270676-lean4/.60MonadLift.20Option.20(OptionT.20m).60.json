[
    {
        "content": "<p>Should this instance exist?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pure</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OptionT</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>",
        "id": 469097834,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725976227
    },
    {
        "content": "<p>It would mean being able to write <code>none</code> instead of <code>failure</code> for a failure. I'm not sure if that is more convenient or confusing. Appart from this I'm not sure what this instance would be useful for.</p>\n<p>I presume you mean to add a <code>MonadLiftT</code> instance, not <code>MonadLift</code>.</p>",
        "id": 469531917,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726104593
    },
    {
        "content": "<p>The motivation here was being able to use <code>f : Option A</code> within <code>OptionM</code>, without having to write <code>let x ← mk &lt;| pure &lt;| f</code> which is rather a mouthful</p>",
        "id": 469617785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726134151
    },
    {
        "content": "<p>That seems reasonable. This would add an extra step in the type class search for stuff like <code>read</code> inside <code>OptionT MetaM</code>, but that should be no problem.</p>",
        "id": 469627000,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726136403
    },
    {
        "content": "<p>The equivalent instance for <code>Except</code> does already exist: <code>MonadLift (Except ε) (ExceptT ε m)</code>, so I think the <code>Option</code> analogue would be  a good addition.</p>",
        "id": 469632935,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726137974
    },
    {
        "content": "<p>A more general version does exist in Lake:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OptionT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>This is the instance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Alternative</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLiftT</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n</code></pre></div>\n<p>By the way I always confuse <code>MonadLift</code> and <code>MonadLiftT</code>, but <code>MonadLift</code> is the one that should be used for declaring the instances, and <code>MonadLiftT</code> for using the resulting transitive closure instances.</p>",
        "id": 469632948,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726137980
    },
    {
        "content": "<p>I guess a similar instance could exist for <code>MonadExceptOf</code> and <code>Except</code>?</p>",
        "id": 469635610,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726138645
    },
    {
        "content": "<p>Do you think that instance should be instead of or in addition to <code>MonadLift (Except ε) (ExceptT ε m)</code>?</p>",
        "id": 469640159,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726139706
    },
    {
        "content": "<p>I don't think it really matters</p>",
        "id": 469673197,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726147191
    },
    {
        "content": "<p>This would be the instance I think:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pure</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>\n<p>this instance seems a bit troublesome to me because during type class search for <code>MonadLiftT m o</code>, it creates the sub-goal <code>MonadLift ?n o</code>. So an instance of <code>MonadLift</code> where the second argument can be anything will always be applicable, so it would need a <code>low</code> priority. Type class search would be more efficient with an instance like <code>MonadLift (Except ε) (ExceptT ε m)</code> for every <code>ExceptT</code>-like monad transformer. Additionally having separate instances like that would always get the outer <code>ExceptT</code> if there were multiple in a monad stack, instead of the innermost one.</p>",
        "id": 469682247,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726149021
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/stream/270676-lean4/topic/.60MonadLift.20Option.20.28OptionT.20m.29.60/near/469682247\">said</a>:</p>\n<blockquote>\n<p>Additionally having separate instances like that would always get the outer <code>ExceptT</code> if there were multiple in a monad stack, instead of the innermost one.</p>\n</blockquote>\n<p>I believe this already happens for most of the monad-related typeclasses that Lean uses.</p>",
        "id": 469687408,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726150281
    },
    {
        "content": "<p>Yes, and that is desirable, but I claim that <code>instance (priority := low) [MonadExceptOf ε m] [Pure m] : MonadLift (Except ε) m</code> would cause this to go backwards.</p>",
        "id": 469687831,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726150401
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 469688521,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726150588
    },
    {
        "content": "<p>Nevermind, the instance does work with any of the <code>ExceptT</code> in a stack of multiple, since TC search goes through all options anyways.</p>",
        "id": 469691776,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726151319
    },
    {
        "content": "<p>But there is an inefficiency in the search because of how <code>MonadExceptOf</code> itself can be lifted through <code>StateT</code>, <code>ReaderT</code> and <code>ExceptT</code>. (But the lean4 tabled type class search algorithm makes this not too bad)</p>",
        "id": 469695403,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1726152115
    },
    {
        "content": "<p>I just encountered the lack of <code>MonadLift Option (OptionT m)</code> the other day. would it still make sense to add?</p>",
        "id": 570352735,
        "sender_full_name": "Mai",
        "timestamp": 1769528123
    },
    {
        "content": "<p>If I have <code>f : Option A</code> instide an <code>OptionT</code>, I tend to just write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n</code></pre></div>\n<p>instead of trying to lift <code>f</code>, which, if we add the right instance, would look like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n<p>I think the first option is clearer.</p>",
        "id": 570353861,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1769528395
    },
    {
        "content": "<p>Should we add a linter that warns you if you try to create <code>MonadLift m n</code> if there's <code>Alternative m</code> instance? With the explanation that <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>'s idea is preferred syntax.</p>",
        "id": 570359572,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769529693
    },
    {
        "content": "<p>Having a special linter just for this may be a bit overkill</p>",
        "id": 570361282,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1769530047
    },
    {
        "content": "<p>That's a bad idea Jakub, since some alternative monads have richer failure info that that discards</p>",
        "id": 570379351,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769534539
    }
]