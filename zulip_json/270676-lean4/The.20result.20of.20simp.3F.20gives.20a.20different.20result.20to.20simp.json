[
    {
        "content": "<p>Here's my mathlib-free mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nothing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">nothing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">nothing</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">S</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo_zero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp?</span>\n</code></pre></div>\n<p>The goal after <code>simp</code> or <code>simp?</code> is of the form <code>∃ S, _ ∧ nothing S ∧ _</code>, but the goal after applying the code action is of the form <code>∃ S, nothing S ∧ _ ∧ _</code>.</p>",
        "id": 469236324,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726013264
    },
    {
        "content": "<p>What does <code>simp?</code> say?</p>",
        "id": 469256096,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726021353
    },
    {
        "content": "<p>Creating an issue from this would be useful!</p>",
        "id": 469256115,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726021365
    },
    {
        "content": "<p>Expanding the <code>simp?</code> says <code>simp only [exists_prop', nonempty_prop, exists_and_left]</code></p>",
        "id": 469307686,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726040096
    },
    {
        "content": "<p><code>exists_and_left</code> isn't necessary but it's believable that it's used somewhere</p>",
        "id": 469309021,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726040424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/The.20result.20of.20simp.3F.20gives.20a.20different.20result.20to.20simp/near/469256115\">said</a>:</p>\n<blockquote>\n<p>Creating an issue from this would be useful!</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/5308\">lean4#5308</a></p>",
        "id": 469311497,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726040995
    },
    {
        "content": "<p>Oof: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">forall_const</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>looks like a bad idea!</p>",
        "id": 469315671,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726041885
    },
    {
        "content": "<p>(It applies everywhere, and generates a <code>Nonempty \\a</code> goal, and then if <code>\\a</code> is a Prop that simplifies to just <code>\\a</code>.)</p>",
        "id": 469315898,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726041946
    },
    {
        "content": "<p>Hmm, I agree that looks like a bad idea but how do we know that that's responsible here?</p>",
        "id": 469317343,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726042336
    },
    {
        "content": "<p>I thought <code>exists_prop'</code> is the thing generating the Nonempty bits</p>",
        "id": 469317435,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726042359
    },
    {
        "content": "<p><code>set_option trace.Meta.Tactic.simp true</code></p>",
        "id": 469317516,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726042379
    },
    {
        "content": "<p>exists_prop' is generating <code>Nonempty</code> is a good way that we like: the rhs of the simp lemma</p>",
        "id": 469317754,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726042438
    },
    {
        "content": "<p><code>forall_const</code> is generating it as a side goal</p>",
        "id": 469317844,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726042448
    },
    {
        "content": "<p>I agree <code>forall_const</code> is getting applied and a bunch of side goals like this are getting generated and this is a bad simp lemma, but turning it off doesn't fix the actual issue here; so I don't see how it's actually the culprit</p>",
        "id": 469318322,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726042546
    },
    {
        "content": "<p>Agreed, but I'm now distracted by fixing <code>forall_const</code>, which I suspect is an even bigger problem. :-)</p>",
        "id": 469318606,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726042593
    }
]