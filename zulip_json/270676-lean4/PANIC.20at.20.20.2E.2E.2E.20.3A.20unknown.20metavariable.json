[
    {
        "content": "<p>While working on a file in VSCode (Lean4 VS Code Extension v0.0.206,  Lean v4.20.0), I keep seeing messages of the form</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>PANIC at Lean.MetavarContext.getLevelDepth Lean.MetavarContext:874:14: unknown metavariable\n</code></pre></div>\n<p>in a pop-up window. The backtrace is rather long and begins like this:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>backtrace</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_panic+0xf5) [0x7fd90d50d295]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_panic_fn+0x15) [0x7fd90d50d475]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_SynthInstance_MkTableKey_normLevel+0x352) [0x7fd90794d9a2]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_List_mapM_loop___at_Lean_Meta_SynthInstance_MkTableKey_normExpr___spec__2+0x13b) [0x7fd90794f70b]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_SynthInstance_MkTableKey_normExpr+0x1a3) [0x7fd90794fa43]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_SynthInstance_MkTableKey_normExpr+0x752) [0x7fd90794fff2]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_SynthInstance_mkTableKey___at_Lean_Meta_SynthInstance_main___spec__1+0xe4) [0x7fd9079a4474]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_SynthInstance_main___lambda__2+0x9c) [0x7fd9079a500c]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_3+0xbac) [0x7fd90d51dc3c]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Core_withCurrHeartbeats___at_Lean_Meta_SynthInstance_main___spec__3+0x24) [0x7fd9079a4be4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_synthInstance_x3f___lambda__2+0x260) [0x7fd9079b7d00]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0x8cc) [0x7fd90d521f6c]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_Basic_0__Lean_Meta_withNewMCtxDepthImp___rarg+0x447) [0x7fd9076c84e7]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_withNewMCtxDepth___at_Lean_Meta_matchesInstance___spec__1___rarg+0x1f) [0x7fd90780c6ff]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_synthInstance_x3f___lambda__4+0x12f2) [0x7fd9079b92e2]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0x8cc) [0x7fd90d521f6c]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_withTraceNode___at_Lean_Meta_synthInstance_x3f___spec__4+0x2eb) [0x7fd9079b72fb]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_synthInstance_x3f___lambda__5+0x1f4) [0x7fd9079c2204]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_1+0xe2f) [0x7fd90d5195ff]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg___lambda__1+0xe) [0x7fd90c7ed27e]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg___lambda__1___boxed+0x9) [0x7fd90c7ed509]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_1+0xb5f) [0x7fd90d51932f]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_profileit+0x83) [0x7fd90d206c43]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_profileitIOUnsafe___rarg+0x64) [0x7fd90c7ed3e4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_synthInstance_x3f+0x162) [0x7fd9079c24f2]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___lambda__1+0xa0) [0x7fd9079c46c0]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___lambda__3+0x12c0) [0x7fd9079c67c0]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0xa70) [0x7fd90d522110]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_Basic_0__Lean_Meta_withMVarContextImp___rarg+0x203) [0x7fd9076cc053]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_MVarId_withContext___at___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___spec__2___rarg+0x17) [0x7fd9079c43b7]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_synth_pending+0x4c2) [0x7fd9079c80b2]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__1___lambda__2+0xb1) [0x7fd907912ee1]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__1+0x754) [0x7fd9079145f4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__2+0x5a9) [0x7fd907917029]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0x8cc) [0x7fd90d521f6c]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1+0x2e4) [0x7fd907851ad4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure+0x1ef) [0x7fd90791803f]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__1+0xe8c) [0x7fd9079353fc]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__2+0x2256) [0x7fd907938306]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive+0xb6a) [0x7fd907939d8a]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_isExprDefEqAuxImpl___lambda__3+0x295b) [0x7fd90794256b]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0x5e6) [0x7fd90d521c86]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1+0x2e4) [0x7fd907851ad4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_is_expr_def_eq+0x621) [0x7fd90782f9a1]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_checkpointDefEq___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqApp___spec__1+0xe6e) [0x7fd907924bbe]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqApp+0x1ea) [0x7fd90792d0da]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__1+0x1e1) [0x7fd907934751]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__2+0x2256) [0x7fd907938306]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive+0xb6a) [0x7fd907939d8a]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_Meta_isExprDefEqAuxImpl___lambda__3+0x295b) [0x7fd90794256b]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_apply_5+0x5e6) [0x7fd90d521c86]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1+0x2e4) [0x7fd907851ad4]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(lean_is_expr_def_eq+0x621) [0x7fd90782f9a1]<br>\n/home/mstoll/.elan/toolchains/leanprover--lean4---v4.20.0/lib/lean/libleanshared.so(l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqLeft___lambda__1+0x26) [0x7fd9078e2626]<br>\n(etc.)</p>\n</div></div>\n<p>Is this a known problem?</p>",
        "id": 522998864,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749414368
    },
    {
        "content": "<p>Can you provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 522999640,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749415627
    },
    {
        "content": "<p>Not right now (I've finished working and will go to bed...).<br>\nIt seems to occur while typing; maybe it tries to make sense of some partially typed thing, which triggers the error.</p>",
        "id": 522999689,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749415721
    },
    {
        "content": "<p>That's the same error as reported in <a href=\"#narrow/channel/287929-mathlib4/topic/.E2.9C.94.20Crash.20in.20.60sup.60.2F.60inf.60.20.2F.20.60max.60.2F.60min.60.20delaborators\">#mathlib4 &gt; âœ” Crash in &#96;sup&#96;/&#96;inf&#96; / &#96;max&#96;/&#96;min&#96; delaborators</a>.</p>\n<p>It means that there is a universe level metavariable in an expression that isn't in the metavariable context. That particular case was fixed by a PR I did to lean, meaning that it would be fixed in v4.21.0. Did your example by any chance involve the <code>max</code> or <code>min</code> function and a rewrite tactic?</p>",
        "id": 523006195,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749425561
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/PANIC.20at.20.20.2E.2E.2E.20.3A.20unknown.20metavariable/near/523006195\">said</a>:</p>\n<blockquote>\n<p>Did your example by any chance involve the <code>max</code> or <code>min</code> function and a rewrite tactic?</p>\n</blockquote>\n<p>That's very well possible; the proof I was working on involves <code>Finset.sup'</code> and also <code>max</code>. Rewrites occur in the proof. But just stepping through the finished proof does not produce the PANIC; I'm quite positive that it happened while editing.</p>",
        "id": 523051925,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749459797
    },
    {
        "content": "<p>The error should only appear when the cursor is on a lemma that involves max, within a rewrite tactic.</p>",
        "id": 523079072,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749471139
    },
    {
        "content": "<p>I can't tell if it's the same problem with only the first part of the trace</p>",
        "id": 523079487,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749471328
    },
    {
        "content": "<p>but it certainly looks similar</p>",
        "id": 523079504,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749471338
    },
    {
        "content": "<p>It just occurred again, when I put the cursor right before the <code>]</code> in <code>rw [this.map_max]</code>, so it really looks like it is the same error.</p>",
        "id": 523345642,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749578929
    }
]