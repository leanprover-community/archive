[
    {
        "content": "<p>I'm digging around <code>Lean.Parser</code> and trying to get individual parsers to work. Some of these work with empty contexts and environments, but not <code>categoryParserFn</code>. What do I need to initialize to, e.g., have <code>ParserFn.run (categoryParserFn ``command)</code> parse <code>def mynat : Nat := 2</code>?</p>",
        "id": 484384059,
        "sender_full_name": "nrs",
        "timestamp": 1732566434
    },
    {
        "content": "<p>you need to run the initializer for <code>Lean</code></p>",
        "id": 484392562,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732570116
    },
    {
        "content": "<p>this populates the global tables used by the parser</p>",
        "id": 484392612,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732570141
    },
    {
        "content": "<p>the way you run the initializer depends on how you got yourself in a situation where they haven't been run yet</p>",
        "id": 484392696,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732570174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20to.20pass.20to.20.60categoryParserFn.60.20for.20it.20to.20work.3F/near/484392696\">said</a>:</p>\n<blockquote>\n<p>the way you run the initializer depends on how you got yourself in a situation where they haven't been run yet</p>\n</blockquote>\n<p>I see thanks a lot for the answer! what parts of source should I look at to learn how the initializer is ran or how it works? (the easy way out is to use the fact that the initializer has in fact been ran and that I have a working environment I'm importing Lean.Parser in, but I want to understand the internals better)</p>",
        "id": 484393625,
        "sender_full_name": "nrs",
        "timestamp": 1732570615
    },
    {
        "content": "<p>The parser table is not stored in the environment, so once you have run the initializer it will work even in the empty environment</p>",
        "id": 484394141,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732570819
    },
    {
        "content": "<p>this is important, because otherwise lean would not be able to parse <code>Prelude.lean</code>, the first lean file</p>",
        "id": 484394193,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732570844
    },
    {
        "content": "<p>Because these are \"builtin parsers\", they are run as part of the function <code>initialize_Lean</code> which runs all the initializers. The way these function calls ended up in this function is a bit convoluted, but goes via the <code>@[builtin_init]</code> attribute and a bootstrap stage</p>",
        "id": 484394641,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732571040
    },
    {
        "content": "<p>but the starting point is the use of <code>@[builtin_command_parser]</code> e.g. <a href=\"https://github.com/leanprover/lean4/blob/606aeddf067ca0b4bb110ee157ec4a6672d93373/src/Lean/Parser/Command.lean#L489\">here</a></p>",
        "id": 484394847,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732571133
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20to.20pass.20to.20.60categoryParserFn.60.20for.20it.20to.20work.3F/near/484394141\">said</a>:</p>\n<blockquote>\n<p>The parser table is not stored in the environment, so once you have run the initializer it will work even in the empty environment</p>\n</blockquote>\n<p>hm, I am however getting a kernel panic from the following (crude I know) code. Other parsers that do not depend on something else than the context's input, such as <code>strLitFnAux</code>, do successfully parse when called in this way</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkInputContext'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InputContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[])</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tempmain</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyenv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">mkEmptyEnvironment</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">emptyenv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyTrie</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Trie</span><span class=\"w\"> </span><span class=\"n\">Token</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Trie</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyTokenCacheEntry</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TokenCacheEntry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserCache</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserCache</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">emptyTokenCacheEntry</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">emptyParserCache</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">categoryParserFn</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkInputContext'</span><span class=\"w\"> </span><span class=\"s2\">\"def mynat : Nat := 2\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"n\">emptyTrie</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">stxStack</span><span class=\"bp\">.</span><span class=\"n\">toSubarray</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">tempmain</span>\n</code></pre></div>",
        "id": 484395060,
        "sender_full_name": "nrs",
        "timestamp": 1732571235
    },
    {
        "content": "<p>Using the current env instead (from <code>/tests</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withCurrentEnv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"w\"> </span><span class=\"s2\">\"def mynat : Nat := 2\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n</code></pre></div>",
        "id": 484399001,
        "sender_full_name": "nrs",
        "timestamp": 1732573011
    },
    {
        "content": "<p>I will be removing each piece of the environment until I figure out the critical objects for this to work, will report back (but do let me know if I should be focusing on something!)</p>",
        "id": 484400261,
        "sender_full_name": "nrs",
        "timestamp": 1732573606
    },
    {
        "content": "<p>The following works and seems to be the minimal initialization necessary to make <code>categoryParserFn</code> work</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tempmain</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">makeEmptyEnvironment</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pcache</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserCache</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">initCacheForInput</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">pcache</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">categoryParserFn</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"s2\">\"def mynat : Nat := 2\"</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getTokenTable</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">stxStack</span><span class=\"bp\">.</span><span class=\"n\">toSubarray</span>\n</code></pre></div>",
        "id": 484412895,
        "sender_full_name": "nrs",
        "timestamp": 1732580304
    },
    {
        "content": "<p>oh yes, the initial token table comes from the global state I mentioned, but the parser itself carries (non-global) state so it can handle files that change the parser in the middle of the file</p>",
        "id": 484481845,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732617549
    }
]