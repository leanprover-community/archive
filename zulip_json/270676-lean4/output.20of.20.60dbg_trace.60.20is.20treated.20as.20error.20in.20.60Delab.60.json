[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"dbg trace\"</span>\n\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`fooDelab</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 490298237,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1734787100
    },
    {
        "content": "<p>When the above code is run on VSCode, the output of <code>dbg_trace</code> seems to be treated as an error.<br>\nWhat is the correct way to do print debugging in <code>Delab</code>?</p>",
        "id": 490298263,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1734787129
    },
    {
        "content": "<p>You can see the output, right? Is there any problem with it being treated as an error?</p>",
        "id": 490319550,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734806051
    },
    {
        "content": "<p>I wonder why this is treated as an error.</p>",
        "id": 490338680,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1734822993
    },
    {
        "content": "<p>Is this intended behavior? Is this a bug?<br>\nI think the output of dbg_trace should not be treated as an error…</p>",
        "id": 490338825,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1734823165
    },
    {
        "content": "<p>In the web editor the output doesn't seem to appear at all</p>",
        "id": 490339650,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734823931
    },
    {
        "content": "<p>use VSCode and see output in the terminal window.</p>",
        "id": 490339705,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1734823987
    },
    {
        "content": "<p><code>dbg_trace</code> outputs directly to stderr. This is a perfectly fine way to output debug messages.</p>",
        "id": 490340859,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734825032
    },
    {
        "content": "<p>Isn't there now a mechanism to capture stderr and pipe it to the infoview? I guess delaborators live outside this if so.</p>",
        "id": 490341291,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734825493
    },
    {
        "content": "<p>Maybe there are other mechanisms too, but the one I know about, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.FS.withIsolatedStreams#doc\">docs#IO.FS.withIsolatedStreams</a> (used by <code>#eval</code> for example), runs the value and yields the entire output at the end.</p>\n<p>I think this sort of defeats the purpose of <code>dbg_trace</code> though, since this means you can't get any debug information until the end of a computation. Plus, there's a larger chance that the logging information will be dropped along the way in case there's an error. You're depending on all the monads in the stack to get the messages to the InfoView, and recall that there have been bugs here before, which makes debugging particularly challenging. (For example, <code>#eval</code> used to drop all log messages for the MetaM monad until recently. I think <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.liftCommandElabM#doc\">docs#Lean.liftCommandElabM</a> too was dropping messages.)</p>",
        "id": 490346711,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734831029
    }
]