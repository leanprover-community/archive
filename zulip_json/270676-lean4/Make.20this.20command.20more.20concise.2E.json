[
    {
        "content": "<p>I have written a command to assert theorem does not depend on Classical.choice.</p>\n<p>Can this command be made more concise? <code>elab</code> or <code>elab_rules</code> command is useful for this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">detectClassicalOf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">constName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAxioms</span><span class=\"w\"> </span><span class=\"n\">constName</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' does not depend on any axioms\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">caxes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Name.isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Classical</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">caxes.isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' is non-classical and depends on axioms: {axioms.toList}\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' depends on classical axioms: {caxes.toList}\"</span>\n\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">:=</span><span class=\"n\">detectClassical</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"#detect_classical \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">detectClassical</span><span class=\"bp\">»</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">elabDetectClassical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstWithInfos</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">    </span><span class=\"n\">cs.forM</span><span class=\"w\"> </span><span class=\"n\">detectClassicalOf</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"sd\">/-- info: 'Nat.add_zero' does not depend on any axioms -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.add_zero</span>\n\n<span class=\"sd\">/-- info: 'Nat.div_add_mod' is non-classical and depends on axioms: [propext] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.div_add_mod</span>\n\n<span class=\"sd\">/-- info: 'Nat.log2' is non-classical and depends on axioms: [propext] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.log2</span>\n</code></pre></div>",
        "id": 463763148,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1724174399
    },
    {
        "content": "<p>In Lean3 we had an attribute-based implementation, <a href=\"https://github.com/leanprover-community/mathlib/pull/10954\">!3#10954</a></p>",
        "id": 463780292,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724178960
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> it sounds nice. why mathlib4 doesn't have such an attribute?</p>",
        "id": 464184243,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1724279453
    },
    {
        "content": "<p>This is more concise veresion.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#detect_classical \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">constName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAxioms</span><span class=\"w\"> </span><span class=\"n\">constName</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' does not depend on any axioms\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">caxes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Name.isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Classical</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">caxes.isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' is non-classical and depends on axioms: {axioms.toList}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' depends on classical axioms: {caxes.toList}\"</span>\n\n<span class=\"sd\">/-- info: 'Nat.add_zero' does not depend on any axioms -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.add_zero</span>\n\n<span class=\"sd\">/-- info: 'Nat.div_add_mod' is non-classical and depends on axioms: [propext] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.div_add_mod</span>\n\n<span class=\"sd\">/-- info: 'Nat.log2' is non-classical and depends on axioms: [propext] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">detect_classical</span><span class=\"w\"> </span><span class=\"n\">Nat.log2</span>\n</code></pre></div>",
        "id": 464185193,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1724279950
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/stream/270676-lean4/topic/Make.20this.20command.20more.20concise.2E/near/464184243\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> it sounds nice. why mathlib4 doesn't have such an attribute?</p>\n</blockquote>\n<p>I wrote a version of this command, but it wasn't useful at the time because lots and lots of things were unnecessarily classical. I'm pretty sure this is even more true now than then</p>",
        "id": 464186059,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724280439
    },
    {
        "content": "<p>Can we gradually erase unnecessarily used classical logic?</p>",
        "id": 464186256,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1724280546
    },
    {
        "content": "<p>I have no idea, last time I tried it I got a lot of irrationally strong pushback and I don't know if the mood has changed</p>",
        "id": 464186442,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724280630
    }
]