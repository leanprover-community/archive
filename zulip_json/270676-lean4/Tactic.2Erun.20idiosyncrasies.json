[
    {
        "content": "<p>I'm trying to benchmark a tactic I've been working on, but I've been running into issues where the function I use to evaluate my tactic gives different results from running the tactic in practice.</p>\n<p>Here is a minimal version of what I'm trying to do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testMyTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"c1\">-- Run `tac` on `goal`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Error: {← e.toMessageData.toString}\"</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n</code></pre></div>\n<p>I expect and intend for <code>testMyTactic</code> to run <code>tac</code> on <code>goal</code> and return <code>false</code> if and only if the tactic threw an error. But I've encountered situations where <code>tac</code> will work in practice but <code>testMyTactic</code> will claim it encountered an error. I describe one example of this more fully in <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Difference.20between.20Tactic.2Erun.20and.20actually.20running.20tactic\">#metaprogramming / tactics &gt; Difference between Tactic.run and actually running tactic</a>.</p>\n<p>What are the known differences in behavior between actually running a tactic in the environment and trying to test the behavior of a tactic using <code>Tactic.run</code>? Are there any gotchas I should know about regarding how I'm using <code>TermElabM.run</code> or <code>Tactic.run</code>?</p>",
        "id": 478126795,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729536231
    }
]