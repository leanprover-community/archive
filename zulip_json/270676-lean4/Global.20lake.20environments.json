[
    {
        "content": "<p>Right now there is a <code>.lake</code> directory for each project which if Mathlib is installed is 5GB.  Many package managers (conda, opam, etc) have both global and local options.  So you can either store everything locally like lake does, or have named global enironments like in conda and opam.  (I prefer local, but I know others prefer global if just to save space.) Lake doesn't currently have a good way to do global packages, right?</p>",
        "id": 495974821,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737904389
    },
    {
        "content": "<p>This question came up on <a href=\"https://proofassistants.stackexchange.com/questions/4647/mathlib-is-downloaded-every-time-a-new-project-is-created/4650\">https://proofassistants.stackexchange.com/questions/4647/mathlib-is-downloaded-every-time-a-new-project-is-created/4650</a>.  The question itself if poorly worded, but in the end this seems to be what they want.  They realized you can do <code>packagesDir = \"path/to/main/.lake/packages\"</code> in the lakefile.toml, but that also means you have to commit a directory path to git, something you don't have to do with other package managers.</p>",
        "id": 495974829,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737904395
    },
    {
        "content": "<p>You can also use symlinks, but those aren't exactly user-friendly.</p>",
        "id": 495974830,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737904400
    },
    {
        "content": "<p>I assume the answer is no, but if yes, feel free to post an answer to that question.</p>",
        "id": 495974833,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737904403
    },
    {
        "content": "<p>Lake support for a system-wide build cache of oleans is on the near-term roadmap (development is currently planned for next quarter). At present, however, <code>packagesDir</code>is the best solution. If I find the time, I could rework it to also support an enviroment vairable (e.g., <code>LAKE_PACKAGES_DIR</code>), which could avoid the need to commit it.</p>",
        "id": 496167546,
        "sender_full_name": "Mac Malone",
        "timestamp": 1737996275
    },
    {
        "content": "<p>For what the user is asking there, wouldn't a local mapping that sends <code>\"leanprover-community\" / \"mathlib\"</code> to <code>../some_mathlib_checkout</code> do the trick?</p>",
        "id": 496168081,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737996439
    },
    {
        "content": "<p>Which is to say, no olean cache or adjusted build directory is needed, just a way to use existing local dependencies</p>",
        "id": 496168159,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737996463
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> not sure what you mean.  Are you saying this is already possible?  And if so, how would it work?</p>",
        "id": 496169114,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737996734
    },
    {
        "content": "<p>I think there may be a separate feature in the pipeline that does what I describe, which is part of the motivation for the new-style <code>require</code>s in the lakefile. It is \"already possible\" today by checking out all of the mathlib dependencies, and editing the lakefiles as</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span>require \"leanprover-community\" / \"batteries\" @ git \"v4.15.0\"\n<span class=\"gi\">+  from \"../batteries\"</span>\n<span class=\"w\"> </span>require \"leanprover-community\" / \"aesop\" @ git \"v4.15.0\"\n<span class=\"gi\">+  from \"../aesop\"</span>\n</code></pre></div>\n<p>etc</p>",
        "id": 496169439,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737996838
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Is this much different from the packageDir approach?  It still requires putting local file system information in the lakefile.  I guess it has the advantage that one doesnâ€™t need a reference .lake directory.  (Also if you have no internet connection at all, maybe this would work.)</p>",
        "id": 496170397,
        "sender_full_name": "Jason Rute",
        "timestamp": 1737997103
    },
    {
        "content": "<p>Also, does one still use <code>lake exe cache get</code>, or will <code>lake build</code> just work?</p>",
        "id": 496180846,
        "sender_full_name": "Jason Rute",
        "timestamp": 1738000271
    },
    {
        "content": "<p>If you modify any lakefiles then <code>lake exe cache get</code> will reject any upstream cache</p>",
        "id": 496180933,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738000307
    },
    {
        "content": "<p>I believe that the modification I make above also causes <code>lake exe cache pack</code> to fail, as it ignores the lakefile / manifest and hard-codes the location of dependencies. <a href=\"https://github.com/leanprover-community/mathlib4/pull/8767\">#8767</a> was an attempt to fix this, but it is frustrating to test</p>",
        "id": 496181165,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738000375
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/Global.20lake.20environments/near/496168081\">said</a>:</p>\n<blockquote>\n<p>For what the user is asking there, wouldn't a local mapping that sends <code>\"leanprover-community\" / \"mathlib\"</code> to <code>../some_mathlib_checkout</code> do the trick?</p>\n</blockquote>\n<p>There is <a href=\"https://github.com/leanprover/lean4/pull/6411\">the new <code>--packages</code> option</a> which could be used to directly override dependencies, butit requires some more sophiticated know-how and is less than ideal for active development (e.g., it cannot be used with <code>lake update</code>). It is more intended for fixed system configurations (e.g., CIs, testbeds).</p>",
        "id": 496244882,
        "sender_full_name": "Mac Malone",
        "timestamp": 1738030054
    }
]