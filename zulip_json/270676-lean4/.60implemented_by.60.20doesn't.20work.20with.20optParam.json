[
    {
        "content": "<p>This should work, I think?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Invalid `implemented_by` argument `Nat.foo_impl`: `Nat.foo_impl` has type</span>\n<span class=\"sd\">  Nat → Nat → Nat</span>\n<span class=\"sd\">but `foo` has type</span>\n<span class=\"sd\">  Nat → optParam Nat 0 → Nat</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 564987132,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766404041
    },
    {
        "content": "<p>Probably, though this is currently a known limitation: it looks for an exact match (up to argument renaming). You can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 565079240,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1766443860
    },
    {
        "content": "<p>Unfortunately, that workaround doesn't work for autoParam.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Invalid `implemented_by` argument `Nat.foo_impl`: `Nat.foo_impl` has type</span>\n<span class=\"sd\">  Nat → autoParam Nat foo_impl._auto_1 → Nat</span>\n<span class=\"sd\">but `foo` has type</span>\n<span class=\"sd\">  Nat → autoParam Nat foo._auto_1 → Nat</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 565079721,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766444256
    },
    {
        "content": "<p>That's a bigger issue, but at least there's this workaround:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo_impl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">fooAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fooAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>\n<p>One way this could be fixed is if there were a cache of autoparam auxiliary definitions, beyond making <code>implemented_by</code> tolerate these <code>autoParam</code>/<code>optParam</code> gadgets (which would be reasonable to do).</p>",
        "id": 565081724,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1766446123
    },
    {
        "content": "<p>Is there a need for such cache? It doesn't seem very costly to convert function signature with {opt,auto}Param to one without them.</p>",
        "id": 565081919,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766446260
    },
    {
        "content": "<p>I'm just meaning to point out that the only reason <code>autoParam</code>s fail here is that the elaborator creates a fresh auxiliary definition for each <code>autoParam</code>. It's not unreasonable for the elaborator to cache these things, and there are some (very mild) performance reasons to do so.</p>\n<p>Certainly stripping the gadgets costs almost nothing. That involves touching <code>implemented_by</code> though, and someone would have to make sure that this doesn't break anything. It seems unlikely, but you never know.</p>",
        "id": 565093799,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1766460073
    },
    {
        "content": "<p>Isn't the auxiliary definition just Syntax object? Which you already obtain from parsing.</p>",
        "id": 565093950,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766460287
    },
    {
        "content": "<p>It might just be a Syntax object, but if so, by the logic I'm assuming you're invoking, doesn't that mean <code>implemented_by</code> should just work here? (This is a rhetorical question; if you're wanting to know the elaboration details of <code>autoParams</code>, I'm happy to point you to key areas of the implementation.)</p>",
        "id": 565094579,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1766461126
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60implemented_by.60.20doesn't.20work.20with.20optParam/near/565094579\">said</a>:</p>\n<blockquote>\n<p>I'm assuming you're invoking, doesn't that mean <code>implemented_by</code> should just work here?</p>\n</blockquote>\n<p>I think it doesn't work, because it check if types are exactly equal. But <code>Nat → autoParam Nat foo._auto_1 → Nat</code> and <code>Nat → autoParam Nat foo_impl._auto_1 → Nat</code> are only defeq.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60implemented_by.60.20doesn't.20work.20with.20optParam/near/565094579\">said</a>:</p>\n<blockquote>\n<p>This is a rhetorical question; if you're wanting to know the elaboration details of <code>autoParams</code>, I'm happy to point you to key areas of the implementation.</p>\n</blockquote>\n<p>I think that elaboration of <code>autoParam</code> doesn't matter for <code>[implemented_by]</code>, but I think you mean, that these elaboration details are important to understand the performance benefit of the cache you propose? I don't have any particular desire to look into it in detail, I think I'll just trust you. And I agree with you, that implementing the cache would also help to solve the issue with <code>implemented_by</code>.</p>",
        "id": 565096591,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766463425
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/.60implemented_by.60.20doesn't.20work.20with.20optParam/near/565093950\">said</a>:</p>\n<blockquote>\n<p>Isn't the auxiliary definition just Syntax object?</p>\n</blockquote>\n<p>Since you're not interested in the code itself, here's the key detail: the actual data stored in a definition in the Environment is an Expr. That means the elaborator needs to invoke the compiler to evaluate it as a Syntax object. (I think there are too many details in Lean to use the word \"just\" without justification. It's \"just\" a Syntax object in one sense, but it's also not \"just\" a Syntax object in another.)</p>\n<blockquote>\n<p>I think that elaboration of <code>autoParam</code> doesn't matter for <code>[implemented_by]</code></p>\n</blockquote>\n<p>It certainly does matter, as your example points out. The two solutions work from different directions:</p>\n<ol>\n<li>change <code>autoParam</code> elaboration to make sure same autoparams yield the same expressions;</li>\n<li>change <code>implemented_by</code> to work around <code>autoParam</code> elaboration by having it strip this gadget when comparing.</li>\n</ol>\n<p>The second one is conceptually better in a few ways, and gadget stripping is done frequently, but it'd take someone to evaluate the changes in the compiler.</p>\n<p>The first one only incidentally fixes it, and it probably would only work with <code>implemented_by</code> in the same module. It might be possible to even avoid ever needing to evaluate using the compiler (e.g. using an environment extension to store Syntax directly in oleans).</p>\n<p>Regarding 1: it should be seriously considered, since someone might say it's a bug that if there are autoParams then you can't write a syntactically-equal type. Regarding 2: it should be seriously considered, since someone (like you) might say it's a bug that if there are autoParams you can't use <code>implemented_by</code> directly, though this one has a workaround. The two solutions aren't mutually exclusive either, even if only one is needed for the immediate issue.</p>",
        "id": 565197214,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1766514037
    }
]