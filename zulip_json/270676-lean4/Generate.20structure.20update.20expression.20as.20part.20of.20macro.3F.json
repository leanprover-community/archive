[
    {
        "content": "<p>Hi! How can I generate the syntax for updating a field of a large structure (e.g. <code>{s with a := v}</code>) as part of a macro?</p>\n<p>For example, given this minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Person</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Person</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Foo\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">age</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>If I try this macro, I'll get a complaint that <code>ident</code> isn't where <code>structInstLVal</code> is expected:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"foo_update\"</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">({</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">})</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">Application type mismatch: The argument</span>\n<span class=\"cm\">  field</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  TSyntax `ident</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  TSyntax `Lean.Parser.Term.structInstLVal</span>\n<span class=\"cm\">in the application</span>\n<span class=\"cm\">  field.raw</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>And if I try casting <code>ident</code> to <code>structInstLVal</code>, I'll get an error at the expansion site:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"foo_update\"</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">({</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">})</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">rawOnError</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo_update</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"s2\">\"Bar\"</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">unexpected syntax</span>\n<span class=\"cm\">  [Error pretty printing syntax: parenthesize: uncaught backtrack exception. Falling back to raw printer.]</span>\n<span class=\"cm\">  (Term.structInst</span>\n<span class=\"cm\">   \"{\"</span>\n<span class=\"cm\">   [[`__src._@.Test.3767781306._hygCtx._hyg.8] \"with\"]</span>\n<span class=\"cm\">   (Term.structInstFields [(Term.structInstField `name [[] [] (Term.structInstFieldDef \":=\" [] (str \"\\\"Bar\\\"\"))])])</span>\n<span class=\"cm\">   (Term.optEllipsis [])</span>\n<span class=\"cm\">   []</span>\n<span class=\"cm\">   \"}\")</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Many thanks!!</p>",
        "id": 553226970,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1762071766
    },
    {
        "content": "<p>Always try annotating the type when errors occur:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"foo_update\"</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">({</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">field</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">})</span>\n</code></pre></div>",
        "id": 553228993,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1762073680
    },
    {
        "content": "<p>Omg thank you so much!!</p>\n<p>I didn't think of that because I didn't know what was going on underneath. I thought an <code>ident</code> was not a <code>structInstLVal</code> so I attempted to \"unwrap then rewrap\" it.</p>\n<p>Is this because there's some coercion from <code>ident</code> to <code>structInstLVal</code> that won't kick in without the explicit annotation?</p>",
        "id": 553230449,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1762074975
    },
    {
        "content": "<p>Well it's because <code>structInstLVal</code> is a node containing a lot of things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">structInstLVal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">fieldIdx</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">structInstArrayRef</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">many</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\".\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">fieldIdx</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">structInstArrayRef</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>when parsing, it will take the outermost antiquotation unless specified otherwise, so it expected a syntax for <code>structInstLVal</code> but if you specify <code>ident</code> you force it to instead create a <code>structInstLVal</code> node containing the identifier you provided. In other words, what you specify after the <code>:</code> can determine which part of the syntax will be filled in. For example, you could also specify <code>$field:fieldIdx</code> which would make it instead fill in the <code>fieldIdx</code> part of the <code>structInstLVal</code> syntax and then you'd need to also provide syntax of type <code>fieldIdx</code>.<br>\nOne common misconception is also that the macro would be able to tell you need an identifier because of type of <code>field</code> - this is not the case since antiquotations are (and need to be) parsed completely before any kind of elaboration, in other words, nothing is known about the types of things at that point. But while parsing the antiquotation it already decided exactly where to put it and what type it should have. That means that if it then turns out to have a different type then it guessed, you'll get an error. Instead, you need to tell it the information that <code>field</code> is an identifier explicitly so it can know that while parsing.</p>",
        "id": 553231466,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1762075962
    },
    {
        "content": "<p>Thank you for the thorough explanation!</p>",
        "id": 553232020,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1762076351
    }
]