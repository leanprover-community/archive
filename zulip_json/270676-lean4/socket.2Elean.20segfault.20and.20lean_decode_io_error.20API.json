[
    {
        "content": "<p>Hi! I'm trying to play around with sockets in lean. I'm using <a href=\"https://github.com/hargoniX/socket.lean\">this library</a></p>\n<p>Here's my main:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Socket</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withUnixSocket</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"bp\">.</span><span class=\"n\">SockAddrUnix</span><span class=\"bp\">.</span><span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"n\">path</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">stream</span>\n<span class=\"w\">  </span><span class=\"n\">sock</span><span class=\"bp\">.</span><span class=\"n\">connect</span><span class=\"w\"> </span><span class=\"n\">addr</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"n\">sock</span>\n\n<span class=\"w\">  </span><span class=\"n\">sock</span><span class=\"bp\">.</span><span class=\"n\">close</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sockPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"/home/james/tmp/lean-timer-socket\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">withUnixSocket</span><span class=\"w\"> </span><span class=\"n\">sockPath</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"socket connected\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdout</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"end\"</span>\n</code></pre></div>\n<p>Running this results in a segfault.</p>\n<p>Looking at the implementation of <code>socket.lean</code>, it seems like it uses alloy. Is there a way to have alloy compile with debugging symbols so that I can try to figure out what's going on?</p>",
        "id": 448495276,
        "sender_full_name": "James Sully",
        "timestamp": 1719892201
    },
    {
        "content": "<p>Ah, it was because I was trying to connect to a nonexistent socket. <code>touch</code>ing <code>/home/james/tmp/lean-timer-socket</code> changes it from a segfault to an exception.</p>\n<p>github issue here: <a href=\"https://github.com/hargoniX/socket.lean/issues/14\">https://github.com/hargoniX/socket.lean/issues/14</a></p>",
        "id": 448504839,
        "sender_full_name": "James Sully",
        "timestamp": 1719897667
    },
    {
        "content": "<p>The segfault seems to occur, as some error messages are seemingly unable to cope with having no file name around (others again are unable to cope with having a file name around) in the implementation of error decoding. Your error specifically goes to this branch <a href=\"https://github.com/leanprover/lean4/blob/554e7234330cf06efffe0cb52092e783a27561cc/src/runtime/io.cpp#L175\">https://github.com/leanprover/lean4/blob/554e7234330cf06efffe0cb52092e783a27561cc/src/runtime/io.cpp#L175</a> which then presumably segfaults on the assertion.</p>\n<p>I'm a little curious as to why we simply crash if a file name is not provided/provided. This would assume on the one hand  knowledge of both the internal behaviors as well as the errors you are potentially about to throw. In particular there might be cases where you throw both file and not file related errros so you have to branch on <code>errno</code> yourself. This makes the trivial fix of \"just supply a file name if you are a sockaddr_un\" a bit too wonky for me because who knows maybe the socket API is able to throw other errors that trigger segfaults <em>with</em> a file name provided :/</p>\n<p>Maybe <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> can shine some light on these decisions?</p>",
        "id": 448518075,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719903308
    },
    {
        "content": "<p>Haha thanks, I was just up to there in my digging in. <br>\nI think in this case there ought to be a path - errno is 2 - <code>ENOENT</code>, so it seems like <code>socket.lean</code> should provide the path that's missing. <br>\nI guess you're talking about a separate issue to that</p>",
        "id": 448518284,
        "sender_full_name": "James Sully",
        "timestamp": 1719903433
    },
    {
        "content": "<p>One thing I'm a little confused by: wouldn't an assert crash cleanly, rather than segfaulting?</p>",
        "id": 448520868,
        "sender_full_name": "James Sully",
        "timestamp": 1719904145
    },
    {
        "content": "<p>src/runtime/debug.h:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">lean_assert</span><span class=\"o\">(</span><span class=\"n\">COND</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">DEBUG_CODE</span><span class=\"o\">({</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LEAN_UNLIKELY</span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"n\">COND</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">notify_assertion_violation</span><span class=\"o\">(</span><span class=\"bp\">__</span><span class=\"n\">FILE__</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">LINE__</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">COND</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">invoke_debugger</span><span class=\"o\">()</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">}})</span>\n</code></pre></div>",
        "id": 448521268,
        "sender_full_name": "James Sully",
        "timestamp": 1719904270
    },
    {
        "content": "<p>src/include/lean/lean.h:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">LEAN_UNLIKELY</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">__</span><span class=\"n\">builtin_expect</span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>I'm not sure how to find <code>__builtin_expect</code>, so I can't really decipher what's going on here.</p>",
        "id": 448521848,
        "sender_full_name": "James Sully",
        "timestamp": 1719904530
    },
    {
        "content": "<p>I would assume <code>lean::notify_assertion_violation</code> would print something out, but I don't see it. Perhaps assertions are disabled in release builds, and it segfaults later due to continuing with invalid data?</p>",
        "id": 448522181,
        "sender_full_name": "James Sully",
        "timestamp": 1719904634
    },
    {
        "content": "<p>I know all this isn't super relevant to the matter at hand, I'm just taking this as a learning opportunity</p>",
        "id": 448522540,
        "sender_full_name": "James Sully",
        "timestamp": 1719904706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/270676-lean4/topic/Debugging.20alloy.20code/near/448518284\">said</a>:</p>\n<blockquote>\n<p>Haha thanks, I was just up to there in my digging in. <br>\nI think in this case there ought to be a path - errno is 2 - <code>ENOENT</code>, so it seems like <code>socket.lean</code> should provide the path that's missing. <br>\nI guess you're talking about a separate issue to that</p>\n</blockquote>\n<p>But is that generally a good idea? What if we also throw errors where the decode code assumes we have not passed a file name? If the assertion was enabled that would also be a bug.</p>",
        "id": 448524747,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719905158
    },
    {
        "content": "<p>Ahh, it took me a bit but I think I'm following you now.</p>",
        "id": 448526533,
        "sender_full_name": "James Sully",
        "timestamp": 1719905553
    },
    {
        "content": "<p>it does seem like there's an implicit expectation for the caller to check <code>errno</code> themselves and decide accordingly whether to provide <code>fname</code>, and you're saying <code>lean_decode_io_error</code> should be able to handle an <code>fname</code> even if it's redundant, so that callers don't have to do this check themselves?</p>",
        "id": 448526861,
        "sender_full_name": "James Sully",
        "timestamp": 1719905699
    },
    {
        "content": "<p>Yes</p>",
        "id": 448526956,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719905738
    },
    {
        "content": "<p>gotcha</p>",
        "id": 448526971,
        "sender_full_name": "James Sully",
        "timestamp": 1719905744
    }
]