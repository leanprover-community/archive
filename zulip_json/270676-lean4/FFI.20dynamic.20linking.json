[
    {
        "content": "<p>I'm trying to use Lean as a replacement for the way I use jupyter notebooks. A lot of things I do in jupyter notebooks are very hacky and involve printing files and running bash commands. One thing in particular I like to do is interactively dynamically link into libraries to explore them or explore compiling snippets of assembly or C. After a good couple days, I can't figure out how to do this in Lean. This is my best attempt.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">compile_C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeFile</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.c\"</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"gcc\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-c\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-o\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.o\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.c\"</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">stdout</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdout2</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"gcc\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-shared\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-o\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.so\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.o\"</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"c1\">--let dylib &lt;- Lean.Dynlib.load \"/tmp/leany.so\"</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">loadDynlib</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.so\"</span><span class=\"w\"> </span><span class=\"c1\">-- This will load the shared library</span>\n\n\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">compile_C</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">#</span><span class=\"s2\">\"</span>\n<span class=\"s2\">#include &lt;stdint.h&gt;</span>\n<span class=\"s2\">uint64_t l_myadd(uint64_t a, uint64_t b) {</span>\n<span class=\"s2\">return a + b;</span>\n<span class=\"s2\">}\"</span><span class=\"bp\">#</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"myadd\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">myadd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myadd</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"c1\">-- segafaults</span>\n</code></pre></div>\n<p>Suggestions? Maybe I need to split into multiple files? Or just impossible with the way lean compilation is set up? Super hacky segfault skirting solutions are fine for my purposes. This isn't and never will be production code. The hackier, the better really.</p>",
        "id": 526633688,
        "sender_full_name": "Philip Zucker",
        "timestamp": 1751383453
    },
    {
        "content": "<p>For future reference, my best understanding of the issue is that lean generates unboxing code when this is done in a separate file. Copying over such unboxing C code combined with <code>supportInterpreter = true</code> in my lakefile.toml seems to work. I'd guess this is using possibly unstable parts of C / linking mechanisms.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bash</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"bash\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-c\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"bp\">.</span><span class=\"n\">stdout</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"bp\">.</span><span class=\"n\">stderr</span>\n\n<span class=\"c1\">-- LEAN_EXPORTING is at least one way to make symbols global.</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">compile_C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeFile</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.c\"</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"w\">  </span><span class=\"n\">bash</span><span class=\"w\"> </span><span class=\"s2\">\"leanc -c -DLEAN_EXPORTING -fPIC -o /tmp/leany.o /tmp/leany.c\"</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">bash</span><span class=\"w\"> </span><span class=\"s2\">\"leanc -shared -o /tmp/leany.so /tmp/leany.o\"</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">loadDynlib</span><span class=\"w\"> </span><span class=\"s2\">\"/tmp/leany.so\"</span><span class=\"w\"> </span><span class=\"c1\">-- This will load the shared library</span>\n\n<span class=\"c1\">-- https://proofassistants.stackexchange.com/questions/4801/how-to-eval-a-ffi-function-in-vscode-in-lean-4</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">compile_C</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">#</span><span class=\"s2\">\"</span>\n<span class=\"s2\">#include &lt;stdint.h&gt;</span>\n<span class=\"s2\">#include &lt;lean/lean.h&gt;</span>\n<span class=\"s2\">LEAN_EXPORT uint64_t myadd(uint64_t a, uint64_t b) {</span>\n<span class=\"s2\">return a + b;</span>\n<span class=\"s2\">}</span>\n\n<span class=\"s2\">LEAN_EXPORT lean_object* l_myadd___boxed(lean_object* x_1, lean_object* x_2) {</span>\n<span class=\"s2\">_start:</span>\n<span class=\"s2\">{</span>\n<span class=\"s2\">uint64_t x_3; uint64_t x_4; uint64_t x_5; lean_object* x_6;</span>\n<span class=\"s2\">x_3 = lean_unbox_uint64(x_1);</span>\n<span class=\"s2\">lean_dec(x_1);</span>\n<span class=\"s2\">x_4 = lean_unbox_uint64(x_2);</span>\n<span class=\"s2\">lean_dec(x_2);</span>\n<span class=\"s2\">x_5 = myadd(x_3, x_4);</span>\n<span class=\"s2\">x_6 = lean_box_uint64(x_5);</span>\n<span class=\"s2\">return x_6;</span>\n<span class=\"s2\">}</span>\n<span class=\"s2\">}</span>\n<span class=\"s2\">\"</span><span class=\"bp\">#</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"myadd\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">myadd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myadd</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"c1\">-- Infoview returns 12</span>\n</code></pre></div>",
        "id": 527017847,
        "sender_full_name": "Philip Zucker",
        "timestamp": 1751554594
    }
]