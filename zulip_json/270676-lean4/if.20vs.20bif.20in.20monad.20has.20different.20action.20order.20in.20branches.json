[
    {
        "content": "<p>Consider the following monad code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">action_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">action_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">24</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">action_with_if</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"w\">    </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_2</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">action_with_bif</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">bif</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"w\">    </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_2</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>The expected behavior is that if <code>3 != 5</code>, then <code>action_1</code> and <code>action_2</code> would not run. <code>if</code> indeed does this. However, for <code>bif</code>, when I unfold <code>action_with_bif</code>, I see that <code>action_1</code> and <code>action_2</code> runs regardless of what the boolean condition evaluates to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">actions_are_equal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">action_with_if</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">action_with_bif</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">action_with_if</span>\n<span class=\"w\">    </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">action_with_bif</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>We can see that the goal is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift_1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_2</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">__</span><span class=\"n\">do_lift</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift_1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift_1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_2</span>\n<span class=\"w\">  </span><span class=\"n\">bif</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">__</span><span class=\"n\">do_lift</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">do_lift_1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This is already semantics difference here. If <code>3 != 5</code>, <code>action_1</code> and <code>action_2</code> shouldn't even run. I thought that <code>bif</code> (i.e. <code>cond</code>) is just a specialized <code>if</code>on <code>Bool</code>, so they should be exactly the same.</p>\n<p>Is this expected behavior? At the very least I think this is very counter-intuitive. Playground link <a href=\"https://live.lean-lang.org/#codez=CYUwZgBAhgxgLgSwPYDsD6BGCAuCBJAeXxThwF4IAHAVwCcQIAWAJgChRJZFU1md8ieEuSp0GzRq3bho8ZOgDuCOAAs0CSLkLFS2MqwgRgSA4YgaIAZghkKAVlOHVIFKPoQADI4ggANgGcGGncAChDABMJZbnQMAEoIAGoICKj5XljYqQ5UniVVNAAjCy1BYT1TY28iyGtbCAczCGdXYIYvRr9AtwYwyK40uMTkvrkeZgypZyR6AFsclH80KHo0EABHaihffn7c5TULCl3FfcLi/UMCgE9vahQwJF9gebQ8g7Bb+8fn49fT6u8/mmtCuQA\">here</a>.</p>",
        "id": 532501954,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754182314
    },
    {
        "content": "<p>I am slighly surprised at this</p>",
        "id": 532502152,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754182543
    },
    {
        "content": "<p>Regular <code>if then else</code> has special support in <code>do</code> notation (you can omit the <code>else</code> branch so it has to be doing something different) but for <code>bif</code> you can't omit the <code>else</code> branch so I think it might just be a term that's been coerced into the monad? Like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">action_with_bif</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">action_2</span><span class=\"o\">))))</span>\n</code></pre></div>\n<p>which would explain why <code>action_1</code> and <code>action_2</code> are lifted outside the <code>bif</code>.</p>",
        "id": 532502429,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754182841
    },
    {
        "content": "<p>From a user's perspective, I'm pretty sure someone will write incorrect code because of this given the documentation for <code>bif</code>/<code>cond</code> kind of says \"we're equivalent to <code>if</code> and you should prefer using us if you're comparing booleans\".</p>",
        "id": 532502569,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754182975
    },
    {
        "content": "<p>yeah I agree this is bad</p>",
        "id": 532502590,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754182994
    },
    {
        "content": "<p>just trying to figure out <em>why</em> it does this</p>",
        "id": 532502605,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754183013
    },
    {
        "content": "<p>It only works for <code>if</code> because the <code>do</code> notation macro has special support for <code>if</code>. Despite <code>bif</code> expanding to <code>cond</code> and <code>cond</code> having the <code>macro_inline</code> attribute, this expansion actually occurs as part of compilation, not in the elaborator. It wouldn't be too difficult for the <code>do</code> notation to support <code>bif</code> (and it probably should), but it would still not work for <code>cond</code>.</p>",
        "id": 532558823,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1754229015
    }
]