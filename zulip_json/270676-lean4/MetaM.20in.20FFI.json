[
    {
        "content": "<p>What would be the correct way to implement a function <code>f : A → MetaM B</code> in C? I'm guessing the signature would still be something like <code>lean_obj_res f(input: lean_obj_arg)</code>, so the <code>MetaM</code> state must be somewhere in <code>input</code> and the return value must somehow be correctly wrapped for <code>MetaM</code>. I know such infrastructure exists for the <code>IO</code> monad, but I don't understand how it works as, for example, the implementation of <code>lean_io_mk_world</code> looks very odd to me:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"nf\">lean_io_mk_world</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_box</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p><a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>: I'm trying to call type class synthesis from C.</p>",
        "id": 489204340,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734346503
    },
    {
        "content": "<p>No, the signature would be much longer, if you take a look at the <code>IO</code> functions in FFI you will see they always take a last parameter that is ignored. This parameter is the IO world parameter. Similarly all <code>MetaM</code> functions are desugared to C functions using the rules <a href=\"https://lean-lang.org/lean4/doc/dev/ffi.html\">here</a>. You'll end up with a function that takes the Meta Context, Meta State, Core Context, Core State and world parameter so 5 additional parameters.</p>\n<blockquote>\n<p>: I'm trying to call type class synthesis from C.</p>\n</blockquote>\n<p>That's not going to be trivially possible, type class synthesis has no stable <code>export</code> name so you will not be able to find the symbol consistently across changes, why do you want to do this?</p>",
        "id": 489205290,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1734346785
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/MetaM.20in.20FFI/near/489205290\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>: I'm trying to call type class synthesis from C.</p>\n</blockquote>\n<p>That's not going to be trivially possible, type class synthesis has no stable <code>export</code> name so you will not be able to find the symbol consistently across changes, why do you want to do this?</p>\n</blockquote>\n<p>I guess I worded that poorly. I'm trying to call a Lean function <code>f : String → MetaM Bool</code> from C, where <code>f</code> needs to run type class synthesis. Is that possible, or does that suffer from the exact problem you mention here?</p>",
        "id": 489205958,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734346972
    },
    {
        "content": "<p>Do you have an <code>Environent</code> to do that synthesis within?</p>",
        "id": 489206307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734347066
    },
    {
        "content": "<p>Or phrased another way; what monad are you morally in when you want to make the call from C; what state do you have around?</p>",
        "id": 489206370,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734347088
    },
    {
        "content": "<p>if you give that function a stable symbol and you have access to all the things that constitute a Meta state or the sufficient data to construct a meta state that works yes</p>",
        "id": 489206383,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1734347093
    },
    {
        "content": "<p>I guess I should explain my situation in more detail.<br>\nI want to write a Lean function <code>f : A → MetaM B</code> which is implemented by a C function <code>g</code> which needs to be able to call a Lean function <code>h : String → MetaM Bool</code> which can run type class synthesis. So my guess was that I probably need to pass around a bunch of state from <code>f</code> through <code>g</code> to <code>h</code> and back. Does that sound sensible?</p>",
        "id": 489206946,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734347227
    },
    {
        "content": "<p>Yeah, that sounds like the right approach</p>",
        "id": 489207045,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734347252
    },
    {
        "content": "<p>Ideally there'd be a <code>#c_signature</code>command that just tells you the function signature to write in C (edit: or better yet, <a href=\"https://github.com/leanprover/lean4/pull/5829\">lean4#5829</a> so that your C compiler can tell you if the signature you wrote doesn't match)</p>",
        "id": 489207106,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734347270
    },
    {
        "content": "<p>My problem now is that I don't know how that state is represented, or how I properly wrap return values with it.</p>",
        "id": 489207192,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734347289
    },
    {
        "content": "<p>You could look at the C output for a pure-lean MetaM function to deduce the signature,</p>",
        "id": 489207339,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734347347
    },
    {
        "content": "<p>So, when I compile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>I get:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_hello</span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">);</span>\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_hello___boxed</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"p\">);</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_hello</span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">);</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_hello___boxed</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unbox</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_hello</span><span class=\"p\">(</span><span class=\"n\">x_7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">);</span>\n<span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_5</span><span class=\"p\">);</span>\n<span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Can I can ignore the <code>___boxed</code> variant? And is the <code>LEAN_EXPORT</code> necessary? I haven't used that in my C functions so far.</p>",
        "id": 489209053,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734347890
    },
    {
        "content": "<p>And what I find interesting about <code>l_hello</code> is that it completely ignores <code>x_2</code>, <code>x_3</code>, <code>x_4</code> and <code>x_5</code>. Is that state that doesn't need to be returned, because it didn't change? Or are there other reasons?</p>",
        "id": 489209971,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734348190
    },
    {
        "content": "<p>If you call a <code>CoreM</code> or <code>IO</code> function from <code>hello</code>, you'll probably see which <code>x</code>s are used for which monad contexts</p>",
        "id": 489210411,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348341
    },
    {
        "content": "<p>Of course you can also <code>#reduce (types := true) MetaM Unit</code> to get the full signature</p>",
        "id": 489210469,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348361
    },
    {
        "content": "<p>Is the <code>___boxed</code> variant generated if you add the attribute <code>@[export \"hello\"\"]</code> to the <code>hello</code> function? </p>\n<p>Also you can write a lean function that accepts the file path of a lean file and outputs <code>CoreM</code> state and context. I think you can initialize <code>MetaM</code> state and context just with <code>{}</code>. So I believe that your function can have a signature <code>FilePath -&gt; Book -&gt; IO Bool</code>.</p>",
        "id": 489210664,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1734348422
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/MetaM.20in.20FFI/near/489210469\">said</a>:</p>\n<blockquote>\n<p>Of course you can also <code>#reduce MetaM Unit</code> to get the full signature</p>\n</blockquote>\n<p>Ahhhh:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n</code></pre></div>\n<p>I don't understand why certain state does not have to be returned though.</p>",
        "id": 489210994,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734348506
    },
    {
        "content": "<p>It would be great if those type names appeared in the generated source</p>",
        "id": 489211103,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348545
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/channel/270676-lean4/topic/MetaM.20in.20FFI/near/489210994\">said</a>:</p>\n<blockquote>\n<p>I don't understand why certain state does not have to be returned though,</p>\n</blockquote>\n<p>ST.Ref is magic / illegal</p>",
        "id": 489211147,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348565
    },
    {
        "content": "<p>Like most performance optimizations</p>",
        "id": 489211188,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348578
    },
    {
        "content": "<p>I guess that leaves <code>Core.Context</code> (<code>x_3</code>) and <code>IO.RealWorld</code> (<code>x_5</code>). Why don't they need to be returned?</p>",
        "id": 489211467,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734348645
    },
    {
        "content": "<p>I could imagine that it's mutated in-place, instead of being returned? After all, we're in C land there.</p>",
        "id": 489211500,
        "sender_full_name": "Rudi Schneider",
        "timestamp": 1734348652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/MetaM.20in.20FFI/near/489210664\">said</a>:</p>\n<blockquote>\n<p>So I believe that your function can have a signature <code>FilePath -&gt; Book -&gt; IO Bool</code>.</p>\n</blockquote>\n<p>I think this is a good answer to what turned out not to be the question that Marcus was asking</p>",
        "id": 489211515,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348658
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/channel/270676-lean4/topic/MetaM.20in.20FFI/near/489211467\">said</a>:</p>\n<blockquote>\n<p>I guess that leaves <code>Core.Context</code> (<code>x_3</code>) and <code>IO.RealWorld</code> (<code>x_5</code>). Why don't they need to be returned?</p>\n</blockquote>\n<p>\"Contexts\" are by convention the bits that are not modified, so returning would be pointless</p>",
        "id": 489211615,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348685
    },
    {
        "content": "<p>And <code>IO.RealWorld</code> is a big lie, which is always just <code>()</code>.</p>",
        "id": 489211718,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734348721
    },
    {
        "content": "<p>Awesome, I think I know what to do now. Thanks!</p>",
        "id": 489212375,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1734348902
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"721337\">@memoryleak47</span> </p>\n<hr>\n<p>I'm stuck with a new problem which I don't understand. I've implemented the following chain of functions, which passes around all the <code>MetaM</code> state/context (<code>x1</code>, ..., <code>x5</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">LEAN</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"run_eqsat_request\"</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">opaque</span><span class=\"w\"> </span><span class=\"n\">runRaw</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Result.Raw</span>\n\n<span class=\"w\">                                       </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">corresponds</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"w\">                                       </span><span class=\"bp\">↓</span>\n\n<span class=\"n\">C</span><span class=\"o\">:</span><span class=\"w\">    </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">run_eqsat_request</span><span class=\"o\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"o\">)</span>\n\n<span class=\"w\">                                       </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">calls</span>\n<span class=\"w\">                                       </span><span class=\"bp\">↓</span>\n\n<span class=\"n\">RUST</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">some_function</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"o\">)</span>\n\n<span class=\"w\">                                       </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">call</span>\n<span class=\"w\">                                       </span><span class=\"bp\">↓</span>\n\n<span class=\"n\">C</span><span class=\"o\">:</span><span class=\"w\">    </span><span class=\"n\">_Bool</span><span class=\"w\"> </span><span class=\"n\">is_synthable</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"o\">)</span>\n\n<span class=\"w\">                                       </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">calls</span>\n<span class=\"w\">                                       </span><span class=\"bp\">↓</span>\n\n<span class=\"n\">C</span><span class=\"o\">:</span><span class=\"w\">    </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">lean_is_synthable</span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"o\">)</span>\n\n<span class=\"w\">                                       </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">corresponds</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"w\">                                       </span><span class=\"bp\">↓</span>\n\n<span class=\"n\">LEAN</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">lean_is_synthable</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">isSynthable</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>For cases where the Rust function <code>some_function</code> does not call <code>is_synthable</code>, everything works great. But when <code>some_function</code> <em>does</em> call <code>is_synthable</code>, I get an error <code>error: Lean exited with code 139</code> <em>after</em> <code>run_eqsat_request </code> returns, but before <code>runRaw</code> completes. Specifically, this means that in the following function:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">req</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">runRaw</span><span class=\"w\"> </span><span class=\"n\">req</span>\n<span class=\"w\">  </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"NO\"</span>\n</code></pre></div>\n<p>... execution does return from <code>run_eqsat_request </code>, but does not reach the panic. From looking around, I couldn't tell what error code 139 is supposed to indicate. So right now I don't know how to debug this.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>run_eq_sat_request</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"nf\">run_eqsat_request</span><span class=\"p\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">x5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">run_eqsat_request_impl</span><span class=\"p\">(</span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">e</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">metam_state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">metam_state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">metam_state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">metam_state</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>is_synthable</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"kt\">_Bool</span><span class=\"w\"> </span><span class=\"nf\">is_synthable</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">env</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">v</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">ty_str</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_mk_string</span><span class=\"p\">(</span><span class=\"n\">str</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_is_synthable</span><span class=\"p\">(</span><span class=\"n\">ty_str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">x1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">x2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">x3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">x4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">-&gt;</span><span class=\"n\">x5</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"o\">-&gt;</span><span class=\"n\">m_tag</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"cm\">/* EStateM.Result.ok */</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"c1\">// Note: The `Bool` is boxed for some reason.</span>\n<span class=\"w\">            </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unbox</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"cm\">/* EStateM.Result.err */</span><span class=\"w\"> </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"c1\">// TODO: We should propagate the error back, as it would also be important</span>\n<span class=\"w\">            </span><span class=\"c1\">//       to know whether we have a `MetaM` failure when we return from `runRaw`.</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>lean_is_synthable</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"nf\">lean_is_synthable</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">ty_str</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x5</span>\n<span class=\"p\">);</span>\n</code></pre></div>\n</div></div>",
        "id": 492301043,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1736253221
    }
]