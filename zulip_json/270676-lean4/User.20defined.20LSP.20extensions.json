[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span> <span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span> is there anyway to experiment adding LSP requests from user code? Is there any plan to add requests asking for the range of the current declaration or current section or current tactic? Or do they already exist? The closest thing I could find in the LSP spec is <a href=\"https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_selectionRange\">https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_selectionRange</a> that doesnâ€™t seem to be implemented in the Lean server (and doesnâ€™t seem to allow labels to the returned ranges, so I donâ€™t know how we would distinguish declarations from tactics for instance).</p>",
        "id": 460113019,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723478904
    },
    {
        "content": "<p>This would be very useful for implementing text objects in editors for editing declarations (I think there's a previous thread where this was briefly discussed).</p>",
        "id": 460114346,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723479238
    },
    {
        "content": "<p>Yes, that's why I'm asking. Because I saw you seemed to be in a lean.nvim mood and I'd like to help.</p>",
        "id": 460134467,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723483154
    },
    {
        "content": "<p>Yes, this is possible. The best worked example I know is Mac's Alloy: <a href=\"https://github.com/tydeu/lean4-alloy/blob/master/Alloy/C/Server.lean\">https://github.com/tydeu/lean4-alloy/blob/master/Alloy/C/Server.lean</a></p>",
        "id": 461028161,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1723484279
    },
    {
        "content": "<p>Nice, Iâ€™ll take a look.</p>",
        "id": 462035722,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723532434
    },
    {
        "content": "<p>I didnâ€™t manage to cargo-cult this. I tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"n\">JsonRpc</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CurDeclParams</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">FromJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ToJson</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileSource</span><span class=\"w\"> </span><span class=\"n\">CurDeclParams</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fileSource</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">textDocument</span><span class=\"bp\">âŸ©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleCurDecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CurDeclParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"s2\">\"Yo\"</span><span class=\"o\">)</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">registerLspRequestHandler</span><span class=\"w\"> </span><span class=\"s2\">\"textDocument/curDecl\"</span><span class=\"w\"> </span><span class=\"n\">CurDeclParams</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">handleCurDecl</span>\n</code></pre></div>\n<p>in a file imported by a file where I send a <code>textDocument/curDecl</code> request, but the only answer I get from the server is <code>Error: No request handler found for 'textDocument/curDecl' (-32601)</code> (note that Iâ€™m able to request a definition in that file for instance).</p>",
        "id": 462063137,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723541307
    },
    {
        "content": "<p>It doesn't work for me either and I'm not sure why, so just +1ing -- but a minor LSP note is that we shouldn't put non-\"standard\" requests on <code>textDocument/</code> -- the convention in the Lean server is to use methods that are named like <code>$/lean/currentDecl</code> -- but yeah trying that locally doesn't change anything, and I barely know enough to even debug whether <code>Lean.Server.Lsp.requestHandlers</code> ends up actually containing the method added.</p>",
        "id": 462132327,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723559814
    },
    {
        "content": "<p>(I'm sure you were messing around anyhow, just mentioning.)</p>",
        "id": 462132405,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723559844
    },
    {
        "content": "<p>The only way I  know the handler is kind of registered is that if I try to register it twice then Lean complains the second time.</p>",
        "id": 462148011,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723563457
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> what happens if you put that snippet in one module and then make the request in another module that imports the first one?</p>",
        "id": 462158317,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1723566458
    },
    {
        "content": "<p>What do you mean by â€œmake the requestâ€? Do you mean from within Lean or through connection to the LSP server?</p>",
        "id": 462158950,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566624
    },
    {
        "content": "<p>I donâ€™t know how to do it from Lean.</p>",
        "id": 462158997,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566636
    },
    {
        "content": "<p>Through the server I get the error message I posted above: <code>No request handler found for 'textDocument/curDecl'</code></p>",
        "id": 462159175,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566673
    },
    {
        "content": "<p>I will describe the way Iâ€™m testing this since it could create issues because I donâ€™t know what Iâ€™m doing.</p>",
        "id": 462159403,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566724
    },
    {
        "content": "<p>I googled to find a python lib to write LSP clients since hacking something with python is still the fastest way for me to test anything that is not purely within Lean.</p>",
        "id": 462159575,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566765
    },
    {
        "content": "<p>I found <a href=\"https://github.com/microsoft/multilspy/\">https://github.com/microsoft/multilspy/</a></p>",
        "id": 462159628,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566777
    },
    {
        "content": "<p>And I wrote <a href=\"https://gist.github.com/PatrickMassot/bc647630058d27ff38105b4157d110ef\">https://gist.github.com/PatrickMassot/bc647630058d27ff38105b4157d110ef</a> on top of it. This is 99% copy-paste from <a href=\"https://github.com/microsoft/multilspy/blob/main/src/multilspy/language_servers/jedi_language_server/jedi_server.py\">https://github.com/microsoft/multilspy/blob/main/src/multilspy/language_servers/jedi_language_server/jedi_server.py</a></p>",
        "id": 462160232,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566924
    },
    {
        "content": "<p>Oh, I thought you had a way to make custom requests from within nvim or another editor</p>",
        "id": 462160268,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1723566935
    },
    {
        "content": "<p>What I was trying to suggest with my message is just that <code>initialize</code> blocks behave differently when imported, and you might need the <code>intialize</code> block to be in a different module than the one you are making the request on/to</p>",
        "id": 462160526,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1723566997
    },
    {
        "content": "<p>The above gist, together with <a href=\"https://github.com/microsoft/multilspy/blob/main/src/multilspy/language_servers/jedi_language_server/initialize_params.json\">https://github.com/microsoft/multilspy/blob/main/src/multilspy/language_servers/jedi_language_server/initialize_params.json</a> also taken from the jedi example is enough for me to require the definition of the token at a given position in a file.</p>",
        "id": 462160528,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723566998
    },
    {
        "content": "<p>Sure, the initialize  is in a different Lean file.</p>",
        "id": 462160617,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723567020
    },
    {
        "content": "<p>Ah, you even wrote that <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 462160721,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1723567054
    },
    {
        "content": "<p>That being said, I donâ€™t insist on using python, this is only a prototyping thing.</p>",
        "id": 462160817,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723567076
    },
    {
        "content": "<p>If you know a way to test a new LSP request from within Lean then it works for me.</p>",
        "id": 462160972,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723567104
    },
    {
        "content": "<p>I was simply trying to separate the issue of learning Lua and registering a new LSP request.</p>",
        "id": 462161108,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723567137
    },
    {
        "content": "<p>My next plan is to hack on Lean itself to add more debug information than what is provided in <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Server/Requests.lean#L61\">https://github.com/leanprover/lean4/blob/master/src/Lean/Server/Requests.lean#L61</a></p>",
        "id": 462161840,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723567315
    },
    {
        "content": "<p>Actually I donâ€™t know how to do this. I cloned the lean4 repo, then followed the instructions at <a href=\"https://lean-lang.org/lean4/doc/make/index.html\">https://lean-lang.org/lean4/doc/make/index.html</a> and then typed <code>elan toolchain link lean4-stage0 build/release/stage0</code> and created a Lean project using <code>lake +lean4-stage0 new tmp</code> but then <code>lake build</code> in the <code>tmp</code> folder says </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Lake'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unexpected</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"mi\">17</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unexpected</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">abbrev</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">axiom</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">binder_predicate'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">builtin_initialize'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">class</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">def</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">elab</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">elab_rules'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">example</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">inductive</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">infix</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">infixl</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">infixr</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">initialize'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">instance</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">macro</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">macro_rules</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">notation</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">opaque</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">postfix</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">prefix</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">structure</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">syntax</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">theorem</span><span class=\"bp\">'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">configuration</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">errors</span>\n</code></pre></div>",
        "id": 462165051,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723568499
    },
    {
        "content": "<p>Patrick I'm not at a comp but the way you make lsp requests in neovim is e.g. <code>:lua vim.print(vim.lsp.get_active_clients()[1].request_sync('textDocument/curDecl', { foo = 37 }))</code> which you run from within the buffer of a .lean file.</p>",
        "id": 462175996,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723571947
    },
    {
        "content": "<p>The second arg is your params</p>",
        "id": 462176023,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723571958
    },
    {
        "content": "<p>(also be aware I think there's a minor Lean bug that the server will crash if you send it nil (i.e. leave off the second arg) so if it seems like stuff is blowing up that's a reason why)</p>",
        "id": 462176253,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723572027
    },
    {
        "content": "<p>But otherwise this is what I tried earlier and got the same message you did.</p>",
        "id": 462176395,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723572062
    },
    {
        "content": "<p>OK and now that I'm back to a computer, I have something \"working\" if I hack it into the server</p>",
        "id": 462191586,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723575748
    },
    {
        "content": "<p>Specifically</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/Lean/Server/FileWorker/RequestHandling.lean b/src/Lean/Server/FileWorker/RequestHandling.lean</span>\n<span class=\"gh\">index 9e5c7f42dd..2a09a363f2 100644</span>\n<span class=\"gd\">--- a/src/Lean/Server/FileWorker/RequestHandling.lean</span>\n<span class=\"gi\">+++ b/src/Lean/Server/FileWorker/RequestHandling.lean</span>\n<span class=\"gu\">@@ -229,6 +229,10 @@ def handleDefinition (kind : GoToKind) (p : TextDocumentPositionParams)</span>\n<span class=\"w\"> </span>        locationLinksOfInfo kind infoWithCtx snap.infoTree\n<span class=\"w\"> </span>      else return #[]\n\n<span class=\"gi\">+def handleCurrentDecl (p : TextDocumentPositionParams) :</span>\n<span class=\"gi\">+    RequestM (RequestTask String) := do</span>\n<span class=\"gi\">+      return (.pure \"Yo\")</span>\n<span class=\"gi\">+</span>\n<span class=\"w\"> </span>open RequestM in\n<span class=\"w\"> </span>def getInteractiveGoals (p : Lsp.PlainGoalParams) : RequestM (RequestTask (Option Widget.InteractiveGoals)) := do\n<span class=\"w\"> </span>  let doc â† readDoc\n<span class=\"gu\">@@ -753,5 +757,10 @@ builtin_initialize</span>\n<span class=\"w\"> </span>    PlainTermGoalParams\n<span class=\"w\"> </span>    (Option PlainTermGoal)\n<span class=\"w\"> </span>    handlePlainTermGoal\n<span class=\"gi\">+  registerLspRequestHandler</span>\n<span class=\"gi\">+    \"$/lean/currentDecl\"</span>\n<span class=\"gi\">+    TextDocumentPositionParams</span>\n<span class=\"gi\">+    String</span>\n<span class=\"gi\">+    handleCurrentDecl</span>\n</code></pre></div>\n<p>then building lean (in my case HEAD does not seem to build because of some UInt issues? But using 4.11.0-rc2 does)</p>\n<p>and then <code>:lua vim.print(vim.lsp.get_active_clients()[1].request_sync('$/lean/currentDecl', vim.lsp.util.make_position_params()))</code></p>\n<p>gives me</p>\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"p\">{</span>\n  <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"s2\">\"Yo\"</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 462191919,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723575852
    },
    {
        "content": "<p>How did you manage to make a project using your custom Lean build?</p>",
        "id": 462207066,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723580676
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462207066\">said</a>:</p>\n<blockquote>\n<p>How did you manage to make a project using your custom Lean build?</p>\n</blockquote>\n<p>If you registered your local build as a toolchain with <code>elan</code> you can just put it into a <code>lean-toolchain</code> file and work with it</p>",
        "id": 462207372,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1723580782
    },
    {
        "content": "<p>Or you can use <code>elan override set my_custom_toolchain</code> and not touch <code>lean-toolchain</code></p>",
        "id": 462207508,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723580831
    },
    {
        "content": "<p>Do you see any mistake in my description at <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462165051\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462165051</a>?</p>",
        "id": 462207594,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723580868
    },
    {
        "content": "<p>Should I also have a stage1 somehow?</p>",
        "id": 462207851,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723580946
    },
    {
        "content": "<p>Ah yes, it seems I need to link stage1</p>",
        "id": 462208112,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723581028
    },
    {
        "content": "<p><a href=\"https://lean-lang.org/lean4/doc/dev/index.html#dev-setup-using-elan\">https://lean-lang.org/lean4/doc/dev/index.html#dev-setup-using-elan</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">rootdir</span>\n<span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage1</span>\n<span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage0</span>\n</code></pre></div>",
        "id": 462208131,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1723581034
    },
    {
        "content": "<p>I think I misread an old zulip message earlier. I can now use my custom toolchain. Thanks Henrik and Matthew!</p>",
        "id": 462208545,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723581201
    },
    {
        "content": "<p>I managed to get some extra info in the error message, but it is only telling me that, at the time the LSPâ€¯request is processed, Lean indeed doesnâ€™t know my handler. But it doesnâ€™t tell me whether it forgot about it or didnâ€™t come across it.</p>",
        "id": 462208702,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723581289
    },
    {
        "content": "<p>Does anyone underdstand how alloy manages to convince Lean that its extra handlers are worth using?</p>",
        "id": 462208825,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723581353
    },
    {
        "content": "<p>And indeed I can reproduce Julianâ€™s success with adding the request handler inside the lean4 code base. At least Iâ€™ll be able to play with trying to make those request actually return something useful. Itâ€™s even semi-quick because the server file we are editing is so high in the build tree that compiling lean after modifying it is pretty fast.</p>",
        "id": 462209900,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723581875
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462207066\">said</a>:</p>\n<blockquote>\n<p>How did you manage to make a project using your custom Lean build?</p>\n</blockquote>\n<p>(I just did PATH=$PWD/stage1/bin:$PATH and started nvim in my case)</p>",
        "id": 462210027,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723581949
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462208825\">said</a>:</p>\n<blockquote>\n<p>Does anyone underdstand how alloy manages to convince Lean that its extra handlers are worth using?</p>\n</blockquote>\n<p>I think maybe someone should confirm alloy actually works just to be sure</p>",
        "id": 462210332,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723582094
    },
    {
        "content": "<p>I didn't yet. But glad you have something temporarily useful</p>",
        "id": 462210373,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723582118
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462210332\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462208825\">said</a>:</p>\n<blockquote>\n<p>Does anyone underdstand how alloy manages to convince Lean that its extra handlers are worth using?</p>\n</blockquote>\n<p>I think maybe someone should confirm alloy actually works just to be sure</p>\n</blockquote>\n<p>It does</p>",
        "id": 462210962,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1723582393
    },
    {
        "content": "<p>New information from the FRO office hour: it looks like one cannot add a LSP request type from user space. What Alloy is doing is chaining request handlers that do their work after a builtin handler.</p>",
        "id": 462369259,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723649374
    },
    {
        "content": "<p>Was there by any chance any alternative proposed (either a future ability to do this, or else any interest in the language server growing this capability)?</p>",
        "id": 462382864,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723653676
    },
    {
        "content": "<p>Yes, there is some hope. But we won't know for sure until Marc comes back from vacation since he is in charge of that corner of Lean.</p>",
        "id": 462389587,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723656455
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/462175996\">said</a>:</p>\n<blockquote>\n<p>Patrick I'm not at a comp but the way you make lsp requests in neovim is e.g. <code>:lua vim.print(vim.lsp.get_active_clients()[1].request_sync('textDocument/curDecl', { foo = 37 }))</code> which you run from within the buffer of a .lean file.</p>\n</blockquote>\n<p>I was not able to get this to return anything. Can you get anything if you put in your Lean4 file that we were tweaking:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleCurrentDecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">text</span>\n\n<span class=\"n\">builtin_initialize</span>\n<span class=\"w\">  </span><span class=\"n\">registerLspRequestHandler</span>\n<span class=\"w\">    </span><span class=\"s2\">\"$/lean/currentDecl\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentPositionParams</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">handleCurrentDecl</span>\n</code></pre></div>",
        "id": 462404346,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723663110
    },
    {
        "content": "<p>I try to call it replacing your <code>{foo = 37}</code> with <code>{ textDocument = { uri = \"file:///home/pmassot/lean/tmp/Tmp/Basic.lean\" }, position = { line = 0, character = 17 } }</code> where the file <code>Tmp/Basic.lean</code> indeed exists and my python code gets an answer. But vim always report an empty result.</p>",
        "id": 462404584,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723663217
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span> any idea here?</p>",
        "id": 463135036,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723973378
    },
    {
        "content": "<p>Sorry, missed that -- yes <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> I do get something here, if I try it on some file with <code>def foo := 12</code> I get the expected response:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"s2\">\"end\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"o\">},</span>\n<span class=\"w\">    </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 463175691,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723989153
    },
    {
        "content": "<p>You tried using <code>vim.lsp.util.make_position_params()</code> as the parameter instead of manually passing them just to be sure of no typos? Even though I don't see any there presuming that's the file path and it's at least 17 chars long...</p>",
        "id": 463176110,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723989255
    },
    {
        "content": "<p>Oh, also use <code>:LspInfo</code> in your lean file and check that for you it says something similar to what it says for me, namely that my Lean is... <code> cmd:             /Users/julian/Development/lean4/build/release/stage1/bin/lake serve -- /Users/julian/Development/lean4 /Users/julian/Development/lean4/src</code> and not that you're talking to the non-custom Lean</p>",
        "id": 463176339,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723989326
    },
    {
        "content": "<p><code>:LspInfo</code> says it called elan, but I know elan its doing its job, otherwise lean would complain about an unknown request.</p>",
        "id": 463178508,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990631
    },
    {
        "content": "<p>Oh, today it works!</p>",
        "id": 463178532,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990673
    },
    {
        "content": "<p>I really donâ€™t understand what happened the other day.</p>",
        "id": 463178564,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990683
    },
    {
        "content": "<p>I am still interested in learning more about your mysterious hint: â€œusing <code>vim.lsp.util.make_position_params()</code> as the parameter instead of manually passing them just to be sure of no typosâ€. I donâ€™t know how to do that.</p>",
        "id": 463178607,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990722
    },
    {
        "content": "<p>I tried <code>:lua vim.lsp.util.make_position_params()</code> but I get a mysterious <code>table: 0x733ce1788760</code>.</p>",
        "id": 463178639,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990763
    },
    {
        "content": "<p>I would be really nice to call a lsp request with the current cursor position as argument.</p>",
        "id": 463178658,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723990800
    },
    {
        "content": "<p>Do <code>:lua vim.print(vim.lsp.util.make_position_params())</code></p>",
        "id": 463180666,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992290
    },
    {
        "content": "<p>You are spoiled Patrick</p>",
        "id": 463180681,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992297
    },
    {
        "content": "<p>Lua is a silly little language</p>",
        "id": 463180693,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992300
    },
    {
        "content": "<p>It does not know how to print its own tables (dictionaries)</p>",
        "id": 463180728,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992308
    },
    {
        "content": "<p>So unlike in Python when you print <code>{\"foo\": 12, \"bar\": 37}</code> you see what you expect to see</p>",
        "id": 463180794,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992325
    },
    {
        "content": "<p>In Lua you see nothing but that memory address, it has no way of printing that table, and you get to write it yourself if you wish by writing <code>for k, v in pairs(yourtable) print(k, v) end</code> and handling all the recursive cases, and etc. -- but neovim has a version of that function which does work  to print anything, it's <code>vim.print</code>.</p>",
        "id": 463180876,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992346
    },
    {
        "content": "<p>So <code>vim.lsp.util.make_position_params()</code> is indeed a function which builds exactly those <code>TextDocumentPositionParams</code> that you wrote by hand, but it does it automatically using the current cursor position, as you want.</p>",
        "id": 463181083,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992400
    },
    {
        "content": "<p>(So even more explicitly, you can write <code>:lua vim.print(vim.lsp.get_active_clients()[1].request_sync('$/lean/currentDecl', vim.lsp.util.make_position_params()))</code>)</p>",
        "id": 463182211,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723992694
    },
    {
        "content": "<p>This memory address thing is what I suspected. Thanks.</p>",
        "id": 463192382,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723995816
    },
    {
        "content": "<p>I'm away from my computer but I will try later.</p>",
        "id": 463192390,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1723995836
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span> I wasnâ€™t able to use your trick because I donâ€™t know how to merge two tables in Lua (and internet seems to say there is no library function doing that)! I mean doing what the python dictionary update method does.</p>",
        "id": 464477336,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359163
    },
    {
        "content": "<p>But anyway, I went back to this tonight, and I think Iâ€™ve reached a stage where Iâ€™ll need your help.</p>",
        "id": 464477349,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359167
    },
    {
        "content": "<p>Here is how you can play. In your copy of Lean 4, in <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Server/FileWorker/RequestHandling.lean\">https://github.com/leanprover/lean4/blob/master/src/Lean/Server/FileWorker/RequestHandling.lean</a>, right before the registrations at the end, paste:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The kind of elements we are looking for. -/</span>\n<span class=\"w\">  </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">ToJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">FromJson</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileSource</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">fileSource</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">textDocument</span><span class=\"bp\">âŸ©</span>\n\n<span class=\"sd\">/-- Placeholder for requesting some LSP range at the current cursor position.</span>\n<span class=\"sd\">This placeholder will always return `none`. It is expected to be</span>\n<span class=\"sd\">chained by some user-defined handler.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleQueryRangeAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"sd\">/-- Placeholder for requesting some LSP position at the current cursor position.</span>\n<span class=\"sd\">This placeholder will always return `none`. It is expected to be</span>\n<span class=\"sd\">chained by some user-defined handler.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleQueryPositionAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Position</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"sd\">/-- Placeholder for requesting some string at the current cursor position.</span>\n<span class=\"sd\">This placeholder will always return `none`. It is expected to be</span>\n<span class=\"sd\">chained by some user-defined handler.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleQueryStringAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p>and then start the <code>builtin_initialize</code> block at the end with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">builtin_initialize</span>\n<span class=\"w\">  </span><span class=\"n\">registerLspRequestHandler</span>\n<span class=\"w\">    </span><span class=\"s2\">\"$/lean/rangeAt\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentCustomQueryAtParams</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">handleQueryRangeAt</span>\n<span class=\"w\">  </span><span class=\"n\">registerLspRequestHandler</span>\n<span class=\"w\">    </span><span class=\"s2\">\"$/lean/positionAt\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentCustomQueryAtParams</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Position</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">handleQueryPositionAt</span>\n<span class=\"w\">  </span><span class=\"n\">registerLspRequestHandler</span>\n<span class=\"w\">    </span><span class=\"s2\">\"$/lean/stringAt\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentCustomQueryAtParams</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">handleQueryStringAt</span>\n</code></pre></div>",
        "id": 464477623,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359273
    },
    {
        "content": "<p>This creates three place-holders custom LSP requests. They each take a position (that should be the cursor position) and a string which is meant to indicate what kind of element we are requesting. Then the server should return an optional range, position or string (the string case is mostly meant for debugging).</p>",
        "id": 464477899,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359379
    },
    {
        "content": "<p>Now the nice thing is that you only need to compile Lean once. Then youâ€™ll be able to implement handlers in user space.</p>",
        "id": 464477961,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359409
    },
    {
        "content": "<p>For instance, you can start a new Lean project using our custom toolchain and have a file there containing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">FileWorker</span><span class=\"w\"> </span><span class=\"n\">RequestM</span>\n\n<span class=\"sd\">/-- Is this the `SyntaxNodeKind` of a tactic syntax? Currently a very crude heuristic. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">SyntaxNodeKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic</span><span class=\"w\"> </span><span class=\"n\">kind</span>\n\n<span class=\"sd\">/-- In the given syntax stack, find the first item satisfying the condition `cond`</span>\n<span class=\"sd\">and run `code` on it. Return `none` if no such item exists.  -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"sd\">/-- In the given syntax stack, find the first item satisfying the condition `cond`</span>\n<span class=\"sd\">and return its LSP range (using the given `FileMap`). Return `none` if no such item exists.  -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">map</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleRangeAt</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)):</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"declaration\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.declaration</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"tactic\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"tacticSeq\"</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic.tacticSeq</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"binder\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`Lean.Parser.Term.explicitBinder</span><span class=\"o\">,</span><span class=\"ss\">`Lean.Parser.Term.implicitBinder</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Position</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Range</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleStringAt</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)):</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"printStack\"</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">      </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{res}</span><span class=\"se\">\\n\\n</span><span class=\"s2\">{stx.getKind}</span><span class=\"se\">\\n</span><span class=\"s2\">{stx}</span><span class=\"se\">\\n</span><span class=\"s2\">{repr &lt;| rg.toLspRange text}\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">res</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">chainLspRequestHandler</span><span class=\"w\"> </span><span class=\"s2\">\"$/lean/rangeAt\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">handleRangeAt</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">chainLspRequestHandler</span><span class=\"w\"> </span><span class=\"s2\">\"$/lean/stringAt\"</span>\n<span class=\"w\">    </span><span class=\"n\">TextDocumentCustomQueryAtParams</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">handleStringAt</span>\n</code></pre></div>",
        "id": 464478137,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359473
    },
    {
        "content": "<p><code>vim.tbl_extend</code> is the functional versiÃ³n of update -- it takes some funny options -- you use it like <code>vim.tbl_extend('keep', t1, t2)</code> where the keep option (which can also be 2 other values) means keep the value from t1 when there are dupes -- and it returns the merged table.<br>\nI'm away from a computer now but you've obviously got my help, so will look at your instructions later tonight my time.</p>",
        "id": 464478165,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724359489
    },
    {
        "content": "<p>Nice, it works! So you can call for instance <code>lua vim.print(vim.lsp.get_active_clients()[1].request_sync('$/lean/rangeAt', vim.tbl_extend('keep',vim.lsp.util.make_position_params(), { kind = \"tactic\"})).result)</code> to get the range of the current tactic syntax. Replace \"tactic\" with \"declaration\" to get the current declaration (I mean the declaration surrounding the cursor) or \"tacticSeq\" to get the current tactic sequence.</p>",
        "id": 464479099,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359882
    },
    {
        "content": "<p>The next step needs you. Iâ€™d like to learn how to extend the lean.nvim extension to take this information and make it into a text object etc.</p>",
        "id": 464479316,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724359962
    },
    {
        "content": "<p>Note the above Lean code is really a proof of concept, it is not meant to be robust and complete.</p>",
        "id": 464479395,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724360004
    },
    {
        "content": "<p>I was starting to refine my proof of concept code from yesterday. My idea was to replace my three placeholders requests and my <code>match</code> on the <code>kind</code> parameter by a single custom LSP request taking arbitrary Json as input and outputting arbitrary json, with proper environment extension and attribute to register handlers. But as I started to think about the implementation, which means thinking about where I could see similar functionality to copy-paste code, I realized I may be reinventing the <code>server_rpc_method</code> attribute and surrounding framework. <span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span>, is that correct? Could I simply user this existing framework and have <code>lean.nvim</code> directly calling the LSP request <code>$/lean/rpc/call</code>? <span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span> what do you think about this? Could you expose a Lua function that takes arbitrary Json input, add the RPC session id and call <code>$/lean/rpc/call</code>?</p>",
        "id": 464718377,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724438435
    },
    {
        "content": "<p>I was just starting to work out similar questions myself to try to help on the next step.</p>",
        "id": 464718879,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724438533
    },
    {
        "content": "<p>More specifically, lean.nvim's RPC code lives in <code>lua/lean/rpc.lua</code>.</p>",
        "id": 464718920,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724438544
    },
    {
        "content": "<p>So yeah I am trying to recall whether your new handlers should be methods on what we call <code>Subsession</code>, which I think possibly yes.</p>",
        "id": 464718963,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724438560
    },
    {
        "content": "<p>Here for instance is how we implemet goToLocation: <a href=\"https://github.com/Julian/lean.nvim/blob/7bb86aefab286c66c7f30f6ab51e7f235eea269b/lua/lean/rpc.lua#L363-L369\">https://github.com/Julian/lean.nvim/blob/7bb86aefab286c66c7f30f6ab51e7f235eea269b/lua/lean/rpc.lua#L363-L369</a></p>\n<p>So I think your method will be similar to that (but yeah it's been &lt;10 minutes since I happen to just start looking at this finally)</p>",
        "id": 464719316,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724438663
    },
    {
        "content": "<blockquote>\n<p>Could you expose a Lua function that takes arbitrary Json input, add the RPC session id and call <code>$/lean/rpc/call</code>?</p>\n</blockquote>\n<p>(So even more explicitly, this function exists, it's called <code>session:call{yourstuff}</code>!)</p>",
        "id": 464719696,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724438782
    },
    {
        "content": "<p>How would you call that <code>session:call</code> from the vim command mode?</p>",
        "id": 464720837,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724439210
    },
    {
        "content": "<p>E.g. in a Lean buffer:</p>\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"p\">:</span><span class=\"n\">lua</span> <span class=\"kd\">local</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">lsp</span><span class=\"p\">.</span><span class=\"n\">util</span><span class=\"p\">.</span><span class=\"n\">make_position_params</span><span class=\"p\">();</span> <span class=\"kd\">local</span> <span class=\"n\">sess</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"s1\">'lean.rpc'</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">);</span> <span class=\"nb\">require</span><span class=\"s1\">'plenary.async'</span><span class=\"p\">.</span><span class=\"n\">void</span><span class=\"p\">(</span><span class=\"kr\">function</span><span class=\"p\">()</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">sess</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"s1\">'Lean.Widget.getInteractiveTermGoal'</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">))</span> <span class=\"kr\">end</span><span class=\"p\">)()</span>\n</code></pre></div>\n<p>and then look at what you see in <code>:messages</code> for the printed response.</p>",
        "id": 464722319,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724439791
    },
    {
        "content": "<p>(The async nonsense is some synchronous wrapping, I forget if we have a helper to do that more nicely) -- does that help at all as-is?</p>",
        "id": 464722382,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724439812
    },
    {
        "content": "<p>I don't know anything about the Lean side of the framework (how you register new RPC calls) -- maybe you do. I'm trying to teach myself that now.</p>",
        "id": 464722816,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724439945
    },
    {
        "content": "<p>Ah, it's <code>registerRpcProcedure</code>.</p>",
        "id": 464723070,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724440022
    },
    {
        "content": "<p>There is an attribute to register rpc methods.</p>",
        "id": 464725216,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724440678
    },
    {
        "content": "<p>Itâ€™s dinner time here, but Iâ€™ll try later.</p>",
        "id": 464725356,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724440712
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> it would help to know what you are trying to achieve in the end, but yes, since it looks like custom LSP endpoints are not possible to register after all, using <code>@[server_rpc_method]</code> is another way of achieving the same effect. The one downside is that you need to have an RPC session running, but lean.nvim seems to have one already for some of its widget support.</p>",
        "id": 464728326,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1724441515
    },
    {
        "content": "<p>I explained in this thread what Iâ€™m trying to do. One single example is to make a LSP request querying the range of the current declaration.</p>",
        "id": 464733441,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724443146
    },
    {
        "content": "<p>I am not able to make it work with rpc_method yet. I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">TextDocumentPositionParams</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The kind of elements we are looking for. -/</span>\n<span class=\"w\">  </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">ToJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">FromJson</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcTest</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"s2\">\"Test\"</span>\n</code></pre></div>\n<p>but then using Julianâ€™s magic code <code>lua local params = vim.tbl_extend('keep',vim.lsp.util.make_position_params(), { kind = \"tacticSeq\"}); local sess = require'lean.rpc'.open(0, params); require'plenary.async'.void(function() vim.print(sess:call('rpcTest', params)) end)()</code> only returns <code>nil</code>.</p>",
        "id": 464734433,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724443402
    },
    {
        "content": "<p>It I think will always return <code>nil</code> because of the <code>async.void</code> -- but it should print something (unless you mean it doesn't do that either) -- let me try your lines now.</p>",
        "id": 464734614,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724443450
    },
    {
        "content": "<p>I think it prints nil.</p>",
        "id": 464736022,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724443852
    },
    {
        "content": "<p>It was not working, and now it's working here.</p>",
        "id": 464736165,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724443891
    },
    {
        "content": "<p>This works for me: <code>lua local params = vim.lsp.util.make_position_params(); local sess = require'lean.rpc'.open(0, params); require'plenary.async'.void(function() vim.notify(sess:call('rpcTest', vim.tbl_extend('keep', params, { kind = 'range' }))) end)()</code></p>",
        "id": 464736507,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724443952
    },
    {
        "content": "<p>(I changed to <code>vim.notify</code> because it's more convenient for me than <code>vim.print</code>, I have vim.notify show me a popup with the message -- but that part doesn't matter) -- that line shows me <code>Test</code></p>",
        "id": 464736624,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724443978
    },
    {
        "content": "<p>Here is a full repository in case that's useful, I'm sure you already have one but just to see what I am running myself: <a href=\"https://github.com/Julian/lspfun\">https://github.com/Julian/lspfun</a> -- I am just using one of your MIL files to test and the lines you showed here</p>",
        "id": 464737466,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444167
    },
    {
        "content": "<p>Ok, this one works!</p>",
        "id": 464737856,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444260
    },
    {
        "content": "<p>Now I really need to learn how to define function to compress that. Editing this line forever in command mode wonâ€™t be fun.</p>",
        "id": 464738466,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444390
    },
    {
        "content": "<p>What you I read to avoid asking you help at every step?</p>",
        "id": 464738580,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444405
    },
    {
        "content": "<p>Should I search for a neovim extension writing tutorial?</p>",
        "id": 464738713,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444435
    },
    {
        "content": "<p>Yeah so I really need to write you out some longer instructions, but let me write you something to get you started -- first step, get lean.nvim in \"develop\" mode so that you can clone the plugin and make changes to it and see those live. This is functionality that lazy.nvim gives you, you just need to tell it where you store your repositories. One second, I'll write up how to do that.</p>",
        "id": 464738902,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444483
    },
    {
        "content": "<p>These are the key lines: <a href=\"https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.lua#L33-L37\">https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.lua#L33-L37</a> -- in particular in my case I am telling lazy.nvim \"when you see a plugin called Julian/&lt;something&gt;, go look at $DEVELOPMENT/something -- if that exists, load the plugin from there -- otherwise, load it from GitHub\" -- and my $DEVELOPMENT environment variable is set to where I keep my git repositories. Add that to where you start lazy, and then either clone or fork + clone the repository into that location.</p>",
        "id": 464739434,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444644
    },
    {
        "content": "<p>Once you have that, go to <code>lua/lean/rpc.lua</code> in that repo and add <code>print(\"HELLO\")</code> somewhere, and open a Lean file, and you should see neovim print HELLO to <code>:messages</code>.</p>",
        "id": 464739533,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444680
    },
    {
        "content": "<p>At this point you can now simply copy paste what you see in that file to add more methods to the session object.</p>",
        "id": 464739637,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444717
    },
    {
        "content": "<p>(I will want to write you up some instructions on how to run tests because that is useful instead of manually testing stuff, but it may have to wait until tomorrow).</p>",
        "id": 464739718,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444746
    },
    {
        "content": "<p>Do you manage to get any output with the actually useful function</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcRangeAt</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"declaration\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.declaration</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"tactic\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"tacticSeq\"</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic.tacticSeq</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"binder\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`Lean.Parser.Term.explicitBinder</span><span class=\"o\">,</span><span class=\"ss\">`Lean.Parser.Term.implicitBinder</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p>I get a lua error message when I try to call it.</p>",
        "id": 464739873,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444792
    },
    {
        "content": "<p>I try it with <code>lua local params = vim.lsp.util.make_position_params(); local sess = require'lean.rpc'.open(0, params); require'plenary.async'.void(function() vim.notify(sess:call('rpcRangeAt', vim.tbl_extend('keep', params, { kind = 'tacticSeq' }))) end)()</code></p>",
        "id": 464739928,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444813
    },
    {
        "content": "<p>Can you tell me the imports</p>",
        "id": 464740004,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444838
    },
    {
        "content": "<p>Lean is confused about <code>findRange?</code></p>",
        "id": 464740018,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444843
    },
    {
        "content": "<p>Sorry about that.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">FileWorker</span><span class=\"w\"> </span><span class=\"n\">RequestM</span>\n</code></pre></div>",
        "id": 464740100,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444875
    },
    {
        "content": "<p>Weird, that's the same imports as I had, but Lean still seems confused... one second.</p>",
        "id": 464740192,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444900
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Is this the `SyntaxNodeKind` of a tactic syntax? Currently a very crude heuristic. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">SyntaxNodeKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic</span><span class=\"w\"> </span><span class=\"n\">kind</span>\n\n<span class=\"sd\">/-- In the given syntax stack, find the first item satisfying the condition `cond`</span>\n<span class=\"sd\">and run `code` on it. Return `none` if no such item exists.  -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"sd\">/-- In the given syntax stack, find the first item satisfying the condition `cond`</span>\n<span class=\"sd\">and return its LSP range (using the given `FileMap`). Return `none` if no such item exists.  -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"bp\">.</span><span class=\"n\">findRange?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">map</span>\n</code></pre></div>",
        "id": 464740195,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444901
    },
    {
        "content": "<p>Sorry, I thought you had the file I pasted yesterday.</p>",
        "id": 464740240,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724444919
    },
    {
        "content": "<p>Ahh ok, yes sorry I just deleted it and replaced it all with the rpc thing but that clearly was deleting too much. OK let's see...</p>",
        "id": 464740304,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724444947
    },
    {
        "content": "<p>(I see the error, trying to figure out where it's coming from.)</p>",
        "id": 464741049,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724445223
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/464739434\">said</a>:</p>\n<blockquote>\n<p>These are the key lines: <a href=\"https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.lua#L33-L37\">https://github.com/Julian/dotfiles/blob/main/.config/nvim/init.lua#L33-L37</a> -- in particular in my case I am telling lazy.nvim \"when you see a plugin called Julian/&lt;something&gt;, go look at $DEVELOPMENT/something -- if that exists, load the plugin from there -- otherwise, load it from GitHub\" -- and my $DEVELOPMENT environment variable is set to where I keep my git repositories. Add that to where you start lazy, and then either clone or fork + clone the repository into that location.</p>\n</blockquote>\n<p>I was not able to make anything out of this, but I did the low-tech replacement of <code>Julian/lean.nvim</code> by <code>dir=â€¦</code> and I can load my version.</p>",
        "id": 464742135,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724445727
    },
    {
        "content": "<p>I wrote in my hacked <code>lean.nvim</code></p>\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"kr\">function</span> <span class=\"nf\">LeanRpc</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">extras</span><span class=\"p\">)</span>\n    <span class=\"kd\">local</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">lsp</span><span class=\"p\">.</span><span class=\"n\">util</span><span class=\"p\">.</span><span class=\"n\">make_position_params</span><span class=\"p\">();</span>\n    <span class=\"kd\">local</span> <span class=\"n\">sess</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"s1\">'lean.rpc'</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">);</span>\n    <span class=\"nb\">require</span><span class=\"s1\">'plenary.async'</span><span class=\"p\">.</span><span class=\"n\">void</span><span class=\"p\">(</span><span class=\"kr\">function</span><span class=\"p\">()</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">sess</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">tbl_extend</span><span class=\"p\">(</span><span class=\"s1\">'keep'</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">extras</span><span class=\"p\">)))</span> <span class=\"kr\">end</span><span class=\"p\">)()</span>\n  <span class=\"kr\">end</span>\n</code></pre></div>\n<p>which is already useful, but of course it doesnâ€™t get rid of the error message.</p>",
        "id": 464743450,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724446436
    },
    {
        "content": "<p>Nor here yet, so I'm missing something obvious.</p>",
        "id": 464743542,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724446478
    },
    {
        "content": "<p>I think this error message is simply hiding any LSP error. Trying to call a non-existent rpc method gives exactly the same message.</p>",
        "id": 464743550,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724446482
    },
    {
        "content": "<p>OK and now it works again after doing random stuff to clean up the code.</p>",
        "id": 464744204,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724446808
    },
    {
        "content": "<p>It's really so unfun dealing with languages with <code>nil</code> and craziness.</p>",
        "id": 464744244,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724446821
    },
    {
        "content": "<p>This is what I ended up with:</p>\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"kd\">local</span> <span class=\"n\">bufnrs</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">iter</span><span class=\"p\">(</span><span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">api</span><span class=\"p\">.</span><span class=\"n\">nvim_tabpage_list_wins</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))</span>\n  <span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"kr\">function</span><span class=\"p\">(</span><span class=\"n\">win</span><span class=\"p\">)</span>\n    <span class=\"kd\">local</span> <span class=\"n\">bufnr</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">api</span><span class=\"p\">.</span><span class=\"n\">nvim_win_get_buf</span><span class=\"p\">(</span><span class=\"n\">win</span><span class=\"p\">)</span>\n    <span class=\"kr\">if</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">bo</span><span class=\"p\">[</span><span class=\"n\">bufnr</span><span class=\"p\">].</span><span class=\"n\">filetype</span> <span class=\"o\">==</span> <span class=\"s1\">'lean'</span> <span class=\"kr\">then</span>\n      <span class=\"kr\">return</span> <span class=\"n\">win</span><span class=\"p\">,</span> <span class=\"n\">bufnr</span>\n    <span class=\"kr\">end</span>\n  <span class=\"kr\">end</span><span class=\"p\">):</span><span class=\"n\">totable</span><span class=\"p\">()</span>\n\n<span class=\"kd\">local</span> <span class=\"n\">win</span><span class=\"p\">,</span> <span class=\"n\">bufnr</span> <span class=\"o\">=</span> <span class=\"n\">unpack</span><span class=\"p\">(</span><span class=\"n\">bufnrs</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n\n<span class=\"kd\">local</span> <span class=\"n\">pos</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">lsp</span><span class=\"p\">.</span><span class=\"n\">util</span><span class=\"p\">.</span><span class=\"n\">make_position_params</span><span class=\"p\">(</span><span class=\"n\">win</span><span class=\"p\">)</span>\n<span class=\"kd\">local</span> <span class=\"n\">sess</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"s1\">'lean.rpc'</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"n\">bufnr</span><span class=\"p\">,</span> <span class=\"n\">pos</span><span class=\"p\">)</span>\n\n\n<span class=\"nb\">require</span><span class=\"s1\">'plenary.async'</span><span class=\"p\">.</span><span class=\"n\">void</span><span class=\"p\">(</span><span class=\"kr\">function</span><span class=\"p\">()</span>\n  <span class=\"kd\">local</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">tbl_extend</span><span class=\"p\">(</span><span class=\"s1\">'keep'</span><span class=\"p\">,</span> <span class=\"n\">pos</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"n\">kind</span> <span class=\"o\">=</span> <span class=\"s1\">'declaration'</span> <span class=\"p\">})</span>\n  <span class=\"kd\">local</span> <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">sess</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"s1\">'rpcRangeAt'</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">)</span>\n  <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n<span class=\"kr\">end</span><span class=\"p\">)()</span>\n</code></pre></div>\n<p>I put this in some random <code>foo.lua</code> file in my case and then was running <code>:source foo.lua</code> over and over again to test -- because I thought it would be easier in case you didn't get lean.nvim editable -- but if you did you can just paste it wherever you want.</p>",
        "id": 464744381,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724446889
    },
    {
        "content": "<p>Iâ€™ll try this, but let me report that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcTestBis</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p>fails while</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcTestBis</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"s2\">\"TestBis\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>works.</p>",
        "id": 464744564,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724446970
    },
    {
        "content": "<p>(You're right that something is simply hiding errors)</p>",
        "id": 464744586,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724446984
    },
    {
        "content": "<p>Ahhhhh</p>",
        "id": 464744646,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447021
    },
    {
        "content": "<p>That's silly.</p>",
        "id": 464744656,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447026
    },
    {
        "content": "<p>The issue is that <code>vim.notify</code> takes a string, and we were passing it a table once you returned a table from your RPC method</p>",
        "id": 464744708,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447043
    },
    {
        "content": "<p>Use <code>vim.notify(vim.inspect(result))</code> -- vim.inspect is like <code>repr()</code>.</p>",
        "id": 464744749,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447070
    },
    {
        "content": "<p>(This fixes what you just sent as well -- it's all just the silly printing mistake.)</p>",
        "id": 464744875,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447141
    },
    {
        "content": "<p>Great!</p>",
        "id": 464745250,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724447357
    },
    {
        "content": "<p>So I can stick with</p>\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"kr\">function</span> <span class=\"nf\">LeanRpc</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">extras</span><span class=\"p\">)</span>\n    <span class=\"kd\">local</span> <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">lsp</span><span class=\"p\">.</span><span class=\"n\">util</span><span class=\"p\">.</span><span class=\"n\">make_position_params</span><span class=\"p\">();</span>\n    <span class=\"kd\">local</span> <span class=\"n\">sess</span> <span class=\"o\">=</span> <span class=\"nb\">require</span><span class=\"s1\">'lean.rpc'</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">);</span>\n    <span class=\"nb\">require</span><span class=\"s1\">'plenary.async'</span><span class=\"p\">.</span><span class=\"n\">void</span><span class=\"p\">(</span><span class=\"kr\">function</span><span class=\"p\">()</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">notify</span><span class=\"p\">(</span><span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">inspect</span><span class=\"p\">(</span><span class=\"n\">sess</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">vim</span><span class=\"p\">.</span><span class=\"n\">tbl_extend</span><span class=\"p\">(</span><span class=\"s1\">'keep'</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">extras</span><span class=\"p\">))))</span> <span class=\"kr\">end</span><span class=\"p\">)()</span>\n  <span class=\"kr\">end</span>\n</code></pre></div>\n<p>right?</p>",
        "id": 464745290,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724447386
    },
    {
        "content": "<p>Now we are back on track. We donâ€™t even need a custom Lean toolchain. It turns out the existing extensibility through RPC method is enough for us.</p>",
        "id": 464745446,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724447460
    },
    {
        "content": "<p>Yep that looks ok -- just beware that when you say <code>0</code> there you are referring to the current buffer (and same if you pass no argument to make_position_params), so you always need to run that from the Lean buffer. If you get tired of that you can use that 4 lines of filter code in my code block to \"find any window that's open that's a lean buffer and run this in there\".</p>",
        "id": 464745504,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447502
    },
    {
        "content": "<p>Yes, this is a very good find, and clearly I should have remembered we already had this before.</p>",
        "id": 464745532,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447518
    },
    {
        "content": "<p>Oh, the <code>vim.notify(vim.inspect(</code> prints strings with <code>\\n</code> instead of printing new lines. Thatâ€™s a bit painful.</p>",
        "id": 464745928,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724447711
    },
    {
        "content": "<p><code>vim.notify(type(result) == \"string\" and result or vim.inspect(result))</code>  perhaps</p>",
        "id": 464746072,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724447787
    },
    {
        "content": "<p>This is not very robust but good enough for now, thanks!</p>",
        "id": 464746654,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724448098
    },
    {
        "content": "<p>Now I guess Iâ€™m back to learning how to make new text objects and motions.</p>",
        "id": 464746679,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724448116
    },
    {
        "content": "<p>You can also go back to <code>vim.print</code>, it's whatever is least painful really.</p>",
        "id": 464746806,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448178
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/User.20defined.20LSP.20extensions/near/464746679\">said</a>:</p>\n<blockquote>\n<p>Now I guess Iâ€™m back to learning how to make new text objects and motions.</p>\n</blockquote>\n<p>Here is an article on how to create text objects -- <a href=\"https://thevaluable.dev/vim-create-text-objects/\">https://thevaluable.dev/vim-create-text-objects/</a> -- but it's both super long winded and a bit out of date it seems, you should do it with <code>vim.keymap.set({'x', 'o'}, 'D -- or whatever letter you want to put it on', function() something end, {buffer = true}))</code></p>",
        "id": 464747338,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448459
    },
    {
        "content": "<p>I would actually possibly start by implementing <code>]m</code> and <code>[m</code> -- this is an (existing) mapping which is supposed to move you to the start of methods/functions/whatever -- so you could start by taking your \"find me where the declaration ends\" and then use that to reimplement ]m properly for Lean</p>",
        "id": 464747804,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448685
    },
    {
        "content": "<p>That would be a normal mode mapping, rather than an operator pending one (i.e. a text object)</p>",
        "id": 464747838,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448702
    },
    {
        "content": "<p>Implementing <code>]t</code> (that doesn't exist but we could invent) for \"move me to the next tactic\" would be similar and obviously super useful.</p>",
        "id": 464748096,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448822
    },
    {
        "content": "<p>Both of those will end up calling <code>vim.api.nvim_win_set_cursor</code> -- that's the function that lets you move the cursor to some arbitrary position (i.e. the one you get back from the lean server!)</p>",
        "id": 464748218,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724448867
    },
    {
        "content": "<p>Thanks! I need to sleep, so that will be for another day. Before going to sleep, I made sure to reimplement all my tests in the new style. The new full Lean file is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">FileWorker</span><span class=\"w\"> </span><span class=\"n\">RequestM</span>\n\n<span class=\"sd\">/-- Is this the `SyntaxNodeKind` of a tactic syntax? Currently a very crude heuristic. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">SyntaxNodeKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic</span><span class=\"w\"> </span><span class=\"n\">kind</span>\n\n<span class=\"sd\">/-- In the given syntax stack, find the first item satisfying the condition `cond`</span>\n<span class=\"sd\">and run `code` on it. Return `none` if no such item exists.  -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Stack</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkRpcAtMethod</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">RpcEncodable</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">text</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkRpcRangeAtMethod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">mkRpcAtMethod</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">map</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcDeclarationRangeAt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRpcRangeAtMethod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.declaration</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcTacticRangeAt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRpcRangeAtMethod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"bp\">.</span><span class=\"n\">isTactic</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcTacticSeqRangeAt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRpcRangeAtMethod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic.tacticSeq</span><span class=\"o\">)</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rpcBinderRangeAt</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mkRpcAtMethod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`Lean.Parser.Term.explicitBinder</span><span class=\"o\">,</span><span class=\"ss\">`Lean.Parser.Term.implicitBinder</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getKind</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"o\">)</span>\n\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Position</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Range</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">syntaxStack</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{res}</span><span class=\"se\">\\n\\n</span><span class=\"s2\">{stx.getKind}</span><span class=\"se\">\\n</span><span class=\"s2\">{stx}</span><span class=\"se\">\\n</span><span class=\"s2\">{repr &lt;| rg.toLspRange text}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">res</span>\n</code></pre></div>",
        "id": 464750175,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724449933
    },
    {
        "content": "<p>Something disappointing is that I donâ€™t get the expected result when the cursor is on a white space. Iâ€™ll need to investigate this.</p>",
        "id": 464750233,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724449981
    },
    {
        "content": "<p>But you can already play with those RPC methods if you want. Now that they are separated from each other, they donâ€™t take any extra argument.</p>",
        "id": 464750276,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724450026
    },
    {
        "content": "<p>Very nice, ok, thanks already for pushing this forward Patrick -- I would like to probably find a beer tonight rather than fight with more computers, but I'll poke at it again at some point myself too.</p>",
        "id": 464751133,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724450360
    },
    {
        "content": "<p>No problem, finding a beer is also a nice project!</p>",
        "id": 464751654,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724450476
    },
    {
        "content": "<p>If any Lean meta-programming expert is still reading this despite the wall of Lua-related question, I can minimize my white space issue to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">FileWorker</span><span class=\"w\"> </span><span class=\"n\">RequestM</span>\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Position</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">Range</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">syntaxStack</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TextDocumentPositionParams</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">lspPosToUtf8Pos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">position</span>\n<span class=\"w\">  </span><span class=\"n\">withWaitFindSnap</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">notFoundX</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"s2\">\"No snapshot found\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">findStack?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">hoverPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"No syntax stack found\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{res}</span><span class=\"se\">\\n\\n</span><span class=\"s2\">{stx.getKind}</span><span class=\"se\">\\n</span><span class=\"s2\">{stx}</span><span class=\"se\">\\n</span><span class=\"s2\">{repr &lt;| rg.toLspRange text}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">res</span>\n</code></pre></div>\n<p>Calling the <code>syntaxStack</code> function with a position where there is white space in the middle of interesting Lean code returns <code>\"No syntax stack found\"</code> which is a bit disappointing.</p>",
        "id": 464752268,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724450622
    },
    {
        "content": "<p>(I know this function never return <code>None</code>, I just turned the <code>None</code> into debugging strings).</p>",
        "id": 464752540,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724450684
    },
    {
        "content": "<p>Julian, I made <a href=\"https://github.com/PatrickMassot/LspExperiments\">https://github.com/PatrickMassot/LspExperiments</a> so that you can play with the code if you want.</p>",
        "id": 464754260,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724451263
    },
    {
        "content": "<p>The only lua code I added in the plugin is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">ppresult</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">vim</span><span class=\"bp\">.</span><span class=\"n\">notify</span><span class=\"o\">(</span><span class=\"n\">type</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"string\"</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">vim</span><span class=\"bp\">.</span><span class=\"n\">inspect</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">))</span>\n<span class=\"kn\">end</span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">LeanRpc</span><span class=\"o\">(</span><span class=\"n\">method</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">extras</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">vim</span><span class=\"bp\">.</span><span class=\"n\">lsp</span><span class=\"bp\">.</span><span class=\"n\">util</span><span class=\"bp\">.</span><span class=\"n\">make_position_params</span><span class=\"o\">()</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">sess</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">require'lean</span><span class=\"bp\">.</span><span class=\"n\">rpc'</span><span class=\"bp\">.</span><span class=\"kn\">open</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">require'plenary</span><span class=\"bp\">.</span><span class=\"n\">async'</span><span class=\"bp\">.</span><span class=\"n\">void</span><span class=\"o\">(</span><span class=\"n\">function</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">ppresult</span><span class=\"o\">(</span><span class=\"n\">sess</span><span class=\"o\">:</span><span class=\"n\">call</span><span class=\"o\">(</span><span class=\"n\">method</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">vim</span><span class=\"bp\">.</span><span class=\"n\">tbl_extend</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"n\">keep'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">extras</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"o\">)()</span>\n<span class=\"w\">  </span><span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 464754306,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724451291
    },
    {
        "content": "<p>Then I put my cursor in <code>Test.lean</code> and type things like <code>lua LeanRpc(\"rpcDeclarationRangeAt\", {})</code></p>",
        "id": 464754364,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724451330
    },
    {
        "content": "<p>And now I really need to go to bed.</p>",
        "id": 464754448,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724451366
    },
    {
        "content": "<p>I will probably have very little time during the week-end, but itâ€™s in a state where it will be easy to resume work.</p>",
        "id": 464754512,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724451409
    },
    {
        "content": "<p>Yeah it seems like we're not far from something at least useful to start.</p>",
        "id": 464754531,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724451426
    },
    {
        "content": "<p>I couldn't resist playing at least a bit. Here's a branch (of lean.nvim) with a POC of ]m and [m to move to declaration start and end  -- modulo your whitespace question it should work to move to beginning or end of a declaration using ]m / [m -- <a href=\"https://github.com/Julian/lean.nvim/tree/lsp-experiments\">https://github.com/Julian/lean.nvim/tree/lsp-experiments</a></p>\n<p>It's just an exclusive motion, so the cursor will move to the beginning of the declaration then stay there rather than moving further to the last one right now.</p>",
        "id": 464766839,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724460187
    },
    {
        "content": "<p>It works great!</p>",
        "id": 464813818,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724490866
    }
]