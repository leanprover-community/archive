[
    {
        "content": "<p>Christian Merten was visiting me last week and we were trying to understand the slowness in JacobiZariski. During the process I found that I was able to reliably hang Lean (or at least it seemed to hang). Can anyone else reproduce this? I'm on a mac using VS Code and this is mathlib commit <code>eff9da572aaa6b532c82a3994deceb722cd92cb5</code>, so <code>leanprover/lean4:v4.18.0-rc1</code>.</p>\n<p>In mathlib, create a scratch file containing this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Kaehler</span><span class=\"bp\">.</span><span class=\"n\">JacobiZariski</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"n\">H1Cotangent</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">KaehlerDifferential</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">SMulCommClass</span><span class=\"bp\">.</span><span class=\"n\">of_commMonoid</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">u‚ÇÇ</span><span class=\"w\"> </span><span class=\"n\">u‚ÇÉ</span><span class=\"w\"> </span><span class=\"n\">u‚ÇÑ</span><span class=\"w\"> </span><span class=\"n\">w'</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">uT</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uT</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- this is what seems to trigger the problem</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">map_comp_cotangentComplex_baseChange'</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toComp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtensionHom</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">liftBaseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚àò‚Çó</span>\n<span class=\"w\">      </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">cotangentComplex</span><span class=\"bp\">.</span><span class=\"n\">baseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">cotangentComplex</span><span class=\"w\"> </span><span class=\"bp\">‚àò‚Çó</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">Cotangent</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toComp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtensionHom</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">liftBaseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"c1\">--have : P.Ring = P.toExtension.Ring := rfl</span>\n\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map_cotangentComplex</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>This is an example of a lemma which compiles very slowly, and I can talk at length about why this is but perhaps this is not the place. Wait for the orange bars to disappear (this can take anything from between 4 and 15 seconds depending on your machine). And then in the blank line (line 24) if I type the code from the commented-out line just above, not too fast and not too slow (e.g. at my personal regular typing speed, but don't cut and paste because this is too fast, and not at a snail's pace because this doesn't work either), so the proof ends up as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"c1\">--have : P.Ring = P.toExtension.Ring := rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map_cotangentComplex</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>then, by the time I've got to the end of the line, I have what seems to be <em>permanent</em> orange bars on the statement and proof. My CPU usage rockets up to max, the fan comes on and as far as I can see Lean never recovers. In this state, if I mash the keyboard on e.g. line 10 of the file, then the orange bars just jump up so that they cover from line 10 to the end of the file, and I have to e.g. restart Lean on the file, which cause things to go back to normal, although I can re-trigger the problem by again typing something not too fast and not too slow in the proof.</p>\n<p>No doubt people who know something about how Lean works can explain why the \"not too fast and not too slow\" part is relevant, and what is probably happening here. Can anyone else reproduce? Is it a VS Code thing?</p>",
        "id": 508934047,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743263692
    },
    {
        "content": "<p>Tried this on the web server, crashed after 4 minutes</p>",
        "id": 508939887,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743267376
    },
    {
        "content": "<p>I would guess that each keypress is launching a task that ignores the cancellation token for more than 30s</p>",
        "id": 508946063,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743272245
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16666\">#16666</a> is an example of how to fix this for one tactic at a time</p>",
        "id": 508946163,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743272324
    },
    {
        "content": "<p>Though probably in this case it's the kernel / elaborator that is timing out, not a tactic itself</p>",
        "id": 508946219,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743272399
    },
    {
        "content": "<p>At any rate for your example this would mean a core change, not a mathlib change.</p>",
        "id": 508946295,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743272436
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/hanging.20Lean.204.20in.20VS.20Code/near/508946063\">said</a>:</p>\n<blockquote>\n<p>I would geuss that each keypress is launching a task that ignores the cancellation token for more than 30s</p>\n</blockquote>\n<p>Are you saying that it will terminate in time 30s * number of keypresses? I don't understand several of the words in this claim.</p>",
        "id": 508957720,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743282078
    },
    {
        "content": "<p>My understanding is - whenever you write something, lean says \"hey, start checking this code\", and when you then write something more, it says \"hey, never mind the previous code, here's some new code to check\" - but some code ignores the \"never mind\" command and just keeps running in the background, so when you write \"abc\", you've got code running for \"a\", for \"ab\", and for \"abc\" simultaneously</p>",
        "id": 508958034,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1743282343
    },
    {
        "content": "<p>That matches my experience</p>",
        "id": 508958090,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743282365
    },
    {
        "content": "<p>Here's an example which uses far less mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">CountHeartbeats</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">5000</span>\n<span class=\"w\">  </span><span class=\"c1\">-- have : hjsdlgkjhldfshfkghsldfjkghsdlfjkghsldkfjghsldkjghslkdfjgh</span>\n\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">5000</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>If I start filling in the blank line with <code>have : randomcharactersdfkldlgkjdfgkl</code> (typing not too fast and not too slow) and watch CPU usage whilst typing in more random characters after <code>have :</code> then suddenly it spikes to 2000% (or 1100% on another machine, but basically \"use all availble CPUs\") and that's when you know you've had it.</p>",
        "id": 508958432,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743282659
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/270676-lean4/topic/hanging.20Lean.204.20in.20VS.20Code/near/508958034\">said</a>:</p>\n<blockquote>\n<p>My understanding is - whenever you write something, lean says \"hey, start checking this code\", and when you then write something more, it says \"hey, never mind the previous code, here's some new code to check\" - but some code ignores the \"never mind\" command and just keeps running in the background, so when you write \"abc\", you've got code running for \"a\", for \"ab\", and for \"abc\" simultaneously</p>\n</blockquote>\n<p>What's the 30s thing about?</p>",
        "id": 508962967,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743286815
    },
    {
        "content": "<p>I just picked a random number such that <code>n / keypress_interval &gt; cpu_cores</code></p>",
        "id": 508970275,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743293441
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/hanging.20Lean.204.20in.20VS.20Code/near/508946163\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16666\">#16666</a> is an example of how to fix this for one tactic at a time</p>\n</blockquote>\n<p>This Pr also added <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/MathlibTest/tactic_timeout.lean\">a <code>check_timeouts</code> combinator</a> that can tell you if a particular tactic is ignoring this signatl</p>",
        "id": 508970293,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743293469
    },
    {
        "content": "<p>You could copy the start of that test and use <code>check_timeouts 500 =&gt;</code> in your proof to check that none of the tactics run for longer than 500ms beyond their cancellation</p>",
        "id": 508970369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743293528
    },
    {
        "content": "<p>(<code>check_timeouts 1 =&gt;</code> will crash your PC, so type it in a comment first)</p>",
        "id": 508970380,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743293549
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>This looks like another structure <del>eta</del> projection defeq that the kernel fails to check; if you follow the link in <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/changing.20a.20proof.20can.20break.20a.20later.20proof/near/497320971\">#lean4 &gt; changing a proof can break a later proof @ üí¨</a> you can see we've observed 2-3 occurrences.</p>",
        "id": 508990542,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1743310796
    },
    {
        "content": "<p>I agree, what I was actually analysing at the time is another story :-) This appears to be an independent <code>count_heartbeats</code> bug.</p>",
        "id": 509774061,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743620930
    },
    {
        "content": "<p>But it's good to have a small way to reproduce it now.</p>",
        "id": 509839961,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1743653814
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/270676-lean4/topic/hanging.20Lean.204.20in.20VS.20Code/near/508958034\">said</a>:</p>\n<blockquote>\n<p>Lean says \"hey, start checking this code\", and when you then write something more, it says \"hey, never mind the previous code, here's some new code to check\" - but some code ignores the \"never mind\" command and just keeps running in the background, so when you write \"abc\", you've got code running for \"a\", for \"ab\", and for \"abc\" simultaneously</p>\n</blockquote>\n<p>I found a way to visibly reproduce this on the webeditor:</p>\n<ol>\n<li>go to the top of a large file</li>\n<li>start typing some nonsensical tactic</li>\n<li>watch as the file gets re-elaborated over and over</li>\n</ol>\n<p>In the video, I type  the tactic <code>apply qwertyui</code>,  and the error message slowly changes from unknown identifier 'q', to 'qw', to 'qwe', etc.</p>\n<p><a href=\"/user_uploads/3121/_PrHBg6-CkoU8ctr9L0oy3ZB/elaborationSlowness.mp4\">elaborationSlowness.mp4</a></p>\n<div class=\"message_inline_image message_inline_video\"><a href=\"/user_uploads/3121/_PrHBg6-CkoU8ctr9L0oy3ZB/elaborationSlowness.mp4\" title=\"elaborationSlowness.mp4\"><video preload=\"metadata\" src=\"/user_uploads/3121/_PrHBg6-CkoU8ctr9L0oy3ZB/elaborationSlowness.mp4\"></video></a></div><p>I'm using Mathlib stable (v4.18.0) to show it's not caused by the recent elaboration changes in v4.19.0</p>",
        "id": 512797052,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744887270
    },
    {
        "content": "<p>Note that here the code isn't running simultaneously, but all in a row</p>",
        "id": 512797176,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744887316
    },
    {
        "content": "<p>I can reproduce this in the web editor but not locally using the same file and Lean version (and, in fact, hardware)</p>",
        "id": 512801909,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744888927
    },
    {
        "content": "<p>What is different in the web editor that could cause this discrepancy?</p>",
        "id": 512828127,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744896792
    }
]