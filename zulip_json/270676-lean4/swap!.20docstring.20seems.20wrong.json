[
    {
        "content": "<p>This technically relates to a mathlib4 thing but it feels sufficently close to being relevant outside it that I am asking in this stream.<br>\nReading the docstring for<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Array/Basic.html#Array.swap!\">Array.swap!</a>, it claims that when the inputs are outside the length, there is a panic. But that certainly isn't true for the implementation within Lean, and it doesn't seem to be true for the external implementation <code> lean_array_swap</code> either.</p>\n<p>Here is the relevant code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">lean_array_swap</span><span class=\"o\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">lean_is_scalar</span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">lean_is_scalar</span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">ui</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">uj</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_to_array</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_size</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ui</span><span class=\"w\"> </span><span class=\"bp\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">uj</span><span class=\"w\"> </span><span class=\"bp\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">lean_array_uswap</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ui</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">uj</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>This really appears to not panic when they are out of bounds, but instead simply just doesn't change the Array. This is in contrast to, say, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Array.get%21#doc\">docs#Array.get!</a>, which does panic there I think.</p>\n<p>This suggests to me that a) <code>Array.swap!</code> is misnamed (! implies a possibility of panic, to me), b) we probably need only one of Array.swapN and Array.swap! (probably the latter).</p>",
        "id": 455108056,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1722341200
    },
    {
        "content": "<p>Doc-string corrected in <a href=\"https://github.com/leanprover/lean4/pull/4869\">lean#4869</a>. I'll consider the naming again soon.</p>",
        "id": 455113469,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1722343142
    },
    {
        "content": "<p>Thanks.</p>",
        "id": 455142176,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1722350747
    },
    {
        "content": "<p>My bad, should have updated the docstring in <a href=\"https://github.com/leanprover/lean4/pull/3197\">https://github.com/leanprover/lean4/pull/3197</a></p>",
        "id": 455204337,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1722368125
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Vector/Basic.html#Vector.swapIfInBounds\">https://leanprover-community.github.io/mathlib4_docs/Init/Data/Vector/Basic.html#Vector.swapIfInBounds</a></p>\n<p>This also has the (incorrect) docstring.</p>",
        "id": 486946169,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733736732
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> FYI</p>",
        "id": 486946210,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733736745
    }
]