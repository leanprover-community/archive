[
    {
        "content": "<p>I want to add a code suggestion to delete a block of text, but currently the link the TryThis tactic suggests has the link text as the replacement text, so if your suggestion is \"\" to just delete text you can't click on anything. I'd like to update TryThis to handle this case properly--the UI change I can imagine is either 1) if the suggestion text is blank, display the suggestion as \"(delete text)\" or 2) make the \"Try this: \" header text be a link if the suggestion text is empty, and then the caller can change the message to be something custom like \"Delete this\". Both seem fine to me, does anyone have an opinion before I make this change and PR it?</p>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> for those curious</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declModifiers</span>\n<span class=\"w\">  </span><span class=\"n\">group</span><span class=\"o\">((</span><span class=\"s2\">\"lemma\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"theorem\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declId</span><span class=\"w\"> </span><span class=\"n\">ppIndent</span><span class=\"o\">(</span><span class=\"n\">declSig</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testtest</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">matchNodeName</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">declId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">matchNodeName</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.declId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"err\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">suggestion</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">TryThis</span><span class=\"bp\">.</span><span class=\"n\">Suggestion</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">suggestion</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"c1\">--- Blank suggestion text causing the issue</span>\n<span class=\"w\">      </span><span class=\"n\">toCodeActionTitle?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"toCodeActionTitle? text\"</span><span class=\"o\">)}</span>\n<span class=\"w\">  </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">TryThis</span><span class=\"bp\">.</span><span class=\"n\">addSuggestion</span><span class=\"w\"> </span><span class=\"n\">declId</span><span class=\"w\"> </span><span class=\"n\">suggestion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"header text: \"</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mythm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 499926039,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1739635408
    },
    {
        "content": "<p>There is a third option: Extend the API to give control over the text of the try-this link. This is also needed with very large try-this code actions. (This is the “alternative text” part of <a href=\"https://github.com/leanprover/lean4/issues/4551\">https://github.com/leanprover/lean4/issues/4551</a>)</p>\n<p>According to <a href=\"https://github.com/leanprover/lean4/issues/4551#issuecomment-2212462024\">https://github.com/leanprover/lean4/issues/4551#issuecomment-2212462024</a> for mathlib you can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/ProofWidgets/Component/MakeEditLink.html#ProofWidgets.MakeEditLink\">https://leanprover-community.github.io/mathlib4_docs/ProofWidgets/Component/MakeEditLink.html#ProofWidgets.MakeEditLink</a> instead of <code>TryThis</code> with more flexibility.</p>\n<p>Also relevant maybe: <a href=\"https://github.com/leanprover/lean4/issues/2064\">https://github.com/leanprover/lean4/issues/2064</a></p>",
        "id": 499948835,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1739652164
    },
    {
        "content": "<p>Thanks for the links!</p>",
        "id": 499949486,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1739652617
    },
    {
        "content": "<p>Another thing I find myself wanting to do: Don't just make a user-facing suggestion, but also make the actual edit on disk. In normal cases obviously this is not desirable, but if I'm writing a linter with lots of suggestions, this is easier than trying to do it in the IDE or writing a script to make the edits since every change may cause other downstream changes that you then also want to apply, without iteratively re-building mathlib mutliple times</p>",
        "id": 500936441,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1740073266
    },
    {
        "content": "<p>This seems to be supported in theory via LSP CodeActions: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Lsp.WorkspaceEdit#doc\">docs#Lean.Lsp.WorkspaceEdit</a> I just don't see it implemented anywhere yet, corrections welcome!</p>",
        "id": 500936844,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1740073442
    },
    {
        "content": "<p>I guess one problem is that since you're editing a file as it's being compiled, this may require some deep compiler/lake integration to work the way you expect it to, depending on your use case.</p>",
        "id": 500937249,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1740073580
    },
    {
        "content": "<p>Re: TryThis suggestions for deletion, specifically: I think it would be intuitive for the suggestion in the infoview to repeat the source text but styled as red and struck-through, so that you can see what is being deleted as you click on it, without having to look somewhere else.</p>\n<p>This still requires changing the behavior of TryThis to not display an empty string; I fully support any attempt to make TryThis much more flexible! :) Some infoview improvements have landed since the API was designed, and it's probably time for an overhaul.</p>\n<p>I also think it makes sense to have <em>both</em> control over the suggestion text and sensible behavior when suggesting <code>\"\"</code> to avoid putting needless responsibility on the caller of TryThis.</p>",
        "id": 501180288,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1740169088
    }
]