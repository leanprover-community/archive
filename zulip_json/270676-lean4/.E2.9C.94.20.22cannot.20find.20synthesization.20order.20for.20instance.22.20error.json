[
    {
        "content": "<p>I run into an issue when trying to make this code polymorphic:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>That is, this instance gives an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pretty</span><span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"txt\"><pre><span></span><code>cannot find synthesization order for instance @instMonadLiftExceptIOOfRepr_test with type\n  {ε : Type u_1} → [inst : Repr ε] → MonadLift (Except ε) IO\nall remaining arguments have metavariables:\n  Repr ?ε\n</code></pre></div>\n<p>I've read all the Zulip threads mentioning \"synthesization order\" as well as the <a href=\"https://leanprover-community.github.io/mathematics_in_lean/C07_Hierarchies.html\">only reference to it in any manual</a>, and I have no idea what might be causing it. I've also tried fiddling with the universe parameters explicitly, restricting <code>u</code> to <code>Type 0</code>, creating the instance as a <code>def</code> first, etc.</p>",
        "id": 493231412,
        "sender_full_name": "Will Bradley",
        "timestamp": 1736724269
    },
    {
        "content": "<p>The issue here is that <code>MonadLift</code>'s first argument is <code>semiOutParam</code>, which means that instances need to provide a concrete value for the first argument given the second argument. There isn't anything in this instance that specifies <code>ε</code> (for instance via instance arguments with <code>ε</code> appearing in one of the (semi-)out-params), and this \"cannot find synthesization order\" error is trying to communicate that nothing is determining <code>ε</code>.</p>",
        "id": 493263003,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736746917
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.22cannot.20find.20synthesization.20order.20for.20instance.22.20error/near/493263003\">said</a>:</p>\n<blockquote>\n<p>The issue here is that <code>MonadLift</code>'s first argument is <code>semiOutParam</code>, which means that instances need to provide a concrete value for the first argument given the second argument. There isn't anything in this instance that specifies <code>ε</code> (for instance via instance arguments with <code>ε</code> appearing in one of the (semi-)out-params), and this \"cannot find synthesization order\" error is trying to communicate that nothing is determining <code>ε</code>.</p>\n</blockquote>\n<p>I see. Is there a way to fix this other than putting <code>set_option synthInstance.checkSynthOrder false in</code> above the instance declaration?</p>",
        "id": 493329002,
        "sender_full_name": "Will Bradley",
        "timestamp": 1736768590
    },
    {
        "content": "<p>Kyle's explanation is that the only way to fix this would to change <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MonadLift#doc\">docs#MonadLift</a> to not use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=semiOutParam#doc\">docs#semiOutParam</a></p>",
        "id": 493329866,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736768863
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"674953\">Will Bradley</span> has marked this topic as resolved.</p>",
        "id": 493562133,
        "sender_full_name": "Notification Bot",
        "timestamp": 1736853387
    }
]