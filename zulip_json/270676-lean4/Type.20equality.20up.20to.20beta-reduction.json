[
    {
        "content": "<p>Hi! Sorry if it already answered somewhere. I have an error at typechecking, where Lean complains that some types <code>foo</code> and <code>bar</code> are not equal. Actually, they are up to beta-reduction. Consider this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- works fine</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>The latter fails with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">USize</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">USize</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>Is there a way to have the typechecker \"try a bit harder\" to show type-equality, or give it a set of hints/tactics to use ? Or do I need to insert a coercion ?</p>\n<p>[EDITED] added <code>toNat</code></p>",
        "id": 537107955,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1756732351
    },
    {
        "content": "<p>What makes you think <code>USize</code> and <code>Nat</code> are the same?</p>",
        "id": 537109189,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756732784
    },
    {
        "content": "<p>And which version of Lean are you using? The error message you quote is not what you get in the online playground.</p>",
        "id": 537109339,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756732828
    },
    {
        "content": "<p>By playground I mean following the link you see in the upper right corner of your code block, leading to <a href=\"https://live.lean-lang.org/#codez=KYDwhgtgDgNsAEAueA1YBjALgewE7wCFtsZ4BmJAXlQx1wDpdhYBLdMTBCzXAVwQC0A+AHc8AawDO8AGYsAdsABQoSLATI0WPIWKkKialrqNmMNhwQAKMsgCqAZRYAvYAEp4PfvCGywLGEklIA\">https://live.lean-lang.org/#codez=KYDwhgtgDgNsAEAueA1YBjALgewE7wCFtsZ4BmJAXlQx1wDpdhYBLdMTBCzXAVwQC0A+AHc8AawDO8AGYsAdsABQoSLATI0WPIWKkKialrqNmMNhwQAKMsgCqAZRYAvYAEp4PfvCGywLGEklIA</a></p>",
        "id": 537109457,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756732867
    },
    {
        "content": "<p>which says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">USize</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">application</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 537109534,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756732893
    },
    {
        "content": "<p>which seems a very reasonable error message.</p>",
        "id": 537109575,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756732909
    },
    {
        "content": "<p><code>example : Vector Bool 3 := Vector.replicate ((3: USize).toNat) true</code> also fails but indeed <code>(3: USize).toNat</code> doesn’t seem to be definitionally equal to <code>3 : Nat</code>.</p>",
        "id": 537109925,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756733012
    },
    {
        "content": "<p>Yes indeed my minimized example was too minimized and missing a coercion from <code>Usize</code> to <code>Nat</code>.<br>\nThe actual example is the one you've written:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>How can I convince the typechecker that <code>(3: Usize).toNat</code> is <code>3 : Nat</code>, at typechecking time ?</p>",
        "id": 537110564,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1756733211
    },
    {
        "content": "<p>I've edited the first message to show the error I'm interested in</p>",
        "id": 537110739,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1756733267
    },
    {
        "content": "<p>You'll need a cast:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">USize</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The reason this doesn't work in the first place is because <code>USize.toNat 3</code> is equivalent to <code>3 % 2 ^ System.Platform.numBits</code> where <code>System.Platform.numBits</code> is an opaque system-dependent constant (i.e. they aren't definitionally equivalent and there's no way to force them to be). The solution here is to use a cast where you can use regular equality instead of definitional equality.</p>",
        "id": 537111354,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756733457
    },
    {
        "content": "<p>You can’t convince the type checking system that something is true by definition when it’s not.</p>",
        "id": 537111452,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1756733489
    },
    {
        "content": "<p>This seems to be a failure of canonicity (which states that every closed term of type Nat reduces to a normal form). Lean deliberately sacrifices canonicity for other properties deemed more important, so it should be expected that some things might fail, but I'm not sure why this particular example fails.</p>",
        "id": 537362115,
        "sender_full_name": "Niels Voss",
        "timestamp": 1756846240
    },
    {
        "content": "<p>well you have opaque constants so</p>",
        "id": 537362204,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756846279
    },
    {
        "content": "<p>I certainly wouldn't want <code>System.Platform.numBits</code> to reduce to any numeral since it's system dependent</p>",
        "id": 537362291,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756846324
    },
    {
        "content": "<p>and <code>USize</code> wraps a <code>BitVec System.Platform.numBits</code></p>",
        "id": 537362383,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756846369
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"746143\">Clément Blaudeau</span> <a href=\"#narrow/channel/270676-lean4/topic/Type.20equality.20up.20to.20beta-reduction/near/537110564\">said</a>:</p>\n<blockquote>\n<p>How can I convince the typechecker that <code>(3: Usize).toNat</code> is <code>3 : Nat</code>, at typechecking time ?</p>\n</blockquote>\n<p>You add a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Vector.cast#doc\">docs#Vector.cast</a></p>",
        "id": 537362637,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756846467
    },
    {
        "content": "<p>To be clear, I agree with Lean's decision to sacrifice canonicity</p>",
        "id": 537363482,
        "sender_full_name": "Niels Voss",
        "timestamp": 1756846849
    }
]