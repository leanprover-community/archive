[
    {
        "content": "<p>I have a local repo in which I have added LeanHammer and Repl to the dependencies and when I run the following code, it works great and it prints a long list of premises for me. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">json</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">os</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">sys</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Any</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"~/SorryDBTest422\"</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Change</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">chdir</span><span class=\"o\">(</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"o\">)</span>\n\n<span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">Popen</span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"s2\">\"lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"exe\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"repl\"</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">stdin</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">bufsize</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"bp\">=</span><span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">environ</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Explicitly</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">working</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">send_command</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">json_command</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">dumps</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ensure_ascii</span><span class=\"bp\">=</span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"o\">(</span><span class=\"n\">json_command</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">flush</span><span class=\"o\">()</span>\n\n<span class=\"w\">    </span><span class=\"n\">response_lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">stdout_line</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">readline</span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">stdout_line</span><span class=\"bp\">.</span><span class=\"n\">strip</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">break</span>\n<span class=\"w\">        </span><span class=\"n\">response_lines</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">stdout_line</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">loads</span><span class=\"o\">(</span><span class=\"s2\">\"\"</span><span class=\"bp\">.</span><span class=\"n\">join</span><span class=\"o\">(</span><span class=\"n\">response_lines</span><span class=\"o\">))</span>\n\n\n<span class=\"n\">lol</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">send_command</span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"s2\">\"cmd\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"import Mathlib </span><span class=\"se\">\\n</span><span class=\"s2\"> import PremiseSelection </span><span class=\"se\">\\n</span><span class=\"s2\"> example : (2:Nat) + 2 = 4 := by premises\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"allTactics\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">})</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">lol</span><span class=\"o\">)</span>\n<span class=\"n\">env_import</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lol</span><span class=\"o\">[</span><span class=\"s2\">\"env\"</span><span class=\"o\">]</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">env_import</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Now if I try to jazz things up and adapt this script  (with lots of help from Claude) so that it also clones a repo and adds the required dependencies (REPL, LeanHammer) things stop working: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">json</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">os</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">sys</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Any</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">tempfile</span>\n\n\n<span class=\"n\">GIT_REPO_URL</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/dhyan-aranha/SorryDBTest422/\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run_command</span><span class=\"o\">(</span><span class=\"n\">cmd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">None</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"Helper function to run shell commands\"\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"o\">(</span><span class=\"n\">cmd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">shell</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">cwd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">capture_output</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">returncode</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Error running command: {cmd}\"</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Error output: {result.stderr}\"</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">raise</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Command failed: {cmd}\"</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">stdout</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">temporary</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">repository</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Cloning repository...\"</span><span class=\"o\">)</span>\n<span class=\"n\">temp_dir</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tempfile</span><span class=\"bp\">.</span><span class=\"n\">mkdtemp</span><span class=\"o\">(</span><span class=\"kn\">prefix</span><span class=\"bp\">=</span><span class=\"s2\">\"lean_project_\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Clone</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">repository</span>\n<span class=\"n\">run_command</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"git clone {GIT_REPO_URL}\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">temp_dir</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">repository</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">URL</span>\n<span class=\"n\">repo_name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">GIT_REPO_URL</span><span class=\"bp\">.</span><span class=\"n\">rstrip</span><span class=\"o\">(</span><span class=\"bp\">'/'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">split</span><span class=\"o\">(</span><span class=\"bp\">'/'</span><span class=\"o\">)[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">replace</span><span class=\"o\">(</span><span class=\"bp\">'.</span><span class=\"n\">git'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">''</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"n\">cloned</span><span class=\"w\"> </span><span class=\"n\">repo</span><span class=\"w\"> </span><span class=\"n\">location</span>\n<span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">path</span><span class=\"bp\">.</span><span class=\"n\">join</span><span class=\"o\">(</span><span class=\"n\">temp_dir</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">repo_name</span><span class=\"o\">)</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Project cloned to: {LEAN_PROJECT_ROOT}\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Change</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">chdir</span><span class=\"o\">(</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Read</span><span class=\"w\"> </span><span class=\"n\">existing</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">toml</span>\n<span class=\"n\">lakefile_path</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">path</span><span class=\"bp\">.</span><span class=\"n\">join</span><span class=\"o\">(</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"lakefile.toml\"</span><span class=\"o\">)</span>\n<span class=\"k\">with</span><span class=\"w\"> </span><span class=\"kn\">open</span><span class=\"o\">(</span><span class=\"n\">lakefile_path</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">r'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">lakefile_content</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">read</span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">dependencies</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">present</span>\n<span class=\"n\">repl_dependency</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">[[require]]</span>\n<span class=\"s2\">name = \"</span><span class=\"n\">REPL</span><span class=\"s2\">\"</span>\n<span class=\"s2\">git = \"</span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">repl</span><span class=\"s2\">\"</span>\n<span class=\"s2\">rev = \"</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">22</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"s2\">\"</span>\n<span class=\"s2\">\"\"\"</span>\n\n<span class=\"n\">hammer_dependency</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">[[require]]</span>\n<span class=\"s2\">name = \"</span><span class=\"n\">Hammer</span><span class=\"s2\">\"</span>\n<span class=\"s2\">git = \"</span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">JOSHCLUNE</span><span class=\"bp\">/</span><span class=\"n\">LeanHammer</span><span class=\"s2\">\"</span>\n<span class=\"s2\">rev = \"</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">22</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"s2\">\"</span>\n<span class=\"s2\">\"\"\"</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"s2\">\"name = </span><span class=\"se\">\\\"</span><span class=\"s2\">REPL</span><span class=\"se\">\\\"</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lakefile_content</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">lakefile_content</span><span class=\"w\"> </span><span class=\"bp\">+=</span><span class=\"w\"> </span><span class=\"n\">repl_dependency</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Added REPL dependency to lakefile.toml\"</span><span class=\"o\">)</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"s2\">\"name = </span><span class=\"se\">\\\"</span><span class=\"s2\">Hammer</span><span class=\"se\">\\\"</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lakefile_content</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">lakefile_content</span><span class=\"w\"> </span><span class=\"bp\">+=</span><span class=\"w\"> </span><span class=\"n\">hammer_dependency</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Added Hammer dependency to lakefile.toml\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Write</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">toml</span>\n<span class=\"k\">with</span><span class=\"w\"> </span><span class=\"kn\">open</span><span class=\"o\">(</span><span class=\"n\">lakefile_path</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">w'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"o\">(</span><span class=\"n\">lakefile_content</span><span class=\"o\">)</span>\n\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Running lake update...\"</span><span class=\"o\">)</span>\n<span class=\"n\">run_command</span><span class=\"o\">(</span><span class=\"s2\">\"lake update\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"o\">)</span>\n\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Running lake build...\"</span><span class=\"o\">)</span>\n<span class=\"n\">run_command</span><span class=\"o\">(</span><span class=\"s2\">\"lake build\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">LEAN_PROJECT_ROOT</span><span class=\"o\">)</span>\n\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Starting REPL process...\"</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Start</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"w\"> </span><span class=\"n\">process</span>\n<span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">Popen</span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"s2\">\"lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"exe\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"repl\"</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">stdin</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">bufsize</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"bp\">=</span><span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">environ</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">cwd</span><span class=\"bp\">=</span><span class=\"n\">LEAN_PROJECT_ROOT</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">send_command</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">json_command</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">dumps</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ensure_ascii</span><span class=\"bp\">=</span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"o\">(</span><span class=\"n\">json_command</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">flush</span><span class=\"o\">()</span>\n\n<span class=\"w\">    </span><span class=\"n\">response_lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">stdout_line</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">readline</span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">stdout_line</span><span class=\"bp\">.</span><span class=\"n\">strip</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">break</span>\n<span class=\"w\">        </span><span class=\"n\">response_lines</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">stdout_line</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">loads</span><span class=\"o\">(</span><span class=\"s2\">\"\"</span><span class=\"bp\">.</span><span class=\"n\">join</span><span class=\"o\">(</span><span class=\"n\">response_lines</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Execute</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"w\"> </span><span class=\"n\">commands</span>\n<span class=\"n\">lol</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">send_command</span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"s2\">\"cmd\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"import Mathlib </span><span class=\"se\">\\n</span><span class=\"s2\"> import PremiseSelection </span><span class=\"se\">\\n</span><span class=\"s2\"> example : (2:Nat) + 2 = 4 := by premises\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"allTactics\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">})</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">lol</span><span class=\"o\">)</span>\n<span class=\"n\">env_import</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lol</span><span class=\"o\">[</span><span class=\"s2\">\"env\"</span><span class=\"o\">]</span>\n<span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">env_import</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>the output is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">messages'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[{</span><span class=\"bp\">'</span><span class=\"n\">severity'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">error'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">pos'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">line'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">column'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">endPos'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">line'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">column'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">data'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected token '+'; expected ':=', 'where' or '|'\"</span><span class=\"o\">}],</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">env'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"mi\">0</span>\n</code></pre></div>\n<p>instead of a long list of premises like in the previous code. Any ideas about what is going on would be greatly appreciated!</p>",
        "id": 545533754,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760696492
    },
    {
        "content": "<p>Also, if I delete the hammer dependencies and REPL on my local test repo, then do a version of the script which imports them back into the local repo then does lake update and lake build, the REPL works with the premises tactic. So the issue is maybe related to how the cloned repo is being handled as a temp-file?</p>",
        "id": 545549869,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760701997
    },
    {
        "content": "<p>I think removing the script from the equation is probably smart to start -- if I clone your repo and add the 2 dependencies to the lakefile.toml and then run the REPL the same way you did in the script I get the error you show.</p>",
        "id": 545551697,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760702535
    },
    {
        "content": "<p>(Which seems to be a lie, if you replace <code>example : (2:Nat) + 2 = 4 := by premises</code> with <code>#check 37</code> the error says something about <code>\"data\": \"unknown constant 'Unit'\"</code>so I'm not sure how much weight to put into the precise error message, it seems like something just isn't being parsed correctly)</p>",
        "id": 545551986,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760702620
    },
    {
        "content": "<p>Something seems different between your local repository and the one I get from cloning I think, I can't get a working version quite yet with the one I got here. Does your local git repository show any other changes?</p>",
        "id": 545552724,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760702847
    },
    {
        "content": "<p>As far as I can tell they are basically the same.</p>",
        "id": 545553246,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760703023
    },
    {
        "content": "<p>ok there is a slight difference but I doubt it much of an issue. In testSorry.lean I have imported Hammer and in my local repo this commented out. (I know from tests that even locally that if I run the command with import hammer instead of import premise selection things break...but it shouldn't effect things if some file that's not being used imports it?)</p>",
        "id": 545553894,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760703250
    },
    {
        "content": "<p>Usually I see these kinds of errors when you haven't imported prelude</p>",
        "id": 545555232,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760703697
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/using.20LeanHammer's.20premise.20selection.20server.20with.20REPL/near/545555232\">said</a>:</p>\n<blockquote>\n<p>Usually I see these kinds of errors when you haven't imported prelude</p>\n</blockquote>\n<p>im really inexperienced with all of this (sorry!), how would I import prelude?</p>",
        "id": 545556138,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760704000
    },
    {
        "content": "<p>no idea</p>",
        "id": 545564729,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760706524
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"751471\">Dhyan Aranha</span> <a href=\"#narrow/channel/270676-lean4/topic/using.20LeanHammer's.20premise.20selection.20server.20with.20REPL/near/545533754\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">messages'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[{</span><span class=\"bp\">'</span><span class=\"n\">severity'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">error'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">pos'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">line'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">column'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">endPos'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">'</span><span class=\"n\">line'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">column'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">data'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected token '+'; expected ':=', 'where' or '|'\"</span><span class=\"o\">}],</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">env'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"mi\">0</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>That error sounds a lot like <a class=\"message-link\" href=\"/#narrow/channel/113489-new-members/topic/Confusion.20about.20Lean.20REPL/near/537989572\">#new members &gt; Confusion about Lean REPL @ ðŸ’¬</a>  which might be related.</p>",
        "id": 545581608,
        "sender_full_name": "Anthony Wang",
        "timestamp": 1760711314
    },
    {
        "content": "<p>Yeah I also assumed that somehow it was really the import failing here -- I thought (like <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> said in the linked thread) that the import statement might be to blame but the lean-repl README seems to imply it's perfectly supported -- you cannot provide <code>env</code> along with an import, but without one it seems to be supported. Let's try again...</p>",
        "id": 545605016,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760716765
    },
    {
        "content": "<p>OK so I just got it to successfully show me premises at the REPL by doing... absolutely nothing different as far as I can guess. So some funny business is happening -- literally the only thing different that I can think of is that I first opened a real life Lean life in an editor and waited for the import to succeed, then quit and tried the REPL. So let's see if that's really the thing that affects whether it works or not, maybe REPL has some sort of timeout and is killing the process too quickly (in premises' case it needs to build the cache, so presumably the second import is faster).</p>",
        "id": 545606763,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760717063
    },
    {
        "content": "<p>Yeah so that's definitely it here.</p>",
        "id": 545607241,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760717146
    },
    {
        "content": "<p>If I clone the repo, add the 2 dependencies, run <code>lake update</code>, it clones all the dependencies, then <code>lake build</code>, lake exits immediately and does no work, then sending <code>lake exe repl</code>:</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"nt\">\"cmd\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"import Mathlib \\n import PremiseSelection \\n example : (2:Nat) + 2 = 4 := by premises\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nt\">\"allTactics\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">}</span>\n</code></pre></div>\n<p>fails with that obscure syntax error.</p>\n<p>If I open <code>foo.lean</code>, put that exact lean code in it, wait for the file to be processed, then clearly <code>lake</code> <em>does</em> do some work and starts building something. And then if I exit and go back to <code>lake exe repl</code>, the exact same line now works and gives me premises.</p>",
        "id": 545607896,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760717261
    },
    {
        "content": "<p>...so what does it all mean :P, do I need to make repl wait somehow? (Also, thanks a ton Julian for taking a deeper look into this)</p>\n<p>Also, it seems in the documentation for the <a href=\"https://github.com/hanwenzhu/premise-selection\">premise selection server</a>:</p>\n<blockquote>\n<p>The first call to premise selection (byÂ <code>hammer</code>Â or byÂ <code>premises</code>) may be much slower than subsequent calls, due to caching. One should expect the first call in any file session (especially in a downstream project of Mathlib, such as FLT) to be up to 10â€“20 seconds. Unrelatedly, the first call in a downstream project after a server restart may also be much slower (e.g. 2 minutes) due to the time it takes to fill the server-side cache, but subsequent calls in the downstream repository (by any user) will be much faster</p>\n</blockquote>",
        "id": 545753724,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760791616
    },
    {
        "content": "<p>I'll try again when I get back to a computer to have a concrete recommendation -- it seems likely there's a bug somewhere and that you're not doing anything wrong yourself here but I'm not 100% where yet. I doubt purely sleeping is going to help, either there's a timeout parameter that needs tweaking or more likely <code>lake build</code> isn't doing the right thing and we need to figure out why.</p>",
        "id": 545780828,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760819634
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/channel/270676-lean4/topic/using.20LeanHammer's.20premise.20selection.20server.20with.20REPL/near/545607896\">said</a>:</p>\n<blockquote>\n<p>If I clone the repo, add the 2 dependencies, run <code>lake update</code>, it clones all the dependencies, then <code>lake build</code>, lake exits immediately and does no work [..] If I open <code>foo.lean</code>, put that exact lean code in it, wait for the file to be processed, then clearly <code>lake</code> <em>does</em> do some work and starts building something. And then if I exit and go back to <code>lake exe repl</code>, the exact same line now works and gives me premises.</p>\n</blockquote>\n<p>The problem here is likely that <code>lake build</code> on a new package does nothing (as no <code>defaultTargets</code> have been set), whereas opening <code>foo.lean</code> with that code builds its imports (i.e., <code>Mathlib</code> and <code>PremiseSelection</code>). The REPL needs those prebuilt and available in the Lean search path. You can do this without the test file with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">PremiseSelection</span>\n</code></pre></div>",
        "id": 545781140,
        "sender_full_name": "Mac Malone",
        "timestamp": 1760819958
    },
    {
        "content": "<p>There we go, an expert straightens us out :) thanks Mac.</p>",
        "id": 545781823,
        "sender_full_name": "Julian Berman",
        "timestamp": 1760820641
    },
    {
        "content": "<p>Don't use <code>lake build Mathlib</code> before using <code>lake exe cache get</code> though</p>",
        "id": 545783853,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1760823076
    },
    {
        "content": "<p>(fortunately, in Julian's example, cloning the Mathlib dependency also fetches the cache)</p>",
        "id": 545792013,
        "sender_full_name": "Mac Malone",
        "timestamp": 1760834957
    },
    {
        "content": "<p>It works for me! Many thanks to everyone on the thread (esp. <span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span>  and <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> ) <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 545847183,
        "sender_full_name": "Dhyan Aranha",
        "timestamp": 1760897176
    }
]