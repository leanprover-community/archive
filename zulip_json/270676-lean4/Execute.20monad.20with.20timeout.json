[
    {
        "content": "<p>Is there a simple way to run a monad based on <code>CoreM</code> with a timeout?</p>\n<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">runWithTimeout</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">Timeout</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>where <code>runWithTimeout t m</code> would return <code>.ok a</code> if the monad finished in time, and otherwise <code>.error</code> with some timeout object.</p>\n<p>I know there's a field for max heartbeats, but can I just use <code>withCoreContext { maxHeartbeats := ... }</code> to achieve this effect?</p>",
        "id": 469000277,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725951098
    },
    {
        "content": "<p>no, this is a long standing open issue</p>",
        "id": 469018990,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1725955174
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/3812\">lean4#3812</a></p>",
        "id": 469019031,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1725955187
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/stream/270676-lean4/topic/Execute.20monad.20with.20timeout/near/469000277\">said</a>:</p>\n<blockquote>\n<p>I know there's a field for max heartbeats, but can I just use <code>withCoreContext { maxHeartbeats := ... }</code> to achieve this effect?</p>\n</blockquote>\n<p>Yes, that should work as it is effectively what the Lean elaborator does. <em>Someone</em> in the called code just has to call <code>Core.checkSystem</code> sufficiently often, which all the fundamental meta functions do</p>",
        "id": 469041979,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1725960813
    },
    {
        "content": "<p>Could we have a <code>MonadCheckSystem</code> typeclass to make it possible to generalize this? Is there a version of <code>checkSystem</code> for <code>CommandElabM</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">checkSystem</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"c1\">-- fails, wrong type</span>\n</code></pre></div>",
        "id": 469058742,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725966001
    },
    {
        "content": "<p>(the actual application I have in mind is being able to create a no-op implementation of <code>MonadCheckSystem Id</code>, so that you can write a function and prove things about it for <code>m := Id</code>, but then invoke it with interruptibility with <code>m := CoreM</code>)</p>",
        "id": 469059458,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725966196
    },
    {
        "content": "<p>That sounds like something that would be best to introduce locally in your project for now :) . CoreM is currently the only core monad with any heartbeats concept.</p>",
        "id": 469067477,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1725968773
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Execute.20monad.20with.20timeout/near/469018990\">said</a>:</p>\n<blockquote>\n<p>no, this is a long standing open issue</p>\n</blockquote>\n<p>that issue refers to the frontend interface. If I just want to run some random <code>TermElabM</code> with a timeout I could just use a heartbeat, right?</p>",
        "id": 469171724,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725991158
    },
    {
        "content": "<blockquote>\n<p>CoreM is currently the only core monad with any heartbeats concept.</p>\n</blockquote>\n<p>I now remember that I wanted to abstract over <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.checkCanceled#doc\">docs#IO.checkCanceled</a> as well</p>",
        "id": 469179634,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725993381
    },
    {
        "content": "<p>The context is <a href=\"https://github.com/leanprover-community/mathlib4/pull/16666\">#16666</a>, where it would be better if the gaussian elimination algorithm used by <code>linarith</code> didn't have to live in <code>CoreM</code></p>",
        "id": 469179823,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725993448
    }
]