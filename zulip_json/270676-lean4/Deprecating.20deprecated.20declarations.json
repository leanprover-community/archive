[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> and I are working on automating the removal of deprecated declarations.  While doing this, the following issue came up:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"yesterday\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"c1\">-- Could this one raise a deprecation warning on `X`?</span>\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"today\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>As you can see, the suggested replacement for <code>Y</code> is the deprecated declaration <code>X</code>.  However, there is no warning that <code>X</code> is deprecated.</p>\n<p>This means that when the deprecations from <code>yesterday</code> get removed, the declaration <code>X</code> disappears and the command defining <code>Y</code> now raises an error that <code>X</code> does not exist and it may take some effort to figure out what the suggested replacement is.</p>",
        "id": 541909209,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759082612
    },
    {
        "content": "<p>So, would it be possible to get a deprecation warning on <code>X</code> in <code>@[deprecated X (since := \"today\")]</code>?</p>",
        "id": 541909212,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759082616
    },
    {
        "content": "<p>Note that this is similar to <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/No.20warning.20on.20deprecated.20local.20instances/with/525208143\">#lean4 &gt; No warning on deprecated local instances</a> which also comes up when removing deprecated declarations.</p>",
        "id": 541909214,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759082617
    },
    {
        "content": "<p>You can see in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30057\">#30057</a> the cases of this that were uncovered by the automated removal of deprecations.</p>",
        "id": 541918610,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759093419
    },
    {
        "content": "<p>According tp the <code>since</code> statements in this example <code>Y</code> was depreacted after <code>X</code>, so why does <code>Y</code> suggest an already deprecated replacement? That is, the evolution of the code suggested by the since statements is:</p>\n<p><strong>Initial</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p><strong>Yesterday</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"yesterday\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p><strong>Today</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"yesterday\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"c1\">-- Why is this not suggesting `new`?</span>\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"today\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>I imagine these  may be a product of some odd merge order on the PRs. For example, the <code>Y</code> was deprecated by <code>X</code> today, but a in-progress PR deprecated <code>X</code> by <code>new</code> yesterday, and they were then merged in reverse order. However, that seems to suggest the correct solution is to possible error (or linter) if deprecation suggests another deprecated method.</p>",
        "id": 542140189,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759180026
    },
    {
        "content": "<p>I have not investigated how those deprecations arose, but you can see them in the linked PR.  In all cases, the commands are all next to each other.</p>",
        "id": 542142008,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759180698
    },
    {
        "content": "<p>What could have happened is that the deprecation dates are usually set when the PRs is opened, not when it is merged.  So there can be some strange entanglements there.</p>",
        "id": 542142171,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759180765
    },
    {
        "content": "<p>In any case, if the deprecation warning could flag also those uses, that would be great!</p>",
        "id": 542142227,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1759180790
    }
]