[
    {
        "content": "<p>I noticed a weird behavior with <code>grind</code>, where it would fail on a super simple proof, but if we swap the order of the hypothesis, then it works. Should I open an issue about it, or am I missing something?</p>\n<p>I tried to minimize as much as I could, here is the <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- note: if we use only one constructor, the bug disappear</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">constuctor1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">constuctor2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"c1\">-- note: if we replace ≤ by a function T.rel, the bug disappear</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"bp\">.</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"c1\">-- L.pred stays true when t gets bigger</span>\n<span class=\"c1\">-- note: if we replace α by Unit, the bug disappear</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"bp\">.</span><span class=\"n\">pred_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l1</span><span class=\"bp\">.</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l1</span><span class=\"bp\">.</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"bp\">.</span><span class=\"n\">pred_le</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l1</span><span class=\"bp\">.</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t1</span>\n\n<span class=\"c1\">-- from now on, no need for the α to trigger the bug</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">T'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T'</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">L</span>\n\n<span class=\"c1\">-- l keeps the same value when t gets bigger</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">l_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T'</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">l_le</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">t1</span>\n\n<span class=\"c1\">-- construction using l and L.pred</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T'</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t</span>\n\n<span class=\"c1\">-- `pred` stays true when the t grows, `grind` works well</span>\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n\n<span class=\"c1\">-- however if we swap the two hypothesis, `grind` fails</span>\n<span class=\"c1\">-- looking at the e-matching lemmas, L.pred didn't instantiate</span>\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fail_if_success</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- bug</span>\n<span class=\"w\">  </span><span class=\"c1\">-- to make it work, we can swap the hypothesis order</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">  </span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n\n<span class=\"c1\">-- however, if we put the (swapped) hypothesis in an auxiliary predicate, it works again</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">is_mono</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T'</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">is_mono</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">is_mono</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- and if we unfold `is_mono` before calling `grind`, it fails again</span>\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">is_mono</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">is_mono</span>\n<span class=\"w\">  </span><span class=\"n\">fail_if_success</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- bug</span>\n<span class=\"w\">  </span><span class=\"c1\">-- need to swap hypothesis to make grind work</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">  </span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 533841317,
        "sender_full_name": "Théophile",
        "timestamp": 1754934887
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"897795\">@Théophile</span> <a href=\"https://github.com/leanprover/lean4/issues/9825\">https://github.com/leanprover/lean4/issues/9825</a></p>",
        "id": 533842266,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754935287
    },
    {
        "content": "<p>This is probably different since <code>grind</code> fails deterministically here as far as I can tell.</p>",
        "id": 533842573,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754935410
    },
    {
        "content": "<p>Could you open an issue about this please?</p>",
        "id": 533852636,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754939890
    },
    {
        "content": "<p>Done <a href=\"https://github.com/leanprover/lean4/issues/9856\">https://github.com/leanprover/lean4/issues/9856</a></p>",
        "id": 533856487,
        "sender_full_name": "Théophile",
        "timestamp": 1754941516
    },
    {
        "content": "<p>(Just noting that this is now fixed, and will be in the v4.23.0-rc1 release later this week.)</p>",
        "id": 533928009,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754985977
    },
    {
        "content": "<p>what was the fix, for my curiosity?</p>",
        "id": 533935790,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754988905
    },
    {
        "content": "<p>Its attached at the issue</p>",
        "id": 533967784,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1755000800
    }
]