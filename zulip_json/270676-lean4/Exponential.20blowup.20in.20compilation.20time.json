[
    {
        "content": "<p>I have a series of function calls like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"s2\">\"incorrect\"</span>\n<span class=\"n\">checkEq</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"s2\">\"incorrect\"</span>\n<span class=\"n\">checkEq</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"s2\">\"incorrect\"</span>\n<span class=\"n\">checkEq</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"s2\">\"incorrect\"</span>\n<span class=\"n\">checkEq</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n</code></pre></div>\n<p>and with every pair of lines, the compilation time seems to exponentially increase. e.g. with just two pairs, it generated 78M of <code>prof</code> data, but with three pairs it generated 8G of data, and 4 pairs generated 80G of data.</p>\n<p>I profiled the lean executable running on this particular file using <code>perf</code>, and these functions have the highest cycle count:<br>\n<a href=\"/user_uploads/3121/Eev3CqtsywCyiqcdD7b-SQS7/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Eev3CqtsywCyiqcdD7b-SQS7/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1853x211\" src=\"/user_uploads/thumbnail/3121/Eev3CqtsywCyiqcdD7b-SQS7/image.png/840x560.webp\"></a></div><p>With the highest one being <code>lean::replace_rec_fn::apply(lean::expr const&amp;, unsigned int)</code>.</p>\n<p>Is there a way pinpoint the root cause of the blowup?</p>",
        "id": 527119461,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751612757
    },
    {
        "content": "<p>Which version of Lean are you using, and what is the full stack trace of those <code>replace_rec_fn</code> calls?</p>",
        "id": 527196402,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751641275
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"656225\">Cameron Zwarich</span> <a href=\"#narrow/channel/270676-lean4/topic/Exponential.20blowup.20in.20compilation.20time/near/527196402\">said</a>:</p>\n<blockquote>\n<p>Which version of Lean are you using, and what is the full stack trace of those <code>replace_rec_fn</code> calls?</p>\n</blockquote>\n<p>4.21</p>\n<p>The flamegraph looks like this</p>\n<p><a href=\"/user_uploads/3121/V-N42mjLKGOY7KY92j6zrp-S/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/V-N42mjLKGOY7KY92j6zrp-S/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"641x473\" src=\"/user_uploads/thumbnail/3121/V-N42mjLKGOY7KY92j6zrp-S/image.png/840x560.webp\"></a></div>",
        "id": 527213630,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751648384
    },
    {
        "content": "<p>Does trace.profiler give a better answer? It doesn't have any stack size limit at the very least</p>",
        "id": 527219748,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1751652296
    },
    {
        "content": "<p>I found a fix, which involves changing</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">checkTrue</span><span class=\"w\"> </span><span class=\"s2\">\"boo\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"ss\">`Name</span>\n</code></pre></div>\n<p>to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">checkTrue</span><span class=\"w\"> </span><span class=\"s2\">\"boo\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n</code></pre></div>\n<p>and the compilation sped up by a couple hundred times</p>",
        "id": 527220805,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751653062
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/Exponential.20blowup.20in.20compilation.20time/near/527219748\">said</a>:</p>\n<blockquote>\n<p>Does trace.profiler give a better answer? It doesn't have any stack size limit at the very least</p>\n</blockquote>\n<p>No it just outputs a bunch of elaborator messages</p>",
        "id": 527221000,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751653216
    },
    {
        "content": "<p>In the same compilation unit, adding more code causes it to compile faster.</p>\n<p>This takes 5.71s</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">checkTrue</span><span class=\"w\"> </span><span class=\"s2\">\"[2] boo\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"ss\">`Name</span>\n</code></pre></div>\n<p>This takes 520ms</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"s2\">\"Incorrect\"</span>\n<span class=\"w\">  </span><span class=\"n\">checkEq</span><span class=\"w\"> </span><span class=\"s2\">\"[2] boo\"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"ss\">`Name</span>\n<span class=\"w\">  </span><span class=\"n\">checkTrue</span><span class=\"w\"> </span><span class=\"s2\">\"[2] boo\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"ss\">`Name</span>\n</code></pre></div>",
        "id": 527226303,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751657713
    },
    {
        "content": "<p>Do you know why this is so much faster?</p>",
        "id": 527228786,
        "sender_full_name": "Justin Asher",
        "timestamp": 1751660394
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"780541\">Justin Asher</span> <a href=\"#narrow/channel/270676-lean4/topic/Exponential.20blowup.20in.20compilation.20time/near/527228786\">said</a>:</p>\n<blockquote>\n<p>Do you know why this is so much faster?</p>\n</blockquote>\n<p>no but it seems to be related to the exponential compile time problem</p>",
        "id": 527229285,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1751660927
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/channel/270676-lean4/topic/Exponential.20blowup.20in.20compilation.20time/near/527213630\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"656225\">Cameron Zwarich</span> <a href=\"#narrow/channel/270676-lean4/topic/Exponential.20blowup.20in.20compilation.20time/near/527196402\">said</a>:</p>\n<blockquote>\n<p>Which version of Lean are you using, and what is the full stack trace of those <code>replace_rec_fn</code> calls?</p>\n</blockquote>\n<p>4.21</p>\n</blockquote>\n<p>Is it possible for you to try this code with 4.22 rc3? I'm curious if it's fixed by the new compiler. If it's not, would it be possible for you to share this example with me?</p>",
        "id": 527235226,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751667127
    }
]