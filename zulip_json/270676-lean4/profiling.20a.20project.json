[
    {
        "content": "<p>I want to look for some excessive slow declarations in the Carleson project. What is the best way to find these (without visiting every file manually)? I tried adding the following to my <code>lakefile.toml</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">leanOptions</span><span class=\"o\">]</span>\n<span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n</code></pre></div>\n<p>But that gives the error <code>error: lakefile.toml:15:0: error: cannot redefine value key 'leanOptions.profiler'</code></p>",
        "id": 500623660,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739963454
    },
    {
        "content": "<p>Something that prints the per-file compilation time would also be very helpful.</p>",
        "id": 500623739,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739963482
    },
    {
        "content": "<p>Where is the source code that generates <a href=\"https://speed.lean-lang.org/\">https://speed.lean-lang.org/</a> ?</p>",
        "id": 500624041,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739963569
    },
    {
        "content": "<p>That looks like a Lake bug</p>",
        "id": 500636877,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739967823
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/270676-lean4/topic/profiling.20a.20project/near/500624041\">said</a>:</p>\n<blockquote>\n<p>Where is the source code that generates <a href=\"https://speed.lean-lang.org/\">https://speed.lean-lang.org/</a> ?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/scripts/bench/temci-config.run.yml\">https://github.com/leanprover-community/mathlib4/blob/master/scripts/bench/temci-config.run.yml</a></p>",
        "id": 500637849,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739968102
    },
    {
        "content": "<p>The simplest setup is to loop over all files in the project and run <code>lake env time lean -Dprofiler...</code> separately on them, then you don't have to worry about parallelism overhead either</p>",
        "id": 500637969,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739968149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/profiling.20a.20project/near/500636877\">said</a>:</p>\n<blockquote>\n<p>That looks like a Lake bug</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/7147\">lean4#7147</a></p>",
        "id": 500640492,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739968939
    },
    {
        "content": "<p>Thanks for the pointers!</p>",
        "id": 500640558,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739968974
    },
    {
        "content": "<p>For future reference, this gives you a per-file compilation time: (run <code>lake build</code> first)</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>find<span class=\"w\"> </span>Carleson<span class=\"w\"> </span>-type<span class=\"w\"> </span>f<span class=\"w\"> </span>-iname<span class=\"w\"> </span><span class=\"s2\">\"*.lean\"</span><span class=\"w\"> </span>-exec<span class=\"w\"> </span><span class=\"nb\">printf</span><span class=\"w\"> </span><span class=\"s2\">\"\\n{}\\n\"</span><span class=\"w\"> </span><span class=\"se\">\\;</span><span class=\"w\"> </span>-exec<span class=\"w\"> </span>lake<span class=\"w\"> </span>env<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span>lean<span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"se\">\\;</span><span class=\"w\"> </span>&gt;<span class=\"p\">&amp;</span><span class=\"w\"> </span>timing.out\n</code></pre></div>",
        "id": 500647925,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739971064
    },
    {
        "content": "<p>You can add <code>-Dprofiler=true</code> after the <code>lean</code> command to also profile each file.</p>",
        "id": 500648496,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739971214
    },
    {
        "content": "<p>This also shows all info/warning messages, even when I pass the <code>-q</code> option, as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">MyFile</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n</code></pre></div>\n<p>Is that intended?</p>",
        "id": 500648566,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739971242
    },
    {
        "content": "<p>I think that flag hasn't done anything in any Lean 4 version. So I don't even remember anymore what its exact semantics in Lean 3 were.</p>",
        "id": 500650140,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739971712
    }
]