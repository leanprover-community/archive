[
    {
        "content": "<p>I ran into a weird <code>too many explicit universe levels</code> error recently and thought I would share here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Computability</span><span class=\"bp\">.</span><span class=\"n\">Language</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">FirstOrder</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"c1\">-- L1 : FirstOrder.Language</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">L2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"c1\">-- \"too many explicit universe levels\"</span>\n</code></pre></div>\n<p>The universe level error does not occur if you comment out the <code>Mathlib.Computability.Language</code> import, so it seems likely that Lean is confusing <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FirstOrder.Language#doc\">docs#FirstOrder.Language</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Language#doc\">docs#Language</a> when calculating the correct number of universe levels, despite the fact that it otherwise interprets the type as <code>FirstOrder.Language</code>.</p>",
        "id": 542851632,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759452013
    },
    {
        "content": "<p>I found this (unsatisfactory) workaround:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Computability</span><span class=\"bp\">.</span><span class=\"n\">Language</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">L2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FirstOrder</span><span class=\"bp\">.</span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 543051693,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1759544598
    },
    {
        "content": "<p>Oh, I should have mentioned that the bug doesn't occur if you use <code>namespace</code> instead of <code>open</code>, which is potentially relevant</p>",
        "id": 543051754,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759544675
    },
    {
        "content": "<p>so there's another workaround for the time being</p>",
        "id": 543051772,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759544701
    },
    {
        "content": "<p>should I open an issue on GitHub? this seems like a legitimate bug (not a high priority one but still worth fixing at some point)</p>",
        "id": 543051818,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759544752
    },
    {
        "content": "<p>Probably since this is unexpected behavior for sure. But you need a mwe first: remove the imports.</p>",
        "id": 543051919,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1759544873
    },
    {
        "content": "<p>That's not an easy task.</p>",
        "id": 543051960,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1759544930
    },
    {
        "content": "<p>Sorry, I'm a bit unclear on what you mean... aren't the imports necessary for this example? Or are you saying that we need a mwe which doesn't rely on Mathlib?</p>",
        "id": 543051988,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759544967
    },
    {
        "content": "<p>The imports include a lot of things that are not relevant to the issue, which makes diagnosis nearly impossible.</p>\n<p>One mwe path is to have a file with no imports. Replace <code>FirstOrder.Language</code> with a structure with the same fields but filled with sorries. Tren add more and more details until you can reproduce the bug.</p>",
        "id": 543052193,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1759545224
    },
    {
        "content": "<p>Gotcha, will try that.</p>",
        "id": 543052271,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759545315
    },
    {
        "content": "<p>To be fair, I feel like diagnosis should be relatively easy given that the universe level count is determined by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.mkConst#doc\">docs#Lean.Elab.Term.mkConst</a> which appears to rely on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.getConstVal#doc\">docs#Lean.getConstVal</a> ... I'm guessing that <code>getConstVal</code> has access to namespaces but not open declarations. However, I'll see if I can come up with a minimal example anyway. (Also, I have very little knowledge of Lean internals so it's possible that my assumptions here are completely off.)</p>",
        "id": 543053410,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1759546911
    }
]