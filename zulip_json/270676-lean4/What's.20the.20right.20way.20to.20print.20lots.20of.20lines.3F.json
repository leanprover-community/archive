[
    {
        "content": "<p>I'm trying to print all declaration names in the environment. My current code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">isAutoDecl</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>runs for a long time without printing anything. Does it accumulate all those strings before printing them all at once? Can I make it print them one by one? Also, how can I make it work faster?</p>",
        "id": 505865588,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742057698
    },
    {
        "content": "<p><code>#eval</code> does accumulate everything before printing. It needs to capture stdout to accumulate a message to be printed.</p>\n<p>I think it has this limitation even if it's being run from the command line. Potentially we should allow stdout to print immediately in this case, but there's the complexity that <code>#eval</code> is frequently used in conjunction with <code>#guard_msgs</code> in tests, which would need to be detected somehow.</p>\n<p>It shouldn't be too hard to write a<code>#eval_unisolated</code> command that evaluates without using <code>withIsolatedStreams</code> by copying the code.</p>",
        "id": 505869201,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742060341
    },
    {
        "content": "<p>This script takes about 15 minutes on my laptop. Is there something wrong with it (besides using <code>eval</code>)?</p>",
        "id": 505872548,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742062877
    },
    {
        "content": "<p>well, there are around 300,000 declarations with your criteria, so it's gonna take a while to format all the text</p>",
        "id": 505874854,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1742064526
    },
    {
        "content": "<p>3ms per declaration seems like a very long time to me, given what is being checked.</p>\n<p>Maybe it's being dominated by string concatenation, from the isolated streams in eval?</p>",
        "id": 505875934,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742065213
    },
    {
        "content": "<p>You could try writing directly to a file instead</p>",
        "id": 505875971,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742065239
    },
    {
        "content": "<p>When I did this a few weeks ago (and wanted more than just names) I did:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">DocString</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">System</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">DeclInfo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">modulePath</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">docString</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">ToJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">FromJson</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getDeclInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">DeclInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">ppExpr</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">modulePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"bp\">.</span><span class=\"n\">getPrefix</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">docString</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findDocString?</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">declType</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">modulePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modulePath</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">docString</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">docString</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dumpDecls</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">outputHandle</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Handle</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declNames</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">map₁</span><span class=\"bp\">.</span><span class=\"n\">keys</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">declNames</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declInfo</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">getDeclInfo</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">    </span><span class=\"n\">outputHandle</span><span class=\"bp\">.</span><span class=\"n\">putStrLn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">declInfo</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">compress</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">outputPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">head?</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"Please provide an output path\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">withFile</span><span class=\"w\"> </span><span class=\"n\">outputPath</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">outputHandle</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">CoreM</span><span class=\"bp\">.</span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`Mathlib</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dumpDecls</span><span class=\"w\"> </span><span class=\"n\">outputHandle</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"mathlib_decls.json\"</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>in case that's helpful to reuse. Though possibly the declaration export thing in the leanprover org is even more useful (but when running that at least you can tail the file and watch progress).</p>",
        "id": 505875979,
        "sender_full_name": "Julian Berman",
        "timestamp": 1742065248
    },
    {
        "content": "<p>I moved it to an executable file and it works in ~4s.</p>",
        "id": 505878364,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067057
    },
    {
        "content": "<p>Sorry for long delays in replies in a topic I've started: I'm on a plane.</p>",
        "id": 505878407,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067100
    },
    {
        "content": "<p>I wonder what the performance issue is. It could be <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.FS.Stream.ofBuffer#doc\">docs#IO.FS.Stream.ofBuffer</a> having accidental nonlinearity somewhere. There's also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.fromUTF8%21#doc\">docs#String.fromUTF8!</a>, but I'd expect that to be better tested on large byte arrays already.</p>",
        "id": 505880478,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742068768
    },
    {
        "content": "<p>I can't test rn, because my laptop's battery is running low and the outlet in the seat doesn't work. I can try to test it in a few hours.</p>",
        "id": 505882153,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742070033
    },
    {
        "content": "<blockquote>\n<p>There's also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.fromUTF8%21#doc\">docs#String.fromUTF8!</a>, but I'd expect that to be better tested on large byte arrays already.</p>\n</blockquote>\n<p>bv_decide regularly works with this function on up to GB long strings, it's pretty good</p>\n<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/270676-lean4/topic/What's.20the.20right.20way.20to.20print.20lots.20of.20lines.3F/near/505865588\">said</a>:</p>\n<blockquote>\n<p>I'm trying to print all declaration names in the environment. My current code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">isAutoDecl</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>runs for a long time without printing anything. Does it accumulate all those strings before printing them all at once? Can I make it print them one by one? Also, how can I make it work faster?</p>\n</blockquote>\n<p>Looking at a profile of your code it's just stuck formatting after doing initial work<br>\n<a href=\"/user_uploads/3121/3EdNdQec9vVvXmejQg8Jk80R/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/3EdNdQec9vVvXmejQg8Jk80R/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2523x473\" src=\"/user_uploads/thumbnail/3121/3EdNdQec9vVvXmejQg8Jk80R/image.png/840x560.webp\"></a></div><p>So if this was run without the formatting machinery of <code>#eval</code> it would be basically instant.</p>",
        "id": 505884008,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1742071445
    },
    {
        "content": "<p>The reason this bottlenecks on extract is likely due to the following function:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadPrettyFormat</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">WorkGroup</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\">                           </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\">   </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\">    </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">::</span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">gs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">@</span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">::</span><span class=\"n\">is</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">::</span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gs'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">is'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">WorkItem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">is'</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">::</span><span class=\"n\">gs</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">posOf</span><span class=\"w\"> </span><span class=\"bp\">'\\</span><span class=\"n\">n'</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">pushOutput</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">        </span><span class=\"n\">endTags</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">activeTags</span>\n<span class=\"w\">        </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">gs'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">pushOutput</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">pushNewline</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">indent</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">::</span><span class=\"n\">is</span>\n<span class=\"w\">        </span><span class=\"c1\">-- after a hard line break, re-evaluate whether to flatten the remaining group</span>\n<span class=\"w\">        </span><span class=\"n\">pushGroup</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">flb</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">w</span>\n</code></pre></div>\n<p>Our string is of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">foo</span><span class=\"bp\">\\</span><span class=\"n\">n</span>\n<span class=\"n\">bar</span><span class=\"bp\">\\</span><span class=\"n\">n</span>\n<span class=\"n\">foobar</span><span class=\"bp\">\\</span><span class=\"n\">n</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>this function advances us to the next <code>\\n</code>, then does an extract until that <code>\\n</code> and an extract starting at that <code>\\n</code> to the end of the previous string, the C implementation of extract is:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">lean_mk_string_from_bytes_unchecked</span><span class=\"p\">(</span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_mk_string_unchecked</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">utf8_strlen</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">obj_res</span><span class=\"w\"> </span><span class=\"n\">lean_string_utf8_extract</span><span class=\"p\">(</span><span class=\"n\">b_obj_arg</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_obj_arg</span><span class=\"w\"> </span><span class=\"n\">b0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_obj_arg</span><span class=\"w\"> </span><span class=\"n\">e0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// blablablabla</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_mk_string_from_bytes_unchecked</span><span class=\"p\">(</span><span class=\"n\">lean_string_cstr</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">new_sz</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>So what this does is always copy (mk_string_unchecked copies) and recompute utf8_strlen of the remaining part of the string after every newline, given that we have <code>O(n)</code> newlines in the code this comes down to a quadratic behavior</p>",
        "id": 505885631,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1742072787
    },
    {
        "content": "<p>Due to the layout of strings in leans runtime right now it is in fact impossible to not copy the string when doing an <code>extract</code>, <code>strlen</code> might be improvable. Regardless the proper fix is likely to instead maintain a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.Iterator#doc\">docs#String.Iterator</a> as we e.g. also do in the Parsec module</p>",
        "id": 505885841,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1742072980
    },
    {
        "content": "<p><code>Substring</code> would probably also work well here</p>",
        "id": 505886815,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1742073832
    },
    {
        "content": "<p>Another (independent) fix here would be to have <code>#eval</code> have max output configuration, like we have in the pretty printer for the Infoview. It wouldn't help if you wanted the whole output, but at least you wouldn't wait 15 minutes on formatting.</p>",
        "id": 505888678,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742075383
    }
]