[
    {
        "content": "<p>As I'm dealing with larger and larger expressions in some of my meta-code, I would like to be able to print a string like <code>&lt;hover to see expression&gt;</code> (similar to how Lean renders proofs inside terms with <code>...</code>).</p>\n<p>This would still keep the ability that hovering over this expression provides the hover info. Does anyone have a recipe to do this? It'd be super helpful, since I have super large expressions right now, which makes printing good debug information difficult in tactics.</p>",
        "id": 479752694,
        "sender_full_name": "Siddharth Bhat",
        "timestamp": 1730317365
    },
    {
        "content": "<p>Maybe this really hacky experiment still works. I was experimenting with getting hoverable words that show arbitrary docstrings like so:</p>\n<p><a href=\"/user_uploads/3121/H9jzMI1F6eZCxew_pyMk82WP/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/H9jzMI1F6eZCxew_pyMk82WP/image.png\" title=\"image.png\"><img data-original-dimensions=\"1028x248\" src=\"/user_uploads/thumbnail/3121/H9jzMI1F6eZCxew_pyMk82WP/image.png/840x560.webp\"></a></div><p>This should have enough to figure out how to do what you want. I think you can skip everything before <code>mkHover</code>.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div aria-hidden=\"true\" class=\"spoiler-content\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">HoverType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HoverType</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span>\n\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rawStringStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"fmt_as_str%\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkRawStringStx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Syntax.node2</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"ss\">``rawStringStx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAtom</span><span class=\"w\"> </span><span class=\"s2\">\"fmt_as_str%\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax.mkStrLit</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">formatter</span><span class=\"w\"> </span><span class=\"n\">rawStringStx</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">rawStringKindFormatter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Formatter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Syntax.MonadTraverser.getCur</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax.isStrLit</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Formatter.throwBacktrack</span>\n<span class=\"w\">  </span><span class=\"n\">Formatter.pushToken</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">Syntax.MonadTraverser.goLeft</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">app.HoverType.info</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delabHoverTypeInfo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">mkRawStringStx</span><span class=\"w\"> </span><span class=\"s2\">\"Info\"</span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">app.HoverType</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delabHoverType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``HoverType</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">strVal</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr.getExpr</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">mkRawStringStx</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkHoverTypeInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkApp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``HoverType.info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"o\">)</span>\n\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">withAnnotation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">stx.setInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">SourceInfo.synthetic</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">pos</span><span class=\"o\">⟩</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">pos</span><span class=\"o\">⟩)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkHover</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hoverText</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">ofPPFormat</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;missing context&gt;\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ctx.runMetaM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withAnnotation</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">hover</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OmissionInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">          </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">elaborator</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`hover</span>\n<span class=\"w\">            </span><span class=\"n\">stx</span>\n<span class=\"w\">            </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkHoverTypeInfo</span><span class=\"w\"> </span><span class=\"n\">header</span>\n<span class=\"w\">            </span><span class=\"n\">expectedType</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">            </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hoverText</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">fmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">RBMap.fromArray</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofOmissionInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hoverMsg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"err\">\\</span>\n<span class=\"s2\">    Wow! The hover *worked*!</span><span class=\"err\">\\</span>\n<span class=\"s2\">    </span><span class=\"se\">\\n</span><span class=\"err\">\\</span>\n<span class=\"s2\">    </span><span class=\"se\">\\n</span><span class=\"s2\">This area supports **Markdown** since it counts as a docstring.</span>\n<span class=\"s2\">    \"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"The word {mkHover \"</span><span class=\"n\">_hover_</span><span class=\"s2\">\" \"</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">hover</span><span class=\"w\"> </span><span class=\"n\">window</span><span class=\"s2\">\" hoverMsg} here is hoverable.\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">test</span>\n</code></pre></div>\n</div></div>",
        "id": 479753320,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730317633
    },
    {
        "content": "<p>The <code>OmissionInfo</code> is how ... works, so it still seems appropriate here. Using <code>TermInfo</code> would mean that hovering over terms would be put into pp.explicit mode, which I assume is undesirable.</p>",
        "id": 479753663,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730317766
    },
    {
        "content": "<p>Right, this seems exactly what I was looking for</p>",
        "id": 479753712,
        "sender_full_name": "Siddharth Bhat",
        "timestamp": 1730317789
    }
]