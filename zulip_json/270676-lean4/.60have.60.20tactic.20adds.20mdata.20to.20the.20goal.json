[
    {
        "content": "<p>The <code>have h : .. := ..</code> tactic changes the goal type by wrapping it in <code>mdata noImplicitLambda:1</code>. This can then confuse other tactics such as <code>simp?</code> (and the <code>simp</code> unused lemma linter). MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- âŠ¢ LE.le.{0} Int Int.instLEInt _uniq.15 _uniq.16</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"w\">  </span><span class=\"c1\">-- âŠ¢ [mdata noImplicitLambda:1 LE.le.{0} Int Int.instLEInt _uniq.15 _uniq.16]</span>\n<span class=\"w\">  </span><span class=\"n\">simp?</span><span class=\"w\"> </span><span class=\"c1\">-- simp only [ge_iff_le]</span>\n</code></pre></div>",
        "id": 529097589,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752683587
    },
    {
        "content": "<p>I think this is a bug in tactics which are confused by the mdata</p>",
        "id": 529097641,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752683605
    },
    {
        "content": "<p>That's true, but I also think it is not intended for <code>have</code> to modify the goal like this.</p>",
        "id": 529097871,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752683694
    },
    {
        "content": "<p>I don't know if this is intended, but it certainly has been the case for as long as I remember.</p>",
        "id": 529100860,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752684786
    },
    {
        "content": "<p>Relatedly, you might be interested in <a href=\"https://github.com/leanprover-community/mathlib4/pull/25500\">#25500</a></p>",
        "id": 529101551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752685034
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60have.60.20tactic.20adds.20mdata.20to.20the.20goal/near/529101551\">said</a>:</p>\n<blockquote>\n<p>Relatedly, you might be interested in <a href=\"https://github.com/leanprover-community/mathlib4/pull/25500\">#25500</a></p>\n</blockquote>\n<p>Yes, that certainly seems useful.</p>",
        "id": 529102165,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752685258
    },
    {
        "content": "<p>Why does <code>have</code> add metadata? Is there a reason?</p>",
        "id": 529102429,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752685355
    },
    {
        "content": "<p>Here is an experiment, although I forget what the answer was at the time: <a href=\"#narrow/channel/287929-mathlib4/topic/.60mdata.60.20puzzle/near/433062983\">#mathlib4 &gt; &#96;mdata&#96; puzzle @ ðŸ’¬</a>.</p>",
        "id": 529102451,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752685361
    },
    {
        "content": "<p>I actually used that to write a metaprogramming test suite, to find tactics that were mishandling goals in various ways.</p>",
        "id": 529102599,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752685424
    },
    {
        "content": "<p>The reason why the mdata is added is because the <code>have</code> tactic is a macro for</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">focus</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">no_implicit_lambda</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But I don't really understand why that adds the mdata.</p>",
        "id": 529103319,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752685699
    },
    {
        "content": "<p>why is it a macro</p>",
        "id": 529103362,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752685722
    },
    {
        "content": "<p>they couldn't come up with a better implementation?</p>",
        "id": 529103440,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752685759
    },
    {
        "content": "<p>I guess so <span aria-label=\"man shrugging\" class=\"emoji emoji-1f937-200d-2642\" role=\"img\" title=\"man shrugging\">:man_shrugging:</span></p>",
        "id": 529103699,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752685873
    },
    {
        "content": "<p>The nice thing about that implementation is that it makes the <code>have</code> tactic behave very similarly to the <code>have</code> term</p>",
        "id": 529103960,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752685939
    },
    {
        "content": "<p>Isn't the problem with <a href=\"https://github.com/leanprover-community/mathlib4/pull/25500\">#25500</a> that it will show <code>no_implicit_lambda%</code> everywhere because the <code>have</code> tactic introduces it everywhere?</p>",
        "id": 529104410,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752686124
    },
    {
        "content": "<p>If <code>no_implicit_lambda%</code> is not supposed to be there, then that's a feature :)</p>",
        "id": 529104675,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752686238
    },
    {
        "content": "<p>But indeed, it does so I guess for now I'll make the PR not do that</p>",
        "id": 529104771,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752686276
    },
    {
        "content": "<p>Ok, <a href=\"https://github.com/leanprover-community/mathlib4/pull/25500\">#25500</a> is now conservative</p>",
        "id": 529105376,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752686480
    }
]