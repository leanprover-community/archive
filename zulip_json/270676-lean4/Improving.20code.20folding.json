[
    {
        "content": "<p>It would be really nice if code folding allowed me to fold away the proof of a theorem, so I can scroll through my file and see what I've proved. In addition, folding away the proofs of subgoals (even if only ones started by <code>have _ : _ := by</code>) would be super helpful. Having the list of names in the explorer tab is nice, but statements are clearly more valuable than just names!</p>",
        "id": 470161905,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726316198
    },
    {
        "content": "<p>Do you mean that you want code folding to start at the <code>:=</code> rather than just after the first line?</p>",
        "id": 470405721,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726446823
    },
    {
        "content": "<p>I just tried folding a lemma I was looking at in a random file</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">norm_cast</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">add_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÜ</span><span class=\"w\"> </span><span class=\"n\">œà</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutomorphicForm</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"o\">[</span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))</span><span class=\"bp\">À£</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">œÜ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">œà</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÜ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œà</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>and it folds away everything apart from the attribute line :-)</p>",
        "id": 470525179,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726479104
    },
    {
        "content": "<p>It also folds the empty line after the lemma which looks weird</p>",
        "id": 470525410,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726479135
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Improving.20code.20folding/near/470405721\">said</a>:</p>\n<blockquote>\n<p>Do you mean that you want code folding to start at the <code>:=</code> rather than just after the first line?</p>\n</blockquote>\n<p>If I'm understanding your meaning correctly, yes. And I'd like the fold to end on the same line that contains the last line of the proof. And the same rule for <code>have/obtain _ : _ :=</code> blocks</p>",
        "id": 470966123,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726576572
    },
    {
        "content": "<p>We're constrained here by what the code folding API provided by VSCode allows (and I certainly don't know the details). If someone interested in this wanted to do that research...?</p>",
        "id": 471130178,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726619572
    },
    {
        "content": "<p>Not that I know everything inside and out, but this is the LSP method: <a href=\"https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_foldingRange\">https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_foldingRange</a><br>\nI think the first thing to consider is whether setting collapsedText already gets things nice enough (that's the text shown when folded, so one could set it to the type and leave everything else as is without even changing the range -- I don't know for sure that VSCode supports that field but it seems likely and verifiable that it does).<br>\nAdding additional ranges for have I think would be a second bit.</p>",
        "id": 471133622,
        "sender_full_name": "Julian Berman",
        "timestamp": 1726620996
    },
    {
        "content": "<p>This is the server side: <a href=\"https://github.com/leanprover/lean4/blob/21d71de481e3d497a3ceeac85e50b50338b5636d/src/Lean/Server/FileWorker/RequestHandling.lean#L594\">https://github.com/leanprover/lean4/blob/21d71de481e3d497a3ceeac85e50b50338b5636d/src/Lean/Server/FileWorker/RequestHandling.lean#L594</a> -- so probably staring at that is where testing such a change would go I think. If no one else volunteers I can have a closer look though I don't know off hand what thing available there has the type information for what's being folded, if anything.</p>",
        "id": 471134045,
        "sender_full_name": "Julian Berman",
        "timestamp": 1726621217
    },
    {
        "content": "<p>Please make an RFC. I have been neglecting this feature a bit because I wasn't aware that it was seeing lots of usage.</p>",
        "id": 471185660,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1726643623
    },
    {
        "content": "<p>It's definitely possible to make a code action cover whatever span of text you want</p>",
        "id": 471216432,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726652828
    },
    {
        "content": "<p>the pattern match code action does exactly that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">                        </span><span class=\"c1\">-- ^ generate a skeleton for the structure under construction</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 471216780,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726652939
    },
    {
        "content": "<p>note that the <code>:=</code> was deleted even though it is not in the span of the <code>_</code></p>",
        "id": 471216857,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726652960
    },
    {
        "content": "<p>oh whoops I got my lines crossed, this is about folding regions not code actions</p>",
        "id": 471217130,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726653036
    },
    {
        "content": "<p>folding regions are constrained in the UX to be full lines</p>",
        "id": 471217204,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726653059
    },
    {
        "content": "<p>I think the LSP protocol itself allows more but vscode can't do much with intra-line information</p>",
        "id": 471217389,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726653115
    }
]