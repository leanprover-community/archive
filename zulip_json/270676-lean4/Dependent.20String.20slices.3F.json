[
    {
        "content": "<p>I'm finding that one bit of friction with the new string API is remembering that the underlying string of a <code>String.Slice</code> is some particular existing string. By making some string into a <code>String.Slice</code>, we seem to forget that valid positions for the slice are also valid positions for the string it came from.</p>\n<p>(Instead, they're valid positions for the field, and it's easy to lose the unfoldability that is necessary to know one is the same as the other.)</p>\n<p>I've just started using this API, so first: am I missing something, or \"holding it wrong\"? :)</p>\n<p>If not: would it make sense to have dependent slices? Something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">SliceOf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n<span class=\"w\">  </span><span class=\"n\">endExclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n<span class=\"w\">  </span><span class=\"n\">startInclusive_le_endExclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">endExclusive</span>\n</code></pre></div>\n<p>or does this ruin performance somehow?</p>",
        "id": 560035746,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764025271
    },
    {
        "content": "<p>Yes, we want this. The reason why it doesn't exist yet is that adding this will multiply the size of the String API by a factor of two again, and we just didn't have time to do so. Also, it will be easier to do this in one step once the <code>String.Slice</code> API has stabilized a bit more. We are planning to use the names <code>String.Substring</code> and <code>String.Slice.Subslice</code>.</p>\n<p>In the meantime, I'm trying to make sure that most of the interesting equalities <code>someSlice.str = someString</code> are definitional. Let me know if I missed one. We also have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.Slice.Pos.str#doc\">docs#String.Slice.Pos.str</a>, <code>String.Slice.Pos.ofStr</code> (this one hasn't made it into an  RC yet I believe), and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.ValidPos.cast#doc\">docs#String.ValidPos.cast</a>, which should offer a way of dealing with this reasonably (without descending right into DTT hell) even if the equality is not definitional. If this turns out to be annoying in your use case, I would be grateful if you could share some code with me, so that I can improve the API in core.</p>",
        "id": 560076437,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764051912
    },
    {
        "content": "<p>That's great to hear! :)</p>\n<p>Here's a simplified example of what I'm working with. The crux of it, I suppose, is that I'm starting with <code>Syntax.Range</code>s. That makes it convenient to define something that converts it into an <code>Option String.Slice</code>.</p>\n<p>The following example just puts brackets around the provided array of ranges. This only seems convenient with dependent slices; if I want to use <code>Slice</code>, I have to return the equality from my <code>Syntax.Range.toSlice?</code>, and then rewrite with <code>▸</code>.</p>\n<p>Also, a secondary question: what's the preferred way to construct a slice \"by hand\" when the positions and inequality are present? I'm not inclined to use <code>replaceStartEnd</code>, since I don't want to adjust an existing slice; it seems contrived to first construct the whole slice then replace the start and end. Further, is there something that attempts to figure out the inequality from the context, e.g. with a <code>by grind</code> autoparam?</p>\n<p>(Note: <code>String.replaceStart</code> took some time to find, because I was looking for something that referenced going to the end of the string, not adjusting a start. In general, it was a bit of a surprise to think of the start and end positions of strings themselves (as opposed to slices) as things which can even become updated! :) )</p>\n<p>And a final note: I seem forced here to <em>first</em> construct the slice for the range, then compare its position. Similarly to losing the connection to the string, if I use <code>if h : prevEndPos.offset ≤ range.start</code>, and then construct the slice, I lose the connection between the positions mentioned by <code>h</code> and the position in the new slice, and so can't construct the other slice up to the start of the range (the one which uses <code>h</code>).</p>\n<p>It seems most of the pain here (which, to be honest, really isn't <em>that</em> much altogether :) ) is coming from having to the traverse the boundary between raw positions and valid positions.</p>\n<p>I realize that the new API is just getting started, so I don't fault it at all for these kinds of things not being available yet! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> But hopefully it helps to hear the kinds of things I'm attempting to reach for.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>bracket ranges</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">SliceOf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The byte position of the start of the string slice. -/</span>\n<span class=\"w\">  </span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The byte position of the end of the string slice. -/</span>\n<span class=\"w\">  </span><span class=\"n\">endExclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The slice is not degenerate (but it may be empty). -/</span>\n<span class=\"w\">  </span><span class=\"n\">startInclusive_le_endExclusive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">endExclusive</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">SliceOf</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sliceOf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">SliceOf</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Slice</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">sliceOf</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">toSliceOf?</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">SliceOf</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos?</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos?</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"sd\">/-- Brackets the ranges in `ranges`. Assumes the ranges are already sorted and are disjoint. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">startValidPos</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSliceOf?</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- append up to start of range</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">        </span><span class=\"n\">startInclusive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span>\n<span class=\"w\">        </span><span class=\"n\">endExclusive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">startInclusive</span>\n<span class=\"w\">        </span><span class=\"n\">startInclusive_le_endExclusive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Slice</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟪\"</span>\n<span class=\"w\">      </span><span class=\"c1\">-- append range</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟫\"</span>\n<span class=\"w\">      </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">endExclusive</span>\n<span class=\"w\">  </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">replaceStart</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"s2\">\"abcdef\"</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">⟨⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">5</span><span class=\"bp\">⟩⟩</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- \"⟪a⟫bc⟪de⟫f\"</span>\n</code></pre></div>\n</div></div>",
        "id": 560265677,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764110911
    },
    {
        "content": "<p>First of all, thank you very much for engaging with the material in its current undocumented state and providing feedback. This kind of feedback is very valuable to me.</p>\n<p>Disclaimer about everything I'm about to say: it will only be available starting in Lean 4.27.0.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Dependent.20String.20slices.3F/near/560265677\">said</a>:</p>\n<blockquote>\n<p>what's the preferred way to construct a slice \"by hand\" when the positions and inequality are present?</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Dependent.20String.20slices.3F/near/560265677\">said</a>:</p>\n<blockquote>\n<p>Note: <code>String.replaceStart</code> took some time to find, because I was looking for something that referenced going to the end of the string, not adjusting a start.</p>\n</blockquote>\n<p>As of <a href=\"https://github.com/leanprover/lean4/pull/11290\">lean4#11290</a>, we now have a uniform family of functions <code>String.slice</code>, <code>String.slice!</code>, <code>String.sliceFrom</code>,  <code>String.sliceTo</code>, <code>String.Slice.slice</code>, <code>String.Slice.slice!</code>, <code>String.Slice.sliceFrom</code>, <code>String.Slice.sliceTo</code> for taking slices delineated by one or two positions. So <code>String.replaceStart</code> is now called <code>String.sliceFrom</code>, which is hopefully a bit easier to understand.</p>\n<p>About your example: I agree that if you like to go through the <code>Option</code> route, then having dependent slices is convenient. However, there is a different approach that works quite well with plain <code>String.Slice</code>, which you had no chance of discovering because the necessary functions were only added today (in <a href=\"https://github.com/leanprover/lean4/pull/11380\">lean4#11380</a>). The idea is this: whenever you create a slice,  there should be  operations on positions that transport positions forwards and backwards across this operation. For example: <code>String.slice</code> creates a <code>Slice</code> from a <code>String</code>. Therefore, there should be a function <code>String.Pos.slice</code> that turns a <code>s.Pos</code> into a <code>(s.slice ..).Pos</code>, and in the  other direction,  there should be a function <code>String.Pos.ofSlice</code> that turns a <code>(s.slice ..).Pos</code> into a <code>s.Pos</code>. Following this approach for the general-purpose slicing functions, we get the following little zoo (sorry for sending a screenshot; I'd send a live-lean link but this stuff isn't in any nightly yet...):<br>\n<a href=\"/user_uploads/3121/6jUXRoB2pU0t_4znZ_lrQVJC/Screenshot_20251126_111845.png\">Screenshot_20251126_111845.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/6jUXRoB2pU0t_4znZ_lrQVJC/Screenshot_20251126_111845.png\" title=\"Screenshot_20251126_111845.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1315x888\" src=\"/user_uploads/thumbnail/3121/6jUXRoB2pU0t_4znZ_lrQVJC/Screenshot_20251126_111845.png/840x560.webp\"></a></div><p>Notice that this gives an alternative answer to the problem of \"forgetting\" what string the slice is on: if I have a term of type <code>(s.slice p0 p1 h).Pos</code>, then the <code>s</code> is right there in the type, and calling <code>String.Slice.Pos.ofSlice</code> will recover the corresponding position on <code>s</code> for me.</p>\n<p>This principle also applies to user-defined operations, like your operation that turns <code>Syntax.Range</code> into a slice. Here is how you could implement this (this should compile starting with <code>nightly-2025-11-27</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">isValid_start</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">isValid_stop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">isValid_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsValid</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">decidable_of_iff'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">isValid_iff</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Slice</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">isValid_start</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">isValid_stop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">le</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ofSlice</span><span class=\"w\"> </span><span class=\"n\">pos</span>\n\n<span class=\"sd\">/-- Brackets the ranges in `ranges`. Assumes the ranges are already sorted and are disjoint. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">startPos</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h'</span>\n<span class=\"w\">        </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟪\"</span>\n<span class=\"w\">        </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">slice</span>\n<span class=\"w\">        </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟫\"</span>\n<span class=\"w\">        </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">endPos</span>\n<span class=\"w\">  </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">sliceFrom</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"s2\">\"abcdef\"</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">⟨⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">5</span><span class=\"bp\">⟩⟩</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- \"⟪a⟫bc⟪de⟫f\"</span>\n</code></pre></div>\n<p>So here I'm defining a <code>Lean.Syntax.Range.toSlice</code> which takes a proof of validity instead of your <code>Option</code>-returning function. The advantage is that this allows us to easily define <code>String.Pos.ofSyntaxRange</code>, which transforms a position on <code>range.toSlice s h</code> into a position on <code>s</code>. In <code>String.bracketRange</code> we can then easily get hold of the required positions, and we're not even relying on any definitional equalities any more after <code>String.Pos.ofSyntaxRange</code> is defined.</p>\n<p>This approach also offers a solution to your ordering problem, because it is easy to prove a lemma relating the ordering on <code>s</code> to the ordering on <code>range.toSlice s h</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">isValid_start</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">isValid_stop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">isValid_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsValid</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">decidable_of_iff'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">isValid_iff</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Slice</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">isValid_start</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">isValid_stop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">le</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ofSlice</span><span class=\"w\"> </span><span class=\"n\">pos</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">le_ofSyntaxRange_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">p'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">p'</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">p'</span><span class=\"bp\">.</span><span class=\"n\">offset</span><span class=\"bp\">.</span><span class=\"n\">offsetBy</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">le_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ofSyntaxRange</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- this is actually true by `Iff.rfl`.</span>\n\n<span class=\"sd\">/-- Brackets the ranges in `ranges`. Assumes the ranges are already sorted and are disjoint. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">startPos</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ranges</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"bp\">.</span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">toSlice</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">slice</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">le_ofSyntaxRange_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">])</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟪\"</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">slice</span>\n<span class=\"w\">      </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"⟫\"</span>\n<span class=\"w\">      </span><span class=\"n\">prevEndPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">ofSyntaxRange</span><span class=\"w\"> </span><span class=\"n\">slice</span><span class=\"bp\">.</span><span class=\"n\">endPos</span>\n<span class=\"w\">  </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">sliceFrom</span><span class=\"w\"> </span><span class=\"n\">prevEndPos</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"s2\">\"abcdef\"</span><span class=\"bp\">.</span><span class=\"n\">bracketRanges'</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">⟨⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"bp\">⟨</span><span class=\"mi\">5</span><span class=\"bp\">⟩⟩</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- \"⟪a⟫bc⟪de⟫f\"</span>\n</code></pre></div>\n<p>Note that I'm not saying that this is strictly better or worse than having dependent slices/substring; I think we'll want both.</p>",
        "id": 560375793,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764159422
    }
]