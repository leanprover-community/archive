[
    {
        "content": "<p>Hi. I'm relatively new to Lean. Trying to add a string field called \"name\" to my NIKE type class:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">key</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">privkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">privkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pubkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">pubkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">NIKE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">string</span>\n<span class=\"w\">  </span><span class=\"n\">privateKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">publicKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"w\">  </span><span class=\"n\">generatePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">derivePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">generateKeyPair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">groupAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">encodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">encodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n</code></pre></div>\n<p>For some reason the compiler inference for the name field is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">string</span>\n</code></pre></div>\n<p>And I fail to add \"name\" to existing NIKE class instances:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">NIKE</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span>\n\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"X25519\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">generatePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">generatePrivateKey</span>\n\n<span class=\"w\">  </span><span class=\"n\">generateKeyPair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">privKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">generatePrivateKey</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pubKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">derivePublicKey</span><span class=\"w\"> </span><span class=\"n\">privKey</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pubKey</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">privKey</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">derivePublicKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">derivePublicKey</span><span class=\"w\"> </span><span class=\"n\">sk</span>\n\n<span class=\"w\">  </span><span class=\"n\">groupAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">curve25519</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"bp\">.</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"bp\">.</span><span class=\"n\">data</span>\n\n<span class=\"w\">  </span><span class=\"n\">privateKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">keySize</span>\n<span class=\"w\">  </span><span class=\"n\">publicKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">keySize</span>\n\n<span class=\"w\">  </span><span class=\"n\">encodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">Key</span><span class=\"bp\">.</span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">sk</span>\n<span class=\"w\">  </span><span class=\"n\">decodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">Key</span><span class=\"bp\">.</span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"n\">bytes</span>\n<span class=\"w\">  </span><span class=\"n\">encodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">Key</span><span class=\"bp\">.</span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">pk</span>\n<span class=\"w\">  </span><span class=\"n\">decodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">Key</span><span class=\"bp\">.</span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"n\">bytes</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519</span>\n</code></pre></div>\n<p>fails to compile, with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"s2\">\"X25519\"</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">8047</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">8047</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">8047</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 465739707,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724845916
    },
    {
        "content": "<p><code>string</code> here is an identifier, while <code>String</code> is the type of strings... note the capital for the built-in type.</p>",
        "id": 465740070,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1724845991
    },
    {
        "content": "<p>the reason it doesn't throw an error due to not knowing what <code>string</code> means here is an option called <code>autoImplicit</code>, which while true adds unknown identifiers to the context as assumptions.</p>",
        "id": 465740451,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1724846102
    },
    {
        "content": "<p>ah yeah thanks!</p>",
        "id": 465740457,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724846103
    },
    {
        "content": "<p>you can turn this off with <code>set_option autoImplicit false</code></p>",
        "id": 465740523,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1724846124
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/stream/270676-lean4/topic/difficulty.20adding.20string.20field.20to.20type.20class/near/465740523\">said</a>:</p>\n<blockquote>\n<p>you can turn this off with <code>set_option autoImplicit false</code></p>\n</blockquote>\n<p>can i set that in my lakefile or does it have to be in the source code of my library?</p>",
        "id": 465740633,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724846156
    },
    {
        "content": "<p>i think there <em>is</em> a way to do this in your lakefile, but i don't know it... maybe someone else could help there?</p>",
        "id": 465740930,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1724846240
    },
    {
        "content": "<p>thanks for your help! the error messages were very confusing but i see what i did wrong now at least.</p>",
        "id": 465741169,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724846307
    },
    {
        "content": "<p>i don't know if this translates one-to-one, but you could take inspiration from <code>mathlib</code>s lakefile: <a href=\"https://github.com/leanprover-community/mathlib4/blob/33d4a4af3e67a4561bbb0dacdc9800fc8785fa44/lakefile.lean#L39C1-L53C25\">https://github.com/leanprover-community/mathlib4/blob/33d4a4af3e67a4561bbb0dacdc9800fc8785fa44/lakefile.lean#L39C1-L53C25</a></p>",
        "id": 465742858,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1724846664
    },
    {
        "content": "<p>A simpler example can be found at <a href=\"https://github.com/avigad/mathematics_in_lean_source/blob/master/lakefile.lean\">https://github.com/avigad/mathematics_in_lean_source/blob/master/lakefile.lean</a></p>",
        "id": 465746409,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724847359
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 465746836,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724847418
    }
]