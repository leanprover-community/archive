[
    {
        "content": "<p>In this example, the <code>sorry</code> warning on the second theorem is conditional:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sorry_in_proof1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">as_aux_lemma</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- warning</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sorry_in_proof2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">as_aux_lemma</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\">  </span><span class=\"c1\">-- no sorry warning here unless you comment out `Elab.async`</span>\n</code></pre></div>",
        "id": 543305164,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759755007
    },
    {
        "content": "<p>This is presumably because in the synchronous case <code>mkAuxTheorem</code> is reusing an existing auxiliary theorem</p>",
        "id": 543305929,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759755195
    },
    {
        "content": "<p>A variant of this was fixed in <a href=\"https://github.com/leanprover/lean4/pull/10388\">lean4#10388</a>, so possibly the same fix should be added to the <code>as_aux_lemma</code> tactic.</p>",
        "id": 543306727,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1759755381
    },
    {
        "content": "<p>Should this be built into <code>mkAuxTheorem</code>?</p>",
        "id": 543307055,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759755452
    },
    {
        "content": "<p>To me it's not 100% clear that disabling the cache like this <em>always</em> desirable, even when invoking <code>mkAuxTheorem</code> somewhere deep in some other thing.</p>",
        "id": 543307479,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1759755549
    },
    {
        "content": "<p>(for what it's worth, I ran into this while debugging <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Kernel.20error.20in.20list.20index.20notation/with/543298850\">#lean4 &gt; Kernel error in list index notation</a>, since omega calls <code>mkAuxTheorem</code>)</p>",
        "id": 543307823,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759755624
    },
    {
        "content": "<p>The 10388 fix is a bit of a hack, justified by being simple to reason about, and the cost to not caching terms with <code>sorry</code> is fairly localized.</p>\n<p>Another justification for it is the following. What is special about <code>sorry</code> is that its identity matters â€” after all, it records a source position, and even if it's a bare <code>sorryAx</code>, we want to attribute the sorry to the current declaration. The aux lemma cache is keyed by the type of the proof, and it does not take the proof itself into consideration. When there is a <code>sorry</code>, we might say that the sorries themselves should be part of the key. Disabling the cache when there is a sorry is a way to ensure the <code>sorry</code> actually makes it into the environment.</p>",
        "id": 543332529,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759761190
    }
]