[
    {
        "content": "<p>See the following code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"c1\">-- short circuiting!!</span>\n<span class=\"sd\">/-- info: false -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₁</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"c1\">-- **not** short circuiting!!</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: hello</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: false</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₂</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>When using the <code>[inline]</code> attribute, short-circuit evaluation is possible, but when using <code>[always_inline]</code>, short-circuit evaluation is not possible. I do not understand the reason for this phenomenon. What does <code>[always_inline]</code> mean?</p>",
        "id": 486997869,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733751598
    },
    {
        "content": "<p>At first I thought <code>[always_inline]</code> would tell it to always expand inline, while <code>[inline]</code> would tell it to only expand inline when it expected to improve performance. However, that interpretation is inconsistent with the code example above.</p>",
        "id": 486998272,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733751713
    },
    {
        "content": "<p>How about with<code>@[inline, always_inline]</code>?</p>",
        "id": 486999042,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733751926
    },
    {
        "content": "<p>not short-circuit</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₃</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: hello</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: false</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">And₃</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 486999552,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733752058
    },
    {
        "content": "<p>For short circuiting you want to use <code>macro_inline</code></p>",
        "id": 487001314,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733752536
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> </p>\n<p>I know <code>[macro_inline]</code> exists, but why should I use <code>[macro_inline]</code> for short-circuit evaluation?<br>\nHow do <code>[macro_inline]</code>, <code>[inline]</code> and <code>[always_inline]</code> differ from each other?</p>",
        "id": 487001615,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733752603
    },
    {
        "content": "<p><code>macro_inline</code> treats the function like a macro and bubbles the evaluation of arguments down to their first use sites while <code>inline</code>/<code>always_inline</code> might not do that</p>",
        "id": 487002835,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733752855
    },
    {
        "content": "<p>you can inspect the generated IR with <code>set_option trace.compiler.ir.result true</code> and observe when arguments get evaluated relative to the pattern matching there</p>",
        "id": 487003120,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733752922
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/270676-lean4/topic/what.20does.20.60.5Balways_inline.5D.60.20mean.3F/near/486999042\">said</a>:</p>\n<blockquote>\n<p>How about with<code>@[inline, always_inline]</code>?</p>\n</blockquote>\n<p>I think you need to use the order <code>@[always_inline, inline]</code> to get the desired effect.</p>",
        "id": 487003386,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1733752973
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> I see. Thanks. </p>\n<p>Then why is it short-circuited even when <code>[inline]</code> is used?</p>",
        "id": 487003581,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733753019
    },
    {
        "content": "<p>I think in the <code>inline</code> situation the compiler merely happens to optimize it in the way that you intended it to be but that is not generally guaranteed</p>",
        "id": 487004508,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733753236
    },
    {
        "content": "<p>Thanks.<br>\nAre there any examples of short-circuit evaluation failure if using <code>[inline]</code>?</p>",
        "id": 487004913,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1733753321
    }
]