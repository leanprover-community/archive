[
    {
        "content": "<p>What's the fastest tactic for proving Nat literal inequalities like <code>3 &lt; 5</code>, <code>159 &lt; 300</code>, etc? You can assume literals don't exceed three digits. I've been using <code>simp</code> but I'm curious if I can make it even faster.</p>\n<p>The context is for bounds check proofs for array indexing. For type-checking performance, I have a custom syntax for array indexing where both the size and the index are literals, e.g. <code>Main : Vector Nat 355</code> and I access <code>Main[42]$</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">withoutPosition</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"]$\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">$</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">getElem</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>I currently have <code>simp</code> in place, but for functions with many array index operations (e.g. I have a parameter <code>Main : Vector Nat 251</code> and there are 752 constant index operations on <code>Main</code>) I still need to adjust <code>maxHeartbeats</code>. I wonder if this can be even faster.</p>\n<p>btw I'm not using the default <code>a[i]</code>syntax because the time complexity of <code>get_elem_tactic</code> is quadratic w.r.t. the size of the context, due to the use of <code>assumption</code>.</p>",
        "id": 533025769,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754456856
    },
    {
        "content": "<p>Truely a \"Lean at scale\" moment <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 533026015,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754457043
    },
    {
        "content": "<p>mathlib's <code>norm_num</code></p>",
        "id": 533051842,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754469363
    },
    {
        "content": "<p><code>by decide</code> might also be fast</p>",
        "id": 533051899,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754469390
    },
    {
        "content": "<p><code>decide</code> is probably faster than <code>norm_num</code></p>",
        "id": 533069785,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754475323
    },
    {
        "content": "<p><code>omega</code> might not be faster, but it's my standard tactic for natural number or integer arithmetic.</p>",
        "id": 533070538,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754475600
    },
    {
        "content": "<p>When you use <code>a[i]</code>, it should already use <code>decide</code> though</p>",
        "id": 533086071,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754481375
    },
    {
        "content": "<p>and <code>simp +arith</code> when that fails</p>",
        "id": 533086121,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754481395
    },
    {
        "content": "<p>Oh it's because <code>decide</code> comes too late...</p>",
        "id": 533086238,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754481436
    },
    {
        "content": "<p>Wait no <code>decide</code> comes before <code>assumption</code></p>",
        "id": 533086417,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754481512
    },
    {
        "content": "<p>Oh but <code>get_elem_tactic</code> puts <code>assumption</code> before <code>decide</code></p>",
        "id": 533086608,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754481595
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/fastest.20tactic.20for.20proving.20Nat.20literal.20inequalities/near/533086608\">said</a>:</p>\n<blockquote>\n<p>Oh but <code>get_elem_tactic</code> puts <code>assumption</code> before <code>decide</code></p>\n</blockquote>\n<p>Yeah that was the biggest issue for me. I understand the rationale for putting <code>assumption</code> first but when your context gets large with 600 <code>let</code>s this doesn't scale.</p>",
        "id": 533153186,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754502403
    },
    {
        "content": "<p>Can't you split up what ever you have into multiple functions..?</p>",
        "id": 533154328,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754502926
    },
    {
        "content": "<p>You're probably not using all 600 lets at the same time, are you?</p>",
        "id": 533154419,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754502963
    },
    {
        "content": "<blockquote>\n<p>You're probably not using all 600 lets at the same time, are you?</p>\n</blockquote>\n<p>Well actually yes.</p>",
        "id": 533155613,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754503454
    },
    {
        "content": "<p>Are you able to create some self-contained test case for this <span class=\"user-mention\" data-user-id=\"766285\">@Gavin Zhao</span>? It might be worth creating a Lean issue pointing out these performance issues with index notation.</p>",
        "id": 533155904,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754503574
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Not yet but I'll give it a try. This issues comes from some company code that will be open-sourced later but right now I don't think I can share the function that has the performance issue.</p>",
        "id": 533156354,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754503785
    },
    {
        "content": "<p>Seems like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">get_elem_tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">get_elem_tactic</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">done</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>provides similar speedup. Doesn't work with <code>get_elem_tactic_extensible</code> though because of the previously mentioned <code>assumption</code> tactic taking priority</p>",
        "id": 533177396,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754513377
    },
    {
        "content": "<p><code>decide</code> is a terminal tactic so <code>get_elem_tactic; done</code> doesn't do anything though</p>",
        "id": 533178110,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754513769
    },
    {
        "content": "<p>Yeah I've just seen that any other different cases now break</p>",
        "id": 533178197,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754513821
    },
    {
        "content": "<p>Really? This still seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">get_elem_tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">get_elem_tactic</span>\n</code></pre></div>",
        "id": 533186110,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754518375
    },
    {
        "content": "<p>I've been looking and I think it seems like it was actually a problem with <code>decide</code> not terminating in time in some edge cases we have, not a global thing. Adding <code>norm_num1</code> seems to give similar speedups without that being an issue</p>",
        "id": 533194133,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754524410
    }
]