[
    {
        "content": "<p>Is this expected behavior? When running the following under <code>lean --run &lt;filename&gt;</code> on nightly (and earlier, e.g. 4.17.0), I sometimes get 7 total threads, sometimes 12, sometimes 5...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Starting task {x}…\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toUInt32</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">30000</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Finishing task {x}…\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"mi\">10</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">asTask</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Done main!\"</span>\n</code></pre></div>\n<p>When it starts with a certain number of threads, that number never increases; it will wait until a task is done to start the next.</p>\n<p>Example output for e.g. 7 total threads (2 basic threads, plus one for each running task, I suppose) is</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>Done main!\nStarting task 0…\nStarting task 4…\nStarting task 1…\nStarting task 3…\nStarting task 2…\nFinishing task 0…\nStarting task 5…\nFinishing task 1…\nStarting task 6…\nFinishing task 2…\nStarting task 7…\nFinishing task 3…\nStarting task 8…\nFinishing task 4…\nStarting task 9…\nFinishing task 5…\nFinishing task 6…\nFinishing task 7…\nFinishing task 8…\nFinishing task 9…\n</code></pre></div>\n</div></div>",
        "id": 511977734,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744604229
    },
    {
        "content": "<p>I'll also note that using e.g. <code>lean --threads=10 --run &lt;filename&gt;</code> produces the same nondeterministic behavior, which seems strange to me.</p>",
        "id": 511978046,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744604471
    },
    {
        "content": "<p>Also (perhaps more importantly): I hit a segfault when trying <code>.asTask (prio := .dedicated)</code> here without supplying <code>--threads=10</code>; and when I <em>do</em> supply <code>--threads=10</code>, I see <code>Starting task n...</code> in the terminal but not <code>Finished task n...</code>.</p>\n<p>The latter might just be me not having the right expectations, but I hope segfaults during innocent attempts at thread management aren't intentional! <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 511979496,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744605416
    },
    {
        "content": "<p>(Sometimes using <code>prio := .dedicated</code> without a <code>--threads</code> argument is a segfault immediately after <code>Done main!</code>, but sometimes it's this:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>error</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Done<span class=\"w\"> </span>main!\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">1</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">6</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">9</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">7</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">5</span>…\n\nlibc++abi:<span class=\"w\"> </span>libc++abi:<span class=\"w\"> </span>libc++abi:<span class=\"w\"> </span>libc++abi:<span class=\"w\"> </span>terminating<span class=\"w\"> </span>due<span class=\"w\"> </span>to<span class=\"w\"> </span>uncaught<span class=\"w\"> </span>exception<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>std::__1::system_error:<span class=\"w\"> </span>condition_variable<span class=\"w\"> </span><span class=\"nb\">wait</span><span class=\"w\"> </span>failed:<span class=\"w\"> </span>Invalid<span class=\"w\"> </span>argumentlibc++abi:\n\nterminating<span class=\"w\"> </span>due<span class=\"w\"> </span>to<span class=\"w\"> </span>uncaught<span class=\"w\"> </span>exception<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>std::__1::system_error:<span class=\"w\"> </span>condition_variable<span class=\"w\"> </span><span class=\"nb\">wait</span><span class=\"w\"> </span>failed:<span class=\"w\"> </span>Invalid<span class=\"w\"> </span>argument\n\nterminating<span class=\"w\"> </span>due<span class=\"w\"> </span>to<span class=\"w\"> </span>uncaught<span class=\"w\"> </span>exception<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>std::__1::system_error:<span class=\"w\"> </span>condition_variable<span class=\"w\"> </span><span class=\"nb\">wait</span><span class=\"w\"> </span>failed:<span class=\"w\"> </span>Invalid<span class=\"w\"> </span>argument\n</code></pre></div>\n</div></div>\n<p>and sometimes the output is simply</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Done<span class=\"w\"> </span>main!\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">0</span>…\n</code></pre></div>\n<p>(or just <code>Done main!</code>) with no apparent error.)</p>",
        "id": 511979639,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744605504
    },
    {
        "content": "<p>I suppose this might be two (or more) separate issues discovered while attempting to reach the same goal (namely, consistently create 10 concurrent task threads), so apologies if it turns out they don't share the same root cause! :)</p>",
        "id": 511980874,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744606249
    },
    {
        "content": "<p>This might be a corner case at the end of <code>main</code> so try waiting for the tasks</p>",
        "id": 512008288,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744617260
    },
    {
        "content": "<p>To update this topic, the segfault and error messages with <code>(prio := dedicated)</code> were indeed caused by <code>main</code> not waiting for dedicated tasks by default, and this has now been changed in <a href=\"https://github.com/leanprover/lean4/pull/7958\">lean4#7958</a> thanks to quick work by <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> :)</p>",
        "id": 512199645,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744678537
    },
    {
        "content": "<p>The only remaining issues in this topic are now</p>\n<ol>\n<li>the number of threads in the thread pool appears to be nondeterministic, and not as large as it could/should be</li>\n<li>using <code>--threads</code> does not change that behavior</li>\n</ol>",
        "id": 512199933,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744678685
    },
    {
        "content": "<p>I believe that, too, will be resolved if you wait for your tasks!</p>",
        "id": 512236561,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744698986
    },
    {
        "content": "<p>To be clear I do mean when <em>not</em> using <code>prio := .dedicated</code>, which was an attempt to work around the thread nondeterminism issue! :) (Waiting does indeed resolve the issue when using <code>prio := .dedicated</code>.)</p>",
        "id": 512247088,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744702351
    },
    {
        "content": "<p>Just to cover all bases, though, waiting does not seem to resolve issues 1 and 2 (assuming I haven't done anything wrong):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Starting task {x}…\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toUInt32</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">3000</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Finishing task {x}…\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkEmpty</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"mi\">10</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">asTask</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Started all tasks.\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tasks</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">wait</span><span class=\"w\"> </span><span class=\"n\">task</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Done main!\"</span>\n</code></pre></div>\n<p>The following run used <code>--threads=10</code> but had 7 total threads (note that task 5 doesn't start until another task ends).</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Starting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">2</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">0</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">4</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">1</span>…\n\nStarted<span class=\"w\"> </span>all<span class=\"w\"> </span>tasks.\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">3</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">0</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">5</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">1</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">6</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">2</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">7</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">3</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">8</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">4</span>…\n\nStarting<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">9</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">5</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">6</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">7</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">8</span>…\n\nFinishing<span class=\"w\"> </span>task<span class=\"w\"> </span><span class=\"m\">9</span>…\n\nDone<span class=\"w\"> </span>main!\n</code></pre></div>\n</div></div>",
        "id": 512247355,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744702415
    }
]