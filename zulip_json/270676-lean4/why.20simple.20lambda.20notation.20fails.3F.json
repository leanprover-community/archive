[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Plus</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n\n<span class=\"kd\">infixl</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Plus.plus</span>\n\n<span class=\"c1\">-- works</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Plus</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List.map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ns</span>\n\n<span class=\"c1\">-- why this fails?</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Plus</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  ambiguous, possible interpretations</span>\n<span class=\"cm\">    n + x✝¹ : ?m.1676</span>\n\n<span class=\"cm\">    n + x✝ : Nat</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List.map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ns</span>\n</code></pre></div>",
        "id": 454006959,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721928052
    },
    {
        "content": "<p>Make sure to include all the code in your mwe. I am guessing you are missing an <code>infix</code> or <code>notation</code> that redefines <code>+</code>.</p>",
        "id": 454008838,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721928576
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thank you!! I edited my question.</p>",
        "id": 454011829,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721929563
    },
    {
        "content": "<p>Then that's the problem, you've defined your own <code>+</code> notation, and it's telling you that <code>n + ·</code> is ambiguous.</p>",
        "id": 454013242,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721930062
    },
    {
        "content": "<p>Generally you shouldn't be definining your own <code>Plus</code> and <code>+</code> when there's <code>HAdd</code> and <code>+</code> already available.</p>",
        "id": 454013337,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721930093
    },
    {
        "content": "<p>Sorry, my explanation wasn't good enough.</p>",
        "id": 454026406,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721932604
    },
    {
        "content": "<p>My question here is why writing explicit lambda expressions using <code>fun</code> does not result in an error, but using bracket syntax fails.</p>",
        "id": 454026535,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721932667
    },
    {
        "content": "<p>It is correct that the <code>+</code> sign is covered by an error, but not both. The reason for the difference is what I want to know.</p>",
        "id": 454026747,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721932768
    },
    {
        "content": "<p>If <code>(n + ·)</code> is a macro that expands to <code>fun x =&gt; n + x</code>, it seemed natural that both would have the same error.</p>",
        "id": 454026934,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1721932843
    },
    {
        "content": "<p>I'm not sure why the first one works (I take that back, it works because it's able to disambiguate after trying to elaborate it both ways)</p>",
        "id": 454026942,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721932848
    },
    {
        "content": "<p>I'm not sure why these are different</p>",
        "id": 454027020,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721932886
    },
    {
        "content": "<p>On a nightly build of Lean, I'm getting a different error on <code>(n + ·)</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1610</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">1609</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1610</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">1609</span>\n</code></pre></div>",
        "id": 454027996,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721933222
    },
    {
        "content": "<p>I'm not sure how it's getting two arguments.</p>",
        "id": 454028376,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721933377
    },
    {
        "content": "<p>Oh, I see... It's triggered by the ambiguous notation.</p>\n<p>Here's some of the elaboration trace.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"bp\">.</span><span class=\"n\">args</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">paren</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">+__</span><span class=\"mi\">1</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"ss\">`n</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">cdot</span><span class=\"w\"> </span><span class=\"s2\">\"·\"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">+_»</span><span class=\"w\"> </span><span class=\"ss\">`n</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">cdot</span><span class=\"w\"> </span><span class=\"s2\">\"·\"</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"ss\">`ns</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The key is that cdot appears twice, so it gets two arguments. This is a funny oversight in how cdot expansion handles choice nodes.</p>",
        "id": 454029885,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721933958
    },
    {
        "content": "<p>What version of Lean are you using?</p>",
        "id": 454029920,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721933971
    },
    {
        "content": "<p>(And in any case, the answer is \"don't overload <code>+</code>\". There are things that won't work correctly if you do. Still, it's good that it uncovered this bug.)</p>",
        "id": 454030214,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721934043
    },
    {
        "content": "<p>I get the same error as  Asei on <code>4.9.0-rc3</code>.</p>",
        "id": 454031574,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1721934417
    },
    {
        "content": "<p>I see it on 4.10.0-rc2 as well. (Edit: not locally, just in the playground link for Asei's original post... Edit edit: I had commented out the first instance in testing, but it's necessary to get \"ambiguous\" error.)</p>",
        "id": 454034788,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721935397
    },
    {
        "content": "<p>Found the explanation for what changed recently: <a href=\"https://github.com/leanprover/lean4/pull/4596\">lean4#4596</a> disambiguates more strongly, removing alternatives when there are stuck metavariables.</p>",
        "id": 454046755,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721938582
    },
    {
        "content": "<p>However, the same bug with cdot notation was there even then. Something to notice is that in the error</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>  ambiguous, possible interpretations\n    n + x✝¹ : ?m.1676\n\n    n + x✝ : Nat\n</code></pre></div>\n<p>you can see both <code>x✝¹</code> and <code>x✝</code>. There are <em>two</em> variables, not one.</p>",
        "id": 454046911,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721938632
    },
    {
        "content": "<p>Reported: <a href=\"https://github.com/leanprover/lean4/pull/4832\">lean4#4832</a></p>",
        "id": 454047902,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721938926
    }
]