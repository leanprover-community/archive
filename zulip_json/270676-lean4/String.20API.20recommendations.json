[
    {
        "content": "<p>I noticed that <code>String.Iterator</code> is being <a href=\"https://github.com/leanprover/lean4/pull/11152\">deprecated in v4.26.0-rc2</a> while updating <a href=\"https://github.com/pandaman64/lean-regex\">lean-regex</a>. I have two questions about the future directions of String APIs so that I can update the lean-regex APIs accordingly.</p>\n<h2>1. What should String APIs take as arguments?</h2>\n<p>So far, I have been using <code>String.Iterator</code> as an input to the regex searches, where</p>\n<ul>\n<li>the termination proofs don't require the iterator to be valid (which required some <a href=\"https://github.com/pandaman64/lean-regex/blob/e1600a18d170eab0a079d6f96c79abdb23e80828/regex/Regex/Data/String.lean#L64\">tricky lemmas</a>)</li>\n<li>the correctness proofs assume a valid iterator</li>\n</ul>\n<p>With the deprecation of <code>String.Iterator</code>, are we expected to migrate string functions to accept <code>String.ValidPos</code>, as described in <a href=\"https://lean-lang.org/doc/reference/latest/Basic-Types/Strings/#String___Legacy___Iterator___mk\">this doc comment</a>, and drop support for non-vaild positions? (I think it's fine as the functions have returned bogus results for non-valid iterators anyway)</p>\n<p>One tricky part of the migration is that <code>String.endPos.offsetBy 1</code> is a useful sentinel value for representing a search iterator that has consumed the entire input (<a href=\"https://github.com/pandaman64/lean-regex/blob/e1600a18d170eab0a079d6f96c79abdb23e80828/regex/Regex/Regex/Captures.lean#L76\">example</a>), but I guess we can use <code>Pos.Raw</code> specifically for it.</p>\n<h2>2. Future of <code>String.Iterator.ValidFor</code></h2>\n<p><a href=\"https://github.com/leanprover-community/batteries/blob/e1c1e06b9cbfc873b309695c9e9584de88ec22ac/Batteries/Data/String/Lemmas.lean#L583\"><code>ValidFor</code> from Batteries</a> is a VERY useful mechanism to reason about code points (or <code>Char</code>s) in a string, and <code>lean-regex</code> uses it quite a lot. Is there a plan to have a counterpart for <code>ValidPos</code> in core? If not, is it okay to make an PR to Batteries to duplicate <code>ValidFor</code> for <code>ValidPos</code>?</p>",
        "id": 560974224,
        "sender_full_name": "pandaman",
        "timestamp": 1764484352
    },
    {
        "content": "<p>For 1.: Yes, the recommended alternative to <code>String.Iterator</code> is <code>String.ValidPos</code> (which will be <code>String.Pos</code> in a future update). If you need sentinel values, I guess you can still use <code>String.Pos.Raw</code> or, well, <code>Option s.ValidPos</code>. There is also some stuff for termination at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.ValidPos.instWellFoundedRelation#doc\">docs#String.ValidPos.instWellFoundedRelation</a><br>\nFor 2.: The core version of <code>ValidFor</code> is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.ValidPos.Splits#doc\">docs#String.ValidPos.Splits</a> (which will be <code>String.Pos.Splits</code> in a future update) which works on <code>String</code>s instead of <code>List Char</code>s. If you want a literal equivalent, you can use something like <code>pos.Splits (String.ofList s) (String.ofList t)</code>. The API of <code>Splits</code> is still a bit incomplete though.</p>\n<p>Anyways, <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span> might have something more to say about this.</p>",
        "id": 561003349,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1764513141
    },
    {
        "content": "<p>Thank you for the answers!</p>\n<p>Regarding a valid position + sentinel, I created <a href=\"https://github.com/pandaman64/lean-regex/blob/v4.26.0-rc2/regex/Regex/Data/String.lean#L150\">a type for it</a>, which seems to be working so far.<br>\nAs for a <code>ValidFor</code> replacement, the most typical lemma I use is <code>it.ValidFor l (m :: r) → it.next.ValidFor (l ++ [m]) r</code>. <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/String/Lemmas/Splits.html#String.Slice.Pos.splits_next\">The Splits counterpart</a> looks a bit more mouthful, but I'll see if I can make it work. Thank you for the pointer!</p>",
        "id": 561004499,
        "sender_full_name": "pandaman",
        "timestamp": 1764514126
    },
    {
        "content": "<p>Oh, the ValidPos one looks much nicer: <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/String/Lemmas/Splits.html#String.ValidPos.Splits.next\">https://leanprover-community.github.io/mathlib4_docs/Init/Data/String/Lemmas/Splits.html#String.ValidPos.Splits.next</a><br>\n(Still trickier than ValidFor, though)</p>",
        "id": 561005514,
        "sender_full_name": "pandaman",
        "timestamp": 1764514863
    },
    {
        "content": "<p>If you feel that <code>Splits</code> works less well than <code>ValidFor</code> in your  application, please share some code. It's still early enough days to change the API if necessary.</p>",
        "id": 561074824,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764570974
    },
    {
        "content": "<p>I'm still trying to understand the new APIs, but here is a case study migrating a simple search function and its proofs to <code>ValidPos/Splits</code>.</p>\n<p><a href=\"https://live.lean-lang.org/#codez=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\">Playground link</a></p>\n<h2>Observations</h2>\n<ul>\n<li>Simple arguments work with <code>Splits</code> (see <code>find_completenessAux</code>)</li>\n<li>However, I needed to reach List-based reasoning with <code>ofList/toList</code> to prove theorems like <code>String.eq_of_append_eq</code> or <code>String.empty_or_eq_singleton_append</code>. Being able to do pattern match/induction is so useful here</li>\n<li>The biggest issue is that I really have no idea how to reason about <code>ValidPos.get</code>. Previously, <code>Pos.Raw.get</code> was defined via <a href=\"https://github.com/leanprover/lean4/blob/1ae680c5e2f3922ba0c6c257a105426fdab20999/src/Init/Data/String/Basic.lean#L1885\"><code>Pos.Raw.utf8GetAux</code></a>, which allowed list-based reasoning and ultimately useful theorems like <a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Data/String/Lemmas.html#String.Legacy.Iterator.ValidFor.curr\"><code>Iterator.ValidFor.curr</code></a>. Now that <code>ValidPos.get</code> goes through extracting a character from a byte array, I cannot prove a counterpart with <code>Splits</code>, namely <code>splits_get_singleton (p.Splits l (singleton c ++ r)) : p.get ... = c</code> in the shared code.</li>\n</ul>",
        "id": 561155609,
        "sender_full_name": "pandaman",
        "timestamp": 1764594892
    },
    {
        "content": "<p>The last point is more about <code>ValidPos.get</code> vs <code>Pos.Raw.get</code> than <code>ValidPos.Splits</code> vs <code>Iterator.ValidFor</code>, but nonetheless I wouldn't be able to migrate lean-regex proofs to <code>ValidPos</code> without useful theorems about <code>ValidPos.get</code> (sorry if they are already added).</p>\n<p>I hope this is a useful feedback. Thank you!</p>",
        "id": 561156945,
        "sender_full_name": "pandaman",
        "timestamp": 1764595238
    },
    {
        "content": "<p>Here is how I would prove <code>splits_get_singleton</code> (which is a good theorem for the library):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">splits_get_singleton</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Splits</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">singleton</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">   </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"n\">ne_endValidPos_of_singleton</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">r'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"n\">exists_eq_singleton_append</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"n\">ne_endValidPos_of_singleton</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n</code></pre></div>",
        "id": 561160089,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764595960
    },
    {
        "content": "<p><code>next_le_of_lt</code> was part of <a href=\"https://github.com/leanprover/lean4/pull/11289\">lean4#11289</a>, so it should show up in the next version.</p>",
        "id": 561160894,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764596127
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 561162243,
        "sender_full_name": "pandaman",
        "timestamp": 1764596457
    },
    {
        "content": "<p>Some meta-information: the <code>Splits</code> API is very much still in (early) development; I am fully aware that tons of material is missing. Unfortunately I will have to take a break from working on it in December, but work will resume in January, and it's great to know what you're currently struggling with, so that I can make sure that these things become easy. Verification of the <code>find</code> function that is part of the standard library is part of the TODO list of course.</p>",
        "id": 561162493,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764596518
    },
    {
        "content": "<p>Thanks! I managed to prove the completeness with the new lemmas: <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAIQIYxgUysNBnAdAERSVwGUZMA7AcwChRJY4BZFACwBtgAjXAFSQDGMYANwBhCCBAQKNGgFp5cAIJxs9dhjgA3DOplwIAMzhlKVXADUknACYAFCHiPAKtgPw0AAgG1sYNAFgG2AALzQAXRpbNBMzVwtrO0dnV1s4AG9sOAAuU3IEgF84AApIbLyk4AcnNQBKUrBcuDFWJCg4QCTCRAgIdgacgF4aODhgE1YKZvK4QbVcNDcqmuyYVkWR0bhyzbR2bDQxkyayp1wqNHhJhrWNre2nXf20TdGXN0azijQADyuKBpgGjoKAgVwoYAyAD6XAAng9sHJFHAADLAbAweRcJAHdJQNA4mQJYHraBoECo9EwBYARyhxihSDAATcULQNNK2EAgQRqQBBBHAYDyYPy8miMS02lAGiVNM14tRcABXGBGAAcKMWah5gBMifLmJUq9WawXS9nNblwADUlr5swFPOtAt5A02gGAiOCKgA0WqtNsVdsFcEA5ES2ub+x3C3JzOGbNKKoSQqYWi7fKAhUIJe1wADuwDWmwAPnAKMB2LMAHxqeiM9jsQtwAQybICH3AVgV15wEAoATtwO5/P3Is+CIVuBUSjpHzyizKtUaije1rtA1qkhhNBQ8pRIcNgDkuTygcG5c7o3U4EMFHY8J8jYo2EZzMWtm997wrgAVgBRGmjlBwOyZ5VpeMg3nAPjst6M6rkaFBQu+3oAHIoLgSC2LYUKaIyGFQuMRhQpgVCsDA/7wJowEQFwMBIK4cCABfkXqATSXLeuyvKAJfkUZjH2PKyuyuAAEzAb8gjwIx3pwiBTSQTSbEsRE8mcXItxkhSMHsvSBFMiymFmlkPLYPygaRnkM7FDKhx5NysEILC6DruEcC6oKtn2WgjloKaHLWQ6NpGQGflOi6ozukxFqOv6cyBiGAVhr6TrcTGoxtLoDFMeyrHMZx3FitSmkMjpL5shyNkwBAeV8rg5WVa5NVUk61UVVSnYlFJF5gEgEEwXOcFQvVGKjoq6jUHAmjSu19AQYACYQwQNMBPrp8kRHUmypYcmUHnkJQwcYlVlc1GINI6O0FAqe0NYqDRzLtRi1VyTWVUMcDJVsUDZjNt15YtL7yVyO5wOt2VbaUX0NUZj1UtdoNnRYF3ildCWnfq8PwMKkNHUlsKdu9n2w7gqM/W4SkA6JQgMWDCOSfCHVdcNmabdT0l0yNVDAxxSJKLwrDomM2Q2NgEBjVSWI4mgtgkmgal6gkCzgDAsL0lAJVQqzmjlfBRUfCUFQy9QIVqHaABERtwIAFERwO6LYwN62RzGrlwGC2EZY5sVE0XR9ECNg3pQEY7Bcc9Gk/FSj4FXd4ObN2MC9g22QDqw9YjmOZPwLgrhln7dajEWLY5Hk3spz8YlwOnFAdF70H46jcdMx13X4w7Gsq6j3qzdXEcYkTtgRBzChc+sBwCqS+IgPz+IvYIADWDDoOkRhQJIgOoGA2A5AA9OvVB5qwio8I2IDr5oSAUGAi+6FAR8EhQAAs69gIqtbrwAjM/gmqgAnDQFBICAOCdQIQ4M4VIj3JKYTggDcApFwNhBkFAIALXYPALIcoIFoGKBkJoPl5gpGKHkAANRyAAPNsLopDdQ+WjNjc8U1pxoKgWcbC+FoL0OgUgvCRgjDemgQAJSQNmGBm5mFwF4fwmBC18JREltLEgrCvibhfCkLSWFkG61kSIdBmQsHmgYdgPBpCSEcm6E0QABkTzEUbUZ6r0gbPRpOnbAywABi0B1GQOwr1OyDkNybHrj4dhwjoG/AkZw7hZw+ECP8SEkRYSxFBI4UYAGkg0BUCQCAqWo9wEaN0bgb4fwsKbgZEgzIai0EYO0dZXRGDWD6KaIYshYAclBMBs5OAlCXrULgMibmCRsicCnocNYvNcy1heoEJJcAursAQdJTQHQZCAJzIcIGtw4AAAMSBgE4DAbAqyuyCB5qmeEMRdBTICK+TYyIuDKmHrzXm6z8bIHUAIVZtshbZiWUgNK5U1CKk4VoSZeYYCaFwJsfE7xDhGEVFMVgYAOQnjGgUgi8DEHwBKJC6FcLKzuChKtFKnyrJzDseiAAqrwRxqpHHACgBiTxm44ToFKO2Z63w2RuCUYUq4NJcVwFxj4elaBvQXBgKS8ltKq76iFSK1UtKyI3MRDQ0C15byiIEfygAkrYH4WkjAHBgHZWVgz5WA3xYDHkeQ7HGB1ZcXA6rNV2gaZa3VNr3Iap+FaUoFrOFOttW6pQDqvXWp9QMKhnZfGRK4dEvA4TxHxNlTCmknYkkpLWia1gIpWkEwDdSH1nTtiZqtdml1dqSFlHOJcQGdRYKeVdvcMNwSI0qpjZIiZnLE1/2TaMe82gW1yrHPeCcABuCZUA2aCSHby1gWVppwBQtSdCmEcSCwEADXl07aXKCgGmWEZaYDfk0CANkfw0zkx1jRRgz08AYnaDANVFABDsHprofN3qi1uptP6gtzr0Cuu5aMU9EAmgXtwFe2At772PrQM+wNr73Ufpfd+u1NpS1CorVWjcdQDU8yNQAduklecCPhp29W/HeiAMQoRCpVkE49NtKQYlgiRxs5Gm4yEw+iTsQNWCAGCCXKVId17vJP1CA67N1IHhDKbixHSMxGXB0ZD5bWB1F/VsEowBuKes/Tmv1UHC0IZ+NKJlVDmbKYnVx70xLb0wFVPYqVlLqV6vchRy4AmD1SaY2gWTbGjUKqaGBW84bQlRrEeGuNsK23JNSaMXD9c/MQRE1u4DG5D3kDErbJL/LsAA1GLy2duAwTwU0poIwpFOy4aTZFrYuGbFzFLbkq4laMRQHscsQRUIPHuU8sBWmEFcvzsZNgJdQ1WZyrSTIuReBjCuM3EwzhxS5SwzKTo8qU3KmZGwXgZYuDcidn9VNlpHJAAphOQjNy20HcTVZw3AWc5DeD8PQKIqkMmbbOKdjRKihNTfiXNsyC2tGtJ0c9vR237gNNewswxTU9tHdqf956F2jBXf9qNp7IQViNLybAgiRSUE/fMIt9bVhUdbYyNU6YcA6nGPR1cfbNaeUfR8HVlhWToGTbQfk+Jbc4CA8h2z9hYOhGcNJsXcmK3oF1fZxyuQL49a0G/r/f+gggH40B8jsBLKXyA+UdjtRv3MG1HKCDQHagLJFLyDMEhBuBgIjgGYvAGuieWJDaMVw5AhZATxWlM3Tg9w6ZaXbpYDuJtZu4gb5rqPWtpmzCRlYuxhfwFy8iiXWPUVmkAB2kY0YA3Cw3IGIxwnA8LQNoW9th4zCBkLgDIioME67x5kaQwhPdc8D4bboJBoDwCr5sEo9vkiWK7Ag4AaV/e2EB9ykodXmiAAAiUhlRm8+0ZWT23CwA+9+wA0bo9fB+HFq00xTZDN9pTAGPwDTfV/1GaAfw4gHhjO4mGT+2y+R/N9uLIe47Z089+qCkJ4BxOwT6aO2KcNgAXkXm4KXomIBCvl/rUBPjvn8BWtyiCPlhCNCFJECNIhkv4Fso+HAk0igpnPNrXpgs0EbkDiTovuYlASsIUF3v4M0HAfVqQJsnmNkBJo6CxlMPJvVg0FKNMEwdgWNJyAkOrAYFwRWglLwdmOsPiLsHSFrOkFYjTFNLFn4A0ppPIeKrLPIf1oNm7FmirJHtHikFjMzBBI6pcFCIzpGrgNGnEs2vTKNP4DpgYfwkYY8P3HAGqjygSLWPCEDPAmMDEF1KwBAB9N8mfBAF8tno9mAlgSwU5gtBwXNgQbjkUJkHnBKO0ItrPmfkDjrCfg0hsgIWWDrMIY7FMM7DaFKAbA0ihk4erlQeygREkXMHnE7oYNRLRFMPRFAHuN6KwIHPbGoSHBiGHHSBwd3GoA0g0U/qvsohwT4soUqhBBMdoV+HGrHiXKwLgM/MBrCFIKrhSOwtAC3FjocDjjLotmAIbnPiblZMdtcVbjDtcebKQnMC8YoZsAIGLNkLlsccrOHPkgijmDvPWBnBnkXCXGXGWEgmCeXMxJCeTGXHJpNJeD4NznYVEo2piRGuyCtIcaYMwdsgsCMdsirNoUVgtByskTyoQWkcQR8aftAdkHkXQWbvwSwYIbwTKPAGbgeBbgbO6OwHxLyN6GWHMMKQlOwPyCGNcRydsmNDyDKPyI6LwZ8c7mAQmAYC8Q4WzOUCAcXuAQYAnPWJ/isIiaignggu9oUlfmHnYBHq4WyrUEgpWnsKAPWP/geO2G2B2G/ianyVTs0hbq8XKRPu2O8dxP8acUCePnEpjiohnspt8QcKsFhiCYOFsEWOCUggeCeJRJ0Z7MKWKaKTyv7LbNcYMTxBnnuAWR7N0cWWWQHNxP4D7r8KHOSc+KyAsfcNlrEK4IcPRI2UkWUD7ihnvo6NKUzLyjBNoYuhAMut6NihzL2aYSobOV2QugNguUNpmHEWSbgfAa2Z2NmfCWaPmaudgHvOKO7r2e7F0QxOwL7P7FWU4e2aMZ2bpKrGURrCJHHo+WltQCIZwXKeOXUM+U+VMdgcohPv4H3DERSO8JhNhDMBceZFon3qQdkZkR0N0AgL0OwDUrULqOULgEhTPu0einhJqWXlMEhZsBPvCqnAioRLEGWFCAxU0kxf+dhGCuxZxfAb6dxSXNhClg+KUAmUUjyZYU0jig0G2ASUharBAFCrYN8ANt9pcRhbrFhX9nkLJmQvhX0Hgl3u6EygiGRWkKQkvmaSkN6CcEAZZR8EfjuggaGWcORU0A/rZY7u0psFRXGFqXRVZUQgOpWBOGkIpWkAhJIJspcIsDgNgMoIqG6mhbrjMDkcycbo0M0AZXhQRQ0BkGWCAB0KkdQBZGyRZUUZycVWqW6F2Dyt6I5Z5ZWtVQqWwTaCADwcGHANPgIN6CALgPePWc2GQvgk0G0X5W8FCtRSXkFXAORSmBgOmJmLVQJfABeVsDFssaodBT5Y+M2gBP4J2MxfRCbN6Ode0nhqoYpFdb4jBMNV0QdYLiucWFxZWKdZdSVXXPQCzHuWAD9WiQ9TICNbGq9f/jAUstWZtaMPeZ7CVX0cxK+cMR2ZpKsZuW9aGtefALebDYWd0SAL7BWYjawHuFWb6fUUEidf+fRCOaRSht8MdJ1UTTLmhJuToQuXAOnq2YDWADWGWNOPjI9a4M9QkvBaAohdFQfHFegOpdkGlUQTMAbiQbcXpThYZQRTQX+hcNMMRQiHuNKKbvreThZS1cDnAONZ8NgGOeWnGayrMcyVruRJnsGlNR0fWQxITY1VMf0VWUpdLerAlQNslW6k0KRfuUanDQ2VlFOcxMTcjSSajXIezZSU7Rnimo3sKW5F4k5O8d7jpl+mgK6rTj5njPqD6oRE6SsMTc4ZpIYc6Zlm7PjZ7YjVnBBVWRpHSIVOzWaG1EoeAF1D4IaruaNBcA0LedHLHBpPLIrCcWjT+dCPIWNPyCaTnKXOCeyHmaeLWrQpvbKnQcef6WlJvSDMrXnakM5dxBifAfkbXXSPXeadzXKeYQtHXVXSkMpsxSUH8RIpumxXAFCKUCfVzUmW6ZwCAPWMiQxP1cvYjZvVxDDXhioZvd6HOducuj2ofVsEDJRmaBekSY+JRkkVg6MDpOBInDvWiSg+OBYVBKzcLQ+LGlLh8DBCrkAA\">Playground link</a></p>\n<p>I want to mention that I quite like the dependent <code>ValidPos</code> type, and I understand there is much room for future improvements. Thank you for great work!</p>",
        "id": 561400761,
        "sender_full_name": "pandaman",
        "timestamp": 1764679096
    },
    {
        "content": "<p>A few more useful lemmas for <code>ValidPos</code> (mostly ports from the <code>Nat</code> ordering):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n\n<span class=\"c1\">-- already in nightly</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">next_le_of_lt</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">next_inj</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eq'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">splits_next</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eq_left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">splits_next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">append_singleton</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">push_inj</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">eq'</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eq'</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">splits</span><span class=\"bp\">.</span><span class=\"n\">offset_eq_rawEndPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">splits</span><span class=\"bp\">.</span><span class=\"n\">offset_eq_rawEndPos</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lt_of_le_of_ne</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_le_of_ne</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValidPos</span><span class=\"bp\">.</span><span class=\"n\">ext_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">Raw</span><span class=\"bp\">.</span><span class=\"n\">ext_iff</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_of_lt_next</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">by_contra</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">nle</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">not_lt_of_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ValidPos</span><span class=\"bp\">.</span><span class=\"n\">next_le_of_lt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_not_le</span><span class=\"w\"> </span><span class=\"n\">nle</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">lt</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_or_eq_of_le_next</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">byCases</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_of_lt_next</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt_of_le_of_ne</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"n\">ne</span><span class=\"o\">)))</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_next_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">le_or_eq_of_le_next</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">?_⟩</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">le_trans</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_of_lt</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">lt_next</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">le_refl</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lt_next_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">le_of_lt_next</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_le_of_lt</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">lt_next</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_iff_lt_or_eq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_iff_lt_or_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">or_congr</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValidPos</span><span class=\"bp\">.</span><span class=\"n\">ext_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">Raw</span><span class=\"bp\">.</span><span class=\"n\">ext_iff</span><span class=\"o\">]))</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lt_next_iff_lt_or_eq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValidPos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">endValidPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">lt_next_iff</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">le_iff_lt_or_eq</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">ValidPos</span>\n</code></pre></div>",
        "id": 562220769,
        "sender_full_name": "pandaman",
        "timestamp": 1765001809
    },
    {
        "content": "<p>I have completed porting from <code>Iterator</code> to <code>ValidPos</code> with a scary <a href=\"https://github.com/pandaman64/lean-regex/pull/144\">+3,434 −4,321 PR</a> <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span> The proofs are passing so it should be good... <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span> </p>\n<p>Reflecting on the experiences, I'm convinced that <code>String</code>-based <code>Splits</code> is useful enough to prove non-trivial properties like those in <code>lean-regex</code>, and <code>List Char</code>-based one is not necessary (while falling back to lists sometimes makes the reasoning easier). I'm sure that missing lemmas can be added gradually.</p>\n<p>Again, I like the dependent <code>ValidPos s</code>, and I hope we have dependent slices, too. It removed the need for some verification conditions (e.g., <code>it.next.s = it.s</code>), which partly contributed to the reduction in the line count. (Not all reductions come from it, since rewriting proofs with <code>grind</code> also reduced line of proofs by a few hundred)</p>",
        "id": 562221221,
        "sender_full_name": "pandaman",
        "timestamp": 1765002376
    },
    {
        "content": "<p>Great thank you for improving the string APIs!</p>",
        "id": 562221244,
        "sender_full_name": "pandaman",
        "timestamp": 1765002404
    }
]