[
    {
        "content": "<p>Why is there an error for <code>rfl</code> in the code below?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c\">/-</span>\n<span class=\"cm\">  type mismatch</span>\n<span class=\"cm\">    rfl</span>\n<span class=\"cm\">  has type</span>\n<span class=\"cm\">    ?m.36775 = ?m.36775 : Prop</span>\n<span class=\"cm\">  but is expected to have type</span>\n<span class=\"cm\">    b = m.snd : Prop</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>Besides using a <code>match</code> and <code>congrArg Prod.snd</code> as shown below, can definitional equality be applied somehow?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 498507169,
        "sender_full_name": "Gordon Hsu",
        "timestamp": 1739025462
    },
    {
        "content": "<p>Destructuring <code>let</code> notation doesn't keep track of the relationship between the value being destructed and the new variables unfortunately.</p>\n<p>The <code>match e : m with</code> is one way to do it, and the other is to simply not destruct <code>m</code> in the first place.</p>",
        "id": 498516102,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739032694
    },
    {
        "content": "<p>Thanks for the clarification. One other question, how is the <code>let</code> binder different from <code>Prod.eta (p : α × β) : (p.1, p.2) = p := rfl</code>? Why is one definitionally equal, yet the other isn't? I think I am missing something very basic.</p>",
        "id": 498517447,
        "sender_full_name": "Gordon Hsu",
        "timestamp": 1739033893
    },
    {
        "content": "<p>The <code>let</code> binder throws away the relationship between <code>a</code>, <code>b</code>, and <code>m</code>.</p>",
        "id": 498519966,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1739035876
    },
    {
        "content": "<p>The <code>let</code> destructuring bind is sugar for <code>match</code>, so just like <code>match</code> there's no relationship between the original value and the pattern variables.</p>",
        "id": 498520156,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739036027
    },
    {
        "content": "<p>Underneath all this is that <code>match</code> uses recursors to break apart values, and there's no defeq relationship between the value broken apart and the components given by the recursor.</p>\n<p>It seems like a reasonable feature request for <code>match</code> for structure-likes to be special cased, to use projections instead of the recursor. So for example <code>let ⟨a, b⟩ := m; ...</code> would be short for <code>let a := m.1; let b := m.2; ...</code>.</p>",
        "id": 498520352,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739036182
    },
    {
        "content": "<p>One small complexity here is that in case the structure-like has dependent fields, successive fields refer to the new <code>let</code> variables rather than <code>m</code>.</p>\n<p>This is a reasonably large project though.</p>",
        "id": 498520545,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739036374
    },
    {
        "content": "<p>Note that in tactic mode <code>obtain \\&lt;a,b\\&gt; := m</code> will simply remove <code>m</code> and replace it with <code>Prod.mk a b</code> so you won't have this problem</p>",
        "id": 498520874,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739036658
    },
    {
        "content": "<p>It also leaves some ugly recursors in the term generated.</p>",
        "id": 498520952,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1739036734
    },
    {
        "content": "<p>That's not something people usually care about for proofs though. (But in the context of the original question, yes that could be an issue, and it's consistent with the 'don't use tactics for data' advice.)</p>",
        "id": 498521127,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739036849
    },
    {
        "content": "<p>Thanks for all your help <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span><br>\nSince <code>let</code> boils down to <code>match</code> that uses recursors, there is no definitional equality with propositional equality being the only thing available. The <code>obtain</code> tactic is indeed helpful in tactic mode.</p>",
        "id": 498565505,
        "sender_full_name": "Gordon Hsu",
        "timestamp": 1739076341
    },
    {
        "content": "<p>There is an open feature request on GitHub for changing the <code>let</code> behavior here</p>",
        "id": 498735763,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739186915
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/A.20question.20regarding.20the.20eta.20rule.20for.20the.20product.20type/near/498735763\">said</a>:</p>\n<blockquote>\n<p>There is an open feature request on GitHub for changing the <code>let</code> behavior here</p>\n</blockquote>\n<p>That's awesome, but I couldn't find the GitHub issue.</p>",
        "id": 498741316,
        "sender_full_name": "Gordon Hsu",
        "timestamp": 1739188567
    },
    {
        "content": "<p>I wasn't able to find it either.</p>",
        "id": 498819069,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739208068
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5216\">lean4#5216</a> is what I was thinking of</p>",
        "id": 498820539,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739208486
    }
]