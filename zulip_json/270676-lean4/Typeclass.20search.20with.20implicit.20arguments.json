[
    {
        "content": "<p>Consider the following MWE (cc <span class=\"user-mention\" data-user-id=\"611077\">@Jiang Jiedong</span>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> it fails after commenting the next line out -/</span>\n<span class=\"w\">  </span><span class=\"n\">haveI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"w\">  </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n</code></pre></div>\n<p>Enabling <code>pp.all true</code> yields that in the last line, <code>@Foo R (baz R)</code> is searched for, but <code>boo</code> has type <code>@Foo (Bar R) (baz R)</code>. This makes sense, as the type of <code>R</code> is probably inferred from the equality <code>ha</code> which lives in <code>R</code>. But adding the line <code>haveI : Foo (baz R) := inferInstance</code> makes it work and <code>trace.Meta.synthInstance</code> reveals that it now in the last line checks this local instance and some unification (?) applies and yields the result.</p>\n<p>Is there any mechanism to make this work without the <code>haveI</code> (and without explitly passing more arguments to <code>Foo.foo</code>)?</p>",
        "id": 478122547,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729534702
    },
    {
        "content": "<p>make <code>Bar</code> into an <code>abbrev</code></p>",
        "id": 478124659,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729535474
    },
    {
        "content": "<p>if this is considered a \"cheat\" solution, could you try and provide a mwe using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">R</span>\n</code></pre></div>\n<p>Because i'm not sure what you're trying to do, and i believe right now there is no point where the <code>Coe</code> instance you defined gets used.</p>",
        "id": 478126472,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729536112
    },
    {
        "content": "<p>right now, your mwe uses defeq only</p>",
        "id": 478126605,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729536152
    },
    {
        "content": "<p>Oh yes, the <code>Coe</code> is irrelevant, that is a miscopy from a previous iteration (edited above).</p>",
        "id": 478126793,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729536231
    },
    {
        "content": "<p>Does something like <code>set_option synthPendingDepth 2</code> fix it? I'm on mobile and going by memory so that might not be exactly right, but autocompletion should find what I really mean. Meta.synthPendingDepth maybe?</p>",
        "id": 478159201,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729548701
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478122547\">said</a>:</p>\n<blockquote>\n<p>Is there any mechanism to make this work</p>\n</blockquote>\n<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>It's sort of random whether <code>Foo (baz R)</code> elaborates to <code>@Foo R (baz R)</code> or <code>@Foo (Bar R) (baz R)</code>, so it seems better to be explicit.</p>\n<p>(It's not really random, but it's not immediately obvious which it would be.)</p>",
        "id": 478161869,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729549835
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478159201\">said</a>:</p>\n<blockquote>\n<p>Does something like <code>set_option synthPendingDepth 2</code> fix it? I'm on mobile and going by memory so that might not be exactly right, but autocompletion should find what I really mean. Meta.synthPendingDepth maybe?</p>\n</blockquote>\n<p>Do you mean <code>maxSynthPendingDepth</code>? If yes, this does not fix it.</p>",
        "id": 478224180,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729583270
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478126472\">said</a>:</p>\n<blockquote>\n<p>if this is considered a \"cheat\" solution, could you try and provide a mwe using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">R</span>\n</code></pre></div>\n<p>Because i'm not sure what you're trying to do, and i believe right now there is no point where the <code>Coe</code> instance you defined gets used.</p>\n</blockquote>\n<p>This came up while debugging <a href=\"https://github.com/leanprover-community/mathlib4/pull/17403\">#17403</a> (see in particular <a href=\"https://github.com/leanprover-community/mathlib4/pull/17403#issuecomment-2418322525\">https://github.com/leanprover-community/mathlib4/pull/17403#issuecomment-2418322525</a>).</p>",
        "id": 478224744,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729583475
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478161869\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478122547\">said</a>:</p>\n<blockquote>\n<p>Is there any mechanism to make this work</p>\n</blockquote>\n<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">boo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>It's sort of random whether <code>Foo (baz R)</code> elaborates to <code>@Foo R (baz R)</code> or <code>@Foo (Bar R) (baz R)</code>, so it seems better to be explicit.</p>\n<p>(It's not really random, but it's not immediately obvious which it would be.)</p>\n</blockquote>\n<p>Yes, this works. Still there seems to be a difference between the local instance variable as introduced in the <code>haveI</code> line and the global <code>boo</code> one, although (without  your explicit type suggestion in <code>boo</code>) they both have type <code>@Foo (Bar R) (baz R)</code>. Are local instance variables tried more liberally in instance search than global ones?</p>",
        "id": 478226419,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729584015
    },
    {
        "content": "<p>Making Lean unify <code>R → R</code> and <code>Bar R → R</code> when <code>Bar</code> is a type synonym seems like a recipe for a bad time.</p>",
        "id": 478291313,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729605270
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478291313\">said</a>:</p>\n<blockquote>\n<p>Making Lean unify <code>R → R</code> and <code>Bar R → R</code> when <code>Bar</code> is a type synonym seems like a recipe for a bad time.</p>\n</blockquote>\n<p>If I understand things correctly, this is what we are doing when using <code>CommRingCat.of</code> and the related <code>FunLike</code> instances.</p>",
        "id": 478295652,
        "sender_full_name": "Christian Merten",
        "timestamp": 1729606428
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/270676-lean4/topic/Typeclass.20search.20with.20implicit.20arguments/near/478226419\">said</a>:</p>\n<blockquote>\n<p>Are local instance variables tried more liberally in instance search than global ones?</p>\n</blockquote>\n<p>Yes they are. They're tried first, and they're tried with defeq, without making use of a discrimination tree.</p>",
        "id": 478334650,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729618187
    }
]