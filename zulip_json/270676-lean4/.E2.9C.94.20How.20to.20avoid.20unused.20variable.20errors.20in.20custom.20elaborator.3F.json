[
    {
        "content": "<p>In the following code, I get an 'unused variable' error. As expected, this doesn't happen if I define <code>instantiate</code> as a <code>macro</code>, but my real code needs access to the environment, so it must be an <code>elab</code>: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"instantiate\"</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" : \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"c1\">-- unused variable `dec_nat`</span>\n<span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">dec_nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>\n<p>What must I do to properly maintain the correspondence between identifiers to get rid of this linter warning?</p>",
        "id": 493111059,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1736614833
    },
    {
        "content": "<p>It looks like a linter bug to me.</p>",
        "id": 493112889,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736616387
    },
    {
        "content": "<p>You could cheat with <code> Lean.Elab.Command.elabCommand $ ← `(set_option linter.unusedVariables false in variable [$nm : $t])\n</code></p>",
        "id": 493112904,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736616402
    },
    {
        "content": "<p>I think we only started seeing this after updating our project from v4.11 to v4.14, so that would make sense.</p>",
        "id": 493113479,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1736616958
    },
    {
        "content": "<p>This linter is rather brittle. I see it giving false reports pretty often.</p>",
        "id": 493114378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736617772
    },
    {
        "content": "<p>Here's how you can disable the linter for just your elaborator:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instantiateStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"instantiate\"</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" : \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">])</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">unused_variables_ignore_fn</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ignoreInstantiate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">IgnoreFunction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">stack</span><span class=\"bp\">.</span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``instantiateStx</span><span class=\"o\">]</span>\n\n<span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">dec_nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 493127163,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736629213
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"542918\">George Pîrlea</span> has marked this topic as resolved.</p>",
        "id": 493166946,
        "sender_full_name": "Notification Bot",
        "timestamp": 1736668960
    },
    {
        "content": "<p>For future reference, in case someone else comes across this thread later: for us, the issue turned out to be the change in behavior of the linter introduced in <a href=\"https://github.com/leanprover/lean4/pull/5338\">lean4#5338</a> (Lean <code>v4.14</code>), as our terms were defined using tactics.</p>\n<p><code>set_option linter.unusedVariables.analyzeTactics true</code> is the relevant option.</p>",
        "id": 494744271,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1737361010
    }
]