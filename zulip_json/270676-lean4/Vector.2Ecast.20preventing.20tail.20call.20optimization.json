[
    {
        "content": "<p>Consider the following two functions</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span>\n<span class=\"w\">    </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">loop1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>For arbitrary monads, I understand why 'loop2' could not be tail recursive in general. However, for typical lawful monads, with sufficient inlining I would have expected 'loop2' to be able to be made tail recursive. Indeed, if IO is changed to Id, the compiler produces equivalent tail-call-optimized code for both loop1 and loop2. However, in IO, the compiler produces the following C code:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_loop1</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unsigned_to_nat</span><span class=\"p\">(</span><span class=\"mi\">0u</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_dec_eq</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unsigned_to_nat</span><span class=\"p\">(</span><span class=\"mi\">1u</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_add</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_sub</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_array_push</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"k\">goto</span><span class=\"w\"> </span><span class=\"n\">_start</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_loop2</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unsigned_to_nat</span><span class=\"p\">(</span><span class=\"mi\">0u</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_dec_eq</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_unsigned_to_nat</span><span class=\"p\">(</span><span class=\"mi\">1u</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_add</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_nat_sub</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_array_push</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_loop2</span><span class=\"p\">(</span><span class=\"n\">x_8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_9</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_8</span><span class=\"p\">);</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">lean_is_exclusive</span><span class=\"p\">(</span><span class=\"n\">x_11</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_14</span><span class=\"p\">;</span>\n\n<span class=\"w\">            </span><span class=\"n\">x_13</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get</span><span class=\"p\">(</span><span class=\"n\">x_11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">x_11</span><span class=\"p\">);</span>\n\n<span class=\"w\">            </span><span class=\"n\">x_14</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_14</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_15</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"n\">x_15</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}}</span>\n</code></pre></div>\n<p>is this expected behavior?</p>",
        "id": 570696421,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769655325
    },
    {
        "content": "<p>(Also this is not IO specific. this seems to happen for any monad except Id)</p>",
        "id": 570698074,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769656646
    },
    {
        "content": "<p>Given the kinds of optimizations that we have in the compiler it is at least expected to me that this happens and I do not have a pass in mind that would capture this. Btw it does of course work for the reader monad as well. I can think of a pass that will detect this kind of behavior for <code>IO</code> and many <code>IO</code>-like monads but for some monads this is always going to be something the compiler cannot tell.</p>",
        "id": 570729607,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769674912
    },
    {
        "content": "<p>Isn't this basically <a href=\"https://github.com/leanprover/lean4/pull/7374\">lean4#7374</a>?</p>",
        "id": 570746703,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769679818
    },
    {
        "content": "<p>Btw, you can fix that locally:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cast_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">cast_impl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">cast_impl</span>\n<span class=\"w\">  </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span>\n<span class=\"w\">    </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">loop1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 570747707,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769680107
    },
    {
        "content": "<p>You can do <code>csimp</code>... but the compiler <em>should</em> be able to handle this itself</p>",
        "id": 570748497,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769680338
    },
    {
        "content": "<p>I agree. Though, is it problem with <code>bind</code>? Shouldn't compiler be able to realize that <code>Vector.cast</code> is just <code>id</code> at runtime representation level?</p>",
        "id": 570749177,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769680516
    },
    {
        "content": "<p>Hmm, why does this not <code>simp</code> more?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mono</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">15</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span>\n</code></pre></div>\n<p><code>_x.11</code> <em>should</em> be simped to <code>_x.8</code> and then the match <em>should</em> be made redundant</p>",
        "id": 570751281,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769681092
    },
    {
        "content": "<p>Yeah iirc (not at my laptop atm) the compiler is capabale of performing the tail call optimization on  e.g. <code>(fun x =&gt; h ▸ x) &lt;$&gt; loop1 …</code></p>\n<p>Both this and Vector.cast (once it is inlined) are just the identity function, so I don’t understand why they lead to different outcomes.</p>",
        "id": 570754895,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769682016
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1006649\">cmlsharp</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.2Ecast.20preventing.20tail.20call.20optimization/near/570754895\">said</a>:</p>\n<blockquote>\n<p>Yeah iirc (not at my laptop atm) the compiler is capabale of performing the tail call optimization on  e.g. <code>(fun x =&gt; h ▸ x) &lt;$&gt; loop1 …</code></p>\n</blockquote>\n<p>Yes, that why it works if you use <code>csimp</code> to tell compiler to use <code>h ▸ x</code> instead of destructure and construct back, which is what <code>Vector.cast</code> does. From what <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> posted, as I understand it, it looks like the problem is that compiler didn't realize that <code>Vector.cast</code> is identity.</p>",
        "id": 570755728,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769682229
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.2Ecast.20preventing.20tail.20call.20optimization/near/570751281\">said</a>:</p>\n<blockquote>\n<p>Hmm, why does this not <code>simp</code> more?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mono</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">15</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">loop2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span>\n</code></pre></div>\n<p><code>_x.11</code> <em>should</em> be simped to <code>_x.8</code> and then the match <em>should</em> be made redundant</p>\n</blockquote>\n<p>The simplifier does not have this machinery at the moment</p>",
        "id": 570755731,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769682230
    },
    {
        "content": "<p>At least not explicitly, it could happen as a sequence of let value optimization then default case optimization and then trivial case erasure. Though the compiler is careful to erase cases at the LCNF stage because they can lead to less optimal reuse behavior further down the line. In general removing any <code>case</code> statement at the LCNF level <em>can</em> be dangerous for FBIP. So it should happen at the IR level after reuse though this of course makes it much more finicky to figure out.</p>",
        "id": 570755847,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769682261
    },
    {
        "content": "<p>Having written passes that actually pessimize build times significantly because they drop cases the fact that doing <code>cast &lt;$&gt;</code> works at the LCNF level is more worrying to me than the fact that <code>Vector.cast &lt;$&gt;</code> doesn't work really <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 570758447,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769682937
    },
    {
        "content": "<p>See for example <a href=\"https://github.com/leanprover/lean4/pull/11078\">https://github.com/leanprover/lean4/pull/11078</a></p>",
        "id": 570758905,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769683050
    },
    {
        "content": "<p>If I understood correctly, you're saying that the compiler is already able to simplify</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcAny</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">Out</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span>\n</code></pre></div>\n<p>to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span>\n</code></pre></div>\n<p>?</p>\n<p>So it seems like the missing kind of optimization that we would wish to have is replacing the \"constructed-back\" expression inside <code>cases</code> statement with the variable being matched.</p>",
        "id": 570759768,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769683281
    },
    {
        "content": "<p>Yes but as I have explained this is not something we want to happen this early in the pipeline, it needs to happen after insertResetReuse. Almost any touching of cases before doing this can have pessimization effects.</p>",
        "id": 570760067,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769683361
    },
    {
        "content": "<p>The PR above only tries to detect more situations where you case on the same variable twice and remove the second case and that was already an FBIP pessimization, one needs to be really careful with any sort of case touching.</p>",
        "id": 570760299,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769683429
    },
    {
        "content": "<p>Hm, that makes it wonder if removing the trivial case erasure might have positive effect in some cases? It might be worth investigating why does removal of cases causes FBIP pessimization.</p>",
        "id": 570760816,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769683565
    },
    {
        "content": "<blockquote>\n<p>Hm, that makes it wonder if removing the trivial case erasure might have positive effect in some cases?</p>\n</blockquote>\n<p>Almost certainly yes, there are also several tensions here. For example, we have the default case optimization which collects the most common case in the simplifier already (it happens later in IR as well) and this might of course obscure what constructors are in flight in certain branches which can in turn inhibit reuse (and potentially other optimizations if they don't work hard enough to analyze the situation).  On the other hand, removing this optimization would mean that you might repeatedly inspect the same (potentially non trivially sized) code arm over and over again so it is still benefitial.</p>\n<blockquote>\n<p>It might be worth investigating why does removal of cases causes FBIP pessimization.</p>\n</blockquote>\n<p>Because the heuristic is very sensitive to a <code>case</code> statement followed by several projections being present in a certain way in order to even consider reuse (for performance reasons). If you inspect the IR pipeline you will see that it only ever considers removing dead projections and certain trivial cases <em>after</em> inserting reuse:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">reuse</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Decl</span><span class=\"bp\">.</span><span class=\"n\">insertResetReuse</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logDecls</span><span class=\"w\"> </span><span class=\"ss\">`reset_reuse</span><span class=\"w\"> </span><span class=\"n\">decls</span>\n<span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Decl</span><span class=\"bp\">.</span><span class=\"n\">elimDead</span>\n<span class=\"n\">logDecls</span><span class=\"w\"> </span><span class=\"ss\">`elim_dead</span><span class=\"w\"> </span><span class=\"n\">decls</span>\n<span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Decl</span><span class=\"bp\">.</span><span class=\"n\">simpCase</span>\n</code></pre></div>\n<p><code>simpCase</code> here does:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Simplify `case`</span>\n<span class=\"sd\">  - Remove unreachable branches.</span>\n<span class=\"sd\">  - Remove `case` if there is only one branch.</span>\n<span class=\"sd\">  - Merge most common branches using `Alt.default`. -/</span>\n</code></pre></div>\n<p>doing any of these before inserting reuse instructions can and does cause problems.</p>",
        "id": 570762319,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769683953
    },
    {
        "content": "<p>It's indeed quite an unfortunate situation that LCNF's pure pipeline has to consider the optimizations of the impure pipeline instead of just optimizing for its simple cost model of \"do less branches if possible\" but that's just how it is. If this optimization should happen it should be done by <code>simpCase</code> in <code>IR</code>. I might get to that this quarter as I migrate the legacy IR optimizations to LCNF.</p>",
        "id": 570763089,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769684166
    },
    {
        "content": "<p>I don't want to pester you further, could you point me where I could read about reuse/FBIP to understand what it does?</p>",
        "id": 570768299,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769685694
    },
    {
        "content": "<p>The original paper is here <a href=\"https://arxiv.org/pdf/1908.05647\">https://arxiv.org/pdf/1908.05647</a> though the implementation in Lean does deviate somewhat noticeably from it by now.</p>",
        "id": 570778176,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769688851
    },
    {
        "content": "<p>In this case would it make sense upstream the above csimp lemma?  Unless it is indeed a mistake that cast &lt;$&gt; works.</p>",
        "id": 570821701,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769699471
    },
    {
        "content": "<p>I don't see why this would need to be done as a csimp lemma, this could also just be the implementation of <code>Vector.cast</code>.</p>\n<p>In any case I would recommend not to rely on the compiler to figure out a tail call for you for anything but a direct <code>h  ▸ f args</code> tail application. This is the only one where the compiler absolutely guarantees that it becomes an id, everything else is subject to heuristics etc that can blow up at any moment.</p>",
        "id": 570822841,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769699732
    },
    {
        "content": "<p>Oh yeah good point. This does make me wonder if something like OCaml’s @[tailcall] attribute (which just causes a warning if a call is not actually tail call optimized) would be useful.</p>",
        "id": 570824957,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769700196
    },
    {
        "content": "<p>Yes a <code>@[tailcall]</code> attribute can be useful. However, it has to have a more creative meaning than in OCaml. For example, Lean produces lots of specializations for most of the code it works on. Should <code>@[tailcall]</code> also ensure these specializations are tail recursive? The semantics are not so clear unfortunately, some real though has to be put into things like this.</p>",
        "id": 570825774,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769700380
    },
    {
        "content": "<p>Yeah I was wondering about specializations also. </p>\n<p>I think Scala also has such an attribute and I think they do have statically dispatched generics. I should look at what they do.</p>",
        "id": 570833498,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769702145
    },
    {
        "content": "<p>I suspect what happens is that their tailrec attribute is checked prior to specialization</p>",
        "id": 570837241,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769703059
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1006649\">cmlsharp</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.2Ecast.20preventing.20tail.20call.20optimization/near/570837241\">said</a>:</p>\n<blockquote>\n<p>I suspect what happens is that their tailrec attribute is checked prior to specialization</p>\n</blockquote>\n<p>If you do that your <code>cast_impl &lt;$&gt;</code> would not be recognized as a tail call btw</p>",
        "id": 570851742,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769706678
    },
    {
        "content": "<p>Yeah, I understand that. The other obvious alternative would of course be to check after the specialization has been dispatched, but that would lead to unintuitive error messages at usage sites presumably. You're right that its a difficult problem! (A middle ground could be something like @[tailcall(IO, Id, Except)] or something where you check a closed list)</p>",
        "id": 570880999,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769715598
    }
]