[
    {
        "content": "<p>The <code>extract_lets</code> tactic had an unexpected (for me) behavior when two of the <code>let</code> statements referred to syntactically identical (not just defeq) expressions: only one of the two <code>let</code> statements can be assigned a name.  MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">extract_lets</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\">  </span><span class=\"c1\">-- linter: b is unused</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>From a purely pragmatic point of view, this does not hinder the ability to complete the proof - one simply uses the one name to refer to both quantities - but from a conceptual or pedagogical point of view it is not always desirable, because the two quantities might play completely different conceptual roles in the proof but are only syntactically equal \"by accident\".  Would it be possible to modify the tactic to allow <code>let</code> statements with syntactically equal values but distinct names be assigned as distinct hypotheses in the proof state?</p>",
        "id": 528370363,
        "sender_full_name": "Terence Tao",
        "timestamp": 1752250173
    },
    {
        "content": "<p>This looks like a bug to me, cc <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span></p>",
        "id": 528370536,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752250236
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/extract_lets.20cannot.20extract.20syntactically.20identical.20lets\">#mathlib4 &gt; extract_lets cannot extract syntactically identical lets</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 528370569,
        "sender_full_name": "Notification Bot",
        "timestamp": 1752250249
    },
    {
        "content": "<p>(<code>import Mathlib</code> is no longer needed, this is part of lean itself now)</p>",
        "id": 528370592,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752250261
    },
    {
        "content": "<p>The <code>-merge</code> option disables this feature:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">extract_lets</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 528400794,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752264886
    },
    {
        "content": "<p>The behavior on <code>extract_lets a b</code> isn't a bug, but the error message could be more informative. What's going on is that <code>extract_lets a</code> is sufficient due to merging, so <code>b</code> really isn't being used. (In particular, it's the name that's not being used, not that it's an unused variable.)</p>",
        "id": 528400881,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752264934
    },
    {
        "content": "<p>Perhaps a line could be added to the docstring for <code>extract_lets</code> to mention this flag.</p>",
        "id": 528406032,
        "sender_full_name": "Terence Tao",
        "timestamp": 1752267821
    },
    {
        "content": "<p>In the meantime, here are all the options: <a href=\"https://github.com/leanprover/lean4/blob/e2e36087e1ff1c29043ded4949862d5da7a8cf4a/src/Init/MetaTypes.lean#L332\">https://github.com/leanprover/lean4/blob/e2e36087e1ff1c29043ded4949862d5da7a8cf4a/src/Init/MetaTypes.lean#L332</a></p>",
        "id": 528407131,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752268439
    },
    {
        "content": "<p>This behavior is a bit surprising to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">AddSemigroup</span><span class=\"bp\">.</span><span class=\"n\">toAdd</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">extract_lets</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"c1\">-- not merged, but printed the same in the infoview</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- but they're the same!</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>I think I'd argue that <code>merge</code> should operate on a coarser relation than \"syntactically equal\"</p>",
        "id": 528407842,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752268898
    },
    {
        "content": "<p>(or not be the default, since the behavior isn't deterministic as a function of the visible state even for non-ambiguous goals)</p>",
        "id": 528408024,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752269005
    }
]