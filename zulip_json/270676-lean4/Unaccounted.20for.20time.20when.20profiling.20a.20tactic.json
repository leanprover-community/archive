[
    {
        "content": "<p>I'm trying to profile a slow tactic, but having some trouble deciphering the information from the profiler. Specifically, when I measure the time taken for the <code>theorem</code> as a whole, I get that it takes about 7.5 seconds. But, when I measure the time taken by the tactic elaborator itself, I measure only 3.5 seconds. At first, I figured this difference must be kernel checking or linters (we generate rather large proofs, so this made some sense to me). However, I then tried to disable those via options (<code>debug.skipKernelTC</code> and various options under <code>linter</code>), and saw basically no difference.</p>\n<p>Are there any other things done by the theorem elaborator after a tactic is finished that can account for the missing runtime?</p>\n<p>Here's the output of the trace profiler:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">command</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.406624</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sha512_225_instructions</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SHA512Bench</span><span class=\"w\"> </span><span class=\"mi\">225</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">intros</span>\n<span class=\"w\">      </span><span class=\"n\">sym_n</span><span class=\"w\"> </span><span class=\"mi\">225</span>\n<span class=\"w\">      </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">step</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3.263754</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">intros</span>\n<span class=\"w\">      </span><span class=\"n\">sym_n</span><span class=\"w\"> </span><span class=\"mi\">225</span>\n<span class=\"w\">      </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"kn\">def</span><span class=\"bp\">.</span><span class=\"n\">maxSharing</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.052831</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">share</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">exprs</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"kn\">def</span><span class=\"bp\">.</span><span class=\"n\">processPreDef</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.021418</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"bp\">-</span><span class=\"n\">definitions</span>\n</code></pre></div>\n<p>Notice the ~3 seconds or so unaccounted for in the trace.</p>\n<p>And for completeness, here's the full theorem with all the options I set: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"bp\">.</span><span class=\"n\">skipKernelTC</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">constructorNameAsVariable</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">missingDocs</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">omit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">suspiciousUnexpanderPatterns</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unnecessarySimpa</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedRCasesPattern</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedSectionVars</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sha512_225_instructions</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SHA512Bench</span><span class=\"w\"> </span><span class=\"mi\">225</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"n\">sym_n</span><span class=\"w\"> </span><span class=\"mi\">225</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 473150173,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1727453412
    },
    {
        "content": "<p>These \"time leaks\" are pretty annoying to find in general, they usually require doing some actual profiling with a C profiler and then adding a <code>withTraceNode</code> to the part of the compiler that is actually at  fault here.</p>",
        "id": 473151695,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727453828
    },
    {
        "content": "<p>The kernel and linters however are definitely logged when above the threshold</p>",
        "id": 473156910,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1727455167
    },
    {
        "content": "<p>After a long and painful process of putting trace nodes everywhere, I've found the culprit: metavariable instantiation.</p>\n<p>Rather confusingly, there is an <code>instantiateMVarsProfiling</code> in <code>MutualDef</code>, defined as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">instantiateMVarsProfiling</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">profileitM</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"instantiate metavars\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>\n<p>I kind of assumed the profiling here referred to the profiler whose traces I was looking at it, so I didn't put a trace class here at first. That was a mistake, somehow the <code>profileIt</code> def does not seem to actually cause it to be part of the profile</p>",
        "id": 473213941,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1727471784
    },
    {
        "content": "<p>Here's a PR that adds the relevant trace node: <a href=\"https://github.com/leanprover/lean4/pull/5501\">https://github.com/leanprover/lean4/pull/5501</a></p>",
        "id": 473216273,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1727472751
    },
    {
        "content": "<p>There is two profilers right now <code>set_option profiler true</code> which you can also access from the command line and notably C++ can also use which is controlled by <code>profileitM</code> and <code>set_option trace.profiler</code> which <code>withTraceNode</code> uses.</p>",
        "id": 473222960,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727475408
    }
]