[
    {
        "content": "<p>How does one debug deep kernel recursion? Is there an option I can set to get a stack trace or similar when it occurs?</p>",
        "id": 468273615,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725650914
    },
    {
        "content": "<p>When this happens to me, I can see the stack trace in the ouput, which in VSCode is one of the tabs next to <code>terminal</code>.</p>",
        "id": 468311733,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725667434
    },
    {
        "content": "<p>I have heard that this stack trace may possibly only be visible on Linux, not sure</p>",
        "id": 468373740,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1725697371
    },
    {
        "content": "<p>I have it on Windows :)</p>",
        "id": 468400510,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725711580
    },
    {
        "content": "<p>I see the Output tab, but alas it doesn't show anything. (I'm on an M2 MacBook Air.)</p>",
        "id": 468467027,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725738651
    },
    {
        "content": "<p>The other thing I get in the output tab are panic messages. Do you get them there?</p>",
        "id": 468470878,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725740991
    },
    {
        "content": "<p>No, they show up as popups.</p>",
        "id": 468470937,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725741011
    },
    {
        "content": "<p>For me panics and deep recursion usually show up as pop ups, and the pop up contains a link to the output tab, where I see the history of both kinds of errors</p>",
        "id": 468471121,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725741147
    },
    {
        "content": "<p>Actually the behaviour for panics has changed for me: they now appear as messages in the infoview. And it shows up with a blue squigle, instead of red so that it doesn't look like an error message :(</p>",
        "id": 468485411,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725751546
    },
    {
        "content": "<p>encountering this mystical error too, how do I see where it's coming from?</p>",
        "id": 479740117,
        "sender_full_name": "Philogy",
        "timestamp": 1730312361
    },
    {
        "content": "<p>I discovered that whether or not the stack is shown to me depends on whether the code is run in compiled or interpreted form. So I sometimes alternate between setting <code>precompileModules := true</code> for speed, and then back off to see the stack trace in a stack overflow.</p>",
        "id": 479746495,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730314785
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479746495\">said</a>:</p>\n<blockquote>\n<p>I discovered that whether or not the stack is shown to me depends on whether the code is run in compiled or interpreted form. So I sometimes alternate between setting <code>precompileModules := true</code> for speed, and then back off to see the stack trace in a stack overflow.</p>\n</blockquote>\n<p>Haven't heard of this option before, what's the syntax for toggling it?</p>",
        "id": 479747032,
        "sender_full_name": "Philogy",
        "timestamp": 1730314965
    },
    {
        "content": "<p>I just have a default <code>math</code> template <code>lake</code> project (new to Lean so still a bit unfamiliar with wider project configuration / commands)</p>",
        "id": 479750356,
        "sender_full_name": "Philogy",
        "timestamp": 1730316387
    },
    {
        "content": "<p>In the lakefile.lean, you can put it in like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">LibraryName</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add library configuration options here</span>\n</code></pre></div>\n<p>It compiles the functions in your other files when importing them. But it is off by default.</p>\n<p>However, there can be functions from other packages that give stack overflows if those other packages are compiled. Also all functions that come with Lean automatically, such as in <code>Lean</code> and <code>Std</code> namespaces are compiled.</p>",
        "id": 479750415,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730316414
    },
    {
        "content": "<p>But setting this to true won't help with debugging this.</p>",
        "id": 479750558,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730316476
    },
    {
        "content": "<p>Do you have an idea of whether the stack overflow is from on of your own functions, or a built in function?</p>",
        "id": 479750822,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730316587
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479750822\">said</a>:</p>\n<blockquote>\n<p>Do you have an idea of whether the stack overflow is from on of your own functions, or a built in function?</p>\n</blockquote>\n<p>Unsure, I have a fairly large proof but I have identified the specific line where if I comment everything from the bottom up including it and add a <code>sorry</code> it goes away. But it's a simple <code>rw [have_lemma_defined_earlier]</code> any ideas why that would cause it and not the definition use of the <code>have</code> lemma itself?</p>",
        "id": 479751230,
        "sender_full_name": "Philogy",
        "timestamp": 1730316744
    },
    {
        "content": "<p>Oh I see you get it from a tactic call, I was thinking you got it from executing some code you wrote. Can you make a minimal example of this problem?</p>",
        "id": 479751540,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730316881
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479751540\">said</a>:</p>\n<blockquote>\n<p>Oh I see you get it from a tactic call, I was thinking you got it from executing some code you wrote. Can you make a minimal example of this problem?</p>\n</blockquote>\n<p>Is this minimal enough? <a href=\"https://gist.github.com/Philogy/127f5d0e6753b6c7ed304123deb0fc04#file-basic-lean-L224\">https://gist.github.com/Philogy/127f5d0e6753b6c7ed304123deb0fc04#file-basic-lean-L224</a></p>\n<p>I've highlighted the line that makes the error disappear if it's commented out. Although the error shows on the line where my theorem is defined (L136)</p>",
        "id": 479751997,
        "sender_full_name": "Philogy",
        "timestamp": 1730317066
    },
    {
        "content": "<p>I see. Can you minimize it further? So remove all the bits that aren't relevant to the error showing up. <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>",
        "id": 479754100,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730317945
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/stream/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479750822\">said</a>:</p>\n<blockquote>\n<p>Do you have an idea of whether the stack overflow is from on of your own functions, or a built in function?</p>\n</blockquote>\n<p>The anwer to this is: a built in function, namely the implementation of <code>rw</code>. The only way to see some sort of stack trace would be to copy paste the definition of <code>rw</code> <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 479756030,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730318681
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479756030\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/stream/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479750822\">said</a>:</p>\n<blockquote>\n<p>Do you have an idea of whether the stack overflow is from on of your own functions, or a built in function?</p>\n</blockquote>\n<p>The anwer to this is: a built in function, namely the implementation of <code>rw</code>. The only way to see some sort of stack trace would be to copy paste the definition of <code>rw</code> <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n</blockquote>\n<p>Why to built in functions suppress the error like this? Currently working to minimize the example...</p>",
        "id": 479756179,
        "sender_full_name": "Philogy",
        "timestamp": 1730318754
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479754100\">said</a>:</p>\n<blockquote>\n<p>I see. Can you minimize it further? So remove all the bits that aren't relevant to the error showing up. <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>\n</blockquote>\n<p>Minimized: <a href=\"https://gist.github.com/Philogy/1e01d255732740edb19bd29ad3225ed7\">https://gist.github.com/Philogy/1e01d255732740edb19bd29ad3225ed7</a></p>",
        "id": 479756861,
        "sender_full_name": "Philogy",
        "timestamp": 1730319045
    },
    {
        "content": "<p>I got confused about where the deep recursion is happening. I thought it was in the tactic implementation, but it is in the kernel that checks the proof term. So I'm not actually  sure about that</p>",
        "id": 479757234,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319218
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479757234\">said</a>:</p>\n<blockquote>\n<p>I got confused about where the deep recursion is happening. I thought it was in the tactic implementation, but it is in the kernel that checks the proof term. So I'm not actually  sure about that</p>\n</blockquote>\n<p>Does Lean not give you some way to dump a stack trace or anything? How is one meant to debug something like this? Should I open an RFC to improve error messaging maybe?</p>",
        "id": 479757644,
        "sender_full_name": "Philogy",
        "timestamp": 1730319388
    },
    {
        "content": "<p>In your minimized example, replacing the definition of <code>m0</code> by a small number, the proof works without a deep recursion in the kernel. This means that the kernel is trying to reduce this number for some reason (reducing into a sequence of applications of <code>Nat.succ</code>.</p>",
        "id": 479757686,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319414
    },
    {
        "content": "<p>The idea in lean is that the tactics do all the hard work, and they produce a proofterm that should be easy to check for the kernel. So generally, error messages from the kernel aren't that common and also tend to not be that helpful. I think Ideally, such an error should be thrown by the tactic before the kernel gets a chance to get stuck.</p>",
        "id": 479757918,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319532
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479757686\">said</a>:</p>\n<blockquote>\n<p>In your minimized example, replacing the definition of <code>m0</code> by a small number, the proof works without a deep recursion in the kernel. This means that the kernel is trying to reduce this number for some reason (reducing into a sequence of applications of <code>Nat.succ</code>.</p>\n</blockquote>\n<p>Is this thread/fact by anyway related? <a href=\"#narrow/channel/270676-lean4/topic/Kernel.20reduction.20of.20Nat.2Esucc.20is.20more.20strict.20that.20expected/near/468136717\">https://leanprover.zulipchat.com/#narrow/channel/270676-lean4/topic/Kernel.20reduction.20of.20Nat.2Esucc.20is.20more.20strict.20that.20expected/near/468136717</a></p>",
        "id": 479757980,
        "sender_full_name": "Philogy",
        "timestamp": 1730319559
    },
    {
        "content": "<p>It seems to be.</p>",
        "id": 479758186,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319640
    },
    {
        "content": "<p>In your case, it's probably an easy fix of proving the lemmas in a more general form instead of just for this specific big natural number.</p>",
        "id": 479758291,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319688
    },
    {
        "content": "<p>By the way you can post minimal examples between triple back-ticks like this, and then it comes with a link to the web version of lean for anyone to try it quickly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"mi\">11577</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">succ_coprime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">remco_equiv_naive</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m1</span>\n\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">comp_z_chinese</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder_modEq_unique</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">succ_coprime</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">])</span>\n\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">comp_z_chinese</span>\n\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m0</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">comp_z_chinese</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 479758469,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730319762
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Debugging.20.28kernel.29.20deep.20recursion.20detected/near/479758469\">said</a>:</p>\n<blockquote>\n<p>By the way you can post minimal examples between triple back-ticks like this, and then it comes with a link to the web version of lean for anyone to try it quickly:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"mi\">11577</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">succ_coprime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">remco_equiv_naive</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m0</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m1</span>\n\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">comp_z_chinese</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder_modEq_unique</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">succ_coprime</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m1</span><span class=\"o\">])</span>\n\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">chineseRemainder'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">comp_z_chinese</span>\n\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m0</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">comp_z_chinese</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Ah yes, thanks for the note. So how lazy is Lean? If I prove this in the general case or maybe split out <code>Nat.chineseRemainder'</code> into a lemma and then put my big number as an input will it work? Or will it still try to expand things?</p>",
        "id": 479758824,
        "sender_full_name": "Philogy",
        "timestamp": 1730319909
    },
    {
        "content": "<p>I would suggest doing the problematic rewrite in a context that doesn't have access to the big number. This means proving your theorem <code>remco_equiv_naive</code> for general <code>m0</code>/<code>m1</code>, and any extra hypotheses about them that you need.</p>\n<p>I don't know if there is any better workaround.</p>",
        "id": 479759301,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730320088
    }
]