[
    {
        "content": "<p>@Mac, I was wondering if you could advise on putting a <code>lean_lib</code> in a subdirectory. Mathlib is on its way to acquiring various little \"utility\" subprojects (many of which will later be upstreamed or moved to separate repositories, but our monorepo tendencies mean they will probably start off incubating in the main repo). We already have <code>cache</code>, and there's a PR for <code>graph</code> (replacing <code>leanproject import-graph</code>).</p>\n<p>I'd like to try putting these all in a <code>Util</code> directory.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">lean_lib</span> <span class=\"n\">Cache</span> <span class=\"n\">where</span>\n  <span class=\"n\">moreLeanArgs</span> <span class=\"o\">:=</span> <span class=\"n\">moreLeanArgs</span>\n  <span class=\"n\">roots</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">`</span><span class=\"n\">Util.Cache</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_exe</span> <span class=\"n\">cache</span> <span class=\"n\">where</span>\n  <span class=\"n\">root</span> <span class=\"o\">:=</span> <span class=\"bp\">`</span><span class=\"n\">Util.Cache.Main</span>\n</code></pre></div>\n<p>is allowed, but only if I then replace all the <code>import Cache.X</code> with <code>import Util.Cache.X</code>.</p>\n<p>Is is possibly to organise these utility libraries into a subdirectory, but without changing their module names?</p>\n<p>(Saying that this is a terrible idea is also okay --- but then it would nice to have an alternative solution to these cluttering up the root directory, while staying within Mathlib.)</p>",
        "id": 373604052,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1688874388
    },
    {
        "content": "<p>What's wrong with longer <code>import</code> lines?</p>",
        "id": 373637136,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1688890553
    },
    {
        "content": "<p>Fair point. If we're going to have <code>ImportGraph</code> in addition to <code>Cache</code> soon, would everyone prefer that both be moved until <code>Util</code>? I can probably also move the unhelpfully-named <code>MathlibExtras</code>, which manages the additional caching for <code>exact?</code> and <code>rw?</code>.</p>",
        "id": 373639415,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1688891286
    },
    {
        "content": "<p>I think the better approach here would be to set the <code>src_dir</code> for the <code>lean_lib Cache</code> to <code>\"Util\"</code> instead of <code>\".\"</code>. Then you can still name the module <code>Cache</code> and lake will look in <code>Util/Cache.lean</code> for it</p>",
        "id": 373710432,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1688911299
    },
    {
        "content": "<p>(I know that this exists because I recently had cause to reimplement this logic for a <code>lake exe cache</code> rewrite)</p>",
        "id": 373710661,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1688911364
    },
    {
        "content": "<p>Okay, I've moved everything into the <code>Util</code> directory in <a href=\"https://github.com/leanprover-community/mathlib4/pull/5787\">#5787</a>.</p>",
        "id": 373800729,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1688949954
    },
    {
        "content": "<p>That PR also moves the <code>MathlibExtras</code> top-level directory (which handles the special caching infrastructure for <code>apply?</code> and <code>rw?</code>) into <code>Util</code>, and also renames it <code>TacticCaches</code>. This constitutes most of the diff, and I'm a bit worried it will introduce regressions in these special caches. I could also change the PR to just leave that stuff alone for now, hoping for a better solution later (e.g. after the new <code>cache</code>!).</p>",
        "id": 373801935,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1688950453
    }
]