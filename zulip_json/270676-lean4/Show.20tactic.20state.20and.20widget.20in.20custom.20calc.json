[
    {
        "content": "<p>The last thing Iâ€¯want to fix in verbose-lean4 before actually using it for teaching is the infoview during calculations. Verbose Lean has nice calc blocks but they donâ€™t show tactic state when editing proofs of calculation steps and they donâ€™t show Mathlibâ€™s calc widget. Iâ€™d be happy to get some help here. I tried something in <a href=\"https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean\">https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean</a> with all the <code>%$tk</code> trying to say where to put the widget in <a href=\"https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean#L88\">https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean#L88</a>. But I really donâ€™t know how to tell Lean to simply display the goal.</p>",
        "id": 493181089,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736680864
    },
    {
        "content": "<p>Hopefully the structure of that file is clear. I have some customized version of <code>calcStep</code> and <code>calcFirstStep</code> and functions to convert from the custom versions to the regular ones.</p>",
        "id": 493181176,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736680941
    },
    {
        "content": "<p>This is just a guess, but it could be that the syntax <code>tks[i]!</code> is not canonical (as explained in <a href=\"https://github.com/leanprover-community/ProofWidgets4/blob/main/ProofWidgets/Demos/Macro.lean\">this file in ProofWidgets</a>). If this is indeed the issue, I think using the <code>mkInfoCanonical</code> function defined in that file will fix it.</p>",
        "id": 493389077,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1736784530
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"303675\">@Anand Rao Tadipatri</span> sorry I didnâ€™t see your answer earlier. Thanks a lot for trying to help. Unfortunately this hint doesnâ€™t seem enough to unstuck me. Iâ€™ll try to prepare a mwe.</p>",
        "id": 493576051,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736858212
    },
    {
        "content": "<p>Besides the source info not being canonical, the issue is that the output syntax has no sane positions at all. The goal to display is determined partly based on <code>Syntax</code> positions, so it doesn't show up.</p>\n<p>We can see the broken positions by adding</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"old syntax: {stx.raw.formatStx (showInfo := true)}\"</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">calcStx</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"k\">calc</span><span class=\"bp\">%$</span><span class=\"n\">calcstx</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"new syntax: {calcStx.raw.formatStx (showInfo := true)}\"</span>\n</code></pre></div>\n<p>to the <code>elab_rule</code>. Then on the example</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">Calc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\">   </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">computation</span>\n</code></pre></div>\n<p>we see <code>[(group \"\":4083:\"by\":4085:\" \" \"\":4086:\"computation\":4097:\"\\n\\n\")]</code> in the old syntax, and</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"n\">Term.byTactic</span><span class=\"o\">:</span><span class=\"mi\">4097</span>\n<span class=\"w\">     </span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"s2\">\"by\"</span><span class=\"o\">:</span><span class=\"mi\">4097</span>\n<span class=\"w\">     </span><span class=\"o\">(</span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"n\">Tactic.tacticSeq</span><span class=\"o\">:</span><span class=\"mi\">4097</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"n\">Tactic.tacticSeq1Indented</span><span class=\"o\">:</span><span class=\"mi\">4097</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"n\">tacticWeCompute_</span><span class=\"o\">:</span><span class=\"mi\">4097</span><span class=\"w\"> </span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"s2\">\"We\"</span><span class=\"o\">:</span><span class=\"mi\">4097</span><span class=\"w\"> </span><span class=\"mi\">4051</span><span class=\"o\">:</span><span class=\"s2\">\"compute\"</span><span class=\"o\">:</span><span class=\"mi\">4097</span><span class=\"w\"> </span><span class=\"o\">[])])))</span>\n</code></pre></div>\n<p>in the new syntax. The broken positions <code>4051-4097</code> are taken from the ambient ref syntax accessible from <code>MonadRef</code>.</p>\n<p>To fix this, let's try copying the <code>by</code> position in <code>convertFirstCalcStep</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">CalcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">byTk</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">calcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">byTk</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Now the new syntax is</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"n\">Term.byTactic</span><span class=\"o\">:</span><span class=\"mi\">4109</span>\n<span class=\"w\">     </span><span class=\"mi\">4095</span><span class=\"bp\">!</span><span class=\"o\">:</span><span class=\"s2\">\"by\"</span><span class=\"o\">:</span><span class=\"mi\">4097</span>\n<span class=\"w\">     </span><span class=\"o\">(</span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"n\">Tactic.tacticSeq</span><span class=\"o\">:</span><span class=\"mi\">4109</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"n\">Tactic.tacticSeq1Indented</span><span class=\"o\">:</span><span class=\"mi\">4109</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"n\">tacticWeCompute_</span><span class=\"o\">:</span><span class=\"mi\">4109</span><span class=\"w\"> </span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"s2\">\"We\"</span><span class=\"o\">:</span><span class=\"mi\">4109</span><span class=\"w\"> </span><span class=\"mi\">4063</span><span class=\"o\">:</span><span class=\"s2\">\"compute\"</span><span class=\"o\">:</span><span class=\"mi\">4109</span><span class=\"w\"> </span><span class=\"o\">[])])))</span>\n</code></pre></div>\n<p>Here <code>!</code> indicates that <code>by</code> has canonical source info. Its exact position changed slightly because we made some edits earlier in the file, but we can see the <code>by</code> has correct positions and indeed the goal shows up when the cursor is before <code>b</code>. Unfortunately all the other positions are still nonsense, and the goal doesn't show up before <code>y</code>, for instance.</p>\n<p>Quotations pick up positions from the ambient syntax reference. So, let's try setting that when quoting pieces of subsyntax. We end up with this little monstrosity:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">CalcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">btk</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"bp\">%$</span><span class=\"n\">ctk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">byCompStx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">step.raw</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">ctk</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">byCompStx</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">btk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tacs</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pf.mkInfoCanonical</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">calcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pf</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>In the last step, we recursively make source info canonical using the code below. This is different from the ProofWidgets demo, as there only the top-level info is made canonical. I initially expected this not to be necessary, but it seems to be.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Lean.SourceInfo.mkCanonical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">synthetic</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">synthetic</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">si</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">si</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Lean.Syntax.mkInfoCanonical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">i.mkCanonical</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a.map</span><span class=\"w\"> </span><span class=\"n\">mkInfoCanonical</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">i.mkCanonical</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">i.mkCanonical</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Lean.TSyntax.mkInfoCanonical</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(âŸ¨</span><span class=\"bp\">Â·.</span><span class=\"n\">raw.mkInfoCanonical</span><span class=\"o\">âŸ©)</span>\n</code></pre></div>\n<p>With these changes, the goal state and the calc widget show up on the custom syntax. Note that the calc widget will not work very well as it produces the default <code>:= by</code> syntax which <code>Calc</code> doesn't support. Adjusting other cases of the syntax left as an exercise.</p>\n<p>As you can see, it is extremely fiddly. Perhaps parsers running in quotations should pick up better positions automatically (e.g. by determining the leading position of <code>(term| by%$btk ...)</code> from the spliced <code>by%$btk</code>), but it is not an easy fix.</p>",
        "id": 494175064,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737041459
    },
    {
        "content": "<p>Thanks you <em>very</em> much <span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span>, this is an extremely useful answer. I will study it carefully.</p>",
        "id": 494314432,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737105156
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span> Iâ€™m sure youâ€™ll find inspiration about things to document here <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 494314441,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737105160
    },
    {
        "content": "<p>Aboslutely!</p>",
        "id": 494314755,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1737105267
    },
    {
        "content": "<p>Note that <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install\">#lean4 &gt; System-wide Lean install</a>  is also full of hidden things to document.</p>",
        "id": 494315144,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737105398
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"128280\">Wojciech Nawrocki</span> <a href=\"#narrow/channel/270676-lean4/topic/Show.20tactic.20state.20and.20widget.20in.20custom.20calc/near/494175064\">said</a>:</p>\n<blockquote>\n<p>Adjusting other cases of the syntax left as an exercise.</p>\n</blockquote>\n<p>Iâ€™m making progress on this exercise but I need a bit more help when the syntax ends with repeating stuff. Where should I put the <code>%$ctk</code> in <code>`(CalcFirstStep|$t:term from%$btk $prfs and from*)</code>?</p>",
        "id": 494362019,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737120816
    },
    {
        "content": "<p>Actually I take back the first claim. I thought I was making progress but Iâ€™m not. I really donâ€™t know how to get a usable <code>ctk</code> when the last piece of syntax is not a simple word.</p>",
        "id": 494363115,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737121182
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span> note that Iâ€¯tried reading <a href=\"https://lean-lang.org/doc/reference/latest/Notations-and-Macros/Macros/#quotation\">https://lean-lang.org/doc/reference/latest/Notations-and-Macros/Macros/#quotation</a> to find how to do that token quotation exercise, but it wasnâ€™t enough for me.</p>",
        "id": 494365189,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737121821
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/Show.20tactic.20state.20and.20widget.20in.20custom.20calc/near/494363115\">said</a>:</p>\n<blockquote>\n<p>Actually I take back the first claim. I thought I was making progress but Iâ€™m not. I really donâ€™t know how to get a usable <code>ctk</code> when the last piece of syntax is not a simple word.</p>\n</blockquote>\n<p>I think there is no right answer to where you should be getting the positions from: it's up to where you want the goal to show up in your custom syntax. Note that I also ran into the issue of \"syntax is not a simple word\" in the first case: <code>by computation</code> is technically two tokens (I think). In that case, I used <code>step.raw[1]</code> to get the sub-<code>Syntax</code> with the desired positions. Can you do something similar for <code>from $prfs and from*</code>?</p>",
        "id": 494365950,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737122034
    },
    {
        "content": "<p>I think the fundamental issue is I donâ€™t understand the difference between <code>btk</code> and <code>ctk</code> in your example.</p>",
        "id": 494375095,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737124753
    },
    {
        "content": "<p>I donâ€™t see any difference if I remove <code>ctk</code> from the pattern matching and replace it with <code>btk</code> where itâ€™s used.</p>",
        "id": 494375760,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737124994
    },
    {
        "content": "<p>Does it help to look at the following debug info? You will see that different positions are copied if you replace <code>ctk</code> with <code>btk</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">CalcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">btk</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"bp\">%$</span><span class=\"n\">ctk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">byCompStx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">step.raw</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">ctk</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">compute</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">byCompStx</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"bp\">%$</span><span class=\"n\">btk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tacs</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pf.mkInfoCanonical</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"orig: {byCompStx.formatStx (showInfo := true)}\"</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"pf: {pf.raw.formatStx (showInfo := true)}\"</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">calcFirstStep</span><span class=\"bp\">|$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pf</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 494380978,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737126561
    },
    {
        "content": "<p>I understand those are different positions of course. What I donâ€™t understand is the impact on the displayed tactic state and displayed widgets.</p>",
        "id": 494385717,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737127992
    },
    {
        "content": "<p>Bearing in mind I haven't looked at the infotree code recently so this may not be entirely accurate, it's like this: </p>\n<ul>\n<li>The language server decides which goal to display at a position P by searching the infotree for TacticInfo nodes at position P.</li>\n<li>TacticInfo nodes don't store a position but rather a piece of syntax. So what it means for a TacticInfo to be \"at P\" is roughly that its associated syntax contains P within its span.</li>\n<li>When it's evaluated, a tactic stores a TacticInfo node with the syntax that caused the tactic to run.</li>\n</ul>\n<p>So overall, if you produce (the syntax of) a tactic script wherein one tactic has incorrect positions, its pre/post goal state will appear at that incorrect position or not at all.</p>",
        "id": 494398016,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737131819
    },
    {
        "content": "<p>I understand the general idea, I was asking specifically how the difference between btk and ctk in this example mattered. But really this isnâ€™t so important. I think Iâ€™m really unstuck here. Thank you very much for your help.</p>",
        "id": 494403616,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737133759
    },
    {
        "content": "<p>I think if you use btk instead of ctk, the no-goals post-state coming from 'We compute' will appear on the 'by'; or something similarly broken (that's what I observed)</p>",
        "id": 494403872,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737133850
    }
]