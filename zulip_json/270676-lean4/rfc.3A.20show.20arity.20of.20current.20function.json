[
    {
        "content": "<p>One thing that could make code-writing more convenient would be a way to show the arity of the current function, because functions in Mathlib often has 10+ typeclasses and 3+ implicit arguments, which makes it hard to count how many underscores I need to apply.</p>\n<p>Consider the following mini-example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">h₁</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h₂</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>Right now, Lean already has a very helpful feature, where if you put the cursor at the end of <code>foo</code> in Line 6, wait a while, and then press space, then it shows you all the (remaining) arguments of the current function:</p>\n<p><a href=\"/user_uploads/3121/ZlIMb6dMgcgmZonupwXs6RQ8/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ZlIMb6dMgcgmZonupwXs6RQ8/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"637x102\" src=\"/user_uploads/thumbnail/3121/ZlIMb6dMgcgmZonupwXs6RQ8/image.png/840x560.webp\"></a></div><p>so maybe a way to implement my suggestion would be just to use that existing window, but add a newline at the bottom with the text \"2 explicit arguments remaining\".</p>",
        "id": 543677411,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759908806
    },
    {
        "content": "<p>I think graying out the Implicit arguments would go a long way here</p>",
        "id": 543700817,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759915967
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543700817\">said</a>:</p>\n<blockquote>\n<p>I think graying out the Implicit arguments would go a long way here</p>\n</blockquote>\n<p>This is not supported by either the signature help request in LSP or the VS Code API. I'd also prefer not to make this popup any larger than it needs to be by adding another line to it since it will then also cover more code.</p>\n<p>I think a decent improvement would be to highlight the first explicit argument instead, which is supported by the protocol. Since the delaborator and the pretty-printer currently don't retain any of this position information, we'd have to delaborate the implicit prefix, the first explicit argument and everything after that separately and then join the outputs.</p>",
        "id": 543728826,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1759924800
    },
    {
        "content": "<p>What's the mechanism to do the highlighting?</p>",
        "id": 543736571,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759926946
    },
    {
        "content": "<p><a href=\"https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#signatureInformation\">SignatureInformation.activeParameter</a></p>",
        "id": 543737042,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1759927076
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/26221\">#26221</a>, Patrick and I got Kyle Miller to write a version of '#check` that only shows explicit arguments. Would this solve your need?</p>",
        "id": 543764076,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1759933977
    },
    {
        "content": "<p>(I share your pain of counting the remaining arguments, particularly in differential geometry, where a declaration easily has 10 arguments, but at most 2 or 3 explicit ones.)</p>",
        "id": 543764197,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1759934009
    },
    {
        "content": "<p>well i would still have to copy it and then #check it outside as i can't #check in the middle of a sentence</p>",
        "id": 543764450,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759934081
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 543764780,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1759934170
    },
    {
        "content": "<p>Given there's a #check tactic (i.e., works in the middle of a proof), <code>#check'</code> could also become one.</p>",
        "id": 543766350,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1759934549
    },
    {
        "content": "<p>maybe we'll need a <code>check%</code> in the middle of a term</p>",
        "id": 543766483,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759934578
    },
    {
        "content": "<p>like unironically</p>",
        "id": 543766522,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759934585
    },
    {
        "content": "<p>Is using Code Lens a possibility here to consider? Maybe having an optional separate code lens which says the arity?</p>",
        "id": 543767777,
        "sender_full_name": "Julian Berman",
        "timestamp": 1759934854
    },
    {
        "content": "<p>what's a code lens?</p>",
        "id": 543767871,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759934876
    },
    {
        "content": "<p>I think the ones you see in VSCode today are related to git information, but here's a googled old list of few examples (from other languages clearly) <a href=\"https://code.visualstudio.com/blogs/2017/02/12/code-lens-roundup\">https://code.visualstudio.com/blogs/2017/02/12/code-lens-roundup</a></p>",
        "id": 543768280,
        "sender_full_name": "Julian Berman",
        "timestamp": 1759934959
    },
    {
        "content": "<p>what if when we right click on an identifier of a decl it just shows \"function arity: 4\"?</p>",
        "id": 543768678,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935057
    },
    {
        "content": "<p>as in, above the whole menu</p>",
        "id": 543768703,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935062
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/tQc0gsJPAfbG4ZP-42ZTiJkZ/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/tQc0gsJPAfbG4ZP-42ZTiJkZ/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"528x372\" src=\"/user_uploads/thumbnail/3121/tQc0gsJPAfbG4ZP-42ZTiJkZ/image.png/840x560.webp\"></a></div>",
        "id": 543768765,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935076
    },
    {
        "content": "<p>above the \"Go to Definition\"</p>",
        "id": 543768796,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935084
    },
    {
        "content": "<p>also, maybe formatting is not supported in the \"space info\", but it's supported in the hover info right</p>",
        "id": 543768963,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935126
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/Wqe0ijNBD0SdjM1VfY6FQe55/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Wqe0ijNBD0SdjM1VfY6FQe55/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"948x145\" src=\"/user_uploads/thumbnail/3121/Wqe0ijNBD0SdjM1VfY6FQe55/image.png/840x560.webp\"></a></div>",
        "id": 543769006,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935136
    },
    {
        "content": "<p>since I see blue colour here</p>",
        "id": 543769041,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935143
    },
    {
        "content": "<p>can we make the implicit arguments gray here?</p>",
        "id": 543769061,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935149
    },
    {
        "content": "<p>related: <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/rfc.3A.20on.20hover.2C.20show.20the.20type.20before.20the.20error/with/543769866\">#lean4 &gt; rfc: on hover, show the type before the error</a></p>",
        "id": 543769924,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759935337
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543769061\">said</a>:</p>\n<blockquote>\n<p>can we make the implicit arguments gray here?</p>\n</blockquote>\n<p>We serve the types in hovers as a markdown code block with language ID <code>lean</code>, the highlighting for which is provided by the Lean 4 VS Code extension TextMate grammar. <br>\nIf you want implicit parameters to be highlighted differently in hovers, you have to define a custom TextMate grammar that parses arbitrary Lean pretty-printer output, identifies implicit arguments in a way that doesn't lead to false-positives with other notation using <code>{}</code> or <code>[]</code>, contribute that to the VS Code extension with a custom language ID and then change the hovers provided by the language server to produce markdown code blocks with the new language ID. When the pretty-printer changes in a new Lean version, you will then also likely have to update the client-side TextMate grammar.</p>\n<p>TextMate grammars are absolutely horrible to maintain as they are just bundles of unreadable regexes, so I don't think this is really worth the initial effort or the maintenance burden.</p>",
        "id": 543778791,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1759937545
    },
    {
        "content": "<p>I see, that's another unfortunate situation.</p>",
        "id": 543779831,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759937840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543778791\">said</a>:</p>\n<blockquote>\n<p>identifies implicit arguments in a way that doesn't lead to false-positives with other notation using <code>{}</code> or <code>[]</code></p>\n</blockquote>\n<p>We essentially had this in Lean 3, but <a href=\"https://github.com/eric-wieser/vscode-lean/commit/32dad8605530eb082cebc6b76681aca47975e2ae\">it was reverted</a>, I think due to false positives for things like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"s2\">\"oops)\"</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 543794401,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759942297
    },
    {
        "content": "<p>We'd also need a textmate <em>scope</em> to attach to the implicit arguments, and one doesn't immediately spring to mind</p>",
        "id": 543794705,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759942403
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543778791\">said</a>:</p>\n<blockquote>\n<p>We serve the types in hovers as a markdown code block with language ID <code>lean</code>, the highlighting for which is provided by the Lean 4 VS Code extension TextMate grammar.</p>\n</blockquote>\n<p>can this be changed?</p>",
        "id": 543794974,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759942507
    },
    {
        "content": "<p>for example, can we have two code blocks?</p>",
        "id": 543795008,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759942518
    },
    {
        "content": "<p>What would the two blocks show?</p>",
        "id": 543795245,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759942609
    },
    {
        "content": "<p>it was a hypothetical question, I wanted to know what can be customised, because that response made it sound like it was not tweakable at all</p>",
        "id": 543795319,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759942638
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543794401\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543778791\">said</a>:</p>\n<blockquote>\n<p>identifies implicit arguments in a way that doesn't lead to false-positives with other notation using <code>{}</code> or <code>[]</code></p>\n</blockquote>\n<p>We essentially had this in Lean 3, but <a href=\"https://github.com/eric-wieser/vscode-lean/commit/32dad8605530eb082cebc6b76681aca47975e2ae\">it was reverted</a>, I think due to false positives for things like</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"s2\">\"oops)\"</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>There's another trick that I know of that could be used to get a more maintainable solution to at least part of this problem: while LSP itself only supports Markdown hovers, VS Code also allows rendering a <a href=\"https://github.com/microsoft/vscode/blob/43305ef182fcbda4ffe022da5b87c49c5b38d0a5/src/vs/base/browser/domSanitize.ts#L14\">safe subset of HTML tags</a> in the Markdown hover you provide if you set a specific flag (e.g. as in <a href=\"#narrow/channel/113488-general/topic/Showing.20two.20doc-string/near/479883666\">this</a> experiment). </p>\n<p>The language server could then define a generic and simple non-HTML format for tagging implicit parameters in the Markdown it produces, which we'd then parse in the language client middleware and convert to HTML that styles implicit parameters accordingly. AFAICT, <a href=\"https://github.com/microsoft/vscode/blob/43305ef182fcbda4ffe022da5b87c49c5b38d0a5/src/vs/base/browser/markdownRenderer.ts#L495\">these HTML tags also have access to VS Code's theme CSS variables</a>, so the styling could be consistent with the current theme. <br>\nAll of this would have to be locked behind a client capability so that clients that don't support parsing this extended Markdown syntax still get the regular Markdown hovers.</p>\n<p>The downside of this is that VS Code obviously won't render the HTML in Markdown code blocks, so while you gain the implicit parameter highlighting, you lose all highlighting that VS Code provides via our TextMate grammar for Lean. We'd have to re-implement much of the highlighting from this grammar in a custom semantic highlighting language for hovers to adequately replace the current implementation. Perhaps this will be the way to go at some point, but I'd need a few more good reasons than just implicit parameter highlighting for it to be worth it :-)</p>",
        "id": 543815499,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1759949993
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/rfc.3A.20show.20arity.20of.20current.20function/near/543815499\">said</a>:</p>\n<blockquote>\n<p>I'd need a few more good reasons</p>\n</blockquote>\n<p>May I present to you these reasons:</p>\n<p><a href=\"/user_uploads/3121/r7ZVLsFeLCMbwMH_7XKnaY3q/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/r7ZVLsFeLCMbwMH_7XKnaY3q/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"836x247\" src=\"/user_uploads/thumbnail/3121/r7ZVLsFeLCMbwMH_7XKnaY3q/image.png/840x560.webp\"></a></div>",
        "id": 543815907,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759950150
    },
    {
        "content": "<p>I don't understand the relevence of that screenshot; did you mean to capture the hover?</p>",
        "id": 543818580,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759951179
    },
    {
        "content": "<p>I meant, look at all these wonderful colours we can have</p>",
        "id": 543819525,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759951552
    },
    {
        "content": "<p>so colourful</p>",
        "id": 543819694,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759951609
    },
    {
        "content": "<p>but is all this really gonna show up in hover info</p>",
        "id": 543819741,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759951624
    },
    {
        "content": "<p>well if it shows up here then i take it to mean that the infrastructure already exists? i also kinda know (or at least i think) that these colours are in part server-generated and not based on grammar</p>",
        "id": 543819894,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759951682
    },
    {
        "content": "<p>Unfortunately the highlighting is a hybrid of those two systems, and vscode provides no API to execute the textmate system.</p>",
        "id": 543837316,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759958700
    },
    {
        "content": "<p>if it looks like monospace font and has spaces in the right places then it is a highlighted code(?)</p>",
        "id": 543837834,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759958950
    }
]