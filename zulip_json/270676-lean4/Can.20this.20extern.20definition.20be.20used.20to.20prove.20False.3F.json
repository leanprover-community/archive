[
    {
        "content": "<p>I'm currently using this definition in some personal projects but I always mark it <code>unsafe</code> (which is fine for my purposes) but I realized I could make it into a plain safe definition with no harm to my code. Is there potential harm in marking it safe?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Returns the first input but forces the compiler to evaluate the second input. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">never_extract</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"w\"> </span><span class=\"s2\">\"#3\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withEffects</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">withEffects_def</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">withEffects</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>The idea is that <code>withEffects</code> forces the compiler to evaluate <code>b</code> and then returns <code>a</code> unchanged, this is because the compiler doesn't know <code>b</code> isn't used because of the <code>extern</code> so it thinks <code>a</code> might be changed. (This is true if evaluating <code>b</code> has effects on <code>a</code>, as is possible in unsafe code.) When pressed, the kernel doesn't care much, it thinks that <code>withEffects a</code> is just <code>a</code>. The weird thing is that the kernel is correct: <code>withEffects a</code> is really just <code>a</code>!</p>\n<p>Can <code>withEffects</code> be used in nefarious ways to make the kernel prove <code>False</code>?</p>",
        "id": 565578734,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1766939718
    },
    {
        "content": "<p>Part of me says no because, in a safe context, <code>b</code> is pure and can't actually have effects so forcing evaluation is meaningless. But I'm still skeptical...</p>",
        "id": 565579147,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1766940398
    },
    {
        "content": "<p>When you talk about the kernel being able to prove <code>False</code>, do you mean using <code>native_decide</code> or similar?  Because if you mean with just the usual three axioms, that would be really bad, right?</p>",
        "id": 565579997,
        "sender_full_name": "Jason Rute",
        "timestamp": 1766941570
    },
    {
        "content": "<p>And hence seems very doubtful this would be a soundness issue, right?</p>",
        "id": 565580007,
        "sender_full_name": "Jason Rute",
        "timestamp": 1766941605
    },
    {
        "content": "<p>Using <code>native_decide</code> or similar would be necessary here since it's about an <code>extern</code> definition. These are invisible to the kernel without such trickery.</p>",
        "id": 565580153,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1766941866
    },
    {
        "content": "<p>I'm probably misunderstanding, but if this is external, doesn't that already allow it to prove <code>False</code> (again, using <code>native_decide</code> which we already know is unsound)?  Just give an external implementation which doesn't match the Lean definition, right?</p>",
        "id": 565580454,
        "sender_full_name": "Jason Rute",
        "timestamp": 1766942388
    },
    {
        "content": "<p>Oh I see.  <code>extern c inline \"#3\"</code> doesn't associate this function with another (arbitrary) external function, but somehow converts it into an external C function.</p>",
        "id": 565580748,
        "sender_full_name": "Jason Rute",
        "timestamp": 1766942826
    },
    {
        "content": "<p>Yes, the <code>extern c inline \"#3\"</code> just makes the compiler spit out <code>a</code> but the compiler can't inspect this extern so it assumes that <code>b</code> (the effect) is actually used even though the result is just <code>a</code>.</p>",
        "id": 565581322,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1766943606
    },
    {
        "content": "<p>I'm pretty sure your definition is <em>effectively</em> equivalent to the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">never_extract</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">noinline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withEffects</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">destruct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">noinline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"n\">destruct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">withEffects_def</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">withEffects</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>A regular non-unsafe definition shouldn't have any soundness concerns so anything equivalent to it should not be much different.</p>",
        "id": 565716684,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767039183
    }
]