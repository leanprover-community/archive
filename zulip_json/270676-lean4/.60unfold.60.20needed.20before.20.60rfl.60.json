[
    {
        "content": "<p>This is probably some confusion on my part about definitional equality. It seems like I can't \"see\" through matches, which is kind of annoying.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ex1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">q</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negSucc</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span>\n<span class=\"w\">    </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">--These don't work:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- rfl</span>\n<span class=\"w\">  </span><span class=\"c1\">-- exact rfl</span>\n\n<span class=\"w\">  </span><span class=\"c1\">--But these should only change things up to definitional equality:</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span><span class=\"w\"> </span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">ex1</span><span class=\"bp\">.</span><span class=\"n\">match_1</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span><span class=\"bp\">.</span><span class=\"n\">match_1</span>\n<span class=\"w\">  </span><span class=\"c1\">--Now it works!</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">--Okay, maybe that was just because we had a match statement in the theorem,</span>\n<span class=\"c1\">-- which is kind of silly. But how about this:</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ex2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">--rfl and exact rfl don't work here</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span><span class=\"w\"> </span><span class=\"n\">npowRec</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span><span class=\"bp\">.</span><span class=\"n\">match_1</span>\n<span class=\"w\">  </span><span class=\"c1\">--Now it works!</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 502821695,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1740891396
    },
    {
        "content": "<p>I would like to be able to turn <code>q ^ z</code> into <code>z.casesOn _ _</code>, which is(?) a definitional equality, but it seems that the process can't see the contents of <code>zpowRec.match_1</code>. And I can't do, say, <code>local attribute [reducible] zpowRec.match_1</code>, that doesn't work.</p>",
        "id": 502821755,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1740891472
    },
    {
        "content": "<p>Even <code>with_unfolding_all rfl</code> doesn't work,  which is surprising. If it helps for your use case <code>cases z &lt;;&gt; rfl</code> works here</p>",
        "id": 502822330,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1740891793
    },
    {
        "content": "<p>Yeah, I see now that once z has is distinctly in one case or the other, then the match seems to go through definitional equality. Works for what I need, but still weird, I'd like to understand it better.</p>",
        "id": 502823067,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1740892417
    },
    {
        "content": "<p>Looks like <code>set_option smartUnfolding false in rfl</code> works here</p>",
        "id": 502825789,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740894745
    },
    {
        "content": "<p>(There are some previous zulip messages if you search for <code>smartUnfolding</code> that are mostly me saying \"looks like <code>smartUnfolding</code> got in the way here\". I didn't check if there's more explanation in those threads.)</p>",
        "id": 502825862,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740894827
    },
    {
        "content": "<p>I see Lean now has a <code>rfl'</code> tactic that's a macro for <code>set_option smartUnfolding false in with_unfolding_all rfl</code></p>",
        "id": 502826110,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740895010
    },
    {
        "content": "<p>This is about rfl the tactic though, right? What about <code>rfl</code> the term? That's just, trying to trigger unification, right? So this is really a question about how the Lean kernel unifies?</p>",
        "id": 502827799,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1740896462
    },
    {
        "content": "<p>You can check that <code>set_option smartUnfolding false in exact rfl</code> works too</p>",
        "id": 502828019,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740896690
    },
    {
        "content": "<p>(This is a feature of the elaborator's defeq/whnf by the way, not a kernel feature.)</p>",
        "id": 502828077,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740896741
    }
]