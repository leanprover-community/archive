[
    {
        "content": "<p>The new string API is surely great... but it broke an in-progress linter in mathlib. Can somebody help me fix this (or tell me everything that's wrong with the code below)? A pointer to the right place in the docs would already help.</p>\n<p>Here's the minimised code: we check if a string has the shape we want, and if not log an error at a particular place. The previous code used a fair number of by-hand manipulation of ranges, which breaks. Help with the proper way is appreciated!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"c1\">-- placeholder; the actual function is Mathlib.Linter.copyrightHeaderChecks</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">stub</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">copyright</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#check_copyright \"</span><span class=\"w\"> </span><span class=\"n\">copStx</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">copStx</span><span class=\"bp\">.</span><span class=\"n\">getString</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">copStx</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"c1\">-- this addition breaks</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">stub</span><span class=\"w\"> </span><span class=\"n\">cop</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"o\">}))</span><span class=\"w\"> </span><span class=\"c1\">-- this line also breaks</span>\n<span class=\"w\">        </span><span class=\"n\">m!</span><span class=\"s2\">\"Text: `&lt;placeholder&gt;`</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">           Range: {(rg.start, rg.stop)}</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">           Message: `&lt;placeholder&gt;`\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check_copyright</span><span class=\"w\"> </span><span class=\"s2\">\"Foo\"</span><span class=\"w\"> </span><span class=\"c1\">-- fails now, with an error `elaboration function for `«command#check_copyright_»` has not been implemented`</span>\n</code></pre></div>",
        "id": 553610942,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762262219
    },
    {
        "content": "<p>(I'm not the original author, but would like to help getting it merged.)</p>",
        "id": 553611098,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762262260
    },
    {
        "content": "<p>Use <code>.increaseBy 1</code> instead of <code> + ⟨1⟩</code> and <code>.offsetBy offset</code> instead of <code> + offset</code>.</p>",
        "id": 553617487,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1762264018
    },
    {
        "content": "<p>Thanks a lot!</p>",
        "id": 553631560,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762267095
    }
]