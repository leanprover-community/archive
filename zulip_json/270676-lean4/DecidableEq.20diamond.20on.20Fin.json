[
    {
        "content": "<p>I have discovered that Mathlib's <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instLinearOrder#doc\">docs#Fin.instLinearOrder</a> induces a diamond for <code>DecidableEq (Fin n)</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqFin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">instDecidableEq_mathlib</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 459949349,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723414584
    },
    {
        "content": "<p>This is due to the <code>LinearOrder (Fin n)</code> instance being defined through <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder.liftWithOrd#doc\">docs#LinearOrder.liftWithOrd</a>, which itself uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=decidable_of_iff#doc\">docs#decidable_of_iff</a></p>",
        "id": 459949374,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723414638
    },
    {
        "content": "<p>... and this is the obvious thing to be doing: We want to prove <code>Decidable (x ≤ y)</code> from <code>Decidable (↑x ≤ ↑y)</code> by \"rewriting\" using <code>decidable_of_iff</code>. In particular, I don't think that we should change <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instLinearOrder#doc\">docs#Fin.instLinearOrder</a> .</p>",
        "id": 459949493,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723414749
    },
    {
        "content": "<p>Hence, even though the problem is created by Mathlib, it eventually boils down to two core constructs, namely <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instDecidableEqFin#doc\">docs#instDecidableEqFin</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=decidable_of_iff#doc\">docs#decidable_of_iff</a>, being defined in incompatible ways.</p>",
        "id": 459949577,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723414817
    },
    {
        "content": "<p>Would people be happy with a PR redefining <code>instDecidableEqFin</code> using <code>decidable_of_iff</code>?</p>",
        "id": 459949604,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723414858
    },
    {
        "content": "<p>... and here is the Mathlib-free MWE that the above Mathlib-full MWE boils down to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqFin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">decidable_of_iff</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val_inj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 459950401,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723415196
    },
    {
        "content": "<p>I suspect there is going to be a bootstrapping issue here: <code>instDecidableEqFin</code> is in <code>Init.Prelude</code>, and I think is needed immediately.</p>",
        "id": 459955368,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723418327
    },
    {
        "content": "<p>I did notice that, but <code>decidable_of_iff</code> doesn't really depend on anything either, right?</p>",
        "id": 459995768,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723438427
    },
    {
        "content": "<p>I guess so! Happy to take a look if you want to make a draft PR to this effect.</p>",
        "id": 460058636,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723460857
    },
    {
        "content": "<p>I am trying to write the PR as we speak, but I am discovering that I don't even know how to get the Lean server started on the lean4 repo! I get the following error (on Windows, if relevant):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">downloading</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lean'</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"n\">nonexistent</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"ss\">`lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">releases</span><span class=\"bp\">/</span><span class=\"n\">expanded_assets</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0'</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">⋃</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">unsuccessful</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">404</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">(</span><span class=\"n\">Download</span><span class=\"o\">(</span><span class=\"n\">HttpStatus</span><span class=\"o\">(</span><span class=\"mi\">404</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">next_error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InternalBacktrace</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">})</span>\n</code></pre></div>",
        "id": 460071399,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723465278
    },
    {
        "content": "<p><code>elan toolchain link lean4-stage0 build/release/stage0</code> assuming you have already built things</p>",
        "id": 460071633,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723465360
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/460071633\">said</a>:</p>\n<blockquote>\n<p>assuming you have already built things</p>\n</blockquote>\n<p>What \"things\"?</p>",
        "id": 460071692,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723465386
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/459949493\">said</a>:</p>\n<blockquote>\n<p>In particular, I don't think that we should change <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instLinearOrder#doc\">docs#Fin.instLinearOrder</a> .</p>\n</blockquote>\n<p>I don't really agree with this; I think changing the instance would be fine (but so is your approach)</p>",
        "id": 460071748,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723465409
    },
    {
        "content": "<p><code>stage0</code> and <code>stage1</code> -- I'll find the link</p>",
        "id": 460071774,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723465420
    },
    {
        "content": "<p><a href=\"https://lean-lang.org/lean4/doc/make/index.html#generic-build-instructions\">https://lean-lang.org/lean4/doc/make/index.html#generic-build-instructions</a></p>",
        "id": 460071977,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723465474
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/460071692\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/460071633\">said</a>:</p>\n<blockquote>\n<p>assuming you have already built things</p>\n</blockquote>\n<p>What \"things\"?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n<span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../..</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"bp\">../..</span>\n<span class=\"n\">make</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">j32</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n</code></pre></div>\n<p>(only the last line necessary on subsequent runs)</p>",
        "id": 461993632,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723513310
    },
    {
        "content": "<blockquote>\n<p><code>-j32</code></p>\n</blockquote>\n<p><span aria-label=\"dollar bills\" class=\"emoji emoji-1f4b5\" role=\"img\" title=\"dollar bills\">:dollar_bills:</span></p>",
        "id": 462002071,
        "sender_full_name": "Julian Berman",
        "timestamp": 1723516679
    },
    {
        "content": "<p>Hmm, </p>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/460071977\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://lean-lang.org/lean4/doc/make/index.html#generic-build-instructions\">https://lean-lang.org/lean4/doc/make/index.html#generic-build-instructions</a></p>\n</blockquote>\n<p>Doing this I'm stuck on installing libuv</p>",
        "id": 462048992,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723536988
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/461993632\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n<span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../..</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"bp\">../..</span>\n<span class=\"n\">make</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">j32</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Doing this too</p>",
        "id": 462049089,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723537035
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/462048992\">said</a>:</p>\n<blockquote>\n<p>Doing this I'm stuck on installing libuv</p>\n</blockquote>\n<p>Stuck in what way?</p>",
        "id": 462050828,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1723537648
    },
    {
        "content": "<p>I don't know what instructions to follow</p>",
        "id": 462050935,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723537685
    },
    {
        "content": "<p>Which operating system are you using?</p>",
        "id": 462050989,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1723537706
    },
    {
        "content": "<p>I'm on gitpod, so Ubuntu</p>",
        "id": 462051167,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723537793
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/DecidableEq.20diamond.20on.20Fin/near/462051167\">said</a>:</p>\n<blockquote>\n<p>I'm on gitpod, so Ubuntu</p>\n</blockquote>\n<p>The instructions here give the right packages to install: <a href=\"https://lean-lang.org/lean4/doc/make/ubuntu.html\">https://lean-lang.org/lean4/doc/make/ubuntu.html</a></p>",
        "id": 462051363,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723537848
    },
    {
        "content": "<p>For posterity, this was fixed by <a href=\"https://github.com/leanprover-community/mathlib4/pull/29436\">#29436</a>.</p>",
        "id": 544855571,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1760487314
    }
]