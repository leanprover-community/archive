[
    {
        "content": "<p>After updating to Mac OS 15.4.1, we've been hitting some linking issues that look like this (on Lean v4.19.0):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">7</span>/23<span class=\"o\">]</span><span class=\"w\"> </span>Building<span class=\"w\"> </span>cvc5.Init\ntrace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib/lean<span class=\"w\"> </span>/Users/dranov/.elan/toolchains/leanprover--lean4---v4.19.0/bin/lean<span class=\"w\"> </span>././././cvc5/Init.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/lean/cvc5/Init.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/lean/cvc5/Init.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/cvc5/Init.c<span class=\"w\"> </span>--load-dynlib<span class=\"w\"> </span>././.lake/build/lib/libffi.dylib<span class=\"w\"> </span>--json\ninfo:<span class=\"w\"> </span>stderr:\nlibc++abi:<span class=\"w\"> </span>terminating<span class=\"w\"> </span>due<span class=\"w\"> </span>to<span class=\"w\"> </span>uncaught<span class=\"w\"> </span>exception<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>lean::exception:<span class=\"w\"> </span>error<span class=\"w\"> </span>loading<span class=\"w\"> </span>library,<span class=\"w\"> </span>dlopen<span class=\"o\">(</span>././.lake/build/lib/libffi.dylib,<span class=\"w\"> </span>0x0009<span class=\"o\">)</span>:<span class=\"w\"> </span>tried:<span class=\"w\"> </span><span class=\"s1\">'././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/System/Volumes/Preboot/Cryptexes/OS././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>no<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/Users/dranov/.elan/toolchains/leanprover--lean4---v4.19.0/lib/././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>no<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/Users/dranov/.elan/toolchains/leanprover--lean4---v4.19.0/lib/lean/././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>no<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/usr/lib/././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>no<span class=\"w\"> </span>such<span class=\"w\"> </span>file,<span class=\"w\"> </span>not<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>dyld<span class=\"w\"> </span>cache<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'././.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/Users/dranov/src/lean-cvc5/.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/System/Volumes/Preboot/Cryptexes/OS/Users/dranov/src/lean-cvc5/.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>no<span class=\"w\"> </span>such<span class=\"w\"> </span>file<span class=\"o\">)</span>,<span class=\"w\"> </span><span class=\"s1\">'/Users/dranov/src/lean-cvc5/.lake/build/lib/libffi.dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag<span class=\"o\">)</span>\n</code></pre></div>\n<p>The key part being <code>(__DATA_CONST segment missing SG_READ_ONLY flag)</code>.</p>\n<p>After updating to Lean v.4.20.0-rc2, we get errors that look like this:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">7</span>/23<span class=\"o\">]</span><span class=\"w\"> </span>Building<span class=\"w\"> </span>cvc5.Init\ntrace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>/Users/dranov/src/lean-cvc5/.lake/build/lib/lean<span class=\"w\"> </span>/Users/dranov/.elan/toolchains/leanprover--lean4---v4.20.0-rc2/bin/lean<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5/cvc5/Init.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5<span class=\"w\"> </span>-o<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5/.lake/build/lib/lean/cvc5/Init.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5/.lake/build/lib/lean/cvc5/Init.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5/.lake/build/ir/cvc5/Init.c<span class=\"w\"> </span>--load-dynlib<span class=\"w\"> </span>/Users/dranov/src/lean-cvc5/.lake/build/lib/libffi.dylib<span class=\"w\"> </span>--json\ninfo:<span class=\"w\"> </span>stderr:\nlibc++abi:<span class=\"w\"> </span>terminating<span class=\"w\"> </span>due<span class=\"w\"> </span>to<span class=\"w\"> </span>uncaught<span class=\"w\"> </span>exception<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>lean::exception:<span class=\"w\"> </span>error<span class=\"w\"> </span>loading<span class=\"w\"> </span>library,<span class=\"w\"> </span>dlopen<span class=\"o\">(</span>/Users/dranov/src/lean-cvc5/.lake/build/lib/libffi.dylib,<span class=\"w\"> </span>0x0009<span class=\"o\">)</span>:<span class=\"w\"> </span>symbol<span class=\"w\"> </span>not<span class=\"w\"> </span>found<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>flat<span class=\"w\"> </span>namespace<span class=\"w\"> </span><span class=\"s1\">'_except_err'</span>\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">134</span>\n</code></pre></div>\n<p>The key part being <code>symbol not found in flat namespace '_except_err'</code>. This seems to suggest that <code>libffi</code> is not properly (dynamically) linked with Lean, but I'm having a very hard time debugging this.</p>\n<p>You can clone branch <a href=\"https://github.com/dranov/lean-cvc5/tree/bump-v4.20.0-rc2\"><code>bump-v4.20.0-rc2</code></a> here, run <code>lake run init</code>, and then <code>lake build</code> to see the error.</p>\n<p>Any idea what might be going on and how to fix it? Any help is greatly appreciated!</p>",
        "id": 516163745,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746442526
    },
    {
        "content": "<p>I'm facing the same problem with lean-egg.</p>",
        "id": 516164985,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1746442950
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span> and <span class=\"user-mention\" data-user-id=\"372804\">@Marcus Rossel</span> could you please try using the toolchain<br>\nleanprover/lean4-pr-releases:pr-release-8228?</p>",
        "id": 516177624,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746446646
    },
    {
        "content": "<p>also -- could you specify which OS you are seeing this on?</p>",
        "id": 516177821,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746446697
    },
    {
        "content": "<p>(deleting, trying to reproduce on a machine without basic things installed...)</p>",
        "id": 516178183,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746446785
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"372804\">@Marcus Rossel</span>, if you have a branch on which you've tried updating to <code>v4.20.0-rc2</code>, could you post that so we can take a look? Just updating the toolchain on <code>main</code> hits many errors before anything looking like the above (e.g. starting with <code>error: /home/kim/lean-egg/Lean/Egg/Tactic/Tags.lean:2:17: unknown constant 'Lean.HashMap'</code>).</p>",
        "id": 516179769,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746447242
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>%<span class=\"w\"> </span>sw_vers<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>xcode-select<span class=\"w\"> </span>-v\nProductName:<span class=\"w\">        </span>macOS\nProductVersion:<span class=\"w\">     </span><span class=\"m\">15</span>.4.1\nBuildVersion:<span class=\"w\">       </span>24E263\nxcode-select<span class=\"w\"> </span>version<span class=\"w\"> </span><span class=\"m\">2409</span>.\n</code></pre></div>\n<p>I'm seeing the same error (<code>symbol not found in flat namespace</code>) with <code>leanprover/lean4-pr-releases:pr-release-8228</code>.</p>",
        "id": 516180001,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746447328
    },
    {
        "content": "<p>Unfortunately, any Linux fix isn't going to affect macos due to the very different way that macos handles dynamic linking</p>",
        "id": 516184001,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1746448500
    },
    {
        "content": "<p>What does <code>otool -l .lake/build/lib/libffi.dylib</code> give?</p>",
        "id": 516185383,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1746448898
    },
    {
        "content": "<p>The symbol is indeed listed as undefined there but it is not used by Lean at all... so I'm thinking this is a symbol in a system lib we're missing</p>",
        "id": 516185767,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746449013
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I think it's supposed to be a Lean symbol: <a href=\"https://github.com/abdoo8080/lean-cvc5/blob/main/ffi/ffi.cpp#L19\">https://github.com/abdoo8080/lean-cvc5/blob/main/ffi/ffi.cpp#L19</a></p>\n<p>(This is not my code, so I'm not sure. Maybe <span class=\"user-mention\" data-user-id=\"417967\">@Abdalrhman M Mohamed</span> can chime in.)</p>\n<p>For what it's worth, I have no issues compiling the <a href=\"https://github.com/dranov/lean-cvc5/tree/bump-v4.20.0-rc2\"><code>bump-v4.20.0-rc2</code></a> branch on x86_64 Ubuntu 24.04.1 LTS with glibc 2.39. The problem only arises on MacOS 15.4.1 (and  did not arise on the <del>immediately</del> previous version I was on – 15.3.2 –  from which I just upgraded today).</p>",
        "id": 516187493,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746449492
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"308899\">@Yakov Pechersky</span>: <a href=\"/user_uploads/3121/0woM4VQZy5nQs-Haa2TEYwpr/otool-output.txt\">otool-output.txt</a></p>",
        "id": 516187815,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746449584
    },
    {
        "content": "<p>Oh! With two projects affected I didn't even consider this might be a project-local symbol. So let's see why we're not loading the implementation...</p>",
        "id": 516187985,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746449630
    },
    {
        "content": "<p>Well we're loading the dynlib before we even get to compiling the file with the implementation, that certainly doesn't look correct. I think this is a question for <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> then how <code>extern_lib</code> interacts with <code>precompileModules</code> and what could have changed here.</p>",
        "id": 516188867,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746449866
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span> What was the last version of the OS where this worked for you? Were you using 15.4.0 or something earlier?</p>",
        "id": 516189278,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1746449968
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> I just checked <code>/Library/Receipts/InstallHistory.plist</code> and it seems I was previously on <code>macOS 15.3.2</code>.</p>",
        "id": 516191508,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746450462
    },
    {
        "content": "<p>Thanks for the reports, this should be fixed by <a href=\"https://github.com/leanprover/lean4/pull/8236\">lean#8236</a></p>",
        "id": 516198558,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746451939
    },
    {
        "content": "<p>I can confirm that this works for me. Thank you very much <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>  and everyone else!</p>",
        "id": 516208040,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1746454109
    },
    {
        "content": "<p>Once <a href=\"https://github.com/leanprover-community/mathlib4/pull/24621\">#24621</a> has landed in Mathlib, Mathlib will be on <code>v4.20.0-rc3</code>, and hopefully the problems in this thread will be resolved.</p>",
        "id": 516303121,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746481815
    },
    {
        "content": "<p>Building lean-egg on <code>lean4:v4.20.0-rc3</code> works like a charm <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span> Thanks for the quick fix!</p>",
        "id": 516379260,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1746519339
    }
]