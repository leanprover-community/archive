[
    {
        "content": "<p>The function <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarContext.MkBinding.mkBinding#doc\">docs#Lean.MetavarContext.MkBinding.mkBinding</a> has the <code>@[specialize]</code> annotation. However, it has a type that won't be specialized.</p>\n<p>With <code>set_option trace.compiler.ir.result true</code>, we can see the IR. This verifies that the function is indeed not specialized where it is used in <code>Lean.MetavarContext.mkBinding</code>. Additionally, the <code>@[specialize]</code> tag causes specializable functions in its definition to not get specialized. In particular,  the specializable function <code>Nat.foldRevM.loop</code> isn't specialized. In the IR we can see that this results in the use of a <code>pap</code> (partial application) and <code>app</code> (application), which are unnecessarily inefficient. If we remove the <code>@[specialize]</code> tag, we can see that <code>Nat.foldRevM.loop</code> gets specialized as intended.</p>\n<p>Should there be some kind of warning when using the <code>@[specialize]</code> tag on a non-specializable definition?</p>\n<p>And shall I make a PR to fix this particular case?</p>",
        "id": 480544173,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1730762638
    }
]