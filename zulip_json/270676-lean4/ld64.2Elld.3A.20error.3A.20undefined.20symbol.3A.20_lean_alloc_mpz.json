[
    {
        "content": "<p>I'm trying to use the FFI together with GMP but I get the following error when I <code>lake build</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">ffigmp.c</span>\n<span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Creating</span> <span class=\"n\">libffigmp.a</span>\n<span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Linking</span> <span class=\"n\">libffigmp.dylib</span>\n<span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">directory</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"n\">for</span> <span class=\"n\">option</span> <span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"bp\">/</span><span class=\"n\">Applications</span><span class=\"bp\">/</span><span class=\"n\">Xcode_14.2.app</span><span class=\"bp\">/</span><span class=\"n\">Contents</span><span class=\"bp\">/</span><span class=\"n\">Developer</span><span class=\"bp\">/</span><span class=\"n\">Platforms</span><span class=\"bp\">/</span><span class=\"n\">MacOSX.platform</span><span class=\"bp\">/</span><span class=\"n\">Developer</span><span class=\"bp\">/</span><span class=\"n\">SDKs</span><span class=\"bp\">/</span><span class=\"n\">MacOSX13.1.sdk</span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_kernel.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_platform.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_pthread.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">FFIGMP</span>\n<span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">FFIGMP</span>\n<span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Main</span>\n<span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Main</span>\n<span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"n\">Linking</span> <span class=\"n\">fFIGMP</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">&gt;</span> <span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ramonfernandezmir</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---nightly-2023-06-20/bin/leanc -o ./build/bin/fFIGMP ./build/ir/Main.o ./build/ir/FFIGMP.o ./build/lib/libffigmp.a -lgmp</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">directory</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"n\">for</span> <span class=\"n\">option</span> <span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"bp\">/</span><span class=\"n\">Applications</span><span class=\"bp\">/</span><span class=\"n\">Xcode_14.2.app</span><span class=\"bp\">/</span><span class=\"n\">Contents</span><span class=\"bp\">/</span><span class=\"n\">Developer</span><span class=\"bp\">/</span><span class=\"n\">Platforms</span><span class=\"bp\">/</span><span class=\"n\">MacOSX.platform</span><span class=\"bp\">/</span><span class=\"n\">Developer</span><span class=\"bp\">/</span><span class=\"n\">SDKs</span><span class=\"bp\">/</span><span class=\"n\">MacOSX13.1.sdk</span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_kernel.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_platform.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">system</span><span class=\"bp\">/</span><span class=\"n\">libsystem_pthread.dylib</span> <span class=\"n\">has</span> <span class=\"n\">version</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">newer</span> <span class=\"n\">than</span> <span class=\"n\">target</span> <span class=\"n\">minimum</span> <span class=\"n\">of</span> <span class=\"mi\">13</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">0</span>\n<span class=\"n\">ld64.lld</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">undefined</span> <span class=\"n\">symbol</span><span class=\"o\">:</span> <span class=\"n\">_lean_alloc_mpz</span>\n<span class=\"bp\">&gt;&gt;&gt;</span> <span class=\"n\">referenced</span> <span class=\"kd\">by</span> <span class=\"bp\">./</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libffigmp.a</span><span class=\"o\">(</span><span class=\"n\">ffigmp.o</span><span class=\"o\">):(</span><span class=\"n\">symbol</span> <span class=\"n\">_my_fun</span><span class=\"bp\">+</span><span class=\"mi\">0x3c</span><span class=\"o\">)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">linker</span> <span class=\"n\">command</span> <span class=\"n\">failed</span> <span class=\"k\">with</span> <span class=\"n\">exit</span> <span class=\"n\">code</span> <span class=\"mi\">1</span> <span class=\"o\">(</span><span class=\"n\">use</span> <span class=\"bp\">-</span><span class=\"n\">v</span> <span class=\"n\">to</span> <span class=\"n\">see</span> <span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">external</span> <span class=\"n\">command</span> <span class=\"bp\">`/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ramonfernandezmir</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---nightly-2023-06-20/bin/leanc` exited with code 1</span>\n</code></pre></div>\n<p>This is from a mwe I uploaded to <a href=\"https://github.com/ramonfmir/FFIGMP\">https://github.com/ramonfmir/FFIGMP</a> . The C code is simply:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"kn\">include</span> <span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean.h</span><span class=\"bp\">&gt;</span>\n<span class=\"bp\">#</span><span class=\"kn\">include</span> <span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean_gmp.h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">lean_obj_res</span> <span class=\"n\">my_fun</span><span class=\"o\">(</span><span class=\"n\">lean_obj_arg</span> <span class=\"n\">x</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">mpz_t</span> <span class=\"n\">y</span><span class=\"bp\">;</span>\n    <span class=\"n\">mpz_init</span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n    <span class=\"n\">mpz_set_ui</span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">,</span> <span class=\"mi\">123</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n    <span class=\"n\">return</span> <span class=\"n\">lean_alloc_mpz</span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>I'm running it on an M1 mac with Lean installed natively. I'm pretty sure that the exact same approach worked a couple of months ago but I think I was running it with Rosetta and on an older Mac OS version. The warnings are also new, I noticed some other people are experiencing the same recently (<a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/stream/113489-new-members/topic/Warnings.20from.20lake.20build.20on.20macOS\">#new members &gt; Warnings from lake build on macOS</a> , <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4/topic/error.3A.20permission.20denied\">#lean4 &gt; error: permission denied</a> ), I wonder if it's related.</p>",
        "id": 370139516,
        "sender_full_name": "Ramon Fernández Mir",
        "timestamp": 1687885125
    },
    {
        "content": "<p>ARM releases are not linked against GMP, see <code>LEAN_USE_GMP</code> references in the Lean source</p>",
        "id": 370140584,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1687885301
    },
    {
        "content": "<p>Ah, I see, so the only way to make this work on my machine is to use Rosetta?</p>",
        "id": 370144752,
        "sender_full_name": "Ramon Fernández Mir",
        "timestamp": 1687886101
    },
    {
        "content": "<p>What is your goal? Eventually no version of Lean 4 will use GMP, but you could still use GMP internally in your library</p>",
        "id": 370145305,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1687886207
    },
    {
        "content": "<p>I'm using another library (Arblib) that depends on GMP and I want an interface to it from Lean.</p>",
        "id": 370145757,
        "sender_full_name": "Ramon Fernández Mir",
        "timestamp": 1687886307
    },
    {
        "content": "<p>You could use Rosetta for now, but if you want to make your code future-proof, you should translate between Lean's representation and GMP's. Which you would probably be the first one to do!</p>",
        "id": 370151934,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1687887497
    },
    {
        "content": "<p>Right, so if I assume that at the interface level I have regular Nats/Ints (which is probably a fair assumption) then I can get rid of lean_alloc_mpz/lean_extract_mpz_value but I still can use GMP at the library level and it all works nicely.</p>",
        "id": 370152167,
        "sender_full_name": "Ramon Fernández Mir",
        "timestamp": 1687887552
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/270676-lean4/topic/ld64.2Elld.3A.20error.3A.20undefined.20symbol.3A.20_lean_alloc_mpz/near/370151934\">said</a>:</p>\n<blockquote>\n<p>You could use Rosetta for now, but if you want to make your code future-proof, you should translate between Lean's representation and GMP's. Which you would probably be the first one to do!</p>\n</blockquote>\n<p>Or I guess I could do that, it seems like a bit more work though hahah</p>",
        "id": 370152506,
        "sender_full_name": "Ramon Fernández Mir",
        "timestamp": 1687887608
    }
]