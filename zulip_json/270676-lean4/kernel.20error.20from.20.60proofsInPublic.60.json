[
    {
        "content": "<p>If in one module, I write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">no_expose</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">five</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">five</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">proofsInPublic</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>Then in another module that imports it,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">instA</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">instA</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>gives a kernel error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">MathlibTest</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">._</span><span class=\"n\">example'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">instA</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">instA</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">instA</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instA</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>I discovered this bug when trying to adapt <code>Real</code> to the module system.</p>\n<p>Note that the <code>set_option backward.proofsInPublic false in</code> is only necessary in Mathlib. The default value of <code>backward.proofsInPublic</code> is already <code>false</code>.</p>",
        "id": 563693721,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765723761
    },
    {
        "content": "<p>Thanks, fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/11673\">#11673</a></p>",
        "id": 563702482,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765733915
    },
    {
        "content": "<blockquote>\n<p>I discovered this bug when trying to adapt <code>Real</code> to the module system.</p>\n</blockquote>\n<p>I believe <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> and <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>  may have some thoughts on where to best start with such experiments, which may also inform how quickly this fix should land in a release.</p>",
        "id": 563702559,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765733983
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/11673\">lean4#11673</a> (for anybody who wants to check, e.g. me)</p>",
        "id": 563716783,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765752635
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> Happy to discuss this further! Did you meet any other obstacles while modulizing <code>Real</code>?</p>\n<p>One thought I had was to try this with some p-adic types, since they probably have fewer files depending on them. Eg <code>WittVector</code> will have very little depending on it (inside Mathlib, there's much more outside Mathlib, which we should be conscious of). And <code>padicInt</code> has some more material depending on it inside Mathlib, but much less than <code>Real</code>.</p>",
        "id": 563780451,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1765793381
    },
    {
        "content": "<p>The PR is <a href=\"https://github.com/leanprover-community/mathlib4/pull/32872\">#32872</a>. I've managed to work around the kernel error by not using <code>rfl</code> for the problematic proofs. All of mathlib builds, but there are some remaining errors in Counterexamples and Archive. There are some questions about which things should and should not be <code>@[no_expose]</code>. For example, we have <code>a - b</code> defined as <code>a + -b</code>, and <code>a / b</code> as <code>a * b⁻¹</code>. This defEq is actually used somewhere. We also have <code>a ≤ b</code> defined as <code>a &lt; b ∨ a = b</code>, but I found that exposing this only lead to some proof working in an unexpected way.</p>\n<p>I also made <a href=\"https://github.com/leanprover-community/mathlib4/pull/32861\">#32861</a> which does similar changes in a couple of other files.</p>",
        "id": 563782937,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765794059
    },
    {
        "content": "<p>I think none of those definitional details should be exposed.</p>",
        "id": 563787470,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1765795260
    },
    {
        "content": "<p>No more sub_eq_add_neg defeq abuse?? What exactly do we gain from this?</p>\n<p>Johan and I are old enough to remember the days when that was a simp lemma :-) Maybe we should go back to that :-) (no! no! no!)</p>",
        "id": 563804185,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765800164
    },
    {
        "content": "<p>I've now fixed the failures in <a href=\"https://github.com/leanprover-community/mathlib4/pull/32872\">#32872</a> by simply making those files into modules. Is there a plan to turn everything into modules in mathlib? (so, Counterexamples, and Archive, etc.)</p>",
        "id": 564346354,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1766007198
    },
    {
        "content": "<p>Though there are some failures from the <code>simpNF</code> linter timing out. Does anyone know if <code>simpNF</code> is run in a <code>module</code> or not?</p>",
        "id": 564346565,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1766007277
    },
    {
        "content": "<p>Also, the following error shows up from marking the projection <code>Real.cauchy</code> as private <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> The `structureInType` linter reports:</span>\n<span class=\"cm\">FOUND STRUCTURES THAT SHOULD BE IN PROP. -/</span>\n<span class=\"c1\">-- Mathlib.Data.Real.Basic</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">LINTER</span><span class=\"w\"> </span><span class=\"n\">FAILED</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`Real.cauchy</span><span class=\"bp\">`</span>\n</code></pre></div>",
        "id": 564592512,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1766103688
    }
]