[
    {
        "content": "<p>I was looking into manually translating a mutually recursive function into a single non-recursive function and saw the elaborator uses <code>WellFounded.fix</code> even though it is <code>noncomputable</code>. </p>\n<p>That got me thinking is there a computable version of <code>WellFounded.fix</code> in Lean?</p>\n<p>I didn't see one, buit was able to write a version that uses WellFoundedRelation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">WellFoundedRelation</span><span class=\"bp\">.</span><span class=\"n\">fix</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WellFoundedRelation</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">ind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">WellFoundedRelation</span><span class=\"bp\">.</span><span class=\"n\">rel</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ind</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">WellFoundedRelation</span><span class=\"bp\">.</span><span class=\"n\">fix</span><span class=\"w\"> </span><span class=\"n\">ind</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>This feels like I may be reinventing something that already exists or there's a performance pitfall.  Is there an alternative computable fixpoint definition I should look into?</p>",
        "id": 528942125,
        "sender_full_name": "Joe Hendrix",
        "timestamp": 1752613702
    },
    {
        "content": "<p>I think Batteries has compiled a computable version</p>",
        "id": 528942695,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752613941
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/blob/82fd0cf6aaa1e2580aa17b3b1e5b9140e6e6a5e5/Batteries/WF.lean#L117-L121\">here</a></p>",
        "id": 528942873,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752614031
    },
    {
        "content": "<p>And it's <code>csimp</code>, so importing that file is enough to make <code>WellFounded.fix</code> computable</p>",
        "id": 528945825,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752615465
    },
    {
        "content": "<p>might be useful to add a note about <code>Batteries.WF</code> to the <code>WellFounded.fix</code> documentation</p>",
        "id": 529186041,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752713178
    },
    {
        "content": "<p>It also seems like this would be a reasonable candidate to migrate from batteries to core.</p>",
        "id": 529347861,
        "sender_full_name": "Joe Hendrix",
        "timestamp": 1752782565
    },
    {
        "content": "<p>I made this <a href=\"https://github.com/leanprover/lean4/pull/11620\">PR</a> for this.</p>",
        "id": 563530170,
        "sender_full_name": "Joe Hendrix",
        "timestamp": 1765561206
    }
]