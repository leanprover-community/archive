[
    {
        "content": "<p>i am encountering a very strange issue.</p>\n<p>i was working on a little toy project in lean when my computer ground to a halt. i shrugged, force rebooted my computer, and continued on, assuming i accidentally had too much stuff open (my oom killer is not very good). this began to happen again but i was able to close vs code before it ground to a halt. so this was a lean issue.</p>\n<p>the third time this happened, i started investigating. <code>lake build</code> was hanging on clearly invalid code and eating up memory, quickly, as it did so. i eventually whittled my code down to the following minimal reproducible example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Header</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"n\">linear</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">decode_header</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Header</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\">     </span><span class=\"c1\">-- *all* of these are necessary for some reason</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">     </span><span class=\"c1\">-- underlying problem was probably here</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">linear</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">height</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">linear</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>yes, minimal reproducible example. making any changes to this code - removing parameters on the <code>structure</code>, touching any of the assignments - produced code that would either quickly error out and not hang lake, or still hang lake but not exhibit the rapid memory consumption that was crashing my computer. and this was <em>reproducible</em>. removing <code>.lake</code> and rebuilding from source triggered the same behavior, every time.</p>\n<p>now that i had a (weird) reproducible example, i was going to file a report, but noticed lake wasn't actually downloading or rebuilding lean. i'm not terribly familiar with the ins and outs of the lean build system: i had in my <code>lean-toolchain</code> file <code>leanprover/lean4:v4.11.0-rc2</code>, but noticed it seemed to happen with whatever i changed it to, which was strange. i remembered <code>elan</code> and wondered if i had updated the toolchains via there recently. i ran <code>elan update</code>, it updated my nightly, and: no issue. <code>lake build</code> successfully failed.</p>\n<p>so i was very confused by all of this and resolved to go to sleep and give up on the whole affair of tracking down exactly what <code>elan update</code> updated that made this all work again (my guess was <code>lake</code>). but, i went back to my original project: deleting the <code>.lake</code> folder, successfully getting build failures. then i opened it in vs code again.</p>\n<p>my memory usage was fine. i changed the problematic line (above) from <code>return none</code> to <code>failure</code>, in hopes lean would treat my <code>a</code> variable as having a consistent type of <code>UInt8</code>.</p>\n<p>my memory usage started ballooning.</p>\n<p>so, right now, i'm a little bit stuck. there was previously some horrifyingly specific memory-leak-causing performance pitfall in either lean or lake. updating my toolchain with <code>elan update</code> fixed it. it's still around, but only in my <em>tooling</em>, and only when i change <code>return none</code> to <code>failure</code> or vice versa. (it does not occur upon first opening code and initial typechecking).</p>\n<p>i do not know how to solve this. does vscode-lean4 manage its own lean toolchain, independent of <code>elan</code>? was this a known bug and actually fixed, or should i figure out exactly what version of all tooling my vscode install is using so as to get an actually-reproducible environment for figuring this out, in case unrelated upstream changes only changed the specific trigger of this extremely-pathological performance case? any advice (particularly about vscode-lean4's tooling management) would be appreciated.</p>\n<p>also - i'm having a lot of fun with lean <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>. it's a beautiful language and the tooling is awesome. this issue i do actually need to fix though, because it's preventing me from writing lean (by crashing my computer). i figured i'd write up the full path to this strangeness for clarity and for others' amusement.</p>",
        "id": 464807248,
        "sender_full_name": "JJ",
        "timestamp": 1724485682
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 464808041,
        "sender_full_name": "JJ",
        "timestamp": 1724486042
    },
    {
        "content": "<p>What's your OS? What's the output of <code>lake --version</code>?</p>",
        "id": 464808119,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1724486132
    },
    {
        "content": "<p>oh, right, i put this in the issue i was going to file but forgot to put it here.</p>\n<ul>\n<li>arch linux 6.6.46</li>\n<li>elan 3.1.1</li>\n<li>vscode 1.92.1</li>\n<li>vscode-lean4 v0.0.176</li>\n</ul>\n<p>my current toolchains installed with elan are these, but these are probably not helpful because it was after i ran <code>elan update</code>. same for <code>lake --version</code> (which is <code>5.0.0-c375e19</code>)</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"o\">[</span>~<span class=\"o\">]</span>$<span class=\"w\"> </span>elan<span class=\"w\"> </span>show\ninstalled<span class=\"w\"> </span>toolchains\n--------------------\n\nleanprover/lean4:nightly\nleanprover/lean4:stable<span class=\"w\"> </span><span class=\"o\">(</span>default<span class=\"o\">)</span>\nleanprover/lean4:v4.10.0\nleanprover/lean4:v4.11.0-rc1\nleanprover/lean4:v4.11.0-rc2\nleanprover/lean4:v4.9.0-rc1\n\nactive<span class=\"w\"> </span>toolchain\n----------------\n\nleanprover/lean4:stable<span class=\"w\"> </span><span class=\"o\">(</span>default<span class=\"o\">)</span>\nLean<span class=\"w\"> </span><span class=\"o\">(</span>version<span class=\"w\"> </span><span class=\"m\">4</span>.10.0,<span class=\"w\"> </span>x86_64-unknown-linux-gnu,<span class=\"w\"> </span>commit<span class=\"w\"> </span>c375e19f6b65,<span class=\"w\"> </span>Release<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 464808445,
        "sender_full_name": "JJ",
        "timestamp": 1724486422
    },
    {
        "content": "<p>(also i probably should not have filed this right now - it's very late where i am and i do need to sleep. i will try any suggestions anyone has and provide more info if needed in the morning...)</p>",
        "id": 464808906,
        "sender_full_name": "JJ",
        "timestamp": 1724486862
    },
    {
        "content": "<p>Does the memory leak go away if you use <code>noncomputable def</code> instead of <code>def</code>?</p>",
        "id": 464816231,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724492438
    },
    {
        "content": "<p>yes, it appears to! with some cursory testing</p>",
        "id": 464858235,
        "sender_full_name": "JJ",
        "timestamp": 1724511904
    },
    {
        "content": "<p>That suggests this is a compiler bug then</p>",
        "id": 464904895,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724536258
    },
    {
        "content": "<p>(as opposed to elaborator or kernel)</p>",
        "id": 464904911,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724536287
    },
    {
        "content": "<p>hmm, interesting. do you have any idea why it would have gone away after <code>elan update</code> when <code>lean-toolchain</code> remained the same (<code>leanprover/lean4:v4.11.0-rc2</code>)?</p>",
        "id": 465076026,
        "sender_full_name": "JJ",
        "timestamp": 1724644227
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/YmiIlHqwhM_5PM3Vvl12h1Ia/2024-08-26-112842.webm\">2024-08-26-112842.webm</a></p>\n<div class=\"message_inline_image message_inline_video\"><a href=\"/user_uploads/3121/YmiIlHqwhM_5PM3Vvl12h1Ia/2024-08-26-112842.webm\" title=\"2024-08-26-112842.webm\"><video preload=\"metadata\" src=\"/user_uploads/3121/YmiIlHqwhM_5PM3Vvl12h1Ia/2024-08-26-112842.webm\"></video></a></div>",
        "id": 465601291,
        "sender_full_name": "JJ",
        "timestamp": 1724808310
    },
    {
        "content": "<p>here's a video of the behavior i'm seeing. is there any way to tell the extension to update / redownload its internally managed tooling? presumably this would fix it as <code>lake build</code> now successfully fails after <code>elan update</code>, but for now i can't do anything in vscode without sticking <code>noncomputable</code> on this function...</p>",
        "id": 465601548,
        "sender_full_name": "JJ",
        "timestamp": 1724808416
    },
    {
        "content": "<p>vscode-lean4 does not manage its own toolchain (it uses Elan for this), though the logic it uses for which <code>lean-toolchain</code> file to use for a given Lean file is slightly different from Elan when there are nested <code>lean-toolchain</code> files.<br>\nWhat's the output of the <code>Troubleshooting: Show Setup Information</code> command when focusing the file that you are seeing the issue in?</p>",
        "id": 465661308,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1724829201
    },
    {
        "content": "<p><strong>Operating system</strong>: Linux (release: 6.6.46-1-lts)<br>\n<strong>CPU architecture</strong>: x64<br>\n<strong>CPU model</strong>: 8 x 11th Gen Intel(R) Core(TM) i7-1165G7 @ 2.80GHz<br>\n<strong>Available RAM</strong>: 16.48 GB</p>\n<p><strong>VS Code version</strong>: Reasonably up-to-date (version: 1.92.1)<br>\n<strong>Lean 4 extension version</strong>: 0.0.176<br>\n<strong>Curl installed</strong>: true<br>\n<strong>Git installed</strong>: true<br>\n<strong>Elan</strong>: Reasonably up-to-date (version: 3.1.1)<br>\n<strong>Lean</strong>: Reasonably up-to-date (version: 4.11.0-rc2)<br>\n<strong>Project</strong>: Valid Lean project (path: /home/apropos/Projects/lean/qoi)</p>\n<hr>\n<p><strong>Elan toolchains</strong>: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">installed</span><span class=\"w\"> </span><span class=\"n\">toolchains</span>\n<span class=\"c1\">--------------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">nightly</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">stable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n\n<span class=\"n\">active</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"c1\">----------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">overridden</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">apropos</span><span class=\"bp\">/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">qoi</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain'</span><span class=\"o\">)</span>\n\n<span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"bp\">-</span><span class=\"n\">unknown</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">gnu</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">edf1bac392f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Release</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 465661756,
        "sender_full_name": "JJ",
        "timestamp": 1724829277
    },
    {
        "content": "<p>In that case, the VS Code extension is using <code>leanprover/lean4:v4.11.0-rc2</code> (as designated in <code>/home/apropos/Projects/lean/qoi/lean-toolchain</code>).</p>",
        "id": 465662363,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1724829379
    },
    {
        "content": "<p>yeah. what is weird is presumably <code>lake build</code> uses that as well when i run it in the project root. yet <code>lake build</code> successfully fails and vscode unsuccessfully hangs on build =&gt; memory leak</p>",
        "id": 465662650,
        "sender_full_name": "JJ",
        "timestamp": 1724829434
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">apropos</span><span class=\"bp\">@</span><span class=\"n\">arch</span><span class=\"w\"> </span><span class=\"n\">qoi</span><span class=\"o\">]</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">pwd</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">apropos</span><span class=\"bp\">/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">qoi</span>\n<span class=\"o\">[</span><span class=\"n\">apropos</span><span class=\"bp\">@</span><span class=\"n\">arch</span><span class=\"w\"> </span><span class=\"n\">qoi</span><span class=\"o\">]</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"k\">show</span>\n<span class=\"n\">installed</span><span class=\"w\"> </span><span class=\"n\">toolchains</span>\n<span class=\"c1\">--------------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">nightly</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">stable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n\n<span class=\"n\">active</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"c1\">----------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">overridden</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">apropos</span><span class=\"bp\">/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">qoi</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain'</span><span class=\"o\">)</span>\n<span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"bp\">-</span><span class=\"n\">unknown</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">gnu</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">edf1bac392f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Release</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 465662859,
        "sender_full_name": "JJ",
        "timestamp": 1724829475
    },
    {
        "content": "<p>unless my eyes deceive me, these toolchains are identical</p>",
        "id": 465663152,
        "sender_full_name": "JJ",
        "timestamp": 1724829528
    },
    {
        "content": "<p>at this point i really just want to get this fixed rather than find the source of the problem... i've tried uninstalling &amp; reinstalling the extension to no avail. going to try to track down and remove any cache the lean extension might be keeping tmrw (if anyone knows where this might be please lmk)</p>",
        "id": 465663675,
        "sender_full_name": "JJ",
        "timestamp": 1724829661
    },
    {
        "content": "<p>I can reproduce this issue using the code in the first post with both the language server and <code>lake build</code>. Looks like it is indeed stuck in the compiler, which explains why <code>noncomputable</code> fixes it. Here's a profile of where <code>lake build</code> spends the first two minutes: <a href=\"https://share.firefox.dev/3AEOrt8\">https://share.firefox.dev/3AEOrt8</a> </p>\n<p>Could you file a bug in the Lean 4 repository?</p>",
        "id": 465675735,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1724831967
    },
    {
        "content": "<p>oh sweet!! i thought for sure it was tied up in some strange computer-specific caching issue...</p>",
        "id": 465682872,
        "sender_full_name": "JJ",
        "timestamp": 1724833027
    },
    {
        "content": "<p>i'll file an issue in the morning, it's a bit late here. what versions of tooling are you running? is it the same as my <code>elan show</code> above?</p>",
        "id": 465683101,
        "sender_full_name": "JJ",
        "timestamp": 1724833080
    },
    {
        "content": "<p>I used v4.10.0.</p>",
        "id": 465683324,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1724833133
    },
    {
        "content": "<p>report filed. interestingly, i can reproduce this with <code>lake build</code> again.</p>",
        "id": 465838398,
        "sender_full_name": "JJ",
        "timestamp": 1724874359
    }
]