[
    {
        "content": "<p>Below is the definition of gcd from mathlib for which the example below works using decide, but if I copy the exact definition to define my_gcd, the same example fails (obviously because of @[extern \"lean_nat_gcd\"]). How do I make decide work for my_gcd?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">@[extern \"lean_nat_gcd\"]</span>\n<span class=\"cm\">def gcd (m n : @&amp; Nat) : Nat :=</span>\n<span class=\"cm\">  if m = 0 then</span>\n<span class=\"cm\">    n</span>\n<span class=\"cm\">  else</span>\n<span class=\"cm\">    gcd (n % m) m</span>\n<span class=\"cm\">  termination_by m</span>\n<span class=\"cm\">  decreasing_by simp_wf; apply mod_lt _ (zero_lt_of_ne_zero _); assumption</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">my_gcd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">my_gcd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">decreasing_by</span><span class=\"w\"> </span><span class=\"n\">simp_wf</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mod_lt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_of_ne_zero</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">gcd</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">my_gcd</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Tactic `decide` failed for proposition</span>\n<span class=\"cm\">  my_gcd 10 7 = 1</span>\n<span class=\"cm\">because its `Decidable` instance</span>\n<span class=\"cm\">  instDecidableEqNat (my_gcd 10 7) 1</span>\n<span class=\"cm\">did not reduce to `isTrue` or `isFalse`.</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 567325465,
        "sender_full_name": "Mario Weitzer",
        "timestamp": 1768056765
    },
    {
        "content": "<p>As far as I know, what decide tactic do is applying decidability to produce a proof if it exists. Thus you have to prove decidability of your predication if you want to use this. You can find the definition of decidability in mathlib index page.</p>",
        "id": 567326806,
        "sender_full_name": "Junseong O",
        "timestamp": 1768058085
    },
    {
        "content": "<p><code>@[extern \"lean_nat_gcd\"]</code> isn't doing anything for reducibility here</p>",
        "id": 567327411,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768058715
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"961264\">@Junseong O</span> The error here is indicating that it was able to synthesize a Decidable instance, and that the problem was that the instance failed to reduce. The Decidable instance exists.)</p>",
        "id": 567327422,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768058726
    },
    {
        "content": "<p>the actual reason is that Lean has special support for <code>Nat.gcd</code> and 13 other constants that directly computes them when applied to <code>Nat</code> literals (instead of having to reduce)</p>",
        "id": 567327468,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768058781
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"595391\">@Mario Weitzer</span> The issue is that using <code>termination_by</code> causes it to not be reducible. (I have to go for a moment, but I'm sure someone will give tips.)</p>",
        "id": 567327472,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768058786
    },
    {
        "content": "<p>that it doesn't compute without this special support is probably a problem?</p>",
        "id": 567327521,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768058829
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thanks for correcting</p>",
        "id": 567327834,
        "sender_full_name": "Junseong O",
        "timestamp": 1768059142
    },
    {
        "content": "<p>I guess it's fine if we have special support for reducing <code>Nat.gcd</code> since that doesn't cause any problems</p>",
        "id": 567328041,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768059363
    },
    {
        "content": "<p>you can mark your <code>my_gcd</code> as <code>@[semireducible]</code> if you want it to reduce in the elaborator</p>",
        "id": 567328055,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768059382
    },
    {
        "content": "<p>or you can <code>decide +kernel</code> to bypass the elaborator and go straight to the kernel</p>",
        "id": 567328073,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768059405
    },
    {
        "content": "<p>Or you could use \"gas\" to make it structural recursion, which makes it readily reducible.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">my_gcd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">gas</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">gas</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">gas'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">gas'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">my_gcd</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 567329098,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768060350
    },
    {
        "content": "<p>Since <a href=\"https://github.com/leanprover/lean4/pull/7965\">https://github.com/leanprover/lean4/pull/7965</a> it's no longer needed to transform to using fuel manually, and you should be able to mark the function as <code>semireducible</code> â€¦ as Aaron says</p>",
        "id": 567334697,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1768065667
    },
    {
        "content": "<p>Oh right, that's already been released! It's available in v4.27.0 (the most recent version).</p>",
        "id": 567334928,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768065875
    },
    {
        "content": "<p>Thank's everybody, the <code>@[semireducible]</code> suggestion was the easiest solution for my problem!</p>",
        "id": 567344261,
        "sender_full_name": "Mario Weitzer",
        "timestamp": 1768076171
    }
]