[
    {
        "content": "<p>I'm a little surprised that this doesn't give an error about a cycle existing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"c1\">-- (kernel) declaration has metavariables 'foo'</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">run_tac</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">    </span><span class=\"c1\">-- make a metavariable loop</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">target</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">setGoals</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">rawOnError</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 511181062,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744207021
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assign#doc\">docs#Lean.MVarId.assign</a> explicitly says it does not check for cycles.</p>",
        "id": 511191494,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744209415
    },
    {
        "content": "<p>If you use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assignIfDefeq#doc\">docs#Lean.MVarId.assignIfDefeq</a> you get the same problem</p>",
        "id": 511192102,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744209532
    },
    {
        "content": "<p>I think <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.checkedAssign#doc\">docs#Lean.MVarId.checkedAssign</a> is supposed to do an occurs check</p>",
        "id": 511193643,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744209908
    },
    {
        "content": "<p>Thanks, that's enough to tell me I'm doing something wrong, but I don't yet know what!</p>",
        "id": 511206972,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744213307
    },
    {
        "content": "<p>I think it's likely there are many latent Lean bugs out there due to using <code>MVarId.assign</code>.</p>\n<p>At least <code>MVarId.assignIfDefeq</code> does a defeq check on the types first, which sometimes is enough to exclude cycles.</p>\n<p>Lean core ought to implement some consistency check functions that can be used to diagnose issues like this. (Some issues that come to mind: valid metacontext state, valid local contexts, that synthetic metavariables have the correct kinds and have consistent associated data, that delayed assignment metavariables have not been assigned directly).</p>",
        "id": 511222217,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744217372
    },
    {
        "content": "<p>Feel free to say a bit more about what you're up to.</p>",
        "id": 511222239,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744217381
    },
    {
        "content": "<p>I'm trying to bundle a list of interdependent MVarIds (let's say they all have no local context) into one big <code>PSigma</code> goal</p>",
        "id": 511222862,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744217583
    },
    {
        "content": "<p>That sounds like it could be tricky. Do you know that there exists some topological sort of the dependencies?</p>",
        "id": 511228742,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744219526
    },
    {
        "content": "<p>In a well-formed proof, is the answer always \"yes\"?</p>",
        "id": 511228888,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744219579
    }
]