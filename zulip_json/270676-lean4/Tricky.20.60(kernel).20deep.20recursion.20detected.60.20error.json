[
    {
        "content": "<p>I've been trying to debug a proof which gives a <code>(kernel) deep recursion detected</code> error. I've included a self-contained example below, however it seems to be resisting further attempt at minimization. I've tried removing several seemingly unrelated complexities from the example, all of which then make the error disappear without a giving me a clear intuition as to why.</p>\n<p>Does anyone have a suggestion for what could cause this behaviour?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\">! # Preliminary -/</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">`PoisonOr` is a simple wrapper around `Option`</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toOption</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">·⟩</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bind</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">none</span><span class=\"bp\">⟩</span><span class=\"w\">    </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">none</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⟩</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bind_assoc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_|_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">! # MWE -/</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">umulOverflow'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"c1\">-- -----^</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Making this `+` has no effect, the error remains.</span>\n<span class=\"w\">  </span><span class=\"c1\">--</span>\n<span class=\"w\">  </span><span class=\"c1\">-- However, replacing `x.toNat` with a constant (even if large), does make the</span>\n<span class=\"w\">  </span><span class=\"c1\">--   error disappear</span>\n<span class=\"w\">  </span><span class=\"c1\">--</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Also note that the rhs was originally `2 ^ w`, but I've replaced it with</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `0` to rule out `2 ^ w` being computed. This had no effect on the error.</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableRel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">umulOverflow'</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">umulOverflow'</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"c1\">-- If we `sorry` out this instance, the error disappears</span>\n<span class=\"w\">  </span><span class=\"c1\">-- sorry</span>\n<span class=\"w\">  </span><span class=\"n\">infer_instance</span>\n\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">The following gives the error:</span>\n\n<span class=\"cm\">  (kernel) deep recursion detected</span>\n\n<span class=\"cm\">-/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">32</span>\n<span class=\"w\">          </span><span class=\"c1\">-- ----- ^^^^^^^^^^^^^^</span>\n<span class=\"w\">          </span><span class=\"c1\">-- Replacing the `PoisonOr` wrapper with `Option` (in the whole MWE)</span>\n<span class=\"w\">          </span><span class=\"c1\">-- makes the error disappear</span>\n<span class=\"w\">          </span><span class=\"c1\">--</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"bp\">.</span><span class=\"n\">umulOverflow'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">65537</span><span class=\"bp\">#_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"c1\">-- ----------------- ^^^^^^^</span>\n<span class=\"w\">          </span><span class=\"c1\">-- Making this constant smaller, or replacing it with a variable,</span>\n<span class=\"w\">          </span><span class=\"c1\">-- makes the error disappear</span>\n<span class=\"w\">          </span><span class=\"c1\">--</span>\n<span class=\"w\">            </span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">32</span>\n<span class=\"w\">          </span><span class=\"k\">else</span>\n<span class=\"w\">            </span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Running `simp only [ite_self]` first makes the error disappear</span>\n<span class=\"w\">  </span><span class=\"c1\">--   (but is not applicable in my actual scenario, as the branches of the real</span>\n<span class=\"w\">  </span><span class=\"c1\">--    code aren't the same)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Similarly, rewriting the statement to not have the if-then-else also</span>\n<span class=\"w\">  </span><span class=\"c1\">-- makes the error disappear.</span>\n\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PoisonOr</span><span class=\"bp\">.</span><span class=\"n\">bind_assoc</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ^^ This rewrite is what seems to trigger the recursion, removing it</span>\n<span class=\"w\">  </span><span class=\"c1\">--    makes the error disappear.</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 525032358,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750421901
    },
    {
        "content": "<p>Can you run it through lean4lean?</p>",
        "id": 525033198,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750422232
    },
    {
        "content": "<p>How would I do that? I've built lean4lean locally, and am trying to get it to check this MWE using</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"w\"> </span>lake<span class=\"w\"> </span>env<span class=\"w\"> </span><span class=\"nv\">$lean4lean</span><span class=\"w\"> </span>--fresh<span class=\"w\"> </span>MWE\n</code></pre></div>\n<p>But lean4lean just complains that it can't find oleans (uncaught exception: Could not find any oleans for: MWE).</p>\n<p>Presumably there's no oleans to be found, given that lean fails to build with the aforementioned error?</p>",
        "id": 525037300,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750423877
    },
    {
        "content": "<p>Maybe <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> can help? I can try to trouble shoot at an unspecified later time but am surely far less useful.</p>",
        "id": 525038207,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750424250
    },
    {
        "content": "<p>I also ran a <code>lake build</code> through samply, which gave a stack trace showing a very deep mutual recursion--presumably the one being complained about--involving <code>lean::type_checker::{whnf, reduce_nat}</code>:<br>\n<a href=\"/user_uploads/3121/kNEkysRLHnIrRiQTQhRRUzCa/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/kNEkysRLHnIrRiQTQhRRUzCa/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"5116x1746\" src=\"/user_uploads/thumbnail/3121/kNEkysRLHnIrRiQTQhRRUzCa/image.png/840x560.webp\"></a></div>",
        "id": 525038580,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750424407
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/270676-lean4/topic/Tricky.20.60.28kernel.29.20deep.20recursion.20detected.60.20error/near/525038207\">said</a>:</p>\n<blockquote>\n<p>Maybe <span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> can help? I can try to trouble shoot at an unspecified later time but am surely far less useful.</p>\n</blockquote>\n<p>Ah, I managed to get the MWE to build (thus producing oleans) by setting <code>debug.skipKernelTC</code> to suppress the kernel error. Although, lean4lean seems to be giving unrelated errors. That is, it seems to be complaining about my preliminary definitions already existing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">EnvExtension</span><span class=\"bp\">.</span><span class=\"n\">getStateImpl</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span><span class=\"o\">:</span><span class=\"mi\">1297</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">extension</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">accessed</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_panic</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xf5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fe0605</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_panic_fn</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x15</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fe07e5</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l___private_Lean_Environment_0__Lean_EnvExtension_getStateUnsafe___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x16b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x14b473b</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_ppConstNameWithInfos</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x4f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x25850ff</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_MessageData_ofConstName___elambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xaf</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x1a7c27f</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_apply_2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xa5f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fee7ef</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_MessageData_formatAux</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2af</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x1a7e0af</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_MessageData_formatAux</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x172d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x1a7f52d</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_MessageData_formatAux</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xa97</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x1a7e897</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_MessageData_toString</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x1a82a6c</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_throwKernelException___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x978</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfa9e78</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_addDecl___lambda__3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x36d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfad63d</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replayConstant</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x225d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfb573d</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x198</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc788</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replayConstants</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x19</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfb1ae9</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replayConstant</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x374</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfb3854</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x198</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc788</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc6d8</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc6d8</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc6d8</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_Lean_RBNode_forIn_visit___at_replayConstants___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfbc6d8</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replay</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x6eb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfc6deb</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replayFromImports___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x248</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfcce38</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_replayFromImports___lambda__4</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x15fa</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">xfcefea</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_apply_1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x11dc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fecd1c</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">l_EIO_toBaseIO___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xa</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7f0e52a</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_apply_1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1219</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fecd59</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x800a56e</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">(</span><span class=\"n\">lean_apply_1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1219</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fecd59</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fea546</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7feb831</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">alex</span><span class=\"bp\">/</span><span class=\"n\">Workspace</span><span class=\"bp\">/</span><span class=\"n\">PhD</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean4lean</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7fde325</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">cg9s562sa33k78m63njfn1rw47dp9z0i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mf\">2.40</span><span class=\"bp\">-</span><span class=\"mi\">66</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x97e63</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7f5ccd297e63</span><span class=\"o\">]</span>\n<span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">cg9s562sa33k78m63njfn1rw47dp9z0i</span><span class=\"bp\">-</span><span class=\"n\">glibc</span><span class=\"bp\">-</span><span class=\"mf\">2.40</span><span class=\"bp\">-</span><span class=\"mi\">66</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x11bdbc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7f5ccd31bdbc</span><span class=\"o\">]</span>\n<span class=\"n\">lean4lean</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">problem</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">MWE</span><span class=\"o\">:</span>\n<span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">declared</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">pretty</span><span class=\"w\"> </span><span class=\"n\">printing</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"ss\">`Inhabited.default</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"ss\">`IO.Error</span><span class=\"bp\">`</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Falling</span><span class=\"w\"> </span><span class=\"n\">back</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"n\">printer</span><span class=\"bp\">.</span><span class=\"o\">]</span>\n<span class=\"n\">PoisonOr'</span>\n</code></pre></div>\n<p>I figured trying out lean4lean with the <code>--fresh</code> flag could be more informative (as in <code>lake env $lean4lean --fresh MWE</code>), but this just complains about <code>uncaught exception: (kernel) invalid form for primitive def Nat.gcd</code>, even if I replace the entire module with a simple</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span>\n</code></pre></div>\n<p>I guess I must be doing something wrong, <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> help/guidance would be much appreciated!</p>",
        "id": 525040959,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750425371
    },
    {
        "content": "<p>sorry, lean4lean was broken by one of the recent bumps and I haven't had time to fix it yet; this isn't your fault</p>",
        "id": 525044971,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750426980
    },
    {
        "content": "<p>if you can, try using a previous version before the lean update</p>",
        "id": 525045025,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750427003
    },
    {
        "content": "<p>I figured it'd be something like that, I'll try an old version!</p>",
        "id": 525045444,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750427160
    },
    {
        "content": "<p>I've tried with commit c0273e3 of lean4lean, which is just before the latest lean bump, where <code>lake env $lean4lean MWE</code> gives no output (which presumably means lean4lean found no problems to report?), but trying <code>--fresh</code> still gives the same error about <code>Nat.gcd</code>.</p>\n<p>I also tried 1574d0a, which is just before the lean version bump before that, on which neither <code>lake env $lean4lean MWE</code> nor <code>lake env $lean4lean --fresh MWE</code> give any output.</p>",
        "id": 525047767,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750427957
    },
    {
        "content": "<p>I see, I wasn't aware of the Nat.gcd issue. Probably someone changed the definition?</p>",
        "id": 525048274,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750428116
    },
    {
        "content": "<p>I think the list of primitives is also out of date</p>",
        "id": 525048649,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750428249
    },
    {
        "content": "<p>I think the problem is that well founded definitions no longer reduce on constants, so the kernel override is adding defeqs that are not justified cc: <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span></p>",
        "id": 525049373,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750428488
    },
    {
        "content": "<p>I think it needs to be implemented with fuel as Nat.div was</p>",
        "id": 525049683,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750428584
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"481133\">@Alex Keizer</span> if you want to ignore the issue you can replace line 81-83 of Primitive.lean with <code>return true -- TODO</code></p>",
        "id": 525050243,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750428750
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Tricky.20.60.28kernel.29.20deep.20recursion.20detected.60.20error/near/525049373\">said</a>:</p>\n<blockquote>\n<p>I think the problem is that well founded definitions no longer reduce on constants, so the kernel override is adding defeqs that are not justified cc: <span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span></p>\n</blockquote>\n<p>Do you mean this is an issue in lean4lean, or that this is the lean issue that causes my deep recursion error? I'm a bit lost.</p>\n<blockquote>\n<p>if you want to ignore the issue you can replace line 81-83 of Primitive.lean with <code>return true -- TODO</code></p>\n</blockquote>\n<p>This is just talking about the lean4lean issue, right? I'm already satisfied that lean4lean seems to accept the MWE olean, confirming that this looks like a lean core issue</p>",
        "id": 525055857,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750430675
    },
    {
        "content": "<p>this is unrelated to the deep recursion error, I think</p>",
        "id": 525055912,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750430698
    },
    {
        "content": "<p>I've opened an issue on the Github tracker for this problem as well: <a href=\"https://github.com/leanprover/lean4/issues/8898\">https://github.com/leanprover/lean4/issues/8898</a></p>",
        "id": 525055955,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1750430714
    },
    {
        "content": "<p>this is an issue in the way primitive declarations are being done in lean</p>",
        "id": 525055977,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750430722
    },
    {
        "content": "<p>What does this mean?</p>",
        "id": 525066826,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1750434824
    },
    {
        "content": "<p>Any workaround we can apply?</p>",
        "id": 525066845,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1750434830
    },
    {
        "content": "<p>The issues seems to be due to the constant <code>65537</code>, which is being unfolded by the kernel. In general, working with big natural numbers brings the risk that the kernel will try to unfold them.</p>",
        "id": 525088919,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750445295
    },
    {
        "content": "<p>I've discovered that the issue is related to <a href=\"https://github.com/leanprover/lean4/commit/dd91d7e2e2b99498f9284fca04f178da1809fc4d\">this commit</a>. When I make the corresponding change to Lean4Lean to remove <a href=\"https://github.com/digama0/lean4lean/blob/20a888d6f24107459a703c4e5564c9f5a03cc9fd/Lean4Lean/TypeChecker.lean#L401\">the <code>e.hasFVar</code> check</a>, I get the same issue. The kernel tries to WHNF the second argument to <code>Nat.ble 0 ((BitVec.toNat 32 x) * (BitVec.toNat 32 (BitVec.ofNat 32 65537)))</code> so it can evaluate the <code>Nat.ble</code> application as a primitive op, which it wouldn't have done before because of the variable <code>x</code>. Was this change made because there was a particular case where we would want to evaluate primitive ops with fvars in their args? Or might this change have accidentally found its way into that commit?</p>",
        "id": 525266158,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750662074
    },
    {
        "content": "<p>(FYI the unrelated bugs in lean4lean caused by the version bump have now been fixed, it should work on hello world files once more)</p>",
        "id": 525266344,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662148
    },
    {
        "content": "<p>that commit looks pretty sneaky, the second change seems entirely unrelated to the commit message</p>",
        "id": 525266597,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662261
    },
    {
        "content": "<p>it could be an accidental change?</p>",
        "id": 525266669,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662293
    },
    {
        "content": "<p>oh, the actual change is <a href=\"https://github.com/leanprover/lean4/pull/7386\">lean4#7386</a></p>",
        "id": 525266778,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662337
    },
    {
        "content": "<p>Ah, so we need to also check that the variable isn't a let variable, perhaps? Rather than removing the check entirely</p>",
        "id": 525267005,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750662429
    },
    {
        "content": "<p>well anything other than that particular check won't be O(1)</p>",
        "id": 525267088,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662476
    },
    {
        "content": "<p>Oh, right, so to keep things O(1) we'll need to add a new entry to <code>Expr.Data</code>? Something like <code>Expr.Data.hasLetVar</code>?</p>",
        "id": 525267683,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750662730
    },
    {
        "content": "<p>I don't think that can be computed in Expr.Data, since it depends on external information</p>",
        "id": 525267811,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750662794
    },
    {
        "content": "<p>Oh darn, yeah it depends on the context, tricky indeed...</p>",
        "id": 525268114,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750662938
    },
    {
        "content": "<p>Could this be a reasonable compromise?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">hasNonLetFVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ldecl</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">abstract</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">hasFVar</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">reduceNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RecM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">hasNonLetFVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">readThe</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>The iteration <code>for decl in lctx do</code> is obviously not ideal, but we could perhaps reduce that cost by separately tracking a list of let-bound free variables in the typechecking context and only iterating over those instead.</p>",
        "id": 525273329,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750665063
    },
    {
        "content": "<p>^ if we do only iterate over let-bound fvars, this actually recovers O(1) in the common case (when there are no let-bound fvars in the context)</p>",
        "id": 525277986,
        "sender_full_name": "Rish Vaishnav",
        "timestamp": 1750666841
    },
    {
        "content": "<p>I don't think it's practical, because this is being run on every subterm all the time - we don't even know yet whether it's a nat expression</p>",
        "id": 525278088,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750666887
    },
    {
        "content": "<p>we may as well just step forward a bit and see if the head is <code>Nat.add</code> or whatever</p>",
        "id": 525278183,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750666927
    },
    {
        "content": "<p>but maybe taking a step back, I'm not yet satisfied with the explanation of the issue. Why is this even triggering a big nat computation? It's just a bind reassociation which isn't unfolding anything</p>",
        "id": 525278927,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750667201
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Tricky.20.60.28kernel.29.20deep.20recursion.20detected.60.20error/near/525278927\">schrieb</a>:</p>\n<blockquote>\n<p>but maybe taking a step back, I'm not yet satisfied with the explanation of the issue. Why is this even triggering a big nat computation? It's just a bind reassociation which isn't unfolding anything</p>\n</blockquote>\n<p>It may be enough to be defeq checking, due to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/**</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">remark</span><span class=\"w\"> </span><span class=\"n\">t_n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s_n</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"n\">lbool</span><span class=\"w\"> </span><span class=\"n\">type_checker</span><span class=\"bp\">::</span><span class=\"n\">lazy_delta_reduction</span><span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"w\"> </span><span class=\"n\">t_n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"w\"> </span><span class=\"n\">s_n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lbool</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">is_def_eq_offset</span><span class=\"o\">(</span><span class=\"n\">t_n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s_n</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">l_undef</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">;</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">has_fvar</span><span class=\"o\">(</span><span class=\"n\">t_n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">has_fvar</span><span class=\"o\">(</span><span class=\"n\">s_n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">t_v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">reduce_nat</span><span class=\"o\">(</span><span class=\"n\">t_n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">                </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">to_lbool</span><span class=\"o\">(</span><span class=\"n\">is_def_eq_core</span><span class=\"o\">(</span><span class=\"bp\">*</span><span class=\"n\">t_v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s_n</span><span class=\"o\">))</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">s_v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">reduce_nat</span><span class=\"o\">(</span><span class=\"n\">s_n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">                </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">to_lbool</span><span class=\"o\">(</span><span class=\"n\">is_def_eq_core</span><span class=\"o\">(</span><span class=\"n\">t_n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">s_v</span><span class=\"o\">))</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>(related investigation at <a href=\"https://github.com/leanprover/lean4/issues/6152#issuecomment-2490917863\">https://github.com/leanprover/lean4/issues/6152#issuecomment-2490917863</a>)</p>",
        "id": 525279311,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750667336
    },
    {
        "content": "<p>hm, needs more lazy</p>",
        "id": 525279770,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750667489
    },
    {
        "content": "<p>Possibly similar problem: <a href=\"#narrow/channel/270676-lean4/topic/strange.20deep.20recursion.20error.20when.20using.20.60rw.60.20with.20.60match.60\">#lean4 &gt; strange deep recursion error when using &#96;rw&#96; with &#96;match&#96;</a></p>",
        "id": 531900175,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1753898676
    },
    {
        "content": "<p>I think they are essentially the same problem. I see the same <code>reduce_nat</code> involvement when debugging this. I would have thought that using <code>Fin</code> would be enough indirection to prevent this but maybe the expose in <code>Fin.ofNat</code> makes it still problematic in the same way? I'm trying to work around it by defining constants rather than using explicit numbers but it feels cumbersome.</p>",
        "id": 531915256,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1753904040
    },
    {
        "content": "<p>The fact that that example relies on explicit match cases vs. a single default case probably comes down to some short circuiting that the compiler does when reducing a match?</p>",
        "id": 531915579,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1753904159
    },
    {
        "content": "<p>So the way we worked around this issue is by introducing an <code>opaque</code> definition which is prop-eq to the identity function, but by virtue of being opaque blocks any reduction:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Definition of `hide` and `hide_eq` -/</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">`hide` is an opaque version of the identity function.</span>\n<span class=\"sd\">By making it opaque, we prevent the kernel from trying to reduce the argument.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n\n<span class=\"sd\">/-- A proof that `hide` is the identity. Note that this is deliberately *not*</span>\n<span class=\"sd\">a def-eq, since we made `hide` opaque. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">hide_eq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hide</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>And then we wrote a simproc which rewrites problematic constants to hide them behind this opaque defintion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Symmetric version of `hide_eq`. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">eq_hide</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">symm</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hide_eq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">simpHide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">SimpM</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">getContext</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">parent?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"bp\">.</span><span class=\"n\">isAppOf</span><span class=\"w\"> </span><span class=\"ss\">``hide</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">LeanMLIR</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"{Lean.crossEmoji}: parent ({parent}) is an application of `hide`\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``hide</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppOptM</span><span class=\"w\"> </span><span class=\"ss\">``eq_hide</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">done</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">    </span><span class=\"n\">proof?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">proof</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">match_expr</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"bp\">.</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"bp\">.</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">isRawNatLit</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isConstant</span><span class=\"o\">)</span>\n\n\n<span class=\"n\">simproc</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">hideOfIntConstants</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">  </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`LeanMLIR.Elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Hiding: {e}\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"{Lean.crossEmoji}: {x} is not a constant\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"n\">simpHide</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"n\">simproc</span><span class=\"w\"> </span><span class=\"n\">LLVM</span><span class=\"bp\">.</span><span class=\"n\">hideConst?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LLVM</span><span class=\"bp\">.</span><span class=\"n\">const?</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">LLVM</span><span class=\"bp\">.</span><span class=\"n\">const?</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">  </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`LeanMLIR.Elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Hiding: {e}\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"{Lean.crossEmoji}: {x} is not a constant\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"n\">simpHide</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"hide_constants\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">memoize</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">hideOfIntConstants</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LLVM</span><span class=\"bp\">.</span><span class=\"n\">hideConst?</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- --------------------^^^^^^^</span>\n<span class=\"w\">  </span><span class=\"c1\">-- NOTE: we have to disable the memoize option, since the simprocs</span>\n<span class=\"w\">  </span><span class=\"c1\">-- inspect the parent expressions, which are disregarded by the cache</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"unhide_constants\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hide_eq</span><span class=\"o\">]</span>\n<span class=\"o\">)</span>\n</code></pre></div>\n<p>Hopefully this workaround works in your situation also</p>",
        "id": 532077981,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1753969260
    },
    {
        "content": "<p>There's <code>irreducible_def</code> from <a href=\"https://tqft.net/mathlib4files/Tactic/IrreducibleDef\">file#Tactic/IrreducibleDef</a></p>",
        "id": 532088365,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753971760
    },
    {
        "content": "<p>Thanks! The <code>hide_def</code> stuff does seem to solve my use case very well. These definitions made it very easy to tailor the <code>simproc</code> and <code>isConstant</code> definitions to our specific use case too</p>",
        "id": 532371216,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754078621
    },
    {
        "content": "<p>I've just had to add a few other cases so far for e.g. \"variable * constant\" that come up for us. But this was a very natural extension to make, and with multiple macros you can have different tiers of hiding things for use cases</p>",
        "id": 532372275,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754079119
    },
    {
        "content": "<p>I have found now though that in a couple of our cases <code>hide_constants</code> itself can cause the deep recusion error (seemingly when the constants involved are especially large). See for example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/-- Definition of `hide` and `hide_eq` -/</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">`hide` is an opaque version of the identity function.</span>\n<span class=\"sd\">By making it opaque, we prevent the kernel from trying to reduce the argument.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n\n<span class=\"sd\">/-- A proof that `hide` is the identity. Note that this is deliberately *not*</span>\n<span class=\"sd\">a def-eq, since we made `hide` opaque. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">hide_eq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hide</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hide_def</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"sd\">/-- Symmetric version of `hide_eq`. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">eq_hide</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">hide</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">symm</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hide_eq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">simpHide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">SimpM</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">getContext</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">parent?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"bp\">.</span><span class=\"n\">isAppOf</span><span class=\"w\"> </span><span class=\"ss\">``hide</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">LeanMLIR</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"{Lean.crossEmoji}: parent ({parent}) is an application of `hide`\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``hide</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">e</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppOptM</span><span class=\"w\"> </span><span class=\"ss\">``eq_hide</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">done</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">    </span><span class=\"n\">proof?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">proof</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">match_expr</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"bp\">.</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"bp\">.</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- Also try to hide Fin values</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">isRawNatLit</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isConstant</span><span class=\"o\">)</span>\n\n<span class=\"n\">simproc_decl</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">hideOfNatConstants</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">  </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`LeanMLIR.Elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Hiding: {e}\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">isConstant</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"{Lean.crossEmoji}: {x} is not a constant\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"n\">simpHide</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"hide_constants\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">memoize</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">hideOfNatConstants</span><span class=\"o\">]</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"unhide_constants\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hide_eq</span><span class=\"o\">]</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"k\">match</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">1000000</span><span class=\"o\">)))[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">one_pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">hide_constants</span>\n<span class=\"w\">  </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"c1\">-- deep recursion is already caused by just calling `hide_constants`</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">run_bind</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">unhide_constants</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">run_pure</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">run_pure</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">HideConstants</span>\n</code></pre></div>\n<p>Although maybe this is also a problem with having the <code>Fin.val</code> case in general without checking things are full constants. There are at least fewer cases where this bug seems to happen.</p>",
        "id": 532796679,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754340909
    },
    {
        "content": "<p>Actually here's a very simple example I also came across as well. Seems that using <code>n &lt;&lt;&lt; 16</code> is over <code>n * 2^16</code> is pretty necessary:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">match</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">one_add_one_eq_two</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- causes deep recursion error</span>\n</code></pre></div>",
        "id": 532813113,
        "sender_full_name": "Devon Tuma",
        "timestamp": 1754352506
    }
]