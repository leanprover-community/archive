[
    {
        "content": "<p>I updated a project to align with Mathlib @ lean-v4.13.0-rc3 and now I get an error (\"failed to unfold 'formula' ...\") where I didn't before with unfolding a definition:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">formula</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n</code></pre></div>\n<p>The strange thing is I am not getting this error if I use the above snippet in another project with the same Mathlib version. I suspect there might be something with caching in the .lake directory...any pointers?</p>\n<p>Things I've tried which  did not resolve the issue:</p>\n<ul>\n<li>Deleting the .lake directory and executing <code>lake update</code>;</li>\n<li>Placing the above snippet in its own file with no imports;</li>\n</ul>",
        "id": 478387250,
        "sender_full_name": "Craig McLaughlin",
        "timestamp": 1729642760
    },
    {
        "content": "<p>The issue is that <code>unfold</code> now lets you unfold local variables, and it's trying to unfold <code>formula</code> the local variable in <code>formula</code>.</p>\n<p>Here are two different fixes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">formula</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">form</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">form</span>\n</code></pre></div>",
        "id": 478388750,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729643813
    },
    {
        "content": "<p>I would suggest not having local variables that shadow global names</p>",
        "id": 478388809,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729643873
    },
    {
        "content": "<p>Thanks for the report. <a href=\"https://github.com/leanprover/lean4/pull/5815\">lean4#5815</a> has a better error message:</p>\n<p><a href=\"/user_uploads/3121/JCnUEWvrwZYUBw2_6GbkY7mH/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/JCnUEWvrwZYUBw2_6GbkY7mH/image.png\" title=\"image.png\"><img data-original-dimensions=\"1270x220\" src=\"/user_uploads/thumbnail/3121/JCnUEWvrwZYUBw2_6GbkY7mH/image.png/840x560.webp\"></a></div>",
        "id": 478391008,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729645380
    },
    {
        "content": "<p>(I don't know why you are seeing the caching issue)</p>",
        "id": 478391032,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729645400
    },
    {
        "content": "<p>Thanks for the clarification and the quick patch!</p>\n<ol>\n<li>When would there be confusion between the two instances of <code>formula</code> that would prevent Lean from figuring which one is meant from the context? In your pull request the usage is <code>unfold x</code> which I agree could be confusing but surely:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p>is not ambiguous as to which <code>X</code> is meant to be unfolded? I agree in principle that shadowing names is bad practice but I think my actual use case makes the proof easier to read;</p>\n<ol start=\"2\">\n<li>This change to <code>unfold</code> doesn't explain why I only see the error in one development and not the other (Does this point to a separate issue?);</li>\n<li>Is <code>unfold_let</code> now superfluous?</li>\n</ol>",
        "id": 478392307,
        "sender_full_name": "Craig McLaughlin",
        "timestamp": 1729646332
    },
    {
        "content": "<ol>\n<li>It's using the normal name resolution to figure out which <code>X</code> to refer to. I suppose in principle it could use the rule \"only refer to names that come from <em>before</em> the local variable <code>X</code> was defined\" if you do <code>unfold ... at X</code></li>\n<li>Are you doing it from a blank file in each case? Or is there other context?</li>\n<li>Mostly, though <code>unfold_let</code> can interleave unfoldings. With <code>unfold</code> you might need to do <code>unfold x y x</code> for example. In any case, improvements made to <code>dsimp only [x, y]</code> a few versions back makes <code>unfold_let</code> totally superfluous.</li>\n</ol>",
        "id": 478392611,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729646572
    },
    {
        "content": "<ol>\n<li>I assume a binding cannot depend on itself but I don't have a good idea on how difficult that would be to implement (or if it even is of interest to others);</li>\n<li>Yes. In fact, I just did <code>lake new unfold-test</code> and pasted the snippet for <code>X := Nat</code> above into the <code>Basic.lean</code>; I get no error and it unfolds the type <code>X</code> to <code>Nat</code> in the context of the hypothesis <code>X</code> (might be worth noting that the 'Expected Type' section of my Goal buffer still mentions <code>_root_.X</code>);</li>\n<li>Ah, good to know. Thanks!</li>\n</ol>",
        "id": 478393424,
        "sender_full_name": "Craig McLaughlin",
        "timestamp": 1729647099
    },
    {
        "content": "<p>For 2, what's the output of <code>#eval Lean.versionString</code> for both projects?</p>",
        "id": 478395286,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729648495
    },
    {
        "content": "<p>For the projects which do <strong>not</strong> report an error (e.g. <code>unfold-test</code>) this string is \"4.12.0-rc1\" and for the other project which does report an error it is \"4.13.0-rc3\". Which would certainly explain the discrepancy but other things I tried: <code>M-x lean4-show-version</code> and <code>elan show</code> imply all projects are using Lean 4.13.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">unfold</span><span class=\"bp\">-</span><span class=\"n\">test</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"k\">show</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">active</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"c1\">----------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">overridden</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">unfold</span><span class=\"bp\">-</span><span class=\"n\">test</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain'</span><span class=\"o\">)</span>\n<span class=\"bp\">/</span><span class=\"n\">unfold</span><span class=\"bp\">-</span><span class=\"n\">test</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc3</span>\n</code></pre></div>\n<p>How do I switch them to the latest version?</p>",
        "id": 478396278,
        "sender_full_name": "Craig McLaughlin",
        "timestamp": 1729649218
    },
    {
        "content": "<p>I didn't exactly follow what's going on above, but 99% of the time the way to change the version being used it to directly edit <code>lean-toolchain</code>.</p>",
        "id": 478451326,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729675775
    },
    {
        "content": "<p>That's what the <code>cat</code> command was for in the above code snippet; I've edited <code>lean-toolchain</code> to the <code>v4.13.0-rc3</code> release. Then I called <code>lake update</code> but nothing has changed (I still do not get the expected error, and the eval command produces the wrong compiler version). What is the other 1%? Or can you think of any other step I might have missed?</p>",
        "id": 478599595,
        "sender_full_name": "Craig McLaughlin",
        "timestamp": 1729726273
    },
    {
        "content": "<p>Are you downstream of Mathlib?</p>",
        "id": 478637580,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729749462
    },
    {
        "content": "<p>If so, running <code>lake update</code> will have the effect of overwriting your <code>lean-toolchain</code> with the <code>lean-toolchain</code> from Mathlib.</p>",
        "id": 478637607,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729749480
    },
    {
        "content": "<p>So in this case you need to edit your lakefile to tell it to use a commit of Mathlib which is on <code>v4.13.0-rc3</code>.</p>",
        "id": 478637684,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729749515
    },
    {
        "content": "<p>But if this is what is affecting you, you should be able to see that by checking if <code>lean-toolchain</code> changed after running <code>lake update</code>.</p>",
        "id": 478637707,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729749541
    }
]