[
    {
        "content": "<p>I would like to write a command that takes a sequence of commands and parses them all.  However, I am failing.  Below is an example of something that goes wrong -- I do not know if there are more issues, but this is certainly stumping me!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"elab_two \"</span><span class=\"w\"> </span><span class=\"n\">cmd1</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">cmd2</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd1</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd2</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">infixr</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"w\"> </span><span class=\"s2\">\" plus \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"c1\">-- 5</span>\n<span class=\"kn\">end</span>\n\n<span class=\"n\">elab_two</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"c1\">--  it looks like the `open Nat` is not actually persisted open...</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">function expected at</span>\n<span class=\"cm\">  2</span>\n<span class=\"cm\">term has type</span>\n<span class=\"cm\">  ?m.2032</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 449683073,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720369254
    },
    {
        "content": "<p><code>open Nat</code> makes your parser visible, but the entire <code>elab_two</code> command has already been parsed - it's too late</p>",
        "id": 449684251,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1720369707
    },
    {
        "content": "<p>Ah, at least now I understand the issue!</p>",
        "id": 449684388,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720369796
    },
    {
        "content": "<p>Is there a fix?</p>",
        "id": 449684396,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720369801
    },
    {
        "content": "<p>Not really, at least in general. At some point, command elaborators may be allowed to do their own parsing, which would be useful for Verso as well.</p>",
        "id": 449684849,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1720370088
    },
    {
        "content": "<p>Ok, I'll see what I can do, thanks!</p>",
        "id": 449685118,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720370302
    }
]