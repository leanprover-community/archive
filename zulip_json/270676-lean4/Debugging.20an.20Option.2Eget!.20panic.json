[
    {
        "content": "<p>On <code>[e2e468c](https://github.com/leanprover-community/mathlib4/pull/30658/commits/e2e468ce936152145e3765ed4461c0b2b1754d5a)</code> (extending the <code>commandStart</code> linter, in-progress), there is a linter panic in many files, which look very similar to the following:</p>\n<p>I understand this is due to calling <code>Option.get!</code> on a none value --- but how would I debug which call is causing this? The backtrace appears very unhelpful.</p>",
        "id": 563716958,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765752917
    },
    {
        "content": "<p>Here is the error message: <a href=\"/user_uploads/3121/flinjv5oQO-86MkPL05o29oV/PastedText.txt\">PastedText.txt</a></p>",
        "id": 563716961,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765752927
    },
    {
        "content": "<p>(The error is almost sure a linter bug: but being unable to debug it without magic skills is not ideal :-))</p>",
        "id": 563716989,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765752973
    },
    {
        "content": "<p>it's debuggin time</p>",
        "id": 563718281,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765754745
    },
    {
        "content": "<p>I would set <code>export LEAN_ABORT_ON_PANIC=1</code> and then run whatever file is causing the issue with <code>lake lean path/to/file.lean</code>. You should then get a backtrace that looks something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.18.0-rc1/lib/lean/libleanshared.so(+0x738ab82) [0x7f781dd8ab82]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.18.0-rc1/lib/lean/libleanshared.so(lean_panic+0x4e) [0x7f781dd8a9ee]</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.18.0-rc1/lib/lean/libleanshared.so(lean_panic_fn+0x15) [0x7f781dd8ac15]</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>which hopefully points closer to the caller. Note however that because mathlib is not using native compilation for it's system (for good reasons) you might end up receiving essentially a lot of stack frames that only talk about the interpreter which will likely not help you. If that happens I would probably start adding debug traces along the program and try to bisect my way to the failure by observing which ones print before the abort and which ones do not.</p>\n<p>It's a bit unfortunate that we currently do not have nice debugging tools for the interpreter and likely also will not in the near term future :/</p>",
        "id": 563718344,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765754821
    },
    {
        "content": "<p>none of the top 22 lines of the trace have any function names, except for <code>lean_panic_fn</code></p>",
        "id": 563718444,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765754953
    },
    {
        "content": "<p>and below that is just the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.runLinters#doc\">docs#Lean.Elab.Command.runLinters</a></p>",
        "id": 563718475,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765754990
    },
    {
        "content": "<p>I picked one instance of the panic to debug (<a href=\"https://github.com/leanprover-community/mathlib4/blob/e2e468ce936152145e3765ed4461c0b2b1754d5a/Mathlib/Algebra/Group/Submonoid/Operations.lean#L622\">here</a>) and the panic is in <code>_private.Mathlib.Tactic.Linter.CommandStart.0.Mathlib.Linter.generateCorrespondence</code></p>",
        "id": 563723768,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765761697
    },
    {
        "content": "<p>it's because it's trying to get the trailing whitespace of synthetic syntax</p>",
        "id": 563728311,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765767667
    },
    {
        "content": "<p>which doesn't exist so it panics</p>",
        "id": 563728315,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765767672
    }
]