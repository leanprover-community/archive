[
    {
        "content": "<p>When building <a href=\"https://github.com/fpvandoorn/carleson/pull/234\">fpvandoorn/carleson#234</a> locally by opening <code>Carleson.ForestOperator.Forests</code>, I get the error that lake failed when building <code>Carleson.ToMathlib.Data.Set.Lattice</code> with the error that the flag <code>-Dlinter.flexible</code> doesn't exists. However, this flag is defined in a very low-level Mathlib file, and when opening <code>Carleson.ToMathlib.Data.Set.Lattice</code> in VSCode it builds fine.</p>\n<p>Any idea what is going on here?</p>",
        "id": 499297525,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739383668
    },
    {
        "content": "<p>Github CI has the same error message:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>âœ– [2347/2409] Building Carleson.ToMathlib.Data.Set.Lattice\ntrace: .&gt; LEAN_PATH=././.lake/packages/Cli/.lake/build/lib:././.lake/packages/batteries/.lake/build/lib:././.lake/packages/Qq/.lake/build/lib:././.lake/packages/aesop/.lake/build/lib:././.lake/packages/proofwidgets/.lake/build/lib:././.lake/packages/importGraph/.lake/build/lib:././.lake/packages/LeanSearchClient/.lake/build/lib:././.lake/packages/plausible/.lake/build/lib:././.lake/packages/mathlib/.lake/build/lib:././.lake/packages/checkdecls/.lake/build/lib:././.lake/build/lib LD_LIBRARY_PATH= /home/runner/.elan/toolchains/leanprover--lean4---v4.17.0-rc1/bin/lean -DrelaxedAutoImplicit=false -Dpp.unicode.fun=true -DautoImplicit=false -Dlinter.style.longLine=false -Dlinter.style.multiGoal=true -Dlinter.oldObtain=true -Dlinter.refine=true -Dlinter.flexible=true -Dpp.unicode.fun=true -DautoImplicit=false -DrelaxedAutoImplicit=false ././././Carleson/ToMathlib/Data/Set/Lattice.lean -R ./././. -o ././.lake/build/lib/Carleson/ToMathlib/Data/Set/Lattice.olean -i ././.lake/build/lib/Carleson/ToMathlib/Data/Set/Lattice.ilean -c ././.lake/build/ir/Carleson/ToMathlib/Data/Set/Lattice.c --json\nerror: &lt;input&gt;:1:0: invalid -D parameter, unknown configuration option 'linter.flexible'\n\nIf the option is defined in this library, use '-Dweak.linter.flexible' to set it conditionally\nerror: Lean exited with code 1\n</code></pre></div>",
        "id": 499298115,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739383871
    },
    {
        "content": "<p>I wrote the linter, but I do not see any reason why this linter option should be any different than all the other linter options...</p>",
        "id": 499298156,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739383888
    },
    {
        "content": "<p>Note that this configuration option is fine for any other file/import.</p>",
        "id": 499298192,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739383906
    },
    {
        "content": "<p>This sounds like a lake issue, not anything related to this linter.</p>",
        "id": 499298243,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739383922
    },
    {
        "content": "<p>I reproduced locally, and then confirmed the command lake outputted also reproduced without lake (which I guess on its own doesn't mean anything, in theory the bug could be lake building something out of order I guess?) but now I <code>rm -r .lake</code>'d and can't reproduce a second time quite yet, even after deleting the Mathlib cache entirely... EDIT: oh, never mind, I'm a dum dum, the reason I couldn't reproduce a second time is because I added <code>import Mathlib.Tactic.Linter.FlexibleLinter</code> to the file to confirm that fixes it, and didn't save the file to remove it :/</p>",
        "id": 499307845,
        "sender_full_name": "Julian Berman",
        "timestamp": 1739387177
    },
    {
        "content": "<p>Oh, so is the issue is that the file I import, <code>Mathlib.Data.Set.Lattice</code> doesn't import <code>Mathlib.Tactic.Linter.FlexibleLinter</code>?</p>",
        "id": 499311911,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739388424
    },
    {
        "content": "<p>I guess this is a Mathlib issue in the import structure.<br>\nWhy does <code>Mathlib.Init</code> not import <code>Mathlib.Tactic.Linter</code> (or all linters)?<br>\nIt still seems undesirable that when setting a configuration option in the lakefile, you cannot have files in your project that do not import the file declaring that option.</p>",
        "id": 499312443,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739388592
    },
    {
        "content": "<p>I can confirm the mismatch: <code>Mathlib.Tactic.Linter.FlexibleLinter</code> is imported in <code>Mathlib.Tactic</code> (or <code>Mathlib.Tactic.Linter</code> or <code>Mathlib.lean</code>) --- but unlike the other syntax linters mathlib enables by default, it is <em>not</em> imported in Mathlib.Init. (I was wrong a moment ago, Floris. Sorry.)</p>\n<p>This means it is possible to have a mathlib file which does not import this linter.</p>",
        "id": 499315084,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739389407
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> What do you think of importing it in Mathlib.Init as well? If downstream projects want to use it (and I tried so in carleson, on the grounds that it wasn't too onerous once you fixed all initial violations), we should remove such footguns.</p>",
        "id": 499315240,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739389448
    },
    {
        "content": "<p>I believe that would be the right fix: created <a href=\"https://github.com/leanprover-community/mathlib4/pull/21794\">#21794</a></p>",
        "id": 499316756,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739389996
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> If you want to make sure: does bumping mathlib to <a href=\"https://github.com/leanprover-community/mathlib4/tree/MR-import-flexible\">branch#MR-import-flexible</a> fix the CI errors in <a href=\"https://florisvandoorn.com/carleson/docs/find/?pattern=234%3F#doc\">carleson#234?</a></p>",
        "id": 499316851,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739390035
    },
    {
        "content": "<p>I'm not at a computer, but I'm trying to understand the issue.  Is this a problem that pertains to any option?  And the problem is when a downstream project imports a file that, due to its import structure, does not import the option?</p>",
        "id": 499326051,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739393391
    },
    {
        "content": "<p>If so, should we enforce that all options are imported in Marhlib.Init?</p>",
        "id": 499326157,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739393421
    },
    {
        "content": "<p>That sounds slightly odd to me personally as a general solution (with the usual caveat that I don't know how this works in detail). But why should every downstream user importing an early file in Mathlib's hierarchy pay the cost of importing extra stuff (if they <em>aren't</em> trying to use the linters). It would seem more like something the downstream project should have to enable (i.e. import all the linters if they want them). Concretely, I think I'd personally expect <code>import Mathlib.Some.Early.File</code> to not <em>say</em> what linters it promises to import (and leave this be an implementation detail of Mathlib on which linters it wants to run on its own files), and then any downstream project which really does want to use all of the linters should have to explicitly <code>import Mathlib.Linters</code> somewhere early in its own import hierarchy to enable all of Mathlib's linters at its own build time.</p>",
        "id": 499330623,
        "sender_full_name": "Julian Berman",
        "timestamp": 1739395153
    },
    {
        "content": "<p>(The caveat on not knowing how this currently works is doing a lot in that sentence, because my expectation I think applies equally well to any other thing which isn't a linter, say some random module in Mathlib that isn't needed always, I'd have the same expectation that importing something I need from <code>Mathlib.Somewhere</code> doesn't automatically give me lots of extra stuff if its not needed for the import I did -- and maybe this already isn't the case for things other than linters)</p>",
        "id": 499331046,
        "sender_full_name": "Julian Berman",
        "timestamp": 1739395335
    },
    {
        "content": "<p>maybe having an undefined option set in some file should be a (silenceable) warning instead?</p>",
        "id": 499331159,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739395382
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20doesn't.20find.20option/near/499326051\">said</a>:</p>\n<blockquote>\n<p>I'm not at a computer, but I'm trying to understand the issue.  Is this a problem that pertains to any option?  And the problem is when a downstream project imports a file that, due to its import structure, does not import the option?</p>\n</blockquote>\n<p>Yes, in principle this applies to any option. More precisely, AIUI the issue is</p>\n<ul>\n<li>the Carleson project sets <code>linter.flexible true</code> in its lakefile</li>\n<li>some file <code>Carleson.FooBar</code> does not transitively import the flexible linter</li>\n<li>compiling this file errors, with an error about that option being unknown</li>\n</ul>",
        "id": 499338477,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739398427
    },
    {
        "content": "<p>I'm still trying to form an opinion on what I think is a good setup for this.</p>\n<p>It seems that right now, if project <code>A</code> defines an option, then any project depending on <code>A</code> can either</p>\n<ul>\n<li>align with the default choice of <code>A</code> on the option and everything is fine;</li>\n<li>decide that it wants a different default value for the option, in which case it must take care of importing the option in all its files.</li>\n</ul>",
        "id": 499375496,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739419856
    },
    {
        "content": "<p>I think that projects setting their own default values for options in projects on which they depend should not be required to import the option everywhere.  At the same time, it seems also like a convenient diagnostic tool to have the ability to find out if this is the case.</p>",
        "id": 499375500,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739419860
    },
    {
        "content": "<p>This example is a good use-case: Carleson wants to use the linter.  It is reasonable that some Mathlib file does not import the linter and that Carleson could import that file and nothing else.</p>",
        "id": 499375646,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739419941
    },
    {
        "content": "<p>It is also reasonable that Carleson would like to know that the option that Carleson wants to be true is actually false in that file.</p>",
        "id": 499375717,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739419994
    },
    {
        "content": "<p>Saying this another way, if Carleson wanted to turn on the linter only on files that import it, but be content with mathlib's choice for the other files, this would require doing more than setting the option in the lakefile, which seems a little counterintuitive to me.</p>",
        "id": 499376116,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739420261
    },
    {
        "content": "<p>Doesn't <code>weak</code> do exactly what you're asking for?</p>",
        "id": 499392657,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739430494
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20doesn't.20find.20option/near/499376116\">said</a>:</p>\n<blockquote>\n<p>Saying this another way, if Carleson wanted to turn on the linter only on files that import it, but be content with mathlib's choice for the other files, this would require doing more than setting the option in the lakefile, which seems a little counterintuitive to me.</p>\n</blockquote>\n<p>I must admit that I find this a strange choice. To me, enabling a linter in a lakefile says \"I want this linter enabled everywhere\". Getting an error \"I don't know this option\" or silently disabling this linter in some files is surprising.</p>\n<p>I would call this a bug in mathlib: if a linter can reasonably be enabled downstream, it should be available there (i.e. imported in Mathlib.Init).</p>",
        "id": 499424682,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739439710
    },
    {
        "content": "<p>i guess a middle ground might be: if you want to enable a linter in your lakefile, make a project-wide <code>Init.lean</code> file which imports said linter (or at least linter option) and make sure your project always has that file imported.</p>",
        "id": 499425881,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739440039
    },
    {
        "content": "<p>still, i think throwing an error over setting an unknown option is a bit overkill</p>",
        "id": 499426089,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739440095
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20doesn't.20find.20option/near/499392657\">said</a>:</p>\n<blockquote>\n<p>Doesn't <code>weak</code> do exactly what you're asking for?</p>\n</blockquote>\n<p>(spoiler: my understanding was wrong)</p>\n<p>As i understand it, <code>weak</code> means set this option, but not in downstream projects. that doesn't mean that it won't complain when the option is set but is not imported</p>",
        "id": 499426898,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739440334
    },
    {
        "content": "<p>I thought that Sebastian's suggestion was to set the <code>weak</code> option in the <em>downstream</em> project.</p>",
        "id": 499429199,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739440938
    },
    {
        "content": "<p>yes, but as i understand it, if an option is <code>weak</code> or not only matters for projects downstream of the one that sets it?</p>",
        "id": 499429430,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739441002
    },
    {
        "content": "<p>so changing how Carleson sets the option won't have an effect on Carleson</p>",
        "id": 499429519,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739441028
    },
    {
        "content": "<p>(if my understanding is correct)</p>",
        "id": 499429545,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739441039
    },
    {
        "content": "<p>I think that <code>weak</code> means \"if you find the option, set it, otherwise do nothing\".</p>",
        "id": 499429905,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739441126
    },
    {
        "content": "<p>ah...</p>",
        "id": 499431375,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739441523
    },
    {
        "content": "<p>looking into it, <a href=\"https://github.com/leanprover/lean4/pull/4741\">lean4#4741</a> seems to be the adding of weak options, and indeed it does what you describe</p>",
        "id": 499431657,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739441600
    },
    {
        "content": "<p>I tested locally and <a href=\"https://github.com/fpvandoorn/carleson/pull/235\">fpvandoorn/carleson#235</a> seems to work as intended.</p>",
        "id": 499459709,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739449674
    },
    {
        "content": "<p>Just to be explicit:</p>\n<ul>\n<li>if you import transitively the flexible linter, the PR above should not change anything;</li>\n<li>if you do not import the flexible linter, then neither CI nor VSCode raise an error.</li>\n</ul>",
        "id": 499460065,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739449754
    },
    {
        "content": "<p>At least, this is what I observed on my computer.</p>",
        "id": 499460091,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739449763
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 499494945,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739458737
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> the error message currently states \"If the option is defined in this library, use '-Dweak.linter.flexible' to set it conditionally\". Can this be changed to something like \"If the option is defined in a file that is not always imported (e.g. it is defined in this library), use '-Dweak.linter.flexible' to set it conditionally\"?</p>",
        "id": 499494960,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739458741
    },
    {
        "content": "<p>I'd accept that PR :)</p>",
        "id": 499550197,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739471350
    },
    {
        "content": "<blockquote>\n<p>Can this be changed to something like \"If the option is defined in a file that is not always imported (e.g. it is defined in this library), use '-Dweak.linter.flexible' to set it conditionally\"?</p>\n</blockquote>\n<p>I realize this is quite minor of a scenario so feel free to ignore, but I still don't really understand why that's behavior someone should want. Taking this specific example -- If you want the <code>flexible</code> linter turned on on your project it's because you're trying to make sure you don't have files that use overpowered tactics, right? Why would you want to silently not run that linter in some cases? Either you want that check on your project's files or not? And it doesn't seem sufficient to rely on where in Mathlib's import hierarchy it gets imported -- for a general case option, it seems like a possible scenario is that Mathlib imports it at stage X in its hierarchy because its implementation requires something from stage X, but that that option makes perfect sense to run on files at stage X-1 or before, so if you're downstream of Mathlib, using <code>weak</code> seems suspect to me (-- so making the error message nudge people towards it also seems a bit weird).</p>",
        "id": 499554767,
        "sender_full_name": "Julian Berman",
        "timestamp": 1739472610
    }
]