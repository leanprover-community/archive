[
    {
        "content": "<p>I can't get persistent env extensions working. The following procedure used to work in maybe Lean <code>v4.7.0</code> or earlier, but I only get an empty output now.</p>\n<p>In the first file, I define the env extension (not sure if <code>.sync</code> is correct):</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>File1.lean: define the env extension</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">myExt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimplePersistentEnvExtension</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerSimplePersistentEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`my_keys</span>\n<span class=\"w\">    </span><span class=\"n\">asyncMode</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sync</span>\n<span class=\"w\">    </span><span class=\"n\">addEntryFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">push</span>\n<span class=\"w\">    </span><span class=\"n\">addImportedFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n</div></div>\n<p>Then in a second file I want to add something to the extension:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>File2.lean: add something to the env extension</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">MyModule</span><span class=\"bp\">.</span><span class=\"n\">File1</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test1</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myExt</span><span class=\"bp\">.</span><span class=\"n\">addEntry</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"s2\">\"test1\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test1</span>\n</code></pre></div>\n</div></div>\n<p>Finally I call <code>lake build MyModule.File2</code> to ensure the <code>.oleans</code> have been and try to use <code>withImportModules</code> in a third file to access the state at file 2:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>File3.lean: use withImportModules to access the env at the version of File2</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">MyModule</span><span class=\"bp\">.</span><span class=\"n\">File1</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- unsafe Lean.enableInitializersExecution        -- saw this somewhere?</span>\n<span class=\"w\">  </span><span class=\"c1\">-- searchPathRef.set compile_time_search_path%    -- old code?</span>\n<span class=\"w\">  </span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`MyModule.File2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myExt</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"c1\">-- got [], expected [\"test1\"]</span>\n</code></pre></div>\n</div></div>\n<p>But I get <code>[]</code> instead of <code> [\"test1\"]</code>. What am I missing here?</p>\n<p>(For context, the command <code>lake exe i18n -t</code> at <a href=\"https://github.com/hhu-adam/lean-i18n\">lean-i18n</a> is completely broken. It used to export all translation keys which are stored in this env extension, so file 2 is intended to be the main module, like <code>Mathlib.lean</code>)</p>",
        "id": 541516619,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758823327
    },
    {
        "content": "<p>I had a similar problem, where using a version of <code>withImportModules</code> that calls <code>importModules</code> with <code>loadExts</code> set to true solved it. Didn't test this on your MWE though <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 541517685,
        "sender_full_name": "Yves Jäckle",
        "timestamp": 1758823680
    },
    {
        "content": "<p>From the doc-string of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.withImportModules#doc\">docs#Lean.withImportModules</a>:</p>\n<blockquote>\n<p>Creates environment object from imports and frees compacted regions after calling <code>act</code>. No live references to the environment object or imported objects may exist after <code>act</code> finishes. As this cannot be ruled out after loading environment extensions, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.importModules#doc\">docs#Lean.importModules</a>​'s <code>loadExts</code> <strong>is always unset</strong> using this function.</p>\n</blockquote>\n<p>and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.importModules#doc\">docs#Lean.importModules</a>:</p>\n<blockquote>\n<p>[...] If <code>loadExts</code> is true, we initialize the environment extensions using the imported data [...]</p>\n</blockquote>\n<p>In other words, <code>withImportModules</code> doesn't load extension data because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.freeRegions#doc\">docs#Lean.Environment.freeRegions</a> isn't safe when using extension data</p>",
        "id": 541518455,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758823924
    },
    {
        "content": "<p>You'll have to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.importModules#doc\">docs#Lean.importModules</a> directly</p>",
        "id": 541518501,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758823939
    },
    {
        "content": "<p>(For what it’s worth, the PR which changed this behavior was <a href=\"https://github.com/leanprover/lean4/pull/6325\">lean4#6325</a>; see also the notes on breaking changes in that PR’s diff.)</p>",
        "id": 541519235,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758824212
    },
    {
        "content": "<p>Ah I see, thanks for the pointers and the link to the PR!</p>",
        "id": 541523386,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758825682
    },
    {
        "content": "<p>So just to be explicit, I just change the mentioned flag</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- same as `Lean.withImportModules` but with `(loadExts := true)`. -/</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyModule</span><span class=\"bp\">.</span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Import</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"n\">trustLevel</span>\n<span class=\"w\">  </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">finally</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">freeRegions</span>\n</code></pre></div>\n<p>add a random <code>unsafe Lean.enableInitializersExecution</code> before its usage and happily accept it's working, without thinking much about the details or consequences...? Seems fine by me :D</p>",
        "id": 541524942,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758826240
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> as you encountered this question for the lint-style options</p>",
        "id": 541553661,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1758839483
    },
    {
        "content": "<p>TL;DR There may be a more robust way</p>",
        "id": 541553721,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1758839525
    },
    {
        "content": "<p>The <code>importModules (loadExts := true)</code> approach seems to work fine but I did not trust that I understood the implications for garbage collection. So I ended up writing an elaborator that inserts the current state of the env extension as an expression.</p>",
        "id": 541604464,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1758872913
    },
    {
        "content": "<p>But now I can't find that code actually, it has not been merged and it is not in one of my open PRs either. Where did I put that? <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 541604596,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1758872949
    },
    {
        "content": "<p>Ah, I totally missed that the last commit in <a href=\"https://github.com/leanprover-community/mathlib4/pull/29513\">#29513</a> got eaten. Fixed now! (Thanks to <code>git reflog</code> for finding it.)</p>",
        "id": 541606336,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1758873568
    }
]