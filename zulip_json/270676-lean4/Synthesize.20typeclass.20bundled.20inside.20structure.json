[
    {
        "content": "<p>Consider the following mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">bundle</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">instC</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span>\n\n<span class=\"c1\">-- this works fine, but can be cumbersome with a few typeclasses</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bundle</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">instC</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- failed to synthesize C</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bundle</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Completely possible this is an <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> question, the context is my question here: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/Category.20of.20Cartesian.20closed.20categories\">#mathlib4 &gt; Category of Cartesian closed categories</a></p>",
        "id": 474670722,
        "sender_full_name": "Chris Henson",
        "timestamp": 1727985453
    },
    {
        "content": "<p><code>attribute [instance] bundle.C</code> might fix it</p>",
        "id": 474965911,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728122306
    },
    {
        "content": "<p>Though I think this is overly minimized; in your real example, does <code>instC</code> reference other fields of <code>bundle</code>?</p>",
        "id": 474965957,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728122374
    },
    {
        "content": "<p>That does seem to work. This is the direction I was headed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"w\"> </span><span class=\"n\">Limits</span><span class=\"w\"> </span><span class=\"n\">CartesianClosed</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"n\">instCategory</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">obj</span>\n<span class=\"w\">  </span><span class=\"n\">instHasFiniteProducts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasFiniteProducts</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">obj</span>\n<span class=\"w\">  </span><span class=\"n\">instCartesianClosed</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CartesianClosed</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">obj</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"bp\">.</span><span class=\"n\">instCategory</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"bp\">.</span><span class=\"n\">instHasFiniteProducts</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"bp\">.</span><span class=\"n\">instCartesianClosed</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CCHom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"bp\">тед</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"bp\">.</span><span class=\"n\">obj</span>\n<span class=\"w\">  </span><span class=\"n\">instPreservesLimitsOfShape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PreservesLimitsOfShape</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Discrete</span><span class=\"w\"> </span><span class=\"n\">WalkingPair</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">F</span>\n<span class=\"w\">  </span><span class=\"n\">instCartesianClosedFunctor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CartesianClosedFunctor</span><span class=\"w\"> </span><span class=\"n\">F</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">CCCat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Hom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CCHom</span>\n<span class=\"w\">  </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">id_comp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">comp_id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 474971967,
        "sender_full_name": "Chris Henson",
        "timestamp": 1728127306
    },
    {
        "content": "<p>That looks correct to me</p>",
        "id": 474972826,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728127566
    },
    {
        "content": "<p>The key thing is that for <code>attribute [instance] Foo.bar</code> to be reasonable, you need <code>Foo.bar (f : Foo) : SomeClass (X f)</code>, so that the instance is keyed on the type of <code>f</code></p>",
        "id": 474973024,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728127630
    },
    {
        "content": "<p>Makes sense, I see that <code>instance (C : CCCat) : Category C.obj := C.instCategory</code> etc. also works</p>",
        "id": 474973818,
        "sender_full_name": "Chris Henson",
        "timestamp": 1728128209
    },
    {
        "content": "<p>That's not quite as good because now you have two names for the same thing!</p>",
        "id": 475127365,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728240833
    },
    {
        "content": "<p>Yeah yours is better, that's what I went with! <code>attribute</code> is very nice in giving more direct control over what is (or isn't) an instance.</p>",
        "id": 475128139,
        "sender_full_name": "Chris Henson",
        "timestamp": 1728241326
    }
]