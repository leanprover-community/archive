[
    {
        "content": "<p>Here is something that surprised me.</p>\n<p>How do you think that the pretty-printer prints these?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"\"</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{1}\"</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Answer</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: #check s!\"\"</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: #check s! \"{1}\"</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{1}\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s2</span>\n</code></pre></div>\n</div></div>",
        "id": 527761076,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752003398
    },
    {
        "content": "<p>I guess this is because <code>s!</code> takes a <code>term &lt;|&gt; interpolatedStr(term)</code> and so they may be handled differently</p>",
        "id": 527767981,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752006614
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"mys!\"</span><span class=\"w\"> </span><span class=\"n\">interpStr</span><span class=\"o\">:</span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">interpStr</span><span class=\"bp\">.</span><span class=\"n\">expandInterpolatedStr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"o\">))</span>\n\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mys!</span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mys!</span><span class=\"s2\">\"{1}\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s2</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">mys!</span><span class=\"s2\">\"\"</span>\n<span class=\"n\">mys!</span><span class=\"w\"> </span><span class=\"s2\">\"{1}\"</span>\n</code></pre></div>",
        "id": 527783128,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752015580
    },
    {
        "content": "<p>Input:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"!\"</span><span class=\"w\"> </span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"s2\">\"{1}\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"s2\">\"{1}\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s2</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"s2\">\"{1}\"</span>\n<span class=\"bp\">!</span><span class=\"s2\">\"{1}\"</span>\n</code></pre></div>",
        "id": 527785593,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752017626
    },
    {
        "content": "<p>I guess <code>s!</code> is a valid identifier</p>",
        "id": 527785628,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752017668
    },
    {
        "content": "<p>Is it something to do with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Formatter.State.leadWordIdent#doc\">docs#Lean.PrettyPrinter.Formatter.State.leadWordIdent</a> ?</p>",
        "id": 527785650,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752017691
    },
    {
        "content": "<p>I think it's this line <a href=\"https://github.com/leanprover/lean4/blob/7c3ca70e29a0806bd4bfc62eae7084bbaf1a303d/src/Lean/PrettyPrinter/Formatter.lean#L386\">https://github.com/leanprover/lean4/blob/7c3ca70e29a0806bd4bfc62eae7084bbaf1a303d/src/Lean/PrettyPrinter/Formatter.lean#L386</a></p>",
        "id": 527787324,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752018981
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t!\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t!</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 527787429,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752019067
    },
    {
        "content": "<p><code>t!fun</code>, <code>t!1</code>, and <code>t!_</code> are valid identifiers, so spaces are inserted</p>",
        "id": 527787500,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752019111
    },
    {
        "content": "<p>Thank you all for your comments!  I do not know if I understand better or worse what is going on now. <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 527816887,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752043052
    },
    {
        "content": "<p>Here is another:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"mi\">0</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Pretty printed</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">info: let a := 0;</span>\n<span class=\"sd\">0</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: let(a) := 0;</span>\n<span class=\"sd\">0</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`a</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s2</span>\n</code></pre></div>\n</div></div>",
        "id": 527821644,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752045374
    },
    {
        "content": "<p>I think this is the same idea: <code>leta</code> would be seen as a single identifier, so a space is inserted</p>",
        "id": 527822900,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752045910
    },
    {
        "content": "<p>I agree, I think that the other is the weird one, though.</p>",
        "id": 527822953,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752045937
    },
    {
        "content": "<p>I agree, I think what happens is that somehow the tokenFn consumes beyond <code>s!</code> in <code>s!\"{</code>, or maybe it's some other corner case that I didn't identify</p>",
        "id": 527823196,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752046027
    },
    {
        "content": "<p>(I don't have time to look into the details)</p>",
        "id": 527823269,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752046056
    },
    {
        "content": "<p>maybe we can use <code>ppSpace</code> in <code>let</code> and <code>noWs</code> in <code>s!</code> to eliminate the differences in behavior</p>",
        "id": 527823449,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752046128
    },
    {
        "content": "<p>I agree that adding a <code>ppSpace</code> for <code>let</code> is probably a good solution.  I am not so sure about <code>noWs</code> in the other case, though.</p>",
        "id": 527825366,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752046862
    },
    {
        "content": "<p>I am not familiar with parsers in Lean, perhaps there is a much better solution</p>",
        "id": 527825530,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1752046922
    },
    {
        "content": "<p><code>noWs</code> is not just a pretty printer thing, it makes it a parse error to add a space which we probably don't want</p>",
        "id": 527912360,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752074358
    },
    {
        "content": "<p>is there a <code>ppNoWs</code>?</p>",
        "id": 527916319,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075494
    },
    {
        "content": "<p>that's just the default</p>",
        "id": 527917380,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752075860
    },
    {
        "content": "<p>spaces between tokens are never inserted unless they would be required by the lexer</p>",
        "id": 527917487,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752075893
    },
    {
        "content": "<p>Right now, I am developing a version of the <code>commandStart</code> that seems to be correctly identifying whitespace issues on the vast majority of mathlib.</p>",
        "id": 527917752,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752075981
    },
    {
        "content": "<p>The main nodes that I have to silence are tactics such as <code>apply</code> and <code>replace</code> that, when followed by <code>(</code> get pretty-printed without a space.</p>",
        "id": 527917917,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752076033
    },
    {
        "content": "<p>those are all pretty printer bugs</p>",
        "id": 527917956,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752076046
    },
    {
        "content": "<p>people don't use <code>ppSpace</code> as much as they should</p>",
        "id": 527918000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752076062
    },
    {
        "content": "<p>If this could be fixed, then I think that most of the rest of the issues would be actually undetermined, so there could be a linter for whitespace on virtually <em>everything</em> in mathlib.</p>",
        "id": 527918087,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752076090
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/pretty-printing.20puzzle/near/527918000\">said</a>:</p>\n<blockquote>\n<p>people don't use <code>ppSpace</code> as much as they should</p>\n</blockquote>\n<p>I agree and it looks like that is the major obstacle for trusting the pretty-printer from being a formatter.</p>",
        "id": 527918216,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752076139
    },
    {
        "content": "<p>well no, I think the high level layout algorithm is not optimal for a formatter</p>",
        "id": 527918368,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752076190
    },
    {
        "content": "<p>Ah, I keep forgetting: the linter trusts line-breaks in the source, but spaces in the pretty-printer.</p>",
        "id": 527918452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752076221
    }
]