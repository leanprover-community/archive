[
    {
        "content": "<p>I was recently in a situation where it would have been convenient to attach a precedence to a syntax abbreviation like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">my_stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">str</span>\n</code></pre></div>\n<p>However, Lean only allows abbreviations without precedence:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">my_stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">str</span>\n</code></pre></div>\n<p>This seems to be because unlike <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ParserDescr.node#doc\">docs#Lean.ParserDescr.node</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ParserDescr.nodeWithAntiquot#doc\">docs#Lean.ParserDescr.nodeWithAntiquot</a> does not come with an argument representing precedence.</p>\n<p>A possible workaround for this is to declare a new syntax category for the abbreviation and assign precendences while declaring the syntax that belongs to this category, but this feels a bit clunky.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">my_stx</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">my_stx</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">my_stx</span>\n</code></pre></div>\n<p>Would precedences in <code>nodeWithAntiquot</code> parsers be a useful feature to have, or might it interfere with the existing parsing framework?</p>",
        "id": 454794275,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1722250432
    },
    {
        "content": "<p>Could you say more about the use case?</p>",
        "id": 455107724,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722341055
    },
    {
        "content": "<p>The use-case was in creating a DSL for a mini programming language.<br>\nWe wanted to support <code>let</code> declarations like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">line</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"let\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">line</span>\n</code></pre></div>\n<p>but ran into the issue of precedences for <code>value</code>s<br>\n(so for instance, <code>let x := 1 + 2;</code> would not be parsed correctly unless <code>1 + 2</code> is parsed before the rest of the declaration)</p>\n<p>The <code>value</code> type is defined as an abbreviation for the union of a few other types </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">ident</span>\n</code></pre></div>\n<p>so setting a precedence for it is not directly possible.</p>",
        "id": 455191792,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1722364331
    },
    {
        "content": "<p>I was about to follow up my previous message with an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>, but strangely, I'm having trouble reproducing the error now! It looks like the syntax for abbreviation works just fine now.</p>",
        "id": 455192002,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1722364412
    }
]