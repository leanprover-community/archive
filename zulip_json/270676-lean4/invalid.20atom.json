[
    {
        "content": "<p>I‚Äôm trying to bump the Lean version of Verbose Lean from <code>4.10.0</code> to <code>4.15.0-rc1</code> and the code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">providersDescr</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">providersField</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\": [\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n</code></pre></div>\n<p>now triggers an <code>invalid atom</code> error. Any idea what‚Äôs going on?</p>",
        "id": 491331526,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735594119
    },
    {
        "content": "<p>quick fuzzing seems to suggest the issue is that there is a space in the string?</p>",
        "id": 491331583,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594181
    },
    {
        "content": "<p>perhaps a feasible workaround is instead using <code>\":\"\"[\"</code></p>",
        "id": 491331673,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594223
    },
    {
        "content": "<p>possibly along with some parsers making sure there is no linebreak inbetween</p>",
        "id": 491331708,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594261
    },
    {
        "content": "<p>Is this a known regression? Or is there a good reason to give up this syntax?</p>",
        "id": 491331742,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735594289
    },
    {
        "content": "<p>i can't find anything in the <a href=\"https://github.com/leanprover/lean4/releases/tag/v4.15.0-rc1\">prospective release notes</a>...</p>",
        "id": 491332323,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594721
    },
    {
        "content": "<p>Patrick, maybe out of scope for this discussion but why are you bumping five Lean versions at once?</p>",
        "id": 491332380,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1735594778
    },
    {
        "content": "<p>It might help here to know which release broke your syntax</p>",
        "id": 491332438,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1735594805
    },
    {
        "content": "<p>(it's the latest rc that breaks it)</p>",
        "id": 491332457,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594821
    },
    {
        "content": "<p>as evidenced by swapping between stable and latest mathlib on the playground</p>",
        "id": 491332480,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735594850
    },
    {
        "content": "<p>the code responsible for atom validation is <a href=\"https://github.com/leanprover/lean4/blob/7e8e22e2bd44c0787d22fb0637d3af6e5593fc24/src/Lean/Elab/Syntax.lean#L235\">here</a>...</p>",
        "id": 491332945,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735595176
    },
    {
        "content": "<p>PR which added the breaking change: <a href=\"https://github.com/leanprover/lean4/pull/6012\">lean4#6012</a></p>",
        "id": 491333291,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735595426
    },
    {
        "content": "<p>(CC <span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span>) i'm not sure why <em>internal</em> spaces are no longer allowed, it was not mentioned in the linked issue...</p>",
        "id": 491333462,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735595571
    },
    {
        "content": "<p>Thanks a lot for investigating this Edward! The PR message does say ‚ÄúAdditionally, atoms with internal whitespace are no longer allowed.‚Äù</p>",
        "id": 491333921,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735595924
    },
    {
        "content": "<p>it does, but no motivation... i'm reading the PR comments right now, there seems to be info there <span aria-label=\"looking\" class=\"emoji emoji-1f440\" role=\"img\" title=\"looking\">:looking:</span></p>",
        "id": 491333955,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735595958
    },
    {
        "content": "<p>Yes, there was a lot of discussion in the PR review.</p>",
        "id": 491334242,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596148
    },
    {
        "content": "<p>i'm guessing the intended fix is using <code>term \" : \" \"[\" ident,* \"]\"</code></p>",
        "id": 491334257,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735596162
    },
    {
        "content": "<p>making maximal use of prettyprinting hints</p>",
        "id": 491334286,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735596192
    },
    {
        "content": "<p>I'm off on vacation and not near a computer - this is phone messaging. Sorry in advance for lack of links etc. The problem with spaces in atoms is that they are a footgun that makes the syntax less predictable - in this one place, the user must write <strong>exactly</strong> one space. Everywhere else in the language, two spaces or even a block comment would have been ok. And this was an easy mistake for the syntax author to make.</p>",
        "id": 491334423,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1735596305
    },
    {
        "content": "<p>For instance, <code>open  private</code> was accidentally a syntax error for a long time</p>",
        "id": 491334544,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1735596375
    },
    {
        "content": "<p>thanks for clarifying!<br>\nit would be nice if this change is given a bit more attention in the proper release notes...<br>\nother than that, enjoy vacation!</p>",
        "id": 491334728,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735596535
    },
    {
        "content": "<p>It seems reasonable to let edsl authors express this behavior, but I couldn't find a real example that wasn't actually a mistake. Is this an example where you intended to require that users write precisely one space character there?</p>",
        "id": 491334830,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1735596603
    },
    {
        "content": "<p>No, I definitely didn‚Äôt intend to force exactly one space.</p>",
        "id": 491335016,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596749
    },
    {
        "content": "<p>Could you confirm that the proper fix is to use <code>term \" : \" \"[\" ident,* \"]\"</code>?</p>",
        "id": 491335039,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596768
    },
    {
        "content": "<p>I will have a <em>lot</em> of fixing to do with this change‚Ä¶</p>",
        "id": 491335186,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596827
    },
    {
        "content": "<p>Because I also have a lot of things like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"Let's\"</span><span class=\"w\"> </span><span class=\"s2\">\" first prove that \"</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">anonymousSplitLemmaTac</span><span class=\"w\"> </span><span class=\"n\">stmt</span>\n</code></pre></div>",
        "id": 491335287,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596885
    },
    {
        "content": "<p>And there I‚Äôm not quite sure how to tell the pretty-printer where to put spaces (and it‚Äôs crucial that the pretty-printer knows this since it is used a lot in the help command and the widgets).</p>",
        "id": 491335369,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735596950
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"Let's \"\"first \"\"prove \"\"that \"</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">anonymousSplitLemmaTac</span><span class=\"w\"> </span><span class=\"n\">stmt</span>\n</code></pre></div>\n<p>should work i think?</p>",
        "id": 491335467,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735597005
    },
    {
        "content": "<p>This is what I‚Äôm trying, although it doesn‚Äôt look pretty.</p>",
        "id": 491335490,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735597025
    },
    {
        "content": "<p>I guess I will soon write a macro/elaborator doing that for me. Because why couldn‚Äôt we take this as an opportunity for more fun with macros?</p>",
        "id": 491335661,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735597129
    },
    {
        "content": "<p>I think I fixed <a href=\"https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/English/Lets.lean\">https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/English/Lets.lean</a>. Only twenty more files like this to go‚Ä¶</p>",
        "id": 491335866,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735597256
    },
    {
        "content": "<p>But I‚Äôll get some sleep first.</p>",
        "id": 491335927,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735597300
    },
    {
        "content": "<p>Yes, that's the intended fix (which will also allow users to use whitespace more flexibly in that context). Sorry to have made such a pile of work over the holidays - perhaps there's a regex find-replace that will do it for you?</p>",
        "id": 491336452,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1735597625
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/invalid.20atom/near/491335661\">said</a>:</p>\n<blockquote>\n<p>I guess I will soon write a macro/elaborator doing that for me. Because why couldn‚Äôt we take this as an opportunity for more fun with macros?</p>\n</blockquote>\n<p>Well, you're in danger of wanting to write a custom parser alias so that you can write <code>withSpaces(\"foo bar\")</code> in your <code>elab</code> line, but <code>initialize add_parser_alias</code> was the very thing that has caused all of the Lean CI scripts to start crashing recently!</p>",
        "id": 491336560,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735597687
    },
    {
        "content": "<p>fwiw, i've managed to write a function which splits a string into a list of strings by whitespace, such that if the string isn't only whitespace, folding it with appending will return the original string.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">makeAtomsOf'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">splitBy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">makeAtomsOf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">makeAtomsOf'</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"bp\">@</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">::</span><span class=\"n\">b</span><span class=\"bp\">::</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"bp\">++</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">::</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">res</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">makeAtomsOf</span><span class=\"w\"> </span><span class=\"s2\">\"   foo sorry    sofosrs sl aooj\"</span><span class=\"w\"> </span><span class=\"c1\">-- [\"   foo \", \"sorry    \", \"sofosrs \", \"sl \", \"aooj\"]</span>\n</code></pre></div>",
        "id": 491340773,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735600556
    },
    {
        "content": "<p>now to make a macro using this...</p>",
        "id": 491340841,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735600585
    },
    {
        "content": "<p>apparently, it's hard to make a macro for something that doesn't have a syntaxnodekind.... which is unfortunate, in this case</p>",
        "id": 491342677,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735601940
    },
    {
        "content": "<p>I tried to play with <code>register_parser_alias</code> but I think this is above my pay grade. I‚Äôll fix things by hand and see whether someone more competent with Lean parsing find this is an interesting challenge.</p>",
        "id": 491387046,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735638856
    },
    {
        "content": "<p>Actually I will probably backtrack and update only to lean4.14.0 which is hopefully enough.</p>",
        "id": 491387287,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639059
    },
    {
        "content": "<p>Expect this plan means fighting <code>lake</code> <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span> Putting a <code>version</code> field in the <code>lakefile.toml</code>‚Äôs <code>require</code> section for mathlib and expect this would do anything was so naive‚Ä¶</p>",
        "id": 491387823,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639446
    },
    {
        "content": "<p>I have </p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.14.0\"</span>\n</code></pre></div>\n<p>in my lakefile and <code>leanprover/lean4:v4.14.0</code> in my <code>lean-toolchain</code> and the first thing <code>lake update</code> tells me is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">5</span><span class=\"n\">bf0f3993d81f682aab73c6129b25b49da7144fa'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n</code></pre></div>",
        "id": 491387994,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639583
    },
    {
        "content": "<p>I think it's \"rev\", not \"version\"</p>",
        "id": 491388153,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1735639688
    },
    {
        "content": "<p>Oh, I was not careful enough when reading <a href=\"https://github.com/leanprover/lean4/tree/master/src/lake#toml-require\">https://github.com/leanprover/lean4/tree/master/src/lake#toml-require</a></p>",
        "id": 491388212,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639750
    },
    {
        "content": "<p>Of course the syntax is not the same for reservoir require and git require, and there is no warning when using an unexpected toml field.</p>",
        "id": 491388238,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639781
    },
    {
        "content": "<p>And indeed it seems to work with <code>rev</code>, thanks Ruben!</p>",
        "id": 491388316,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735639827
    },
    {
        "content": "<p>I filled <a href=\"https://github.com/leanprover/lean4/pull/6482\">lean4#6482</a></p>",
        "id": 491393681,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735643607
    },
    {
        "content": "<p>Here's a solution <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>. For each syntax-defining command in Lean, you can copy the <code>attribute</code> command below to add a \"molecule splitter\" macro for it. The macro searches the entire command syntax for a <code>Lean.Parser.Syntax.atom</code> that's actually a \"molecule\" (for example <code>\" a b c \"</code>) and then replaces it with <code>group(\" a \" \"b \" \"c\")</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Splits a \"molecule\" into atoms. For example,</span>\n<span class=\"sd\">```</span>\n<span class=\"sd\">splitMolecule \"  a b  c \" = #[\"  a \", \"b  \", \"c \"]</span>\n<span class=\"sd\">```</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkIterator</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">it</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">))</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Iterator</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">atoms</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Syntax.atom</span>\n<span class=\"w\">    </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">atoms</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"kn\">syntax</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">syntaxAbbrev</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" : [\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">elaboration function for '¬´term_:[_]¬ª' has not been implemented</span>\n<span class=\"cm\">  2 : [3]</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"c1\">-- [2, 3] : List Nat</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" =&gt; [\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">])</span>\n</code></pre></div>",
        "id": 491786989,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1735925116
    },
    {
        "content": "<p>This looks really nice, thank you very much!</p>",
        "id": 491788490,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735925826
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, thanks to Kim‚Äôs work last night, I‚Äôm able to really test your molecule splitter. It works but it creates a lot of new keywords. In particular I have now summoned the a bug from the dead. Do you see any way to avoid that?</p>",
        "id": 492459383,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736326603
    },
    {
        "content": "<p>In French you write funny accents on top of the \"a\" anyways, right?</p>",
        "id": 492460037,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736326836
    },
    {
        "content": "<p>I'm taking a look at what kind of refactoring is needed in verbose-lean4 to account for all this. Non-reserved keywords could be used here for most of it, I believe</p>",
        "id": 492460278,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736326932
    },
    {
        "content": "<p>The a bug is indeed resurrected only for English-speaking users.</p>",
        "id": 492460907,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327133
    },
    {
        "content": "<p>Thanks David!</p>",
        "id": 492460925,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327140
    },
    {
        "content": "<p>Sorry for having made more work for you here...</p>",
        "id": 492460965,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736327153
    },
    {
        "content": "<p>My hope is that Kyle‚Äôs molecule splitting magic function can be tweaked to avoid that.</p>",
        "id": 492461051,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327175
    },
    {
        "content": "<p>You can see it also poses issues like at <a href=\"https://github.com/PatrickMassot/verbose-lean4/commit/de5761cefee99be45501d489db28302e786c2d8e#diff-afbd756aded38e92e4b93f913ecc558c3c56ee8ebb1b7880a42677e9b75d50ebL13-R15\">https://github.com/PatrickMassot/verbose-lean4/commit/de5761cefee99be45501d489db28302e786c2d8e#diff-afbd756aded38e92e4b93f913ecc558c3c56ee8ebb1b7880a42677e9b75d50ebL13-R15</a></p>",
        "id": 492461229,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327235
    },
    {
        "content": "<p>where <code>   notation3 u \" is increasing\" =&gt; increasing u   </code> had to be changed to <code>   notation3 u \" is increasing\" =&gt; increasing_seq u   </code> after renaming the <code>increasing</code> declaration because the molecule splitted <code>is increasing</code> was introducing an <code>increasing</code> keyword.</p>",
        "id": 492461470,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327319
    },
    {
        "content": "<p>The first word after a <code>term</code>/... should be a reserved keyword because we need it to tell the term parser to stop there but the remainder could be non-reserved, yes</p>",
        "id": 492461724,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736327410
    },
    {
        "content": "<p>Do you see a way to fix <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/invalid.20atom/near/491786989\">#lean4 &gt; invalid atom @ üí¨</a></p>",
        "id": 492461858,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736327472
    },
    {
        "content": "<p>Yes indeed, I'm experimenting with it right now :)</p>",
        "id": 492461869,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736327476
    },
    {
        "content": "<p>This quick hack seems to do the trick:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Splits a \"molecule\" into atoms. For example,</span>\n<span class=\"sd\">```</span>\n<span class=\"sd\">splitMolecule \"  a b  c \" = #[\"  a \", \"b  \", \"c \"]</span>\n<span class=\"sd\">```</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkIterator</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">it</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">))</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Iterator</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">atoms</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Syntax.atom</span>\n<span class=\"w\">    </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">firstAtom</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">restAtoms</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">              </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isAlpha</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">                </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">&amp;$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">firstAtom</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">restAtoms</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">))</span>\n<span class=\"w\">          </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"kn\">syntax</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">syntaxAbbrev</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" : [\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">elaboration function for '¬´term_:[_]¬ª' has not been implemented</span>\n<span class=\"cm\">  2 : [3]</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"c1\">-- [2, 3] : List Nat</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" =&gt; [\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">])</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Here's a great \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\" of type \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- This works:</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 492462924,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736327853
    },
    {
        "content": "<p>It just reserves the first keyword in a \"molecule\". This is may not be specific enough, but it should allow for some progress.</p>",
        "id": 492463132,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736327925
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> Note that this change should also provide a (minor/major?) UX improvement: on partial input such as <code>f is</code>, I assume you previously got an error message such as \"unknown identifier 'is'\", while now it should list exactly the words that may follow <code>is</code></p>",
        "id": 492463353,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736328004
    },
    {
        "content": "<p>Sebastian, I‚Äôm well aware that this whole change is globally a good idea. The fact that the old style was enforcing having exactly one space between words was also very bad (I never noticed it but I‚Äôm sure students would have find it since they have a magical ability to trigger <em>all</em> possible issues).</p>",
        "id": 492463861,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328155
    },
    {
        "content": "<p>In particular, there are still opportunities for ambiguity with this version: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Here's a great \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" of type \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">)</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Here's a \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\" of type \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">id</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: ambiguous, possible interpretations ‚èé</span>\n<span class=\"sd\">  let_fun this := great 33;</span>\n<span class=\"sd\">  this : Nat</span>\n<span class=\"sd\">  ‚èé</span>\n<span class=\"sd\">  let_fun this := 33;</span>\n<span class=\"sd\">  this : Nat</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 492463874,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736328159
    },
    {
        "content": "<p>I can confirm that the parser errors here are quite civilized:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Here's</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">great</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"w\"> </span><span class=\"n\">of</span>\n</code></pre></div>\n<p>reports</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unexpected</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">type'</span>\n</code></pre></div>",
        "id": 492464630,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736328370
    },
    {
        "content": "<p>It creates issues elsewhere unfortunately.</p>",
        "id": 492465592,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328688
    },
    {
        "content": "<p>Are they ambiguity issues? Based on my experiments this morning, I think there's some refactoring needed to get the right precedence annotations in and avoid ambiguous parses. It's doable but not so fun. I'll look at adding a backwards compat option for this change to make it into a non-emergency situation for you.</p>",
        "id": 492466128,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736328866
    },
    {
        "content": "<p>And the error message is the dreaded <code>unexpected syntax</code> which I‚Äôve never found very helpful.</p>",
        "id": 492466133,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328868
    },
    {
        "content": "<p>It‚Äôs not really an emergency issue because, thanks to Kim‚Äôs work last night, I can rather easily teach on Lean 4.14.0 this year. But this is not a future proof solution.</p>",
        "id": 492466256,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328927
    },
    {
        "content": "<p>If you want to help even more then you can try your fix on verbose Lean and see if you can get the library to build.</p>",
        "id": 492466341,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328958
    },
    {
        "content": "<p>The molecule code is in <a href=\"https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/Tactics/Common.lean\">https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/Tactics/Common.lean</a></p>",
        "id": 492466473,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736328997
    },
    {
        "content": "<p>And it breaks <a href=\"https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean\">https://github.com/PatrickMassot/verbose-lean4/blob/master/Verbose/French/Calc.lean</a></p>",
        "id": 492466517,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736329016
    },
    {
        "content": "<p>I had a quick house thing to take care of. Looking at the files, it doesn't seem that they're broken anymore</p>",
        "id": 492473735,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736331584
    },
    {
        "content": "<p>Very mysterious. In the mean time I moved to another computer and it also seems to work.</p>",
        "id": 492477148,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736332802
    },
    {
        "content": "<p>Well then, good to hear!</p>",
        "id": 492477999,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736333105
    },
    {
        "content": "<p>So, just to confirm: the backwards-compatiblity option is no longer needed, because <code>verbose-lean4</code> works now, right?</p>",
        "id": 492503397,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736342460
    },
    {
        "content": "<p>Yes, it seems to work now. Thank you very much to all people who helped.</p>",
        "id": 492507025,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736343658
    },
    {
        "content": "<p>Actually the white space trick seems to break the info view, as in:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Option</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Splits a \"molecule\" into atoms. For example,</span>\n<span class=\"sd\">`splitMolecule \"  a b  c \" = #[\"  a \", \"b  \", \"c \"]`</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkIterator</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">it</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">))</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Iterator</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">atoms</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Syntax.atom</span>\n<span class=\"w\">    </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">atoms</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"kn\">syntax</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">syntaxAbbrev</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"s2\">\" is even \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">5</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hf5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hf5</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 493025236,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736543015
    },
    {
        "content": "<p>It seems Lean tries to display the notation in the infoview and it goes very wrong.</p>",
        "id": 493025343,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736543056
    },
    {
        "content": "<p>By the way, <span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span> this is a case where lean.nvim simply displays nothing at all while VSCode shows an error message.</p>",
        "id": 493025389,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736543092
    },
    {
        "content": "<p>The error message is: ‚ÄúError updating:¬†Error fetching goals: Rpc error: InternalError: parenthesize: uncaught backtrack exception.¬†<a href=\"http://\">Try again.</a>‚Äù</p>",
        "id": 493025467,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736543132
    },
    {
        "content": "<p>I was looking into fixing this earlier. The current \"molecule splitter\" works by creating a <code>group(...)</code> node with the atomized molecule. Somehow either the default parenthesizer can't handle <code>group</code>s, or this code is accidentally breaking some assumption for how <code>notation</code> is supposed to work.</p>\n<p>The <code>expandStxMolecules?</code> function could instead splice-in the atoms into the surrounding syntax. This could break things in some contexts, but for <code>syntax</code>/<code>notation</code> it should be fine...</p>",
        "id": 493025877,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736543321
    },
    {
        "content": "<p>Maybe this requires <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>‚Äôs input then?</p>",
        "id": 493026248,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736543513
    },
    {
        "content": "<p>It's a matter of some more macros <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Option</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Splits a \"molecule\" into atoms. For example,</span>\n<span class=\"sd\">`splitMolecule \"  a b  c \" = #[\"  a \", \"b  \", \"c \"]`</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkIterator</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">it</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">))</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Iterator</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!¬∑.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">atoms</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Syntax.atom</span>\n<span class=\"w\">    </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isStxMolecule</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">atoms</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">atomStrings</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atomString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">atoms</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules?</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"kn\">syntax</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">syntaxAbbrev</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandStxMolecules</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isNotationItemMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">@[builtin_command_parser] def ¬´notation¬ª    := leading_parser</span>\n<span class=\"cm\">  optional docComment &gt;&gt; optional Term.¬´attributes¬ª &gt;&gt; Term.attrKind &gt;&gt;</span>\n<span class=\"cm\">  \"notation\" &gt;&gt; optPrecedence &gt;&gt; optNamedName &gt;&gt; optNamedPrio &gt;&gt; many notationItem &gt;&gt; darrow &gt;&gt; termParser</span>\n\n<span class=\"cm\">item 7 is the `many notationItem`</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandNotationMolecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">isNotationItemMolecule</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">notationItem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">item</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">setArg</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkNullNode</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"o\">)</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"kn\">notation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandNotationMolecules</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"s2\">\" is even \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">5</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hf5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  f g : Int ‚Üí Int</span>\n<span class=\"cm\">  hf : f is even</span>\n<span class=\"cm\">  hf5 : f (-5) = f 5</span>\n<span class=\"cm\">  ‚ä¢ g (f (-5)) = g (f 5)</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hf5</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 493028509,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736544675
    },
    {
        "content": "<p>Fantastic, thank you very much Kyle! I‚Äôm very happy since I grew quite fond of tactic states over the years.</p>",
        "id": 493036435,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736548973
    },
    {
        "content": "<p>Yeah, tactic states are a real nice-to-have :-)</p>\n<p>(By the way, this isn't including David's improvement from <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/invalid.20atom/near/492462924\">#lean4 &gt; invalid atom @ üí¨</a>, which marks some of the atoms with <code>&amp;</code>)</p>",
        "id": 493036656,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736549107
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/invalid.20atom/near/493036656\">said</a>:</p>\n<blockquote>\n<p>(By the way, this isn't including David's improvement from <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/invalid.20atom/near/492462924\">#lean4 &gt; invalid atom @ üí¨</a>, which marks some of the atoms with <code>&amp;</code>)</p>\n</blockquote>\n<p>This is super weird. I guess I messed up with git because I‚Äôm sure I incorporated those changes at some point.</p>",
        "id": 493038378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736550146
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/invalid.20atom/near/493025389\">said</a>:</p>\n<blockquote>\n<p>By the way, <span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> this is a case where lean.nvim simply displays nothing at all while VSCode shows an error message.</p>\n</blockquote>\n<p>oh fun, I've never seen that before (in VSCode), that's not a diagnostic it's the extension obviously saying that talking to the language server failed quite hard. We catch that (and I think log it) but don't show those in the infoview. Do you want to (== think everyone should) see that in the infoview or is a logging message enough if I make it visible?</p>",
        "id": 493038476,
        "sender_full_name": "Julian Berman",
        "timestamp": 1736550216
    },
    {
        "content": "<p>Oh no I see. I told David at that time that his fix broke other stuff and he couldn‚Äôt reproduce. But that‚Äôs precisely because I forgot to push. Now it‚Äôs breaking things again <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 493038505,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736550239
    },
    {
        "content": "<p>Julian, I think the totally blank infoview panel is not great in this case because there is no hint about what‚Äôs going on. Of course the error message is completely unusable but at least it says Lean is not dead.</p>",
        "id": 493038629,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736550309
    },
    {
        "content": "<p>This time I pushed David‚Äôs code to <a href=\"https://github.com/PatrickMassot/verbose-lean4/tree/david_fix\">https://github.com/PatrickMassot/verbose-lean4/tree/david_fix</a>, and indeed the lib doesn‚Äôt build with it.</p>",
        "id": 493038792,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736550406
    },
    {
        "content": "<p>It's too late for me to look tonight, but I'll take a look as soon as I can</p>",
        "id": 493045560,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736554867
    },
    {
        "content": "<p>OK, I just created a PR against that branch that makes it build for me. I got rid of all the auto-splitting, and just went in and split the atoms manually in all the files. I set <code>a</code> to be a non-reserved keyword, but there may be others that should be it. The library builds, and clicking around in the demos does what I expect, but I don't know it well. Please let me know if there's something else to look at!</p>",
        "id": 493120198,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736622482
    },
    {
        "content": "<p>This is very kind, but it doesn‚Äôt seem really future proof. Are you really convinced there is no way to automate this and people should simply try putting <code>&amp;</code> by hand until the parser is happy?</p>",
        "id": 493120468,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736622660
    },
    {
        "content": "<p>I'd rather suggest using <code>&amp;</code>selectively on atoms that should remain valid as identifiers, like <code>a</code>. In cases where this leads to ambiguous parses, I'd suggest refactoring the grammar if possible, or using precedence annotations to remove the ambiguity.</p>",
        "id": 493121374,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736623343
    },
    {
        "content": "<p>Any automated solution would need something like this too, really - ambiguity is a property of the resulting syntax. But it should also be possible to whitelist a set of atoms to not reserve, rather than doing it positionally like in my change to Kyle's macro. That should give a result equivalent to the changes I implemented in the branch, but it was unclear to me that this actually made the library easier to develop. I could try that approach too if you'd like to see it.</p>",
        "id": 493121563,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736623561
    },
    {
        "content": "<p>How did you choose to put <code>&amp;</code> in your PR?</p>",
        "id": 493123013,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736625018
    },
    {
        "content": "<p>I put it before tokens that seemed likely to be used as identifiers elsewhere.</p>",
        "id": 493123163,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736625170
    },
    {
        "content": "<p>In practice, this set will likely need some adjustment, because my knowledge is far from global!</p>",
        "id": 493123252,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736625251
    },
    {
        "content": "<p>If you have a corpus of assignments and solutions using this that you can send me in private, I'll give it another pass to make sure they do what they should</p>",
        "id": 493123282,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736625305
    },
    {
        "content": "<p>Thanks but I really want to avoid a solution where molecules are split by hand. I‚Äôll try to come up with a list of atoms to decorate with <code>&amp;</code> and see if this is good enough.</p>",
        "id": 493124454,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736626491
    },
    {
        "content": "<p>Ok, when I get the chance I'll make you another version of the macro</p>",
        "id": 493124574,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736626617
    },
    {
        "content": "<p>I‚Äôll try to do it tonight.</p>",
        "id": 493124686,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736626726
    },
    {
        "content": "<p>No rush - I can tweak the macro with just a guess of what should be in it, and you can adjust as needed</p>",
        "id": 493124806,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736626836
    },
    {
        "content": "<p>OK, I just pushed an alternative PR that builds locally, and in which the infoview works. This one has an explicit list of tokens to not reserve when splitting; it doesn't allow them to be the first (because of ambiguity issues). I hope this works well for you.</p>",
        "id": 493128726,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736630760
    },
    {
        "content": "<p>When things settle down, I'd like to hear more about why writing multiple atoms in a row is undesirable. I'd assumed it was that you didn't have time/energy to do the splitting, which is why I just went and did it, but now it sounds like it's something else too.</p>\n<p>If it were my project, then I probably wouldn't consider the the kind of metaprogramming done to do automatic atom splitting here to be worth the complexity cost in the code, but perhaps there are further reasons to do so that I'm not aware of?</p>",
        "id": 493129041,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736631033
    },
    {
        "content": "<p>In any case, let me know how it goes!</p>",
        "id": 493129052,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736631054
    },
    {
        "content": "<p>Thanks a lot!</p>",
        "id": 493129305,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736631320
    },
    {
        "content": "<p>Does the full library builds with this?</p>",
        "id": 493129323,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736631344
    },
    {
        "content": "<p>Is there a reason to turn <code>notation3</code> into <code>notation</code>? Note I didn‚Äôt have any specific reason to use <code>notation3</code>, it was simply because in my mind it means a better version of <code>notation</code>.</p>",
        "id": 493129400,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736631399
    },
    {
        "content": "<p>No prob :-)</p>\n<p>It does this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 493129442,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736631442
    },
    {
        "content": "<p>I switched <code>notation</code> commands because <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>'s infoview fix was for the built-in notation command rather than <code>notation3</code>. The infoview was still throwing parenthesizer errors without it.</p>",
        "id": 493129523,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736631510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"354934\">David Thrane Christiansen</span> <a href=\"#narrow/channel/270676-lean4/topic/invalid.20atom/near/493129041\">said</a>:</p>\n<blockquote>\n<p>When things settle down, I'd like to hear more about why writing multiple atoms in a row is undesirable. I'd assumed it was that you didn't have time/energy to do the splitting, which is why I just went and did it, but now it sounds like it's something else too.</p>\n</blockquote>\n<p>The only reason is I still hope some people will create translations to different languages (I‚Äôve heard many people claiming this, but it happened only once and the translation is not maintained). I don‚Äôt want to scare those people.</p>",
        "id": 493129559,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736631560
    },
    {
        "content": "<p>That makes sense. Would a code action/quickfix to do the split in the source file address this concern?</p>",
        "id": 493129644,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1736631630
    },
    {
        "content": "<p>Probably. It‚Äôs difficult to be sure.</p>",
        "id": 493129700,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736631694
    },
    {
        "content": "<p>The <code>notation3</code> version of the macro should be just like <code>expandNotationMolecules</code>, but you change the <code>7</code>s to <code>8</code>s</p>",
        "id": 493129928,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736631910
    },
    {
        "content": "<p>Do you know what should go in <code>attribute [macro Lean.Parser.Command.notation] expandNotationMolecules\n</code>?</p>",
        "id": 493130349,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736632352
    },
    {
        "content": "<p><code>attribute [macro Mathlib.Notation3.notation3] expandNotation3Molecules</code></p>",
        "id": 493130831,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736632857
    },
    {
        "content": "<p>It doesn‚Äôt seem to work.</p>",
        "id": 493132311,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736634331
    },
    {
        "content": "<p>Maybe I misunderstood. I tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandNotation3Molecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">isNotationItemMolecule</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">notationItem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">item</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">setArg</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkNullNode</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"o\">)</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span><span class=\"bp\">.</span><span class=\"n\">notation3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandNotation3Molecules</span>\n</code></pre></div>",
        "id": 493132527,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736634524
    },
    {
        "content": "<p>There turned out to be some subtle differences in the items. This one's been tested a little:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isNotation3ItemMolecule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"bp\">.</span><span class=\"n\">trim</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandNotation3Molecules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">isNotation3ItemMolecule</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">items</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">item</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isStrLit?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">splitMolecule</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">item</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span><span class=\"bp\">.</span><span class=\"n\">notation3Item</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">atom</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">items'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">item</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">setArg</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkNullNode</span><span class=\"w\"> </span><span class=\"n\">items'</span><span class=\"o\">)</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span><span class=\"bp\">.</span><span class=\"n\">notation3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expandNotation3Molecules</span>\n</code></pre></div>",
        "id": 493133147,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736635248
    },
    {
        "content": "<p>It seems to work much better, thanks!</p>",
        "id": 493133378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736635517
    }
]