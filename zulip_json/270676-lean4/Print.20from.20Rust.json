[
    {
        "content": "<p>If I run the following Rust function from Lean, it prints <code>\"Hello\"</code> to stdout:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">printhello</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>But if the function never returns, it never prints <code>\"Hello\"</code> as in the following:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">nohello</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Hello\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Is there a way to get <code>nohello</code> to print to stdout anyway?</p>\n<hr>\n<p><a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>: I'm trying to print-debug from Rust. I think I have a non-terminating loop somewhere, and am trying to figure out where.</p>",
        "id": 468802538,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725889203
    },
    {
        "content": "<p>Do you need to flush stdout maybe on the rust side. Seems strange that it wouldn't print at all, more likely that it's just buffered</p>",
        "id": 468806415,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1725889959
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"127136\">@Alex J. Best</span> I tried using <code>io::stdout().flush()</code>, but that didn't help.</p>",
        "id": 468806798,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725890058
    },
    {
        "content": "<p>(I thought maybe so too, but Rust appears to still use line-buffering always according to <a href=\"https://github.com/rust-lang/rust/issues/60673\">https://github.com/rust-lang/rust/issues/60673</a> )</p>",
        "id": 468809419,
        "sender_full_name": "Julian Berman",
        "timestamp": 1725890628
    },
    {
        "content": "<p>If you strace do you see the syscall happen maybe?</p>",
        "id": 468809537,
        "sender_full_name": "Julian Berman",
        "timestamp": 1725890648
    },
    {
        "content": "<p>How are you calling rust from Lean?</p>",
        "id": 468809959,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725890760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Print.20from.20Rust/near/468809959\">said</a>:</p>\n<blockquote>\n<p>How are you calling rust from Lean?</p>\n</blockquote>\n<p>I should have mentioned that! It's as part of a tactic - so at compile time in <code>MetaM</code>.</p>",
        "id": 468810680,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725890924
    },
    {
        "content": "<p>So it's linked via <code>extern</code>, not run via a subprocess?</p>",
        "id": 468811300,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725891043
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Print.20from.20Rust/near/468811300\">said</a>:</p>\n<blockquote>\n<p>So it's linked via <code>extern</code>, not run via a subprocess?</p>\n</blockquote>\n<p>Exactly! (I'm setting up an mwe repo as we speak)</p>",
        "id": 468811759,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725891132
    },
    {
        "content": "<p>(regarding the <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>-question, perhaps it would be useful to <code>gdb attach</code> to your process)</p>",
        "id": 468812015,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1725891195
    },
    {
        "content": "<p>Ok, here's a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> repo: <a href=\"https://github.com/marcusrossel/mwe/tree/main\">https://github.com/marcusrossel/mwe/tree/main</a><br>\nBut for some reason, right now it's not even printing <code>\"hello\"</code>/looping for the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"lean_printhello\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">printhello</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"lean_nohello\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">nohello</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``Unit.unit</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">printhello</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">hello</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"nohello\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nohello</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">nohello</span>\n</code></pre></div>\n<p>(I added the <code>Unit.toExpr</code> dance in the hope that it would mean that Lean doesn't optimize away the calls to <code>printhello</code> and <code>nohello</code> - though I have no clue if that's necessary or effective.)</p>",
        "id": 468821623,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725893055
    },
    {
        "content": "<p>Does it work as expected if <code>printhello</code> and <code>nohello</code> live in <code>IO</code> monad?</p>",
        "id": 468850681,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1725898696
    },
    {
        "content": "<p>I don't think that <code>u.toExpr</code> is preventing Lean from optimizing the calls away.</p>",
        "id": 468851285,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1725898811
    },
    {
        "content": "<p>If it's not in the IO monad, I think the reliability of printing is more like <code>dbg_trace</code>, which will happen if it's forced to, but it might be eliminated. For example, I don't see any messages in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">printHello</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">printHello</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 468863463,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725901455
    },
    {
        "content": "<p>Does it work if you print to stderr instead to remove the buffering?</p>",
        "id": 468881783,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725906682
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/stream/270676-lean4/topic/Print.20from.20Rust/near/468881783\">said</a>:</p>\n<blockquote>\n<p>Does it work if you print to stderr instead to remove the buffering?</p>\n</blockquote>\n<p>Using <code>eprintln!</code> didn't work either.</p>",
        "id": 469461186,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1726073008
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Print.20from.20Rust/near/468863463\">said</a>:</p>\n<blockquote>\n<p>If it's not in the IO monad, I think the reliability of printing is more like <code>dbg_trace</code></p>\n</blockquote>\n<p>I tried wrapping my function's return type in <code>IO</code> and using <code>lean_io_result_mk_ok</code> when returning the result from C. Should that be enough to see <code>println!</code>s? Because when the Rust function is non-terminating I still don't see the result of the <code>println!</code>.</p>",
        "id": 469463697,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1726073586
    }
]