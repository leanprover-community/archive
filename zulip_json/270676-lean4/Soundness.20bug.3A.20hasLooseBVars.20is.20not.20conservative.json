[
    {
        "content": "<p>The \"possible\" is because it is arguable whether this should count as a soundness bug given that it produces a panic. Nevertheless, this is causing problems for lean4lean having false theorems.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">20</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">hasLooseBVars</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>Normally you would need gargantuan terms to get this many bvars in an expression, but in this case you can just pass this bvar expression on input and various parts of lean will ignore it because it doesn't \"look\" like a bvar.</p>",
        "id": 520153084,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748052671
    },
    {
        "content": "<p>Actually it seems to be possible to build terms large enough to hit the bvar limit without running into stack overflows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkProps</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkProps</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"ss\">`_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span>\n\n<span class=\"n\">run_elab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">axiomDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`foo</span>\n<span class=\"w\">    </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkProps</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">20</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">20</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">isUnsafe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">setEnv</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ofExceptKernelException</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">decl</span>\n</code></pre></div>\n<p>The usual symptom is an error <code>(kernel) type checker does not support loose bound variables</code>, because I believe when traversing into the body it does not actually reduce the bvar number as it normally would because it thinks the bvar isn't there, meaning that when it eventually gets to actually typechecking it the bvar is still there instead of being replaced by a fvar, so it thinks the term is ill-scoped</p>",
        "id": 520154182,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748053756
    },
    {
        "content": "<p>This one isn't even a panic:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">liftLooseBVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"c1\">-- Lean.Expr.bvar 3</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">liftLooseBVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"c1\">-- Lean.Expr.bvar 1</span>\n</code></pre></div>",
        "id": 520213558,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748105972
    },
    {
        "content": "<p>cc: <span class=\"user-mention\" data-user-id=\"112857\">@Leonardo de Moura</span> . There are a lot of missing bounds checks in these functions, and the biggest issue is that they don't even have an error pathway. Should I look for an actual unsoundness, or can they be changed to return an optional result? I might try going ahead with the proof as is (keeping track of their limitations and proving that either they aren't called with too big inputs or that the garbage outputs don't make it too far before an error is raised) but these functions are used to produce trusted terms that are not revisited, so I have a high suspicion that this is real unsoundness</p>",
        "id": 520214661,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748106804
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span>  / <span class=\"user-mention\" data-user-id=\"221653\">@Paul Reichert</span>  are these the same ones that you saw?</p>",
        "id": 520214787,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1748106911
    },
    {
        "content": "<p>Our fuzzer also found a problem related to the bvar handling, but I think we got sidetracked and haven't finished the analysis yet (and also weren't able to expoit it so far). I need to revisit where we left off to remember more details and try to find the time for it this week.</p>",
        "id": 520365437,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1748239706
    },
    {
        "content": "<p>We found various segfaults in the kernel triggered by feeding terms with loose bvars to the kernel. Our fuzzer only generates bvars with de bruijn index at most 2^16, so I guess our findings are somewhat orthogonal.</p>",
        "id": 520368756,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1748241403
    },
    {
        "content": "<p>I would love to have some of those tests for lean4lean</p>",
        "id": 520456291,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748266850
    },
    {
        "content": "<p>you should definitely test bvars around 2^20, 2^32 and 2^64, these are all interesting crossover points in the code</p>",
        "id": 520456881,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748267015
    },
    {
        "content": "<p>I have figured out how to upgrade this to an actual unsoundness. This repro uses a similar bug, not the one in <a href=\"http://Expr.data\">Expr.data</a> but in <a href=\"http://Level.data\">Level.data</a>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">isProp_prop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">not_isProp_type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">nomatch</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">isProp_not_invariant</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">isProp_prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">not_isProp_type</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Level</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- #eval (mkLevel (2^24) (.param `u)).hasParam -- false!</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"o\">(</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_elab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">24</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"ss\">`u</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">defnDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`magic</span>\n<span class=\"w\">    </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n<span class=\"w\">    </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`isProp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">l</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"kn\">opaque</span>\n<span class=\"w\">    </span><span class=\"n\">safety</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">safe</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"n\">run_elab</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">defnDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`magic_eq</span>\n<span class=\"w\">    </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`u</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkPropEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`magic</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`isProp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"ss\">`u</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkApp2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Eq.refl</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelOne</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`magic</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">    </span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"kn\">opaque</span>\n<span class=\"w\">    </span><span class=\"n\">safety</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">safe</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">magic</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">isProp</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">magic_eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">contradiction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isProp_not_invariant</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">magic_eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">magic_eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">})</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"n\">contradiction</span>\n<span class=\"c1\">-- 'contradiction' does not depend on any axioms</span>\n</code></pre></div>",
        "id": 521286338,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748607776
    },
    {
        "content": "<p>Just checking: <code>magic</code> and <code>magic_eq</code> themselves do type-check, according to the Kernel? Because otherwise this is just a special case of \"you can put type-incorrect theorems into the environment using <code>addDecl</code>\", right?</p>",
        "id": 521286722,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1748607921
    },
    {
        "content": "<p>that's right, the kernel validates these theorems</p>",
        "id": 521286755,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748607938
    },
    {
        "content": "<p>Oh, good point. I misremembered: the other unsoundness is not with <code>addDecl</code> but with a more lower-level \"adapt the environment yourself\"</p>",
        "id": 521286881,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1748607986
    },
    {
        "content": "<p>the use of <code>addDecl</code> is because the construction involves the level expression <code>max 0 ... 0 u</code> where there are 2^24 <code>0</code>'s, and so it is better to not have the elaborator look at it because it takes a long time and sometimes stack overflows</p>",
        "id": 521287007,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748608041
    },
    {
        "content": "<p>that's a lot of zeroes <span aria-label=\"looking\" class=\"emoji emoji-1f440\" role=\"img\" title=\"looking\">:looking:</span></p>",
        "id": 521294803,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1748610746
    },
    {
        "content": "<p>fixed in <a href=\"https://github.com/leanprover/lean4/pull/8554\">lean4#8554</a></p>",
        "id": 521352000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748630200
    },
    {
        "content": "<p>Unfortunately, it seems Leo has not accepted the PR, and has instead fixed the issue in a way that can't be proved correct :(</p>",
        "id": 521446632,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748701325
    },
    {
        "content": "<p>For people who review formalization papers, what is the recommended way to check that a presented proof doesn't exploit this bug?</p>",
        "id": 527901761,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1752071335
    },
    {
        "content": "<p>the fix is already on the latest stable</p>",
        "id": 527917746,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752075980
    },
    {
        "content": "<p>so the easiest way is to just make sure it's upgraded to the latest version</p>",
        "id": 527917808,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1752076002
    }
]