[
    {
        "content": "<p>I love <code>trace.profiler.useHeartbeats</code>. The heartbeat output is far more stable than the reporting in seconds (which differs between restarts) and this makes diffs far more stable when debugging. But I've noticed two (very minor) things about it: (1) even though the output is an integer, it is consistently reported to 6 decimal places and (2) when I am mathlib typeclass hell and trying to figure out what's going on by \"chasing the big number\", it can be very difficult to spot the actual problem when <code>useHeartbeats</code> is on because <code>3395634.000000</code>, <code>33956345.000000</code> and <code>339563452.000000</code> (a 7-digit, an 8-digit and a 9-digit number) all look quite similar when reported like this (especially when interspersed between many 4- and 5-digit numbers); this is in contrast to looking at the output in seconds, where it's very easy to visually spot the difference between <code>3.255733</code>, <code>0.325573</code> and <code>0.032557</code> and ignore the <code>0.000023</code> stuff). </p>\n<p>My RFC is to have <code>trace.profiler.useHeartbeats</code> on (so very stable numbers) but in a way where it's visually easy to differentiate between numbers at the \"problematic scale\" (which in my experience is 7-digit, 8-digit and 9-digit numbers). For example, reporting heartbeats but in the \"mega\" range (i.e. divide by a million and then report to 6 decimal places) would preserve the numerical stability of the output between runs and also make it visually much easier to spot the large figures in trace output.</p>",
        "id": 566223973,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1767534557
    },
    {
        "content": "<p>How about when <code>useHeartbeats</code> is on, we print these numbers as e.g. <code>33_956_345</code> (i.e. Lean's existing mechanism for optional place notation hints when parsing numbers)?</p>",
        "id": 566269300,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767582714
    },
    {
        "content": "<p>That sounds good to me. The alternative I could see is to stay with float formatting but use something like megaheartbeats as the unit, similar to Radar.</p>",
        "id": 566368107,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1767623987
    },
    {
        "content": "<p>By the way, I have an old lean4 PR I wanted to get mergeable at some point that would also allow measuring CPU instructions, just like in Radar, for a similarly deterministic metric that at the same time is closer to wall-clock time. This would be Linux-only however.</p>",
        "id": 566368763,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1767624143
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/trace.2Eprofiler.2EuseHeartbeats.20RFC/near/566269300\">schrieb</a>:</p>\n<blockquote>\n<p>How about when <code>useHeartbeats</code> is on, we print these numbers as e.g. <code>33_956_345</code> (i.e. Lean's existing mechanism for optional place notation hints when parsing numbers)?</p>\n</blockquote>\n<p>I'd print large numbers with underscores always even.</p>",
        "id": 566588878,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1767720114
    }
]