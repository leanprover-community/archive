[
    {
        "content": "<p>Occasionally, I would like to configure the behaviour of runLinter, such as</p>\n<ul>\n<li>also run lint X (say, the docBlameThm linter)[1]</li>\n<li>only run lint X/omit lint Y (say, if I'm running on all of mathlib; the simpNF linters take a while on my computer)</li>\n</ul>\n<p>In addition, the user experience of using <code>runLinter</code> can be improved: no --help output, no documentation what its inputs do. They are all somewhat obvious, but not quite. I remember looking for a way to do the above; it took me a while to figure out this was <em>not</em> possible.<br>\nPerhaps I have been spoilt by the Rust ecosystem, but I like my tools telling me right away what they can and cannot do!</p>\n<p>The most apparent way to address both is to<br>\n(1) rewrite runLinter as a proper CLI app (instead of the ad hoc command line argument parsing it's doing today)<br>\n(2) add flags such as</p>\n<ul>\n<li><code>--print-linters</code>: print the list of all linters it discovered and exit</li>\n<li>\n<p><code>--add-linters</code>: also run the following linters, even if they were disabled before<br>\n(my use case: run a linter which is <code>@[env_linter disabled]</code>, when I cannot or do not want to edit the project defining the linter)</p>\n</li>\n<li>\n<p><code>--exclude-linters X Y</code>: do not run linters X or Y (say, for performance reasons or because I'm not interested in their output right now)</p>\n</li>\n<li><code>--only-linters Z</code>: only run linter Z (say, if I added this anew)</li>\n</ul>\n<p>Is there any reasons to <em>not</em> do this? Are the longer-term plans in this area I should be aware of?<br>\nI have a prototype for this in a mathlib branch; if this is deemed useful, I'm happy to make a PR to batteries to improve <code>runLinter</code> there.)</p>\n<p>[1] I can do so in individual files using the #lint docBlameThm command. I would like to run it on the whole project, however.</p>",
        "id": 450770662,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720720166
    },
    {
        "content": "<p>To un-#xy: my original motivation was regenerating mathlib's <code>nolints.json</code> file locally. I know how to do this, but running all the simp linters takes a while. I can have my computer start this, cook dinner and have the results afterwards, but there ought to be a better way.<br>\nAnother motivation was re-discovering the <code>docBlameThm</code> linter, which is disabled by default: I currently cannot run it on mathlib without editing core or batteries; this should not be necessary.</p>",
        "id": 450770677,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720720173
    },
    {
        "content": "<p>Mathlib PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/14654\">#14654</a> is a proof of concept PR for the UX I can imagine. Comments very welcome.</p>",
        "id": 450922977,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720777137
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/881\">batteries#881</a> makes first baby steps in this direction, by fixing the <code>getChecks</code> function</p>",
        "id": 450924850,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720777808
    },
    {
        "content": "<p>Thanks for the comments and merging the batteries PR!</p>",
        "id": 452502495,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721372599
    },
    {
        "content": "<p>In light of the <a href=\"#narrow/stream/287929-mathlib4/topic/Naming.20convention/near/451072858\">discussion</a> about the naming convention, I would like to rename <code>runLinter</code> (to be in kebab-case, for example).</p>\n<p>At the same time, <code>runLinter</code> is slightly ambiguous, now that syntax linters exist and at least mathlib is gaining quite a few of them. Since <code>runLinter</code> runs all linters tagged with <code>env_lint</code>, how about renaming to <code>env-lint</code>? (I would perform this rename along with adding a warning to the old script, pointing out the rename. After perhaps a month or two, that warning can be removed.)<br>\nCC <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span></p>",
        "id": 452502499,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721372604
    },
    {
        "content": "<p>I don't think env needs to be in the executable name. I think the plan is that we are going to transition to using <code>lake lint</code> (in fact, if I understand right we can already do this, but I'm on mobile and can't verify). It is meant to work just like @[test_driver] does for <code>lake test</code>.</p>",
        "id": 452905262,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721512935
    },
    {
        "content": "<p>The distinction between syntax and environment linters should be prominent in the <em>documentation</em> for both, but people who are just trying to use them don't need to know immediately.</p>",
        "id": 452905378,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721512996
    },
    {
        "content": "<p>That said, I guess it's no harm to rename the executable as you suggest, and then immediately hide it behind <code>lake lint</code>.</p>",
        "id": 452905512,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721513056
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Configuring.2Fmodernizing.20runLinter/near/452905512\">said</a>:</p>\n<blockquote>\n<p>That said, I guess it's no harm to rename the executable as you suggest, and then immediately hide it behind <code>lake lint</code>.</p>\n</blockquote>\n<p>That would be my preferred solution also!</p>",
        "id": 452906139,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721513396
    },
    {
        "content": "<p>Sorry for bumping this old thread with something only tangentially related to the conversation.</p>\n<p>Looking at the diff of our most recent mathlib4 <a href=\"https://github.com/leanprover-community/mathlib4/pull/17010/files\">automatic update nolints PR</a>, it looks like <code>lake exe runLinter --update</code> writes a nolints.json file without a final newline. It'd be nice to fix that since anyone editing the file manually will most likely add a final newline character so this will just lead to diff noise. (This is of course hardly a huge deal, but I figured I'd post here while it was on my mind.)</p>\n<p>Maybe if  <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> 's runLinter rewrite is still forthcoming, this can be worked in somehow?</p>",
        "id": 472003381,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726978262
    },
    {
        "content": "<p>Bryan, does <a href=\"https://github.com/leanprover-community/mathlib4/pull/17038\">#17038</a> look like it might solve the issue?  Sorry, I do not have time to test it now.</p>",
        "id": 472079984,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727035705
    },
    {
        "content": "<p>Hi Damiano, this is my first time looking at the lean code in that file, but isn't that PR touching code (in Mathlib/Tactic/Linter/TextBased.lean) which writes changes to the .lean file being linted and not the code where the <code>nolints.json</code> file containing exceptions is updated?</p>\n<p>I could be wrong but I think the nolints.json file is generated with a missing final newline in <a href=\"https://github.com/leanprover-community/batteries/blob/2ce0037d487217469a1efeb9ea8196fe15ab9c46/scripts/runLinter.lean\">scripts/runLinter.lean in batteries</a>.</p>",
        "id": 472081084,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1727036600
    },
    {
        "content": "<p>You're probably right.  Then I think that the missing line break is here:</p>\n<p><a href=\"https://github.com/leanprover-community/batteries/blob/2ce0037d487217469a1efeb9ea8196fe15ab9c46/scripts%2FrunLinter.lean#L18\">https://github.com/leanprover-community/batteries/blob/2ce0037d487217469a1efeb9ea8196fe15ab9c46/scripts%2FrunLinter.lean#L18</a></p>\n<p>I remember fixing a similar issue with shake a while back.</p>",
        "id": 472083215,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727038348
    },
    {
        "content": "<p>I think that the JSON <code>pretty</code>-fier does not add a final line break to the file.</p>",
        "id": 472083264,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727038393
    },
    {
        "content": "<p>I've already switched off the computer for the night, though.  If you want to add a <code>.push '\\n'</code> yourself, feel free to do so!  Otherwise, I'll do it tomorrow.</p>",
        "id": 472083370,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727038457
    },
    {
        "content": "<p>This is the analogous line in shake:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Shake%2FMain.lean#L538\">https://github.com/leanprover-community/mathlib4/blob/master/Shake%2FMain.lean#L538</a></p>",
        "id": 472083546,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727038611
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/955\">batteries#955</a></p>\n<p>I tested this locally and it seems to work as intended.</p>\n<p>I am having some difficulty testing it in CI, though.</p>",
        "id": 472147992,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727075751
    },
    {
        "content": "<p>That PR looks good to me - you got to it before I saw this thread in full :-)</p>",
        "id": 472155838,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1727077817
    },
    {
        "content": "<p>It looks like the update nolints job is now saving a file ending in a newline: <a href=\"https://github.com/leanprover-community/mathlib4/pull/17245/files\">https://github.com/leanprover-community/mathlib4/pull/17245/files</a></p>\n<p>Thanks Damiano! (I've closed <a href=\"https://github.com/leanprover-community/mathlib4/pull/17038\">#17038</a> for now.)</p>",
        "id": 473490812,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1727644015
    }
]