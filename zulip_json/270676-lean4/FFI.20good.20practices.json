[
    {
        "content": "<p>Hey there !</p>\n<p>I am in the process of wrapping the <code>ncurses</code> library in lean, and I am wondering about the \"good practices\" of making suck a wrapper.</p>\n<p>Here are my questions:</p>\n<ol>\n<li>Many types in <code>ncurses</code> are actually standard types representing other things. I'd like to expose them as disctinct types in lean to haev better type guarantees. Is it necessary to always box them (even if the type is say <code>short</code>) ? What is the process ?</li>\n<li>I know <code>lean_external_class</code> and the likes exist but I don't understand what they do. Is there documentation about that somewhere ?</li>\n</ol>",
        "id": 480852634,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730874514
    },
    {
        "content": "<p>The source code of the bindings is available here by the way: <a href=\"https://git.sr.ht/~vigoux/lcurses/tree\">https://git.sr.ht/~vigoux/lcurses/tree</a></p>",
        "id": 480859461,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730878473
    },
    {
        "content": "<ol>\n<li>Some types are unboxed as function arguments/return types, e.g. UInts. Trivial wrappers around them (inductive with only one relevant type, e.g. Char) are treated similarly. But when stored in an inductive any wrappers are stored as <code>lean_object*</code>.</li>\n<li>External class is required to create external objects that hold a user supplied pointer that can be anything. The class stores free and foreach callbacks (foreach is used to mark owned <code>lean_object*</code>s as multithreaded etc).</li>\n</ol>\n<p>See <a href=\"https://lean-lang.org/lean4/doc/dev/ffi.html\">manual</a> and <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20Lean's.20Foreign.20Function.20Interface.20.28FFI.29/near/452101098\">this guide</a>.</p>",
        "id": 480878750,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1730885716
    },
    {
        "content": "<p>Wrapper example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"func\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">(</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 480879568,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1730885964
    },
    {
        "content": "<p>Class example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"my_init\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">init</span>\n\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">BPointed</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">BPointed</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">BPointed</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"my_func\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">B</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">lean_external_class</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">my_class</span><span class=\"p\">;</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">my_finalize</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">user_ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">my_foreach</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">user_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">my_init</span><span class=\"p\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">io_world</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">my_class</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_register_external_class</span><span class=\"p\">(</span><span class=\"n\">my_finalize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">my_foreach</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"p\">(</span><span class=\"n\">lean_box</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">my_func</span><span class=\"p\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">io_world</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"p\">(</span><span class=\"n\">lean_alloc_external</span><span class=\"p\">(</span><span class=\"n\">my_class</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">NULL</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 480884249,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1730887455
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"587706\">@Daniil Kisel</span>  Is there any example about the <code>foreach</code>callback? i don't quite understand how it can \"mark ownedÂ <code>lean_object*</code>s as multithreaded etc\"</p>",
        "id": 481947129,
        "sender_full_name": "haowei chen",
        "timestamp": 1731417674
    },
    {
        "content": "<p>You need to apply the supplied function to every owned <code>lean_object*</code>. For example, if the pointer stored in the external object points to a structure:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"p\">;</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>Then the foreach callback should apply <code>f</code> to <code>x</code> and to <code>y</code>:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">my_foreach</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">user_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">user_ptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">x</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">lean_apply_1</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">x</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">y</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">lean_apply_1</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">-&gt;</span><span class=\"n\">y</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>And the free callback should probably call <code>lean_dec</code> on <code>a-&gt;x</code> and <code>a-&gt;y</code> to free them.</p>",
        "id": 481954649,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1731419730
    }
]