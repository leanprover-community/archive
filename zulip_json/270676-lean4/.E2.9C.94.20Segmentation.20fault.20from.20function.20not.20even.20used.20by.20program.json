[
    {
        "content": "<p>I've made a minimal working example to try to diagnose some code that segfaults when compiled:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"bp\">.</span><span class=\"n\">Lemmas</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">set</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ne_eq</span><span class=\"o\">,</span>\n<span class=\"w\">                 </span><span class=\"bp\">←</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">isEmpty_eq_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"bp\">.</span><span class=\"n\">isEmpty_keys</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rwa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>will<span class=\"w\"> </span>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>build<span class=\"p\">;</span><span class=\"w\"> </span>./.lake/build/bin/advent-of-code-2024\nBuild<span class=\"w\"> </span>completed<span class=\"w\"> </span>successfully.\nzsh:<span class=\"w\"> </span>segmentation<span class=\"w\"> </span>fault<span class=\"w\">  </span>./.lake/build/bin/advent-of-code-2024\n</code></pre></div>\n<p>When I comment out <code>test</code>, it compiles and runs. I've already tried <code>lake clean</code>ing. I already have a workaround, which is just matching on <code>set.toList</code>, but I figured the community would be interested in this. I'm running <code>leanprover/lean4:v4.15.0</code> on a 2021 MacBook Pro, macOS 14.1.</p>",
        "id": 494935766,
        "sender_full_name": "Will Bradley",
        "timestamp": 1737417702
    },
    {
        "content": "<p>(It segfaults on 4.16.0-rc2 as well it would seem).</p>\n<p>The crash report says it happens in:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Thread</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">Crashed</span><span class=\"bp\">::</span><span class=\"w\">  </span><span class=\"n\">Dispatch</span><span class=\"w\"> </span><span class=\"n\">queue</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">com</span><span class=\"bp\">.</span><span class=\"n\">apple</span><span class=\"bp\">.</span><span class=\"n\">main</span><span class=\"bp\">-</span><span class=\"n\">thread</span>\n<span class=\"mi\">0</span><span class=\"w\">   </span><span class=\"n\">foo</span><span class=\"w\">                                    </span><span class=\"mi\">0</span><span class=\"n\">x100664b58</span><span class=\"w\"> </span><span class=\"n\">l_List_head___rarg</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">12</span>\n<span class=\"mi\">1</span><span class=\"w\">   </span><span class=\"n\">foo</span><span class=\"w\">                                    </span><span class=\"mi\">0</span><span class=\"n\">x100598e5c</span><span class=\"w\"> </span><span class=\"n\">initialize_Foo</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">224</span>\n<span class=\"mi\">2</span><span class=\"w\">   </span><span class=\"n\">foo</span><span class=\"w\">                                    </span><span class=\"mi\">0</span><span class=\"n\">x100598eb0</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">32</span>\n<span class=\"mi\">3</span><span class=\"w\">   </span><span class=\"n\">dyld</span><span class=\"w\">                                   </span><span class=\"mi\">0</span><span class=\"n\">x193cb0274</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2840</span>\n</code></pre></div>\n<p>I think filing this as a bug on the lean4 repo seems like a decent idea, it seems likely to be minimized close enough.</p>",
        "id": 494938772,
        "sender_full_name": "Julian Berman",
        "timestamp": 1737418993
    },
    {
        "content": "<p>9/10 a duplicate bug of the closed term extraction that we already have in the issue tracker a couple of times</p>",
        "id": 494989292,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737446967
    },
    {
        "content": "<p>Yes, you're thinking of <a href=\"https://github.com/leanprover/lean4/pull/5188\">lean4#5188</a> and I already noted this in the new <a href=\"https://github.com/leanprover/lean4/pull/6721\">lean4#6721</a>.</p>",
        "id": 494989521,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1737447042
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"674953\">Will Bradley</span> has marked this topic as resolved.</p>",
        "id": 495105317,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737479364
    }
]