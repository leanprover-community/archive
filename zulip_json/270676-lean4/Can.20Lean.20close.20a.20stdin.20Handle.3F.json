[
    {
        "content": "<p>I wanted Lean to do some process communication, and I am not able to finish the data stream. It is especially annoying when the passed data would be binary. As a test, let's say we have this Lean code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tryPipe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">SpawnArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"./try_pipe.py\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[],</span>\n<span class=\"w\">    </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"n\">args</span>\n<span class=\"w\">  </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"hello</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"pipe</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"w\">  </span><span class=\"c1\">-- close finish stop somehow !</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">readToEnd</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">dedicated</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">stderr</span><span class=\"bp\">.</span><span class=\"n\">readToEnd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">wait</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">tryPipe</span>\n</code></pre></div>\n<p>calling this Python code</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"ch\">#!/usr/bin/python</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">sys</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdin</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span>\n<span class=\"c1\"># data = sys.stdin.readline()</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">\"&lt;data&gt;\"</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">end</span><span class=\"o\">=</span><span class=\"s1\">''</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">\"&lt;/data&gt;\"</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>I found <a href=\"\">a post from 2021 / 2022</a> that it was not possible. Did anything change since then?</p>",
        "id": 516504748,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1746554539
    },
    {
        "content": "<p>You might be looking for <code>takeStdin</code>.  The docstring of the function states that it closes the file handle when there are no more references to it, which seems to have the behaviour you are looking for:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tryPipe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">SpawnArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"./try_pipe.py\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[],</span>\n<span class=\"w\">    </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"n\">args</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stdinHandle</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newChild</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">takeStdin</span>\n<span class=\"w\">  </span><span class=\"n\">stdinHandle</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"hello</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">stdinHandle</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"pipe</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">stdinHandle</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"w\">  </span><span class=\"c1\">-- close finish stop somehow !</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"n\">newChild</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">readToEnd</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">dedicated</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"n\">newChild</span><span class=\"bp\">.</span><span class=\"n\">stderr</span><span class=\"bp\">.</span><span class=\"n\">readToEnd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newChild</span><span class=\"bp\">.</span><span class=\"n\">wait</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">tryPipe</span>\n</code></pre></div>",
        "id": 516541842,
        "sender_full_name": "Yann Herklotz",
        "timestamp": 1746569721
    },
    {
        "content": "<p>thanks, magic :-)</p>",
        "id": 516542688,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1746570253
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.Process.Child.takeStdin#doc\">docs#IO.Process.Child.takeStdin</a>)</p>",
        "id": 516543174,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746570417
    }
]