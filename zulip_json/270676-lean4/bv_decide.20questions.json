[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>  Picking up from the conversation <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Henrik.20B.C3.B6ving.3A.20Automated.20Bit-Level.20Reasoning.20in.20Lean.204/near/494176531\">here</a>, I played around with implementing some of these lemmas this weekend and I have maybe about ~10 done; however, I realize that upstreaming these also requires understanding what the proper form of statements required for <code>bv_decide</code> is. I have a couple of questions.</p>\n<p>1) For now I've mostly been focusing on simple statements that I really consider just missing BitVec API lemmas rather than something that has to only live in the bv_normalize simpset; however, I'm not sure how you think about this. For example, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Tactic.BVDecide.Normalize.BitVec.and_contra#doc\">docs#Std.Tactic.BVDecide.Normalize.BitVec.and_contra</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Tactic.BVDecide.Normalize.BitVec.add_not#doc\">docs#Std.Tactic.BVDecide.Normalize.BitVec.add_not</a> seem like they should just be BitVec simp lemmas to me. Or e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Tactic.BVDecide.Normalize.BitVec.shiftLeft_zero%27#doc\">docs#Std.Tactic.BVDecide.Normalize.BitVec.shiftLeft_zero'</a> seems like it's an exact copy of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.shiftLeft_zero%27#doc\">docs#BitVec.shiftLeft_zero'</a> I guess I'm just looking for if you have specific recommendations about where to put a lemma, or if it's somewhat up to personal interpretation on the given lemma's generality.</p>\n<p>2) <a href=\"https://github.com/leanprover/lean4/pull/5297\">lean4#5297</a> adds <code>BitVec.lt_irrefl</code> (among other theorems), but it's not in the simpset. Is that just an oversight or intentional?</p>\n<p>3) For now I'm avoiding anything with constant folding (as I haven't looked at the front end code at all), ite/dite (due to <a href=\"https://github.com/leanprover/lean4/pull/6453\">lean4#6453</a>), and negative constants (since it seems like reduceNeg always runs first?). Is there anything else I should avoid?</p>",
        "id": 494652479,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737301558
    },
    {
        "content": "<ol>\n<li>Yes, the reason here is that I mostly wanted to push further on as many simple rules as I could without too much regarder for the greater <code>BitVec</code> reasoning API at the time. Syncing up what we have in <code>BitVec</code> now and in the <code>BVDecide.Normalize</code> space such that general purpose <code>BitVec</code> lemmas get pulled out or in case they already are, removed and then just tagged with the <code>bv_normalize</code> attribute would be a good contribution.</li>\n<li>5297 was in preparation for work on <code>UIntX</code> around the time but yes we could add thsi into <code>bv_normalize</code> , note that the canonical form of <code>&lt;</code> is <code>BitVec.ult</code> in the <code>bv_normalize</code> simp set as I want to avoid working with both <code>Prop</code> and <code>Bool</code> so everything just gets pushed over to <code>Bool</code>. So the proper form of this lemma is <code>BitVec.ult x x = false</code>.</li>\n<li>\n<p>To comment on each:</p>\n<ul>\n<li>touching <code>ite</code>,<code>dite</code> could be fine, note however that we normalize to <code>bif</code>: <a href=\"https://github.com/leanprover/lean4/blob/master/src/Std/Tactic/BVDecide/Normalize/Bool.lean#L48\">https://github.com/leanprover/lean4/blob/master/src/Std/Tactic/BVDecide/Normalize/Bool.lean#L48</a>, so the lemmas should be written in terms of <code>bif</code>. The reason for this is that we avoid carrying around decidable instances that might need to be type checked in this way</li>\n<li>Everything with constants is a bit interesting yes, in particular things that involve negations (usually <code>-1#w</code> for example) are usually handled in the <code>Simproc</code> module that I sent you. This has the additional benefit that we will also detect a <code>-1</code> even if it's in its written out decimal form.</li>\n<li>One thing to consider avoiding might be the lemmas that have a lot of potentially symmetric appliactions. For example <code>a &amp;&amp; (!a &amp;&amp; b) = false</code> may be written in a multitude of other ways, the two sides of the and could be flipped and the inner and could be flipped as well so there are 4 versions of this lemma. While we can of course write them out there is also a world where simp learns to match lemmas up to commutativity and we might be able to make use of that.</li>\n</ul>\n</li>\n</ol>\n<p>Do you have some particular things to work on in mind?</p>",
        "id": 494653509,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737302355
    },
    {
        "content": "<p>I don't have much lean experience, so to start I think I'd like to just fill in some simple lemmas that I think the BitVec API should have regardless of <code>bv_decide</code> since I've started looking at it already. I think looking at adding more constant folding may be a simple goal to get my toes wet in meta-programming, but I should probably read MPIL first and I need to finish one of the books I'm reading before starting any more.</p>\n<p>I'll send some PRs slowly, for updates to <code>BitVec/Lemmas.lean</code> should I add you as a reviewer? And should I add lemmas to the <code>bv_normalize</code> simpset simultaneously, or is there perf/other verification you do on your end that I should be aware of?</p>",
        "id": 494654848,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737303378
    },
    {
        "content": "<p>I usually put a unit test for each rule that is added to <code>bv_normalize</code> into here: <a href=\"https://github.com/leanprover/lean4/blob/master/tests/lean/run/bv_decide_rewriter.lean\">https://github.com/leanprover/lean4/blob/master/tests/lean/run/bv_decide_rewriter.lean</a>. Evaluation on SMTLIB always takes ~half a day so we only do this on a periodic basis. Additionally one of the biggest performance issues right now is that <code>simp</code> does not perform well when hunreds of <code>let</code> are involved which is quite often the case in SMTLIB problems. That will be tackled eventually but it's going to take some time until it happens so the benefit that a lot of the rules get us will probably remain hidden underneath the noise that is caused by <code>simp</code>' struggling on large SMTLIB problems for a bit. That being said I have seen on multiple occurences in the past that adding rules can make even small problems speed up by as much as 10x so it will certainly be beneficial regardless!</p>\n<p>Yes please do ad me as a reviewer, if the rules are within the form that <code>bv_normalize</code> expects you can also tag them as shown in the stdlib files yes.</p>",
        "id": 494655328,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737303787
    },
    {
        "content": "<p>Note that one thing you can do to figure out the \"correct form of a lemma\" is just write out the rule you want to prove before putting it into <code>bv_normalize</code>, then running <code>bv_normalize</code> and inspecting the goal state</p>",
        "id": 494655467,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737303882
    },
    {
        "content": "<p>Question about reviews: <a href=\"https://github.com/leanprover/lean4/pull/6718\">lean4#6718</a> is awaiting review, it's not urgent at all, but I wasn't sure if I should ping the ticket since it may have fallen of the review stack, or what the normal procedure is in such cases.</p>\n<p>I've been finished with what I considered all of the low-hanging fruit on the list for a few days. I figured I'd share the illustrative tests here in case you have comments on any of them (in parens is the line of the spreadsheet it correlates to). I think with the exception of the last rule (mul + shiftleft), there should not be concerns about confluence with any of them, though I wasn't sure 100% if there are concerns for the lemmas for sub-&gt;add (44 in the spreadsheet)</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- neg_mul / mul_neg (181,182)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~~~</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~~~</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~~~</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- or_beq_zero_iff (25)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|||</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- xor_beq_zero_iff (24)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- add_left_eq_self / add_right_eq_self (42)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- add_left_inj / add_right_inj (43,36)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"c1\">-- TODO remove</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span><span class=\"w\"> </span><span class=\"c1\">-- Didn't use to work</span>\n\n<span class=\"c1\">-- eq_sub_iff_add_eq / sub_eq_iff_eq_add (44)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- lt_irrefl (218,248)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">ult</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">slt</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- not_lt_zero (245)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">ult</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- lt_one_iff (246)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">ult</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- ushiftRight_self (209)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- ushiftRight_eq_zero / shiftLeft_eq_zero (200,207)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n\n<span class=\"c1\">-- shiftLeft_mul / mul_shiftLeft (185)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_normalize</span>\n</code></pre></div>\n</div></div>",
        "id": 495968373,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737898770
    },
    {
        "content": "<p>6718 is fine from my side, I'm just waiting for Kim to approve but she is on holiday till tomorrow so that's why its taking a while</p>",
        "id": 495972843,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737902735
    },
    {
        "content": "<p>And I think these are pretty great! I'd suggest to wait until Kim approved 6718 and then we can start upstreaming the rest.</p>",
        "id": 495972988,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737902867
    },
    {
        "content": "<p>Though looking through the lemmas I think the easiest to merge are probably going to be (apart from the one alrady in PR):</p>\n<ul>\n<li>218,248</li>\n<li>245</li>\n<li>246</li>\n<li>209</li>\n<li>42</li>\n<li>43,36</li>\n</ul>\n<p>and then we can look into the remainder. In particular if you can prove some of these without extending any theory by <code>BitVec</code> I'd also be willing to review and merge them myself, I'm just holding off on the current PR because I'm no expert on the Int theory</p>",
        "id": 496066625,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737968315
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span></p>",
        "id": 496066728,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737968357
    },
    {
        "content": "<p>Sounds good, I figured I'd submit follow-up PRs one-by-one until I feel confident enough that I'm aligned with reviewer expectations that I'm not wasting reviewer time parallelizing them.</p>\n<p>I just looked at my local git diff and I've implemented every one of these in BitVec/Lemmas.lean (modulo maybe adding some symmetries for bv_normalize.) The backing theorems seem (to me) to be general enough to be worth having outside of bv_normalize, though I'm happy to move them if you or Kim disagree.</p>",
        "id": 496068511,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737968862
    },
    {
        "content": "<p>I do think that at least for a couple of these it's useful to have them in BitVec.Lemmas so feel free to leave them there and sen the PR for irrefl <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 496068705,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737968919
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> one thing, could you comment <code>changelog-language</code> on your PR so that it lands in the correct changelog section?</p>",
        "id": 496076001,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737971334
    },
    {
        "content": "<p>Sure, should I do this for every PR? The PR submission text I think mentions changelog-library or no-changelog being added by reviewers for external PRs</p>",
        "id": 496076164,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737971396
    },
    {
        "content": "<p>In general we are touching a language feature here so it should be in the language changelog</p>",
        "id": 496080759,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737971429
    },
    {
        "content": "<p>Also it seems one of the counter example tests broke, let's see</p>",
        "id": 496080967,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737971510
    },
    {
        "content": "<p>Ah the last test is now so easy that <code>bv_normalize</code> already changes it to <code>True</code></p>",
        "id": 496081180,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737971578
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/blob/master/tests/lean/run/bv_counterexample.lean#L112-L118\">https://github.com/leanprover/lean4/blob/master/tests/lean/run/bv_counterexample.lean#L112-L118</a> If you make this a slightly harder example the test should pass again. The background is that if bv_normalize already detects that a theorem is always incorrect by rewriting we currently throw this error about not finding any theorems as we just reduce the proof by contradiction hypothesis to <code>True</code></p>",
        "id": 496081374,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737971648
    },
    {
        "content": "<p>sorry, I thought i had run the test suite locally and verified it was green. Will fix now</p>",
        "id": 496081432,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1737971668
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/270676-lean4/topic/bv_decide.20questions/near/496081432\">said</a>:</p>\n<blockquote>\n<p>sorry, I thought i had run the test suite locally and verified it was green. Will fix now</p>\n</blockquote>\n<p>Merged, feel free to continue^^</p>",
        "id": 496136076,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737988233
    },
    {
        "content": "<p>I've left a comment. I'd like to have the <code>mod</code>/<code>tmod</code>/<code>fmod</code> variants of your new <code>bmod_neg_bmod</code> theorem (if such exist?). I'm happy either if you add them here, or we add them to an internal TODO list (I don't want to bog down a new contributor too much!)</p>",
        "id": 496225559,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738018545
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> I put the lt_one_iff one on the merge queue.</p>",
        "id": 496283776,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738054119
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> <a href=\"https://github.com/leanprover/lean4/pull/6849#issuecomment-2621777762\">https://github.com/leanprover/lean4/pull/6849#issuecomment-2621777762</a> is writing a simproc something you feel able to do? Or should I take that?</p>",
        "id": 496558533,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738160244
    },
    {
        "content": "<p>I think not at the moment, I'd rather have a better grasp of meta-programming before spending anyone else's time to review my code. I am curious about the answer to <a href=\"https://github.com/leanprover/lean4/pull/6849#issuecomment-2623782902\">https://github.com/leanprover/lean4/pull/6849#issuecomment-2623782902</a> though, e.g. when would the simproc handle cases that it doesn't right now? And when does Lean auto-synthesize those hypotheses actually?</p>",
        "id": 496713422,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738224214
    },
    {
        "content": "<p>When simp tries to apply a simp theorem that has pre conditions it tries to run its so called discharger to resolve them. It would appear that the default discharger is powerful enough for the constant case</p>",
        "id": 496714291,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738224541
    },
    {
        "content": "<p>Yeah from local testing it can't handle the <code>16 ≤ x + 20</code> case</p>",
        "id": 496714862,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738224757
    },
    {
        "content": "<p>Yes one would need to change the discharger to e.g. <code>omega</code> for that but we don't want that for bv_decide</p>",
        "id": 496715551,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738225020
    },
    {
        "content": "<p>The 3 remaining changes I have locally are <code>shiftLeft_mul</code> / <code>eq_sub_iff_add_eq</code> / <code>or_beq_zero_iff</code> + <code>xor_beq_zero_iff</code> from above. Do you think any of these should also be handled by simproc? I could imagine perhaps the or/xor ones could be handled more generally by splitting ands/ors/xors comparisons to constants into bitsliced comparisons instead of just handling the 0 cases.</p>",
        "id": 496716125,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738225214
    },
    {
        "content": "<ul>\n<li><code>shiftLeft_mul</code> is probably going to have to be implemented differently. After all we wish to reduce shifts by constants to a zero vec + extract so the pattern from your simp lemma is not going to match that. It would probably still be useful if we had the theorem for the <code>x &lt;&lt;&lt; y</code> <code>y : BitVec w</code> case.</li>\n<li><code>eq_sub_iff_add_eq</code> is probably fine but it's of course important to keep the symmetries in mind here</li>\n<li><code>or_beq_zero_iff</code> and <code>xor_beq_zero_iff</code> are fine I would say</li>\n</ul>",
        "id": 496718116,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738225882
    },
    {
        "content": "<p>btw as a little motivation towards this effort, when we measured SMTLIB the last time benchmarks like <a href=\"https://pastebin.com/0DWTufRg\"><code>sage/app1/bench_2187.smt2</code></a> used to take hundreds of seconds. I took another measurement yesterday and this one is now solved  instantly in the rewriting stage <a href=\"https://share.firefox.dev/40TuUje\">https://share.firefox.dev/40TuUje</a> this is of course very punctual, we didn't generally get a 100x improvement but it shows how effective rewriting systems can be. Looking forward to getting some fresh bv_decide data potentially next week on all of SMTLIB^^</p>",
        "id": 496730454,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738229880
    },
    {
        "content": "<p>is the below a refactor that still needs to be done? <br>\n<code>1. Yes, the reason here is that I mostly wanted to push further on as many simple rules as I could without too much regarder for the greater `BitVec` reasoning API at the time. Syncing up what we have in `BitVec` now and in the `BVDecide.Normalize` space such that general purpose `BitVec` lemmas get pulled out or in case they already are, removed and then just tagged with the `bv_normalize` attribute would be a good contribution.</code></p>",
        "id": 496870421,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1738271954
    },
    {
        "content": "<p>I would say it's been getting less and less as Vlad has been pushing on the rewrites I would say, scrolling through the file right now nothing instantly jumps at me anymore. <span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> do you have some left on your TODO list?</p>",
        "id": 496871065,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738272200
    },
    {
        "content": "<p>I think there's some unification that could be done (e.g. and_contra can now depend on BitVec.and_not_self, this example isn't any shorter line-wise but it's just a bit cleaner as it's depending on BitVec results instead of reproving things), and some results can still be in BitVec like <code>BitVec.zero_lt_iff_zero_neq</code>. I haven't really looked at it, I thought I might try to do a once over once my current changes are merged, but happy to have someone else take a look</p>",
        "id": 496878508,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738275276
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> did you not derive a bv_normalize theorem from and_eq_allOnes_iff on purpose?</p>",
        "id": 497006165,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738329771
    },
    {
        "content": "<p>I thought since it needs to match against -1 it needs a simproc</p>",
        "id": 497006532,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738329895
    },
    {
        "content": "<p>Ah! You are correct yes</p>",
        "id": 497006569,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738329906
    },
    {
        "content": "<p>Yea I just included it for API completeness on the bitvec side</p>",
        "id": 497006860,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738330002
    },
    {
        "content": "<p>Makes sense yes <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 497006889,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738330011
    },
    {
        "content": "<p>Okay I put the stuff on the merge queue now. What's the next step from your side?</p>",
        "id": 497007719,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738330275
    },
    {
        "content": "<p>I will submit <code>eq_sub_iff_add_eq / sub_eq_iff_eq_add</code> and I need to think about what you said about <code>shiftLeft_mul / mul_shiftLeft</code> and see if it still makes sense to contribute. After that I'll take another scan of the spreadsheet, but I may be done with the simplest rewrites that don't require simprocs. If I see nothing else I'll probably have another PR or two to clean up things I noticed but otherwise I'll set it down for now.</p>",
        "id": 497011679,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738331557
    },
    {
        "content": "<p>Sounds good, if you want to get into writing simprocs feel free to ask questions^^</p>",
        "id": 497012627,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738331870
    }
]