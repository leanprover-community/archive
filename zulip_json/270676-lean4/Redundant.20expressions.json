[
    {
        "content": "<p>Hi all, <br>\nI'm working through some algebraic calculation-style proofs. They often end up having a few long algebraic expressions that need to be typed out multiple times in Lean. Here's a still relatively short example where a quadratic polynomial expression is used multiple times.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">*</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">*</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n</code></pre></div>\n<p>I want to copy the expression <code>x ^ 2 - 3 * x + 2</code> that was typed out in the header of the proof in the two <code>calc</code> blocks without typing them out manually. I.e. I want to replace the two instances of this expression inside the <code>calc</code> blocks by some Lean code along the lines of <code>currentTheorem.goal.leftHandSide</code>. How can I approach this? I have a feeling this involves meta programming in Lean but I'm not sure where to find this in the documentation.</p>",
        "id": 459447538,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723203072
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">rhs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">*</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">*</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n</code></pre></div>",
        "id": 459448060,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723203184
    },
    {
        "content": "<p>That's it! I'm trying to find documentation for the refine (tactic?) but I'm not succesful so far. Do you know how I can handle the case where the expression I'm interested in is part of one of the hypotheses in the theorem header? I.e.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">*</span><span class=\"n\">y</span><span class=\"bp\">=</span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">neq</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 459453679,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723204504
    },
    {
        "content": "<p>This works but is really a hack:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">*</span><span class=\"n\">y</span><span class=\"bp\">=</span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"bp\">_;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"c1\">-- to prove that we captured `lhs`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 459456530,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723205277
    },
    {
        "content": "<p>Maybe <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> can come up with a better way using existing tactics</p>",
        "id": 459456592,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723205290
    },
    {
        "content": "<p>maybe something like <code>generalize</code> might help?</p>",
        "id": 459459886,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723206300
    },
    {
        "content": "<p>Hmm, how would you use that? Looking at the hover documentation it seems to be useful for substituting parts of the goal by another expression.</p>",
        "id": 459460508,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723206514
    },
    {
        "content": "<p>it means you get to name an expression, not just substitute for a variable.</p>",
        "id": 459462774,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723207174
    },
    {
        "content": "<p>i.e. when you want to capture some expression <code>e</code>, write <code>gereralize h: e = z</code>, then when you'd like to refer to <code>e</code>, rather refer to <code>z</code> , then rewrite with <code>h.symm</code>.</p>",
        "id": 459463088,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723207234
    },
    {
        "content": "<p>or maybe i'm misunderstanding your questions...</p>",
        "id": 459463332,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723207309
    },
    {
        "content": "<p>What I'm getting from what you said is this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">generalize</span><span class=\"w\"> </span><span class=\"n\">hyp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>This leaves the proof state as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span>\n<span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">hyp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 459464602,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723207606
    },
    {
        "content": "<p>What I want is to be able to capture some subexpression from the theorem header. Then I can re-use it later in the proof without manually typing the expression again and again. E.g.<code>exact (2 + whateverVariableTheSubExpressionEndedUpIn)/\\pi</code> where whateverVariableTheSub.... could be a term that could span half a page for example.</p>",
        "id": 459464838,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723207662
    },
    {
        "content": "<p>I feel, and emphasis on feel, like generalize doesn't do what I want, although it does seem like a useful tactic to know in general :)</p>",
        "id": 459465015,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723207700
    },
    {
        "content": "<p>Does something like <code>let y = ?_; change y = _</code> work?</p>",
        "id": 459472707,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723209596
    },
    {
        "content": "<p>I assume you saw that I was able to use (mathlib's) <code>have</code> to do something similar above, <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span>?</p>",
        "id": 459473137,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723209694
    },
    {
        "content": "<p>Yeah, but it seemed very convoluted</p>",
        "id": 459519852,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723221343
    },
    {
        "content": "<p>Preferably it would be possible to do this using a short expression. At least these two approaches work for taking a part of a hypothesis or a goal. Maybe the second approach could be shortened using a custom tactic?</p>",
        "id": 459674218,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723286700
    },
    {
        "content": "<p>Does the <code>set</code> tactic help?</p>",
        "id": 459677484,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723287493
    },
    {
        "content": "<p>Writing <code>set P := &lt;long expression&gt;</code> will define <code>P</code> as your long expression, and replace it in your goal wherever it occurs. You can use <code>set P := with h</code> to get a hypothesis <code>P=long expression</code>, to rewriting with if you need it.</p>",
        "id": 459677775,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723287617
    },
    {
        "content": "<p>That's a nice tactic to know about, but it's not exactly what I want. Using <code>let</code> or <code>set</code> is a nice and clean way to store long expressions, but it would still require you to type out the expression you want to copy at least one more time.</p>",
        "id": 459678535,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723287952
    },
    {
        "content": "<p>I feel like there should be some way to access the definition of the goal and the parts that make up that goal. Maybe using metaprogramming. I.e. how I described it before using <code>currentTheorem.goal.leftHandSide</code>. This way you can insert any expression you want while you're in the middle of writing a proof step.</p>",
        "id": 459679319,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723288288
    },
    {
        "content": "<p>I think that there was a <code>setm</code> tactic in the making on which <span class=\"user-mention\" data-user-id=\"579936\">@Gareth Ma</span> was working.</p>\n<p>I think that this may be up for adoption, but I'll let Gareth comment on that!</p>",
        "id": 459692377,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723294288
    },
    {
        "content": "<p>It would be nice if <code>change ?lhs = ?rhs</code> and <code>change ?lhs = ?rhs at h</code> were valid here</p>",
        "id": 459692527,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723294415
    },
    {
        "content": "<p>Speaking of randomly sticking metavariables somewhere, I'd love to be able to write things like <code>have : (x + y) ^ 3 = x ^ 3 + y ^ 3 + 3 * ?foo := by ring</code> (tangentially related at best)</p>",
        "id": 459704338,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723300045
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/Redundant.20expressions/near/459692377\">said</a>:</p>\n<blockquote>\n<p>I think that there was a <code>setm</code> tactic in the making on which <span class=\"user-mention silent\" data-user-id=\"579936\">Gareth Ma</span> was working.</p>\n<p>I think that this may be up for adoption, but I'll let Gareth comment on that!</p>\n</blockquote>\n<p>Yes I was working on the setm tactic, but it has been a while. I don’t quite remember what is blocking it either, but if anyone wants to takeover, feel free to. IIRC it’s most working already, there’s a PR and some tests from the PR that shows how to use it.</p>",
        "id": 459704851,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300286
    },
    {
        "content": "<p>Sounds interesting, what is the purpose of <code>setm</code>?</p>",
        "id": 459705249,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723300549
    },
    {
        "content": "<p>IIRC if u have a goal x^2+y^2=z^2 then u can setm ?x + ?y = ?z and it set all of them. I think the m means set multiple, but not sure</p>",
        "id": 459705412,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300603
    },
    {
        "content": "<p>(Someone else suggested the name - I think Damiano? Lol)</p>",
        "id": 459705433,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300616
    },
    {
        "content": "<p>Also, <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> what is the <code>change</code> tactic meant to do? I can't find it in the docs, my search skills still need some work</p>",
        "id": 459705446,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723300624
    },
    {
        "content": "<p>From what I understand change changes the term and type of something to another that’s defeq. For example if you have n+0=3 at a hypothesis then you can change n=3 at h, because n+0 is defeq to n for nat.</p>",
        "id": 459705646,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300719
    },
    {
        "content": "<p>Sorry I’m on phone</p>",
        "id": 459705654,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300721
    },
    {
        "content": "<p>I am on a train, so same here :)</p>",
        "id": 459705852,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723300802
    },
    {
        "content": "<p>Your <code>setm</code> descriptions sounds quite useful!  It would still require a separate line of Lean code to obtain whatever expression you want, and I'd prefer a quick inline version, but maybe I could build on this!</p>",
        "id": 459706124,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723300905
    },
    {
        "content": "<p>I'd need to work on more than just my search skills for that :P I assume <code>setm</code> involves some metaprogramming? Or is it basic Lean?</p>",
        "id": 459706248,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723300953
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/xem5Kmg5SOlOUiPSHt6KcCw3/6BC93A01-D402-4240-8977-9C287F1B6F8C.jpg\">6BC93A01-D402-4240-8977-9C287F1B6F8C.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/xem5Kmg5SOlOUiPSHt6KcCw3/6BC93A01-D402-4240-8977-9C287F1B6F8C.jpg\" title=\"6BC93A01-D402-4240-8977-9C287F1B6F8C.jpg\"><img data-original-dimensions=\"1448x915\" src=\"/user_uploads/thumbnail/3121/xem5Kmg5SOlOUiPSHt6KcCw3/6BC93A01-D402-4240-8977-9C287F1B6F8C.jpg/840x560.webp\"></a></div>",
        "id": 459706269,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723300982
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"603023\">Rick de Wolf</span> <a href=\"#narrow/stream/270676-lean4/topic/Redundant.20expressions/near/459706248\">said</a>:</p>\n<blockquote>\n<p>I'd need to work on more than just my search skills for that :P I assume <code>setm</code> involves some metaprogramming? Or is it basic Lean?</p>\n</blockquote>\n<p>I.e. the code of setm itself requires metaprogramming. Not whether a user of setm would need metaprogramming.</p>",
        "id": 459707118,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723301197
    },
    {
        "content": "<p>Based on your description of <code>change</code> I'm not sure how it helps with expression 'copy-paste'. Could you elaborate <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>?</p>",
        "id": 459707259,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723301271
    },
    {
        "content": "<p>If the rules were \"<code>change</code> is allowed to assign metavariables\" then it would work out of the box</p>",
        "id": 459707328,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723301305
    },
    {
        "content": "<p>If that’s the case then my setm is duplicating the same functionality?</p>",
        "id": 459707383,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723301340
    },
    {
        "content": "<p>Only in the same way that <code>set</code> duplicates <code>generalize</code>, so I think there is still room for <code>setm</code></p>",
        "id": 459707442,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723301365
    },
    {
        "content": "<p>That's starting to make sense now. So I assume what you'd need to make that work is that a metavariable can be definitionally equal to any expression?</p>",
        "id": 459707821,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723301472
    },
    {
        "content": "<p>That's already how it works, see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.isDefEq#doc\">docs#Lean.Meta.isDefEq</a></p>",
        "id": 459713325,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723303449
    },
    {
        "content": "<p>But if you call <code>withNewMCtxDepth</code>, then any metavariables created outside that call are not eligible for that behavior</p>",
        "id": 459713418,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723303471
    },
    {
        "content": "<p>I dont entirely understand what prevents <code>change</code> from being useful in the 'copy-paste' problem, but do you think there is a chance it could be fixed?</p>",
        "id": 459715281,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723304559
    },
    {
        "content": "<p>With respect to the name <code>setm</code> is in analogy with <code>congrm</code> and the name there is <code>congr</code> with a <code>m</code>atch, since the user introduces a pattern that the tactic tries to match in the given goal/hypothesis.</p>",
        "id": 459759262,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723323228
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Redundant.20expressions/near/459707328\">said</a>:</p>\n<blockquote>\n<p>If the rules were \"<code>change</code> is allowed to assign metavariables\" then it would work out of the box</p>\n</blockquote>\n<p>This makes <code>change</code> behave in the way I was suggesting:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">loc</span><span class=\"o\">:</span><span class=\"n\">location</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withLocation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">expandOptLocation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkOptionalNode</span><span class=\"w\"> </span><span class=\"n\">loc</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">atLocal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hTy</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">        </span><span class=\"c1\">-- In a previous iteration, this was a hack to get the new type to elaborate in the</span>\n<span class=\"w\">        </span><span class=\"c1\">-- same sort of way that it would for a `show` expression for the goal.</span>\n<span class=\"w\">        </span><span class=\"c1\">-- We don't want the semantics of `show` anyway though, so it's not clear whether this</span>\n<span class=\"w\">        </span><span class=\"c1\">-- is still a hack.</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"c1\">-- using a type ascription rather tha</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTermWithHoles</span>\n<span class=\"w\">                          </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">hTy</span><span class=\"w\"> </span><span class=\"ss\">`change</span>\n<span class=\"w\">        </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">changeLocalDecl</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">atTarget</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">refine_lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">)))</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"change tactic failed\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Unfortunately, this requires it to assign _all_ metavariables, so now you can't create subgoals with <code>change</code> like you currently can.</p>",
        "id": 459879832,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723374097
    },
    {
        "content": "<p>Sorry for the slight delay in answering :) All of these approaches sound interesting to me, but the first two that were proposed, by Eric, seem like the best way to go for now. The other approaches require typing out the expression one more time, which seems a little \"unergonomic\" to me. I will hopefully have more time to look into this after I'm back from my holiday, then I'll be able to test these approaches properly :) Thanks for all the suggestions!</p>",
        "id": 462594423,
        "sender_full_name": "Rick de Wolf",
        "timestamp": 1723741383
    },
    {
        "content": "<p>Maybe my definition of \"typing out the expression\" is different, but I'm pretty sure mine doesn't require that</p>",
        "id": 462594718,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1723741463
    },
    {
        "content": "<p>I'm sure you have more complicated examples where this wouldn't work, but my approach would be to give a high-level automation-based proof. If you were to explain this to someone, you'd say \"just substitute the possible values in for <code>x</code> and then evaluate\", right?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">subst_vars</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n</code></pre></div>",
        "id": 462597224,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723742175
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, do you have a feeling for whether the change to <code>change</code> I propose is possible? The difficulty arises from wanting <code>?foo</code> to create a metavariable that is either immediately assigned by unification, or deferred to a subgoal if unification fails. Currently the behavior is to always defer and forbid assignment, while my message above always assigns but doesn't allow any deference.</p>",
        "id": 462597989,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723742422
    },
    {
        "content": "<p>Are there examples where deference is wanted? I know there are tests for it, but (if I remember correctly) they're there just to make sure that they're handled correctly due to it being theoretically possible, not necessarily useful.</p>",
        "id": 462600597,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723743197
    },
    {
        "content": "<p>(It might be worth testing with <code>(id $(← Term.exprToSyntax mvar) : $newType)</code> too. Maybe it was fixed in the meantime, but I remember at some point <code>convert</code> needed an <code>id</code> to make sure some metavariables were collected properly.)</p>",
        "id": 462600837,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723743296
    },
    {
        "content": "<p>I could imagine wanting something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">fooHom</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>where <code>hn : n.Prime</code> or something</p>",
        "id": 462603792,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723744376
    },
    {
        "content": "<p>This seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">builtin_tactic</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">loc</span><span class=\"o\">:</span><span class=\"n\">location</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withLocation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">expandOptLocation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkOptionalNode</span><span class=\"w\"> </span><span class=\"n\">loc</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">atLocal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hTy</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTermWithHoles</span>\n<span class=\"w\">                          </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">hTy</span><span class=\"w\"> </span><span class=\"ss\">`change</span>\n<span class=\"w\">        </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">changeLocalDecl</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">atTarget</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">refine_lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">newType</span><span class=\"o\">)))</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"change tactic failed\"</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 462605692,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723744970
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooHom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"c1\">-- x : Nat := foo 2</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">fooHom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- fooHom 2 ?hp = 4</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- Prime 2</span>\n</code></pre></div>",
        "id": 462606442,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723745099
    },
    {
        "content": "<p>(Each <code>id</code> is necessary to make sure metavariables are collected from the type of the metavariable. It might be a bug in <code>getMVarsNoDelayed</code> but I'm not sure.)</p>",
        "id": 462606898,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723745174
    },
    {
        "content": "<p>Happy to PR that?</p>",
        "id": 462609711,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723745652
    },
    {
        "content": "<p>If you have time, it'd be worth creating a PR on <code>nightly-with-mathlib</code> and seeing how bad the fallout is with mathlib. I'm not sure when I can get to investigating this one myself.</p>",
        "id": 462610191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723745736
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5063\">lean4#5063</a></p>",
        "id": 462612332,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723746323
    },
    {
        "content": "<p>Unfortunately this is running into <a href=\"https://github.com/leanprover-community/batteries/pull/889\">batteries#889</a></p>",
        "id": 462654706,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723762454
    },
    {
        "content": "<p>(actually, there are lots of failures)</p>",
        "id": 462654798,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723762528
    }
]