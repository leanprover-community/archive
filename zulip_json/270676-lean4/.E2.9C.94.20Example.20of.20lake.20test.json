[
    {
        "content": "<p>The lake documentation says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">5.0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"mi\">3</span><span class=\"n\">b58e06</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"o\">)</span>\n\n<span class=\"n\">USAGE</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OPTIONS</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">COMMAND</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">COMMANDS</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">name</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">temp</span><span class=\"bp\">&gt;</span><span class=\"w\">     </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"w\">  </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">name</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">temp</span><span class=\"bp\">&gt;</span><span class=\"w\">    </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"w\">  </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">targets</span><span class=\"bp\">&gt;...</span><span class=\"w\">    </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">targets</span>\n<span class=\"w\">  </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">exe</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">args</span><span class=\"bp\">&gt;...</span><span class=\"w\">   </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Lake's</span><span class=\"w\"> </span><span class=\"n\">environment</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\">                  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">configured</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">driver</span>\n<span class=\"w\">  </span><span class=\"n\">check</span><span class=\"bp\">-</span><span class=\"n\">test</span><span class=\"w\">            </span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">there</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">properly</span><span class=\"w\"> </span><span class=\"n\">configured</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">driver</span>\n</code></pre></div>\n<p>How does the <code>test</code> command work? Is there an example of it?</p>",
        "id": 463125270,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1723969469
    },
    {
        "content": "<p>I think batteries uses it now</p>",
        "id": 463128714,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723971000
    },
    {
        "content": "<p>I just went through this yesterday. Fwiw the best documentation for Lake is the README in its subdirectory; <a href=\"https://github.com/leanprover/lean4/tree/master/src/lake#lake\">https://github.com/leanprover/lean4/tree/master/src/lake#lake</a></p>\n<p>A minimal setup involves this lakefile, and (as an example) a file <code>&lt;project root&gt;/scripts/test.lean</code> as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add package configuration options here</span>\n<span class=\"w\">  </span><span class=\"n\">testDriverArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"testArg1\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"testArg2\"</span><span class=\"o\">]</span>\n\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Foo</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add library configuration options here</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">test_driver</span><span class=\"kd\">]</span>\n<span class=\"c1\">-- `test` is the name of the file.</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"scripts\"</span>\n</code></pre></div>\n<p>The <code>test.lean</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"test arg := {arg}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"starting tests\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"s2\">\"shouldFail\"</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">args</span>\n<span class=\"w\">  </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n</code></pre></div>\n<p>Will run with an exit code 1 if it gets the arg <code>shouldFail</code>, and 0 otherwise. I just inferred this from looking at batteries, so I guess the behavior that constitutes success/failure is currently open-ended. As Ruben noted, the batteries example is obviously more in depth.</p>",
        "id": 463144326,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1723977213
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> has marked this topic as resolved.</p>",
        "id": 463245489,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724017974
    },
    {
        "content": "<p>Another way to use <code>lake test</code> is simply as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">test_driver</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FooTest</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n</code></pre></div>\n<p>and then put a bunch of files in <code>FooTest/</code>, and import them from <code>./FooTest.lean</code>.</p>\n<p>This suffices if just building a bunch of files is all you need to do to test.</p>\n<p>In fact, as this applies to both Batteries and Mathlib, if someone wanted to arrange that it might be a good idea.</p>\n<p>Notice that <code>Aesop</code> already uses this mechanism for its tests.</p>",
        "id": 464526550,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724382627
    }
]