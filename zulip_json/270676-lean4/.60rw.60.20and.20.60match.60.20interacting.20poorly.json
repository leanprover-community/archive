[
    {
        "content": "<p>I have been trying to abstract away some rewriting of an expression involving what looks like a <code>match</code> statement, and it's proven painful because while the term in the rewrite matches the term in my real goal syntactically, at face value, there is a discrepancy in implicits that makes the rewrite not work.</p>\n<p>It's going to be painful to minimize, but the vague idea is of the shape:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\"> </span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">apply</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e2</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">e3</span>\n<span class=\"w\">  </span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e4</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>When I try to apply my rewrite lemma, even passing explicitly all the abstracted variables so as to get a full syntactic match, I get the classic:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`rewrite</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">occurrence</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ZKOpInterp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZKOp</span><span class=\"bp\">.</span><span class=\"n\">ConstrainR1CS</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">())))</span><span class=\"bp\">.</span><span class=\"n\">apply</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"bp\">⌝</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptConds</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">ExceptConds</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ZKOpInterp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZKOp</span><span class=\"bp\">.</span><span class=\"n\">ConstrainR1CS</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">())))</span><span class=\"bp\">.</span><span class=\"n\">apply</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"bp\">⌝</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptConds</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">ExceptConds</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Of course, these terms look identical.</p>\n<p>Now if I print the two terms with full explicit, I'll save you the gory details, but they differ so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"n\">c2</span><span class=\"o\">,</span><span class=\"mi\">3</span>\n<span class=\"bp\">&lt;</span><span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">myLemma</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span>\n<span class=\"bp\">&lt;</span><span class=\"w\">       </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"w\"> </span><span class=\"n\">PostShape</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ZKState</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"o\">)))</span>\n<span class=\"c1\">---</span>\n<span class=\"bp\">&gt;</span><span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instWPZKBuilderArgZKStateExceptPUnitPure</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"bp\">&gt;</span><span class=\"w\">       </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExceptT</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PredTrans</span><span class=\"w\"> </span><span class=\"n\">PostShape</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ZKState</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"o\">)))</span>\n<span class=\"mi\">26</span><span class=\"n\">c26</span><span class=\"o\">,</span><span class=\"mi\">27</span>\n<span class=\"bp\">&lt;</span><span class=\"w\">         </span><span class=\"bp\">@</span><span class=\"n\">myLemma</span><span class=\"bp\">.</span><span class=\"n\">match_3</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Assertion</span><span class=\"w\"> </span><span class=\"n\">PostShape</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"c1\">---</span>\n<span class=\"bp\">&gt;</span><span class=\"w\">         </span><span class=\"bp\">@</span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">pushExcept</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">ZKState</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Assertion</span><span class=\"w\"> </span><span class=\"n\">PostShape</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;</span><span class=\"w\">           </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>So, it appears that the first <code>match</code>, while being displayed syntactically similarly, ends up being in my real context the call to some bespoke <code>match_1</code> field of some instance, while in my lemma, it's yet another bespoke <code>myLemma.match_3</code> that was seemingly generated to handle the typing of my syntactic <code>match</code> expression.</p>\n<p>Now my questions:</p>\n<ul>\n<li>How much does Lean handle these <code>match</code> expressions? Is there no hope for them to ever match?</li>\n<li>Do I need to unfold all such matches until I reach the primitive recursors if want any chance at using a rewrite lemma?</li>\n<li>Are there techniques to deal with such issues?</li>\n</ul>",
        "id": 561737375,
        "sender_full_name": "Valentin Robert",
        "timestamp": 1764790404
    },
    {
        "content": "<p>does <code>split</code> work?</p>",
        "id": 561737501,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764790445
    },
    {
        "content": "<p>Oooh, I did not know about <code>split</code>, and it pretty much does much of what I wanted to do with this rewrite lemma! Thanks for the suggestion!</p>",
        "id": 561737706,
        "sender_full_name": "Valentin Robert",
        "timestamp": 1764790507
    },
    {
        "content": "<p>Hmmm, it's unfortunate that it introduces hypotheses without letting me name them though, I need it to split more in the introduced hypothesis but it has an unreachable name.</p>",
        "id": 561738968,
        "sender_full_name": "Valentin Robert",
        "timestamp": 1764790932
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 561739967,
        "sender_full_name": "Ilmārs Cīrulis",
        "timestamp": 1764791273
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 561740114,
        "sender_full_name": "Ilmārs Cīrulis",
        "timestamp": 1764791325
    },
    {
        "content": "<p>you can <code>rename_i</code> the hypotheses</p>",
        "id": 561741102,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764791672
    }
]