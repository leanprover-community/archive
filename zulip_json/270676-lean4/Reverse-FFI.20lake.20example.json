[
    {
        "content": "<p>Hi! I made a fresh clone of the Lean4 repo so I could play with the examples <code>src/lake/examples/reverse-ffi</code> <code>src/lake/examples/ffi</code>as I need a python reverse-ffi (as in, call lean functions from python) for a project i'm working on. However, I'm having trouble running <code>test.sh</code> in each of the examples, as they both return:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">LAKE</span><span class=\"bp\">=../../.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">clean</span><span class=\"bp\">.</span><span class=\"n\">sh</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">LAKE</span><span class=\"bp\">=../../.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">run</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">downloading</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lean'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"n\">nonexistent</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"ss\">`lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0</span><span class=\"bp\">`</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">releases</span><span class=\"bp\">/</span><span class=\"n\">expanded_assets</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0'</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ahuja</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">b62uenk3oey3gc4h_file'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">unsuccessful</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">404</span>\n<span class=\"bp\">../../.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"c1\">--dir=lib build</span>\n<span class=\"n\">make</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">../../.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">make</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">***</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">lake</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Any way to fix this so I can run the (reverse) ffi and any guidance on how to implement one for python? Thanks</p>",
        "id": 480253642,
        "sender_full_name": "Riyaz Ahuja",
        "timestamp": 1730584955
    },
    {
        "content": "<p>Nevermind, I figured out a good workaround and just made a simple C reverse FFI (exact same code as in the lean repo in a new project). However, how does one usually extend this to also work with functions with many dependencies to mathlib and other files in the project?</p>\n<p>Also, is there any reasonable way to map this into python afterward (ctypes or something?)</p>",
        "id": 480322263,
        "sender_full_name": "Riyaz Ahuja",
        "timestamp": 1730653143
    },
    {
        "content": "<p>Hi all, the <a href=\"https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi\">reverse FFI example</a> of the lean4 repository does not compile for me. I get the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">make</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">***</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">out</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Any tips?</p>",
        "id": 504715193,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741653648
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"562377\">Derek Sorensen</span> <a href=\"#narrow/channel/270676-lean4/topic/Reverse-FFI.20lake.20example/near/504715193\">said</a>:</p>\n<blockquote>\n<p>Hi all, the <a href=\"https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi\">reverse FFI example</a> of the lean4 repository does not compile for me. I get the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">make</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">***</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">out</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Any tips?</p>\n</blockquote>\n<p><a href=\"https://leni.sh/post/240304-rust-call-lean/\">https://leni.sh/post/240304-rust-call-lean/</a></p>\n<p>I don't know if this example still works but my project is based on it. It shows a use case reverse FFI from Rust.</p>",
        "id": 504758987,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1741677504
    },
    {
        "content": "<p>I haven't had any luck getting your example to work <span class=\"user-mention\" data-user-id=\"599027\">@Leni Aniva</span> :/</p>",
        "id": 504865363,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741704871
    },
    {
        "content": "<p>On further inspection, when trying to use the lean-generated library, my machine complains that the <code>__DATA_CONST</code> segment is not read-only.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">DATA_CONST</span><span class=\"w\"> </span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">SG_READ_ONLY</span><span class=\"w\"> </span><span class=\"n\">flag</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">dhsorens</span><span class=\"bp\">/</span><span class=\"n\">devel</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">/</span><span class=\"n\">reverse</span><span class=\"bp\">-</span><span class=\"n\">ffi</span><span class=\"bp\">-</span><span class=\"n\">repo</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libRFFI</span><span class=\"bp\">.</span><span class=\"n\">dylib'</span>\n</code></pre></div>",
        "id": 504865372,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741704873
    },
    {
        "content": "<p>Is there anything that needs to be altered when building the lean library? A flag or something?</p>",
        "id": 504865597,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741704922
    },
    {
        "content": "<p>Have you seen <a href=\"#narrow/channel/270676-lean4/topic/.E2.9C.94.20Reverse.20FFI.20undefined.20reference.20for.20mathlib\">this topic</a>? <code>SG_READ_ONLY</code> is mentioned here in a similar context.</p>",
        "id": 504874234,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1741706725
    },
    {
        "content": "<p>Nice! Thank you, this looks really relevant. No luck quite yet (after updating <code>llvm</code> to v19) but this gives me some more clues to work with</p>",
        "id": 504884972,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741708672
    },
    {
        "content": "<p>Did you update your system's llvm? Given there is an issue on lean repo, I guess you need to update the one bundled with lean (there is one?). There is a pr with a fix which is not merged but I think you might be able to try it if you set <code>lean-toolchain</code> to <code>leanprover/lean4-pr-releases:pr-release-6063</code>.</p>",
        "id": 504902405,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1741712385
    },
    {
        "content": "<p>I did update my system's LLVM, and linked it to <code>clang</code> (as far as I know, at least). You might be right now, though I'm getting an error now: <code>error: could not download nonexistent lean version </code>leanprover/lean4-pr-releases:pr-release-6063`. Is there different syntax I should use for this?</p>",
        "id": 504921393,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741717605
    },
    {
        "content": "<p>It seems that this PR doesn't have an associated release. I don't know what PRs get releases, maybe the problem is that it didn't pass all ci checks.</p>\n<p>The checks on macos did pass, perhaps you could try building lean locally.</p>\n<p>(And maybe it is possible to use some tool to modify the generated library to add the required flag? I couldn't find anything about that)</p>\n<p>Also try setting <code>LEAN_CC</code> environment variable to your system's clang before building the library. It will use it for linking, maybe it will generate the correct library. (NOTE: using it like <code>LEAN_CC=clang lake build</code> may be wrong and an absolute path might be required, I had a problem where passing <code>clang</code> during some build (maybe ffi target, maybe lean target) defaulted to the lean's clang).</p>",
        "id": 504933085,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1741720886
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"587706\">@Daniil Kisel</span> for all your help on this. I've put this down for now (out of exhaustion) and am just using a Linux VM to hack at the FFI for now. I'll pick this up again and come back when I have a working solution!</p>",
        "id": 504976027,
        "sender_full_name": "Derek Sorensen",
        "timestamp": 1741733615
    }
]