[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">[{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">squares</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">}]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pos'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Succeeds on nightly-2024-05-10 and earlier.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- On newer Lean versions, fails with the following message:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- tactic 'decide' failed for proposition</span>\n<span class=\"w\">  </span><span class=\"c1\">-- pos' ∈ valid_moves pos</span>\n<span class=\"w\">  </span><span class=\"c1\">-- since its 'Decidable' instance reduced to</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Decidable.rec (fun h ↦ (fun hp ↦ isFalse ⋯) h) (fun h ↦ (fun hp ↦ isTrue ⋯) h)</span>\n<span class=\"w\">  </span><span class=\"c1\">--  (instDecidableEqBool (List.elem pos' (valid_moves pos)) true)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- rather than to the 'isTrue' constructor.</span>\n</code></pre></div>",
        "id": 449757859,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720407555
    },
    {
        "content": "<p>I'm guessing that this ^ has to do with <a href=\"https://github.com/leanprover/lean4/pull/4061\">lean4#4061</a> (making well-founded definitions irreducible).</p>",
        "id": 449757993,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720407622
    },
    {
        "content": "<p>But I don't understand what's going on. I don't see any well-founded recursive functions here.</p>",
        "id": 449758068,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720407657
    },
    {
        "content": "<p>And I'm puzzled about how I should proceed with the proof now.</p>",
        "id": 449758266,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720407768
    },
    {
        "content": "<p>Here's the error messages with the experimental <a href=\"https://github.com/leanprover/lean4/pull/4674\">lean4#4674</a>, in case it's helpful:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>tactic 'decide' failed for proposition\n  pos' ∈ valid_moves pos\nsince its 'Decidable' instance\n  List.instDecidableMemOfLawfulBEq pos' (valid_moves pos)\ndid not reduce to 'isTrue' or 'isFalse'.\n\nAfter unfolding the instances decEqPosition✝, decidable_of_decidable_of_iff,\ninstDecidableEqBool, instDecidableEqNat, instDecidableEqPosition,\nArray.instDecidableEq, Bool.decEq, List.instDecidableMemOfLawfulBEq, Nat.decEq,\nNat.decLe and Nat.decLt, reduction got stuck at the 'Decidable' instance\n  match List.elem pos' (valid_moves pos), true with\n  | false, false =&gt; isTrue ⋯\n  | false, true =&gt; isFalse ⋯\n  | true, false =&gt; isFalse ⋯\n  | true, true =&gt; isTrue ⋯\n</code></pre></div>",
        "id": 449779515,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720417636
    },
    {
        "content": "<p>That first discriminant is neither true nor false, as far as <code>rfl</code> is concerned:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 449779698,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720417734
    },
    {
        "content": "<p>But according to the <code>rfl</code> tactic, the first is true:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- succeeds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 449779854,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720417815
    },
    {
        "content": "<p>This is using the <code>eq_refl</code> tactic, which has a feature where if there are no free variables or metavariables, it just checks that the kernel would accept <code>rfl</code>, without any restriction on reducibility (as the kernel doesn't have the notion of reducibility).</p>",
        "id": 449779970,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720417889
    },
    {
        "content": "<p>The definition <code>List.elem</code> isn't using well-founded recursion, so that's not to blame, but instead it seems to be that the derived DecidableEq instance isn't reducible:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 449780308,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720418106
    },
    {
        "content": "<p>In fact, it appears that this is an <code>Array</code> problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>A purely <code>List</code>-based version of your code works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">[{</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">squares</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">}]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">squares</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 449780561,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720418226
    },
    {
        "content": "<p>Sure enough, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Array.isEqvAux#doc\">docs#Array.isEqvAux</a> is defined using well-founded recursion.</p>",
        "id": 449780640,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720418275
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> Maybe you'd be interested in this example of a well-founded recursion not reducing? Should we change the definition of <code>Array.isEqvAux</code>? Or could perhaps the termination checker automatically synthesize a structural recursion here? Or would that be too brittle to depend on?)</p>",
        "id": 449782148,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720418938
    },
    {
        "content": "<p>There is a <code>TODO: Cleanup</code> comment there :-)</p>\n<p>My sense is that <em>all</em> array functions should be implemented via list functions on <code>.data</code>, for good DefEqs, and the the efficient implementation should be a <code>csimp</code> (or <code>implemented_by</code>). This would have avoided the present problem. I did not run this proposed guideline/goal past Kim yet, though, but if they agree then a PR fixing this would certainly be welcome.</p>",
        "id": 449803110,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1720426094
    },
    {
        "content": "<p>I was able to work around my problem with an <code>unseal</code>: <a href=\"https://github.com/dwrensha/animate-lean-proofs/commit/8b8f5c49c2f6560f2328cf2aeb11329a13c160f4\">https://github.com/dwrensha/animate-lean-proofs/commit/8b8f5c49c2f6560f2328cf2aeb11329a13c160f4</a></p>",
        "id": 449860910,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720443180
    },
    {
        "content": "<p>Then I switched from <code>Array</code> to <code>List</code>, which removed the need for the <code>unseal</code>, and made things much faster: <a href=\"https://github.com/dwrensha/animate-lean-proofs/commit/93875ead00083b2ae65b8a192d9c599d8f725f2f\">https://github.com/dwrensha/animate-lean-proofs/commit/93875ead00083b2ae65b8a192d9c599d8f725f2f</a></p>",
        "id": 449861196,
        "sender_full_name": "David Renshaw",
        "timestamp": 1720443231
    },
    {
        "content": "<p>It might also be worth trying out the <code>ground</code> option for <code>simp</code>. It's for reducing ground terms using simplification, and it works for your original code block:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pos'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">valid_moves</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ground</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">})</span>\n</code></pre></div>",
        "id": 449871478,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720445743
    }
]