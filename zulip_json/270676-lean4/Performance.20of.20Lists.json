[
    {
        "content": "<p>Hey!<br>\nIn get a stack overflow for ( including on the web editor).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">9000000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">175561</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I'm new to programming in general.<br>\nIs this because the code generated for lists is inefficient ? (though Array yields the same problem).<br>\nIs there a general way I allow lean to handle large computations without changing the implementation ?<br>\nIs my laptop just bad ?</p>",
        "id": 451509641,
        "sender_full_name": "Yves Jäckle",
        "timestamp": 1721052753
    },
    {
        "content": "<p>I'm not fully sure but it certainly seems like part of the answer is you're asking to <em>print</em> that giant thing. Are you really trying to do that, or just do some continued computation?</p>",
        "id": 451512810,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721053448
    },
    {
        "content": "<p>E.g., with Array, this is fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">175561</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">g</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">[</span><span class=\"mi\">37</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n</code></pre></div>",
        "id": 451512854,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721053460
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/270676-lean4/topic/Performance.20of.20Lists/near/451512810\">said</a>:</p>\n<blockquote>\n<p>I'm not fully sure but it certainly seems like part of the answer is you're asking to <em>print</em> that giant thing.</p>\n</blockquote>\n<p>Worse, pretty-print as  a <code>Format</code> object</p>",
        "id": 451513829,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721053704
    },
    {
        "content": "<p>This works fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">9000000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">175561</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 451514046,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721053775
    },
    {
        "content": "<p>And even in this case you are benchmarking <code>toString</code> presumably! Throw in a <code>Nat.sum</code> before worrying about long lists.</p>",
        "id": 451514593,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721053910
    },
    {
        "content": "<p>Unrelated but because I noticed it, does <code>set_option maxRecDepth 0</code> PANIC for either/any of you?</p>",
        "id": 451514748,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721053954
    },
    {
        "content": "<p>It does here (in nvim and VSCode, on 4.10.0-rc2) but seems not to in the web editor.</p>",
        "id": 451514805,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721053973
    },
    {
        "content": "<p>0 means \"no stack!! only execute\", as opposed to \"as much stack as you like\"</p>",
        "id": 451514885,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721053997
    },
    {
        "content": "<p>Right I understand it's not what I wanted anyhow, but the PANIC was presumably unexpected</p>",
        "id": 451514966,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721054018
    },
    {
        "content": "<p>Amazing, thanks <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 451517443,
        "sender_full_name": "Yves Jäckle",
        "timestamp": 1721054600
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"665760\">Yves Jäckle</span> has marked this topic as resolved.</p>",
        "id": 451517492,
        "sender_full_name": "Notification Bot",
        "timestamp": 1721054615
    },
    {
        "content": "<p>Hi, this topic is quite interesting and I want to learn more about it. I looked at the implementation of <code>Repr</code> which I assume is where the Format comes from. Here are the relevant parts:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Format.joinSep</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToFormat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Format</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">nil</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">],</span><span class=\"w\">   </span><span class=\"n\">_</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">::</span><span class=\"n\">as</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sep</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">as.foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">sep</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">List.repr</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToFormat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">repr</span><span class=\"o\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"[]\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Format.bracket</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Format.joinSep</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">Format.line</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n</code></pre></div>\n<p>From what I can tell, <code>List.repr</code> is <em>not</em> recursive (as in recurse to itself) and just calls <code>Format.joinSep</code>, and neither is <code>Format.joinSep</code> which calls <code>List.foldl</code>. So the stack overflow occurs at <code>List.foldl</code>. But... <code>List.sum</code> also calls <code>List.foldl</code>??</p>",
        "id": 452023065,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1721212045
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"579936\">Gareth Ma</span> has marked this topic as unresolved.</p>",
        "id": 452023101,
        "sender_full_name": "Notification Bot",
        "timestamp": 1721212059
    },
    {
        "content": "<p>And this doesn't stack overflow</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Tactic</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"w\"> </span><span class=\"n\">Format</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">add_up</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">::</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">as.foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">add_up_list</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"[]\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Format.bracket</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">add_up</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter.setOption</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace.profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">add_up_list</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List.range</span><span class=\"w\"> </span><span class=\"mi\">50000</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>So does this mean <code>String</code> is the place overflowing? Or am I missing something stupid</p>",
        "id": 452023374,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1721212141
    },
    {
        "content": "<p>you are secretly calling <code>Format.pretty</code> there because you are passing a <code>Format</code> to <code>#eval</code> to show it. <code>Format.pretty</code> is bad at deep recursion if you hand it a deeply nested Format object</p>",
        "id": 452039694,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721216080
    },
    {
        "content": "<p>Ohh I see now, thanks! I think I also mixed up <code>Format</code> with <code>String</code> (due to the <code>++</code>), so I didn't realise it's a nested tree instead of a string</p>",
        "id": 452061909,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1721220983
    }
]