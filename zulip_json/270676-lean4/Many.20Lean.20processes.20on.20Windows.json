[
    {
        "content": "<p>Can someone on Windows test the following:</p>\n<ol>\n<li>Open Task Manager</li>\n<li>Create a new file in Mathlib with the following contents and wait for Lean to finish compiling the file</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Ring</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Field</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Finite</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">IsArtinian</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>I now have 2 visible processes <code>lean.exe</code> in the task manager</li>\n<li>Jump to the definition of <code>Ring</code>, which opens in a new file, and wait for that file to finish compiling</li>\n<li>Close the new tab</li>\n<li>Repeat steps 4-5 for all other definitions.</li>\n<li>Check how many processes <code>lean.exe</code> are running in the task manager</li>\n</ol>\n<p>After each iteration of steps 4-5, I get one additional Lean executable running in the task manager, so at the end, <code>lean.exe</code> is running ~7 times. I am on Lean <code>v4.22.0-rc3</code>.</p>",
        "id": 530592824,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753371744
    },
    {
        "content": "<p>After multiple such tasks, Lean can slow down significantly (probably because they are competing for CPU/Memory).</p>",
        "id": 530593439,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753371937
    },
    {
        "content": "<p>Something that I couldn't quite make reproducible, but also had happen to me a few times: the task in my main editor stopped responding at all (the \"yellow bar\" wouldn't move past simple commands like a <code>variable</code> or <code>attribute</code> or <code>set_option</code> command, even after giving it 10+ seconds).<br>\nThis happened when I was browsing the output of trace/profiler commands, sometimes jumping to definitions, sometimes editing the file a bit. (EDIT: posted this here <a href=\"#narrow/channel/270676-lean4/topic/Lean.20freezes.20with.20.60.23count_heartbeats.60\">#lean4 &gt; Lean freezes with &#96;#count_heartbeats&#96;</a> )</p>",
        "id": 530593565,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753371972
    },
    {
        "content": "<p>I tried this on a Windows machine but can't seem to reproduce that the processes linger around after closing the tab.</p>",
        "id": 530596312,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753372828
    },
    {
        "content": "<p>Hmm... Do you have any ideas how I could help diagnose this further (post logs, ways to try to minimize this behavior, or maybe I should try it on a fresh copy of Mathlib or something)?</p>",
        "id": 530597813,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753373287
    },
    {
        "content": "<p>FWIW, I can still reproduce it without importing any Mathlib files (this is still a file in the Mathlib directory of my local copy of Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetaM</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">adaptCacheableContext</span>\n</code></pre></div>",
        "id": 530601643,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753374408
    },
    {
        "content": "<p>(FWIW, I checked with a recent Mathlib on v4.22.0-rc4, probably good to double-check on that one first)</p>\n<p>I think the first thing to check would be whether the language server gets the correct messages from VS Code. Set 'Lean 4 &gt; Trace: Server' to 'compact', restart VS Code without any open tabs, open the Lean output window (command: 'Show Troubleshooting Output') and repeat your reproduction up to the step where you've closed the file for <code>Ring</code> and a process that shouldn't be there anymore is still sticking around. There should be a bunch of output in the 'Lean: Editor' panel that would be helpful to know about.</p>\n<p>You could also try whether using <code>gdb</code> works on Windows (I think it's shipped with e.g. mingw) and then we can try looking at the backtraces.</p>\n<ol>\n<li>Get your reproduction into the state where you have three processes, one of which shouldn't be there (for the closed tab).</li>\n<li>Figure out the process ID (pid) of all of your <code>lean</code> processes (e.g. using the \"Resource Monitor\" on Windows)</li>\n<li>One after another, run <code>gdb -p &lt;pid&gt;</code> for each of these process ID, and then <code>thread apply all bt</code> in <code>gdb</code> to get the backtraces. Copy each set of backtraces and then use <code>quit</code> to leave each <code>gdb</code> session.</li>\n</ol>",
        "id": 530602655,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753374725
    },
    {
        "content": "<p>Ok, going through the steps: <br>\nI can still reproduce this on Lean v4.22-rc4.</p>",
        "id": 530604682,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753375456
    },
    {
        "content": "<p>Here is the server trace file: <a href=\"https://gist.github.com/fpvandoorn/7e26b87fadde89db2e5432b6be99ae1a\">https://gist.github.com/fpvandoorn/7e26b87fadde89db2e5432b6be99ae1a</a><br>\nI believe I closed the secondary file (<code>Lean.Parser.Attr</code>) at 6:53:44, and afterwards, I still see <code>keepAlive</code> notifications.</p>",
        "id": 530606777,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753376240
    },
    {
        "content": "<p>Here is the output of gdb, of what I think is the process that shouldn't be there:<br>\n<a href=\"https://gist.github.com/fpvandoorn/8a4fa6c179053d5a0b7123e0fae6318f\">https://gist.github.com/fpvandoorn/8a4fa6c179053d5a0b7123e0fae6318f</a><br>\nHere is the output of gdb of another run with all three processes: (I think the second one, starting at line 273, is the one that shouldn't be there)<br>\n<a href=\"https://gist.github.com/fpvandoorn/e743b5e952345bf5f0928499876dd89d\">https://gist.github.com/fpvandoorn/e743b5e952345bf5f0928499876dd89d</a></p>",
        "id": 530609062,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753376951
    },
    {
        "content": "<p>I hope this helps!</p>",
        "id": 530609072,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753376956
    },
    {
        "content": "<p>Oh, interesting. I'm glad I asked for the LSP log - the client never emits a <code>didClose</code> notification for the document for some reason, so the server doesn't know to terminate the process.</p>\n<p>It probably isn't the cause of the issue, but could you also ensure that both VS Code and the extension are up-to-date? The most recent VS Code version is 1.102.2 and the most recent extension version is 0.0.209.</p>",
        "id": 530734729,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753436462
    },
    {
        "content": "<p>(I'd also be curious if anyone else with a Windows system can reproduce this / not reproduce it)</p>",
        "id": 530735222,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753436614
    },
    {
        "content": "<p>Another shot in the dark: Are you running any other VS Code extensions? Does disabling them make a difference?</p>",
        "id": 530735585,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753436727
    },
    {
        "content": "<p>I just tried it on my windows system (windows 11, mathlib and vscode up to date), and I can't reproduce: when I close a tab, a Lean process disappears.</p>",
        "id": 530737881,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1753437453
    },
    {
        "content": "<p>I did update VSCode this morning. I now have the versions you mentioned for VSCode and the extension, and the issue still persists.<br>\nThe issue also persists after disabling all extensions except the <code>Lean 4</code> extension. (EDIT: this was false)</p>",
        "id": 530776931,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753450730
    },
    {
        "content": "<p>Argh. I assume your <code>settings.json</code> doesn't contain any non-standard settings, either? (Settings &gt; \"Open Settings (JSON)\" in the top right)</p>",
        "id": 530777150,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753450792
    },
    {
        "content": "<p>(If that's not it either, I'll see if I can build you a custom version of the extension that produces more debug output)</p>",
        "id": 530777603,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753450939
    },
    {
        "content": "<p>When debugging further, we found out that this problem is caused by the fairly common \"GitHub Pull Requests\" extension. If you have it installed, I'd recommend disabling it and restarting VS Code afterwards. <br>\nThis issue is also independent of Windows, and running it myself while working on a TypeScript project caused some other strange bugs (e.g. issues in the \"Problems\" view for TypeScript wouldn't clear when closing the file, as it usually does).</p>\n<p>I'm 90% sure that this issue is independent of Lean; VS Code will simply not emit any more <code>didClose</code> events for certain files when using this extension.</p>",
        "id": 530792453,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753455171
    },
    {
        "content": "<p>Would it make sense to open an issue in <a href=\"https://github.com/Microsoft/vscode-pull-request-github/issues\">their repo</a>?</p>",
        "id": 530816017,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753463457
    },
    {
        "content": "<p>I've created <a href=\"https://github.com/microsoft/vscode-pull-request-github/issues/7403\">https://github.com/microsoft/vscode-pull-request-github/issues/7403</a></p>",
        "id": 530833943,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1753470818
    }
]