[
    {
        "content": "<p>I cannot reproduce this on my own laptop, but there was some weird behavior <span class=\"user-mention\" data-user-id=\"754741\">@Melanie Matchett Wood</span> experienced.<br>\nShe worked on a project downsteam from Mathlib, and had a <code>lean-toolchain</code> that specified <code>v4.20.0</code> and a <code>lakefile.toml</code> that pinned Mathlib to <code>v4.20.0</code> (this last part was not intentional). Then, running <code>lake update</code> from the command line cause the <code>lean-toolchain</code> file to somehow get updated to <code>4.24.0-rc1</code>, which then broke <code>Cache</code>. <br>\nAny ideas what could have gone wrong here?</p>",
        "id": 541502143,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1758818127
    },
    {
        "content": "<p>I just realized another very important extra piece of information: <code>lakefile.toml</code> <em>also</em> specified a <code>doc-gen</code> dependency with revision <code>main</code> hardcoded. Whose responsibility is it to raise an error that there is a Lean version mismatch in the dependencies? I expect it is the responsibility of <code>lake update</code>, right? I don't think such an error was raised.</p>",
        "id": 541502822,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1758818349
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/lake.20update.20breaks.20lean-toolchain\">#mathlib4 &gt; lake update breaks lean-toolchain</a> by <span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span>.</p>",
        "id": 541522540,
        "sender_full_name": "Notification Bot",
        "timestamp": 1758825372
    },
    {
        "content": "<p>I'm pretty sure there is no such check (that the <code>lean-toolchain</code>s of all dependencies agree), let alone a check that different paths through the dependency graph reach the same revision.</p>",
        "id": 541568997,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758850743
    },
    {
        "content": "<p>Note that it's pretty common to run on different toolchains: e.g. in testing Mathlib against nightly releases (or PR toolchain releases), it is essential to be able to use upstream libraries at older releases, rather than also bumping them.</p>",
        "id": 541569059,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758850801
    },
    {
        "content": "<p>It's the users responsibility to raise that error ;)</p>\n<p><del>I thought only the mathlib post-update hook used to update the lean_toolchain by copying it from somewhere, not aware of any other mechanism.</del> no, that's deprecated information</p>",
        "id": 541592196,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758868095
    },
    {
        "content": "<p>Apparently, the relevant function to look at is <code>Lake.Workspace.updateToolchain</code>. There the algorithm iterates over all toolchains of the (direct?) dependencies with the following test:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">depTc</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tcs</span><span class=\"o\">)</span>\n<span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">depTc</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dep</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">depTc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tcs</span><span class=\"o\">)</span>\n<span class=\"k\">else</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tcs</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dep</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">depTc</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>so concretely, it tries to find the newest toolchain to update to. Which would probably be the toolchain of <code>doc-gen@main</code> in your example.</p>\n<p>I'm a bit surprised that this is the chosen behaviour, especially since in the next line of code it looks like there is already the setup to warn users when they have (direct?) dependencies with mismatching toolchains:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">tcs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"toolchain not updated; multiple toolchain candidates:\"</span>\n</code></pre></div>\n<p>I think you can avoid the automatic toolchain bump with <code>lake --keep-toolchain update</code>.</p>",
        "id": 541600418,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758871540
    },
    {
        "content": "<p>(I guess there is a slight conflict of interest, from lake's perspective it makes sense to update to the newest version if possible and not prioritise any dependencies. It's unfortunate that in praxis a lot of users would want to follow mathlib's version no matter what because mathlib is their largest dependency and most likely to break with the wrong toolchain)</p>",
        "id": 541602141,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758872127
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20update.20breaks.20lean-toolchain/near/541592196\">said</a>:</p>\n<blockquote>\n<p>It's the users responsibility to raise that error ;)</p>\n</blockquote>\n<p>I think it would be good if <code>lake update</code> raises a warning when it finds that different dependencies have a hard-coded a version that uses a different Lean version. <br>\nIn this case, we had a Lean beginner that used someone else's setup which was workable 4 months ago, but now the meaning of \"stable\" has changed. Nothing pointed the beginner to the fact that there might be something wrong in <code>lakefile.toml</code> (and even as the expert it took a few tries before considering a problem in <code>lakefile.toml</code>).</p>",
        "id": 541603535,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1758872607
    },
    {
        "content": "<p>I completely agree<span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>\n<p>(If that didn't come across, with this comment I meant to hint at my impression that <code>lake</code> is quite fiddly to get set up correctly, and I would love to have better warnings and less possibilities to end up in a bad state by running the wrong commands in the wrong order. But I do apprechiate that package managing a complex task with many possibilities and quite hard to get completely right)</p>",
        "id": 541738987,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1758917620
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20update.20breaks.20lean-toolchain/near/541603535\">said</a>:</p>\n<blockquote>\n<p>I think it would be good if <code>lake update</code> raises a warning when it finds that different dependencies have a hard-coded a version that uses a different Lean version. </p>\n</blockquote>\n<p>It is not quite clear to me what you are suggesting Lake should do here. Lake currently does log the fact that it updates the toolchain. Are you suggesting that Lake should promote this to a warning whenever there are dependencies with different Lean toolchains? As Kim noted, it is very common for a package to have dependencies at different toolchains (as many packages bump toolchains infrequnetly as they may not break every release), and the goal is usually to build them all on the most up-to-date toolchain. Making this a warning seems quite odd when that is the usually desired behavior.</p>\n<p>I am also not sure what you mean by \"hard-coded a version\". All dependencies are pinned to some version. I presume you don't mean a specific commit hash / tag, as your example was using \"stable\" and \"main\". Even when pinned to a specific hash / tag, it is not clear that indicates incompatibilty across toolcahins. The tag can represent a specific package version, not a toolchain version, after all.</p>",
        "id": 541740758,
        "sender_full_name": "Mac Malone",
        "timestamp": 1758918366
    },
    {
        "content": "<p>On the flip side, one way to improve the UX here could be to add a configuration optiona that allows Mathlib to specify it only works on a specific toolchain. That way Lake could know that it should produce an error if it wants to move to newer toolchain for another dependency.</p>",
        "id": 541742447,
        "sender_full_name": "Mac Malone",
        "timestamp": 1758919134
    },
    {
        "content": "<p>Isn't the new intended way to use doc-gen <em>not</em> to put it in the main lakefile?</p>",
        "id": 541792484,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758966887
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20update.20breaks.20lean-toolchain/near/541740758\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.20update.20breaks.20lean-toolchain/near/541603535\">said</a>:</p>\n<blockquote>\n<p>I think it would be good if <code>lake update</code> raises a warning when it finds that different dependencies have a hard-coded a version that uses a different Lean version. </p>\n</blockquote>\n<p>It is not quite clear to me what you are suggesting Lake should do here. Lake currently does log the fact that it updates the toolchain. Are you suggesting that Lake should promote this to a warning whenever there are dependencies with different Lean toolchains? As Kim noted, it is very common for a package to have dependencies at different toolchains (as many packages bump toolchains infrequnetly as they may not break every release), and the goal is usually to build them all on the most up-to-date toolchain. Making this a warning seems quite odd when that is the usually desired behavior.</p>\n<p>I am also not sure what you mean by \"hard-coded a version\". All dependencies are pinned to some version. I presume you don't mean a specific commit hash / tag, as your example was using \"stable\" and \"main\". Even when pinned to a specific hash / tag, it is not clear that indicates incompatibilty across toolcahins. The tag can represent a specific package version, not a toolchain version, after all.</p>\n</blockquote>\n<p>With \"hardcoded a version\" I mean something like <code>rev = v4.20.0</code> in the <code>lakefile.toml</code>.<br>\nI can assure you that if the Lean version of your project is any different than the Lean version of your Mathlib dependency, then that is almost never the desired behavior, will almost always lead to errors, and these errors will confuse both beginners and experts. <br>\nI respect that in other cases this is desirable, and I don't know the best solution. Maybe lake can hardcode a check like this for Mathlib (and anything that depends on Mathlib)?</p>",
        "id": 542003309,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1759143095
    },
    {
        "content": "<p>Maybe you can try specify the lean version in the \"lakefile.toml\" and \"lean-toolchain\", like this</p>\n<ol>\n<li>lakefile.toml</li>\n</ol>\n<p>[[require]]<br>\nname = \"mathlib\"<br>\ngit = \"<a href=\"https://github.com/leanprover-community/mathlib4.git\">https://github.com/leanprover-community/mathlib4.git</a>\"<br>\n<strong>rev = \"v4.23.0\"</strong></p>\n<ol start=\"2\">\n<li>lean-toolchain</li>\n</ol>\n<p><strong>leanprover/lean4:v4.23.0</strong></p>",
        "id": 544678177,
        "sender_full_name": "TyDHC",
        "timestamp": 1760427249
    }
]