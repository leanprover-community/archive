[
    {
        "content": "<p>I see there has been a lot of work refactoring the definition of <code>Vector</code> in recent months. This has totally broken some code I had but it is a major improvement, so that's exciting. Is there a plan to do more work here, e.g. add more API to Vector?</p>",
        "id": 486071585,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733312141
    },
    {
        "content": "<p>Yes, <code>Vector</code> will be moving to Lean 4 core soon.</p>",
        "id": 486089753,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1733318023
    },
    {
        "content": "<p>Thanks :)</p>",
        "id": 486089801,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733318037
    },
    {
        "content": "<p>If it is of interest, I have a fairly complete treatment of the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">A `VectorPerm n` is a permutation on `n` elements represented by two vectors, which we can</span>\n<span class=\"sd\">think of as an array of values and a corresponding array of indexes which are inverse to</span>\n<span class=\"sd\">one another. (One can flip the interpretation of indexes and values, and this is essentially</span>\n<span class=\"sd\">the inversion operation.)</span>\n<span class=\"sd\">It is designed to be a more performant version of `Equiv.Perm`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Gives the `VectorPerm` as an vector of size `n`.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">fwdVector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Gives the inverse of the `VectorPerm` as a vector of size `n`.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bwdVector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">getElem_fwdVector_lt'</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">fwdVector</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">getElem_bwdVector_lt'</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">bwdVector</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">left_inv'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"n\">bwdVector</span><span class=\"o\">[</span><span class=\"n\">fwdVector</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"n\">getElem_fwdVector_lt'</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 486106637,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733322884
    },
    {
        "content": "<p>Strictly speaking this is just the efficient subset of equiv.perm, right?</p>",
        "id": 486150136,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733335246
    },
    {
        "content": "<p>I suppose you could put it like that, yes - certainly the idea was that it is to <code>Equiv.Perm (Fin n)</code> as <code>Fin n -&gt; ℕ</code> is to <code>Vector ℕ n</code>.</p>",
        "id": 486292347,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733401292
    },
    {
        "content": "<p>I have a constructor which just takes in a single vector along with a proof of its members being bounded by <code>n</code> and have no duplicates (both of which are decidable): obviously that means it has to construct the inverse but it is convenient for testing.</p>",
        "id": 486292581,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733401371
    },
    {
        "content": "<p>Notably because of the finiteness you only have to show it's the inverse one way.</p>",
        "id": 486292939,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733401473
    },
    {
        "content": "<p>Actually <code>getElem_bwdVector_lt'</code> might also be unncessary.</p>",
        "id": 486293309,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733401597
    },
    {
        "content": "<p>(Yes, it is.)</p>",
        "id": 486354428,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418392
    },
    {
        "content": "<p>I guess I'd be tempted to define the fields above as <code>Vector (Fin n) n</code> so as to drop the need for two of the fields</p>",
        "id": 486355398,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733418690
    },
    {
        "content": "<p>That is true - there was a good reason why I didn't do that to start with but I can't remember it now.</p>",
        "id": 486355549,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418725
    },
    {
        "content": "<p>Oh yes - it just makes it a LOT more annoying to manipulate stuff because you get caught in casting hell.</p>",
        "id": 486355639,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418753
    },
    {
        "content": "<p>Also as I say this is sufficient:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Gives the `VectorPerm` as an vector of size `n`.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">fwdVector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Gives the inverse of the `VectorPerm` as a vector of size `n`.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bwdVector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_fwdVector_lt</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">fwdVector</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_bwdVector_getElem_fwdVector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"n\">bwdVector</span><span class=\"o\">[</span><span class=\"n\">fwdVector</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"n\">getElem_fwdVector_lt</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 486355675,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418771
    },
    {
        "content": "<p>i.e. you don't need to bound <code>bwdVector</code>, that is a theorem.</p>",
        "id": 486355710,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418784
    },
    {
        "content": "<p>But for example, suppose you want to cast using <code>n = m</code> to <code>VectorPerm m</code>. You can just use the same fwdArray and bwdArray - you don't have to worry about casting the fin values inside them.</p>",
        "id": 486356284,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733418955
    },
    {
        "content": "<p>I appreciate I am just saying \"trust me\" - but some experience with this has convinced me that this is the right way.</p>",
        "id": 486356458,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419004
    },
    {
        "content": "<p>At least for defining the basic API it doesn't seem too bad:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"w\">  </span><span class=\"n\">rev_getElem_fwd_getElem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"o\">[</span><span class=\"n\">fwd</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps!</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"bp\">.</span><span class=\"n\">toPerm</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">ofLeftInverseOfCardLE</span>\n<span class=\"w\">    </span><span class=\"n\">le_rfl</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">fwd</span><span class=\"o\">[</span><span class=\"bp\">·</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">rev</span><span class=\"o\">[</span><span class=\"bp\">·</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">rev_getElem_fwd_getElem</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"bp\">.</span><span class=\"n\">fwd_getElem_rev_getElem</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">fwd</span><span class=\"o\">[</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">rev</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">toPerm</span><span class=\"bp\">.</span><span class=\"n\">right_inv</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">fwd</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">rev</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">rev_getElem_fwd_getElem</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">erw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">rev_getElem_fwd_getElem</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- oops, this isn't simp-normal!</span>\n</code></pre></div>",
        "id": 486357323,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733419265
    },
    {
        "content": "<p><em>shrug</em></p>",
        "id": 486357382,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419286
    },
    {
        "content": "<p>I spent a couple months working on this back in the summer - I tried it a bunch of different ways.</p>",
        "id": 486357433,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419303
    },
    {
        "content": "<p>I guess my hesitancy is whether the casting hell is the fault of the design, or is the fault of something in Lean/mathlib that we should be fixing instead of working around</p>",
        "id": 486357585,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733419350
    },
    {
        "content": "<p>As I say, there's no problem in the basics, it's later you have issues.</p>",
        "id": 486357604,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419360
    },
    {
        "content": "<p>Essentially what I found is that faiiirly often I wanted to re-interpret nats without keeping track of the bounds I had on them.</p>",
        "id": 486357703,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419397
    },
    {
        "content": "<p><em>however</em> this was all before Vector.</p>",
        "id": 486357719,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419404
    },
    {
        "content": "<p>Also, as I say your definition is stronger than the second one I give there - because you don't need to specify that both are bounded.</p>",
        "id": 486357875,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419448
    },
    {
        "content": "<p>Oh, a good example of the more complicated stuff I mean is when I was working with permutations on Fin (2^n). You really want to avoid doing too much casting with this - in particular because Fin (2^(n + 1)) isn't def eq to everything you might wish it was, casting comes up quite a lot.</p>",
        "id": 486358108,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419529
    },
    {
        "content": "<p>As an aside - man I wish there was a typeclass for \"SMul on the right\" that wasn't just fiddling around with MulOpposite</p>",
        "id": 486358271,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419566
    },
    {
        "content": "<p>Edited above with <code>cast</code>. Note that if you wrap <code>a.rev.cast h).map &lt;| Fin.cast h</code> with a custom definition, you can <code>csimp</code> into a call to (another wrapper around) <code>_root_.cast</code> which is free at runtime, unlike <code>map</code> which is <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span></span></span></span></p>",
        "id": 486359306,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733419919
    },
    {
        "content": "<p>Yeah. I mean I do just feel this is nice:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">fwdVector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">bwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">bwdVector</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_fwdVector_lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_cast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_fwdVector</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_lt</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_bwdVector_getElem_fwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getElem_inv_getElem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"bp\">.</span><span class=\"n\">trans_eq</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 486359482,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419961
    },
    {
        "content": "<p>But I haven't got time to hash it out now. At some point I am going to make a big PR and I can have the discussion there.</p>",
        "id": 486359570,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733419987
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486357585\">said</a>:</p>\n<blockquote>\n<p>or is the fault of something in Lean/mathlib that we should be fixing instead of working around</p>\n</blockquote>\n<p>Indeed, we are missing basic things like <code>Vector.cast rfl x = x</code> and <code>Vector.map id x = x</code></p>",
        "id": 486359624,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420008
    },
    {
        "content": "<p>Oh I mean <code>Vector</code> is missing a LOT.</p>",
        "id": 486359675,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420024
    },
    {
        "content": "<p>We don't even have this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">getElem_map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 486359735,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420043
    },
    {
        "content": "<p>My suggestion would be to contribute things like this to Batteries, and let core upstream them when ready</p>",
        "id": 486359865,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420078
    },
    {
        "content": "<p>That way you also don't need to wait for a lean release to use them in your project</p>",
        "id": 486359910,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420092
    },
    {
        "content": "<p>Oh I wouldn't dream of contributing this to Core, yeah.</p>",
        "id": 486359927,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420097
    },
    {
        "content": "<p>Batteries for most of it, some of it is more Mathlib-y I think.</p>",
        "id": 486359975,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420109
    },
    {
        "content": "<p>But you get some nice stuff - i.e. <code>VectorPerm n</code> has a natural (right) action on <code>Vector \\alpha n</code>.</p>",
        "id": 486360036,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420130
    },
    {
        "content": "<p>(And of course it ALSO has a nice left action on Vector Nat n).</p>",
        "id": 486360257,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420189
    },
    {
        "content": "<p>In the same way that <code>Equiv.perm α</code> and <code>DomMulAct (Equiv.perm ι)</code> already have natural actions on <code>ι → α</code></p>",
        "id": 486360344,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420215
    },
    {
        "content": "<p>Right, and presumably you could write down some theorem that links that action to the one you would define here.</p>",
        "id": 486360433,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420245
    },
    {
        "content": "<p>Or you could just work in the abstract setting once you want to start talking about actions, rather than working with vector</p>",
        "id": 486360506,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420269
    },
    {
        "content": "<p>But the motivation for all this was some absolutely terrible performance on some code that used Equivs, when I realised - aha.</p>",
        "id": 486360533,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420279
    },
    {
        "content": "<p>No, no, I needed this stuff in the concrete setting :)</p>",
        "id": 486360600,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420290
    },
    {
        "content": "<p>Right, but you can convert it to the abstract setting mid-proof</p>",
        "id": 486360628,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420304
    },
    {
        "content": "<p>I guess if your definitions want to use the actions then you're right</p>",
        "id": 486360667,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420318
    },
    {
        "content": "<p>Yes, but what I needed was to <em>define</em> something that used the abstraction - yes.</p>",
        "id": 486360678,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420323
    },
    {
        "content": "<p>Specifically there's a key algorithm that only gets decent speed by the fact that, well, essentially for a given permutation ir sort of performs the calculations on all values at once and thus ammortizes the cost.</p>",
        "id": 486360771,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420366
    },
    {
        "content": "<p>If you do it in the naive abstracted way, <em>every</em> time you make a call you re-calculate the whole thing, catastrophic.</p>",
        "id": 486360840,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420387
    },
    {
        "content": "<p>You can avoid that with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">finCacheImpl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">invFun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">left_inv</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">right_inv</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"sd\">/-- Cache a fin permutation for runtime efficiency. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">finCache</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"c1\">-- csimp is undocumented, maybe this is backwards</span>\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">finCache_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">finCache</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">finCacheImpl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">finCacheImpl</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 486361560,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420626
    },
    {
        "content": "<p>That's quite nice, yes.</p>",
        "id": 486361727,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420668
    },
    {
        "content": "<p>What is <code>csimp</code>?</p>",
        "id": 486361748,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733420676
    },
    {
        "content": "<p><code>@[csimp] theorem foo : A = B</code> means \"use <code>A</code>/<code>B</code> when compiling <code>B</code>/<code>A</code>\", though I forget which way around it is</p>",
        "id": 486361891,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733420718
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486360344\">said</a>:</p>\n<blockquote>\n<p>In the same way that <code>Equiv.perm α</code> and <code>DomMulAct (Equiv.perm ι)</code> already have natural actions on <code>ι → α</code></p>\n</blockquote>\n<p>Though this isn't quite the same (or rather, it naturally acts on Vector Nat n rather than just on Vector (Fin n) n)!</p>",
        "id": 486364033,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421414
    },
    {
        "content": "<p>That's the <code>DomMulAct</code> example as <code>ι := Fin n</code> and <code>α := Nat</code></p>",
        "id": 486364577,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733421594
    },
    {
        "content": "<p>Right, but I'm talking about the action on values not indices (I guess that might be the first one?)</p>",
        "id": 486364889,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421673
    },
    {
        "content": "<p>I would argue that the action on <code>Vector Nat n</code> that acts on the values less than <code>n</code> and ignores the rest is not natural</p>",
        "id": 486364973,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733421705
    },
    {
        "content": "<p>If you have a vector of Nats, you can either shuffle the indices, or map on the values.</p>",
        "id": 486364987,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421708
    },
    {
        "content": "<p>Hmm, I'm not so sure - I think a lot of people would say that, say, \"the permutation that switches 0 and 1\" is something that can be applied to all the naturals, not just <code>Fin 2</code></p>",
        "id": 486365199,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421758
    },
    {
        "content": "<p>Now I mean you could argue that there's what, n + 1 different ways of embedding the symmetry group of <code>Fin n</code> into <code>Fin (n + 1)</code>, and this makes one of them \"special\". I would agree with that. On the other hand, the one it makes special <em>is</em> special.</p>",
        "id": 486365397,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421821
    },
    {
        "content": "<p>But I think it's ultimately a philosophical point. Regardless, in my context I do often need to, say, reinterpret a permutation on 2^n elements as a permutation on 2^(n + 1) elements - so it worked for me.</p>",
        "id": 486365569,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421872
    },
    {
        "content": "<p>I think that reinterpretation would probably best be spelt explicitly</p>",
        "id": 486365627,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733421895
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">natPerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">extendDomainHom</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">equivSubtype</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span>\n<span class=\"bp\">```</span>\n</code></pre></div>",
        "id": 486365677,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421912
    },
    {
        "content": "<p>You can do something like this.</p>",
        "id": 486365700,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421920
    },
    {
        "content": "<p>Where <code>finPerm</code>, to be clear, is the actual isomorphism.</p>",
        "id": 486365820,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733421963
    },
    {
        "content": "<p>Here is an example of something which I think might be something more of a headache to do if you do use <code>Fin n</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">castIfgetElemLtOfLt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">VectorPerm</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">?.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⁻¹</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">?.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_fwdVector_lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_range</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem?_def</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">him</span>\n<span class=\"w\">    </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">lt_or_le</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">hin</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hin</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hin</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dite_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getD_some</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"n\">him</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hin</span><span class=\"bp\">.</span><span class=\"n\">not_lt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dite_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getD_none</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">him</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">getElem_bwdVector_getElem_fwdVector</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_range</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem?_def</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">    </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">lt_or_le</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">hin</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hin</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hin</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dite_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getD_some</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_lt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_inv_getElem</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hin</span><span class=\"bp\">.</span><span class=\"n\">not_lt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dite_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getD_none</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 486369912,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733423468
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486359735\">said</a>:</p>\n<blockquote>\n<p>We don't even have this:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">getElem_map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Apologies about the state of <code>Vector</code>, I am trying to fill it in asap. This lemma (all the <code>getElem_X</code> lemmas for basic operations) is in <a href=\"https://github.com/leanprover/lean4/pull/6324\">https://github.com/leanprover/lean4/pull/6324</a>.</p>",
        "id": 486422701,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733448288
    },
    {
        "content": "<p>As illustrated by <a href=\"https://github.com/leanprover/lean4/pull/6234\">lean4#6234</a>, the <code>by cases &lt;that_vector&gt;; simp</code> strategy should work in most cases to prove missing lemmas. Of course, please PR such missing lemmas to Batteries (they may then be moved to core, as needed).</p>",
        "id": 486428801,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1733452334
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Vector.20refactor/near/486422701\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486359735\">said</a>:</p>\n<blockquote>\n<p>We don't even have this:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">getElem_map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Apologies about the state of <code>Vector</code>, I am trying to fill it in asap. This lemma (all the <code>getElem_X</code> lemmas for basic operations) is in <a href=\"https://github.com/leanprover/lean4/pull/6324\">https://github.com/leanprover/lean4/pull/6324</a>.</p>\n</blockquote>\n<p>It's no trouble - I figured it was being worked on!</p>",
        "id": 486450818,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733467686
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> Is there a specification somewhere for what fits in Batteries, what fits in Mathlib, and what is (aimed to) fit into core?</p>",
        "id": 486475294,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733478175
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486422701\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486359735\">said</a>:</p>\n<blockquote>\n<p>We don't even have this:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">getElem_map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getElem_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">getElem_map</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Apologies about the state of <code>Vector</code>, I am trying to fill it in asap. This lemma (all the <code>getElem_X</code> lemmas for basic operations) is in <a href=\"https://github.com/leanprover/lean4/pull/6324\">https://github.com/leanprover/lean4/pull/6324</a>.</p>\n</blockquote>\n<p>I've added a single comment to this based on a thing I just noticed - in my experience it seems to be essential that the bounds in getElem lemmas match defeq to what is needed, otherwise you can have issues in automation. I just had <code>simp</code> choke on your <code>getElem_take</code> lemma for this reason.</p>",
        "id": 486477902,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1733479080
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/270676-lean4/topic/Vector.20refactor/near/486475294\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> Is there a specification somewhere for what fits in Batteries, what fits in Mathlib, and what is (aimed to) fit into core?</p>\n</blockquote>\n<p>It's not that well delineated. The advantage of submitting to Batteries is that it will be available right after merge whereas with Lean core you need to wait for the appropriate release (usually a month right now but possibly longer in the future).</p>\n<p>Much like Lean core, Batteries has stricter standards than Mathlib. Code in Batteries (and Lean core) should be efficient and suitable for \"industrial use\". That said, don't be shy and submit a PR to Batteries if you think it's suitable. Maintainers will work with you to get it up to par before merging, or they will explain why it is not actually suitable for Batteries and recommend a suitable place for your code.</p>",
        "id": 486618973,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1733534519
    },
    {
        "content": "<p>I think there is a typo in a lemma from <a href=\"https://github.com/leanprover/lean4/pull/6324\">lean4#6324</a> , specifically <a href=\"https://github.com/opencompl/lean4/blame/f50b863868a3625dfbca4fd2ad777d187632b1d4/src/Init/Data/Vector/Lemmas.lean#L2398\"><code>Vector.getElem_take</code></a>. The type of <code>hi : i &lt; min n m</code> when it should be <code>hi : i &lt; min m n</code>. In the lemma definition, <code>get_elem_tactic</code> fearlessly fills in a nontrivial proof, which means <code>hi</code> is not resolved by unification! Annoyingly, this only becomes noticeable when the goal is hard enough for <code>get_elem_tactic</code> to fail.</p>\n<p>Not-very-minimized example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k₁</span><span class=\"w\"> </span><span class=\"n\">k₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">j₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">j₁</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">k₁</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))[</span><span class=\"n\">j₁</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k₂</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))[</span><span class=\"n\">j₁</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">getElem_take</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- no progress</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">getElem_take'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k₁</span><span class=\"w\"> </span><span class=\"n\">k₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">j₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">j₁</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">k₁</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))[</span><span class=\"n\">j₁</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k₂</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))[</span><span class=\"n\">j₁</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">getElem_take'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- progress</span>\n</code></pre></div>\n<p>Maybe we should stylistically prefer <code>getElem</code> simp lemmas to always use the <code>[...]'...</code> notation, to avoid this kind of bug? It seems lint-able, which could be worthwhile given the huge number of getElem simp lemmas.</p>",
        "id": 500330457,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1739862078
    },
    {
        "content": "<p>reported at <a href=\"https://github.com/leanprover/lean4/pull/7212\">lean4#7212</a> so it doesn't get lost</p>",
        "id": 501633529,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1740426250
    },
    {
        "content": "<p>Fixed (at least the surface symptom) at <a href=\"https://github.com/leanprover/lean4/pull/7449\">lean#7449</a>.</p>",
        "id": 505021332,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741751585
    }
]