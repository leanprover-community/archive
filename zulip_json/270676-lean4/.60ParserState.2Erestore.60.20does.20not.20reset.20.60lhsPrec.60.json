[
    {
        "content": "<p>Interestingly, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.ParserState.restore#doc\">docs#Lean.Parser.ParserState.restore</a> does not reset <code>lhsPrec</code>.</p>\n<p>This causes the follow repeated usage of <code>lookahead</code> to fail:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test2Parser</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"o\">:</span><span class=\"mi\">101</span><span class=\"w\"> </span><span class=\"s2\">\"test2\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">lookahead</span><span class=\"o\">(</span><span class=\"n\">test2Parser</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">lookahead</span><span class=\"o\">(</span><span class=\"n\">test2Parser</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">test2</span>\n</code></pre></div>\n<p>The first call to <code>lookahead</code> succeeds and sets <code>lhsPrec</code> to 100. Since the <code>lhsPrec</code> is not reset, the second call to <code>lookahead</code> fails.</p>\n<p>I had initially thought there would be many such examples, but <code>restore</code> is usually called after a parsing error which means the <code>lhsPrec</code> was not changed.</p>\n<p>Is there a reason to not also reset <code>lhsPrec</code> inside of <code>restore</code>?</p>",
        "id": 565635841,
        "sender_full_name": "Eric Paul",
        "timestamp": 1766999129
    },
    {
        "content": "<p>It also appears that the <code>firstTokens</code> of a couple parsers could be made more useful.<br>\nFor example, <code>checkColGe</code> and <code>checkLinebreakBefore</code> both set their <code>firstTokens</code> to be <code>epsilon</code>, which makes sense.</p>\n<p>But <code>checkColGt</code>, <code>checkLineEq</code>, and <code>notFollowedBy</code> all set their <code>firstTokens</code> to be <code>unknown</code> when <code>epsilon</code> would be better.<br>\n<code>many</code> and <code>sepBy</code> use <code>unknown</code> when <code>toOptional</code> would be better.</p>\n<p>Here are examples of what the switch looks like and does.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>switching checkGolGt to epsilon</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n<span class=\"c1\">-- Updated version of `checkColGt`</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">checkColGt'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">errorMsg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"checkColGt\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">checkColGtFn</span><span class=\"w\"> </span><span class=\"n\">errorMsg</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">firstTokens</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">epsilon</span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">checkColGt</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">checkColGt'</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: unknown</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">firstTokens</span>\n\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [hi]</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">firstTokens</span>\n</code></pre></div>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>switching many to toOptional</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">manyNoAntiquot'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">firstTokens</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">firstTokens</span><span class=\"bp\">.</span><span class=\"n\">toOptional</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">manyFn</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">fn</span>\n<span class=\"o\">}</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">many'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">manyNoAntiquot'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">withAntiquotSpliceAndSuffix</span><span class=\"w\"> </span><span class=\"ss\">`many</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">many</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"bye\"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">many'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"s2\">\"bye\"</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: unknown</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">firstTokens</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [$, hi, bye]</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"bp\">.</span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">firstTokens</span>\n</code></pre></div>\n</div></div>\n<p>Is making issues or PRs for these something that would be appreciated?</p>",
        "id": 566244119,
        "sender_full_name": "Eric Paul",
        "timestamp": 1767554413
    }
]