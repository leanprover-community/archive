[
    {
        "content": "<p>I'm trying to produce a proof term, where there's a certain amount of shared subexpressions in the final proof. So, I'd like to use <code>let_fun</code> (or similar) to produce <code>let_fun x := long_proof; h x x</code> instead of <code>h long_proof long_proof</code>. I found <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkLetFun#doc\">docs#Lean.Meta.mkLetFun</a>, which seems like exactly what I want, but I don't understand how to manage the fvars to make this happen. As an example, I'm first trying to make a tactic which produces <code>let_fun x := sorry; x</code>, but I get panic because of unknown free variables. What am I doing wrong?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftMetaFinishingTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FVarId</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"ss\">`h1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLetFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkSorry</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">test</span>\n</code></pre></div>",
        "id": 515312249,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746021475
    },
    {
        "content": "<p>For concreteness, here's the proof term I want the <code>test</code> tactic to create here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n</code></pre></div>",
        "id": 515312595,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746021558
    },
    {
        "content": "<p>This is what I would do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftMetaFinishingTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLetFun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkSorry</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>",
        "id": 515313310,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746021717
    },
    {
        "content": "<p>Oh, with a new mvar instead of a new fvar, interesting</p>",
        "id": 515313634,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746021789
    },
    {
        "content": "<p>If you want an fvar:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftMetaFinishingTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkSorry</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withLocalDecl</span><span class=\"w\"> </span><span class=\"ss\">`h1</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fvar</span>\n<span class=\"w\">    </span><span class=\"n\">mkLetFun</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">  </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>You can't just use <code>FVarId.mk</code> to make a new fvar because then it won't be in the local context. Instead, use something like <code>withLocalDecl</code></p>",
        "id": 515314079,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746021895
    },
    {
        "content": "<p>I couldn't find the function <code>withLocalDecl</code>, which is why I used an mvar</p>",
        "id": 515314399,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746021964
    },
    {
        "content": "<p>I don't particularly mind whether it's an mvar or an fvar; I just presumed fvar was the thing to use here! Does it make a difference which one I use?</p>\n<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Produce.20proof.20expression.20containing.20let_fun/near/515314079\">said</a>:</p>\n<blockquote>\n<p>it won't be in the local context</p>\n</blockquote>\n<p>Interesting: since this is meant to be a finishing tactic I imagined that it doesn't matter whether it's in the local context, since the new binding wouldn't be user-facing... Thanks for the fix!</p>",
        "id": 515314523,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746021994
    },
    {
        "content": "<p>Well it uses it in particular for the type so it does need to exist in the local context</p>",
        "id": 515314738,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746022052
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/270676-lean4/topic/Produce.20proof.20expression.20containing.20let_fun/near/515314523\">said</a>:</p>\n<blockquote>\n<p>Interesting: since this is meant to be a finishing tactic I imagined that it doesn't matter whether it's in the local context, since the new binding wouldn't be user-facing... Thanks for the fix!</p>\n</blockquote>\n<p><code>mkLetFun</code> needs it to be in the local context to work, that's where the error was coming from.</p>",
        "id": 515314991,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746022117
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/Produce.20proof.20expression.20containing.20let_fun/near/515314991\">said</a>:</p>\n<blockquote>\n<p><code>mkLetFun</code> needs it to be in the local context to work, that's where the error was coming from.</p>\n</blockquote>\n<p>Makes sense, but does that mean <code>mkLetFun</code> was the wrong thing to use?</p>",
        "id": 515315159,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746022159
    },
    {
        "content": "<p>You can also use Qq to construct the expression without any MetaM</p>",
        "id": 515315254,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746022186
    },
    {
        "content": "<p>I ended up using the mvar solution and it works nicely, thanks!</p>",
        "id": 515324003,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746024300
    }
]