[
    {
        "content": "<p>I was testing <a href=\"https://github.com/leanprover-community/mathlib4/pull/30266\">#30266</a>, which delaborates an algebra equivalence into Galois notation if a <code>Field</code> instance can be synthesized for some of its arguments, when I noticed that the local instances are not populated in <code>DelabM</code>. This leads to <code>synthInstance?</code> for <code>Field A</code> failing despite there being a <code>variable [Field A]</code> present (and present in the local context during delaboration).</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>MWE</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"sd\">/-- Dummy declaration to attach our `app_delab` to, to mimic circumstances in #30266 -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n\n<span class=\"sd\">/-- Syntax to embed our debugging logs in. -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"⟪\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span>\n<span class=\"c1\">-- Whether `Bar Foo` is synthesized</span>\n<span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"s2\">\"synthBar\"</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span>\n<span class=\"w\"> </span><span class=\"c1\">-- Types of terms in the local context</span>\n<span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"s2\">\"lctx\"</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span>\n<span class=\"w\"> </span><span class=\"c1\">-- List of local instance names</span>\n<span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"s2\">\"localInstanceNames\"</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span>\n<span class=\"w\"> </span><span class=\"s2\">\"⟫\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"kd\">]</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabBaz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">synthBar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance?</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSepArray</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLocalHyps</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"bp\">.</span><span class=\"n\">setBool</span><span class=\"w\"> </span><span class=\"ss\">`Lean.pp.notation</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"bp\">&lt;|←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localInstanceNames</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSepArray</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLocalInstances</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">className</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">⟪</span><span class=\"w\"> </span><span class=\"n\">synthBar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">synthBar</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">lctx</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">localInstanceNames</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">localInstanceNames</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"bp\">⟫</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- the `[Bar Foo]` instance is present in the local context, but not in the local instances</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: ⟪</span>\n<span class=\"sd\">  synthBar := Bool.false✝,</span>\n<span class=\"sd\">  lctx := [Bar Foo],</span>\n<span class=\"sd\">  localInstanceNames := []</span>\n<span class=\"sd\">  ⟫ : True</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"c1\">-- local instances are, as expected, correctly populated during elaboration</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test_elab%\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"local instance names: {(← getLocalInstances).map (·.className)}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: local instance names: [Bar]</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: true : Bool</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test_elab</span><span class=\"bp\">%</span>\n</code></pre></div>\n</div></div>\n<p>Is this a bug, or is this deliberate to avoid overhead during delaboration? (Should <a href=\"https://github.com/leanprover-community/mathlib4/pull/30266\">#30266</a> crawl the local context/populate the local instances manually?)</p>",
        "id": 544850819,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760483555
    },
    {
        "content": "<p>Here's some thing related:<br>\nThe infoview seems to have different behaviour when pretty printing <code>Tactic state</code> and <code>Expected type</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">NoBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"YesBar\"</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">NoBar</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- Delaborates `NoBar` to `YesBar` if `Bar` instance is present. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">NoBar</span><span class=\"kd\">]</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabNoBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">YesBar</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NoBar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  Infoview when you place your cursor here:</span>\n<span class=\"cm\">  ▼ Tactic state</span>\n<span class=\"cm\">  1 goal</span>\n<span class=\"cm\">    inst✝ : Bar</span>\n<span class=\"cm\">    ⊢ YesBar</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  Infoview when you place your cursor on the end of the previous line:</span>\n<span class=\"cm\">  ▼ Tactic state</span>\n<span class=\"cm\">    No goals</span>\n<span class=\"cm\">  ▼ Expected type</span>\n<span class=\"cm\">    inst✝ : Bar</span>\n<span class=\"cm\">    ⊢ NoBar</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>",
        "id": 545146542,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1760573937
    },
    {
        "content": "<p>we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.delabInf#doc\">docs#Mathlib.Meta.delabInf</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.delabSup#doc\">docs#Mathlib.Meta.delabSup</a> what do they do</p>",
        "id": 545146646,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760574035
    },
    {
        "content": "<p>They add the local instances back manually (i.e. <code>withLocalInstances (← getLCtx).decls.toList.reduceOption do</code>)</p>",
        "id": 545146790,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1760574154
    },
    {
        "content": "<p>Nice find! :) For visibility, <a href=\"https://github.com/leanprover-community/mathlib4/pull/23558\">#23558</a> is the PR in which that approach was introduced, and on which this issue was encountered was discussed.</p>\n<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/23558#pullrequestreview-2780008449\">mentioned</a> on that PR that this was a 4.19 limitation; Kyle, do you happen to know if there's an issue associated with it and/or still plans to address it?</p>",
        "id": 545153194,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760579137
    },
    {
        "content": "<p>Yes, I made a PR to Lean that tried to fix this issue (and this is the fix that <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> was referring to), but it turns out that the PR didn't fix it (or at least not in all situations)</p>",
        "id": 545292126,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760616298
    },
    {
        "content": "<p>Ah, okay! Did that end up with a planned fix, a wontfix, or just a general postponement? I'm trying to figure out if this should be filed as an issue.</p>",
        "id": 545419837,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760638625
    },
    {
        "content": "<p>I think nobody else cared about it at that time, and I didn't make an issue, so feel free to make an issue about it now.</p>",
        "id": 545422658,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760639639
    },
    {
        "content": "<p>(My attempted fix was in <a href=\"https://github.com/leanprover/lean4/pull/8022\">lean#8022</a>)</p>",
        "id": 545423427,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760639918
    },
    {
        "content": "<p>I see, thanks! :) Issue: <a href=\"https://github.com/leanprover/lean4/pull/10830\">lean4#10830</a></p>",
        "id": 545711885,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760742598
    },
    {
        "content": "<p>Aha, I <em>think</em> I've gotten to the bottom of this.</p>\n<p>Pretty-printing works by starting with a <code>PPContext</code>, which looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">env</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span>\n<span class=\"w\">  </span><span class=\"n\">mctx</span><span class=\"w\">          </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetavarContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">lctx</span><span class=\"w\">          </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">opts</span><span class=\"w\">          </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span>\n<span class=\"w\">  </span><span class=\"n\">openDecls</span><span class=\"w\">     </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">OpenDecl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n</code></pre></div>\n<p>(Note the lack of <code>localInstances</code>....)</p>\n<p>To pretty-print via<code>Lean.ppExprWithInfos (ctx : PPContext) (e : Expr) : BaseIO FormatWithInfos</code> using some such <code>ctx</code>, we look in the <code>ppExt</code> extension's state in <code>ctx.env</code>, which in turn is set by looking in the pretty-printing ref <code>ppFnsRef</code>. In there, you find an instance of a structure <code>PPFns</code>, which looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PPFns</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ppExprWithInfos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">FormatWithInfos</span>\n<span class=\"w\">  </span><span class=\"n\">ppConstNameWithInfos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">FormatWithInfos</span>\n<span class=\"w\">  </span><span class=\"n\">ppTerm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Format</span>\n<span class=\"w\">  </span><span class=\"n\">ppLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Format</span>\n<span class=\"w\">  </span><span class=\"n\">ppGoal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Format</span>\n</code></pre></div>\n<p>What do we set this field <code>ppExprWithInfos</code> to?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">builtin_initialize</span>\n<span class=\"w\">  </span><span class=\"n\">ppFnsRef</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">ppExprWithInfos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withoutContext</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">ppExprWithInfos</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">ppConstNameWithInfos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withoutContext</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">ppConstNameWithInfos</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">ppTerm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withoutContext</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">ppTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">    </span><span class=\"n\">ppLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getPPMVarsLevels</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">opts</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">ppGoal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withoutContext</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">ppGoal</span><span class=\"w\"> </span><span class=\"n\">mvarId</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Note: that's <code>Lean.Meta.ppExprWithInfos</code> in the body, not to be confused with <code>Lean.ppExprWithInfos</code> above or the name of the field itself!</p>\n<p>That <code>ctx</code> is a <code>PPContext</code>, and <code>PPContext.runMetaM</code> (Lean.Meta.Basic) looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppCtx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ppCtx</span><span class=\"bp\">.</span><span class=\"n\">runCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ppCtx</span><span class=\"bp\">.</span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ppCtx</span><span class=\"bp\">.</span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>It's there that <code>localInstances</code> acquires the value <code>#[]</code> by a default field value, I believe.</p>",
        "id": 545721805,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760753902
    },
    {
        "content": "<p>So, we can either</p>\n<ol>\n<li>give <code>PPContext</code> a field <code>localInstances</code>--this would mean constructing those at the different points we construct a <code>PPContext</code></li>\n<li>add the local instances to the context in <code>PPContext.runMetaM</code></li>\n<li>provide better documentation around <code>DelabM</code> if both of these are too burdensome performance-wise</li>\n</ol>",
        "id": 545722086,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760754369
    },
    {
        "content": "<p>I'm experimenting with option 2 in <a href=\"https://github.com/leanprover/lean4/pull/10832\">lean4#10832</a>. If it's not too bad when benched (fingers crossed! But my hopes aren't too high...), I'll clean it up and propose it... :)</p>",
        "id": 545728462,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760762985
    },
    {
        "content": "<p><a href=\"https://speed.lean-lang.org/mathlib4/compare/e7b27246-a3e6-496a-b552-ff4b45c7236e/to/5c915ea7-46c1-48bc-a7dc-8b3615b7e900?hash1=c84ee75fe89338a5ca15ea04ad57789461a5cc7a\">Here</a> are the bench results (comparing the commit incorporating <a href=\"https://github.com/leanprover/lean4/pull/10832\">lean4#10832</a> to the one just before it, via benching PRs <a href=\"https://github.com/leanprover-community/mathlib4/pull/30642\">#30642</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/30643\">#30643</a>), though I'm not 100% sure how they should be interpreted. There's a good bit of orange, but not much shows up in the stddev column...</p>\n<p>I'm also not sure if benching like this actually stress-tests pretty printing sufficiently well, especially if it's focused on building. If it doesn't, how would we tell if this change was making things more sluggish in the infoview?</p>",
        "id": 545735508,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760771720
    },
    {
        "content": "<p>I would think that</p>\n<ul>\n<li>this change doesn't affect performance much</li>\n<li>if it did affect performance, it would not be visible in the benchmarking since very little of the benchmarking time is spent on pretty printing.</li>\n</ul>",
        "id": 545766705,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760804679
    }
]