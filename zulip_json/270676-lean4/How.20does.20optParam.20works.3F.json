[
    {
        "content": "<p>Hi everyone.</p>\n<p>I thought that if I define something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>\n<p>Then, when I eval  <code>sum 3</code> I would get <code>4</code>, but that's not what happens. I'm doing something wrong?</p>\n<p>Is there a way to really have an optional parameter such that when not introduced it is automatically replaced by its default value?</p>\n<p>Thanks in advance.</p>",
        "id": 474328227,
        "sender_full_name": "Esteban Martínez Vañó",
        "timestamp": 1727882626
    },
    {
        "content": "<p>Optional parameters are mostly useful if they're the last parameter. But you can also use them together with named arguments. These both work as you want them to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- 4</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">sum'</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"c1\">-- 4</span>\n</code></pre></div>",
        "id": 474329911,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727882894
    },
    {
        "content": "<p>I see. Thanks!</p>",
        "id": 474330174,
        "sender_full_name": "Esteban Martínez Vañó",
        "timestamp": 1727882971
    },
    {
        "content": "<p>I wouldn't mind seeing an RFC for \"implicit optional parameters\", like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum''</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>\n<p>There are some details to nail down, like for example what if <code>x</code> appears in the type of another argument. Would it try to be inferred by unification before the optional parameter is tried? Or would it simply mean \"use this value unless it's given as a named argument\"? I think the latter is easiest to implement and to reason about, but the former might be what some users would expect.</p>\n<p>Similarly, there could be \"implicit autoparameters\" like <code>{h : x = y := by rfl}</code>. The same questions apply: should it immediately use <code>by rfl</code> for the value of <code>h</code>, or should it wait to see if <code>h</code> was solved for by unification?</p>",
        "id": 474333366,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727883936
    },
    {
        "content": "<p>I already ran into cases where that would be useful.  Also - and perhaps this is not he same as saying <code>by rfl</code> in your example - it seems that you can't use function calls in the definitions of defaults, which would be useful, too.</p>",
        "id": 474337233,
        "sender_full_name": "Tom",
        "timestamp": 1727884868
    },
    {
        "content": "<p>I'm not sure what you mean about not being able to use functions in defaults, do you have an example?</p>",
        "id": 474338472,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727885127
    },
    {
        "content": "<p>It seems that the following does not apply for structure <code>.mk</code>?</p>\n<p>For instance, following from this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">sum'</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"c1\">-- 4</span>\n</code></pre></div>\n<p>I would expect the following to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"aDefault\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>Due to that fact that <a href=\"http://A.mk\">A.mk</a> is elaborated ignoring the defaults:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>On the other hand, it does work when using <code>{ b := 1 }</code>, but not <code>⟨ 1 ⟩</code>.</p>",
        "id": 474349905,
        "sender_full_name": "Yuri",
        "timestamp": 1727888033
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"463095\">@Yuri de Wit</span> That's a known issue, but surprisingly fixing it depends on fixing a kernel bug. Fixing it is in progress.</p>",
        "id": 474352056,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727888762
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> What kernel bug?</p>",
        "id": 474375493,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727895880
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <a href=\"https://github.com/leanprover/lean4/pull/4824\">lean4#4824</a></p>",
        "id": 474376964,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727896213
    },
    {
        "content": "<p>that's not a kernel bug</p>",
        "id": 474377131,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896271
    },
    {
        "content": "<p>the error message is correct, but confusing</p>",
        "id": 474377181,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896285
    },
    {
        "content": "<p>You can't make a nested inductive like that</p>",
        "id": 474377240,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896305
    },
    {
        "content": "<p>to fix it you would have to hide the <code>optParam</code> wrapper from the kernel</p>",
        "id": 474377430,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896368
    },
    {
        "content": "<p>The bug is that the nested inductive processor isn't erasing the optParam, but the issue is that this erases them on the elaborator side too.</p>\n<p>Is it not possible to translate the optParam?</p>",
        "id": 474378242,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727896616
    },
    {
        "content": "<p>Could you explain what's wrong with the inductive?</p>",
        "id": 474378417,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727896678
    },
    {
        "content": "<p>no, part of nested inductive validation involves replacing all types involved in the cycle with type variables, and <code>none</code> will not have this type</p>",
        "id": 474378473,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896684
    },
    {
        "content": "<p>in general you can't use functions defined on <code>Option</code> at all</p>",
        "id": 474378514,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896699
    },
    {
        "content": "<p>this amounts to a kind of induction-recursion if you did allow it</p>",
        "id": 474378574,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896728
    },
    {
        "content": "<p>the only reason it's okay here is because you can defeq replace the types of the constructors with ones that pass the check</p>",
        "id": 474378646,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896758
    },
    {
        "content": "<p>but the kernel doesn't know how to find such a type</p>",
        "id": 474378676,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896769
    },
    {
        "content": "<p>in particular, the kernel takes care not to reduce the types of constructors at all, even though it does reduce the type of the inductive</p>",
        "id": 474378856,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896822
    },
    {
        "content": "<p>i.e. if you introduce an abbreviation for <code>A -&gt; B</code>, it will work if you use it in the type of the inductive but not in the constructor</p>",
        "id": 474378956,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727896857
    },
    {
        "content": "<p>Ok, thanks, this is in line with my understanding. It's just not clear to me that it's not possible to fix this in some way so that the elaborator still sees an optparam. (So far it's seemed likely we'll sacrifice that though.)</p>",
        "id": 474380118,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727897213
    },
    {
        "content": "<p>we can probably fix it with a kernel patch, but I'm not a big fan of those for obvious reasons</p>",
        "id": 474380242,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727897258
    },
    {
        "content": "<p>The most sensible general technique I see here is the ability to post-facto change the type of a constant to something defeq</p>",
        "id": 474380376,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727897289
    },
    {
        "content": "<p>but maybe only very special cases of that (like removing optParams) are surfaced in practice</p>",
        "id": 474380624,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727897377
    }
]