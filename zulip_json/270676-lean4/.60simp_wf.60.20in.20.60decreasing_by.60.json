[
    {
        "content": "<p>Is there a scenario where one doesn't want to immediately call <code>simp_wf</code> when starting a <code>decreasing_by</code> proof?</p>",
        "id": 456195017,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1722706549
    },
    {
        "content": "<p>I am asking because I wonder why calling <code>simp_wf</code> isn't automatically done when a <code>decreasing_by</code> is declared.</p>",
        "id": 456195484,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1722706727
    },
    {
        "content": "<p><code>simp_wf</code> runs the simplifier, so may do things to your goal that you don't want, depending on the default simp set.  I think it's desirable to be able to do your termination proofs differently.</p>\n<p>One could argue for a design where <code>simp_wf</code> runs by default and there is a way to turn off when you need to. Not sure if it's worth the complexity.</p>\n<p>Or alternatively a <code>simp_wf</code> that is very careful to only clean up technicalities from the wf construction, but not arbitrary simplification.</p>",
        "id": 456219185,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1722716841
    },
    {
        "content": "<p>The raw proof goals produced in the decreasing_by proof are really messy, in particular because they have tons of very large autogenerated variables in the context. I am not sure about <code>simp_wf</code> specifically, but the goals as presented to the user should be cleaned up to reflect the actual goal that sensibly corresponds to the <code>termination_by</code>. On top of being a mess, we already know that showing raw goals is brittle because the internal logic producing the goals can change and this could result in breaking any decreasing_by proof that takes the low-level route.</p>",
        "id": 456219769,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722717141
    },
    {
        "content": "<p>Right. It ought to undo the argument packing and maybe resolve the wf relation to the concrete relation for that type.</p>",
        "id": 456222160,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1722719137
    },
    {
        "content": "<p>Using <code>simp_wf</code> is a bit overkill for this, because it uses the global simp set and therefore is something users may wish to turn off. I think the initial simplification should be using a closed simp set (or other bespoke automation) tailored to the current implementation of the termination_by infrastructure, and it should be fast and not optional</p>",
        "id": 456223624,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722720353
    },
    {
        "content": "<p>another way to frame this is that the initial goal provided to a <code>decreasing_by</code> proof is something that should in principle (and one day maybe in practice) be specified in complete detail in the lean manual, and so you don't want anything implementation detail leaking into it</p>",
        "id": 456223745,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722720474
    },
    {
        "content": "<p>I will add the perspective that for newer Lean users that the first time you use <code>decreasing_by</code> is pretty confusing if you don't immediately know to try <code>simp_wf</code>. I think there's definitely value in making that learning curve smoother if it doesn't cause more problems, is maintainable, etc.</p>",
        "id": 456238860,
        "sender_full_name": "Chris Henson",
        "timestamp": 1722728220
    },
    {
        "content": "<p>I was actually surprised when I found out that <code>simp_wf</code> is not already doing that. It seems we are in agreement here about how  things should be :-)</p>",
        "id": 456246316,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1722732267
    },
    {
        "content": "<p>Tracking this at <a href=\"https://github.com/leanprover/lean4/issues/4928\">https://github.com/leanprover/lean4/issues/4928</a> now.</p>",
        "id": 456864819,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1722953085
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"512030\">Eric Paul</span> has marked this topic as resolved.</p>",
        "id": 457420159,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723135971
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"512030\">@Eric Paul</span> : please don't mark topics as resolved.</p>",
        "id": 457421523,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723136465
    },
    {
        "content": "<p>Terribly sorry that was an accident</p>",
        "id": 457421628,
        "sender_full_name": "Eric Paul",
        "timestamp": 1723136493
    },
    {
        "content": "<p>It's okay. I blame the lack of fine grained permissions in zulip. Ideally we should have the means to disable this feature without stopping members from editing topic titles.</p>",
        "id": 457421793,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723136523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> has marked this topic as unresolved.</p>",
        "id": 457431968,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723139245
    },
    {
        "content": "<p>PR for this at <a href=\"https://github.com/leanprover/lean4/pull/5016\">https://github.com/leanprover/lean4/pull/5016</a>, mathlib adoption was simple.<br>\n<span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> , do you want to have a look?</p>",
        "id": 462139788,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723561715
    },
    {
        "content": "<p>Nice. I do wonder if it offers the kind of guarantee that Mario is looking for: namely being guaranteed that the goal corresponds to the parameters supplied to <code>termination_by</code>. I imagined what would work is to the construct a goal for  based on the <code>termination_by</code> clause and then do something like <code>suffices &lt;new_goal&gt; from {tactic_chain_using_simp_wf only [...]}</code></p>",
        "id": 462141982,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723562167
    },
    {
        "content": "<p>Then if <code>suffices</code> throws extra goals, we know that the termination goal that was presented to the user was not sufficient and some implementation detail has leaked through.</p>",
        "id": 462142149,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723562214
    },
    {
        "content": "<p>That would require calculating <code>&lt;new_goal&gt;</code>, right? I guess <code>GuessLex</code> does that to some extent, although the actual <code>WF.Fix</code> code doesn’t. Maybe worth revisiting if the current <code>simp_wf</code> tactic proofs (heh) to be insufficient.</p>",
        "id": 462161735,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723567289
    },
    {
        "content": "<p>Sure. I mean in practice I completely expect simp_wf to do just fine. I just don't know how we can deduce the goal to document how it will be produced, so that end users can predict the goal they will get and choose the termination parameter accordingly</p>",
        "id": 462164105,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723568168
    },
    {
        "content": "<p>I think it would be better not to touch <code>simp_wf</code> itself (for backcompat reasons) and instead use some custom code (not a tactic-with-syntax) in the preprocessing stage, before calling the <code>decreasing_by</code> tactic.</p>\n<p>One thing which I think is not being done by <a href=\"https://github.com/leanprover/lean4/pull/5016\">lean4#5016</a> (if I understand the implementation correctly) is the clearing of all the weird inaccessible hypotheses</p>",
        "id": 462164140,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723568183
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 462164196,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1723568211
    },
    {
        "content": "<p>Thanks for having a look.</p>\n<p>True, I can leave simp_wf in as it is (maybe deprecated) and use some other name for the internally used tactic. </p>\n<p>I don't see the benefit of not using tactic syntax to set up the call to <code>simp</code> here, though, and doing the same in <code>MetaM</code> seems fairly tediou. Is there one?</p>\n<p>And can you give an example of  those  weird inaccessible hypotheses?</p>",
        "id": 462206534,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723580491
    },
    {
        "content": "<p>Here's a MWEified example of <code>decreasing_by</code> in lean4lean (which incidentally is working around a separate bug)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">rank_lt</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lt_rankMax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">root_parent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">root_eq_self</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">root_root</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">find_parent_or</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∨</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">find_root_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">root_eq_self</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">find_parent_or</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">root_eq_self</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sub_lt_sub_left</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">lt_rankMax</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">rank_lt</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">root_parent</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">find_root_1</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)]</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">find_parent_or</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">root_root</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">root_parent</span><span class=\"o\">]</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"n\">decreasing_by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"c1\">-- why is this needed? It is way slower without it</span>\n</code></pre></div>\n<p>Here's the goal at the <code>decreasing_by</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UnionFind</span>\n<span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">a</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">invImage</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">instWellFoundedRelationOfSizeOf</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"n\">this</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">invImage</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rankMax</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">instWellFoundedRelationOfSizeOf</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>",
        "id": 462208515,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723581184
    },
    {
        "content": "<p>I actually use <code>decreasing_by</code> very rarely, because the goals are such a mess that it's easier to just work in situ using <code>have :=</code></p>",
        "id": 462208661,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723581260
    },
    {
        "content": "<p>I don't think I've seen that before, thanks for the example, I'll investigate tomorrow</p>",
        "id": 462209768,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723581817
    },
    {
        "content": "<p>Note that it's only one variable here but I've seen 4 or 5 of them, and they tend to have big types too, so it can easily make a big context into an unusably large one</p>",
        "id": 462209925,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723581894
    },
    {
        "content": "<p>Is that only with definitions constructed using tactics?</p>",
        "id": 462212425,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723583098
    },
    {
        "content": "<p>Possibly? I use termination_by most of the time for theorems, so it's using tactics yes</p>",
        "id": 462212588,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723583165
    },
    {
        "content": "<p>It seems that these hypothese appear when recursive calls appear in arguments to recursive calls. More investigation in <a href=\"https://github.com/leanprover/lean4/issues/5038\">https://github.com/leanprover/lean4/issues/5038</a>. Fixable, but not trivially so.</p>",
        "id": 462324159,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723635031
    },
    {
        "content": "<p>As for</p>\n<blockquote>\n<p><code>decreasing_by exact this -- why is this needed? It is way slower without it</code></p>\n</blockquote>\n<p>I believe it’s because <code>macro_rules</code> are applied bottom to top, so a few other things are tried before <code>assumption</code> is tried, and maybe some of them are slow in your case (I guess the <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>’ed example doesn’t exhibit the slowness anymore)</p>",
        "id": 462328396,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723636200
    }
]