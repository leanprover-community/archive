[
    {
        "content": "<p>I'm trying to print the output of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Widget.exprDiff#doc\">docs#Lean.Widget.exprDiff</a> as a widget, using the <code>&lt;InteractiveCode&gt;</code> widget, but the diff doesn't seem to be showing up:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Html</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">Component</span><span class=\"bp\">.</span><span class=\"n\">HtmlDisplay</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Json</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"w\"> </span><span class=\"n\">Jsx</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Html</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">before_t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">after_t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">exprDiff</span><span class=\"w\"> </span><span class=\"n\">before_t</span><span class=\"w\"> </span><span class=\"n\">after_t</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">before_tagged</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">ppExprTagged</span><span class=\"w\"> </span><span class=\"n\">before_t</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">after_tagged</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">ppExprTagged</span><span class=\"w\"> </span><span class=\"n\">after_t</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">before_diff</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">addDiffTags</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"n\">before_tagged</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">after_diff</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">addDiffTags</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"n\">after_tagged</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">div</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">&lt;</span><span class=\"n\">InteractiveCode</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"bp\">=</span><span class=\"o\">{</span><span class=\"n\">before_diff</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">/&gt;&lt;</span><span class=\"n\">br</span><span class=\"w\"> </span><span class=\"bp\">/&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">&lt;</span><span class=\"n\">InteractiveCode</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"bp\">=</span><span class=\"o\">{</span><span class=\"n\">after_diff</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">/&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;/</span><span class=\"n\">div</span><span class=\"bp\">&gt;</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"#diff_types\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">diff_types</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">savePanelWidgetInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">HtmlDisplayPanel</span><span class=\"bp\">.</span><span class=\"n\">javascript</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"bp\">.</span><span class=\"n\">RpcEncodable</span><span class=\"bp\">.</span><span class=\"n\">rpcEncode</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">tk</span>\n\n<span class=\"sd\">/-- begin example -/</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- doesn't show any diff</span>\n<span class=\"bp\">#</span><span class=\"n\">diff_types</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>",
        "id": 451732618,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721126949
    },
    {
        "content": "<p>(this doesn't seem to work at all in the web editor due to <code>The requested module 'blob:https://live.lean-lang.org/99574127-ee5e-469d-9348-e622cadff5ad' does not provide an export named 'useRpcSession'</code>)</p>",
        "id": 451732798,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721127014
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> is this the fault of our workaround?</p>",
        "id": 451737137,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1721128781
    },
    {
        "content": "<p>This widget works on <code>v4.8.0-rc1</code>, but without the diff highlighting.</p>",
        "id": 451738812,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1721129458
    },
    {
        "content": "<p>Yes, to be clear my issue is that the types appear with no highlighting</p>",
        "id": 451739451,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721129750
    },
    {
        "content": "<p>It looks to me like <code>Lean.Widget.addDiffTags</code> is not actually populating the tags?</p>",
        "id": 451741492,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721130597
    },
    {
        "content": "<p>Ah probably not from our recent workaround then.</p>",
        "id": 451741567,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1721130612
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">ExprDiffTag</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">Diff</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ExprDiffTag</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">DiffTag</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">ExprDiff</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">TaggedText</span><span class=\"bp\">.</span><span class=\"n\">listTags</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">TaggedText</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"bp\">.</span><span class=\"n\">listTags</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"n\">ars</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ars</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">TaggedText</span><span class=\"bp\">.</span><span class=\"n\">listTags</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and running <code>Lean.logInfo m!\"{repr (before_diff.listTags.map (¬∑.diffStatus?))}\"</code> gives a list of <code>none</code>s</p>",
        "id": 451741640,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721130637
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span></p>",
        "id": 451744468,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1721131656
    },
    {
        "content": "<p>Here is one way of rendering diffs of expressions that has worked for me in the past:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Html</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">Component</span><span class=\"bp\">.</span><span class=\"n\">HtmlDisplay</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">Jsx</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">CodeWithInfos</span><span class=\"bp\">.</span><span class=\"n\">addDiffs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">diffs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">DiffTag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CodeWithInfos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CodeWithInfos</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">code</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">diffs</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">subexprPos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">diffStatus?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\">    </span><span class=\"n\">none</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span><span class=\"w\">   </span><span class=\"n\">info</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">renderWithDiffs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">diffs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">DiffTag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Html</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">ppExprTagged</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">addDiffs</span><span class=\"w\"> </span><span class=\"n\">diffs</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">InteractiveCode</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"bp\">=</span><span class=\"o\">{</span><span class=\"n\">e'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">/&gt;</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">renderWithDiffs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">diffs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">DiffTag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Html</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">renderWithDiffs</span><span class=\"w\"> </span><span class=\"n\">diffs</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"s2\">\"#test_diff_render\"</span><span class=\"w\"> </span><span class=\"n\">thm</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">thm</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">renderWithDiffs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">pushBindingBody</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">pushAppArg</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">willChange</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">savePanelWidgetInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">HtmlDisplayPanel</span><span class=\"bp\">.</span><span class=\"n\">javascript</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"bp\">.</span><span class=\"n\">RpcEncodable</span><span class=\"bp\">.</span><span class=\"n\">rpcEncode</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n\n<span class=\"bp\">#</span><span class=\"n\">test_diff_render</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_zero</span>\n</code></pre></div>",
        "id": 451744678,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1721131734
    },
    {
        "content": "<p>With that example, I have to build the diff myself rather than using <code>Lean.Widget.exprDiff</code>, right?</p>",
        "id": 451746785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721132553
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik B√∂ving</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20.60exprDiff.60.20in.20widgets/near/451737137\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> is this the fault of our workaround?</p>\n</blockquote>\n<p>Which work-around again?</p>",
        "id": 451747251,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1721132740
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20.60exprDiff.60.20in.20widgets/near/451732798\">said</a>:</p>\n<blockquote>\n<p>(this doesn't seem to work at all in the web editor due to <code>The requested module 'blob:https://live.lean-lang.org/99574127-ee5e-469d-9348-e622cadff5ad' does not provide an export named 'useRpcSession'</code>)</p>\n</blockquote>\n<p>Ah, most likely the web editor needs to update its <code>@leanprover/infoview</code> dependency.</p>",
        "id": 451747265,
        "sender_full_name": "ùö†ùöòùöìùöåùöíùöéùöåùöë ùöóùöäùö†ùöõùöòùöåùöîùöí",
        "timestamp": 1721132746
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20.60exprDiff.60.20in.20widgets/near/451741492\">said</a>:</p>\n<blockquote>\n<p>It looks to me like <code>Lean.Widget.addDiffTags</code> is not actually populating the tags?</p>\n</blockquote>\n<p>Looking more closely; the <code>Pos</code> info in the result of <code>exprDiff</code> doesn't match with the pos info in <code>ppExprTagged</code></p>",
        "id": 451747513,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721132843
    },
    {
        "content": "<p>It works correctly if the theorems being compared start with a pi binder! That is, my original code works with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bar2</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- works</span>\n<span class=\"bp\">#</span><span class=\"n\">diff_types</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"n\">bar2</span>\n</code></pre></div>",
        "id": 451747740,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721132934
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20.60exprDiff.60.20in.20widgets/near/451747251\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik B√∂ving</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20.60exprDiff.60.20in.20widgets/near/451737137\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> is this the fault of our workaround?</p>\n</blockquote>\n<p>Which work-around again?</p>\n</blockquote>\n<p>The one where we hide symbols from the LSP, but it's not it.</p>",
        "id": 451747853,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1721132983
    },
    {
        "content": "<p>I think the issue here is that the diff highlighting only works if the <code>Subexpr</code> being highlighted already has info attached</p>",
        "id": 451887455,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721171169
    },
    {
        "content": "<p>In my original example, it fails because <code>exprDiff</code> detects the diff at the <code>nat_lit 1</code> in <code>@OfNat.ofNat _ _ (nat_lit 1)</code>, but the tagged format only records a node for the entire <code>@OfNat.ofNat</code> node</p>",
        "id": 451887575,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721171231
    }
]