[
    {
        "content": "<p>The following fails with <code>unknown constant 'IntegrallyClosedDomain₂.mk'</code> and <code>'IsIntegrallyClosed' is not a structure</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>In contrast the following works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FractionRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Also, trying to solve the first issue using the following does not work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain₃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>Note that  <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/RingTheory/IntegralClosure/IntegrallyClosed.lean#L59-L69\">the referenced <code>IsIntegralClosure</code></a> is implemented as an <code>abbrev</code>.</p>\n<p>It seems like the <code>class abbrev</code> set-up was not seeing through other <code>abbrev</code>s.</p>\n<p>Is this intended behaviour?</p>",
        "id": 471895107,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726902168
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> showing the issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">B</span>\n</code></pre></div>",
        "id": 471983925,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726961182
    },
    {
        "content": "<p>Can you give an import-free <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> ?</p>",
        "id": 471988387,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726965364
    },
    {
        "content": "<p>Is this highlighting the same issue?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Z0</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Z1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Z0</span>\n\n<span class=\"c1\">-- works</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Z0'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Z0</span>\n\n<span class=\"c1\">-- `Z1` is not a structure</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Z1'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Z1</span>\n</code></pre></div>",
        "id": 472010977,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726981575
    },
    {
        "content": "<p>The problem is not with <code>class abbrev</code>, it's with <code>extends</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Z0</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Z1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Z0</span>\n\n<span class=\"c1\">-- works</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Z0'</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Z0</span>\n\n<span class=\"c1\">-- `Z1` is not a structure</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Z1'</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Z1</span>\n</code></pre></div>",
        "id": 472011245,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726981770
    },
    {
        "content": "<p>Update <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>. Note that the only difference between the working and non-working examples is <code>class abbrev</code> vs bare <code>abbrev </code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">OK₁</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">OK₂</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">OK₁</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">OK₃</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">OK₂</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">FAIL₁</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">FAIL₂</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FAIL₁</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">FAIL₃</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">FAIL₂</span>\n\n<span class=\"c1\">---</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">OKAY₁</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">OKAY₂</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">OKAY₁</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">OKAY₃</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">OKAY₂</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FAILURE₁</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">FAILURE₂</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FAILURE₁</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FAILURE₃</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">FAILURE₂</span>\n</code></pre></div>",
        "id": 472022396,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726989903
    },
    {
        "content": "<p>That's because a <code>class abbrev</code> is not an <code>abbrev</code> but a <code>structure</code>.</p>",
        "id": 472058997,
        "sender_full_name": "Mac Malone",
        "timestamp": 1727022160
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> I apologize if this is a basic question, but does that mean that everything is working as expected here from both a Lean and Mathlib perspective?</p>\n<p>From the perspective of a a novice undergraduate user, this is the code I naïvely assumed would work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>I'm trying to pinpoint exactly where my reasoning went wrong here, and what I can do to fix it :)</p>",
        "id": 472069405,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1727028588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/stream/270676-lean4/topic/class.20abbrev.20set-up.20not.20seeing.20through.20other.20abbrevs/near/472011245\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- `Z1` is not a structure</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Z1'</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Z1</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This looks like it's worth reporting as a bug.</p>",
        "id": 472070946,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727028987
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"683979\">@Isak Colboubrani</span> As Kyle noted, the problem here is that a <code>structure</code> does not see through abbreviations. As you experienced, this is unintuitive and would be nice to fix.</p>",
        "id": 472091859,
        "sender_full_name": "Mac Malone",
        "timestamp": 1727045514
    },
    {
        "content": "<p>Thanks for reporting it (<a href=\"https://github.com/leanprover/lean4/pull/5417\">lean4#5417</a>)</p>",
        "id": 472112365,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727058038
    }
]