[
    {
        "content": "<p>I have some code which extracts infotrees from an elaborated Lean file and processes them in some way. A minimal version of this code is here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Frontend</span>\n\n<span class=\"n\">unsafe</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">InputContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readFile</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">parseHeader</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">processHeader</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">commandState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">mkState</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">enabled</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">commandState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmdPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Frontend</span><span class=\"bp\">.</span><span class=\"n\">FrontendM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">processCommands</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">commandState</span><span class=\"bp\">.</span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">trees</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n</code></pre></div>\n<p>When I run this as <code>lake exe foo Test.lean</code> with the contents of <code>Test.lean</code> being </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I get <code>2</code> as the output, which is what I expect, if I run this in <code>leanprover/lean4:v4.24.0</code>. When using <code>leanprover/lean4:v4.25.0-rc2</code>, I end up with <code>1</code> (just the <code>elabEoi</code> infotree). I couldn't find anything in the <a href=\"https://lean-lang.org/doc/reference/latest/releases/v4.25.0/#release-v4___25___0\">release notes</a> that would indicate this change in behavior, but it's possible I didn't look hard enough. Is this a bug, or is there a different way to obtain the infotrees after elaboration in <code>FrontendM</code>?</p>",
        "id": 554186919,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1762462078
    },
    {
        "content": "<p>Is the change of behavior specific to <code>example</code> (rather than <code>theorem</code>)?</p>",
        "id": 554284895,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1762510821
    },
    {
        "content": "<p>It's not specific to <code>example</code>, the same happens with <code>theorem</code>. What seems to happen in <code>4.25.0</code> is that <code>CommandState.infoState.trees</code> is a singleton after <em>every</em> <code>processCommand</code> step, where the infotree is only the one obtained from elaborating the last command. Here's a standalone code block if anyone wants to test:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Frontend</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\</span>\n<span class=\"s2\">theorem foo (a b : Nat) : a + b = b + a := by</span>\n<span class=\"s2\">  rw [Nat.add_comm]</span>\n<span class=\"s2\">\"</span>\n\n<span class=\"n\">unsafe</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">InputContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">parseHeader</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">processHeader</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">commandState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">mkState</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">enabled</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">commandState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmdPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Frontend</span><span class=\"bp\">.</span><span class=\"n\">FrontendM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">processCommands</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">commandState</span><span class=\"bp\">.</span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">trees</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">main</span>\n</code></pre></div>",
        "id": 554300036,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1762515108
    },
    {
        "content": "<p>Aha, it looks like <a href=\"https://github.com/leanprover/lean4/commit/316859e87167dcb8a7f7ada18b241ab7c0135f43\">this recent commit</a> which changed <code>elabCommandTopLevel</code> is responsible! It seems that the new behavior is intentional, and not a bug.</p>\n<blockquote>\n<p>perf: reset <code>InfoState.lazyAssignment</code> before each command (<a href=\"https://github.com/leanprover/lean4/pull/10744\">#10744</a>)</p>\n</blockquote>\n<blockquote>\n<p>This PR fixes a performance regression introduced in <a href=\"https://github.com/leanprover/lean4/pull/10518\">#10518</a>. More generally, it ensures both message log and info state are per-command, which has been the case in practice ever since the asynchronous language driver was introduced.</p>\n</blockquote>",
        "id": 554407912,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762546100
    },
    {
        "content": "<p>Great find! Okay, so it seems that indeed I will have to get the infotree after every invokation of <code>processCommand</code>.</p>",
        "id": 554410943,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1762547454
    },
    {
        "content": "<p>Given this change, it is a bit strange though that <code>InfoState.trees</code> is of type <code>PersistentArray InfoTree</code> and not just <code>InfoTree</code> (or <code>Option InfoTree</code>.</p>",
        "id": 554411042,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1762547500
    },
    {
        "content": "<p>Does a <code>mutual</code> block return multiple InfoTrees?</p>",
        "id": 554839803,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1762839950
    }
]