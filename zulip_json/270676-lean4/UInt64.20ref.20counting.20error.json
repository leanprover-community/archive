[
    {
        "content": "<p>On Lean v4.23.0, when using a <code>UInt64</code> that sets the most significant bit (<code>0x8000000000000000</code> and above), the compiler errors if <code>lean_inc</code> is called on that value when used more than once.</p>\n<p>MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">gSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x8000000000000000</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gSize</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gSize</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>\n<p>errors with</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯<span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">7</span>/8<span class=\"o\">]</span><span class=\"w\"> </span>Building<span class=\"w\"> </span>Main:c.o\ntrace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span>/home/sam/.elan/toolchains/leanprover--lean4---v4.23.0/bin/cc<span class=\"w\"> </span>-c<span class=\"w\"> </span>-o<span class=\"w\"> </span>/home/sam/lean-mwe/.lake/build/ir/Main.c.o.export<span class=\"w\"> </span>/home/sam/lean-mwe/.lake/build/ir/Main.c<span class=\"w\"> </span>-I<span class=\"w\"> </span>/home/sam/.elan/toolchains/leanprover--lean4---v4.23.0/include<span class=\"w\"> </span>-fstack-clash-protection<span class=\"w\"> </span>-fwrapv<span class=\"w\"> </span>-fPIC<span class=\"w\"> </span>-fvisibility<span class=\"o\">=</span>hidden<span class=\"w\"> </span>-Wno-unused-command-line-argument<span class=\"w\"> </span>-O3<span class=\"w\"> </span>-DNDEBUG<span class=\"w\"> </span>-DLEAN_EXPORTING\ninfo:<span class=\"w\"> </span>stderr:\n/home/sam/lean-mwe/.lake/build/ir/Main.c:<span class=\"w\"> </span>In<span class=\"w\"> </span><span class=\"k\">function</span><span class=\"w\"> </span>‘_init_l_mwe___closed__0’:\n/home/sam/lean-mwe/.lake/build/ir/Main.c:39:10:<span class=\"w\"> </span>error:<span class=\"w\"> </span>passing<span class=\"w\"> </span>argument<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>of<span class=\"w\"> </span>‘lean_inc’<span class=\"w\"> </span>makes<span class=\"w\"> </span>pointer<span class=\"w\"> </span>from<span class=\"w\"> </span>integer<span class=\"w\"> </span>without<span class=\"w\"> </span>a<span class=\"w\"> </span>cast<span class=\"w\"> </span><span class=\"o\">[</span>-Wint-conversion<span class=\"o\">]</span>\n<span class=\"w\">   </span><span class=\"m\">39</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>lean_inc<span class=\"o\">(</span>x_1<span class=\"o\">)</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"p\">|</span><span class=\"w\">          </span>^~~\n<span class=\"w\">      </span><span class=\"p\">|</span><span class=\"w\">          </span><span class=\"p\">|</span>\n<span class=\"w\">      </span><span class=\"p\">|</span><span class=\"w\">          </span>uint64_t<span class=\"w\"> </span><span class=\"o\">{</span>aka<span class=\"w\"> </span>long<span class=\"w\"> </span>unsigned<span class=\"w\"> </span>int<span class=\"o\">}</span>\nIn<span class=\"w\"> </span>file<span class=\"w\"> </span>included<span class=\"w\"> </span>from<span class=\"w\"> </span>/home/sam/lean-mwe/.lake/build/ir/Main.c:4:\n/home/sam/.elan/toolchains/leanprover--lean4---v4.23.0/include/lean/lean.h:512:62:<span class=\"w\"> </span>note:<span class=\"w\"> </span>expected<span class=\"w\"> </span>‘lean_object<span class=\"w\"> </span>*’<span class=\"w\"> </span>but<span class=\"w\"> </span>argument<span class=\"w\"> </span>is<span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>‘uint64_t’<span class=\"w\"> </span><span class=\"o\">{</span>aka<span class=\"w\"> </span>‘long<span class=\"w\"> </span>unsigned<span class=\"w\"> </span>int’<span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"m\">512</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>static<span class=\"w\"> </span>inline<span class=\"w\"> </span>void<span class=\"w\"> </span>LEAN_ALWAYS_INLINE<span class=\"w\"> </span>lean_inc<span class=\"o\">(</span>lean_object<span class=\"w\"> </span>*<span class=\"w\"> </span>o<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span>!lean_is_scalar<span class=\"o\">(</span>o<span class=\"o\">))</span><span class=\"w\"> </span>lean_inc_ref<span class=\"o\">(</span>o<span class=\"o\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"p\">|</span><span class=\"w\">                                                </span>~~~~~~~~~~~~~~^\nAt<span class=\"w\"> </span>top<span class=\"w\"> </span>level:\ncc1:<span class=\"w\"> </span>note:<span class=\"w\"> </span>unrecognized<span class=\"w\"> </span>command-line<span class=\"w\"> </span>option<span class=\"w\"> </span>‘-Wno-unused-command-line-argument’<span class=\"w\"> </span>may<span class=\"w\"> </span>have<span class=\"w\"> </span>been<span class=\"w\"> </span>intended<span class=\"w\"> </span>to<span class=\"w\"> </span>silence<span class=\"w\"> </span>earlier<span class=\"w\"> </span>diagnostics\nerror:<span class=\"w\"> </span>external<span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span><span class=\"s1\">'/home/sam/.elan/toolchains/leanprover--lean4---v4.23.0/bin/cc'</span><span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>targets<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>Main:c.o\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>\n<p>Using numeric  symbols for <code>9223372036854775808</code> and above also causes the error, while using an exponent <code>2^64-1</code> does not. The error also doesn't occur if there's only one reference to <code>gSize</code>. I tested that v4.22.0 and earlier don't have this behavior.</p>",
        "id": 540253105,
        "sender_full_name": "Sam Burnham",
        "timestamp": 1758206882
    },
    {
        "content": "<p>Could you please file an issue?</p>",
        "id": 540254682,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1758207291
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/UInt64.20ref.20counting.20error/near/540254682\">said</a>:</p>\n<blockquote>\n<p>Could you please file an issue?</p>\n</blockquote>\n<p>Done: <a href=\"https://github.com/leanprover/lean4/pull/10443\">lean#10443</a></p>",
        "id": 540258534,
        "sender_full_name": "Sam Burnham",
        "timestamp": 1758208201
    },
    {
        "content": "<p>fixed <a href=\"https://github.com/leanprover/lean4/pull/10444\">lean#10444</a></p>",
        "id": 540319172,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758229108
    },
    {
        "content": "<p>Thanks for the quick fix!</p>",
        "id": 540354649,
        "sender_full_name": "Sam Burnham",
        "timestamp": 1758243691
    }
]