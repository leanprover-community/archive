[
    {
        "content": "<p>Sometimes when you invoke <code>MVarId.revert</code> (the low-level <code>MetaM</code> version), additional mvars can be generated.</p>\n<p>Is there a function that can collect the generated mvars from this tactic? The simplest way I can think of is to record the mvar counter and used <code>filterOldMVars</code> to filter all mvars in the current <code>MetaM</code> context.</p>\n<p>This function would take place of the <code>??</code> in</p>\n<div class=\"codehilite\" data-code-language=\"llean4\"><pre><span></span><code>def invokeRevertAndCollect (mvarId: MVarId) (fvarId: FVarId): MetaM (List MVarId) := do\n  let (nextGoal, moreMVars) := ?? do\n    let (_, nextGoal) := mvarId.revert #[fvarId]\n    pure nextGoal\n  return [nextGoal] ++ moreMVars\n</code></pre></div>",
        "id": 468311815,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725667481
    },
    {
        "content": "<p>Do you have an example where you need to collect these mvars? If it's generating mvars, they should be delayed assigned, so they are not your responsibility.</p>",
        "id": 468312588,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725668020
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468312588\">said</a>:</p>\n<blockquote>\n<p>Do you have an example where you need to collect these mvars? If it's generating mvars, they should be delayed assigned, so they are not your responsibility.</p>\n</blockquote>\n<p>There are some cases when the generated mvars are not delayed assigned. Consider this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">?</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">rhs</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">?</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">alpha</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">?</span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">alpha</span>\n</code></pre></div>\n<p>Now suppose you execute <code>.revert #[fvarId]</code> where <code>fvarId</code> is the id of this <code>n</code>, on <code>?snd</code>, you get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">?</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"k\">forall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">alpha'</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs'</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">rhs'</span>\n</code></pre></div>\n<p>(the actual generated mvar names are not as clean as this. I annotated this for clarity)</p>\n<p>In this case instead of having <code>?lhs'</code> being delayed assigned with some expr dependent on <code>?lhs</code>, we get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">?</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">lhs'</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>This is a pretty peculiar case, but if it occurs I don't even have a way of detecting that it happened, hence the question</p>",
        "id": 468314430,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725669249
    },
    {
        "content": "<p>I see. I was noticing this issue recently, and it can pop up whenever you have natural metavariables, and there are lots of tactics that seem to accidentally create natural metavariables for new goals.</p>\n<p>Can you make sure these metavariables are synthetic opaque instead?</p>",
        "id": 468327891,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725677655
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468327891\">said</a>:</p>\n<blockquote>\n<p>I see. I was noticing this issue recently, and it can pop up whenever you have natural metavariables, and there are lots of tactics that seem to accidentally create natural metavariables for new goals.</p>\n<p>Can you make sure these metavariables are synthetic opaque instead?</p>\n</blockquote>\n<p>do you mean the automatically generated ones?</p>\n<p>I have no control over the mvars <code>?alpha, ?lhs, ?rhs</code> because they could be generated from other tactics.</p>\n<p>As long as I can detect when this problem occurs, I can deal with it. My only question is about detecting this problem and collecting the resulting mvars.</p>",
        "id": 468332939,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725679256
    },
    {
        "content": "<p>If <code>revert</code> causes goals to disappear, this is a bug. Please report these bugs. Can you give mwe's of this phenomenon?</p>\n<p>A workaround you could try is to change all the goal metavariables to be synthetic opaque yourself with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarContext.setMVarKind#doc\">docs#Lean.MetavarContext.setMVarKind</a> before doing revert. I <em>think</em> this should work.</p>",
        "id": 468335111,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725680229
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468335111\">said</a>:</p>\n<blockquote>\n<p>If <code>revert</code> causes goals to disappear, this is a bug. Please report these bugs. Can you give mwe's of this phenomenon?</p>\n<p>A workaround you could try is to change all the goal metavariables to be synthetic opaque yourself with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarContext.setMVarKind#doc\">docs#Lean.MetavarContext.setMVarKind</a> before doing revert. I <em>think</em> this should work.</p>\n</blockquote>\n<p>it doesn't cause goals to disappear. I'm operating on the <code>MetaM</code> level where there's no concept of goals like <code>TacticM</code>. I just need to capture the generated mvars from a revert</p>",
        "id": 468335142,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725680268
    },
    {
        "content": "<p>I am pretty sure that revert should not be assigning metavariables like this. You shouldn't need to capture generated mvars.</p>",
        "id": 468340343,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725682184
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468340343\">said</a>:</p>\n<blockquote>\n<p>I am pretty sure that revert should not be assigning metavariables like this. You shouldn't need to capture generated mvars.</p>\n</blockquote>\n<p>so it should just fail in this case? even if the assigned mvars are <code>.natural</code>?</p>",
        "id": 468340405,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725682208
    },
    {
        "content": "<p>Another workaround you could try is to use <code>withNewMCtxDepth</code> to prevent pre-existing mvars to be assigned.</p>",
        "id": 468340467,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725682250
    },
    {
        "content": "<blockquote>\n<p>so it should just fail in this case?</p>\n</blockquote>\n<p>No. My understanding of this issue is that the assignment is happening in the wrong direction. It would be very helpful having some mwes to properly report it.</p>",
        "id": 468340592,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725682343
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468340592\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>so it should just fail in this case?</p>\n</blockquote>\n<p>No. My understanding of this issue is that the assignment is happening in the wrong direction. It would be very helpful having some mwes to properly report it.</p>\n</blockquote>\n<p>I can try producing one.</p>",
        "id": 468342872,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725683660
    },
    {
        "content": "<p>Its done:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">showMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvarId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExprMVarAssignment</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{name} := {← Meta.ppExpr expr}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getDelayedMVarAssignment</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{name} ::= {a.mvarIdPending.name}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{name} is not assigned\"</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">metaM</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`Nat</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">Meta.withLocalDecl</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta.mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">type</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta.mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goalType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta.mkEq</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta.mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"n\">goalType</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"goal: {← Meta.ppExpr $ ← goal.mvarId!.getType}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">goal2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal.mvarId</span><span class=\"bp\">!.</span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">fvar.fvarId</span><span class=\"bp\">!</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"goal2 : {← Meta.ppExpr $ ← goal2.getType}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal2.getType</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">panic</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"This must be a ∀\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">lhs'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">rhs'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">body.eq</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">panic</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"Wrong type\"</span>\n<span class=\"w\">    </span><span class=\"n\">showMVar</span><span class=\"w\"> </span><span class=\"s2\">\"lhs\"</span><span class=\"w\"> </span><span class=\"n\">lhs.mvarId</span><span class=\"bp\">!</span>\n<span class=\"w\">    </span><span class=\"n\">showMVar</span><span class=\"w\"> </span><span class=\"s2\">\"rhs\"</span><span class=\"w\"> </span><span class=\"n\">rhs.mvarId</span><span class=\"bp\">!</span>\n<span class=\"w\">    </span><span class=\"n\">showMVar</span><span class=\"w\"> </span><span class=\"s2\">\"lhs'\"</span><span class=\"w\"> </span><span class=\"n\">lhs'.mvarId</span><span class=\"bp\">!</span>\n<span class=\"w\">    </span><span class=\"n\">showMVar</span><span class=\"w\"> </span><span class=\"s2\">\"rhs'\"</span><span class=\"w\"> </span><span class=\"n\">rhs'.mvarId</span><span class=\"bp\">!</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`Init</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">options.setBool</span><span class=\"w\"> </span><span class=\"ss\">`pp.all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">coreM</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Meta.MetaM.run'</span><span class=\"w\"> </span><span class=\"n\">metaM</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">coreContext</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean.Core.Context</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">options</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Example</span>\n<span class=\"w\">    </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\">     </span><span class=\"c1\">-- No 'open' directives needed</span>\n<span class=\"w\">    </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;stdin&gt;\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">positions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">coreM.run'</span><span class=\"w\"> </span><span class=\"n\">coreContext</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"bp\">.</span><span class=\"n\">toBaseIO</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{← exception.toMessageData.toString}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>RHS is set to <code>.syntheticOpaque</code> so it wasn't modified by <code>revert</code> (edit: However the generated mvar in <code>goal2</code> corresponding to <code>rhs</code> was modified). Should I file a bug in Lean4 repo?</p>\n<p>In summary:</p>\n<ul>\n<li><code>lhs</code>: Assigned to <code>lhs? x</code></li>\n<li><code>rhs</code>: Not assigned</li>\n<li><code>lhs'</code>: Not assigned</li>\n<li><code>rhs'</code>: Delayed assigned to <code>rhs</code> with fvar. (IMO correct behaviour)</li>\n</ul>",
        "id": 468354342,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725689799
    },
    {
        "content": "<p>Moreover, if you run the tactic with <code>withNewMCtxDepth</code>, you get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">goal</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n<span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span><span class=\"w\"> </span><span class=\"bp\">'?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"bp\">'</span>\n</code></pre></div>\n<p>The unknown mvar occurs at <code>← goal2.getType</code>.</p>",
        "id": 468358094,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725691222
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/issues/5279\">https://github.com/leanprover/lean4/issues/5279</a></p>",
        "id": 468370075,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725696447
    },
    {
        "content": "<p>I came up with a way to fix it. If we can have a function</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">withOpaqueOldMVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvarCount</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>which overrides the kind of mvars older than <code>mvarCount</code> to be <code>.syntheticOpaque</code>. Then we can call it before <code>MetavarContext.revert</code> to prevent the elimination function from assigning to these mvars.</p>\n<p>If people are fine with this solution, I'll open a PR. It requires adding a new field to <code>Meta.Context</code> and modifications to <code>elim</code></p>",
        "id": 468371975,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725696874
    },
    {
        "content": "<p>I love it when people in this community persevere to understand a problem. Thanks a lot for minimising and thinking about a fix! I'm well aware that it's time-consuming.</p>",
        "id": 468381578,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725700308
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468381578\">said</a>:</p>\n<blockquote>\n<p>I love it when people in this community persevere to understand a problem. Thanks a lot for minimising and thinking about a fix! I'm well aware that it's time-consuming.</p>\n</blockquote>\n<p>My main research project is blocked on this bug I may as well fix it asap</p>",
        "id": 468449702,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725731609
    },
    {
        "content": "<p>I just wanted to note that this looks similar to a <a href=\"#narrow/stream/270676-lean4/topic/MVar.20disappearing.20from.20list.20of.20goals.20after.20a.20.60subst.60\">previous discussion on MVar assignments</a>, we've been working around this with an MVar collection tactic and being careful about where MVars are assingned.</p>",
        "id": 468743306,
        "sender_full_name": "Yann Herklotz",
        "timestamp": 1725876389
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"688543\">@Yann Herklotz</span>, I was trying to remember that thread. I've linked to it on the issue (<a href=\"https://github.com/leanprover/lean4/pull/5279\">lean4#5279</a>).</p>",
        "id": 468869748,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725903101
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"688543\">Yann Herklotz</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468743306\">said</a>:</p>\n<blockquote>\n<p>I just wanted to note that this looks similar to a <a href=\"#narrow/stream/270676-lean4/topic/MVar.20disappearing.20from.20list.20of.20goals.20after.20a.20.60subst.60\">previous discussion on MVar assignments</a>, we've been working around this with an MVar collection tactic and being careful about where MVars are assingned.</p>\n</blockquote>\n<p>I came up with a workaround which is to intercept all MVars during <code>Tactic.setGoals</code> and force them to be <code>.syntheticOpaque</code>. It seems to be working for now, but if a tactic runs things with <code>withAssignableSyntheticOpaque</code> we could potentially lose track of the goals</p>",
        "id": 468882532,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725906940
    },
    {
        "content": "<p>There's a problem with this workaround. I sometimes rely on the fact that <code>apply</code> can unify metavariables. For example, I can apply <code>le_of_eq</code> to <code>2 &lt;= ?m</code> and this will induce <code>?m := 2</code>. With all mvars set to <code>.syntheticOpaque</code>, this is no longer possible. I think having this sort of unification is fine as long as no goals are lost</p>",
        "id": 468963028,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725937167
    },
    {
        "content": "<p>Yann suggested in the other thread that <code>apply</code> might need to be doing its unifications using <code>withSyntheticOpaque</code> — this might be justified.</p>",
        "id": 468988105,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725945684
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468988105\">said</a>:</p>\n<blockquote>\n<p>Yann suggested in the other thread that <code>apply</code> might need to be doing its unifications using <code>withSyntheticOpaque</code> — this might be justified.</p>\n</blockquote>\n<p>do you mean <code>withAssignableSyntheticOpaque</code>?</p>",
        "id": 468993260,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1725948429
    },
    {
        "content": "<p>Yeah I think so, as far as I understand, one should use synthetic MVars when creating MVars that one wants to keep around, and that tactics that want to unify those MVars should use <code>withAssignableSyntheticOpaque</code> to explicitly assign them.</p>",
        "id": 469014994,
        "sender_full_name": "Yann Herklotz",
        "timestamp": 1725954225
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/stream/270676-lean4/topic/Collect.20mvars.20during.20a.20tactic/near/468358094\">said</a>:</p>\n<blockquote>\n<p>Moreover, if you run the tactic with <code>withNewMCtxDepth</code>, you get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">goal</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n\n<span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span><span class=\"w\"> </span><span class=\"bp\">'?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"bp\">'</span>\n</code></pre></div>\n<p>The unknown mvar occurs at <code>← goal2.getType</code>.</p>\n</blockquote>\n<p>Relatedly, I’d love if there were a version of <code>withNewMCtxDepth</code> that didn’t revert the entire <code>mctx</code> at the end, but instead raised the depth of the newly-created mvars inside back up to the depth outside. That would prevent unknown mvar errors like these and imo provide more intuitive behavior (intuitively, I wouldn’t expect that increasing the depth would affect anything besides assignability). </p>\n<p>I’ve run into this situation a few times, and collecting/returning the necessary information from within <code>withNewMCtxDepth</code> in a stateless fashion can be frustrating. (I would be in favor of <code>withNewMCtxDepth</code> itself changing if it didn’t break anything!)</p>\n<p>It’s not hard to write a combinator which manages the depths like this yourself, but it does feel “risky”! :) (And a little inefficient.)</p>\n<p>(Note: an alternative, cheaper implementation that I think achieves the same effect (but might require a core change) is to not actually <em>change</em> the depth of any mvars upon closing out <code>withNewMCtxDepth'</code>, but to simply say that any mvars with the current mctx depth <em>or greater</em> are assignable. However, to ensure that you can always create a fresh depth easily when entering subsequent (non-nested) <code>withNewMCtxDepth'</code>s (i.e. to avoid re-entering a previously-used depth), we could maintain the maximum encountered mctx depth in the <code>MetaM</code> state, and increase the depth based on that.)</p>",
        "id": 469832078,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726197651
    }
]