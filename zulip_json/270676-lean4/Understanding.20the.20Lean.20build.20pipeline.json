[
    {
        "content": "<p>When building a Lean file such as <code>ChevalleyComplexity.lean</code> using <code>lake build</code>, it appears that precisely eight files are generated:</p>\n<ul>\n<li><code>ChevalleyComplexity.setup.json</code></li>\n<li><code>ChevalleyComplexity.c</code> + <code>ChevalleyComplexity.c.hash</code></li>\n<li><code>ChevalleyComplexity.trace</code></li>\n<li><code>ChevalleyComplexity.olean</code> + <code>ChevalleyComplexity.olean.hash</code></li>\n<li><code>ChevalleyComplexity.ilean</code> + <code>ChevalleyComplexity.ilean.hash</code></li>\n</ul>\n<p>The files ending in <code>.hash</code> each contain a numeric checksum (such as <code>6944499953131117393</code>), presumably used for cache invalidation.</p>\n<p>As I understand it, the only file that Lean actually reads when I <code>import</code> ChevalleyComplexity is <code>ChevalleyComplexity.olean</code>. Is that correct?</p>\n<p>If so, what roles do the remaining files play during the build process? How is the build pipeline structured: that is, which distinct build steps are executed to produce the final <code>.olean</code> file? </p>\n<p>Example build:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"s2\">\"ChevalleyComplexity.*\"</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">xargs</span><span class=\"w\"> </span><span class=\"n\">file</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">hash</span><span class=\"o\">:</span><span class=\"w\">           </span><span class=\"n\">ASCII</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">terminators</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">setup</span><span class=\"bp\">.</span><span class=\"n\">json</span><span class=\"o\">:</span><span class=\"w\">       </span><span class=\"n\">JSON</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"w\">                </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ASCII</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">very</span><span class=\"w\"> </span><span class=\"n\">long</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">420</span><span class=\"o\">)</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\">      </span><span class=\"n\">JSON</span><span class=\"w\"> </span><span class=\"n\">data</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">olean</span><span class=\"bp\">.</span><span class=\"n\">hash</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ASCII</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">terminators</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">olean</span><span class=\"o\">:</span><span class=\"w\">      </span><span class=\"n\">data</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">ilean</span><span class=\"bp\">.</span><span class=\"n\">hash</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ASCII</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">terminators</span>\n<span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Spectrum</span><span class=\"bp\">/</span><span class=\"n\">Prime</span><span class=\"bp\">/</span><span class=\"n\">ChevalleyComplexity</span><span class=\"bp\">.</span><span class=\"n\">ilean</span><span class=\"o\">:</span><span class=\"w\">      </span><span class=\"n\">JSON</span><span class=\"w\"> </span><span class=\"n\">data</span>\n</code></pre></div>",
        "id": 546730629,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1761239067
    },
    {
        "content": "<p>Perhaps this question would be better suited for the <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a> channel? I don’t have permission to move it over there.</p>",
        "id": 547110198,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1761463740
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Understanding.20the.20Lean.20build.20pipeline\">#new members &gt; Understanding the Lean build pipeline</a> by <span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span>.</p>",
        "id": 547117008,
        "sender_full_name": "Notification Bot",
        "timestamp": 1761471282
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20the.20Lean.20build.20pipeline/near/546730629\">said</a>:</p>\n<blockquote>\n<p>How is the build pipeline structured: that is, which distinct build steps are executed to produce the final <code>.olean</code> file? </p>\n</blockquote>\n<p>The general steps to build a module <code>m</code> are:</p>\n<ul>\n<li>Lake computes and emits the <code>&lt;m&gt;.setup.json</code></li>\n<li>Lake runs <code>lean &lt;m&gt;.lean --setup &lt;m&gt;.setup.json -o &lt;m&gt;.olean -i &lt;m&gt;.ilean -c &lt;m&gt;.c</code></li>\n<li>On success, Lake emits the <code>&lt;m&gt;.trace</code> and the <code>.hash</code> files for future  no-op builds and invalidations.</li>\n</ul>\n<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20the.20Lean.20build.20pipeline/near/546730629\">said</a>:</p>\n<blockquote>\n<p>If so, what roles do the remaining files play during the build process?</p>\n</blockquote>\n<p>The <code>.c</code> file is used to generate native code for a Lean module, so that it can be compiled into, .e.g, an executable. The <code>.ilean</code> file is used by the Lean LSP server (and thus the VS Code extension) for various interactivity features.</p>",
        "id": 547142334,
        "sender_full_name": "Mac Malone",
        "timestamp": 1761495478
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Thanks! That clarifies a lot.</p>",
        "id": 547161359,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1761514345
    },
    {
        "content": "<p>If I understand correctly, the combination of <code>&lt;m&gt;.setup.json</code> (the environment in some sense) and <code>&lt;m&gt;.lean</code> together captures exactly all the inputs that can influence the output <code>&lt;m&gt;.olean</code>. Is there a way to make <code>lake</code> output <code>&lt;m&gt;.setup.json</code> given <code>&lt;m&gt;.lean</code> (without doing the following steps)?</p>",
        "id": 547161985,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1761515045
    }
]