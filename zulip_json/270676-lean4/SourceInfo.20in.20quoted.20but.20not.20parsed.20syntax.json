[
    {
        "content": "<p>It seems that when forming syntax via syntax quotation, synthetic source info can get inserted even in positions that parsing usually does not insert source info. This can change where messages are logged.</p>\n<p>The following is a minimized issue that occurs in the new tactic analysis framework which causes messages to be logged at the current ref instead of on the tactic sequence:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#show_parsed \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">tacticSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#show_quoted \"</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"o\">:</span><span class=\"n\">tactic</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|$</span><span class=\"n\">ts</span><span class=\"o\">:</span><span class=\"n\">tactic</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">show_parsed</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"c1\">-- info logged on this line</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"bp\">#</span><span class=\"n\">show_quoted</span><span class=\"w\"> </span><span class=\"c1\">-- info logged on this line</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>One can see that the syntax created in <code>#show_quoted</code> retains its original source info, but also has synthetic source info near the top of the tree, whereas the parsed <code>tacticSeq</code> has no such info.</p>\n<p>I'm not sure if this is an issue or not. I can imagine that sometimes we want to eagerly add source info from the ref when constructing synthetic syntax (so that we're more likely to have position info than not at the end of the day), but it's a bit unusual to me that it's added despite having perfectly good source info in the syntax we're using to construct it (and that it's being added in a place it isn't \"naturally\" added), so I thought I'd bring it up here.</p>\n<p>(Note: it's not too hard to work around this to get correct logging with e.g. <code>withRef (mkNullNode ts) `(tacticSeq|$ts:tactic*)</code>, or even <code>MonadRef.withRef .missing `(tacticSeq|$ts:tactic*)</code>.)</p>",
        "id": 535927774,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1756070951
    }
]