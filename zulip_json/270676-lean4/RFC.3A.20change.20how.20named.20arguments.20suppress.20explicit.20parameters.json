[
    {
        "content": "<p>The RFC is <a href=\"https://github.com/leanprover/lean4/pull/5397\">lean4#5397</a></p>\n<p>Summary: Currently every explicit parameter that is depended upon by a named argument is elaborated as an implicit argument. This has been a confusing feature, as evidenced by questions on Zulip and the reported issues, but there are still some places where it is useful.</p>\n<ul>\n<li>We would preserve this feature for explicit parameters that haven't been supplied an argument. This happens when there is a named argument for a parameter that occurs after such an explicit parameter. In that case, normally the explicit argument would become an eta argument (it gets lambda abstracted after the application is elaborated), but that would result in a type-incorrect expression if the explicit argument is depended-upon. Instead, we can just elaborate it as an implicit parameter. There are plenty of examples in Batteries/Mathlib that make use of this. I already explored making this be an error, but I found the resulting errors to be more baffling than just letting it elaborate.</li>\n<li>Internally, the way <code>x.f</code> elaborates when <code>f</code> is a field of a structure is as <code>S.f (self := x)</code>. Sometimes structure parameters are explicit, and in this specific case we would have the <code>self</code> argument continue to cause all the structure parameters (the collection of parameters it depends on) to be implicit. Without this exception, while you might be able to write <code>x.f</code> (due to the first bullet), if you wanted to supply any additional arguments <code>a b c</code> you might have to write <code>x.f _ _ a b c</code>, with one <code>_</code> per explicit structure parameter.</li>\n</ul>",
        "id": 472600768,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727230716
    },
    {
        "content": "<p>This RFC was motivated by <a href=\"#narrow/stream/270676-lean4/topic/.40foo.20.28A.20.3A.3D.20bar.29.20_.20_/near/468564862\">this Zulip thread</a>. I had explored disabling the explicit parameter suppression completely, but the feature from the first bullet point is difficult to live without, for example in writing <code>rw [lem (h := foo)]</code> when <code>lem</code> has explicit arguments that <code>h</code> depends on.</p>",
        "id": 472600775,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727230724
    },
    {
        "content": "<p>There is a reference implementation at <a href=\"https://github.com/leanprover/lean4/pull/5283\">lean4#5283</a>. This did not require any changes to Batteries, but you can <a href=\"https://github.com/leanprover-community/mathlib4/compare/nightly-testing...lean-pr-testing-5283\">evaluate the impact on Mathlib</a>.</p>",
        "id": 472600778,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727230727
    },
    {
        "content": "<p>Pinging <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>, <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span>, <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, who have commented so far.</p>",
        "id": 472600781,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727230729
    },
    {
        "content": "<p>The fact that the feature still exists when no more arguments are given seems reasonable. What is the new output of the following (the current output is shown in comment):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- fun y =&gt; foo ?m.76 y 3 : Nat → Nat</span>\n</code></pre></div>\n<p>The output of the following is unchanged?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fun x y =&gt; foo x y 3 : Nat → Nat → Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- ⟨?m.118, 1⟩ : Sigma ?m.115</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fun fst =&gt; (fst, 1) : ?m.144 → ?m.144 × Nat</span>\n</code></pre></div>\n<p>(I just realized that there is a difference between the last two examples: one of them is a function, the other an element of a sigma-type.)</p>",
        "id": 472652643,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727256819
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/RFC.3A.20change.20how.20named.20arguments.20suppress.20explicit.20parameters/near/472600768\">said</a>:</p>\n<blockquote>\n<p>Sometimes structure parameters are explicit [arguments of projections]</p>\n</blockquote>\n<p>Just checking: this only (sometimes) happens for classes, right? For non-class structures, projections never have parameters as explicit arguments, I believe.</p>",
        "id": 472653786,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727257198
    },
    {
        "content": "<p>All of your examples have the exact same output. A difference is that now you can include the <code>_</code> in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- ⟨?m.119, 1⟩ : Sigma ?m.116</span>\n</code></pre></div>\n<p>In current lean this produces a \"function expected\" error. The new behavior makes the trailing <code>_</code> optional because its a dependency (vs required to be omitted). Changing that <code>1</code> to <code>Nat.zero</code> (<code>1</code> obscures the following issue since it's waiting on an OfNat instance) if you try to turn <code>fst</code> into an eta argument like <code>fun x =&gt; Sigma.mk x Nat.zero</code>, this has a type error on <code>Nat.zero</code>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/270676-lean4/topic/RFC.3A.20change.20how.20named.20arguments.20suppress.20explicit.20parameters/near/472653786\">said</a>:</p>\n<blockquote>\n<p>Just checking: this only (sometimes) happens for classes, right?</p>\n</blockquote>\n<p>Yes, correct. Non-class structures always have an explicit <code>self</code> parameter, so all the type parameters are implicit.</p>",
        "id": 472732885,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727280903
    },
    {
        "content": "<p>I forgot to mention the history of this feature: This ability to omit trailing dependencies of named arguments comes from around 2020, and the fix for <a href=\"https://github.com/leanprover/lean4/pull/1851\">lean4#1851</a> comes from around 2022. The RFC is essentially \"revert to the 2020 behavior and re-implement the 2022 behavior for only the <code>self</code> parameter for projection notation\".</p>",
        "id": 472734634,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727281544
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/RFC.3A.20change.20how.20named.20arguments.20suppress.20explicit.20parameters/near/472732885\">said</a>:</p>\n<blockquote>\n<p>All of your examples have the exact same output.</p>\n</blockquote>\n<p>Right, because I didn't actually make the arguments dependent. I'm happy with the new behavior described in this RFC.</p>",
        "id": 472737324,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727282536
    }
]