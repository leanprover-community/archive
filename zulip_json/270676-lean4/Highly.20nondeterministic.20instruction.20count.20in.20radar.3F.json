[
    {
        "content": "<p>I'm doing some benching, and re-benched an earlier commit to see if the earlier bench was a fluke. It seems it was, but I'm not sure how it could be: there seem to be ~400G extra instructions in one run compared to another, and I would have thought instructions are mostly deterministic. However, the contents of the commits are exactly the same.</p>\n<p>The benches in question are:</p>\n<ul>\n<li><a href=\"https://radar.lean-lang.org/repos/mathlib4/commits/3085d730fc9d5f89d63b830f819add2371eef099?reference=e618b64ebf9baaf4ff72ff80c3cdcf3c26ffea59\">fast</a>: benches 3085d730fc9d5f89d63b830f819add2371eef099</li>\n<li><a href=\"https://radar.lean-lang.org/repos/mathlib4/commits/332ece0991aae90921658ce7fa682b1973554f4c?reference=e618b64ebf9baaf4ff72ff80c3cdcf3c26ffea59\">slow</a>: benches 332ece0991aae90921658ce7fa682b1973554f4c</li>\n<li><a href=\"https://radar.lean-lang.org/repos/mathlib4/commits/332ece0991aae90921658ce7fa682b1973554f4c?reference=3085d730fc9d5f89d63b830f819add2371eef099\">comparison of slow to fast</a></li>\n</ul>\n<p>Note that <code>git diff 3085d730fc9d5f89d63b830f819add2371eef099 332ece0991aae90921658ce7fa682b1973554f4c</code> is empty. (This is on <a href=\"https://github.com/leanprover-community/mathlib4/pull/32440\">#32440</a> if anyone would like to pull the branch; it consists of a modification to a linter.)</p>\n<p>This seems unusual to me. Is it?</p>\n<p>If so, how might I find out what's causing the jump in instruction count between these two runs?</p>",
        "id": 562517253,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765213442
    },
    {
        "content": "<p>Instruction count is not deterministic, lean is a concurrent system with lots of reliances on caches, some of which are based on memory addresses etc. A small amount of variance is to be expected</p>",
        "id": 562537618,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765219650
    },
    {
        "content": "<p>Is this small, though? It produces major and minor changes according to radar.</p>",
        "id": 562537718,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765219703
    },
    {
        "content": "<p>What is small and isn't highly depends on the workload. The major and minor stuff in radar has to be hand tuned to account for that sometimes.</p>",
        "id": 562537886,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765219775
    },
    {
        "content": "<p>By workload, you mean e.g. the other runs currently being performed by the benching machine?</p>",
        "id": 562537967,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765219818
    },
    {
        "content": "<p>What program you are benchmarking. The runners only benchmark one thing at a time</p>",
        "id": 562538180,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765219911
    },
    {
        "content": "<p>But the commits are exactly the same; shouldn't it be the same program?</p>",
        "id": 562538318,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765219974
    },
    {
        "content": "<p>Oh wait; I suppose you mean building mathlib vs. something else, and that radar might not yet be fine-tuned to mathlib?</p>",
        "id": 562538341,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765219983
    },
    {
        "content": "<p>I also <a href=\"https://github.com/leanprover-community/mathlib4/pull/32339#issuecomment-3625926061\">observed</a> extra ~400G instructions on two of my PRs following radar's <a href=\"#narrow/channel/116290-rss/topic/Significant.20commits.20to.20mathlib4/near/562307742\">recent recovery from corrupted mathlib clone</a>.</p>",
        "id": 562541075,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1765221178
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Highly.20nondeterministic.20instruction.20count.20in.20radar.3F/near/562538318\">said</a>:</p>\n<blockquote>\n<p>But the commits are exactly the same; shouldn't it be the same program?</p>\n</blockquote>\n<p>As I have explained running lean inherently has a variance of instructions due to things like concurrency and pointer based caches. Running lean twice on the same hardware without anything else running can thus still have variance. Perfectly deterministic execution is basically impossible. If you want that you are approximately 50-60 years too late :P</p>",
        "id": 562544860,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765222611
    },
    {
        "content": "<p>Makes senseâ€”sorry, I think that confusion came from me misinterpreting what you meant by \"depends on the workload\" etc. initially... <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 562545677,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765222933
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 562545840,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765223003
    },
    {
        "content": "<p>Hmm, I was aware that <code>open-mathlib//instructions</code> was a bit more volatile but <code>build//instructions</code> apparently is also more noisy than I expected. The linked bench results don't show any specific culprit, just more red than green for the individual modules (but within expected limits for each module).</p>\n<p>I've turned down the sensitivity on both of these metrics for now. We're also expecting faster benchmark runner hardware with more cores soon, which may behave differently yet again.</p>",
        "id": 562546270,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1765223173
    },
    {
        "content": "<p>Thanks! :)</p>",
        "id": 562549083,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765224394
    },
    {
        "content": "<p>I don't know if this is possible, but it strikes me that maybe this is even a bit of an xy problem: I'm trying to judge the mathlib-wide performance of my linter modification, but the difference I care about gets bundled in with the performance of everything else, and therefore can get covered by noise. This seems common to many meta code modifications.</p>\n<p>One argument is that if it's covered by noise, don't worry about it, but sometimes it's hard to tellâ€”especially if you're going to gradually expand its scope.</p>\n<p>I wonder if it would be possible to have some sort of meta combinator I could include in a temporary commit that singled out the performance of the linter in radarâ€”e.g. if I set <code>profiler</code> to <code>true</code> and used <code>profileit</code>(<code>M</code>) within my linter (which is a trick I've used locally, but is a bit too uninformative on single files). No idea how big of an ask this is, though, so feel free to ignore this feature request. :)</p>",
        "id": 562549288,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765224478
    },
    {
        "content": "<p>I was extremely surprised by this radar output for a change which looked to me essentially like a no-op: <a href=\"https://github.com/leanprover-community/mathlib4/pull/31040#issuecomment-3621974001\">https://github.com/leanprover-community/mathlib4/pull/31040#issuecomment-3621974001</a> . <code>build//instructions</code> + 13.8T (+8.2%).</p>",
        "id": 562562546,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765229804
    },
    {
        "content": "<p>Hmm. I should have paid more attention to your previous posts.</p>",
        "id": 562563102,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1765230051
    },
    {
        "content": "<p>I should add that I don't know if post-merge bench's work with radar, but I've been fighting off deadlines for references today so haven't taken the time to check out the before/after commits and compare yet.</p>",
        "id": 562563669,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765230283
    },
    {
        "content": "<p>We traded <code>910</code> for <code>1000</code> priority right?</p>",
        "id": 562563824,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1765230335
    },
    {
        "content": "<p>Oh maybe not</p>",
        "id": 562563954,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1765230393
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik BÃ¶ving</span> <a href=\"#narrow/channel/270676-lean4/topic/Highly.20nondeterministic.20instruction.20count.20in.20radar.3F/near/562537618\">said</a>:</p>\n<blockquote>\n<p>Instruction count is not deterministic, lean is a concurrent system with lots of reliances on caches, some of which are based on memory addresses etc. A small amount of variance is to be expected</p>\n</blockquote>\n<p>Would doing benchmarking builds with <code>Elab.async</code> set to <code>false</code> help with this?</p>",
        "id": 562564139,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1765230479
    },
    {
        "content": "<p>To a degree sure. But after all you want to benchmark the actual experience of users building the software. There could be meta programs around that hinder parallelism for example</p>",
        "id": 562570979,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1765233639
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/270676-lean4/topic/Highly.20nondeterministic.20instruction.20count.20in.20radar.3F/near/562563669\">said</a>:</p>\n<blockquote>\n<p>I should add that I don't know if post-merge bench's work with radar, but I've been fighting off deadlines for references today so haven't taken the time to check out the before/after commits and compare yet.</p>\n</blockquote>\n<p>If you <code>!bench</code> a PR after a bors merge, the result should be identical to pre bors merge since bors doesn't affect the PR and its commits, but instead creates a new commit on master.</p>",
        "id": 562685474,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1765287257
    },
    {
        "content": "<p>Are these changes real? Both PRs seem quite innocuous.</p>\n<p><a class=\"message-link\" href=\"/#narrow/channel/116290-rss/topic/Significant.20commits.20to.20mathlib4/near/561540762\">#rss &gt; Significant commits to mathlib4 @ ðŸ’¬</a> says `open-mathlib//instructions: +437.4M (+0.6%) and then the next post <a class=\"message-link\" href=\"/#narrow/channel/116290-rss/topic/Significant.20commits.20to.20mathlib4/near/561548551\">#rss &gt; Significant commits to mathlib4 @ ðŸ’¬</a> goes down again.</p>",
        "id": 563080864,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765410307
    },
    {
        "content": "<p>That really looks like it's noise. It's also only <code>+/- 0.6%</code></p>",
        "id": 563181676,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1765458336
    }
]