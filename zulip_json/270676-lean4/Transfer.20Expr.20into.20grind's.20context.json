[
    {
        "content": "<p>I'm trying to tack a feature onto <code>grind</code>, but can't implement it without copying and slightly modifying a number of <code>grind</code>'s (private) functions. I'm wondering if there's potential for this to be addressed as I think it could be a common issue.</p>\n<p><strong>High-Level Problem</strong><br>\nSpecifically, I'm trying to use an <code>Expr</code> obtained from \"outside\" of <code>grind</code> in an mvar context produced by <code>grind</code> itself (I've already partially discussed this in <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Transfer.20exprs.20between.20mvar.20contexts/with/544719331\">#general &gt; Transfer exprs between mvar contexts</a> ). Let's call the outer context <code>o</code> and <code>grind</code>'s context <code>g</code>. The problem I'm running into is that the local context of <code>o</code> is not the same as the local context of <code>g</code>. As a result, any expressions containing fvars which were created in <code>o</code> are broken in the context of <code>g</code>.</p>\n<p><strong>More Details</strong><br>\nThe local contexts of <code>o</code> and <code>g</code> are however not unconnected. AFAICT the local context of <code>g</code> is derived from <code>o</code> by first reverting all local variables in <code>o</code> and then reintroducing them (and potentially introducing more fvars which were previously in the goal). This happens once before <code>grind</code> runs by first calling:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">initCore</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Params</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GrindM</span><span class=\"w\"> </span><span class=\"n\">Goal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">abstractMVars</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">clearImplDetails</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">revertAll</span><span class=\"w\"> </span><span class=\"c1\">-- RELEVANT LINE</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">unfoldReducible</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">betaReduce</span>\n<span class=\"w\">  </span><span class=\"n\">appendTagSuffix</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"ss\">`grind</span>\n<span class=\"w\">  </span><span class=\"n\">mkGoal</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"n\">params</span>\n</code></pre></div>\n<p>... and subsequently calling:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Introduce new hypotheses (and apply `by_contra`) until goal is of the form `... ⊢ False`</span>\n<span class=\"sd\">or is inconsistent.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">generation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SearchM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withCurrGoalContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>... once before <code>grind</code>'s main loop:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Try to solve/close the given goal.</span>\n<span class=\"sd\">Returns `some goal` if this subgoal failed to be closed,</span>\n<span class=\"sd\">and `none` if all subgoals were closed.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">solve</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GrindM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">failed?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">failed?</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SearchM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">tryCatchRuntimeEx</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"w\">  </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SearchM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"c1\">-- RELEVANT LINE</span>\n<span class=\"w\">    </span><span class=\"n\">repeat</span>\n<span class=\"w\">      </span><span class=\"bp\">...</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p><strong>Solution?</strong><br>\nThus, it seems to me that if I want to \"transfer\" an expression <code>e</code> from the outer context <code>o</code> (in which <code>grind</code> is called) to the context <code>g</code> of <code>grind</code>'s <code>Goal</code>, then it would suffice to obtain the list of new fvars introduced by <code>intros</code> and map the fvars in <code>e</code> to those new fvars (as shown in the last post of <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Transfer.20exprs.20between.20mvar.20contexts/with/544719331\">#general &gt; Transfer exprs between mvar contexts</a>). There is, however, currently no good way of doing that except by copying and slightly modifying a number of functions starting at <code>revertAll</code> and <code>intros</code> to retain the fvars. Does this seem correct, or am I missing something?</p>\n<p><strong>Related Efforts</strong><br>\nIt seems to me that the same problem must be addressed in order to allow for <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/grind.20with.20expressions/with/537573063\">#lean4 &gt; grind with expressions</a>. <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, has there been progress on this, or is it in fact the case that you would need something similar to allow for general expression parameters?<br>\nAlso, is there perhaps a completely different approach to using <code>Expr</code>s from outside of <code>grind</code> within <code>grind</code> that I'm missing?</p>",
        "id": 547484189,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1761655622
    },
    {
        "content": "<p>We haven't been moving on passing terms yet, as so far it seems <code>have := foo; grind</code> is sufficing.</p>",
        "id": 547686019,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761735625
    },
    {
        "content": "<p>I'm a little hesitant to promise anything that involves <code>GrindM</code> or <code>Goal</code> at all --- this are internal interfaces that we still want to be able to break without telling anyone. :-)</p>",
        "id": 547686190,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761735674
    },
    {
        "content": "<p>Maybe you can explain why <code>have</code> doesn't work for your application?</p>",
        "id": 547686306,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761735702
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Transfer.20Expr.20into.20grind's.20context/near/547686306\">said</a>:</p>\n<blockquote>\n<p>Maybe you can explain why <code>have</code> doesn't work for your application?</p>\n</blockquote>\n<p>What I'm trying to implement is a <a href=\"https://github.com/marcusrossel/grind-extraction/blob/6dc438d0cf946d8ace9a3d7ce0f288f0ecef609b/Extraction.lean#L39\">wrapper</a> around <code>grind</code> which allows one to make progress when <code>grind</code> fails, by extracting the minimal expression (wrt AST size) equivalent to the initial proof goal. For example, if the goal is <code>P 1 2 3</code> and <code>grind</code> fails to solve this goal, but it does prove that <code>P 1 2 3 = Q</code> along the way, then I want to update the proof goal to be <code>Q</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">min_ast</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ Q</span>\n</code></pre></div>\n<p>That's why I need to translate expressions \"into\" grind and \"out of\" grind. Namely, following the example above, I need to translate <code>P 1 2 3</code> <em>into</em> grind's context, and translate <code>Q</code> <em>out of</em> grind's context. <br>\nTranslating expressions into grind's context seems like it should be doable, as I think there's a relatively direct translation of the fvars as outlined in my previous message. For the reverse direction I'm not sure, as I don't know if grind can introduce new fvars during its procedure (e.g. as a result of case splits?), which then have no corresponding fvar in the \"outer\" context.</p>",
        "id": 553318381,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1762156447
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Transfer.20Expr.20into.20grind's.20context/near/547686190\">said</a>:</p>\n<blockquote>\n<p>I'm a little hesitant to promise anything that involves <code>GrindM</code> or <code>Goal</code> at all --- this are internal interfaces that we still want to be able to break without telling anyone. :-)</p>\n</blockquote>\n<p>That makes total sense. I'm just trying to get this to work <em>somehow</em> and would be interested in any sort of metaprogramming functionality to make this possible, even if it may change/break frequently.</p>\n<p>As it stands, I'm working around this by defining <a href=\"https://github.com/marcusrossel/grind-extraction/blob/45ec0a4b3bf3fad6d6b16d157704ed4c73b79d11/Extraction/Grind.lean#L51\">my own hacky version</a> of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Grind.main#doc\">docs#Lean.Meta.Grind.main</a>, which just relies on the order of fvars in the local contexts, and will surely break in some cases.</p>",
        "id": 553321267,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1762157534
    }
]