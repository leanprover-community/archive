[
    {
        "content": "<p>I'm wondering if it is possible to load a plugin during <code>lake build</code>, so that e.g. a linter introduced by the plugin can run on all files during build, or so that the environment can record some information. I'd like to avoid adding any imports, while still injecting something during initialization for every file.</p>\n<p>One approach is to simply recreate a frontend, call <code>loadPlugin</code> under <code>withImporting</code>, and run it on all files; but this can't easily handle \"dependent\" modifications, where what we want to record in the environment might depend on the environment (and thus on what we've recorded earlier for a given module's dependencies). It would be nice to take advantage of Lake's existing infrastructure for that.</p>\n<p>I suspect it <em>might</em> be possible to make a lake target or facet that does this, but we need to intervene <em>before</em> building, and somehow pass a <code>--plugin</code> argument (or the internal equivalent) to the lean process. I'm not sure how to pass this along.</p>\n<p>Context: making it easy to install library-scale modification tools. :)</p>",
        "id": 563058714,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765401423
    },
    {
        "content": "<p><code>lean_lib</code> has a <code>plugins</code> option which is an array of shared library targets Lake will cause Lean to load as plugins.</p>",
        "id": 563060048,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765401654
    },
    {
        "content": "<p>One can, for example, pass the <code>lib:shared</code> facet of a <code>lean_lib lib</code> target as such a plugin.</p>",
        "id": 563060383,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765401708
    },
    {
        "content": "<p>Oh, wow! I am <em>so</em> glad it's that easy. :D</p>",
        "id": 563060744,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765401770
    },
    {
        "content": "<p>One future desire of mine is adding  a <code>lean_plugin</code> target type that is more specifically focused on producing a plugin (instead of using the <code>shared</code> facet of a <code>lean_lib</code>, which is only incidentally a plugin).</p>",
        "id": 563061528,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765401899
    },
    {
        "content": "<p>Follow-up: I know there's some comment somewhere about how we ought not to load the same symbol twice when using plugins. Does this mean not <code>import</code>ing the library \"normally\" within the <code>lean_lib</code> using it as a plugin? I'm imagining a case where I want to use tools provided by the library-used-as-a-plugin in some meta code downstream (e.g. <code>recordThisInPluginExt foo</code>) but also want to take advantage of the plugin aspect. Would I need to take special care there?</p>",
        "id": 563062374,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765402055
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span>, <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, I have no idea how to use this stuff, I don't even know what a lake plugin is. Could either of you produce an minimal example of injecting a linter without touching the source files?</p>",
        "id": 563081324,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765410589
    },
    {
        "content": "<p>The primary example I'm working off of so far is the <code>pkg/user_plugin/</code> test in lean core. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> As far as I know a plugin is essentially a shared/dynamic(?) library that gets to initialize things at the start of the file without ever being <code>import</code>ed by that file. (As such it's injected by e.g. <code>lean --plugin=path/to/plugin foo</code>, or by the <code>plugins</code> argument discussed here.)</p>\n<p>In the tests at <code>user_plugin</code>, the <code>builtin_initialize</code>s can be replaced with e.g. <code>builtin_initialize addLinter fooLinter</code>.</p>",
        "id": 563081696,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765410801
    },
    {
        "content": "<p>There's a chance I'm getting this wrong, so take it with a grain of salt, as I'm still actively figuring out what's going on here myself.</p>",
        "id": 563081891,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765410903
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Load.20plugin.20during.20build.3F/near/563062374\">said</a>:</p>\n<blockquote>\n<p>Follow-up: I know there's some comment somewhere about how we ought not to load the same symbol twice when using plugins.</p>\n</blockquote>\n<p>There are some comments in the code about this. However, I ended up investigating this more thoroughly ( a while back) and have come to the conclusion that this is not actually an issue on modern platforms. I  am not quite sure why I (and others) previously thought this would be a problem (and thus cannot really disprove it), but it does not appear to be anymore.</p>",
        "id": 563507628,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765555037
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/270676-lean4/topic/Load.20plugin.20during.20build.3F/near/563060383\">said</a>:</p>\n<blockquote>\n<p>One can, for example, pass the <code>lib:shared</code> facet of a <code>lean_lib lib</code> target as such a plugin.</p>\n</blockquote>\n<p>Trying this out; what actually is the correct syntax? For example, if I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">defaultFacets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">LeanLib</span><span class=\"bp\">.</span><span class=\"n\">sharedFacet</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">plugins</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>it typechecks, but doesn't work.</p>\n<p>I noticed some syntax of the form <code> `@pkg/tgt:facet</code>, which seems promising (e.g. <code> `@mypackage/Foo:shared</code>)! Is that the expected way to interact with things here? (I'm wondering if there's a more \"typesafe\" way to do this, because there doesn't seem to be any compile-time resolution of <code> `@</code> syntax.)</p>",
        "id": 563555032,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765570872
    },
    {
        "content": "<p>I'm also hitting an error of the form</p>\n<blockquote>\n<p>error loading library, dlopen(&lt;path-to-.dylib&gt;, 0x0009): symbol not found in flat namespace '_l_Lean_Name_transitivelyUsedConstants___boxed'</p>\n</blockquote>\n<p>I'm not really sure how to start debugging that... <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> Would certainly appreciate any hints/thoughts! :)</p>",
        "id": 563555661,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765571183
    },
    {
        "content": "<p>Note: I'm experimenting by modifying Mathlib to use some plugins by adding a shared <code>lean_lib</code> to Mathlib's lakefile then loading it as a plugin for mathlib. <code>transitivelyUsedConstants</code> is used in some files I copied to the shared lib, and it seems to come from the <code>ImportGraph</code> dependency, if that's a clue...</p>",
        "id": 563556060,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765571365
    },
    {
        "content": "<p>(This error appears when attempting to build a file with only core imports in Mathlib; the shared library itself builds successfully.)</p>",
        "id": 563556141,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765571396
    },
    {
        "content": "<p>Hmm, I'm struggling to get anything working when the plugin/shared library has <em>any</em> imports, even if they're not used. Here's a zip file of an example package for which <code>lake build</code> fails:<br>\n<a href=\"/user_uploads/3121/apDfgmtDGy2JQgCT0h9qZ1tG/OutletPkg.zip\">OutletPkg.zip</a><br>\nHowever, go into <code>LocalPluginPkg.lean</code> and comment out <code>import Batteries</code>, and <code>lake build</code> works (and demonstrates the plugins working). Otherwise, on windows, I get the error</p>\n<blockquote>\n<p>OutletPkg/Basic.lean:1:0: error loading library c:\\Users\\Notoc\\Coding\\Lean\\PluginTest\\OutletPkg\\.lake\\build\\lib\\LocalPluginPkg.dll: 126</p>\n</blockquote>\n<p>(I get a similar error on mac.)</p>\n<p>Are plugins simply disallowed from having imports, or am I doing something wrong? Or is this a bug?</p>\n<p>(I've tried things like adding <code>needs = [\"batteries/Batteries:shared\"]</code> to the plugin's <code>lean_lib</code>, but to no avail.)</p>",
        "id": 563570279,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765578026
    },
    {
        "content": "<p>I managed to make it build successfully by changing the lakefile to:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span>name = \"OutletPkg\"\n<span class=\"w\"> </span>version = \"0.1.0\"\n<span class=\"w\"> </span>defaultTargets = [\"OutletPkg\"]\n\n<span class=\"w\"> </span>[[require]]\n<span class=\"w\"> </span>name = \"batteries\"\n<span class=\"w\"> </span>git = \"https://github.com/leanprover-community/batteries\"\n<span class=\"w\"> </span>rev = \"main\"\n\n<span class=\"w\"> </span>[[lean_lib]]\n<span class=\"w\"> </span>name = \"LocalPluginPkg\"\n<span class=\"w\"> </span>defaultFacets = [\"shared\"]\n<span class=\"w\"> </span>leanOptions = { experimental.module = true }\n\n<span class=\"w\"> </span>[[lean_lib]]\n<span class=\"w\"> </span>name = \"OutletPkg\"\n<span class=\"w\"> </span>needs = [\"OutletPkg/LocalPluginPkg\"]\n<span class=\"w\"> </span>plugins = [\"OutletPkg/LocalPluginPkg:shared\"]\n<span class=\"gi\">+dynlibs = [\"batteries/Batteries:shared\"]</span>\n<span class=\"w\"> </span>leanOptions = { experimental.module = true }\n</code></pre></div>",
        "id": 563881018,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1765819130
    },
    {
        "content": "<p>Aha! What if we do a static link instead:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span>name = \"OutletPkg\"\n<span class=\"w\"> </span>version = \"0.1.0\"\n<span class=\"w\"> </span>defaultTargets = [\"OutletPkg\"]\n\n<span class=\"w\"> </span>[[require]]\n<span class=\"w\"> </span>name = \"batteries\"\n<span class=\"w\"> </span>git = \"https://github.com/leanprover-community/batteries\"\n<span class=\"w\"> </span>rev = \"main\"\n\n<span class=\"w\"> </span>[[lean_lib]]\n<span class=\"w\"> </span>name = \"LocalPluginPkg\"\n<span class=\"w\"> </span>defaultFacets = [\"shared\"]\n<span class=\"w\"> </span>leanOptions = { experimental.module = true }\n<span class=\"gi\">+moreLinkObjs = [\"batteries/Batteries:static\"]</span>\n\n<span class=\"w\"> </span>[[lean_lib]]\n<span class=\"w\"> </span>name = \"OutletPkg\"\n<span class=\"w\"> </span>needs = [\"OutletPkg/LocalPluginPkg\"]\n<span class=\"w\"> </span>plugins = [\"OutletPkg/LocalPluginPkg:shared\"]\n<span class=\"w\"> </span>leanOptions = { experimental.module = true }\n</code></pre></div>",
        "id": 563890809,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1765821983
    },
    {
        "content": "<p>The <code>needs</code> should be unnecessary. The main issue here is was that Lake does not, by default, link a shared library to its dependent shared libraries. Thus, users need to make those dependents available to Lean manually  so that the plugin can load successfully. Anne presents a couple of ways to do this (thanks!), and the existence of multiple solutions is partly why Lake does not currently do this automatically.  However, I do hope to provide a cleaner solution in the future (e.g., <code>lean_plugin</code> with some customization options)  when I have more time to devote to this aspect of Lake.</p>",
        "id": 563985020,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765873250
    },
    {
        "content": "<p>Nice! I do think it would be great if Lake linked everything automatically here even just when building shared facets, before the <code>lean_plugin</code> solution, though; it took some time to figure out these solutions on a call together, and it doesn’t seem like the kind of thing that should be done manually anyway (plugin aside), right?</p>\n<p>I can imagine that the sensible default for most users here is statically linking the dependency libraries when building shared libraries; otherwise, every time you add a dependency, you need to update the lakefile, which makes maintaining shared facets harder. Perhaps there could be a way to opt out of this behavior for users who don’t want static linking instead of having to opt in? Otherwise, the default state for using shared facets is a non-working state. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 564048357,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765893507
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> The idea with a shared facet is that shared library of <code>lean_lib</code> works like the shared library of normal C lib. In C space, it is normal to link a library and its dependencies separately rather than bundled them all together (e.g.,  libraries like  Lean's <code>gmp</code>, <code>pthread</code>, <code>m</code> are common depedencies of C code, but are not usually statically linked to it -- sometimes, like with <code>gmp</code>, due to licensing restrictions).</p>",
        "id": 564115533,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765912401
    },
    {
        "content": "<p>Hmm, okay—but doesn't this introduce a high maintainability cost for plugins? I understand the analogy, but I'm not sure Lean users should be thought of as C users, after all—most will not be familiar with that ecosystem. :) For them, this does mean that the default state is non-working, when, to my mind, this could be handled automatically—and would be the correct thing in most cases, right? Otherwise, to load a plugin with dependencies, you need to look at documentation for that module's dependencies and load them as dynlibs, and the error messages are quite obscure. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 564116581,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765912824
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> For plugins, yes. The <code>shared</code> facet was not originally designed with plugins in mind (and that is still not really its primary purpose). That is why I want to introduce a proper <code>lean_plugin</code> that more cleanly targets that use case.</p>",
        "id": 564116767,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765912914
    },
    {
        "content": "<p>To elaborate a bit on <code>shared</code>'s purpose. It was initially intended for use with Lean FFI / Reverse FFI  with languages like C and Rust (hence the similar approach to code organization). It is also used internally by Lake in <code>precompileModules</code> setups (where Lake knows its dependencies and can load them alongside).</p>",
        "id": 564118767,
        "sender_full_name": "Mac Malone",
        "timestamp": 1765913632
    },
    {
        "content": "<p>Okay, I see! Thanks for elaborating—that was going to be my next question! :)</p>\n<p>It's rather low-prio, then (especially if <code>lean_plugin</code> will exist), but it would be nice if one day the error messages were friendlier; maybe e.g. when building the shared facet lake demands that a flag is explicitly set in the config which specifies whether you are going to link it dynamically or statically, and the lack of this flag becomes a chance to explain the situation to the user in the resulting error message. But, of course, I know you're busy, and there are likely bigger fish to fry... :)</p>",
        "id": 564120652,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765914262
    },
    {
        "content": "<p>One question I have about a future <code>lean_plugin</code>, though—sometimes we will want to load the plugin library via <code>import</code> downstream to extend it. What are the tradeoffs with having e.g. a <code>LeanLib.pluginFacet</code> facet for a <code>lean_lib</code>? (Maybe plugins demand different config options?) Would an example usage be to have e.g. both <code>lean_lib</code> and <code>lean_plugin</code>, or would <code>lean_plugin</code> imply <code>lean_lib</code>? (I understand if these questions and tradeoffs are still being figured out, of course... <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>",
        "id": 564120940,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1765914366
    }
]