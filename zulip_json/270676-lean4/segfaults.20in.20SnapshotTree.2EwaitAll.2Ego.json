[
    {
        "content": "<p>I have a little weekend project in which I'm generating very large proof objects. </p>\n<p>To keep things sane I am using <code>abstractProof</code> <em>a lot</em> (e.g. 10s of thousands of times).</p>\n<p>Things were going well until I started getting segfaults, which I have tracked down (via <code>lldb</code>) to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">EXC_BAD_ACCESS</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"bp\">=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x173e63ff0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010be2224c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l___private_Lean_Language_Basic_0__Lean_Language_SnapshotTree_waitAll_go___lam__0</span>\n</code></pre></div>\n<p>(the full backtrace here has 160,000 frames!)</p>\n<p>The relevant function is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Returns a task that waits on all snapshots in the tree. -/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SnapshotTree</span><span class=\"bp\">.</span><span class=\"n\">waitAll</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SnapshotTree</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">SnapshotTask</span><span class=\"w\"> </span><span class=\"n\">SnapshotTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">::</span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"bp\">.</span><span class=\"n\">bindTask</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sync</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Any advice?</p>\n<ul>\n<li>Do we really need these snapshots? Can I avoid them somehow?</li>\n<li>Could <code>waitAll.go</code> be changed in order to be less prone to the segfault?</li>\n</ul>\n<p>I think I can probably change my design to call <code>abstractProof</code> less often, but still often enough, so I'll try that in the meantime.</p>",
        "id": 536897008,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756538867
    },
    {
        "content": "<p>Setting <code>Elab.async</code> to false should work I think?</p>",
        "id": 536897892,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1756540011
    },
    {
        "content": "<p>Hmm... I think I am benefitting from that, however.</p>\n<p>I've successfully reduced the density of <code>abstractProof</code>, and got the proof over the line.</p>",
        "id": 536898228,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756540401
    }
]