[
    {
        "content": "<p>I've been running into <a href=\"#narrow/stream/442935-Carleson/topic/disk.20space\">storage issues</a> on Github pages hosting blueprint + documentation.<br>\nLooking at the size of the Github pages for my project, this is roughly 1GB, and I believe 99+% of that is the documentation pages. See e.g. the artifacts from <a href=\"https://github.com/fpvandoorn/carleson/actions/runs/9805108806\">Carleson</a> <a href=\"https://github.com/fpvandoorn/BonnAnalysis/actions/runs/9439552282\">BonnAnalysis</a> <a href=\"https://github.com/leanprover-community/sphere-eversion/actions/runs/9359616808\">sphere-eversion</a> and <a href=\"https://github.com/YaelDillies/LeanCamCombi/actions/runs/9663087919\">LeanCamCombi</a>. <br>\nGithub states that Github pages may not be larger than 1GB (soft limit). I think I've been running into a hard limit by trying to put two projects on the same account. However, as Mathlib grows, this will become an issue for everyone.</p>\n<p>I think it would be nice to be able to host light-weight docs, including only your project, but not the docs of Mathlib (+ dependecies). Then the links can go to the official Mathlib doc. Sure, that will lead to broken links because of version mismatches, but it's probably better than not being able to host the docs on Github pages anymore(?)<br>\nBut maybe someone else knows a better solution.</p>",
        "id": 449303431,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720183197
    },
    {
        "content": "<p>According to mathlib4_docs doc-gen's output on mathlib + all its dependencies etc. is 87MB compressed and 1.9 GB uncompressed. One thing that you can do to cut down on size right now is to just upload less <span aria-label=\"tm\" class=\"emoji emoji-2122\" role=\"img\" title=\"tm\">:tm:</span>. For example the <code>declarations/</code> is almost entirely full of intermediate build products. The actual page only needs <code>declarations/declaration-data.bmp</code>, all of the other files in that directory are not relevant for the upload. I'll look into changing it such that only the relevant file ends up there and all the others are put elswhere.</p>\n<p>Interlinking between different documentation things is something that I can implement in principle, though I was hoping to reduce the need for this until we have reservoir properly up and running such that we can just link to a central location for documentation instead of having people set links up to projects individually.</p>",
        "id": 449308932,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720184534
    },
    {
        "content": "<p>Okay hacking the change together and testing it on <code>Batteries</code> reveals that about 30% of the space is JSON files that you don't actually need in production. I'll make a change to doc-gen to fix this soon.</p>\n<p>Next going into the directory that contains the actual doc data I see that 40.4% of the space it uses are in fact consumed by <code>header-data.bmp</code> which iirc is only used by <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> for some website rendering stuff? So if we were to cut that out we could presumably get quite large improvements on unpacked disk size already. If what you are doing does not need this I would encourage you to simply delete <code>.lake/build/doc/declarations/header-data.bmp</code> and thus safe on <em>quite</em> some space overall.</p>",
        "id": 449311917,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720185403
    },
    {
        "content": "<p>Yes, I think <code>header-data.bmp</code> is used to assemble the \"100 theorems\" and \"undergraduate math\" list</p>",
        "id": 449312007,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720185454
    },
    {
        "content": "<p>Right, <code>header-data.bmp</code> on mathlib4_docs is 500MB+ large. So deleting that + using the change I just pushed to doc-gen master (difference on file size pending) will reduce your file size rather drastically.</p>\n<p>I'm a little skeptical about having <code>header-data.bmp</code> around now tbh</p>",
        "id": 449314290,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720186333
    },
    {
        "content": "<p>I think I will add an extra facet to doc-gen's lakefile.lean facets such that libraries that are interested in having header-data.bmp for mathlib like applications can use it and the rest of the world is not burdened by it.</p>",
        "id": 449315784,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720186714
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> the changes are live now. Please retry with a doc-gen that is updated to the current main version, I would expect your output size to get halved or better.</p>",
        "id": 449319963,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720188180
    },
    {
        "content": "<p>That's amazing. Thanks for your quick action!</p>",
        "id": 449322211,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720188841
    },
    {
        "content": "<p>Mathlib + all dependencies doc size got reduced from 1.9GB uncompressed to 1.3GB and then without the 500MB+ header data (which is the default now but enabled for mathlib) that would go down to 800MB.</p>",
        "id": 449323492,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720189229
    },
    {
        "content": "<p>(compressed 60MB)</p>",
        "id": 449323541,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720189246
    },
    {
        "content": "<p>You can still go further on this if you remove the lake files like <code>.trace</code> and <code>.hash</code> from the output directory but that's not really something doc-gen, being driven by lake, should do.</p>",
        "id": 449326040,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720189940
    },
    {
        "content": "<p>The (uncompressed) Github-pages size on my projects went from ~1GB yesterday to 380MB after updating. It becomes 370MB when removing the <code>.trace</code> and <code>.hash</code> files. Thanks to <span class=\"user-mention\" data-user-id=\"556875\">@Pietro Monticone</span> for cleaning up my workflow script.</p>",
        "id": 449360694,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720199944
    },
    {
        "content": "<p>So should I be doing a similar thing for the FLT project?</p>",
        "id": 449368753,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720202610
    },
    {
        "content": "<p>Yes, but just updating <code>doc-gen</code> to the latest version should get you almost all of the benefits.</p>",
        "id": 449379170,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720206623
    },
    {
        "content": "<p>I've got a bump in progress</p>",
        "id": 449379630,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720206770
    },
    {
        "content": "<p>(<a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/111\">FLT#111</a>)</p>",
        "id": 449385738,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720208408
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/.5Bdoc-gen.5D.20Documentation.20size/near/449326040\">said</a>:</p>\n<blockquote>\n<p>You can still go further on this if you remove the lake files like <code>.trace</code> and <code>.hash</code> from the output directory but that's not really something doc-gen, being driven by lake, should do.</p>\n</blockquote>\n<p>For future readers of this thread: when removing these files, make sure you only do this in the <code>docs</code> directory (i.e. what you upload to your site) and not in the <code>.lake/build/doc</code> directory. Otherwise, caching of the Mathlib docs will not work correctly.</p>",
        "id": 451865855,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1721165025
    }
]