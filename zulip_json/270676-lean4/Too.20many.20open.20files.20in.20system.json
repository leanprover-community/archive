[
    {
        "content": "<p>I am maintaining a repo with a large number of <em>parallel</em> files and <code>lake build</code> only builds about 20% of the files because all the other ones fail with \"Too many open files in system\". This means I need to run <code>lake build</code> five times in a row for the build to complete! Could this be improved?</p>",
        "id": 569952616,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1769345604
    },
    {
        "content": "<p>The repo in question is no other than <a href=\"https://github.com/google-deepmind/formal-conjectures\">formal-conjectures</a>, which I maintain as part of my work for GDM. The file structure is roughly</p>\n<ol>\n<li>Some meta files</li>\n<li>...imported by <code>FormalConjectures.Util.ProblemImports</code></li>\n<li>...imported by all the conjecture files</li>\n</ol>",
        "id": 569952763,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1769345767
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/270676-lean4/topic/Too.20many.20open.20files.20in.20system/near/569952616\">said</a>:</p>\n<blockquote>\n<p>I am maintaining a repo with a large number of <em>parallel</em> files and <code>lake build</code> only builds about 20% of the files because all the other ones fail with \"Too many open files in system\". This means I need to run <code>lake build</code> five times in a row for the build to complete! Could this be improved?</p>\n</blockquote>\n<p>Are you doing this on a Linux system?</p>",
        "id": 569956506,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769349727
    },
    {
        "content": "<p>If so you should be able to overwrite the limit using <code>ulimit -Hn</code> and <code>ulimit -Sn</code> with some big value. On some systems this value is 1024 by default which is by far not enough for something like this.</p>",
        "id": 569956606,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769349810
    },
    {
        "content": "<p>While we do not currently have OS integration on this level in Lake, it should be technically feasible to check and raise unreasonably low soft limits there as well, so please consider opening an issue</p>",
        "id": 569959486,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769352985
    },
    {
        "content": "<p>\"Too many open files in system\" (<code>ENFILE</code>) is not the same as \"Too many open files\" (<code>EMFILE</code>). <code>ulimit</code> will only help with the latter. What's the content of <code>/proc/sys/fs/file-max</code>? Maybe you have something in <code>/etc/sysctl.d</code> or <code>/etc/sysctl.conf</code> that reduces <code>file-max</code> a lot? (I'm not sure if anything can e.g. limit the number of open files in a control group as opposed to a single process or the system as a whole, and which error you'd get in that case.)</p>",
        "id": 569967150,
        "sender_full_name": "Joseph Myers",
        "timestamp": 1769360474
    },
    {
        "content": "<p>Ah. I think Lean should be okay with the value on my machine at least...</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>sysctl<span class=\"w\"> </span>fs/file-max\n<span class=\"go\">fs.file-max = 9223372036854775807</span>\n</code></pre></div>",
        "id": 569967480,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769360779
    },
    {
        "content": "<p>I run in this all the time, also for buildling mathlib. Without further investigation I had usually set </p>\n<div class=\"codehilite\" data-code-language=\"Fish\"><pre><span></span><code>export <span class=\"nv\">LEAN_NUM_THREADS</span><span class=\"o\">=</span>64\n</code></pre></div>\n<p>(while 128 threads are available)<br>\nwhen that happens. </p>\n<p>A repo where this problem seems to be even worse is <a href=\"https://github.com/trishullab/PutnamBench\">https://github.com/trishullab/PutnamBench</a><br>\non that machine </p>\n<div class=\"codehilite\" data-code-language=\"Fish\"><pre><span></span><code><span class=\"nv\">$ </span>sysctl fs/file-max                                                                                                                                                                                <span class=\"o\">(</span>base<span class=\"o\">)</span>\nfs.file-max <span class=\"o\">=</span> 1048576\n</code></pre></div>\n<p>Next time I will try setting the limits as suggested...</p>",
        "id": 570671219,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1769638928
    }
]