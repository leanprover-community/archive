[
    {
        "content": "<p>I'm getting an error <code>(kernel) unknown constant 'foo._expr_def_1'</code> in this snippet:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref3</span><span class=\"w\"> </span><span class=\"n\">ref4</span><span class=\"w\"> </span><span class=\"n\">ref5</span><span class=\"w\"> </span><span class=\"n\">ref6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref4</span><span class=\"bp\">.</span><span class=\"n\">uaddOverflow</span><span class=\"w\"> </span><span class=\"n\">ref6</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">ref3</span><span class=\"bp\">.</span><span class=\"n\">uaddOverflow</span><span class=\"w\"> </span><span class=\"n\">ref5</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">      </span><span class=\"o\">((</span><span class=\"n\">ref4</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ref6</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">uaddOverflow</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">128</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">safe</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_decide</span><span class=\"o\">)])</span>\n</code></pre></div>\n<p>Not sure if it's a bug in <code>aesop</code> or in <code>bv_decide</code>? <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span></p>",
        "id": 511148170,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1744198881
    },
    {
        "content": "<p>bv_decide does create a definition with this name as an auxiliary constant but I don't understand why it should disappear again.</p>",
        "id": 511148475,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744198967
    },
    {
        "content": "<p>So I would expect it's in fact a combi bug^^</p>",
        "id": 511148544,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744198993
    },
    {
        "content": "<p>Could be the environment replay, is it new in 4.19?</p>",
        "id": 511148761,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744199048
    },
    {
        "content": "<p>Yes it is</p>",
        "id": 511149021,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1744199136
    },
    {
        "content": "<p>In a similar vein, I'm getting a <code>(kernel) application type mismatch</code> in an case where I'm using <code>aesop (add safe [(by omega)])</code></p>",
        "id": 511151615,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1744199874
    },
    {
        "content": "<p>Oh an <code>bv_decide</code> started leaving <code>.lrat</code> crumbs around</p>",
        "id": 511157135,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1744201312
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110789\">Jakob von Raumer</span> <a href=\"#narrow/stream/270676-lean4/topic/aesop.20and.20bv_decide/near/511151615\">said</a>:</p>\n<blockquote>\n<p>In a similar vein, I'm getting a <code>(kernel) application type mismatch</code> in an case where I'm using <code>aesop (add safe [(by omega)])</code></p>\n</blockquote>\n<p>There was previous discussion on this in <a class=\"stream\" data-stream-id=\"428973\" href=\"/#narrow/channel/428973-nightly-testing\">#nightly-testing</a>, putting omega in aesop doesn't currently work :(</p>",
        "id": 511625813,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744370586
    },
    {
        "content": "<p>What's the current status of this replay/Aesop issue? I assume it's about <code>replay</code> not picking up auxiliary declarations generated by tactics. Is there a plan to fix this or do I need to work around it in Aesop (which would probably entail going back to the previous hack)?</p>",
        "id": 512071598,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1744635093
    },
    {
        "content": "<p>I think you're the only user of <code>replay</code> at this point, besides <code>lean4checker</code>, so there's no plan to work on it (but conversely, if you want to propose changes that wouldn't break <code>lean4checker</code>, we can probably merge them).</p>",
        "id": 512080329,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744637374
    },
    {
        "content": "<p>Okay. I hope I'll find time to look into it soon. The current situation, where a bunch of tactics are just broken in Aesop, is very suboptimal.</p>",
        "id": 512081207,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1744637595
    },
    {
        "content": "<p>A MWE (i.e. calling replay directly) would also be helpful!</p>",
        "id": 512081770,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744637747
    },
    {
        "content": "<p><code>(by grind)</code> also causes errors <code>(kernel) constant has already been declared '_grind._proof_8'</code>, not sure if they're also because of <code>replay</code> or just due to <code>grind</code>s name generation</p>",
        "id": 512768744,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1744878704
    },
    {
        "content": "<p>Ah, that indeed is a separate issue that suggests Aesop needs to manage the mkAuxLemma state to prevent such duplicate names</p>",
        "id": 512769380,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744878896
    },
    {
        "content": "<p>I looked into this issue and the situation seems to be as follows (cc <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>):</p>\n<ul>\n<li><code>replay</code> is innocent (except for some possible latent bugs below).</li>\n<li>The issue is with <code>Term.mkAuxName</code>and <code>mkAuxLemma</code>. Both of these are used to register auxiliary constants that are then used in the main constructions of, e.g., <code>bv_decide</code>, <code>grind</code> and <code>omega</code>. The constants are generally named according to a scheme like <code>&lt;decl&gt;._proof_&lt;n&gt;</code>, where <code>&lt;decl&gt;</code> is the theorem we're currently proving and <code>n</code> is a counter that's used to ensure no name clashes.</li>\n<li>The auxiliary declarations are public (they can be referenced, e.g. with <code>#check &lt;decl&gt;._proof_&lt;n&gt;</code>), but unhygienic in the sense that their names are presumably considered unstable implementation details.</li>\n<li>In the context of Aesop, this is problematic because tactics can run in different branches of the search tree, so they don't see auxiliary declarations added by other tactics, leading to name clashes. E.g. one invocation of <code>omega</code> adds an auxiliary declaration <code>&lt;decl&gt;._proof_0</code>; another invocation of <code>omega</code> runs on a sibling branch and also adds <code>&lt;decl&gt;._proof_0</code>; once the branches are combined into the final proof, we get a name clash.</li>\n<li>This conceptual issue has been present basically forever, but is now surfacing because auxiliary declarations are increasingly used in core tactics.</li>\n</ul>\n<p>Possible solutions:</p>\n<ul>\n<li>Names of auxiliary lemmas become private and globally unique. This would anyway be better from a hygiene perspective, but maybe there are issues with this that I'm not seeing.</li>\n<li>The environment allows me to 'reserve' names that <code>Term.mkAuxName</code> will then consider used. This would allow me to reserve names that were added on sibling branches. However, branches would become coupled, blocking any future attempt to parallelise Aesop. (For <code>mkAuxLemma</code>, I should be able to implement this solution with the existing API.)</li>\n<li>The environment allows me to register a 'branch name' that becomes part of the auxiliary names generated by <code>Term.mkAuxName</code> and <code>mkAuxLemma</code>. So the generated name would be something like <code>&lt;decl&gt;._branch_&lt;m&gt;._proof_&lt;n&gt;</code>.</li>\n</ul>\n<p>Some possible latent bugs of <code>replay</code> that turned up during the investigation:</p>\n<ul>\n<li>In the Lean version I was looking at yesterday, setting the option <code>Lean.Elab.async := false</code> would prevent constants from showing up in <code>asyncConsts</code>, so <code>replay</code> would not pick them up. But this seems to have already changed on <code>master</code>.</li>\n<li><code>replayConsts</code> only supports definition and theorem constants. I guess this is fine for <code>leanchecker</code>, but for the Aesop use case there's no conceptual reason to prevent tactics from adding axioms or inductives.</li>\n</ul>",
        "id": 514775125,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1745835562
    },
    {
        "content": "<p>Oh so the kernel error was from aux theorems with colliding names?</p>",
        "id": 514791620,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745840667
    },
    {
        "content": "<p>Ah no, that seems to be a different bug. Investigating...</p>",
        "id": 514798537,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1745842650
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> the <code>bv_decide</code> error does seem to be related to <code>replay</code>. MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"replay\"</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"o\">:</span><span class=\"n\">tacticSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">initEnv</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">ts</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">  </span><span class=\"n\">setEnv</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">initEnv</span><span class=\"bp\">.</span><span class=\"n\">replayConsts</span><span class=\"w\"> </span><span class=\"n\">initEnv</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">core</span><span class=\"bp\">.</span><span class=\"n\">env</span>\n\n<span class=\"c1\">-- (kernel) unknown constant 'test._expr_def_1'</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">replay</span><span class=\"w\"> </span><span class=\"n\">bv_decide</span>\n</code></pre></div>",
        "id": 514826276,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1745849703
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> Thanks, that was helpful! <a href=\"https://github.com/leanprover-community/mathlib4/pull/8157\">#8157</a></p>",
        "id": 514895886,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745871178
    },
    {
        "content": "<p>Thank you! (<a href=\"https://github.com/leanprover/lean4/pull/8157\">lean4#8157</a>)</p>",
        "id": 514901796,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1745873530
    },
    {
        "content": "<p>Does the core team have an opinion on the suggested solutions for the name clash issue? My preference is no. 3 (or the radical no. 1). I can make an RFC and/or talk to Leo about it on Thursday.</p>",
        "id": 514902264,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1745873736
    },
    {
        "content": "<p>I'm assuming we'll want a <code>NameGenerator</code> but I haven't asked others yet</p>",
        "id": 514902457,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745873821
    }
]