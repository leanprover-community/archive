[
    {
        "content": "<p>On running the following mwe: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">HashSet</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">System</span>\n\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">processFileHeader</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">searchPathRef</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">compile_time_search_path</span><span class=\"bp\">%</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fileContent</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readFile</span><span class=\"w\"> </span><span class=\"n\">file</span>\n<span class=\"w\">  </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">fileContent</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">parseHeader</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">processHeader</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Other code to go here.</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\".lake/packages/mathlib/Mathlib/Algebra/AddConstMap/Basic.lean\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"s2\">\"{n}\"</span>\n<span class=\"w\">    </span><span class=\"n\">processFileHeader</span><span class=\"w\"> </span><span class=\"n\">file</span>\n</code></pre></div>\n<p>each step in the <code>for</code> loop in <code>main</code> leads to an increase in memory. It seems like the variables <code>env</code> and <code>messages</code> etc are held onto once the function <code>processFileHeader</code> is complete for each iteration. Is this the case? Is there a way to clear these variables to ensure they are not kept between iterations and memory doesn't explode.</p>\n<p>(The code in <code>processFileHeader</code> is based on code from <a href=\"https://github.com/lean-dojo/LeanDojo/blob/main/src/lean_dojo/data_extraction/ExtractData.lean\">here</a>)</p>",
        "id": 467198824,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1725357983
    },
    {
        "content": "<p>The memory still explodes with the more functional approach where <code>main</code> above is replaced with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\".lake/packages/mathlib/Mathlib/Algebra/AddConstMap/Basic.lean\"</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">processFileHeader</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 467261870,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1725371444
    },
    {
        "content": "<p><code>env</code> does not get free-d because it contains <code>mmap</code>-ed data. So in order to free <code>env</code> you need to free all of <code>env</code> at once. However that requires that not a single reference into <code>env</code> exists anymore which is an invariant that you have to ensure. There is unsafe functions like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.withImportModules#doc\">docs#Lean.withImportModules</a> that do free the environment they create and are safe to call under the assumption that no references to objects in env exist anymore. You can imitate what they are doing under the hood to free and env if you want.</p>",
        "id": 467263669,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725371887
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> ! Until I understand exactly how to do this, I'm going to follow the same workaround as  <a href=\"https://github.com/lean-dojo/LeanDojo/blob/main/src/lean_dojo/data_extraction/ExtractData.lean\">here</a>, which is to use <code>IO.Process.run</code> to call another file containing <code>processFileHeader </code>.</p>",
        "id": 467334537,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1725388523
    }
]