[
    {
        "content": "<p>I am implementing the <a href=\"https://en.wikipedia.org/wiki/Gale%E2%80%93Shapley_algorithm\">Gale-Shapley</a> in Lean. My code will need to handle real data. One of the inputs has 18430 candidates and 43 posts, resulting in 792490 potential interactions.  I am getting  <code>Stack overflow detected. Aborting.</code> in the command line after building and executing it with <code>lake exec</code>.</p>\n<p>I am using <code>StateM</code> monad, can it be the problem? Is there any limitation in the <code>StateM</code>? I am running on MacOS, with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">ulimit</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">s</span>\n<span class=\"mi\">65520</span>\n</code></pre></div>",
        "id": 526699486,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751415092
    },
    {
        "content": "<p><a href=\"#narrow/channel/270676-lean4/topic/stack.20overflow.20with.20StateM/near/526699486\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/stack.20overflow/with/286821520\">#lean4 &gt; stack overflow</a> by <span class=\"user-mention silent\" data-user-id=\"121542\">Alexandre Rademaker</span>.</p>",
        "id": 526699528,
        "sender_full_name": "Notification Bot",
        "timestamp": 1751415125
    },
    {
        "content": "<p>Can you share an example?</p>",
        "id": 526703114,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751418082
    },
    {
        "content": "<p>It will be hard to reduce to a MWE.. but I will share the link …</p>",
        "id": 526703436,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751418335
    },
    {
        "content": "<p><a href=\"https://gist.github.com/arademaker/67982be24c455756ecd43d4b21817e5b\">https://gist.github.com/arademaker/67982be24c455756ecd43d4b21817e5b</a></p>",
        "id": 526703895,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751418682
    },
    {
        "content": "<p>The way I call the function is </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"s2\">\"Usage: lake cpnu NUM\"</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildInstance</span><span class=\"w\"> </span><span class=\"s2\">\"/Users/ar/r/cpnu/2025.2/dados\"</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">toNat!</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"candidates x posts: {cs.size} x {ps.size} = {cs.size * ps.size}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">galeShapley</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">initialState</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">assignments</span><span class=\"bp\">.</span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Assignments: {k} =&gt; {m.2.assignments[k]?}\"</span>\n</code></pre></div>",
        "id": 526704508,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751419163
    },
    {
        "content": "<p>I would be interested in any ideas about how to debug the code. How can I add some extra flags to understand the functional call stack that is causing the stack overflow?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">candidate</span><span class=\"w\"> </span><span class=\"mi\">281972</span><span class=\"w\"> </span><span class=\"n\">selected</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"mi\">1586</span><span class=\"w\"> </span><span class=\"n\">free</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Aborting</span><span class=\"bp\">.</span>\n<span class=\"n\">zsh</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">abort</span><span class=\"w\">      </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">cpnu</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n</code></pre></div>\n<p>This happened almost at the end of the loop...  But the next dataset can be 40% bigger.</p>",
        "id": 526816711,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751466820
    },
    {
        "content": "<p>Does <code>gdb</code> help?</p>",
        "id": 526821884,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751468282
    },
    {
        "content": "<p>It might also be worth experimenting with <code>abbrev GS := StateRefT MatchState IO</code>, just to get it to run.</p>\n<p>It'd be nice to understand what's causing the stack overflow with StateM though.</p>",
        "id": 526829817,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751470319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> how to flag the <code>lake build</code> to add <code>-g</code> in the compilation? I suppose this would be my first question for trying to use <code>gdb</code>. Debugging at the C level will probably be more complex, but I am willing to try anything to solve the problem.</p>",
        "id": 526833402,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751471448
    },
    {
        "content": "<p>You can put <code>moreLeancArgs = [\"-g\"]</code> into your lakefile (if I read the code correctly)</p>",
        "id": 526834725,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751471838
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> ... I will try, but I need to understand StateRefT first.</p>",
        "id": 526835498,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751472087
    },
    {
        "content": "<p>I expect you won't need to change very much. It just changes the underlying implementation of how the state is threaded through the computation, though while also making your code be in the IO monad rather than be pure.</p>",
        "id": 526838866,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751473162
    },
    {
        "content": "<p>Yep. no need to make changes, but I ended up with the same problem... <code>Stack overflow detected. Aborting.</code></p>",
        "id": 526887994,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1751494982
    }
]