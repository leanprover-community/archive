[
    {
        "content": "<p>Hello everyone,</p>\n<p>I'm working on a project that uses Lean to call into a Rust library via FFI. I'm having trouble with passing file paths from Lean to Rust.</p>\n<p>My setup:</p>\n<p>In Lean </p>\n<p>(<code>FFI.Lean</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">SMTParser</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"test_ffi\"</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">testFFI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"parse_smt_file\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">parseSMTFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">SMTParser</span>\n</code></pre></div>\n<p>(<code>Main.Lean</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Please provide an SMT file path\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">filename</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Processing SMT file: {filename}\"</span>\n<span class=\"w\">    </span><span class=\"n\">SMTParser</span><span class=\"bp\">.</span><span class=\"n\">processSMTFile</span><span class=\"w\"> </span><span class=\"n\">filename</span>\n</code></pre></div>\n<p>In Rust<br>\n(<code>lib.rs</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">unsafe</span><span class=\"o\">(</span><span class=\"n\">no_mangle</span><span class=\"o\">)]</span>\n<span class=\"n\">pub</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"n\">parse_smt_file</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">path</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">c_char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">u32</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">path</span><span class=\"bp\">.</span><span class=\"n\">is_null</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">eprintln!</span><span class=\"o\">(</span><span class=\"s2\">\"Received null pointer for path\"</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">    </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">Convert</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Rust</span><span class=\"w\"> </span><span class=\"n\">string</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">path_str</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">CStr</span><span class=\"bp\">::</span><span class=\"n\">from_ptr</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">path</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">to_str</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">            </span><span class=\"n\">Ok</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span>\n<span class=\"w\">            </span><span class=\"n\">Err</span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">                </span><span class=\"n\">eprintln!</span><span class=\"o\">(</span><span class=\"s2\">\"Error converting path: {}\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">                </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"o\">},</span>\n<span class=\"w\">        </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">}</span><span class=\"bp\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">eprintln!</span><span class=\"o\">(</span><span class=\"s2\">\"Reading file: '{}'\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">path_str</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n\n<span class=\"w\">    </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">Read</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">file</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">fs</span><span class=\"bp\">::</span><span class=\"n\">read_to_string</span><span class=\"o\">(</span><span class=\"n\">path_str</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">Ok</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">Err</span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">            </span><span class=\"n\">eprintln!</span><span class=\"o\">(</span><span class=\"s2\">\"Error reading file: {}\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">}</span><span class=\"bp\">;</span>\n\n<span class=\"w\">    </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">Rest</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"bp\">...</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>When I pass a file path from Lean to Rust, the string doesn't seem to be properly marshalled. The Rust side can't correctly interpret the string pointer that Lean is passing.</p>\n<p>A simple numeric FFI test works fine (<code>test_ffi</code> function that doubles an integer), but string passing is failing.</p>\n<p>Does anyone know how can we properly pass a Lean String as a C-compatible string through Rust's FFI?</p>",
        "id": 529360980,
        "sender_full_name": "Daneshvar Amrollahi",
        "timestamp": 1752789002
    },
    {
        "content": "<p>This is how Lean strings are stored in memory:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"c1\">// from lean.h</span>\n<span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"n\">m_header</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\">      </span><span class=\"n\">m_size</span><span class=\"p\">;</span><span class=\"w\">     </span><span class=\"cm\">/* byte length including '\\0' terminator */</span>\n<span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\">      </span><span class=\"n\">m_capacity</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kt\">size_t</span><span class=\"w\">      </span><span class=\"n\">m_length</span><span class=\"p\">;</span><span class=\"w\">   </span><span class=\"cm\">/* UTF8 length */</span>\n<span class=\"w\">    </span><span class=\"kt\">char</span><span class=\"w\">        </span><span class=\"n\">m_data</span><span class=\"p\">[];</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">lean_string_object</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>So you either have to intercept the call in C and pass <code>ptr-&gt;m_data</code> to Rust or you need to mimic that precise memory layout in Rust in order to access the <code>m_data</code> attribute</p>",
        "id": 529370145,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1752795300
    },
    {
        "content": "<p>Or, if you're feeling brave, add <code>32</code> to your pointer and read from there. It's the size of a <code>lean_object</code> (8 bytes) and three <code>size_t</code>s (8 bytes each on a 64bit machine).</p>",
        "id": 529370636,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1752795655
    },
    {
        "content": "<p>If you choose to mimic the memory layout in Rust, make sure to tag your <code>LeanStringObject</code> struct with <code>#[repr(C)]</code>!</p>",
        "id": 529371699,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1752796672
    },
    {
        "content": "<p>Thanks Arthur. I managed to do it by mimicing the struct in my Rust code. <br>\nBut it seems like a very fragile solution. For instance if the String object for Lean changes for some reason in the future updates, this would break. Is there a more clean solution for this?</p>",
        "id": 529372808,
        "sender_full_name": "Daneshvar Amrollahi",
        "timestamp": 1752797463
    },
    {
        "content": "<p>These basic structs from <code>lean.h</code> are pretty stable already. But passing <code>ptr-&gt;m_data</code> (or, even better, <code>lean_string_cstr(ptr)</code>) from C to Rust is more stable because in the worst case you'd get a compilation error from your C code. The price of this solution is that your build becomes a bit messier, mixing up C and Rust.</p>",
        "id": 529373154,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1752797841
    },
    {
        "content": "<p>But keep in mind that FFI is fundamentally unsafe, so it's always gonna feel a bit itchy.</p>",
        "id": 529373354,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1752798018
    }
]