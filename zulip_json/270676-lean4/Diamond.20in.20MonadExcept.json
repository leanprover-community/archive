[
    {
        "content": "<p>I came across a diamond in core for <code>MonadExcept Exception TacticM</code>. I'm happy to work around it in my current application, and i don't expect anything to be done, but I just wanted to make sure that this is mentioned somewhere.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadExcept</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- Fails</span>\n</code></pre></div>",
        "id": 512588509,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1744818857
    },
    {
        "content": "<p>I came across this because I had some functions that assumed <code>MonadExcept E M</code>, and a function later on that assumed <code>MonadError M</code>. Now, <code>MonadError M</code> implies <code>MonadExceptOf Exception M</code> which implies <code>MonadExcept Exception M</code>, so I ended up with two nondefeq instances when I tried to apply things to <code>M = TacticM</code>.</p>",
        "id": 512588895,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1744818959
    },
    {
        "content": "<p>Concerningly this means you can get the wrong <code>catch</code> behavior:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadExcept</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">instMonadExceptExceptionTacticM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">throwThe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">congr</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- Fails</span>\n</code></pre></div>",
        "id": 512594441,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744820396
    },
    {
        "content": "<p>A lot of annoying unfolding gets you to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadExcept</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">instMonadExceptExceptionTacticM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">instMonadExceptOf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">throwThe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">StateRefT'</span><span class=\"bp\">.</span><span class=\"n\">instMonadExceptOf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">instMonadLiftTOfMonadLift</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">instMonadLift</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instMonadExceptOfExceptionCoreM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">tryCatchRestore</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">tryCatchRestore</span><span class=\"w\"> </span><span class=\"n\">instMonadExceptOfMonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">instMonadExceptOf</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span><span class=\"w\"> </span><span class=\"n\">StateRefT'</span><span class=\"bp\">.</span><span class=\"n\">instMonadExceptOf</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instMonadExceptOfExceptionCoreM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">tryCatchRestore</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">tryCatchThe</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instMonadExceptOfExceptionCoreM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">tryCatchRestore</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  ⊢ { throw := fun {α} =&gt; throwThe Exception,</span>\n<span class=\"sd\">    tryCatch := fun {α} x h =&gt; do</span>\n<span class=\"sd\">      let b ← saveState</span>\n<span class=\"sd\">      fun r s r_1 s_1 r_2 s_2 =&gt;</span>\n<span class=\"sd\">        Core.tryCatch (x r s r_1 s_1 r_2 s_2) fun e =&gt; (b.restore &gt;&gt;= fun x =&gt; h e) r s r_1 s_1 r_2 s_2 } =</span>\n<span class=\"sd\">  { throw := fun {α} =&gt; throwThe Exception,</span>\n<span class=\"sd\">    tryCatch := fun {α} x handle r s r_1 s_1 r_2 s_2 =&gt;</span>\n<span class=\"sd\">      Core.tryCatch (x r s r_1 s_1 r_2 s_2) fun e =&gt; handle e r s r_1 s_1 r_2 s_2 }</span>\n<span class=\"sd\">  -/</span>\n</code></pre></div>",
        "id": 512595718,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744820759
    },
    {
        "content": "<p>So if you write <code>[MonadExcept Exception m]</code> then <code>catch</code> means \"restore the state on failure\", but if you write <code>[MonadExceptOf Exception m]</code> then it doesn't</p>",
        "id": 512595907,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744820815
    }
]