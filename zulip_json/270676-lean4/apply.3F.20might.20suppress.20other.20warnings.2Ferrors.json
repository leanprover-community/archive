[
    {
        "content": "<p>In Lean v4.9.0, the following</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">TypeStar</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">apply?</span>\n</code></pre></div>\n<p>shouldn't work. It should raise an error <code>invalid occurrence of universe level 'u_1' at 'f', it does not occur at the declaration type, nor it is explicit universe level provided by the user, occurring at expression</code>, because there is no universe parameter to <code>f</code>. In fact, I think this error is indeed reached, and <code>f</code> isn't even added to the environment. However, this error interacts weirdly with <code>apply?</code>, and <code>apply?</code> seems to have suppressed the error (and its own warning <code>declaration uses 'sorry'</code>).</p>\n<p>But:</p>\n<ul>\n<li>In VS Code, there are no errors or warnings in InfoView. The error/warning counter on the bottom-left is 0/0.</li>\n<li><code>lake build --wfail</code> succeeds with code 0 (so CI passes).</li>\n<li><code>lake env /path/to/lean4checker@4.9.0/.lake/build/bin/lean4checker False</code> returns code 0 (probably because <code>f</code> is not in the environment?).</li>\n</ul>\n<p>This is not the same issue as, but is related to, <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/.23print.20axioms.20does.20not.20report.20sorry/with/515566581\">#lean4 &gt; #print axioms does not report sorry</a>, in that <code>apply?</code> suppresses all warnings and errors, when the particular error in the linked thread occurs.</p>\n<p>This is also not the same issue as the 500 limit of squiggly lines in VS Code. Note that <code>apply?</code> on <code>False</code> gives only 23 suggestions here.</p>\n<p>All in all, on the surface this really really looks convincing, though of course it is not a \"real\" issue because <code>f</code> is not added.</p>\n<p>Reproduce the error: <a href=\"https://github.com/hanwenzhu/lean-demo-20250502\">https://github.com/hanwenzhu/lean-demo-20250502</a></p>\n<p><a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>: this is minimized from 3 of DeepSeek-Prover-V2's (wrong) solutions, where the prover apparently exploited this issue. (DeepSeek would have caught this if they checked the theorem they wanted to prove is indeed in the environment after the proof.)</p>\n<p>I would really appreciate someone more familiar with Lean core to determine if this is a trivial thing or indeed a serious bug. Thank you!</p>",
        "id": 515641973,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746164119
    },
    {
        "content": "<p>Why are you using v4.9.0? Everyone in the public sphere has moved on from it</p>",
        "id": 515642164,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1746164271
    },
    {
        "content": "<ol>\n<li>As far as I know this issue was not reported before, so without knowing what caused the error, a variant of the MWE might work on newest Lean. This particular example doesn't. (and I really hope that this issue was somehow fixed between 4.9.0 to 4.19.0, but I need a much more knowledgeable person to help confirm this)</li>\n<li>DeepSeek-Prover-V2 used v4.9.0, and wrongly claimed they proved some theorems, because of this issue.</li>\n</ol>",
        "id": 515642421,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746164435
    },
    {
        "content": "<p>Here's a slightly better minimization, which doesn't need Mathlib, and clearly shows both that no error message appeared on <code>v4.9.0</code>, but that no proof of <code>False</code> was ever added to the environment:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Uh oh, no error messages generated on this apparent proof of `False`.</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">apply?</span>\n\n<span class=\"c1\">-- It's not so bad: it was never added to the environment, so you can't do anything with it.</span>\n<span class=\"sd\">/-- error: unknown identifier 'f' -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n<p>As of <code>v4.13.0</code>, error messages are generated as expected.</p>",
        "id": 515682038,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746181097
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"631691\">Thomas Zhu</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20v4.2E9.2E0.3A.20apply.3F.20might.20suppress.20other.20warnings.2Ferrors/near/515641973\">said</a>:</p>\n<blockquote>\n<p>I would really appreciate someone more familiar with Lean core to determine if this is a trivial thing or indeed a serious bug. Thank you!</p>\n</blockquote>\n<p>This is a user interface bug (dropped error message), that was present up to <code>v4.12.0</code>, but not a soundness bug, because you could not use the apparent proof of <code>False</code> to do anything else.</p>\n<p>It was certainly a bad user interface bug --- because a piece of text that apparently proves <code>False</code> was accepted!</p>\n<p>But it is the sort of thing that any AI pipeline or autograder for students should take responsibility for: verify that the declaration you're claiming to prove is actually in the environment.</p>\n<p>As a point of comparison, one could easily write a macro that overrides the <code>theorem</code> syntax, turning it into a no-op. Then you can write <code>theorem false : False := trivial</code>, and have the file be accepted. Of course nothing will have been added to the environment!</p>",
        "id": 515682844,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746181402
    },
    {
        "content": "<p>I claim Lean needs to provide robust and easy-to-use auto-grading solutions.  Otherwise people will be lazy and not use them.  In Lean 4.9 what would have been the right solution to catch this?  (I thought it was lean4checker, but in that case that wasn’t enough, right?) How do we make the correct solution more well known?</p>",
        "id": 515683439,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746181638
    },
    {
        "content": "<p>(Actually maybe that should be its own topic so it is easy to find.)</p>",
        "id": 515683690,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746181727
    },
    {
        "content": "<p>For this topic, are their tests catching this user interface bug so it doesn’t happen again?</p>",
        "id": 515683924,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746181804
    },
    {
        "content": "<p>The standard autograder solution today is Rob Lewis' <a href=\"https://github.com/robertylewis/lean4-autograder-main\">https://github.com/robertylewis/lean4-autograder-main</a>. We should investigate whether this would have been sufficient for DeepSeek's needs!</p>",
        "id": 515684123,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746181888
    },
    {
        "content": "<p>There is a minimal example of setting up the autograder for circumstances like this at <a href=\"https://github.com/kim-em/autograder_false\">https://github.com/kim-em/autograder_false</a>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">kim</span><span class=\"bp\">-</span><span class=\"n\">em</span><span class=\"bp\">/</span><span class=\"n\">autograder_false</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">autograder_false</span>\n<span class=\"bp\">./</span><span class=\"n\">autograder</span><span class=\"bp\">.</span><span class=\"n\">sh</span>\n</code></pre></div>\n<p>should print the output</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Submission</span><span class=\"w\"> </span><span class=\"n\">compilation</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"o\">:</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">not_succ_le_zero</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">false_of_true_eq_false</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">false_of_ne</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ne_self_iff_false</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Ne</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">true_iff_false</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">false_iff_true</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iff_false_intro</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not_iff_false_intro</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">false_of_true_iff_false</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Ne</span><span class=\"bp\">.</span><span class=\"n\">irrefl</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">not_true</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">neZero_zero_iff_false</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">and_not_self_iff</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not_and_self_iff</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">eq_true_and_eq_false_self</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">eq_not_self</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_eq_self</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">eq_false_and_eq_true_self</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negSucc_not_nonneg</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negSucc_not_pos</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Omega</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">le_lt_asymm</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Omega</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">lt_le_asymm</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mem_nil_iff</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"n\">autograder</span><span class=\"bp\">/</span><span class=\"n\">submission</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"gr\">sorry</span><span class=\"bp\">'</span>\n\n\n<span class=\"n\">false</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">points</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Proof</span><span class=\"w\"> </span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 515690033,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746184270
    },
    {
        "content": "<p>Note that this autograder example is running on <code>v4.15.0</code>, where the declaration <em>is</em> being added, and the autograder is detecting the <code>sorry</code>.</p>\n<p>I haven't quite worked on what the invocation for <code>autograder</code> is back on a <code>v4.9.0</code> compatible version, but hopefully <span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span> will be able to help me with this. I'm pretty confident that once we work out how to invoke it the autograder will successfully notice that on <code>v4.9.0</code> the declaration was simply not added at all, and similarly \"fail the student\".</p>",
        "id": 515690327,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746184387
    },
    {
        "content": "<p>(If anyone wants to experiment in the meantime, you can:</p>\n<ul>\n<li>change the <code>lean-toolchain</code> in that repository to point to <code>v4.9.0</code></li>\n<li>change the <code>lakefile.toml</code>, to use a version of autograder compatible with v4.9.0 (see comment in the file)</li>\n<li>change the attribute from <code>autogradedProof</code> to <code>autograded</code> in <code>autograder/solutions.lean</code></li>\n<li>try to work out how to modify <code>autograder.sh</code> to make the old version run!)</li>\n</ul>",
        "id": 515690519,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746184466
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Lean.20v4.2E9.2E0.3A.20apply.3F.20might.20suppress.20other.20warnings.2Ferrors/near/515682844\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"631691\">Thomas Zhu</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20v4.2E9.2E0.3A.20apply.3F.20might.20suppress.20other.20warnings.2Ferrors/near/515641973\">said</a>:</p>\n<blockquote>\n<p>I would really appreciate someone more familiar with Lean core to determine if this is a trivial thing or indeed a serious bug. Thank you!</p>\n</blockquote>\n<p>This is a user interface bug (dropped error message), that was present up to <code>v4.12.0</code>, but not a soundness bug, because you could not use the apparent proof of <code>False</code> to do anything else.</p>\n</blockquote>\n<p>Was this UI bug known before? What happened during v4.13.0 that apparently fixed the bug? I think DeepSeek Prover (through very large scale random generations) found and then exploited this bug, because it tried to use Cardinal.ofNat which also triggers this bug. Of course the proof is wrong, but will it be fair for DeepSeek to now claim their model actually found and exploited a bug in Lean's UI?</p>",
        "id": 515711784,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746191781
    },
    {
        "content": "<p>Although we now know from an author that they used the REPL (see the DeepSeek-Prover v2 thread), so even if the AI could have explointed the UI, in practice it only exploited the REPL.  (Of course it isn’t fully clear yet, what they should have done, and what all AI researchers going forward, should do to catch this stuff.)</p>",
        "id": 515713322,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746192249
    },
    {
        "content": "<p>But the root cause of exploiting the REPL is just this Lean UI bug that doesn't have anything to do with REPL</p>",
        "id": 515718417,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746193714
    },
    {
        "content": "<p>I like the idea of using Rob's autograder, if it actually catches the error above. The repo <a href=\"https://github.com/BrownCS1951x/fpv2024\">https://github.com/BrownCS1951x/fpv2024</a> uses autograder @ bac0a6c9b83279e903d89c56621dbe89fd2b27f3 on Lean v4.10.0, and someone should test this setup against the bug above (I don't have time currently to do that)</p>",
        "id": 515719472,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746194005
    },
    {
        "content": "<p>Good point!  (Personally I feel this issue deserves a full post mordem paper.  I don’t think many of us suspected that by using standard tactics inside a proof that such a weird UI bug could happen that would cause so many of the standard ways to check a Lean proof for errors to fail, even if it was just for dumb reasons like that the theorem wasn’t added to the environment and none of the standard methods check for that.)</p>",
        "id": 515719955,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746194140
    },
    {
        "content": "<p>I agree---I appreciate that from the point of view of the kernel, this error is not really different from a person maliciously changing the elaboration of \"theorem\" command to a no-op, but on the surface level it really looks like an innocuous proof that passes CI testing (for example see this non-proof: <a href=\"https://github.com/hanwenzhu/lean-demo-20250502/blob/main/putnam_2005_a4.lean\">https://github.com/hanwenzhu/lean-demo-20250502/blob/main/putnam_2005_a4.lean</a>).</p>",
        "id": 515720638,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746194326
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20v4.2E9.2E0.3A.20apply.3F.20might.20suppress.20other.20warnings.2Ferrors/near/515690519\">said</a>:</p>\n<blockquote>\n<p>(If anyone wants to experiment in the meantime, you can:</p>\n<ul>\n<li>change the <code>lean-toolchain</code> in that repository to point to <code>v4.9.0</code></li>\n<li>change the <code>lakefile.toml</code>, to use a version of autograder compatible with v4.9.0 (see comment in the file)</li>\n<li>change the attribute from <code>autogradedProof</code> to <code>autograded</code> in <code>autograder/solutions.lean</code></li>\n<li>try to work out how to modify <code>autograder.sh</code> to make the old version run!)</li>\n</ul>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> </p>\n<p>The v4.10 autograder also compiles in v4.9, but it's pretty hard-coded to the Gradescope directory layout. Since then we've generalized a lot. I quickly hacked up v4.10 to match the layout of your repo instead (without touching any of the actual checking code). <a href=\"https://github.com/robertylewis/autograder_false\">https://github.com/robertylewis/autograder_false</a> is your repo, depending on this hacked version. You can run it with <code>lake exe autograder</code> and indeed see that it flags the <code>sorry</code> in this proof.</p>",
        "id": 515730228,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1746196859
    },
    {
        "content": "<p>There's a 50% chance I've flipped the \"assignment\" and \"solution\" but it doesn't matter for this example. One of them is the reference file from the \"instructor\" and one is the \"student\" file being checked. But here they're identical, hardcoded to be <code>autograder/{Assignment, Solution}.lean</code></p>",
        "id": 515731000,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1746197059
    },
    {
        "content": "<p>Fantastic, thank you Rob.</p>",
        "id": 515736798,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746198595
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span> I think there is a mistake in your repos: the line should be <code>have := Type _</code>, not <code>have := Type</code></p>",
        "id": 515742271,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746200267
    },
    {
        "content": "<p>Yes, fixed now.</p>",
        "id": 515742711,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746200395
    },
    {
        "content": "<p>(Note that on later versions <code>have := Type _</code> is not even allowed.)</p>",
        "id": 515742797,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746200410
    },
    {
        "content": "<p>Okay, here are the clean examples:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">kim</span><span class=\"bp\">-</span><span class=\"n\">em</span><span class=\"bp\">/</span><span class=\"n\">autograder_false</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">autograder_false</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"bp\">./</span><span class=\"n\">autograder</span><span class=\"bp\">.</span><span class=\"n\">sh</span><span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">reports</span><span class=\"w\"> </span><span class=\"s2\">\"Proof contains sorry\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"bp\">./</span><span class=\"n\">autograder</span><span class=\"bp\">.</span><span class=\"n\">sh</span><span class=\"w\">   </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">reports</span><span class=\"w\"> </span><span class=\"s2\">\"Declaration not found in submission\"</span>\n</code></pre></div>",
        "id": 515743226,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746200555
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span>  I did not anticipate you grading the robots. This is great!</p>",
        "id": 515793499,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746218024
    },
    {
        "content": "<p>Neither did I! I hope our autograder is up for it.</p>",
        "id": 515795108,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1746218640
    },
    {
        "content": "<p>We were already planning to make a lot of improvements this summer. If there are requests from the robot operators that don't conflict with its main purpose (grading non-robots), please let me know.</p>",
        "id": 515795283,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1746218701
    },
    {
        "content": "<p>The exact mechanism of the error is very simple: it is a synthetic sorry that also doesn't log an error. The following also doesn't report any errors (v4.9.0):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">sorryAx</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">synthetic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>\n<p><code>apply?</code> <a href=\"https://github.com/leanprover/lean4/blob/14d647f2198a1c1d273c105386fe8b1457c01c3c/src/Lean/Elab/Tactic/LibrarySearch.lean#L51\">calls</a> the function <code>admitGoal</code> without logging errors, breaking the invariant that creators of synthetic sorries should log errors first.</p>\n<p>There should have been a big warning in the docstring of <code>admitGoal</code> to say the sorryAx is synthetic in v4.9.0, and direct users to <code>Term.reportUnsolvedGoals</code> or <code>closeUsingOrAdmit</code> instead.</p>\n<p>Then elaboration of the theorem tries to throw the expected error of universe parameter <a href=\"https://github.com/leanprover/lean4/blob/v4.9.0/src/Lean/Elab/MutualDef.lean#L881\">here</a>. This error is not actually thrown, because the message data body contains a synthetic sorry. This still stops elaboration: within <code>Term.elabMutualDef</code> (see v4.9.0 source), <code>checkForHiddenUnivLevels</code> raises this error, so the next step <code>addPreDefinitions</code> (which calls <code>addDecl</code>, which would have raised warning <code>declaration uses 'sorry'</code>) is not reached.</p>\n<p>(Edit: added details)</p>",
        "id": 515803860,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746222415
    },
    {
        "content": "<p><del>There was probably something in v4.13.0 update that changed some of the parts above. Perhaps there was a similar known issue that led to this. However, I don't have time currently to go through the git blame</del> (see below)</p>",
        "id": 515805316,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746223188
    },
    {
        "content": "<p>I can't get the <code>theorem f</code> to print a warning even with a natural <code>sorry</code></p>",
        "id": 515805527,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746223261
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20v4.2E9.2E0.3A.20apply.3F.20might.20suppress.20other.20warnings.2Ferrors/near/515805527\">said</a>:</p>\n<blockquote>\n<p>I can't get the <code>theorem f</code> to print a warning even with a natural <code>sorry</code></p>\n</blockquote>\n<p>Do you have a working example? Changing <code>true</code> to <code>false</code> in the above makes the error pop up.</p>",
        "id": 515825977,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746235280
    },
    {
        "content": "<p>Maybe it's the version I'm on</p>",
        "id": 515830326,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746237938
    },
    {
        "content": "<p>I finally had some time to dig through the code changes. The exact commit that fixed this error was <a href=\"https://github.com/leanprover/lean4/pull/5402\">lean4#5402</a>, which deferred the <code>checkForHiddenUnivLevels</code> logic (hidden levels check) to later, and also added some error recovery mechanisms, and this allowed elaboration to continue even if the \"hidden levels\" error is present, so <code>f</code> is finally added, and the warning <code>declaration uses 'sorry'</code> is reached.</p>",
        "id": 515845225,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746247197
    },
    {
        "content": "<p>I found a version of this error that still exists on Lean stable &amp; nightly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply?</span>\n<span class=\"w\">  </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span>\n</code></pre></div>\n<p>Expected: error <code>invalid use of 'partial', 'g' is not a function</code> and warning <code>declaration uses 'sorry'</code><br>\nActual: no errors, no warnings</p>",
        "id": 515849041,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746249040
    },
    {
        "content": "<p>Since it is clear now it is not just a Lean ≤ v4.12.0 issue, I created <a href=\"https://github.com/leanprover/lean4/pull/8212\">lean#8212</a>. Also changed the title of this topic.</p>",
        "id": 515851766,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1746250679
    },
    {
        "content": "<p>This is now fixed in <a href=\"https://github.com/leanprover/lean4/pull/8231\">lean#8231</a>, which should shortly arrive as part of <code>v4.20.0-rc3</code>.</p>",
        "id": 516258254,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746465772
    }
]