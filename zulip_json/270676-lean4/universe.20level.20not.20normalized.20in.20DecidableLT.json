[
    {
        "content": "<p>When working on the <code>@[to_dual]</code> attribute, I ran into the problem that <code>DecidableLT</code> has type <code>Sort (max 1 (u+1))</code>. The way it gets pretty printed varies:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"c1\">-- DecidableLT.{u} (α : Type u) [LT α] : Type u</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">DecidableLT</span>\n\n<span class=\"c1\">-- (α : Type u) → [inst : LT α] → Type (max 0 u)</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"w\"> </span><span class=\"s2\">\"{(← getConstInfo ``DecidableLT).type}\"</span>\n</code></pre></div>\n<p>This is an issue because I want to define the dual <code>DecidableGT</code>/<code>DecidableLT'</code>, but that one does live in the expected <code>Type u</code>.</p>\n<p>I wrote a program to find more occurences of this</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>import Batteries<br>\nopen Lean Meta<br>\nunsafe def findUnivs (e : Expr) : CoreM Unit :=<br>\n  let rec visitUnivs (u : Level) : CoreM Unit := do<br>\n    match u with<br>\n    | .max (.succ .zero) (.succ u)<br>\n    | .max (.succ u) (.succ .zero) =&gt; throwError \"{u}\"<br>\n    | .max u v<br>\n    | .imax u v =&gt; visitUnivs u; visitUnivs v<br>\n    | .succ u =&gt; visitUnivs u<br>\n    | _ =&gt; return<br>\n  let rec visit (e : Expr) : (StateT (PtrSet Expr) CoreM) Unit := do<br>\n    if (← get).contains e then<br>\n      return<br>\n    else<br>\n      match e with<br>\n      | .app f a         =&gt; visit f; visit a<br>\n      | .mdata _ b       =&gt; visit b<br>\n      | .proj _ _ b      =&gt; visit b<br>\n      | .letE _ t v b _  =&gt; visit t; visit v; visit b<br>\n      | .lam _ d b _     =&gt; visit d; visit b<br>\n      | .forallE _ d b _ =&gt; visit d; visit b<br>\n      | .const _ us      =&gt; liftM &lt;| us.forM visitUnivs<br>\n      | .sort u          =&gt; liftM (visitUnivs u)<br>\n      | _                =&gt; return<br>\n  visit e |&gt;.run' mkPtrSet<br>\n@[noinline]<br>\ndef foo := unsafe findUnivs<br>\nnamespace Batteries.Tactic.Lint<br>\n/-- A linter for commutativity lemmas that are marked simp. -/<br>\n@[env_linter]<br>\ndef myLinter : Linter where<br>\n  noErrorsFound := \"No error found\"<br>\n  errorsFound := \"Error found\"<br>\n  test := fun declName =&gt; do<br>\n    let cinfo ← getConstInfo declName<br>\n    let type := cinfo.type<br>\n    _ ← unsafe findUnivs type<br>\n    return none<br>\nend Batteries.Tactic.Lint<br>\nuniverse u<br>\nabbrev DecidableLT' (α : Type u) [LT α] := DecidableRel (<a href=\"http://LT.lt\">LT.lt</a> : α → α → Prop)<br>\n#lint only myLinter in all</p>\n</div></div>\n<p>And here are the bad declarations it found in Lean/Batteries:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Batteries.Data.BinomialHeap.Basic</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">BinomialHeap</span>\n\n<span class=\"c1\">-- Batteries.Data.PairingHeap</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">PairingHeap</span>\n\n<span class=\"c1\">-- Init.Core</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">instDecidableEq</span>\n\n<span class=\"c1\">-- Init.Data.Array.Lemmas</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">swapAt!</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span>\n\n<span class=\"c1\">-- Init.Data.Array.QSort</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">qpartition</span><span class=\"bp\">.</span><span class=\"n\">loop</span><span class=\"bp\">.</span><span class=\"n\">eq_def</span><span class=\"bp\">✝</span>\n\n<span class=\"c1\">-- Init.Data.Vector.Lemmas</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">insertIdx!</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">eraseIdx!</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span>\n\n<span class=\"c1\">-- Init.Prelude</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">DecidableLT</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">DecidableLE</span>\n\n<span class=\"c1\">-- Init.WF</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PSigma</span><span class=\"bp\">.</span><span class=\"n\">skipLeft</span>\n\n<span class=\"c1\">-- Lean.Data.HashSet</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">HashSetBucket</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">HashSet</span>\n\n<span class=\"c1\">-- Lean.Data.SSet</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">SSet</span>\n</code></pre></div>",
        "id": 514543287,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745677139
    },
    {
        "content": "<p>Just to take <code>#check</code> out of the picture, <code>inferType</code> also reports the \"clean\" universe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"c1\">-- (α : Type u) → [inst : LT α] → Type u</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"ss\">`u</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">DecidableLT</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{← Meta.inferType e}\"</span>\n</code></pre></div>",
        "id": 514545271,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745678432
    }
]