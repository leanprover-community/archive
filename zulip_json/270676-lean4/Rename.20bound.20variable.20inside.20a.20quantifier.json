[
    {
        "content": "<p>I proved divergence of an identity sequence as an exercise, and there's one thing bothering me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"c1\">-- ¬¨‚àÉ a, ‚àÄ Œµ &gt; 0, ‚àÉ N, ‚àÄ n ‚â• N, |(fun x =&gt; ‚Üëx) n - a| &lt; Œµ</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ‚àÄ (x : ‚Ñù), ‚àÉ x_1, 0 &lt; x_1 ‚àß ‚àÄ (x_2 : ‚Ñï), ‚àÉ x_3, x_2 ‚â§ x_3 ‚àß x_1 ‚â§ |‚Üëx_3 - x|</span>\n</code></pre></div>\n<p><code>simp</code> here loses the original names and introduces new <code>x x_1 x_2 x_3</code>, and so does <code>push_neg</code>. Is it possible to keep the original names?</p>",
        "id": 553286895,
        "sender_full_name": "tau",
        "timestamp": 1762131102
    },
    {
        "content": "<p>simp just applies the lemmas, and for example the lemma for the first step involves:<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/PropLemmas.html#not_exists\">not_exists</a> : <code>(¬¨‚àÉ (x : Œ±), p x) ‚Üî ‚àÄ (x : Œ±), ¬¨p x</code><br>\nand simp just sees this and thinks, I see the LHS in the current expression, so I replace it with the RHS</p>\n<p>it wouldn't be a good thing to have simp additionally think \"I see a bounded variable in the LHS and also the RHS so I should keep the name\" because in a general theorem, the bounded variables don't have to be related at all</p>",
        "id": 553287108,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762131278
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553287108\">said</a>:</p>\n<blockquote>\n<p>simp just applies the lemmas, and for example the lemma for the first step involves:<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/PropLemmas.html#not_exists\">not_exists</a> : <code>(¬¨‚àÉ (x : Œ±), p x) ‚Üî ‚àÄ (x : Œ±), ¬¨p x</code><br>\nand simp just sees this and thinks, I see the LHS in the current expression, so I replace it with the RHS</p>\n</blockquote>\n<p>Yeah, I figured out that much. Still, is it possible to change the names to the original names without retyping the whole goal?</p>",
        "id": 553287225,
        "sender_full_name": "tau",
        "timestamp": 1762131383
    },
    {
        "content": "<p>it is undoubtedly possible to have a specialised tactic to keep bvar names but then by being specialised its code is by definition not very maintainable, as if you go to the docstring for <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/Push.html#Mathlib.Tactic.Push.push_neg\">push_neg</a>, you see that it is a special case of the more general <code>push</code> tactic</p>",
        "id": 553287260,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762131413
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"692637\">tau</span> <a href=\"#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553287225\">said</a>:</p>\n<blockquote>\n<p>Still, is it possible to change the names to the original names without retyping the whole goal?</p>\n</blockquote>\n<p>it's possible to write a tactic to do that but I don't think I've seen it yet</p>",
        "id": 553287322,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762131472
    },
    {
        "content": "<p>oh wow, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/RenameBVar.html#Mathlib.Tactic.%C2%ABtacticRename_bvar_%E2%86%92__%C2%BB\">it exists!</a></p>",
        "id": 553287365,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762131505
    },
    {
        "content": "<p>but it has very few functionalities and it's literally <a href=\"https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4%20rename_bvar&amp;type=code\">never been used</a></p>",
        "id": 553287444,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762131561
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553287365\">said</a>:</p>\n<blockquote>\n<p>oh wow, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/RenameBVar.html#Mathlib.Tactic.%C2%ABtacticRename_bvar_%E2%86%92__%C2%BB\">it exists!</a></p>\n</blockquote>\n<p>Thanks! Unfortunately, it doesn't seem to work the way I expect: <code>rename_bvar x ‚Üí a</code> changes the goal to <code>‚àÄ (a : ‚Ñù), ‚àÉ a_1, 0 &lt; a_1 ‚àß ‚àÄ (a_2 : ‚Ñï), ‚àÉ a_3, a_2 ‚â§ a_3 ‚àß a_1 ‚â§ |‚Üëa_3 - a|</code>, and the other variables can't be renamed. From my understanding, these variables all have the same internal name as well as distinct indices to protect against clashing, and <code>rename_bvar</code> ignores these indices.</p>",
        "id": 553287764,
        "sender_full_name": "tau",
        "timestamp": 1762131862
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚àÉ</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚àÉ</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">a‚ÇÅ</span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"692637\">@tau</span> please include <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>",
        "id": 553287908,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762132011
    },
    {
        "content": "<p>ah I read your message again, yeah I guess this is what I meant by that it has very few functionalities and wasn't really tested much</p>",
        "id": 553287976,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762132085
    },
    {
        "content": "<p>for example, I would add a feature to be able to refer to the old variable by index</p>",
        "id": 553288007,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762132107
    },
    {
        "content": "<p>Sure, sorry.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isLimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"bp\">&gt;</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚àÉ</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚â•</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">Œµ</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">convergent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÉ</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">isLimit</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">divergent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">¬¨</span><span class=\"n\">convergent</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">Œª</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">divergent</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">divergent</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">convergent</span><span class=\"w\"> </span><span class=\"n\">isLimit</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ¬¨‚àÉ a, ‚àÄ Œµ &gt; 0, ‚àÉ N, ‚àÄ n ‚â• N, |(fun x =&gt; ‚Üëx) n - a| &lt; Œµ</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ‚àÄ (x : ‚Ñù), ‚àÉ x_1, 0 &lt; x_1 ‚àß ‚àÄ (x_2 : ‚Ñï), ‚àÉ x_3, x_2 ‚â§ x_3 ‚àß x_1 ‚â§ |‚Üëx_3 - x|</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"n\">a_1</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œµ</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 553288074,
        "sender_full_name": "tau",
        "timestamp": 1762132200
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553287108\">said</a>:</p>\n<blockquote>\n<p>it wouldn't be a good thing to have simp additionally think \"I see a bounded variable in the LHS and also the RHS so I should keep the name\" because in a general theorem, the bounded variables don't have to be related at all</p>\n</blockquote>\n<p>Wasn't there a gadget to tell <code>simp</code> which bounds variables on the lhs corresponding to which ones on the rhs?</p>",
        "id": 553297348,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762141767
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> this is a <em>huge</em> regression from <code>push_neg</code>. It was a core requirement of this tactic. Can you fix that in <code>push</code> very soon or should we revert that refactor to get back a working <code>push_neg</code>?</p>",
        "id": 553315326,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762155011
    },
    {
        "content": "<p>It‚Äôs crazy that we didn‚Äôt have unit tests catching this.</p>",
        "id": 553315923,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762155300
    },
    {
        "content": "<p>In some lemmas (e.g., rewriting sums), you definitely want to keep the names of bound variables. (Not all lemmas, as Kenny points out.) There's a lean gadget binderHint (or so, don't remember exactly) which helps here, but IIRC is hardly used in practice.</p>",
        "id": 553316103,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762155376
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> was working on this: what's the status of that feature? Would it be wise to go ahead and tag lots if mathlib with it.</p>",
        "id": 553316264,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762155451
    },
    {
        "content": "<p>This is completely independent from new features in Lean. There was a complete failure of the reviewing process which broke a crucial teaching tactic and we simply need to revert that commit if it‚Äôs complicated to fix.</p>",
        "id": 553320898,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762157377
    },
    {
        "content": "<p>Agreed; we are talking about two different issues here. I think both bear fixing, but regressions go first.</p>",
        "id": 553321233,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762157521
    },
    {
        "content": "<p>Do you have an example of the old push_neg syntax that is broken now/a pointer to one?</p>",
        "id": 553321336,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762157560
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553288074\">#lean4 &gt; Rename bound variable inside a quantifier @ üí¨</a>  is now a mwe.</p>",
        "id": 553321893,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762157770
    },
    {
        "content": "<p>You can see it in the playground (replace the <code>simp</code> with <code>push_neg</code>).</p>",
        "id": 553321940,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762157789
    },
    {
        "content": "<p>Should I create a GitHub issue for this?</p>",
        "id": 553322074,
        "sender_full_name": "tau",
        "timestamp": 1762157848
    },
    {
        "content": "<p>Thanks, but I hope it‚Äôs not necessary. We‚Äôll learn very soon whether there is an easy fix, and otherwise the commit which introduced the bug will be reverted within a few days.</p>",
        "id": 553322404,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762157980
    },
    {
        "content": "<p>There are two issues with our tests: They were supposed to use <code>guard_target =‚Çõ</code> instead of <code>guard_target =</code>. And there is a bug in the implementation of <code>guard_target =‚Çõ</code> so that it doesn't actually check that the binder names are the same (but the doc-string says that it does)</p>\n<p>In the meantime, here is a quickfix for the problem: <a href=\"https://github.com/leanprover-community/mathlib4/pull/31212\">#31212</a></p>",
        "id": 553330594,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762160805
    },
    {
        "content": "<p>Thanks a lot! Is there a way to test this, aside from locally (or waiting for the Lean bug to get fixed)?</p>",
        "id": 553330817,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762160880
    },
    {
        "content": "<p>I think that you are required to eta reduce the LHS of your simp lemma to guarantee that the <code>binderNameHint</code> works. In the lemma that I fixed, the <code>binderNameHint</code> does work in <code>rw</code>, but in <code>simp</code>, it picks up the name of the bound variable in the LHS of the lemma. A long while ago I tried to fix this discrepancy with <a href=\"https://github.com/leanprover/lean4/pull/8155\">lean#8155</a></p>",
        "id": 553331352,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762161076
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/270676-lean4/topic/Rename.20bound.20variable.20inside.20a.20quantifier/near/553330817\">said</a>:</p>\n<blockquote>\n<p>Thanks a lot! Is there a way to test this, aside from locally (or waiting for the Lean bug to get fixed)?</p>\n</blockquote>\n<p>I think that <code>#guard_msg</code>ing a logInfo of the goal would include the actual binder names.</p>",
        "id": 553331359,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762161081
    },
    {
        "content": "<p>Thanks, I've added a <code>#guard_msgs</code> test to the above PR</p>",
        "id": 553332234,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762161348
    },
    {
        "content": "<p>Thanks Jovan! I‚Äôm a bit worried that the fix seems so specific to <code>Exists</code>.</p>",
        "id": 553367631,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762172288
    },
    {
        "content": "<p>The only two cases where the name preservation is done in <code>push_neg</code> is for pushing through forall and exists. And the forall case is still special cased as it was before. It's only the exists case that is relying on the binderNameHint</p>",
        "id": 553391675,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762179425
    },
    {
        "content": "<p>Ok, I don‚Äôt remember how I did it in the Lean 3 version anyway.</p>",
        "id": 553398638,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762181057
    }
]