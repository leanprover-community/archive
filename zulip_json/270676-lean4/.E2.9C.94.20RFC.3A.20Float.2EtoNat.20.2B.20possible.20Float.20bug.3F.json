[
    {
        "content": "<p>Based on the discussions in \"new members\" and my attempts to write more \"generic\" numeric code (e.g.<br>\nhere <a href=\"#narrow/stream/113489-new-members/topic/Missing.20numeric.20conversion.20type.20classes.3F/near/472444189\">https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/Missing.20numeric.20conversion.20type.20classes.3F/near/472444189</a>) one outcome is that I noticed that there is no <code>Float.toNat</code> function in lean.  It's possible to write e.g. <code>ff.toUint64.toNat</code> as a workaround.</p>\n<p>Would the Lean developers be open to a PR that implements as a C++ extern with similar semantics to the above?  Here are the proposed semantics:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mf\">2.71828</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nan</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">inf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"n\">nan</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">inf</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fToNat</span><span class=\"w\"> </span><span class=\"n\">inf</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\">   </span><span class=\"c1\">--- &lt; Question about this</span>\n</code></pre></div>\n<p>However, I have some questions about the last conversion because it seems wrong, even in the case of just <code>Float -&gt; UInt64</code>, and it seem the documentation is incorrect: <code>Float.lean</code> says </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- If the given float is positive, truncates the value to the nearest positive integer.</span>\n<span class=\"sd\">If negative or larger than the maximum value for UInt64, returns 0. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"lean_float_to_uint64\"</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n</code></pre></div>\n<p>However, I'd argue that <code>Inf &gt; UInt64.size</code> <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> yet <code>0</code> is not returned.</p>\n<p>This is also the case with a different \"big\" number, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Thanks!</p>",
        "id": 472733249,
        "sender_full_name": "Tom",
        "timestamp": 1727281060
    },
    {
        "content": "<p>Note that if this is indeed an issue, I am also happy to help fix this in a separate PR.</p>",
        "id": 472734496,
        "sender_full_name": "Tom",
        "timestamp": 1727281494
    },
    {
        "content": "<p>I'm not sure if there is anyone with bandwidth to review changes to <code>Float</code> in Lean at the moment. (Someone may prove me wrong, but at least it's not me. :-)</p>",
        "id": 472793926,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727311571
    },
    {
        "content": "<p>Are you referring to just the new proposed feature, or the bugs I found in conversions/documentation?</p>",
        "id": 472813622,
        "sender_full_name": "Tom",
        "timestamp": 1727325975
    },
    {
        "content": "<p>I am happy to work on just fixing the conversions so they align with the documented behavior.</p>",
        "id": 472814284,
        "sender_full_name": "Tom",
        "timestamp": 1727326505
    },
    {
        "content": "<p>Certainly opening a bug report about the difference between the implementation and documentation would be great!</p>",
        "id": 472817969,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727329353
    },
    {
        "content": "<p>I know little enough of floats that I don't know which of those two needs fixing.</p>",
        "id": 472817996,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727329380
    },
    {
        "content": "<p>In Java, for comparison, values greater than the maximum (including infinity) are cast to the maximum, and values smaller than the minimum (including negative infinity) are cast to the minimum. NaN is cast to 0</p>",
        "id": 472819085,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727330066
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> </p>\n<p>I filed an issue <a href=\"https://github.com/leanprover/lean4/issues/5483\">https://github.com/leanprover/lean4/issues/5483</a>.  I also amended my original message because I realized one of the examples wasn't accurate.</p>\n<p>Thanks!</p>",
        "id": 472963822,
        "sender_full_name": "Tom",
        "timestamp": 1727380201
    },
    {
        "content": "<p>To close the loop on this:</p>\n<p><span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span> - the expected behavior is as you describe, i.e. you saturate to the largest value.</p>\n<p>I made a PR.</p>",
        "id": 473164677,
        "sender_full_name": "Tom",
        "timestamp": 1727457096
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> has marked this topic as resolved.</p>",
        "id": 473164705,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727457104
    }
]