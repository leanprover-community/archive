[
    {
        "content": "<p>This question is in the context of <a href=\"#narrow/stream/113488-general/topic/stacks.20tags\">Stacks Project tags</a>.</p>\n<p>It is also my first attempt at writing a parser and something has not gone the way it should.  Below is what I have, but I am clearly missing something... but I do not know what!  What should I do to make the code below work?</p>\n<p>The intention is to get a parser that accepts any sequence of consecutive digits or uppercase letters.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"sd\">/-- `stacksTag` is the node kind of Stacks Project Tags: a sequence of digits and</span>\n<span class=\"sd\">uppercase letters. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">stacksTagKind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`stacksTag</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">stacksTagFn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">takeWhileFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isDigit</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isUpper</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">mkNodeToken</span><span class=\"w\"> </span><span class=\"n\">stacksTagKind</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">st</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">stacksTagNoAntiquot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stacksTagFn</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkAtomicInfo</span><span class=\"w\"> </span><span class=\"s2\">\"stacksTag\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">-- the commented attribute was present in the code that I pasted</span>\n<span class=\"c1\">--@[run_builtin_parser_attribute_hooks]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">stacksTag</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"stacksTag\"</span><span class=\"w\"> </span><span class=\"n\">stacksTagKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">stacksTagNoAntiquot</span>\n\n<span class=\"c1\">-- this \"works\" in the sense that the parsing does what I expect it to</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">stacksTag</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"n\">B11D1S</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n\n<span class=\"c1\">-- however, I must be missing some sort of \"initialization\"</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">don't know how to generate formatter for non-definition '{ info := mkAtomicInfo \"stacksTag\", fn := stacksTagFn }'</span>\n<span class=\"cm\">-/</span>\n<span class=\"sd\">/-- The `stacks` attribute. -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stacks</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"stacks \"</span><span class=\"w\"> </span><span class=\"n\">stacksTag</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">attr</span>\n</code></pre></div>",
        "id": 465845230,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724877175
    },
    {
        "content": "<p>If you feel like educating me, I would also welcome any comment explaining what some of the functions defined above do.  They are there, since they were the pieces that made <code>ident</code> work that I took from core and I do not really understand how they fit together, or whether they are necessary.</p>",
        "id": 465845887,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724877456
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean.Parser</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean.PrettyPrinter.Formatter</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">combinator_formatter</span><span class=\"w\"> </span><span class=\"n\">stacksTagNoAntiquot</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">stacksTagNoAntiquot.formatter</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Lean.PrettyPrinter.Formatter.visitAtom</span><span class=\"w\"> </span><span class=\"n\">stacksTagKind</span>\n\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Lean.PrettyPrinter.Formatter</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean.PrettyPrinter.Parenthesizer</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">combinator_parenthesizer</span><span class=\"w\"> </span><span class=\"n\">stacksTagNoAntiquot</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">stacksTagAntiquot.parenthesizer</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">visitToken</span>\n\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Lean.PrettyPrinter.Parenthesizer</span>\n</code></pre></div>\n<p>Does this fix the error?</p>",
        "id": 465848803,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724878711
    },
    {
        "content": "<p>It appears to do, thanks!</p>",
        "id": 465849367,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724878935
    },
    {
        "content": "<p>I'll report back, in case I run into issues later on!</p>",
        "id": 465849391,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724878948
    },
    {
        "content": "<p>I suspect anything with that attribute that is type correct silences the error. So that actual implementation (taken from scientific literals) here should be dubious</p>",
        "id": 465849642,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724879053
    },
    {
        "content": "<p>Ok, is it expected that <code>logInfo</code> does not know how to print the new syntax?  (Not that I would want to do that, I was just curious.)</p>",
        "id": 465849762,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724879105
    },
    {
        "content": "<p>What monad are you in?</p>",
        "id": 465851396,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724879840
    },
    {
        "content": "<p>Where?  Part of this happens in <code>AttrM</code> which I think is just an abbrev for <code>CoreM</code>.</p>",
        "id": 465851461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724879872
    },
    {
        "content": "<p>Ah, the logInfo I was running it in a <code>run_cmd</code>, so <code>CommandElabM</code>, I guess.</p>",
        "id": 465851571,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724879906
    },
    {
        "content": "<p>Btw, while your fix works, the error messages for typing the wrong input are really harsh!  You just get an \"unexpected identifier\", rather than a friendlier \"Please, could you use digits and uppercase letters?\".</p>",
        "id": 465851860,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724880041
    },
    {
        "content": "<p>(I do not think that the \"bad\" errors are a problem with your fix, but with me not really knowing how to implement this correctly.)</p>",
        "id": 465851924,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724880074
    },
    {
        "content": "<p>I am tempted to make the parser accept <code>alphanum</code> and then let the elaborator handle the non-uppercase-letter for a better user experience.</p>",
        "id": 465852657,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724880437
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/Parser.20for.20digits.20and.20uppercase.20letters/near/465851571\">said</a>:</p>\n<blockquote>\n<p>Ah, the logInfo I was running it in a <code>run_cmd</code>, so <code>CommandElabM</code>, I guess.</p>\n</blockquote>\n<p>I guess you need to elaborate the stacks tag syntax then</p>",
        "id": 465853909,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724881044
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/Parser.20for.20digits.20and.20uppercase.20letters/near/465851860\">said</a>:</p>\n<blockquote>\n<p>Btw, while your fix works, the error messages for typing the wrong input are really harsh!  You just get an \"unexpected identifier\", rather than a friendlier \"Please, could you use digits and uppercase letters?\".</p>\n</blockquote>\n<p>I think it the <code>ParserFn</code> is too permissive. So nothing matching is cool with it. Then moves on to looking for a string literal or closed brace</p>",
        "id": 465854081,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724881124
    },
    {
        "content": "<p>Well, the issue is that <code>stacks 04sQ</code> underlines <code>04</code> in red and says <code>unexpected token; expected ']'</code>.</p>",
        "id": 465854445,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724881301
    },
    {
        "content": "<p>I think that a better message is to underline <code>04sQ</code> in yellow and say \"Please, use only digits and uppercase letters\".</p>",
        "id": 465854538,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724881348
    },
    {
        "content": "<p>But for this, I suspect that the parser will have to accept <code>alphanum</code> and then the elaborator looks at it and says, actually, not all <code>alphanum</code> are good.</p>",
        "id": 465854593,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724881394
    },
    {
        "content": "<p>I went ahead and opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/16230\">#16230</a>.</p>",
        "id": 465856573,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724882443
    }
]