[
    {
        "content": "<p>I would have expected the following to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>It works when writing <code>x</code> instead of <code>fun n =&gt; x n</code>. Is this intended behaviour? There are quite a few instances in mathlib that are special cases of the above missing instance.</p>",
        "id": 528541076,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752424546
    },
    {
        "content": "<p>this seems normal to me</p>",
        "id": 528541160,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752424627
    },
    {
        "content": "<p>You don't think that it would make sense for all coercions to a function to be synthesized by <code>CoeFun</code>?</p>",
        "id": 528541330,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752424774
    },
    {
        "content": "<p>I don't think that would make sense</p>",
        "id": 528541403,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752424834
    },
    {
        "content": "<p>I think <code>CoeFun</code> is for when a term in an application position is not a function</p>",
        "id": 528541424,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752424855
    },
    {
        "content": "<p>Yes, <code>x : {f : Nat → Nat // f 3 = 2}</code> is not a function. And I know it has a coercion to a function, so I'd want it to get picked up by <code>CoeFun</code>.</p>",
        "id": 528541496,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752424917
    },
    {
        "content": "<p>interesting take</p>",
        "id": 528541540,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752424957
    },
    {
        "content": "<p>it won't get pretty-printed as a coefun though</p>",
        "id": 528541588,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425002
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: def test : { f // f 3 = 2 } → ℕ → ℕ :=</span>\n<span class=\"sd\">fun x n =&gt; ↑x n</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">test</span>\n</code></pre></div>",
        "id": 528541649,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425056
    },
    {
        "content": "<p>I think that's a feature</p>",
        "id": 528541656,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425067
    },
    {
        "content": "<p>We don't want two spellings of the same thing in the infoview</p>",
        "id": 528541666,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425075
    },
    {
        "content": "<p>yes and that's why I think it shouldn't be a coefun</p>",
        "id": 528541682,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425094
    },
    {
        "content": "<p>That's why it shouldn't be a <code>DFunLike</code></p>",
        "id": 528541734,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425136
    },
    {
        "content": "<p>then you would have to deal with <code>Subtype.val _</code> and <code>DFunLike.coe _</code> being two different spellings of the same thing</p>",
        "id": 528541786,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425183
    },
    {
        "content": "<p>that would be bad</p>",
        "id": 528541789,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425187
    },
    {
        "content": "<p>so definitely not <code>DFunLike</code></p>",
        "id": 528541801,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425195
    },
    {
        "content": "<p>but maybe we could register <code>Subtype.val</code> as a <code>CoeFun</code> instance I think is the issue being brought up here</p>",
        "id": 528541819,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425219
    },
    {
        "content": "<p>I think that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div>\n<p>is relatively harmless, and that the primary reason it doesn't exist is that in lean 3 it would have behaved as DFunLike does now</p>",
        "id": 528541824,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425223
    },
    {
        "content": "<p>Or even</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div>",
        "id": 528541941,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425339
    },
    {
        "content": "<p>Yes I think the second option is better</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div>\n<p>(avoiding repeating variable <code>p</code>)</p>",
        "id": 528542274,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752425631
    },
    {
        "content": "<p>Should I try to add this to core, or for now to <code>Mathlib.Data.Subtype</code>?</p>",
        "id": 528542763,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752426045
    },
    {
        "content": "<p>I think probably core</p>",
        "id": 528544226,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752427429
    },
    {
        "content": "<p>Either this is a good idea for everyone or it isn't, this doesn't seem mathlib specific</p>",
        "id": 528544247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752427447
    },
    {
        "content": "<p>A slight annoyance here is that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"ss\">`CoeFun</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"ss\">`CoeOut</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">well</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>So, adding this instance means that there are now two different <code>CoeOut</code> instances for <code>Subtype</code>.</p>",
        "id": 528544578,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752427813
    },
    {
        "content": "<p>Are they likely to actually be different?</p>",
        "id": 528544673,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752427916
    },
    {
        "content": "<p>I was saying it more out of efficiency considerations</p>",
        "id": 528544752,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752428024
    },
    {
        "content": "<p>I wonder if there is any reason why we can't define <code>CoeFunT</code> as the transitive closure of <code>CoeOut</code>, and generate that instead of <code>CoeFun</code>. Then it would just need to check that the generated type is indeed a function. Currently if it generates a non-function type, it says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">coerce</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n<span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">applying</span><span class=\"w\"> </span><span class=\"ss\">`CoeFun.coe</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">still</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">function</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">bla</span>\n<span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">often</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">incorrect</span><span class=\"w\"> </span><span class=\"ss\">`CoeFun</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">synthesized</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">was</span>\n<span class=\"w\">  </span><span class=\"n\">instCoeFunMyFun'MyFun</span>\n</code></pre></div>",
        "id": 528545067,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752428384
    },
    {
        "content": "<p>i imagine because <code>CoeFunT</code> will then include <em>lots</em> of instances which will not at all be conducive in creating a function?</p>",
        "id": 528658721,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1752498602
    },
    {
        "content": "<p>Yeah. I thought at first that there wouldn't be other <code>CoeOut</code> instances for function-like types. But they do exists, for example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">coeOutMonoidHom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeOut</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→ₐ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 528659082,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752498720
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/missing.20.60CoeFun.60.20instance.20for.20.60SubType.60/near/528541941\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>You're proposing adding <em>both</em> the above and also this:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/missing.20.60CoeFun.60.20instance.20for.20.60SubType.60/near/528541824\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>right? Because the first one doesn't imply the second, unless I'm grossly mistaken.</p>",
        "id": 528662097,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1752499539
    },
    {
        "content": "<p>Note that the docstring of <code>CoeFun.coe</code> is also confused about the non-transitive nature of <code>CoeFun</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Coerces a value `f : α` to type `γ f`, which should be either be a</span>\n<span class=\"sd\">  function type or another `CoeFun` type, in order to resolve a mistyped</span>\n<span class=\"sd\">  application `f x`. -/</span>\n</code></pre></div>\n<p>But if I try to have <code>γ f</code> be another <code>CoeFun</code> type, I get an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">B</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n</code></pre></div>",
        "id": 528663944,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752499937
    },
    {
        "content": "<p>Another option is to add this instance to Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFunLike</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DFunLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n<span class=\"w\">  </span><span class=\"n\">coe_injective'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">coe_injective'</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I've started trying this at <a href=\"https://github.com/leanprover-community/mathlib4/pull/27143\">#27143</a></p>",
        "id": 528700420,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752510706
    },
    {
        "content": "<p>Doesn't that not fix the original issue, since functions aren't funlike?</p>",
        "id": 528701126,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752510964
    },
    {
        "content": "<p>You're right. I think I'll then also add an instance to make functions be funlike</p>",
        "id": 528701349,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752511062
    },
    {
        "content": "<p>No, please don't.</p>",
        "id": 528704230,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1752512179
    },
    {
        "content": "<p>What is the disadvantage of an instance of <code>DFunLike (∀ a, β a) α β</code>?</p>",
        "id": 528704496,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752512285
    },
    {
        "content": "<p>It has absolutely awful performance</p>",
        "id": 528709549,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1752514195
    },
    {
        "content": "<p>Really? I though <code>DFunLike F _ _</code> goals in type class search usually arise when <code>F</code> is NOT a function. So a <code>DFunLike (∀ a, β a) α β</code> instance would essentially do nothing performance wise.</p>",
        "id": 528709820,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752514285
    },
    {
        "content": "<p>Anyways, it turns out my idea doesn't work, because it gives an application of <code>DFunLike.coe</code> instead of <code>Subtype.val</code>.</p>",
        "id": 528709855,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752514298
    }
]