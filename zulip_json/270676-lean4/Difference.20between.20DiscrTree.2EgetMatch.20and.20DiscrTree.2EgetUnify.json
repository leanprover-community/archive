[
    {
        "content": "<p>Hi, I am trying to understand how to use <code>DiscrTree</code> and it seems that <code>simp</code> uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/DiscrTree.html#Lean.Meta.DiscrTree.getMatch\">getMatch</a> while typeclass inference uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/DiscrTree.html#Lean.Meta.DiscrTree.getUnify\">getUnify</a>. I had a hard time understand what the difference between the two since I did not see documentation for them and the code a bit too tricky for me to understand. Does someone have an intuition what the difference between the two is and when to use which?</p>",
        "id": 511579852,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1744356349
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Difference.20between.20DiscrTree.2EgetMatch.20and.20DiscrTree.2EgetUnify\">#new members &gt; Difference between DiscrTree.getMatch and DiscrTree.getUnify</a> by <span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span>.</p>",
        "id": 511840494,
        "sender_full_name": "Notification Bot",
        "timestamp": 1744488245
    },
    {
        "content": "<p>I think <code>getUnify</code> may assign metavariables in the expression being matched against while <code>getMatch</code> may not. But I'm not sure.</p>",
        "id": 512069951,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1744634653
    },
    {
        "content": "<p>Indeed, there are two ways to match with a <code>DiscrTree</code>: unifying, or just matching. Type class search needs to unify, because its target may have metavariables that it wants to unify (due to <code>outParam</code>s). On the other hand <code>simp</code> doesn't want to instantiate metavariables in the expression that is being simplified.</p>",
        "id": 512778787,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744881847
    },
    {
        "content": "<p>That helps for knowing when to use which, thanks! Thought I have to admit I still don't really understand how it works. From what I see, the <code>DiscrTree</code> does not instantiate metavariables itself (which would be weird anyway if there are multiple matches), but <code>getUnify</code> treats <code>.star</code> differently from <code>getMatch</code>.</p>",
        "id": 513163853,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1745064152
    },
    {
        "content": "<p>Yes, DiscrTree doesn't actually do the unification. Rather, it gives a list of results that probably unify with the target. Then these results should be attempted one by one with unification, i.e. isDefEq.</p>\n<p>Thus, DiscrTree works as a first filter that limits the amount of expressions that we have to try to unify.</p>",
        "id": 513194634,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745087693
    },
    {
        "content": "<p>When using getMatch (which is most use cases), you need the function to be wrapped in a withNewMCtxDepth, to avoid instantiating the metavariables in the matched expression.</p>",
        "id": 513194806,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745087839
    }
]