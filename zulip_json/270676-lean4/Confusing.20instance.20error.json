[
    {
        "content": "<p>I asked a question in \"new members\"; I seem to get an error from the Eleborator but the code still type checks/works.  Not sure if this is a bug/unintended behavior:</p>\n<p><a href=\"#narrow/stream/113489-new-members/topic/Lean.20gives.20error.20but.20eval.20works.3F/near/471538887\">https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/Lean.20gives.20error.20but.20eval.20works.3F/near/471538887</a></p>\n<p>Thought I'd surface just in case.</p>",
        "id": 471539940,
        "sender_full_name": "Tom",
        "timestamp": 1726769399
    },
    {
        "content": "<p>Summarizing here, the \"cannot find synthesization order\" error message led <span class=\"user-mention\" data-user-id=\"515083\">@Tom</span> to think that there was an error in the instance definition itself. However, the error doesn't mean the instance definition itself has any real errors, other than the fact that a synth order couldn't be computed — this is the plan that instance synthesis will use when trying to apply the instance — the impact is that the instance might not be applicable.</p>",
        "id": 471540457,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769603
    },
    {
        "content": "<p>In this particular case, there's an <code>HAdd</code> instance argument that has some arguments that only appear in an outParam. Interestingly, the <code>Add</code> default instance makes the instance succeed anyway in the end.</p>",
        "id": 471540881,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769774
    },
    {
        "content": "<p>Given that the only way this instance works is by applying a default instance, I think it should use <code>Add</code> instead of <code>HAdd</code>.</p>",
        "id": 471541166,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769890
    },
    {
        "content": "<p>Still, the error message probably should mention that it will use some default synth order as a backup and warn that the instance is likely never applicable.</p>",
        "id": 471541308,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769951
    },
    {
        "content": "<p>perhaps this should be a warning rather than an error, then?</p>",
        "id": 471541595,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726770066
    },
    {
        "content": "<p>Yeah, I think that could make sense.</p>",
        "id": 471542250,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726770350
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5399\">lean4#5399</a> proposes the change</p>",
        "id": 471545659,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726771842
    },
    {
        "content": "<p>So does the above discussion also mean that in general, I can't use <code>CoeFun</code> to generate a polymorphic function?  That was basically what I experimenting with.  Perhaps simplifying further,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>Also note that the inferred type is now <code>USize</code>!  Is that concerning?</p>",
        "id": 471545660,
        "sender_full_name": "Tom",
        "timestamp": 1726771842
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471545659\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/5399\">lean4#5399</a> proposes the change</p>\n</blockquote>\n<p>Just saw this, thank you!</p>",
        "id": 471546025,
        "sender_full_name": "Tom",
        "timestamp": 1726772015
    },
    {
        "content": "<p>The issue here is that the second argument to <code>CoeFun</code> is an outParam, meaning that the instance is responsible for filling it in. The non-outParam argument <code>MyAdd</code> doesn't mention <code>α</code>, so it's not able to solve for <code>α</code>.</p>\n<p>I'm surprised <code>USize</code> pops up here though! You'd have to trace instance synthesis to get to the bottom of that one.</p>",
        "id": 471546262,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726772127
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> <a href=\"#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471546025\">said</a>:</p>\n<blockquote>\n<p>Just saw this, thank you!</p>\n</blockquote>\n<p>Be sure to check whether the wording would have helped, and feel free to leave a github comment!</p>",
        "id": 471546373,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726772174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471546373\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> <a href=\"#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471546025\">said</a>:</p>\n<blockquote>\n<p>Just saw this, thank you!</p>\n</blockquote>\n<p>Be sure to check whether the wording would have helped, and feel free to leave a github comment!</p>\n</blockquote>\n<p>Already looking! <span aria-label=\"bow\" class=\"emoji emoji-1f647\" role=\"img\" title=\"bow\">:bow:</span></p>",
        "id": 471546478,
        "sender_full_name": "Tom",
        "timestamp": 1726772225
    },
    {
        "content": "<p>for what it's worth, you <em>can</em> make a polymorphic function this way. you just have to tell lean about the fact that the coersion has to happen regardless of what the type of the second operand is going to be.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">myval</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">myval</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 471546882,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726772417
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> </p>\n<p>Wow, that's cool.  I can just about read/understand this but wouldn't have never been able to come up with it!</p>\n<p>What's the reason for the <code>autoImplicit false</code>?  Is that some magic required to make this work or is that a coding style preference wrt to being explicit about universe levels?</p>\n<p>And forgive the silly question but when I change the last line to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I actually get an error, while </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>actually works (as expected).</p>\n<p>Am I misunderstanding something or does the above instance actually not work for mixed types?</p>\n<p>Thanks!</p>",
        "id": 471548728,
        "sender_full_name": "Tom",
        "timestamp": 1726773263
    },
    {
        "content": "<p><code>set_option autoImplicit false</code> can always be removed. It can be good practice when developing when you're not sure if you're accidentally introducing additional parameters.</p>",
        "id": 471549100,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773431
    },
    {
        "content": "<p><code>5 + (3 : Int)</code> works because of some elaboration magic for binary operators. If you go-to-def for <code>+</code> you'll see <code>binop%</code>, which triggers it.</p>\n<p>That elaborator will get <code>5</code> to elaborate as an <code>Int</code>. You can hover over <code>5</code> in <code>#check 5 + (3 : Int)</code> to verify.</p>",
        "id": 471549405,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773569
    },
    {
        "content": "<p>We need these special elaborators since heterogenous operators have elaboration issues — we want to be able to propagate the return value's type to the arguments, and from one argument to the other, when we can detect it's not heterogenous.</p>",
        "id": 471549576,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773645
    },
    {
        "content": "<p>i actually expected it to simply be coersion?</p>",
        "id": 471549625,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726773666
    },
    {
        "content": "<p>Anyway, the proximal error is that there's no <code>HAdd Nat Int ?m.693</code> instance.</p>",
        "id": 471549657,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773683
    },
    {
        "content": "<p>Thanks!  Sorry - to be clear.  I understand why \"5 + (3 : Int)\" works.  However, the <code>Adder</code> example which <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> posted does not work for me with mixed types.</p>",
        "id": 471549658,
        "sender_full_name": "Tom",
        "timestamp": 1726773683
    },
    {
        "content": "<p>Yeah, that's what I'm addressing. The difference is that you have <code>myAdd : MyAdd Nat</code></p>",
        "id": 471549729,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773716
    },
    {
        "content": "<p>There's nothing here that will trigger a coercion</p>",
        "id": 471549794,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773727
    },
    {
        "content": "<p>Even <code>(5 : Nat) + (3 : Int)</code> needs this <code>binop%</code> elaborator. Compare it to <code>HAdd.hAdd (5 : Nat) (3 : Int)</code>, which fails.</p>",
        "id": 471549859,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773767
    },
    {
        "content": "<p>Even if you use homogenous addition, there are elaboration gotchas. The first fails, but the second works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 471550101,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726773850
    },
    {
        "content": "<p>then what's going on here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 471550200,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726773900
    },
    {
        "content": "<p>ah, i think i've misunderstood you. i thought you said <code>binop%</code> was something to make <em>number literals</em> get cast to the right type,  but it does the coersion in general</p>",
        "id": 471550472,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726773998
    },
    {
        "content": "<p>I see.  I was just going off Ch 4. of FPiL, from which my understanding was that writing </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>are the same, because the former would only \"desugar\" to the latter.  Seeing that the latter doesn't work is actually a surprise to me.</p>\n<p>Hence why I was also confused about your comment about \"coercion\", because the only \"coercion\" I was looking for was the  \"CoeFun\" to go from <code>Adder a</code> to something like <code>`fun b =&gt; x.myval + b</code> with <code>[HAdd a b c] b -&gt; c</code>. </p>\n<p>Clearly it's more complicated than that.</p>",
        "id": 471551013,
        "sender_full_name": "Tom",
        "timestamp": 1726774221
    }
]