[
    {
        "content": "<p>I'm trying to update <a href=\"https://github.com/lecopivo/LeanBLAS\">LeanBLAS</a> to newer toolchain but I'm getting some linker errors that I have no idea what to do about:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"bp\">âœ–</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">CBLASLevelOneTest</span><span class=\"o\">:</span><span class=\"n\">exe</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.22.0/bin/clang -o /home/tskrivan/Documents/LeanBLAS/.lake/build/bin/CBLASLevelOneTest  [...]</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">libc_csu_fini</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">101</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">x86_64</span><span class=\"bp\">/</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">101</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.22.0/lib/Scrt1.o:(_start)</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">libc_csu_init</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">102</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">x86_64</span><span class=\"bp\">/</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">102</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.22.0/lib/Scrt1.o:(_start)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.22.0/bin/clang' exited with code 1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">CBLASLevelOneTest</span><span class=\"o\">:</span><span class=\"n\">exe</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>\n<p>What can I do about this? Probably there is some mismatch between Lean's and system's C libraries. I'm running Ubuntu 24.04 and compiling with Lean v4.22.0</p>",
        "id": 536830971,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756487424
    },
    {
        "content": "<p>The compilation command is </p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>/home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0/bin/clang -o /home/tskrivan/Documents/LeanBLAS/.lake/build/bin/CBLASLevelOneTest /home/tskrivan/Documents/LeanBLAS/.lake/build/ir/Test/cblas_level_one.c.o.export -L/usr/lib/x86_64-linux-gnu/ -lblas -fuse-ld=bfd -L /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0/lib/lean --sysroot /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0 -L /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0/lib -L /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0/lib/glibc -lc -lc_nonshared -Wl,--as-needed -l:ld.so -Wl,--no-as-needed -lpthread_nonshared -Wl,--as-needed -Wl,-Bstatic -lgmp -lunwind -luv -Wl,-Bdynamic -Wl,--no-as-needed -fuse-ld=lld -Wl,--start-group -lleancpp -lLean -Wl,--end-group -lStd -Wl,--start-group -lInit -lleanrt -Wl,--end-group -Wl,-Bstatic -lc++ -lc++abi -Wl,-Bdynamic -lLake -Wl,--as-needed -lgmp -luv -lpthread -ldl -lrt -Wl,--no-as-needed -lm -ldl -pthread\n</code></pre></div>\n</div></div>\n<p>If I remove</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">--sysroot /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.22.0</span>\n</code></pre></div>\n<p>then it compiles fine.</p>",
        "id": 536904104,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756548143
    },
    {
        "content": "<p>Ok the problem is with OpenBLAS library is distributed on Ubuntu 24.04 for glibc 2.39 but Lean v4.22.0 uses glibc 2.26. This causes incompatibility as newer versions of glibc do not have <code>__libc_csu_fini/init</code>.</p>\n<p>Not sure what to do exactly:</p>\n<ol>\n<li>compile OpenBLAS against the C libraries distributed with the specific version of Lean</li>\n<li>tell Lean to use system's C libraries (I think this is effectively removing the <code>--sysroot</code> flag)</li>\n</ol>\n<p>What is the most future proof approach?</p>\n<hr>\n<p><span class=\"user-mention\" data-user-id=\"601076\">@Peiyang Song</span> I see that Lean Copilot is building OpenBLAS from source. Did you come across with this issue? Are you using BLAS in Lean FFI? If not then you probably do not suffer from this.</p>",
        "id": 536907228,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756552394
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Any idea how set up lakefile to resolve this issue?</p>",
        "id": 536908191,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756553620
    },
    {
        "content": "<p>I suspect the issue is adding the entire system root as a library path and doing so very early in the cmdline. Try oassing the .so directly without changing the library path?</p>",
        "id": 536913492,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1756558875
    },
    {
        "content": "<p>Ohh, changing </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-L/usr/lib/x86_64-linux-gnu/\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-lblas\"</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"/usr/lib/x86_64-linux-gnu/libblas.so\"</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>solves the issue.</p>",
        "id": 536913937,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756559322
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/undefined.20symbol.3A.20__libc_csu_fini/near/536913492\">said</a>:</p>\n<blockquote>\n<p>Try oassing the .so directly without changing the library path?</p>\n</blockquote>\n<p>Is that what you had in mind? I'm not sure if I understand your suggestion correctly.</p>",
        "id": 536913978,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1756559379
    },
    {
        "content": "<p>Yes, exactly</p>",
        "id": 536919220,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1756565027
    }
]