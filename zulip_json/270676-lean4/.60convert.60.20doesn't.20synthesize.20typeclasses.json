[
    {
        "content": "<p>While proving a theorem, I encountered this odd behavior:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subgroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"bp\">⊤</span>\n<span class=\"w\">  </span><span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>Is this intended? I didn't see anything about this in the docstring.</p>",
        "id": 496462445,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738120366
    },
    {
        "content": "<p><code>convert</code> doesn't use the expected type for elaboration, because the purpose of convert is to take a term whose type doesn't match the expected type and then solve for the differences.</p>\n<p>This means that <code>⊤</code> elaborates with unknown <code>Top</code> instance. What <code>convert</code> also does is elaborate and allow stuck typeclass problems, so these get left as metavariables. The <code>convert</code> tactic doesn't go out of its way to then try to solve stuck typeclass problems — it just leaves them as goals. You can verify that <code>convert (⊤ : Subgroup G)</code> leaves no instance goals.</p>\n<p>I'm sure you're just experimenting here, but <code>convert</code> is the wrong tool for constructing data. (Plus, this can simply be <code>example (G : Type*) [Group G] : Subgroup G := ⊤</code>.)</p>",
        "id": 496464184,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738121578
    },
    {
        "content": "<p>This phenomenon means that in practice it is not uncommon (at least in my experience) to see <code>convert</code> leave goals which can be solved by <code>infer_instance</code>. I try to avoid <code>convert</code> nowadays, it feels a bit like a code smell (e.g. often in PR reviews I suggest changes to remove <code>convert</code>s).</p>",
        "id": 496503537,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738142909
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60convert.60.20doesn't.20synthesize.20typeclasses/near/496464184\">said</a>:</p>\n<blockquote>\n<p>I'm sure you're just experimenting here, but <code>convert</code> is the wrong tool for constructing data. (Plus, this can simply be <code>example (G : Type*) [Group G] : Subgroup G := ⊤</code>.)</p>\n</blockquote>\n<p>This was minimized from a 600 line proof of <code>∀ (f : Circle → ℝ), ¬Topology.IsEmbedding f</code> (over a third of it was providing <code>ConditionallyCompleteLinearOrder (Set.Ioo (0 : ℝ) 1)</code>).<br>\nIn the proof I was not constructing data, and now that I think about it <code>simpa</code> probably would've worked anyways.</p>\n<p>EDIT: <code>simpa</code> did not work (typeclass stuck)</p>",
        "id": 496538451,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738154216
    },
    {
        "content": "<p>We could add a last pass to try inferring instances easily enough. I hadn't heard anyone was running into this until now.</p>\n<p>The current behavior (ignore stuck typeclasses) came from people reporting that reasonable <code>convert</code>s were failing because of this problem. Usually the stuck typeclasses seem to be solved for inside the congruence algorithm.</p>",
        "id": 496602234,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738172094
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Feel free to make a PR that modifies <code>convert</code> to go through the the <code>gs</code> goal and solve those that are synthesizable instances. You can look at <code>apply</code> and <code>use</code> for examples of how to do that.</p>",
        "id": 496624938,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738177672
    }
]