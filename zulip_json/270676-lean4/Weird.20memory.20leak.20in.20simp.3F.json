[
    {
        "content": "<p>First, forgive me for not being able to give a compact example to replicate the problem, since I haven't identified the exact cause of the problem.</p>\n<p>I am working on a project to <a href=\"https://github.com/FormalizedFormalLogic\">formalize logic</a> . I recently updated Lean to v4.20.0-rc2 and encountered a weired memory leaks. The central part of the problem is as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">[(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">cons_val_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- memory leaks!</span>\n</code></pre></div>\n<p>Where <code>x</code> is some complex term.</p>\n<p><del>See <a href=\"https://github.com/FormalizedFormalLogic/Foundation/blob/palalansouki/update-to-v4.19.0-rc2/Foundation/Incompleteness/Arith/WeiredMemoryLeak.lean\">here</a> for details. This file depends on hundreds of local files, so it is difficult to extract mwe.</del> mwe reproduce the error probably due to the same problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">VecNotation</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"o\">(</span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"o\">(</span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"mi\">999999</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span><span class=\"bp\">^</span><span class=\"mi\">9</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">cons_val_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- memory leak?</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">[</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">cons_val_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- (kernel) deep recursion detected</span>\n</code></pre></div>\n<p>It is also odd to get a <code>(kernel) deep recursion detected</code> error for a very simple proposition.</p>\n<p>Perhaps this is a bug in simp tactic?<br>\nI think this was not the case in the previous version (v4.18.0-rc1). What information can I provide to fix this problem?</p>",
        "id": 517850414,
        "sender_full_name": "Palalansouk√Æ",
        "timestamp": 1747147489
    },
    {
        "content": "<p>Can you please make \"memory leak\" more precise?</p>",
        "id": 517850901,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1747147600
    },
    {
        "content": "<p>E.g., what tools tell you that it's a memory leak, not some other bug?</p>",
        "id": 517851046,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747147637
    },
    {
        "content": "<p>I checked using gnome-system-monitor. (If left untreated, it will occupy memory and freeze the PC.)</p>",
        "id": 517852922,
        "sender_full_name": "Palalansouk√Æ",
        "timestamp": 1747148092
    },
    {
        "content": "<blockquote>\n<p>Can you please make \"memory leak\" more precise?</p>\n</blockquote>\n<p>The yellow line on the left does not disappear even after the proof is finished, and in the meantime it continues to occupy memory (until PC freezes ...).</p>",
        "id": 517855335,
        "sender_full_name": "Palalansouk√Æ",
        "timestamp": 1747148595
    },
    {
        "content": "<p>That's not (just) a memory leak, that's a runaway process! This should usually be caught by the heartbeat/rec depth limits but apparently that doesn't happen (fast enough) here. Not sure what more can be said without an MWE.</p>",
        "id": 517860679,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1747149838
    },
    {
        "content": "<p>An unrelated code but with similar phenomenon: <a class=\"message-link\" href=\"/#narrow/channel/217875-Is-there-code-for-X.3F/topic/Separability.20degree.3F/near/517460785\">#Is there code for X? &gt; Separability degree? @ üí¨</a> which causes Lean to run forever</p>",
        "id": 517893657,
        "sender_full_name": "Jz Pan",
        "timestamp": 1747159699
    },
    {
        "content": "<p>I found a mwe that probably causes the same problem (see also the first message I edited).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">VecNotation</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"o\">(</span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"o\">(</span><span class=\"mi\">999999</span><span class=\"bp\">^</span><span class=\"mi\">999999</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"bp\">!</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">cons_val_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- memory leak/runaway process?</span>\n</code></pre></div>",
        "id": 518030356,
        "sender_full_name": "Palalansouk√Æ",
        "timestamp": 1747219375
    },
    {
        "content": "<p><code>999999^(999999^(999999^999999))</code> is too big to evaluate.</p>",
        "id": 518098501,
        "sender_full_name": "Jz Pan",
        "timestamp": 1747236772
    },
    {
        "content": "<p>Related: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Panic.20in.20rw.3A.20Nat.2Epow.20exponent.20is.20too.20big/with/431515691\">#general &gt; Panic in rw: Nat.pow exponent is too big</a></p>",
        "id": 518098611,
        "sender_full_name": "Jz Pan",
        "timestamp": 1747236808
    }
]