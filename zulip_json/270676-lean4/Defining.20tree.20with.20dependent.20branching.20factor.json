[
    {
        "content": "<p>Suppose I want to model terms of a (first-order, untyped) language, but still want to statically track that applications have the right arities:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Functions / base constants -/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n\n<span class=\"sd\">/-- A term is either a variable, or an application of a function symbol to sub-terms -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n</code></pre></div>\n<p>But I'll get an error:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>(kernel) invalid nested inductive datatype 'Subtype', nested inductive datatypes parameters cannot contain local variables.\n</code></pre></div>\n<p>How should I fix this problem? Thanks!!</p>",
        "id": 505905848,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1742090122
    },
    {
        "content": "<p>Using <code>Fin n → Term</code> works</p>",
        "id": 505906332,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1742090506
    },
    {
        "content": "<p>That works great thanks! I needed a few coersion instances to make things look nice but that's neat.</p>\n<p>Is this problem fundamental, or more of a current implementation quirk that may eventually be improved? Thanks!</p>",
        "id": 505908079,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1742091936
    },
    {
        "content": "<p>Note that <code>n</code> is an autoimplicit parameter here, so <code>app</code> has type <code>∀ {n : Nat}, ...</code></p>",
        "id": 505918330,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742100365
    },
    {
        "content": "<p>Also, why do you need a structure <code>Const</code> that takes <code>arity</code> but doesn't use it in any way?</p>",
        "id": 505918385,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742100440
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover/lean4/issues/1964\">https://github.com/leanprover/lean4/issues/1964</a></p>",
        "id": 505918868,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742100763
    },
    {
        "content": "<p>Thanks Yury for the issue link!</p>\n<p>The <code>arity</code> was to avoid simple errors mis-applying the constant/function to the wrong number of arguments. For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">MkTerm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">     </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MkTerm</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- For nicer term construction</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">var</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">MkTerm</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> omitted -/</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"pair\"</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"nil\"</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nil</span>\n</code></pre></div>\n<p>Also, independent of whether I'll actually need to use the <code>n</code> at runtime for this example, is there in general a way to mark an index as \"compile-time only\", so if I accidentally retain it at runtime, I'll get an error, similar to <a href=\"https://idris2.readthedocs.io/en/latest/tutorial/multiplicities.html\">multiplicities</a> in Idris? Thanks!!</p>",
        "id": 505928304,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1742107988
    },
    {
        "content": "<p>Ohh now I realized Yury's question was why I hadn't done it this way, which would reuse the <code>arity</code> in <code>Const</code> and avoid the implicit <code>n</code> in <code>Term.app</code>. Thanks!!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">arity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Const</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">arity</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n</code></pre></div>",
        "id": 505929406,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1742108914
    },
    {
        "content": "<p>Note that this is nice for proving theorems but it's bad for writing computable code.</p>",
        "id": 505961558,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742134596
    },
    {
        "content": "<p>I mean, <code>Fin _ → _</code> isn't stored as an array in memory.</p>",
        "id": 505961578,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742134619
    },
    {
        "content": "<p>I tried to give a <code>mutual inductive</code> definition that stores children in an <code>Array</code> but failed.</p>",
        "id": 505961699,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742134687
    }
]