[
    {
        "content": "<p>What the title says. I've been trying to find information about what the idiomatic way of writing tests in Lean 4 is supposed to be, but that information seems to be under some rock. Also, how do I run the tests once I have written them? I see <code>lake</code> has a command <code>test</code>, but the help for <code>lake test</code> talks about some \"test driver\", and I've still to find a clearly written example of this. Do I need to set it up in <code>lakefile.toml</code>?</p>",
        "id": 491012866,
        "sender_full_name": "Santtu",
        "timestamp": 1735320206
    },
    {
        "content": "<p>Yes, you need a <code>lakefile.toml</code> or a <code>lakefile.lean</code>, but you need this for any lean project. Here is an example <code>lakefile.toml</code> with a <code>test driver</code>.</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClient\"</span>\n<span class=\"n\">testDriver</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClientTest\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"LeanSearchClient\"</span><span class=\"p\">]</span>\n\n<span class=\"k\">[[lean_lib]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClient\"</span>\n\n<span class=\"k\">[[lean_lib]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClientTest\"</span>\n</code></pre></div>\n<p>The library <code>LeanSearchClientTest</code> has the <em>test</em> files, which are simply Lean files. A useful way to write tests is to use <code>guard_msgs</code> before a command say <code>#eval ...</code> or <code>#check ...</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- info: 2 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>The great thing about <code>#guard_msgs</code> is if you just include it, you will get a code action to add the correct stuff.</p>",
        "id": 491082776,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1735382989
    },
    {
        "content": "<p>Right, having the tests as a separate library makes sense. And I suppose that marking the tests library as a test driver makes it possible to import stuff from the actual library?</p>",
        "id": 491094590,
        "sender_full_name": "Santtu",
        "timestamp": 1735394297
    },
    {
        "content": "<p>I think the <code>lean_lib</code> is what makes the imports resolve; the <code>testDriver</code> just hooks it up to <code>lake test</code></p>",
        "id": 491094777,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735394492
    },
    {
        "content": "<p>What is the idiomatic way to run compiled tests?</p>\n<p>I.e. I have a bunch of lean files with <code>def main : IO Int := ...</code> which should return <code>0</code> when executed.</p>\n<p>I do now want to list all those files in lakefile but say that all files in a directory should be treated that way.</p>",
        "id": 491118790,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1735418502
    },
    {
        "content": "<p>Hello, I'd like to (re)use this thread to ask about the following goal for the <a href=\"https://lean-lang.org/fro/roadmap/1900-1-1-the-lean-fro-year-3-roadmap/\">year 3 roadmap</a>:</p>\n<blockquote>\n<ol start=\"5\">\n<li>Provide reliable benchmarking, testing, and profiling infrastructure for Lean and Mathlib.</li>\n</ol>\n</blockquote>\n<p>More specifically, I'm interested in the testing infrastructure.</p>\n<p>As a reference, we've been using <a href=\"https://github.com/argumentcomputer/LSpec\">LSpec</a> to test Lean 4 code. It has decent ways to define testing suites. It also has API for property testing, which is extremely useful.</p>\n<p>However, one major issue of LSpec is that it currently runs the tests simply by importing test suites. I think this happens because LSpec is based on <code>Prop</code> decidability to derive <code>Testable</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">The main typeclass of propositions that can be tested by `LSpec`.</span>\n\n<span class=\"sd\">In non-succeeding cases, it may contain an explanatory message.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Testable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isMaybe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFailure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- A default `Testable` instance with low priority. -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Testable</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"s2\">\"Evaluated to false\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\">  </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">isTrue</span><span class=\"w\">  </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>All that to motivate the questions: what are the plans for the official Lean 4 testing infrastructure? Will it support property testing natively?</p>",
        "id": 539786941,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1758033184
    },
    {
        "content": "<p>The benchmarking and profiling part of this is more geared towards work on velcom (known to most as <a href=\"https://speed.lean-lang.org/\">https://speed.lean-lang.org/</a>) done by <span class=\"user-mention silent\" data-user-id=\"421885\">Joscha Mennicken</span>. </p>\n<p>The plans for the testing infrastructure are much less laid out at the moment. There was a time where I worked on a generic testing infrastructure that can handle many kinds of tests here <a href=\"https://github.com/hargoniX/nest-core\">https://github.com/hargoniX/nest-core</a> (and in related nest- repositories) though I eventually stopped. I guess if we revitalized that kind of infrastructure we could have spec tests, property tests, golden tests and all the other stuff that people are interested in.</p>",
        "id": 539795617,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758035378
    },
    {
        "content": "<p>Okay I already see that <code>IsTest.run</code> happens in <code>IO</code> and therefore it wouldn't have this issue of running tests just by importing them.</p>\n<p>I'm looking forward to it!</p>",
        "id": 539797569,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1758035885
    },
    {
        "content": "<p>Nice, nest-unit looks really neat. I Hope something like this makes it into Std.</p>",
        "id": 539806921,
        "sender_full_name": "Alfredo Moreira-Rosa",
        "timestamp": 1758038310
    }
]