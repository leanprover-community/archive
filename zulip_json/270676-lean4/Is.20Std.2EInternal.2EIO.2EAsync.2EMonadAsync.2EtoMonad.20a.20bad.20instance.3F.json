[
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Internal.IO.Async.MonadAsync#doc\">docs#Std.Internal.IO.Async.MonadAsync</a> seems to break the rule of \"a 2-ary typeclass should never extend a 1-ary one\", as there is no way to determine what <code>t</code> should be used to find <code>Monad m</code> from <code>MonadAsync t m</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">MonadAwait</span><span class=\"bp\">.</span><span class=\"n\">toMonad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">MonadAwait</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 536560463,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756371368
    },
    {
        "content": "<p>You can see this blow-up in action (on mathlib stable or the latest mathlib) in:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">Load</span><span class=\"bp\">.</span><span class=\"n\">Resolve</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">MonadWorkspace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ResolveT</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 536560670,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756371437
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Internal.IO.Async.MonadAwait#doc\">docs#Std.Internal.IO.Async.MonadAwait</a> seems similarly bad</p>",
        "id": 536560789,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756371472
    },
    {
        "content": "<p>\"the rule\" I mention is the one in <a href=\"https://leanprover-community.github.io/mathematics_in_lean/\">#mil</a>; I've created <a href=\"https://github.com/avigad/mathematics_in_lean_source/pull/316\">https://github.com/avigad/mathematics_in_lean_source/pull/316</a> to track that the error message it reports seems to no longer occur.</p>",
        "id": 536563311,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756372238
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span>, since I think your thesis discusses such instances</p>",
        "id": 536586272,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756381074
    },
    {
        "content": "<p>Yes, such <code>extends</code> clauses cause underdetermined instances, and would generally be a bad idea unless <code>t</code> is a (semi)outparam. Normally this should cause an error \"cannot find synthesization order for instance ... all remaining arguments have metavariables\". Indeed if I make a declaration with the same type I see the error. Weird that the check does not seem to fire on the definition of <code>MonadAsync</code>.</p>",
        "id": 536597336,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1756384921
    },
    {
        "content": "<blockquote>\n<p>cannot find synthesization order for instance ... all remaining arguments have metavariables</p>\n</blockquote>\n<p>This error no longer files if you define <code>Module</code> this way either:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Module'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero_smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">one_smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">mul_smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">add_smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">smul_add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 536601186,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756386066
    },
    {
        "content": "<p>I was working on a fix for this type class issue in <a href=\"https://github.com/leanprover/lean4/pull/9638\">lean#9638</a> (see also <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/projection.20instance.20binderinfo.20problem/with/532887599\">#lean4 &gt; projection instance binderinfo problem</a> ). And on the toolchain of that PR, the definition of <code>MonadAwait</code> indeed throws an error.</p>\n<p>But the strange thing is that the CI on the PR was green, so I didn't notice this bad instance (I did notice some in Batteries and Mathlib). Is this some sort of bootstrapping thing where it doesn't do a second build?</p>",
        "id": 536649146,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756400212
    },
    {
        "content": "<p>The lack of this error message was introduced by <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a></p>",
        "id": 536650094,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756400542
    },
    {
        "content": "<p>Anyways, in this case I think the <code>t</code> argument in <code>MonadAsync</code> and <code>MonadAwait</code> should be a <code>semiOutParam</code>.</p>",
        "id": 536650255,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756400607
    },
    {
        "content": "<p>I'd actually argue that we shouldn't extend <code>Monad</code> in the first place but use <code>[Monad m]</code> - take something like<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Internal.IO.Async.concurrentlyAll#doc\">docs#Std.Internal.IO.Async.concurrentlyAll</a> which already says <code>[Monad m] [MonadAwait t m] [MonadAsync t m]</code> which would be three different monad instances!</p>",
        "id": 536689482,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756418769
    },
    {
        "content": "<p>It has <code>[MonadAwait Task m] [MonadAsync t m] [MonadAwait t m] [Monad m]</code>, so I'm counting 4 different monad instances <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> </p>\n<p>But yes, if we ever want to combine <code>[MonadAsync t m]</code> and <code>[MonadAwait t m]</code>, then these classes should certainly not extend <code>Monad m</code>.</p>",
        "id": 536690632,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756419590
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"481858\">@Sofia Rodrigues</span></p>",
        "id": 536738185,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756454938
    },
    {
        "content": "<p>I opened PR <a href=\"https://github.com/leanprover/lean4/pull/10173\">#10173</a> that removes <code>extends Monad</code> from both type classes.</p>",
        "id": 536804005,
        "sender_full_name": "Sofia Rodrigues",
        "timestamp": 1756478571
    },
    {
        "content": "<p>Probably it should be backported, since I assume these bad instances can impact more than just lake</p>",
        "id": 536805404,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756479001
    },
    {
        "content": "<p>Are you actively affected by this?</p>",
        "id": 536813667,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1756481443
    },
    {
        "content": "<p>I don't know yet, but my understanding is that a backport (at least to 4.23.0) is as simple as adding a label</p>",
        "id": 536815026,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756481844
    },
    {
        "content": "<p>I understand backporting to 4.22.0 is more work</p>",
        "id": 536815057,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756481854
    },
    {
        "content": "<p>It's as simple as adding a label as long as you don't need an rc3.</p>",
        "id": 536815968,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1756482154
    },
    {
        "content": "<p>I guess I'd advocate putting it on the branch in case something _else_ justifies a new RC release</p>",
        "id": 536816938,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756482459
    },
    {
        "content": "<p>Already done :)</p>",
        "id": 536817055,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1756482496
    },
    {
        "content": "<p>What should the action be on <a href=\"https://github.com/avigad/mathematics_in_lean_source/pull/316\">https://github.com/avigad/mathematics_in_lean_source/pull/316</a> ?</p>",
        "id": 536817148,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756482527
    },
    {
        "content": "<p>Is the error message supposed to be produced?</p>",
        "id": 536817167,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756482532
    },
    {
        "content": "<p>Yes, the error message is supposed to be produced. This is part of the problem I wanted to fix.</p>",
        "id": 536817419,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756482610
    }
]