[
    {
        "content": "<p>A new release candidate for <a href=\"https://github.com/leanprover/elan/releases/tag/v4.0.0-rc1\">Elan 4.0.0</a> and a new Lean 4 VS Code extension pre-release version with support for Elan 4.0.0 are now available.</p>\n<h3>New features in Elan 4.0.0</h3>\n<ul>\n<li><strong>Eager toolchain resolution</strong>: Release channels like <code>leanprover/lean4:stable</code> or <code>leanprover/lean4:nightly</code> are now resolved to their current version when the corresponding release channel is used, not to the version that is currently installed. <ul>\n<li>This resolves a long-standing usability issue where many users would install <code>leanprover/lean4:stable</code> for their default toolchain when first installing Elan, which meant that commands like <code>lean</code> or <code>lake</code> outside of the scope of a Lean project would always use an old Lean version from when <code>leanprover/lean4:stable</code> was first installed.</li>\n<li>Eager toolchain resolution requires additional network accesses when using release channels and may also download a new Lean version when a release channel resolves to a version that is not installed. If <code>leanprover/lean4:stable</code> cannot be resolved to a new version (e.g. because there is no internet connection), Elan will fall back to the most recent installed Lean version for that release channel. Additionally, as described below, the Lean 4 VS Code extension now has additional support to control network accesses and downloads by Elan when using it from within VS Code.</li>\n</ul>\n</li>\n<li><strong>Unused toolchain garbage collection</strong>: Elan now supports new commands <code>elan toolchain gc</code> and <code>elan toolchain gc --delete</code> to delete unused toolchains. <ul>\n<li>The garbage collector is only triggered using these commands. </li>\n<li>A toolchain is considered 'used' by Elan if there is a local project using that toolchain and Elan 4.0.0+ has been used in it without the project being moved to a different filesystem location afterwards.</li>\n<li>Automation can use <code>elan toolchain gc --json</code> to query information from <code>elan toolchain gc</code>. The format can be found <a href=\"https://github.com/leanprover/elan/blob/417e1abbd6e24781dde778e2d75d51361378f242/src/elan-cli/elan_mode.rs#L460\">here</a>.</li>\n</ul>\n</li>\n<li><strong><code>elan dump-state [--no-net]</code></strong>: This new Elan command can be used by automation to extract information from Elan about toolchains.<ul>\n<li><code>--no-net</code> will force Elan to not resolve Lean release channels so that information about the current offline state of Elan can be extracted.</li>\n<li>The format can be found <a href=\"https://github.com/leanprover/elan/blob/417e1abbd6e24781dde778e2d75d51361378f242/src/elan-cli/json_dump.rs#L59\">here</a>.</li>\n</ul>\n</li>\n</ul>\n<h3>New features in Lean 4 VS Code extension pre-release 0.0.187</h3>\n<p>With all of these new features enabled by Elan 4.0.0, 0.0.187 of the Lean 4 VS Code extension provides the following new functionality:</p>\n<ul>\n<li><strong>Toolchain download confirmations</strong>: For users on a slow network connection or on a limited data plan, it can be quite frustrating that Elan in VS Code will start downloading a new toolchain whenever a project with a non-installed toolchain is accidentally opened. This issue is made more severe by the changes in Elan 4.0.0, as users often use <code>leanprover/lean4:stable</code> for their default toolchain, and so opening a new file in VS Code can initiate a download when a new stable Lean version is released. 0.0.187 resolves this issue by introducing a new '<em>Always Ask Before Installing Lean Versions</em>' VS Code setting that causes the Lean 4 VS Code extension to prompt users before installing a new Lean toolchain. If users decide not to install the new version, the Lean 4 VS Code extension will either use the most recent installed version for release channels or abort launching the language server otherwise.<ul>\n<li>'<em>Always Ask Before Installing Lean Versions</em>' is disabled by default to keep the behavior as close as possible to the current behavior. However, when installing or updating Elan using the Lean 4 VS Code extension, it will now display a prompt, asking whether users want to enable this setting.</li>\n<li>Even when '<em>Always Ask Before Installing Lean Versions</em>' is disabled, the Lean 4 VS Code extension will still prompt users when opening a file in VS Code will update the toolchain for a release channel like <code>leanprover/lean4:stable</code>. This ensures that the additional automatic downloads induced by eager toolchain resolution of Elan 4.0.0 are always optional in VS Code.</li>\n</ul>\n</li>\n<li><strong>VS Code command for manually updating the Lean version of a release channel</strong>: A new '<em>Setup: Update Release Channel Lean Version</em>' VS Code command can be used to manually update the Lean version of release channels. This is helpful if you have decided to not update an eagerly resolved Lean version for a release channel in VS Code in the current VS Code session, or if you simply want to update the Lean version of a release channel prematurely, before using the release channel in VS Code.</li>\n<li><strong>VS Code commands for selecting project and default toolchains</strong>: New '<em>Setup: Select Default Lean Version</em>' and '<em>Project: Select Project Lean Version</em>' VS Code commands can be used to select the default or the project Lean version. Both of these commands display dialogs that allow choosing a toolchain from all available toolchains (queried from <a href=\"https://release.lean-lang.org/\">https://release.lean-lang.org/</a>), not just the installed ones.</li>\n<li><strong>VS Code command for uninstalling Lean toolchains</strong>: A new '<em>Setup: Uninstall Lean Versions</em>' command can be used to uninstall installed toolchains. This command has support for the new garbage collector in Elan 4.0.0.</li>\n</ul>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Screenshots of new Lean 4 VS Code extension functionality</p>\n</div><div aria-hidden=\"true\" class=\"spoiler-content\">\n<p><a href=\"/user_uploads/3121/ir4TBSMBIrWvKHymz6Dgs5oE/Installation_Dialog.png\">Toolchain installation confirmation prompt</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ir4TBSMBIrWvKHymz6Dgs5oE/Installation_Dialog.png\" title=\"Toolchain installation confirmation prompt\"><img data-original-dimensions=\"528x190\" src=\"/user_uploads/thumbnail/3121/ir4TBSMBIrWvKHymz6Dgs5oE/Installation_Dialog.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/r48g_mvjqFhkeo4BmgfxZaP8/Update_Dialog.png\">Release channel update confirmation prompt</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/r48g_mvjqFhkeo4BmgfxZaP8/Update_Dialog.png\" title=\"Release channel update confirmation prompt\"><img data-original-dimensions=\"535x220\" src=\"/user_uploads/thumbnail/3121/r48g_mvjqFhkeo4BmgfxZaP8/Update_Dialog.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/4KkC1W9CoWU4o3f2K_g5K6Wa/New_Version_Management_Menu.png\">New 'Version Management' menu</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/4KkC1W9CoWU4o3f2K_g5K6Wa/New_Version_Management_Menu.png\" title=\"New 'Version Management' menu\"><img data-original-dimensions=\"724x500\" src=\"/user_uploads/thumbnail/3121/4KkC1W9CoWU4o3f2K_g5K6Wa/New_Version_Management_Menu.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/zJEdEwgCNI_0VMITdOtOhFlm/Release_Channel_Update_Dialog.png\">'Setup: Update Release Channel Lean Version' dialog</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/zJEdEwgCNI_0VMITdOtOhFlm/Release_Channel_Update_Dialog.png\" title=\"'Setup: Update Release Channel Lean Version' dialog\"><img data-original-dimensions=\"610x165\" src=\"/user_uploads/thumbnail/3121/zJEdEwgCNI_0VMITdOtOhFlm/Release_Channel_Update_Dialog.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/TdqsqfzFEolcN8LXPVnJu5dl/Default_Version_Dialog.png\">'Setup: Select Default Lean Version' dialog</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/TdqsqfzFEolcN8LXPVnJu5dl/Default_Version_Dialog.png\" title=\"'Setup: Select Default Lean Version' dialog\"><img data-original-dimensions=\"620x935\" src=\"/user_uploads/thumbnail/3121/TdqsqfzFEolcN8LXPVnJu5dl/Default_Version_Dialog.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/fKsbK4i17KaBTE8nrTIoIXnT/Version_Uninstall_Dialog.png\">'Setup: Uninstall Lean Versions' dialog</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/fKsbK4i17KaBTE8nrTIoIXnT/Version_Uninstall_Dialog.png\" title=\"'Setup: Uninstall Lean Versions' dialog\"><img data-original-dimensions=\"611x188\" src=\"/user_uploads/thumbnail/3121/fKsbK4i17KaBTE8nrTIoIXnT/Version_Uninstall_Dialog.png/840x560.webp\"></a></div></div></div>\n<h3>Testing Elan 4.0.0-rc1 and Lean 4 VS Code extension pre-release 0.0.187</h3>\n<p>All of these new features require significant changes to Elan and the Lean 4 VS Code extension, so we would be very grateful if you could help us test these changes before we release them to everyone.</p>\n<p>You can install the Lean 4 VS Code extension pre-release by right-clicking on the Lean 4 extension in the VS Code 'Extensions' menu and selecting 'Switch to Pre-Release Version': </p>\n<p><a href=\"/user_uploads/3121/BBEb8WYN_43fihd_9lJp-OEe/image.png\">Switching to a pre-release version</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/BBEb8WYN_43fihd_9lJp-OEe/image.png\" title=\"Switching to a pre-release version\"><img data-original-dimensions=\"1012x546\" src=\"/user_uploads/thumbnail/3121/BBEb8WYN_43fihd_9lJp-OEe/image.png/840x560.webp\"></a></div><p>0.0.187 is backwards-compatible with older Elan versions, so it should not cause any issues with Elan 3.1.1.</p>\n<p>After installing 0.0.187, you can install the Elan 4.0.0 pre-release by downloading the archive for your system from <a href=\"https://github.com/leanprover/elan/releases/tag/v4.0.0-rc1\">the Elan release page</a>, unpacking it and running the <code>elan-init</code> executable from the archive from the command line. After installing Elan 4.0.0-rc1, Elan will automatically delete some toolchains that use an outdated format from your <code>.elan</code> directory (specific stable and release candidate toolchains will not be removed).</p>\n<p>Once both 0.0.187 and Elan 4.0.0-rc1 are installed, you should be ready-to-go. Please report all new issues you encounter here so that we can fix them before releasing Elan 4.0.0 and the corresponding changes to the Lean 4 VS Code extension to everyone. Thanks!</p>",
        "id": 492510877,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1736344904
    },
    {
        "content": "<p>So does elan track all the local projects started with recent toolchains?</p>",
        "id": 493924465,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1736946995
    },
    {
        "content": "<p>Does this work for projects cloned from GitHub for instance? Or is it just projects that were created locally?</p>",
        "id": 493924582,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1736947031
    },
    {
        "content": "<p>It doesn't care about creation, only that you used a Lean toolchain with the project at least once</p>",
        "id": 493925315,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736947238
    },
    {
        "content": "<p>Could we put this to use and store Mathlib caches at the toolchain level?</p>",
        "id": 493925854,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1736947415
    },
    {
        "content": "<p>Currently we have math based project folders which are like 5GB</p>",
        "id": 493926032,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1736947466
    },
    {
        "content": "<p>Another question: how does elan know that a project that once used a toolchain stopped using it after toolchain updates?</p>",
        "id": 493926402,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1736947584
    },
    {
        "content": "<p>If you are interested in the implementation, the code shouldn't be too unreadable I hope</p>",
        "id": 493926609,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736947656
    },
    {
        "content": "<p>We are planning to release these changes around <time datetime=\"2025-01-30T13:00:00Z\">2025-01-30T14:00:00+01:00</time>, so pre-release testing will continue for another week.</p>",
        "id": 495228931,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1737536313
    },
    {
        "content": "<p>Both Elan 4.0.0 and 0.0.192 of the Lean 4 VS Code extension have been released. You can update Elan with the 'Setup: Update Elan' command in VS Code after restarting VS Code. </p>\n<p><a href=\"/user_uploads/3121/V_LhA9w1AKMuzMWFmphiQHn7/image.png\">Updating Elan</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/V_LhA9w1AKMuzMWFmphiQHn7/image.png\" title=\"Updating Elan\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"669x393\" src=\"/user_uploads/thumbnail/3121/V_LhA9w1AKMuzMWFmphiQHn7/image.png/840x560.webp\"></a></div><p>The Elan 4.0.0 changelog can be found <a href=\"https://github.com/leanprover/elan/blob/master/CHANGELOG.md#400---2025-01-30\">here</a> and the 0.0.192 VS Code extension changelog can be found <a href=\"https://github.com/leanprover/vscode-lean4/releases/tag/v0.0.192\">here</a>.</p>\n<p>Please let us know if you encounter any new issues on Elan 4.0.0 or 0.0.192 of the VS Code extension.</p>\n<p><strong>Note for tooling developers:</strong> Due to eager toolchain resolution in Elan 4.0.0, the <code>elan toolchain update</code> command has been removed, as it is not needed anymore.</p>",
        "id": 496778591,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1738244299
    },
    {
        "content": "<p>After updating the VS Code extension (which added the menu option \"Update Elan\") and clicking on \"Upadate Elan\", I got a pop-up window asking me if I want to be asked before downloading lean versions, which I denied. I then got an error</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Unable to write to User Settings because lean4.alwaysAskBeforeInstallingLeanVersions is not a registered configuration.\n</code></pre></div>\n<p>which I guess means that my answer was not recorded, but otherwise looks harmless...</p>",
        "id": 496779921,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738244714
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/270676-lean4/topic/Elan.204.2E0.2E0rc1.20.26.20Lean.204.20VS.20Code.20extension.20pre-release.200.2E0.2E187/near/496779921\">said</a>:</p>\n<blockquote>\n<p>After updating the VS Code extension (which added the menu option \"Update Elan\") and clicking on \"Upadate Elan\", I got a pop-up window asking me if I want to be asked before downloading lean versions, which I denied. I then got an error</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Unable to write to User Settings because lean4.alwaysAskBeforeInstallingLeanVersions is not a registered configuration.\n</code></pre></div>\n<p>which I guess means that my answer was not recorded, but otherwise looks harmless...</p>\n</blockquote>\n<p>Argh. Could you restart VS Code and check if the setting exists by opening the settings menu and pasting that identifier into the search?</p>",
        "id": 496780301,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1738244815
    },
    {
        "content": "<p>Also, did you restart VS Code before clicking the \"Update Elan\" button, or did you just click the \"Restart Extensions\" button?</p>",
        "id": 496781550,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1738245156
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/Elan.204.2E0.2E0rc1.20.26.20Lean.204.20VS.20Code.20extension.20pre-release.200.2E0.2E187/near/496781550\">said</a>:</p>\n<blockquote>\n<p>Also, did you restart VS Code before clicking the \"Update Elan\" button, or did you just click the \"Restart Extensions\" button?</p>\n</blockquote>\n<p>The latter. I can try restarting VS Code, but not now (I have an appointment in one minute...)</p>",
        "id": 496783110,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738245589
    },
    {
        "content": "<p>After closing VS Code and starting it again, it does find the relevant setting.</p>",
        "id": 496793075,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738248066
    },
    {
        "content": "<p>Thanks. I suspect what's going on here is that there's a VS Code bug related to the \"Restart Extensions\" button not correctly dealing with new configuration options. I've changed the description above to suggest a restart before updating Elan.</p>",
        "id": 496793355,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1738248141
    }
]