[
    {
        "content": "<p>In the definition of  <code>searchIn</code> I could not prove termination. I got the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">prove</span><span class=\"w\"> </span><span class=\"n\">termination</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">solutions</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`have</span><span class=\"bp\">`-</span><span class=\"n\">expressions</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">prove</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"n\">goals</span>\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`termination_by</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">specify</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">well</span><span class=\"bp\">-</span><span class=\"n\">founded</span><span class=\"w\"> </span><span class=\"n\">relation</span>\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`decreasing_by</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">specify</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">own</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">discharging</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"n\">h</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The code is my translation from the Haskell function from Sec 4.2 of <a href=\"https://www.cs.ox.ac.uk/publications/books/adwh/\">https://www.cs.ox.ac.uk/publications/books/adwh/</a>. It is a two dimension search problem. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">   </span><span class=\"k\">if</span><span class=\"w\">      </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">   </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">   </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {p} {p.1 + p.2}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {x} {y} {x^2 + 3^y}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div>\n<p>Any idea how can I proof termination for <code>searchIn</code>?</p>",
        "id": 474411827,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1727907654
    },
    {
        "content": "<p>I know that all <code>f</code> provided to this function need to be strictly increasing. But how to tell this to <code>searchIn</code>?</p>",
        "id": 474412567,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1727908047
    },
    {
        "content": "<p>If the monotonicity is required to obtain termination, you'll need to pass that as an argument to <code>searchIn</code>.</p>",
        "id": 474490215,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727936861
    },
    {
        "content": "<p>what's the point of the <code>y &lt; 0</code> check? it's a <code>Nat</code></p>",
        "id": 474536338,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727947463
    },
    {
        "content": "<p>Conversely, I am suspicious about the <code>y - 1</code>, it seems like this code was originally written using signed integers</p>",
        "id": 474536529,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727947527
    },
    {
        "content": "<p>The termination measure is wrong, I think you will have more luck with the termination measure <code>(t - x) + y</code></p>",
        "id": 474537116,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727947729
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 474537493,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727947851
    },
    {
        "content": "<p>I am curious to explore the limits here.. Thanks to <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> the termination problem is solved. But still, the haskell implementation is reported in the book to be able to find a solution for the input value 20259. I can't get 5 digits with the Lean code. I adapted the <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> code to use tail recursion, adding an extra accumulator parameter. Still, getting stackoverflow error for input 20259. </p>\n<p>I am running in MacOS, I added more stack limit with <code>ulimit -s 16384</code> but I am still getting </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ar</span><span class=\"bp\">/</span><span class=\"n\">r</span><span class=\"bp\">/</span><span class=\"n\">emap</span><span class=\"bp\">-</span><span class=\"mi\">20242</span><span class=\"bp\">-</span><span class=\"n\">ed</span><span class=\"bp\">/</span><span class=\"n\">fad</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"c1\">--version</span>\n<span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">5.0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"mi\">0</span><span class=\"n\">edf1ba</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.11</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">)</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">throwable</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">deep</span><span class=\"w\"> </span><span class=\"n\">recursion</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">interpreter'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">potential</span><span class=\"w\"> </span><span class=\"n\">solution</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">increase</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">space</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"o\">)</span>\n<span class=\"n\">interpreter</span><span class=\"w\"> </span><span class=\"n\">stacktrace</span><span class=\"o\">:</span>\n<span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">lambda_1</span>\n<span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">lambda_1</span><span class=\"bp\">._</span><span class=\"n\">boxed</span>\n<span class=\"bp\">...</span>\n<span class=\"bp\">#</span><span class=\"mi\">9535</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">searchIn</span>\n<span class=\"bp\">#</span><span class=\"mi\">9536</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">searchIn</span><span class=\"bp\">.</span><span class=\"n\">searchIn'</span>\n<span class=\"bp\">#</span><span class=\"mi\">9537</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">searchIn</span>\n<span class=\"bp\">#</span><span class=\"mi\">9538</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">searchIn</span><span class=\"bp\">.</span><span class=\"n\">searchIn'</span>\n<span class=\"bp\">#</span><span class=\"mi\">9539</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">searchIn</span>\n<span class=\"bp\">#</span><span class=\"mi\">9540</span><span class=\"w\"> </span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">D2</span><span class=\"bp\">.</span><span class=\"n\">search₁</span>\n<span class=\"bp\">#</span><span class=\"mi\">9541</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">lambda_2</span><span class=\"bp\">._</span><span class=\"n\">closed_2</span>\n<span class=\"bp\">#</span><span class=\"mi\">9542</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">lambda_2</span>\n<span class=\"bp\">#</span><span class=\"mi\">9543</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">lambda_2</span><span class=\"bp\">._</span><span class=\"n\">boxed</span>\n<span class=\"bp\">#</span><span class=\"mi\">9544</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">runEval</span><span class=\"bp\">._</span><span class=\"n\">at</span><span class=\"bp\">._</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">spec_1</span><span class=\"bp\">._</span><span class=\"n\">lambda_1</span>\n<span class=\"bp\">#</span><span class=\"mi\">9545</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">withIsolatedStreams</span><span class=\"bp\">._</span><span class=\"n\">at</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">runEval</span><span class=\"bp\">._</span><span class=\"n\">spec_1</span>\n<span class=\"bp\">#</span><span class=\"mi\">9546</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">runEval</span><span class=\"bp\">._</span><span class=\"n\">at</span><span class=\"bp\">._</span><span class=\"n\">eval</span><span class=\"bp\">._</span><span class=\"n\">spec_1</span>\n<span class=\"bp\">#</span><span class=\"mi\">9547</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span>\n\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">02</span><span class=\"o\">:</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">PM</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"w\"> </span><span class=\"n\">textDocument</span><span class=\"bp\">/</span><span class=\"n\">documentSymbol</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Message</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"bp\">///</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ar</span><span class=\"bp\">/</span><span class=\"n\">r</span><span class=\"bp\">/</span><span class=\"n\">emap</span><span class=\"bp\">-</span><span class=\"mi\">20242</span><span class=\"bp\">-</span><span class=\"n\">ed</span><span class=\"bp\">/</span><span class=\"n\">fad</span><span class=\"bp\">/</span><span class=\"n\">Fad</span><span class=\"bp\">/</span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">crashed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">likely</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">32902</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">02</span><span class=\"o\">:</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">PM</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"w\"> </span><span class=\"n\">textDocument</span><span class=\"bp\">/</span><span class=\"n\">foldingRange</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Message</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"bp\">///</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ar</span><span class=\"bp\">/</span><span class=\"n\">r</span><span class=\"bp\">/</span><span class=\"n\">emap</span><span class=\"bp\">-</span><span class=\"mi\">20242</span><span class=\"bp\">-</span><span class=\"n\">ed</span><span class=\"bp\">/</span><span class=\"n\">fad</span><span class=\"bp\">/</span><span class=\"n\">Fad</span><span class=\"bp\">/</span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">crashed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">likely</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">32902</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">02</span><span class=\"o\">:</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">PM</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Request</span><span class=\"w\"> </span><span class=\"n\">textDocument</span><span class=\"bp\">/</span><span class=\"n\">documentSymbol</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Message</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"bp\">///</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ar</span><span class=\"bp\">/</span><span class=\"n\">r</span><span class=\"bp\">/</span><span class=\"n\">emap</span><span class=\"bp\">-</span><span class=\"mi\">20242</span><span class=\"bp\">-</span><span class=\"n\">ed</span><span class=\"bp\">/</span><span class=\"n\">fad</span><span class=\"bp\">/</span><span class=\"n\">Fad</span><span class=\"bp\">/</span><span class=\"n\">Chapter4</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">crashed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">likely</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">Code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">32902</span>\n</code></pre></div>\n<p>The code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sofar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">   </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">   </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sofar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">     </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">    </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">     </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">sofar</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">     </span><span class=\"n\">searchIn'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {x} {y}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {x} {y}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">12</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2223</span>\n<span class=\"c1\">-- #eval search₁ (λ (x, y) =&gt; x^2 + 3^y) 20259</span>\n</code></pre></div>\n<p>I would be glad for ideas on how to handle the input 20259... Curious why Haskell can handle it.</p>",
        "id": 474628832,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1727971482
    },
    {
        "content": "<p>Currently lean doesn't handle mutual tail recursion. Inlining <code>searchIn'</code> avoids the need for the double <code>termination_by</code> and also makes the calls tail recursive</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sofar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">y'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">sofar</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">searchIn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">sofar</span>\n<span class=\"w\">  </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {x} {y}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"fun {x} {y}\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">12</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">search₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">20259</span>\n</code></pre></div>",
        "id": 474630907,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727971870
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I am also curious about the termination_by expressions you used. Why <code>(t + 1 - x, y, 1)</code> and <code>(t + 1 - x, y, 0)</code>. I know you are using the fact that Lean will employ sizeof of the triples as <code>decreasing measure</code>.. but why the last elements 1 and 0 for the tuples? I also noticed that without the <code>+ 1</code> in the first projection, Lean failed to proof <code>t - (x + 1) &lt; t - x</code>in the case <code>z &lt; t</code>, but I could not understand why.</p>",
        "id": 474631147,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1727971953
    },
    {
        "content": "<p>When you have a mutual recursion, all mutually defined functions have a <code>termination_by</code> producing an element of the same type, and calling any of the other functions requires proving that the measure for that function is less than your current value. Using <code>, 1</code> and <code>, 0</code> at the end of an existing termination measure allows <code>searchIn'</code> to call <code>searchIn</code> (nonrecursively) without really changing the main measure value, which is the semantics you want for abstracting a common pattern, in this case a match statement, which contains a call to a recursive function.</p>",
        "id": 474631994,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727972196
    },
    {
        "content": "<p>(Unfortunately this doesn't mesh well with tail recursion due to limitations of the code generator that aren't likely to change soon.)</p>",
        "id": 474632344,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727972317
    },
    {
        "content": "<p>Thank you.. where can I learn all of these? Silly question maybe...possible answer... \"keep working with Lean and with functional language implementation, near some 10k hours you will start to understand.\"</p>",
        "id": 474632520,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1727972380
    },
    {
        "content": "<p>Regarding your second question: to prove <code>t - (x + 1) &lt; t - x</code> you need to know that <code>x &lt; t</code>, which is not actually true in the given context. Adding an extra 1 means we only need to prove <code>x &lt; t + 1</code> which follows from the <code>!(x &gt; t)</code> assumption we have in context</p>",
        "id": 474632959,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727972502
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"121542\">Alexandre Rademaker</span> <a href=\"#narrow/stream/270676-lean4/topic/proof.20termination/near/474632520\">said</a>:</p>\n<blockquote>\n<p>Thank you.. where can I learn all of these? Silly question maybe...possible answer... \"keep working with Lean and with functional language implementation, near some 10k hours you will start to understand.\"</p>\n</blockquote>\n<p>What I just showed is a combination of several different skills:</p>\n<ol>\n<li>Knowing how to look at a function and figure out a termination measure</li>\n<li>Knowing how to adjust that termination measure to work with the things lean can do automatically (or insert termination proofs if it can't be done)</li>\n<li>General adjustments to fit lean semantics</li>\n<li>Knowing how the compiler actually lowers these to code, and common pitfalls that can occur when doing so</li>\n</ol>\n<p>(1) is mostly mathematics experience, (2) and (3) are lean proof experience, and (4) is experience you can get by either deep diving on the compiler a lot or answering questions on zulip from people like you who are confused why something stack overflows even though it looks tail recursive</p>",
        "id": 474633865,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727972765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"121542\">Alexandre Rademaker</span> has marked this topic as resolved.</p>",
        "id": 474634125,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727972848
    },
    {
        "content": "<p>I was expecting that it can be simpler... but I was wrong! Some direction on how to proof termination here?  The point is that <code>ys</code> or <code>zs</code> need to be necessarily smaller than <code>xs</code> but how to show it? </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">null</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ys</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">partition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 477021392,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729007889
    },
    {
        "content": "<p>That requires knowledge about what <code>List.partition</code> does, so while a bit unfortunate, I’m not surprised that this doesn't  go through automatically.</p>",
        "id": 477022236,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729008124
    },
    {
        "content": "<p>It seems we don’t have the necessary lemmas about <code>List.partition</code>. Guess one can go via <code>List.filter</code></p>\n<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> List.partition</p>",
        "id": 477022416,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729008176
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/List/Basic.html#List.partition\">List.partition</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/List/Lemmas.html#List.partition.eq_1\">List.partition.eq_1</a>, and <a href=\"https://loogle.lean-lang.org/?q=List.partition\">2 more</a></p>",
        "id": 477022421,
        "sender_full_name": "loogle",
        "timestamp": 1729008176
    },
    {
        "content": "<p>Oh, and you are <em>also</em> running into the issue that let-with-pattern-matching loses the connection to the RHS… oh wey</p>",
        "id": 477022581,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729008226
    },
    {
        "content": "<p>How about this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">null</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ys_zs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">partition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">ys_zs</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">ys_zs</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ys_zs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">partition_eq_filter_filter</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">length_filter_le</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one_of_le</span><span class=\"w\"> </span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 477023087,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729008365
    },
    {
        "content": "<p>Proving termination is still an increasing challenge in my attempt to translate the codes from <a href=\"https://www.cs.ox.ac.uk/publications/books/adwh/\">algorithms design in Haskell</a> to Lean. I'm embarrassed for not knowing earlier that <code>termination_by</code> and <code>decreasing_by</code> could be used together. I didn't know about the <code>all_goals</code> tactic either, but that is less problematic. Regarding the theorems for <code>partition</code> and <code>filter</code> in <code>Init.Data.List.Lemmas</code>, I simply couldn’t find them because they are not close to the definition of <code>List.partition</code> in <code>Init.Data.List.Basic</code>.</p>",
        "id": 477026808,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729009474
    },
    {
        "content": "<p>Oh, I just saw that loogle could have helped me to find one of the theorems.</p>",
        "id": 477027089,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729009565
    },
    {
        "content": "<p><span aria-label=\"exclamation\" class=\"emoji emoji-2757\" role=\"img\" title=\"exclamation\">:exclamation:</span> &lt;input&gt;:1:6: expected end of input</p>",
        "id": 477027091,
        "sender_full_name": "loogle",
        "timestamp": 1729009566
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span></p>",
        "id": 477027342,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729009654
    },
    {
        "content": "<p>BTW, This is my second time facing these hidden limitations, such as <code>let-with-pattern-matching loses the connection to the RHS.</code> I also learn some limitations with local definitions in <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20proof.20termination\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/.E2.9C.94.20proof.20termination</a></p>",
        "id": 477030122,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729010591
    },
    {
        "content": "<p>I found these lemmas using <a href=\"https://loogle.lean-lang.org/\">loogle</a>. Searching for <code>List.partition</code> gave me the first hint, and then <code>List.filter, List.length</code> was my second query.</p>",
        "id": 477030126,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729010592
    },
    {
        "content": "<p>For the let-with-patterns issue, see <a href=\"https://github.com/leanprover/lean4/issues/5216\">https://github.com/leanprover/lean4/issues/5216</a> for a discussion.</p>",
        "id": 477030296,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729010647
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"121542\">Alexandre Rademaker</span> has marked this topic as resolved.</p>",
        "id": 477040224,
        "sender_full_name": "Notification Bot",
        "timestamp": 1729013889
    },
    {
        "content": "<blockquote>\n<p>Oh, and you are <em>also</em> running into the issue that let-with-pattern-matching loses the connection to the RHS… oh wey</p>\n</blockquote>\n<p>Concerning let-patterns, would there be any use in carrying equality hypothesises from the match functions generated by let-patterns ? <br>\nWhen adding <code>h : </code>in the match <a href=\"https://github.com/leanprover/lean4/blob/edecf3d4baa30ef9a74d6af78a754d88c30b4386/src/Lean/Elab/Binders.lean#L760\">here</a> and <a href=\"https://github.com/leanprover/lean4/blob/edecf3d4baa30ef9a74d6af78a754d88c30b4386/src/Lean/Elab/Binders.lean#L763\">here</a>, the following code works (albeit lacks some automation, and I also lack good proving practices):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ys</span><span class=\"o\">,</span><span class=\"n\">zs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">partition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkTree</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span><span class=\"cm\">  x : Nat</span>\n<span class=\"cm\">        xs ys zs : List Nat</span>\n<span class=\"cm\">        h✝ : List.partition (fun x_1 =&gt; decide (x_1 &lt; x)) xs = (ys, zs)</span>\n<span class=\"cm\">      ⊢ ys.length &lt; (x :: xs).length-/</span>\n<span class=\"w\">    </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"n\">h₂</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"n\">h₁</span><span class=\"o\">,</span><span class=\"bp\">&lt;-</span><span class=\"n\">h₂</span><span class=\"o\">,</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">partition_eq_filter_filter</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">length_filter_le</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one_of_le</span><span class=\"o\">]</span><span class=\"bp\">```</span>\n</code></pre></div>\n<p>Perhaps adding an (innacessible) equality variable could help prove termination of such functions automatically ?</p>",
        "id": 477062883,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1729022939
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"432410\">@Arthur Adjedj</span> , I didn't understand. In your code, where is the name <code>h :</code> introduced?  I am assuming <code>rename_i</code> is a tactic from Mathlib, right?</p>",
        "id": 477065858,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1729024246
    },
    {
        "content": "<p>I guess my question was more directed at <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> regarding <a href=\"https://github.com/leanprover/lean4/pull/5216\">lean4#5216</a>. I added the <code>h : </code> in the Lean 4 code <a href=\"https://github.com/leanprover/lean4/blob/edecf3d4baa30ef9a74d6af78a754d88c30b4386/src/Lean/Elab/Binders.lean#L760\">linked</a> above before recompiling the repo locally to test if it would be any useful in your example, it is not a fix for your current use-case.<br>\n<code>rename_i</code> is a tactic that allows you to access variable names generated automatically by Lean such as the <code>h✝</code> present in the context at the beginning, you don't need any import to access it.</p>",
        "id": 477066534,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1729024514
    },
    {
        "content": "<p>I think we were worried about the performance impact of having lots of possible large equations in the context, especially when this appears in “normal” functional programming, and given that some tactics (like <code>cases</code>) like to modify the full context. It seemed safer to stick to the status quo for now</p>",
        "id": 477078727,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729030160
    }
]