[
    {
        "content": "<p>The following code contains two variants of <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/Tactic/Calc.lean#L19\">https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/Tactic/Calc.lean#L19</a>. The first one simply removes some code that is not relevant to the question. Unsurprisingly the corresponding <code>Calc</code> tactic show an error message when there is an unknown variable in the code. Then the <code>Balc</code> tactic has exactly the same code but wrapped into a <code>try … catch e =&gt; throw e</code>. This time the error message disappears and we only get a sorry. How could I fix that?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Calc\"</span><span class=\"w\"> </span><span class=\"n\">calcSteps</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Calc</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">steps</span><span class=\"o\">:</span><span class=\"n\">calcSteps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">closeMainGoalUsing</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">checkNewUnassigned</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withTacticInfoContext</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">mkCalcStepViews</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">consumeMData</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withCollectingNewGoalsFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parentTag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tagSuffix</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">runTermElab</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabCalcSteps</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"c1\">-- Immediately the right type, no need for further processing.</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n\n<span class=\"w\">        </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">ensureHasTypeWithErrorMsgs</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">mkImmedErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">mkErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">pushGoals</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n\n<span class=\"sd\">/-- error: Unknown identifier `x` -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">Calc</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">         </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Balc\"</span><span class=\"w\"> </span><span class=\"n\">calcSteps</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Balc</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">steps</span><span class=\"o\">:</span><span class=\"n\">calcSteps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">closeMainGoalUsing</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">checkNewUnassigned</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">withTacticInfoContext</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">mkCalcStepViews</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">consumeMData</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withCollectingNewGoalsFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parentTag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tagSuffix</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">runTermElab</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabCalcSteps</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"c1\">-- Immediately the right type, no need for further processing.</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n\n<span class=\"w\">          </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">ensureHasTypeWithErrorMsgs</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">mkImmedErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">mkErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">pushGoals</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"sd\">/-- warning: declaration uses 'sorry' -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">Balc</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">         </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 573146011,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1770756183
    },
    {
        "content": "<p>Of course in my real code I’d like to try more things in the <code>catch</code> part, but still being able to throw <code>e</code> (and get the error message) when it fails.</p>",
        "id": 573146173,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1770756238
    },
    {
        "content": "<p>What's going on here is that <code>Term.throwCalcFailure</code> is merely <em>logging</em> the informative error that you want to keep, and the actual error it throws (which is caught by <code>catch</code>) is an internal error, from e.g. <code>throwAbortTerm</code>. If you write <code>catch e =&gt; logInfo m!\"{e.toMessageData}\"; throw e</code> instead, you can see from the logged message that <code>e</code> is <code>internal exception #4</code>. That is, <code>e</code> does not contain these errors you see; the messages in the tactic state do, and <code>try</code>/<code>catch</code> is rewinding that state when it catches the error.</p>\n<p>I believe you might have to resort to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.tryCatch#doc\">docs#Lean.Elab.Tactic.tryCatch</a>, which is just a regular function that does non-backtracking try/catch. Then you can manage state manually like so (replace the <code>Balc</code> <code>elab_rules</code> in your code above):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Balc</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">steps</span><span class=\"o\">:</span><span class=\"n\">calcSteps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">    </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">tryCatch</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"c1\">-- same code...</span>\n<span class=\"w\">      </span><span class=\"n\">closeMainGoalUsing</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">checkNewUnassigned</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">withTacticInfoContext</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">mkCalcStepViews</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">consumeMData</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withCollectingNewGoalsFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parentTag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tagSuffix</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`calc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">runTermElab</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabCalcSteps</span><span class=\"w\"> </span><span class=\"n\">steps</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">valType</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">              </span><span class=\"c1\">-- Immediately the right type, no need for further processing.</span>\n<span class=\"w\">              </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n\n<span class=\"w\">            </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">ensureHasTypeWithErrorMsgs</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">mkImmedErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">mkErrorMsg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">throwCalcFailure</span><span class=\"w\"> </span><span class=\"n\">steps</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"n\">pushGoals</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"c1\">-- ...until here.</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e₁</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"c1\">-- save the state created by the failure, which has error messages</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">failureState</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">        </span><span class=\"n\">try</span>\n<span class=\"w\">          </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"c1\">-- restore the initial state to start fresh</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">          </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Oh no, a second time!\"</span>\n<span class=\"w\">        </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">e₂</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"c1\">-- in the case of a second failure restore state of first failure and throw that error</span>\n<span class=\"w\">          </span><span class=\"n\">failureState</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">e₁</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>You may need to make your nested <code>try</code>/<code>catch</code> a <code>Tactic.tryCatch</code> if you want to save state from there as well! And you may want to do things like merge your two exceptions or messages.</p>\n<p>Technically the second <code>try</code>/<code>catch</code> will save and restore <code>failureState</code> automatically. But I wanted to make it clear what's going on, and give you the chance to adjust it to another <code>Tactic.tryCatch</code> if you need to.</p>\n<p>Note also that this is partly because you're in <code>TacticM</code>. You might be aware that there's quite unfortunate inconsistency among do notation <code>try</code>/<code>catch</code>: <code>TacticM</code>'s <code>try</code>/<code>catch</code> backtracks, restoring the state, but in other monads like <code>MetaM</code> it won't.</p>",
        "id": 573157870,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770760699
    },
    {
        "content": "<p><del>(EDIT: hang on, I think I copied the wrong code, or made an edit somewhere...)</del> ah, nevermind, all is well.</p>",
        "id": 573158347,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770760863
    },
    {
        "content": "<p>Thanks a lot Thomas! I had partly understood what was going on but couldn’t fix it. Your solution also seems to work in my real code.</p>",
        "id": 573232023,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1770800757
    }
]