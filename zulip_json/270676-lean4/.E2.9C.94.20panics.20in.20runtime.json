[
    {
        "content": "<p>I want to collect examples of unsafe lean code and ideas how to fix it</p>\n<h1>Example 1</h1>\n<p>Correct <a href=\"https://live.lean-lang.org/#codez=CYUwZgBGCWBGD2A7AhgY1dCAKREBcEAcsgC4CU+EAggE43ICeRp+AvBAJLAB0NArrmDwAUBDEQANiBIQAtnxkxYlWvSbEZedqsbdZAawCisgA4kmiUeKVsocbib4BnABYQADFbE2td2A+c3AEYvKHgaCExoXABtACY8RABdCCFQv1slANdsJRjoJIBCCABqP3yAWjiislCaaT4aXBthYQBiEAA3ZAk/JDQMCAAWIA\">fibonacci is</a> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fibonacci</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkEmpty</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fib</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">fib</span>\n</code></pre></div>\n<p>But if replace <code>fib[i-1]!</code> with <code>fib[i]!</code> - no warning and error in runtime </p>\n<p>How to fix?</p>",
        "id": 504966789,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741730645
    },
    {
        "content": "<p>For instance, instead of using <code>[i-1]!</code>, you can use <code>[i-1]</code> and then Lean will tell you what it is that you are supposed to prove.</p>",
        "id": 504967962,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741731042
    },
    {
        "content": "<p>How do you like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">dfold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">       </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">init</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dfold</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">accumulate</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">dfold</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fibonacci</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">accumulate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">])</span>\n</code></pre></div>",
        "id": 504975663,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741733472
    },
    {
        "content": "<p>Notice in the actual definition all the array indexing is checked at compile time.</p>",
        "id": 504975734,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741733499
    },
    {
        "content": "<p>(Obviously here <code>Nat.dfold</code> would need a csimp lemma with a tail-recursive implementation.)</p>",
        "id": 504975855,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741733534
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20is.20unsafe/near/504975734\">said</a>:</p>\n<blockquote>\n<p>Notice in the actual definition all the array indexing is checked at compile time.</p>\n</blockquote>\n<p>I don't like that lean doesn't show any warnings or errors </p>\n<ol>\n<li>In purescript we have <a href=\"https://pursuit.purescript.org/packages/purescript-partial/4.0.0\">https://pursuit.purescript.org/packages/purescript-partial/4.0.0</a></li>\n<li>In idris2 we have <a href=\"https://idris2.readthedocs.io/en/latest/tutorial/theorems.html#totality-checking\">total</a> (<a href=\"https://idris2.readthedocs.io/en/latest/reference/pragmas.html#default\">covering is a default</a>)</li>\n</ol>\n<p>Both of them will throw errors/warn if inside programmer is using partial functions</p>",
        "id": 505002371,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741744229
    },
    {
        "content": "<p>Todo for me: prove that mixing <code>let mut</code> and <code>IO</code> is not safe <a href=\"https://github.com/purescript/purescript-st/tree/master/src/Control/Monad/ST\">(this is why St monad exists in purescript)</a></p>",
        "id": 505004161,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741744939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">serhii khoma (srghma)</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20is.20unsafe/near/505002371\">said</a>:</p>\n<blockquote>\n<p>I don't like that lean doesn't show any warnings or errors</p>\n</blockquote>\n<p>I don't understand what you mean. My code shouldn't show any warnings or errors, because there is nothing unsafe about it.</p>\n<p>If you change your original code to use <code>xs[i]</code> rather than <code>xs[i]!</code>, then Lean will show errors because it can't prove the array indexing is correct.</p>",
        "id": 505014602,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741748720
    },
    {
        "content": "<p>I suspect this person's complaint is that using the <code>xs[i]!</code> syntax doesn't warn the user that they're operating in an \"unsafe\" mode where runtime errors may occur.</p>",
        "id": 505017851,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1741750129
    },
    {
        "content": "<p>Personally I think that the exclamation mark in the syntax is warning enough, but that's just me...</p>",
        "id": 505017954,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1741750177
    },
    {
        "content": "<p>Yes, I don't understand what the request is. Is the request that <code>xs[i]!</code> always generates a warning which you have to explicitly suppress before committing code? That would be a bad idea.</p>",
        "id": 505019187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741750685
    },
    {
        "content": "<p><del>I don't see a warning when I open the original example in <code>live.lean-lang.org</code>...</del></p>\n<p><strong>Edit:</strong> Thanks for the edit, I see how I misread your original comment.</p>",
        "id": 505019421,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1741750789
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"380294\">Matt Diamond</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20is.20unsafe/near/505017851\">said</a>:</p>\n<blockquote>\n<p>I suspect this person's complaint is that using the <code>xs[i]!</code> syntax doesn't warn the user that they're operating in an \"unsafe\" mode where runtime errors may occur.</p>\n</blockquote>\n<p>How can I prove that none of dependencies of my function <code>foo</code> use <code>xs[i]!</code>? How can I prove that my function <code>foo</code> is total? In idris2 I can AFAIU by marking my function <code>foo</code> with <code>total</code></p>",
        "id": 505019582,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741750842
    },
    {
        "content": "<p>Remember that <code>xs[i]!</code> means \"take the i-th element if it is in range, otherwise use the default value, but panic at runtime\".</p>",
        "id": 505019827,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741750938
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/BppcciXCQP3e2eoG2Yxav2C2/Screenshot_20250312-110204_Kiwi-Browser.jpg\">Screenshot_20250312-110204_Kiwi Browser.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/BppcciXCQP3e2eoG2Yxav2C2/Screenshot_20250312-110204_Kiwi-Browser.jpg\" title=\"Screenshot_20250312-110204_Kiwi Browser.jpg\"><img data-original-content-type=\"image/jpeg\" data-original-dimensions=\"999x1876\" src=\"/user_uploads/thumbnail/3121/BppcciXCQP3e2eoG2Yxav2C2/Screenshot_20250312-110204_Kiwi-Browser.jpg/840x560.webp\"></a></div><p><a href=\"/user_uploads/3121/VKbCOiWzBbepHEQRJN9R7PnY/Screenshot_20250312-110414_Kiwi-Browser.jpg\">Screenshot_20250312-110414_Kiwi Browser.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/VKbCOiWzBbepHEQRJN9R7PnY/Screenshot_20250312-110414_Kiwi-Browser.jpg\" title=\"Screenshot_20250312-110414_Kiwi Browser.jpg\"><img data-original-content-type=\"image/jpeg\" data-original-dimensions=\"1235x1920\" src=\"/user_uploads/thumbnail/3121/VKbCOiWzBbepHEQRJN9R7PnY/Screenshot_20250312-110414_Kiwi-Browser.jpg/840x560.webp\"></a></div>",
        "id": 505023162,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741752365
    },
    {
        "content": "<p>I mean, I kinda get what they're talking about. I don't think they want a warning, but rather they want a <code>partial</code> notation on any function which may potentially panic at runtime, and any function that calls a <code>partial</code> function must itself be declared <code>partial</code> unless it calls it with special <code>unsafePartial</code> syntax. That's how Purescript does it.</p>\n<p>I think the answer might just be \"Lean isn't Purescript\". <span aria-label=\"man shrugging\" class=\"emoji emoji-1f937-200d-2642\" role=\"img\" title=\"man shrugging\">:man_shrugging:</span></p>\n<p>(Lean does have <code>partial</code> functions but they don't work like that.)</p>",
        "id": 505023305,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1741752443
    },
    {
        "content": "<p>Why not mark <code>[]!</code> with <code>unsafe</code>? That would make <code>fibonacci</code> <code>unsafe</code> too - problem solved</p>\n<p><a href=\"https://github.com/leanprover/lean4/blob/2952cf81e6089626f96321b44307d2222bc74d03/doc/lean3changes.md?plain=1#L268\">https://github.com/leanprover/lean4/blob/2952cf81e6089626f96321b44307d2222bc74d03/doc/lean3changes.md?plain=1#L268</a></p>",
        "id": 505026594,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741754127
    },
    {
        "content": "<p>The definition you linked defines safety in terms of logical soundness, your example doesn't implicate soundness issues. <code>[]!</code> is defined in the logic as returning a default element on failure. </p>\n<p>If you want guarantees about the correctness of your code you should prove characterizing lemmas, which would have revealed the error here because of the way <code>[]!</code> is defined.</p>",
        "id": 505030016,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1741755714
    },
    {
        "content": "<p>tnx</p>\n<blockquote>\n<p><code>[]!</code> is defined in the logic as returning a default element on failure. </p>\n</blockquote>\n<p><del>in logic/types - returns 0, in fact/in runtime - throws error?</del></p>\n<p>yes, misunderstood, it returns 0</p>\n<p><span class=\"user-mention silent\" data-user-id=\"228466\">Chris Bailey</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20is.20unsafe/near/505030016\">said</a>:</p>\n<blockquote>\n<p><code>[]!</code> is defined in the logic as returning a default element on failure. </p>\n</blockquote>\n<p>what lemma could find this error? Forall numbers fib returns some number?</p>",
        "id": 505051311,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741765297
    },
    {
        "content": "<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">][</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\">    </span><span class=\"c1\">-- Nat.zero</span>\n</code></pre></div>",
        "id": 505052935,
        "sender_full_name": "suhr",
        "timestamp": 1741765858
    },
    {
        "content": "<p>Panics seem to be an ugly part of Lean since their runtime behavior mismatch the model and there seems to be no way to check if code is panic-free.</p>",
        "id": 505054506,
        "sender_full_name": "suhr",
        "timestamp": 1741766352
    },
    {
        "content": "<p>It would be nice to have at least a lint for panics like there's a lint for <code>sorry</code>es.</p>",
        "id": 505054762,
        "sender_full_name": "suhr",
        "timestamp": 1741766424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"394485\">suhr</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20is.20unsafe/near/505054506\">said</a>:</p>\n<blockquote>\n<p>Panics seem to be an ugly part of Lean since their runtime behavior mismatch the model</p>\n</blockquote>\n<p>Did you test that?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">][</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\">    </span><span class=\"c1\">-- 0</span>\n</code></pre></div>",
        "id": 505063213,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741768954
    },
    {
        "content": "<p>Yes, there is an additional message. You can consider this a runtime lint. Yes, a compile-time lint could also be an option. I don't think there is an RFC for it yet. Also, the environment variable <code>LEAN_ABORT_ON_PANIC</code> is available if you do want the semantics to diverge.</p>",
        "id": 505063532,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741769042
    },
    {
        "content": "<p>By the way, LEAN_ABORT_ON_PANIC does not seem to be documented anywhere.</p>",
        "id": 505071190,
        "sender_full_name": "suhr",
        "timestamp": 1741771075
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394485\">@suhr</span>, could you open a <code>doc-request</code> issue at <a href=\"https://github.com/leanprover/reference-manual/issues\">https://github.com/leanprover/reference-manual/issues</a>?</p>",
        "id": 505085790,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741774578
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/reference-manual/issues/340\">Done.</a></p>",
        "id": 505095119,
        "sender_full_name": "suhr",
        "timestamp": 1741776958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">serhii khoma (srghma)</span> has marked this topic as resolved.</p>",
        "id": 505287590,
        "sender_full_name": "Notification Bot",
        "timestamp": 1741827940
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"813382\">@serhii khoma (srghma)</span> I'm curious, did you find the original implementation of <code>fibonacci</code> here <a href=\"https://lecopivo.github.io/scientific-computing-lean/Working-with-Arrays/#Scientific-Computing-in-Lean--Working-with-Arrays\">https://lecopivo.github.io/scientific-computing-lean/Working-with-Arrays/#Scientific-Computing-in-Lean--Working-with-Arrays</a> by any chance? Maybe I should pick a different example to demonstrate imperative code in Lean. Maybe something more aligned with scientific computing like matrix multiplication.</p>",
        "id": 505290507,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741829130
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> yes, fibonacci is from there. No, all is ok, the only suggestion is maybe to add \"<code>[]!</code> will not throw any error if element is not found, instead it will return <code>default</code>(<code>0</code>) and print a warning\"</p>",
        "id": 505374429,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1741860170
    }
]