[
    {
        "content": "<p>in trying to write tests for my fix for <a href=\"https://github.com/leanprover/lean4/pull/4246\">lean4#4246</a>, i've been repeatedly running into <a href=\"https://github.com/leanprover/lean4/pull/6544\">lean4#6544</a>, so i decided to investigate, and it turns out that this is caused by the fact that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.getFVarSetToGeneralize#doc\">docs#Lean.Meta.getFVarSetToGeneralize</a> purposefully does not generalize instimplicit arguments. Can someone explain why this is?</p>",
        "id": 512285351,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744713564
    },
    {
        "content": "<p>CC: <span class=\"user-mention\" data-user-id=\"112857\">@Leonardo de Moura</span> who wrote this (4 years ago)?</p>",
        "id": 512285831,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744713718
    },
    {
        "content": "<p>i imagine a fix might look like adding a second option argument for <code>getFVarSetToGeneralize</code> saying wether to ignore instance-implicit fvars, which is set to false in <code>Lean.Elab.Tactic.generalizeVars</code> (it's a private def) but true in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.getFVarsToGeneralize#doc\">docs#Lean.Meta.getFVarsToGeneralize</a></p>",
        "id": 512287599,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744714319
    },
    {
        "content": "<p>update: this <em>does</em> run into issues...</p>",
        "id": 512330958,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726129
    },
    {
        "content": "<p>in particular, for some reason this causes the following to generate a goal <code>Decidable P</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>",
        "id": 512331387,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726239
    },
    {
        "content": "<p>That's a bad induction principle</p>",
        "id": 512331565,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726278
    },
    {
        "content": "<p>(it's in the lean test suite)</p>",
        "id": 512331633,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726296
    },
    {
        "content": "<p>I think it should be changed to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n</code></pre></div>",
        "id": 512331692,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726309
    },
    {
        "content": "<p>The test couldn't have been written that way before because it wasn't supported</p>",
        "id": 512331889,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726341
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/blob/master/tests/lean/run/394.lean\">see for yourself</a></p>",
        "id": 512332424,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726454
    },
    {
        "content": "<p>Yes, I'm saying that what you're proposing is a behavior change, and when you make such changes sometimes tests have to change</p>",
        "id": 512332570,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726489
    },
    {
        "content": "<p>the behaviour change i'm proposing shouldn't change this behaviour though? i think?</p>",
        "id": 512332706,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726523
    },
    {
        "content": "<p>I would recommend you change the test as above and see if anything else breaks</p>",
        "id": 512332960,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726579
    },
    {
        "content": "<p>Whether changing the test is ok can wait till review</p>",
        "id": 512333003,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726590
    },
    {
        "content": "<p>btw, i think the principle you're proposing here won't work, since the fix for <a href=\"https://github.com/leanprover/lean4/pull/6544\">lean4#6544</a> is separate from the fix for <a href=\"https://github.com/leanprover/lean4/pull/4246\">lean4#4246</a> , so lean will complain it can't figure out the implicit target</p>",
        "id": 512333703,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726744
    },
    {
        "content": "<p>I think probably I'm claiming that the two things are morally the same bug</p>",
        "id": 512334481,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726906
    },
    {
        "content": "<p>(they're not)</p>",
        "id": 512334525,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744726918
    },
    {
        "content": "<p>My claim is that instance binders are not currently generalized because if they were, <code>induction</code> would not know how to populate them</p>",
        "id": 512334664,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744726943
    },
    {
        "content": "<p>i think one of us is missing a key part here, in that as far as i can tell, <a href=\"https://github.com/leanprover/lean4/pull/4246\">lean4#4246</a> is about instance <em>targets</em>, not all instance arguments to induction</p>",
        "id": 512335077,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727043
    },
    {
        "content": "<p>also, the goal <code>Decidable P</code> strangely does not contain the instance that existed before</p>",
        "id": 512335462,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727146
    },
    {
        "content": "<p>so there is something really strange going on there</p>",
        "id": 512335492,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727155
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512335462\">said</a>:</p>\n<blockquote>\n<p>also, the goal <code>Decidable P</code> strangely does not contain the instance that existed before</p>\n</blockquote>\n<p>What's the full goal state after the <code>induction</code> line?</p>",
        "id": 512336221,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744727328
    },
    {
        "content": "<p>with the following snippet:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>\n<p>at the third <code>admit</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">inst</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>",
        "id": 512336444,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727394
    },
    {
        "content": "<p>which is <em>really weird</em> to me</p>",
        "id": 512336560,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727413
    },
    {
        "content": "<p>time to dive into the induction implementation again, i guess</p>",
        "id": 512336710,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727454
    },
    {
        "content": "<p>Just to check, does the alternative test I suggested pass?</p>",
        "id": 512338762,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744727940
    },
    {
        "content": "<p>or actually, it makes sense? since the goal gets changed to <code>[Decidable P] -&gt; ¬¬P → P</code> (because we're generalizing the instance), if you then try to use <code>induction P using casesTFOn</code>, you're indeed missing the needed instance</p>",
        "id": 512338960,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744727999
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512336444\">said</a>:</p>\n<blockquote>\n<p>with the following snippet:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>\n<p>at the third <code>admit</code>:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">inst</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>On the web editor this gives me \"no goals\"</p>",
        "id": 512339239,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744728065
    },
    {
        "content": "<p>yea, like i said, this is an issue on my branch where i try to fix <a href=\"https://github.com/leanprover/lean4/pull/6544\">lean4#6544</a></p>",
        "id": 512339382,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728100
    },
    {
        "content": "<p>oh sorry didn't see</p>",
        "id": 512339420,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744728111
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512338762\">said</a>:</p>\n<blockquote>\n<p>Just to check, does the alternative test I suggested pass?</p>\n</blockquote>\n<p>the alternative test you wrote doesn't compile the induction principle even on current lean</p>",
        "id": 512339869,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728220
    },
    {
        "content": "<p>Oh, you should have told me sooner!</p>",
        "id": 512340863,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744728435
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- TODO: replace `(_ : Decidable P)` with `[Decidable P]`</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">‹</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">›</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">H</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">H</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‹_›</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>",
        "id": 512340879,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744728438
    },
    {
        "content": "<p>yea, that works</p>",
        "id": 512341066,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728480
    },
    {
        "content": "<p>Does it work on your branch with <code>[]</code> instead of <code>(_ :)</code>?</p>",
        "id": 512341157,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744728491
    },
    {
        "content": "<p>no, <code>failed to infer implicit target</code></p>",
        "id": 512341300,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728526
    },
    {
        "content": "<p>Ok, same failure as head then</p>",
        "id": 512341422,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744728552
    },
    {
        "content": "<p>anywho, i think that actually lean ideally should decide to <em>not</em> revert <code>Decidable P</code> here...</p>",
        "id": 512341935,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728653
    },
    {
        "content": "<p>the question is, what is a good decision procedure to decide if one should or shouldnt revert this? (btw, i'm guessing lean would have a similar issue with normal implicit arguments on current lean)</p>",
        "id": 512342226,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728716
    },
    {
        "content": "<p>let me see if i can throw together an example</p>",
        "id": 512342385,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728740
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">inst</span><span class=\"o\">:</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 512342979,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744728873
    },
    {
        "content": "<p>i guess this is a result of the fact that these kinds of arguments are \"extra\": they're not major premises/targets, they're not minor premises, and they're not the motive...</p>",
        "id": 512343513,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744729001
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512331387\">said</a>:</p>\n<blockquote>\n<p>in particular, for some reason this causes the following to generate a goal <code>Decidable P</code>:</p>\n</blockquote>\n<p>I think this is not the intended behavior because the <code>motive</code> does not mention <code>Decidable P</code>...</p>",
        "id": 512349985,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744730455
    },
    {
        "content": "<p>I would say this is induction on <code>Decidable P</code></p>",
        "id": 512352178,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744730956
    },
    {
        "content": "<p>But it's not mentioned in the motive</p>",
        "id": 512352234,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744730972
    },
    {
        "content": "<p>What's the criteria for determining the premises/targets?</p>",
        "id": 512352292,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744730986
    },
    {
        "content": "<p>if you have an induction principle, match on the type it eliminates into; the head symbol is the motive; all other arguments to the motive in this type are the targets</p>",
        "id": 512358481,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744732654
    },
    {
        "content": "<p>the minor premises are the arguments to the induction principle which eliminate into <code>motive</code></p>",
        "id": 512358768,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744732720
    },
    {
        "content": "<p>the major premises are the targets</p>",
        "id": 512358795,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744732730
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512358768\">said</a>:</p>\n<blockquote>\n<p>the minor premises are the arguments to the induction principle which eliminate into <code>motive</code></p>\n</blockquote>\n<p>Explain?</p>",
        "id": 512359125,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744732816
    },
    {
        "content": "<p>I've decided to read the code, so I can figure out this confusing behavior</p>",
        "id": 512359304,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744732869
    },
    {
        "content": "<p>take the induction principle for <code>Nat</code>. it looks like <code>natinduction : (motive : Nat -&gt; Sort u) -&gt; (zero : motive 0) -&gt; (succ : ((n' : Nat) -&gt; motive n' -&gt; motive (n' + 1)) -&gt; (n : Nat) -&gt; motive n</code></p>",
        "id": 512359489,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744732906
    },
    {
        "content": "<p>So the motive is <code>motive</code>, and the targets are <code>[n]</code></p>",
        "id": 512359665,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744732956
    },
    {
        "content": "<p>What are the major and minor premises?</p>",
        "id": 512359759,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744732984
    },
    {
        "content": "<p>the principle eliminates into <code>motive n</code>. the head symbol is called the motive, <code>motive</code>. its arguments  (just <code>n</code> in this case) are the major premises, which is another word for targets. the arguments <code>zero</code> and <code>succ</code> are the minor premises, since they eliminate into <code>motive 0</code> and <code>motive (n' + 1)</code> respectively.</p>",
        "id": 512359846,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744733013
    },
    {
        "content": "<p>oh i get it now</p>",
        "id": 512359957,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744733038
    },
    {
        "content": "<p>The major premise is what you're inducting on and the minor premise is the induction cases</p>",
        "id": 512360179,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744733093
    },
    {
        "content": "<p>so the question is: given some context + some goal, how do you determine what variables should become part of the motive (i.e. be <code>revert</code>ed or <code>generalize</code>d), and which variables shouldn't?</p>",
        "id": 512360879,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744733291
    },
    {
        "content": "<p>What's wrong with the way it's being done right now?</p>",
        "id": 512361513,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744733466
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512341935\">said</a>:</p>\n<blockquote>\n<p>anywho, i think that actually lean ideally should decide to <em>not</em> revert <code>Decidable P</code> here...</p>\n</blockquote>\n<p>Can you give a before and after of what you want <code>induction</code> to do?</p>",
        "id": 512361976,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744733598
    },
    {
        "content": "<p>the same as what it does on current lean, in this case</p>",
        "id": 512362099,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744733633
    },
    {
        "content": "<p>but there are other cases where i <em>do</em> want lean to generalize a free variable, and i'm not sure yet what criterion to use to decide between these</p>",
        "id": 512362705,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744733801
    },
    {
        "content": "<p>Here's what I got on the current Lean.</p>\n<p>Before:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>After:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">T</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">True</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">F</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">False</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">inst</span>\n<span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>assignment</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">?</span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">inst</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">inst</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">inst</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span>\n</code></pre></div>",
        "id": 512364417,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744734262
    },
    {
        "content": "<p>ah wait, that's not right</p>",
        "id": 512364530,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744734294
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512331387\">said</a>:</p>\n<blockquote>\n<p>in particular, for some reason this causes the following to generate a goal <code>Decidable P</code>:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>for <em>this</em>, it should behave the same as on current lean</p>",
        "id": 512364631,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744734329
    },
    {
        "content": "<p>Maybe it helps to note that this fails on current lean:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>",
        "id": 512366969,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744734927
    },
    {
        "content": "<p>So I really think <code>casesTFOn</code> is garbage</p>",
        "id": 512367323,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744735033
    },
    {
        "content": "<p>This also fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_true</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">ht</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">eq_false</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">casesTFOn</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>",
        "id": 512367417,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744735061
    },
    {
        "content": "<p>It works if you add the <code>Decidable P</code> as a target</p>",
        "id": 512370420,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744735956
    },
    {
        "content": "<p>You might still get a <code>failed to infer implicit target</code> though</p>",
        "id": 512370622,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744736026
    },
    {
        "content": "<p>Do you mean <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512340879\">like this</a>?</p>",
        "id": 512384707,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744740414
    },
    {
        "content": "<p>I think I have a solution: call arguments to an induction principle <em>semitargets</em> if their type depends on a target. Then, have all explicit targets and semitargets passed to <code>induction</code>. At the point where these would be <code>revert</code>ed, instead do something which behaves like <code>refine (?_ : semitargettype -&gt; ?_) semitarget</code> (but in the language of metaprogramming) such that the semitargets stay available to the current scope, but they also become available in the appropriate form when proving the minor premises.</p>",
        "id": 512405496,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744747839
    },
    {
        "content": "<p>I'll try implementing this tomorrow</p>",
        "id": 512405524,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744747854
    },
    {
        "content": "<p>(then generalizing any non-(semi)target will be blocked)</p>",
        "id": 512405653,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744747896
    },
    {
        "content": "<p>Maybe it's worth mentioning how <code>@[elab_as_elim]</code> works. It has similar considerations.</p>\n<p>Here's how it handles things (see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.getElabElimExprInfo#doc\">docs#Lean.Elab.Term.getElabElimExprInfo</a>):</p>\n<ol>\n<li>The \"motive\" is the head variable of the return type.</li>\n<li>The  \"motive fvars\" consist of all the variables that appear in the return type and (transitively) every variable that appears in the type of a motive fvar.</li>\n<li>A \"major argument\" is any variable that's not the motive and either (1) it's a motive fvar or (2) its type contains a motive fvar and every application in the type is a constant application (it's a \"first-order argument\")</li>\n<li>Then, every other argument is a \"minor argument\".</li>\n</ol>\n<p>Then the elaborator takes the following steps:</p>\n<ol>\n<li>The major arguments are all elaborated.</li>\n<li>The motive is computed from the expected type.</li>\n<li>The minor arguments are elaborated.</li>\n</ol>\n<p>The purpose of all this is to be able to elaborate enough in (1) to be able to get enough information to successfully compute the motive in (2), before elaborating all the other arguments, which likely need a motive to be successful in (3).</p>\n<p>Possibly it would have worked to simply say that the minor arguments are those whose types contain the motive variable.</p>\n<p>The terminology doesn't line up with <code>induction</code> (for example every type parameter is a \"major argument\" according to <code>@[elab_as_elim]</code>), but maybe there's something useful to think about here</p>\n<p>It's not clear to me that <code>getFVarSetToGeneralize</code> itself is the culprit (though, disclosure, I haven't investigated the issue). It might be that the way <code>using</code> clauses are elaborated needs rethinking. The handling of eliminators has undergone evolution over a number of years.</p>",
        "id": 512409809,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744749676
    },
    {
        "content": "<p>how can a motive fvar not occur as argument to the motive though??</p>",
        "id": 512410273,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744749853
    },
    {
        "content": "<p>i don't see what kind of motive could have that...</p>",
        "id": 512410385,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744749904
    },
    {
        "content": "<p>When there's an argument that appears in the type of an argument that appears in the return type.</p>",
        "id": 512413055,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744750982
    },
    {
        "content": "<p>so the principle can be something like <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>?</p>",
        "id": 512413385,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744751112
    },
    {
        "content": "<p>i guess that makes sense</p>",
        "id": 512413512,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744751164
    },
    {
        "content": "<p>Sure, that would make <code>a</code> be a \"major argument\" for <code>@[elab_as_elim]</code>.</p>\n<p>This is also possible: <code>(a:A) -&gt; (motive : (a' : A) -&gt; b a' -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>. It too will include <code>a</code> as something that needs to be elaborated before computing the motive.</p>",
        "id": 512413664,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751233
    },
    {
        "content": "<p>The motivation is that to be able to find all <code>x</code>'s in the expected type you should elaborate <code>x</code>, but to elaborate <code>x</code>, you should know its type, so you should elaborate <code>a</code>.</p>",
        "id": 512413833,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751293
    },
    {
        "content": "<p>the <code>a</code> from my example would be a \"motive fvar\" too, right?</p>",
        "id": 512414084,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744751409
    },
    {
        "content": "<p>Yes, both in your example and mine.</p>",
        "id": 512414670,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751673
    },
    {
        "content": "<p>the key difference is that in my example it is only because of the transitive considerations</p>",
        "id": 512414788,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744751728
    },
    {
        "content": "<p>In yours its for two reasons: it appears in the type of <code>x</code> which appears in the return type, and because it appears in the <code>motive</code> argument's type.</p>",
        "id": 512414795,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751732
    },
    {
        "content": "<p>In mine it's only for the first reason. (Both reasons are due to transitivity.)</p>",
        "id": 512414845,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751758
    },
    {
        "content": "<p>your example seems to be missing an argument to the final <code>motive</code></p>",
        "id": 512414986,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744751811
    },
    {
        "content": "<p>Oh yeah, you're right. That's a simple case then, no transitivity.</p>",
        "id": 512415294,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744751952
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512413385\">said</a>:</p>\n<blockquote>\n<p>so the principle can be something like <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>?</p>\n</blockquote>\n<p>I think for this case you can only induction on <code>x</code> and <code>a</code> is always fixed. If user want to do induction on <code>a</code> it should throws an error.</p>",
        "id": 512449546,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744771729
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"366779\">Jz Pan</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512449546\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512413385\">said</a>:</p>\n<blockquote>\n<p>so the principle can be something like <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>?</p>\n</blockquote>\n<p>I think for this case you can only induction on <code>x</code> and <code>a</code> is always fixed. If user want to do induction on <code>a</code> it should throws an error.</p>\n</blockquote>\n<p>This is actually really common. Take for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.induction#doc\">docs#Finset.induction</a>, that starts with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>which fits the pattern described above.</p>",
        "id": 512524640,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744801476
    },
    {
        "content": "<p>yea, that's fair. i also realised the same for <code>List.rec</code> and similar</p>",
        "id": 512524784,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744801512
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512524640\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"366779\">Jz Pan</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512449546\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512413385\">said</a>:</p>\n<blockquote>\n<p>so the principle can be something like <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>?</p>\n</blockquote>\n<p>I think for this case you can only induction on <code>x</code> and <code>a</code> is always fixed. If user want to do induction on <code>a</code> it should throws an error.</p>\n</blockquote>\n<p>This is actually really common. Take for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.induction#doc\">docs#Finset.induction</a>, that starts with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>which fits the pattern described above.</p>\n</blockquote>\n<p>In that case the <code>α</code> is fixed and cannot be changed during the proof of <code>Finset.induction</code>, since the <code>α</code> is not appeared as an input of <code>motive</code>. Like <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code> you cannot vary <code>a</code> during the proof, since <code>a</code> is not appeared as an input of <code>motive</code>. If you want to vary <code>a</code> you must  use <code>(a:A) -&gt; (motive : (a' : A) -&gt; b a' -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code>. The compiler should not implicitly prepend an <code>a' : A</code> to the <code>motive</code> for the former case.</p>",
        "id": 512556117,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744810738
    },
    {
        "content": "<p>you mean <code>(a:A) -&gt; (motive : (a' : A) -&gt; b a' -&gt; Sort) -&gt; (x: b a) -&gt; motive a x</code> in that second case, right?</p>",
        "id": 512558032,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744811234
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/270676-lean4/topic/lean4.236544.20.3A.20induction.20does.20not.20generalize.20instance.20argument/near/512558032\">said</a>:</p>\n<blockquote>\n<p>you mean <code>(a:A) -&gt; (motive : (a' : A) -&gt; b a' -&gt; Sort) -&gt; (x: b a) -&gt; motive a x</code> in that second case, right?</p>\n</blockquote>\n<p>Yes, I mean only in this case you can vary <code>a</code> in the motive. For <code>(a:A) -&gt; (motive : b a -&gt; Sort) -&gt; (x: b a) -&gt; motive x</code> the <code>induction</code> should always generate goals for the fixed <code>a</code>.</p>",
        "id": 512563609,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744812668
    },
    {
        "content": "<p>or, well, as much as the value of <code>motive</code> depends on it</p>",
        "id": 512563865,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744812728
    },
    {
        "content": "<p>Although the value <code>b a</code> of <code>motive</code> depends on <code>a</code>, but <code>a</code> does not appear as an input of <code>motive</code> which means that the <code>a</code> in <code>motive</code> is fixed and can never be changed... Just like thinking <code>motive</code> as a closure (<code>a</code> is in the closure) function which has only one argument, instead of a function taking two arguments.</p>",
        "id": 512564568,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744812914
    },
    {
        "content": "<p>As an example here <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/How.20to.20write.20induction.20principle.20for.20modules/near/511892053\">#mathlib4 &gt; How to write induction principle for modules @ 💬</a>  although some properties for <code>M</code> depends on <code>A</code>, but when I write <code>motive</code> in that way I mean the <code>A</code> is always fixed as the input <code>A</code> in the induction principle theorem, and can never be changed; I don't want <code>induction</code> principle generates goals with varying <code>A</code>.</p>",
        "id": 512565021,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744813033
    }
]