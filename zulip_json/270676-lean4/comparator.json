[
    {
        "content": "<p>Has anyone gotten the <a href=\"https://github.com/leanprover/comparator\">comparator</a> to work when <code>Quot.sound</code> is involved?  I am trying to figure out whether <a href=\"https://github.com/leanprover/comparator/issues/1\"><code>uncaught exception: (kernel) unknown constant 'Eq'</code></a> is a bug in the compartor, lean4export, or lean4checker</p>",
        "id": 564793202,
        "sender_full_name": "Jason Gross",
        "timestamp": 1766192600
    },
    {
        "content": "<p>I've previously used comparator to check results from Mathlib so it is certainly possible yes,  lean4export also manages to correctly export Quot.sound from the module based from a cursory look at its output so I would suspect that this is an issue with the replay system from lean4checker. Though also a very specific issue because only in the very minimal configurations that you use does <code>Eq</code> not get added through some other mean before <code>Quot.sound</code> pops up eventually.</p>",
        "id": 564795294,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766195593
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> if something in the lean4checker codebase regarding dependencies of axioms comes to mind.</p>",
        "id": 564795587,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766196022
    },
    {
        "content": "<p>Sorry, can't think of anything. I'm not sure what \"the very minimal configurations that you use\" is referring to, but maybe it is out of the intended scope of these tools? :-)</p>",
        "id": 564914160,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766349309
    },
    {
        "content": "<p>It very much is in scope.  It refers to the very small theorem that Jason is trying to check:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"n\">hpq</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">hpq</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n</code></pre></div>\n<p>Comparator will load both the theorem as well as all of the allowed axioms (including <code>Quot.sound</code>) and their dependencies into lean4checker. It appears that usually <code>Eq</code> happens to be addded before <code>Quot.sound</code> through some other dependency path but in this specific situation that does not end up being the case.</p>",
        "id": 564914727,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766349954
    },
    {
        "content": "<p>At least when I print both the output from <code>lean4export</code> and the list of declarations that comparator sends to lean4checker I can clearly see that <code>Eq</code> is being sent</p>",
        "id": 564914865,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766350095
    },
    {
        "content": "<p>I see. I was wondering (since <code>Quot.sound</code> is involved <em>everywhere</em>) if perhaps there was some alternative prelude being used.</p>",
        "id": 564917273,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766353913
    },
    {
        "content": "<p>Repro at <a href=\"https://github.com/kim-em/scratch-comparator-unknown-constant\">https://github.com/kim-em/scratch-comparator-unknown-constant</a></p>",
        "id": 564918134,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766355347
    },
    {
        "content": "<p>Fix at <a href=\"https://github.com/leanprover/lean4checker/pull/79\">https://github.com/leanprover/lean4checker/pull/79</a></p>",
        "id": 564918838,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766356506
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>, if you could update the require statement in <code>comparator</code>?</p>",
        "id": 564919187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766357019
    },
    {
        "content": "<p>Will do</p>",
        "id": 564919254,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766357132
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> do you want to update the version tag or do I just put the raw commit here?</p>",
        "id": 564919477,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766357504
    },
    {
        "content": "<p>Is it okay to just use a raw commit until we release the v4.27.0 or v4.28.0-rc1 tags?</p>",
        "id": 564920865,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766359413
    },
    {
        "content": "<p>Alternatively, we could add a v4.27.0-rc1+patch1 tag</p>",
        "id": 564920883,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766359443
    },
    {
        "content": "<p>Sure, just wanted to make sure</p>",
        "id": 564921374,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766360111
    },
    {
        "content": "<p>I tried to use a comparator, but it throws an exception on this theorem statement. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">nonzero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<blockquote>\n<p>uncaught exception: Const not found in target 'IsLeftRegular'</p>\n</blockquote>\n<p>However, it works fine when I remove [NeZero t] in the statement. Any advice?</p>",
        "id": 573116873,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770747546
    },
    {
        "content": "<p>Can you please provide a full <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> here</p>",
        "id": 573117452,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1770747710
    },
    {
        "content": "<p>something like <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0BBdAcwFMsokcBxKCAVzAHVg0AtYmnAORQCge1i0YiDgA7CKID6AL3YQ4AClFx4ALjiBUQgCUcANqdibGioC6cVTzgAGOAB4V5gLxwAztCgBPHkA\">this</a></p>",
        "id": 573117977,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770747864
    },
    {
        "content": "<p>I have this in the config file. The Challenge.lean and Solution.lean are identical to the mwe above. <br>\n{<br>\n  \"challenge_module\": \"Challenge\",<br>\n  \"solution_module\": \"Solution\",<br>\n  \"theorem_names\": [\"nonzero\"],<br>\n  \"permitted_axioms\": [<br>\n    \"propext\", \"Quot.sound\", \"Classical.choice\", \"sorryAx\"<br>\n  ],<br>\n  \"enable_nanoda\": false<br>\n}</p>",
        "id": 573118305,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770747961
    },
    {
        "content": "<p>When I try to debug in Compare.lean,  I found that the following condition is true (when I insert it in line 43) , which triggers an exception. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">solution</span><span class=\"bp\">.</span><span class=\"n\">constMap</span><span class=\"o\">[</span><span class=\"n\">target</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">challenge</span><span class=\"bp\">.</span><span class=\"n\">constMap</span><span class=\"o\">[</span><span class=\"n\">target</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>",
        "id": 573119232,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770748233
    },
    {
        "content": "<p>I think this is most likely going to be an issue with the new parser that we introduced</p>",
        "id": 573119815,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1770748403
    },
    {
        "content": "<p>I see. Thanks.</p>",
        "id": 573120125,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770748493
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"759386\">@Sorrachai Yingchareonthawornchai</span> fixed in <a href=\"https://github.com/leanprover/comparator/pull/16\">https://github.com/leanprover/comparator/pull/16</a> it was a slightly overzealous behavior that got uncovered because <code>lean4export</code> got more careful with what actually needs to be exported.</p>",
        "id": 573123253,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1770749450
    },
    {
        "content": "<p>Thank you very much</p>",
        "id": 573150862,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1770757898
    },
    {
        "content": "<p>A quick question. Is it possible to run the comparator without sandboxing (e.g., with an additional flag)?</p>",
        "id": 574536994,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1771428639
    },
    {
        "content": "<p>No that is not possible. Why do you need that?</p>",
        "id": 574537920,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771428897
    },
    {
        "content": "<p>Is sandboxing the only thing stopping it from working on Windows (and maybe macOS)?</p>",
        "id": 574611868,
        "sender_full_name": "James E Hanson",
        "timestamp": 1771451984
    },
    {
        "content": "<p>Everything else is compiled from Lean code, so it should be, right?</p>",
        "id": 574612126,
        "sender_full_name": "James E Hanson",
        "timestamp": 1771452082
    },
    {
        "content": "<p>My first intuition would be yes</p>",
        "id": 574613061,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771452410
    },
    {
        "content": "<p>You said before that comparator is basically where you want it to be feature-wise, but I had wondered in the past whether it might make sense to split it into something that produces an export JSON from a sandboxed environment and something that compares an export JSON against a goal.</p>\n<p>I guess one issue with this approach might be that the export format seems to be pretty space inefficient?</p>",
        "id": 574616152,
        "sender_full_name": "James E Hanson",
        "timestamp": 1771453714
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> ! I'm trying to integrate Comparator as the final verification gate for my AI benchmark (<a href=\"http://asiprize.com\">asiprize.com</a>) which runs models against the 297 unsolved conjectures in DeepMind's formal-conjectures repo. The repo pins Lean 4.22.0 and Comparator is on 4.29.0-rc1  is there a path to running Comparator against proofs built on 4.22.0 or do I need to wait for the repo to upgrade?</p>",
        "id": 574779926,
        "sender_full_name": "Austin Hatfield",
        "timestamp": 1771520886
    },
    {
        "content": "<p>You can try in principle to just set the toolchain to 4.22 but I wouldn't rely on it. Waiting for things to upgrade is likely the better way. That said if they are pinned to 4.22 they haven't updated in half a year by now so maybe this requires some pressure from your side rather than just waiting.</p>",
        "id": 574780444,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771521029
    },
    {
        "content": "<p><code>formal-conjectures</code> is on <a href=\"https://github.com/google-deepmind/formal-conjectures/blob/main/lean-toolchain\">v4.27.0</a>, so it's on the latest stable as of yesterday...</p>",
        "id": 574786313,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1771522424
    },
    {
        "content": "<p>Yes, we merged the bump PR a few hours ago</p>",
        "id": 574786547,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1771522495
    },
    {
        "content": "<p>Oh, merging without squashing gives the misleading impression that the bump happened multiple weeks ago.</p>",
        "id": 574786780,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1771522566
    },
    {
        "content": "<p>Sorry for this. We had to <em>not</em> squash due to a limitation of our internal tools</p>",
        "id": 574787074,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1771522668
    },
    {
        "content": "<p>Thank you Floris, Yael, Henrik - the version bump is exactly what I needed for the v2 benchmark. Really appreciate the quick responses!</p>",
        "id": 574790342,
        "sender_full_name": "Austin Hatfield",
        "timestamp": 1771523745
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/comparator/near/574537920\">said</a>:</p>\n<blockquote>\n<p>No that is not possible. Why do you need that?</p>\n</blockquote>\n<p>Since I already have a sandbox (docker) I'm running it in and landrun sandbox adds unnecessary complexity?</p>",
        "id": 574795879,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1771525447
    },
    {
        "content": "<p>The sandbox of comparator is not meant to protect your system from malicious code. It's meant to protect itself from exploits. For example, suppose you are running in dual kernel mode with nanoda and the built-in kernel. An attacker could simply add a meta program to their file that replaces the nanoda binary with one that always says accept, thus reducing the level of trust provided by Comparator. Thus giving up on the sandboxing functionality is not really negotiatable. If anything the sandbox is still <em>too loose</em>.</p>",
        "id": 574797190,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771525917
    },
    {
        "content": "<p>In general, the whole architecture of Comparator is built around defense in depth. Even if you manage to find a way to break assumptions that were made during development, it should be as hard as possible to turn these issues into a functioning exploit.</p>",
        "id": 574798066,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771526215
    }
]