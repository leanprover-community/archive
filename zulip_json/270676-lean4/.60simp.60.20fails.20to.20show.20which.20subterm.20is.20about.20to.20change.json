[
    {
        "content": "<p>Here is my example, I couldn't minimise it further:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Delaborators</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mem_foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extracted_3</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mem_foo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">and_imp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>I expected the <code>simp</code> call to highlight some subterm of <code>h</code> (maybe the whole term) in red in the infoview, but it highlights nothing here. What's going on?</p>",
        "id": 471989523,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1726966515
    },
    {
        "content": "<p>I think that the change is in something that is not visible: if you add <code>set_option pp.all true</code> before the theorem, you will see a diff.</p>",
        "id": 472009273,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726980626
    },
    {
        "content": "<p>Here is an example where even <code>pp.all</code> is not enough:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n</code></pre></div>\n<p>In this case, I think that it is just a metavariable being instantiated.</p>",
        "id": 472009501,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726980771
    },
    {
        "content": "<p>I'm not quite sure this explains it, because the subterm that it gets changed _to_ is shown, in green, as expected.</p>",
        "id": 472045881,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727010628
    },
    {
        "content": "<p>I suspect that what is happening is that the range that gets highlighted green (the \"after\") does not contain the <code>m ≤ m</code>, but that this part gets highlighted as it is \"part of the range of the previous <code>Expr</code>\".  The rest of the diff in the <del>pretty printer</del>infoview is probably just a pretty-printed difference, not an actual <code>Expr</code> difference, so there is nothing to show in the \"before\".</p>\n<p>Maybe?  I am really not too sure, but I have already had some difficulty in the past understanding what are the \"good\" ranges that the exprDiff displays.</p>",
        "id": 472049786,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727014266
    },
    {
        "content": "<p>If you add <code>attribute [-delab] PiNotation.delabPi</code> then you can see red in the before state <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span>.</p>\n<p>I think the issue is that the widget diff operates on raw expressions rather than pretty printer output, and to succeed it has to predict how things will be pretty printed.</p>\n<p>Some solutions:</p>\n<ul>\n<li>All pretty printers need to be aware of the pre-calculated diffs and do work to decide how they will surface the diffs, like perhaps not pretty printing using the <code>∀ m ∈ foo 0, m ≤ m</code> binder notation if it means being able to show the diff properly.</li>\n<li>Do a post-pretty-printing calculation that checks whether there are \"unaccounted for\" diffs. Every pretty printed syntax has an expression and source position associated to it, and we could associate the diffs to the closest parent expression that has pretty printed syntax.</li>\n</ul>",
        "id": 472070444,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727028865
    },
    {
        "content": "<p>Ah okay, this explanation makes a lot more sense to me! Thanks.</p>",
        "id": 472464408,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727175531
    }
]