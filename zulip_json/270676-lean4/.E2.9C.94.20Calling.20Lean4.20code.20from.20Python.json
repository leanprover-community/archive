[
    {
        "content": "<p>Hello,</p>\n<p>I need to call Lean4 code from Python. If you know of existing projects that do so (like <a href=\"https://github.com/leanprover-community/lean-client-python\">https://github.com/leanprover-community/lean-client-python</a>) or simple examples to look at, could you please share them? Thanks.</p>",
        "id": 451782827,
        "sender_full_name": "John Tristan",
        "timestamp": 1721142899
    },
    {
        "content": "<p>Given that python can call C code you can use Lean's C FFI to achieve this if you want to. But there's no Pre existing thing for this AFAIK.</p>",
        "id": 451788864,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721144143
    },
    {
        "content": "<p>That's fine. I was just trying to understand <a href=\"https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi\">https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi</a> to see how this would work. Do you know what <code>defaultFacets := #[LeanLib.sharedFacet]</code> does in <a href=\"https://github.com/leanprover/lean4/blob/master/src/lake/examples/reverse-ffi/lib/lakefile.lean\">https://github.com/leanprover/lean4/blob/master/src/lake/examples/reverse-ffi/lib/lakefile.lean</a>?</p>",
        "id": 451791064,
        "sender_full_name": "John Tristan",
        "timestamp": 1721144624
    },
    {
        "content": "<p>It instructs lake to build a share object for that library I would guess. \"facet\" is the lake term for a generic build step.</p>",
        "id": 451797805,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721146101
    },
    {
        "content": "<p>What are you trying to achieve? If you interested only in proving theorems (i.e. calling tactics in Python and receiving proof states from Lean) you could check <a href=\"https://github.com/lean-dojo/LeanDojo\">LeanDojo</a>.</p>",
        "id": 451798421,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1721146211
    },
    {
        "content": "<p>I'm trying to call Lean4 code but I'll take a look at LeanDojo out of curiosity anyway, thanks</p>",
        "id": 451800972,
        "sender_full_name": "John Tristan",
        "timestamp": 1721146723
    },
    {
        "content": "<p>Here is an example project doing reverse FFI with mathlib <a href=\"https://github.com/lecopivo/ReverseFFIwithMathlib\">https://github.com/lecopivo/ReverseFFIwithMathlib</a> I would look also at this <a href=\"#narrow/stream/270676-lean4/topic/reverse.20FFI.3A.20building.20a.20.22fat.22.20static.20library.3F\">thread</a></p>",
        "id": 451806339,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1721147979
    },
    {
        "content": "<p>Using the Python <code>ctypes</code> package, I'm able to load <code>libInit_shared.dylib</code> and <code>libleanshared.dylib</code> (I'm on a mac), but then when I try to load my own shared library, I get the following error: <code>OSError: dlopen([...]/libleanffi.dylib, 0x0006): symbol not found in flat namespace '_lean_internal_panic'</code> Am I missing a shared library?</p>",
        "id": 451828614,
        "sender_full_name": "John Tristan",
        "timestamp": 1721153978
    },
    {
        "content": "<p><code>lean_internal_panic</code> should exist in libleanshared but I wouldn't know where the additional underscore could come from</p>",
        "id": 451841577,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721157799
    },
    {
        "content": "<p>I do indeed find it in libleanshared, with the underscore (maybe it's a mac thing):<br>\n00000000033aabe4 T _lean_internal_panic</p>",
        "id": 451842115,
        "sender_full_name": "John Tristan",
        "timestamp": 1721157920
    },
    {
        "content": "<p>And I can call it from Python without the underscore (it works)</p>",
        "id": 451842919,
        "sender_full_name": "John Tristan",
        "timestamp": 1721158092
    },
    {
        "content": "<p>It looks like this problem really has nothing to do with Lean :)</p>",
        "id": 451843028,
        "sender_full_name": "John Tristan",
        "timestamp": 1721158117
    },
    {
        "content": "<p>Indeed. For reference, solution: <a href=\"https://stackoverflow.com/questions/78343245/error-loading-libmpich-dylib-using-python-ctypes-on-macos\">https://stackoverflow.com/questions/78343245/error-loading-libmpich-dylib-using-python-ctypes-on-macos</a></p>",
        "id": 451843998,
        "sender_full_name": "John Tristan",
        "timestamp": 1721158339
    },
    {
        "content": "<p>I do run into another issue, which I think is Lean-related this time (I think I'm not using Lake the right way). In my Lean code, I have an export </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">Discrete_Gaussian_Sample</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DiscreteGaussianSample</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 451847166,
        "sender_full_name": "John Tristan",
        "timestamp": 1721159284
    },
    {
        "content": "<p>In my lakefile, I use the option <code>defaultFacets := #[LeanLib.sharedFacet]</code></p>",
        "id": 451847289,
        "sender_full_name": "John Tristan",
        "timestamp": 1721159331
    },
    {
        "content": "<p>Building does produce a shared library, but I don't understand what's in it</p>",
        "id": 451847427,
        "sender_full_name": "John Tristan",
        "timestamp": 1721159370
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">0000000000008028</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">G_initialized</span>\n<span class=\"mi\">0000000000008020</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">dyld_private</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">initialize_Init</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">initialize_SampCert_Samplers_Gaussian_Code</span>\n<span class=\"mi\">0000000000000638</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">initialize_Samplers</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">lean_alloc_small</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">lean_dec_ref_cold</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"n\">dyld_stub_binder</span>\n</code></pre></div>",
        "id": 451847490,
        "sender_full_name": "John Tristan",
        "timestamp": 1721159392
    },
    {
        "content": "<p>My exported definition is not there, nor its dependencies, and there are undefined symbols. Am I using the wrong facet?</p>",
        "id": 451847694,
        "sender_full_name": "John Tristan",
        "timestamp": 1721159453
    },
    {
        "content": "<p>Are SampCert and Samplers two different Lake libraries? Which one is the export in?</p>",
        "id": 451856656,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721162207
    },
    {
        "content": "<p>SampCert is the name of the package, and Samplers is one of the library entry in my lakefile</p>",
        "id": 451856719,
        "sender_full_name": "John Tristan",
        "timestamp": 1721162240
    },
    {
        "content": "<p>But the export is not directly in Samplers?</p>",
        "id": 451857116,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721162361
    },
    {
        "content": "<p>I'm assuming the above are the symbols of libSamplers</p>",
        "id": 451857388,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721162415
    },
    {
        "content": "<p>No, it is imported. If I redefine it in Samplers.lean, then I can see that it is indeed included in the library, but the definition is undefined. It seems like this is related to the thread that Tomas mentioned, and I need an option to have all the definitions transitively fetched from the imported modules?</p>",
        "id": 451857560,
        "sender_full_name": "John Tristan",
        "timestamp": 1721162463
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/270676-lean4/topic/Calling.20Lean4.20code.20from.20Python/near/451857388\">said</a>:</p>\n<blockquote>\n<p>I'm assuming the above are the symbols of libSamplers</p>\n</blockquote>\n<p>If you ignore what's imported, it may indeed be the case.</p>",
        "id": 451857952,
        "sender_full_name": "John Tristan",
        "timestamp": 1721162552
    },
    {
        "content": "<p>So how it should work is that each definition is defined as a symbol in its library's shlib and any references to it from other shlibs are undefined symbols there. So your symbol should exist, just maybe not in the library you were looking at</p>",
        "id": 451858356,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721162659
    },
    {
        "content": "<p>OK! I just tried again but defining the facet for my package library, and now it seems to contain everything</p>",
        "id": 451858632,
        "sender_full_name": "John Tristan",
        "timestamp": 1721162721
    },
    {
        "content": "<p>However, I would rather not construct and load lots and lots of shared libraries. Is there an option for the facet so that it finds all the dependencies and puts everything in one shared library?</p>",
        "id": 451861970,
        "sender_full_name": "John Tristan",
        "timestamp": 1721163513
    },
    {
        "content": "<p>Ok yes, that would be the referenced  <a href=\"https://github.com/leanprover/lean4/pull/4271\">lean#4271</a></p>",
        "id": 451867478,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721165708
    },
    {
        "content": "<p>Until that lands, it might be easier to create the desired shlib yourself from the static libs created by Lake</p>",
        "id": 451867940,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721165858
    },
    {
        "content": "<p>I was able to load a few of the dynamic libraries from Python (qq, aesop, cli, batteries, proofwidgets) but not the one for importgraph. Loading complains that it cannot find symbol <code>_l_Lake_Manifest_load_x3f</code>. I can find this symbol in <code>libLake.a</code>, but libLake.a doesn't seem to have a dynamic version. Is there a reason for this?</p>",
        "id": 451891584,
        "sender_full_name": "John Tristan",
        "timestamp": 1721173174
    },
    {
        "content": "<p>For many use cases, <a href=\"https://github.com/leanprover-community/repl\">Lean REPL</a> should do very well.</p>",
        "id": 451928234,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1721189971
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221511\">John Tristan</span> <a href=\"#narrow/stream/270676-lean4/topic/Calling.20Lean4.20code.20from.20Python/near/451891584\">said</a>:</p>\n<blockquote>\n<p>I was able to load a few of the dynamic libraries from Python (qq, aesop, cli, batteries, proofwidgets) but not the one for importgraph. Loading complains that it cannot find symbol <code>_l_Lake_Manifest_load_x3f</code>. I can find this symbol in <code>libLake.a</code>, but libLake.a doesn't seem to have a dynamic version. Is there a reason for this?</p>\n</blockquote>\n<p>There is no hard reason, it didn't seem like a library that end users should need as a shared library. That one line in importgraph that uses Lake seems to create more trouble than it is worth.</p>",
        "id": 452013224,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721209782
    },
    {
        "content": "<p>In any case, it is easy enough to work around, <span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> did it in <a href=\"https://github.com/lecopivo/ReverseFFIwithMathlib\">reverseFFIwithMathlib</a> and I worked around it on mac with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">clang</span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">fpic</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Wl</span><span class=\"o\">,</span><span class=\"bp\">-</span><span class=\"n\">force_load</span><span class=\"w\"> </span><span class=\"n\">libLake</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">libLake_shared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lleanshared</span>\n</code></pre></div>",
        "id": 452058081,
        "sender_full_name": "John Tristan",
        "timestamp": 1721219528
    },
    {
        "content": "<p>To close this thread, I was indeed able to write a Python program calling Lean code using reverse FFI. <a href=\"https://github.com/leanprover/SampCert/blob/7850b0b231a285ddabae11511f60bf274e11f8ea/Interop/Test.py\">Here's one way</a>, using the Python ctypes package.</p>",
        "id": 452085904,
        "sender_full_name": "John Tristan",
        "timestamp": 1721225620
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221511\">John Tristan</span> has marked this topic as resolved.</p>",
        "id": 452086004,
        "sender_full_name": "Notification Bot",
        "timestamp": 1721225635
    }
]