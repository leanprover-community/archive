[
    {
        "content": "<p>If I mark a function <code>private</code>, can it only be accessed within that namespace or section and nowhere else, or is it not that strict?</p>",
        "id": 272899426,
        "sender_full_name": "Joseph O",
        "timestamp": 1645585736
    },
    {
        "content": "<p>Those declarations are still in the environment after the namespace is closed but its name is mangled. If you defined it as <code>Namespace.foo</code> and defined it in <code>dir/file.lean</code>, it will be in your environment as <code>dir.file.0.Namespace.foo</code> (or with another number if there are multiple private definitions with the same name in the same file).</p>",
        "id": 272899963,
        "sender_full_name": "Simon Hudon",
        "timestamp": 1645586297
    },
    {
        "content": "<p>If you're using mathlib4, you can also do <code>open my.private.defn from Module.Where.Its.Defined.In</code> to comfortably access private definitions from other modules.</p>",
        "id": 272917967,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1645605457
    },
    {
        "content": "<p>What's the current preferred way to open a private definition? Is the above still valid? I couldn't get it to work.</p>",
        "id": 471014880,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726586647
    },
    {
        "content": "<p>Okay, I figured it out, it's <code>open private name from module</code></p>",
        "id": 471016983,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726587055
    },
    {
        "content": "<p>Oof, why do you need access to a private defn? That seems like a code smell to me?</p>",
        "id": 471023610,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726588352
    },
    {
        "content": "<p>Is there some API that is incomplete?</p>",
        "id": 471023656,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726588365
    },
    {
        "content": "<p>I need a bounded variant of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.lambdaLetTelescope#doc\">docs#Lean.Meta.lambdaLetTelescope</a> and the implementation of this has such an option, but is marked as private.</p>",
        "id": 471024194,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726588497
    },
    {
        "content": "<p>This is for a private project unrelated to mathlib etc. so I'm not too worried about using private defs</p>",
        "id": 471024249,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726588509
    },
    {
        "content": "<p>Note that we do have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.lambdaBoundedTelescope#doc\">docs#Lean.Meta.lambdaBoundedTelescope</a> but not something that will also handle <code>letE</code> exprs.</p>",
        "id": 471024450,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726588560
    },
    {
        "content": "<p>The Lean API has a bunch of private functions that are generally useful (and are no more dangerous than many public functions).</p>",
        "id": 471025958,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1726588896
    },
    {
        "content": "<p>Hmm, is there a list of some examples? It would be good to record them in some place. Because I think this just needs fixing.</p>",
        "id": 471063225,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726598615
    },
    {
        "content": "<p>FWIW, the private def that I needed is <a href=\"https://github.com/leanprover/lean4/blob/e9e858a4484905a0bfe97c4f05c3924ead02eed8/src/Lean/Meta/Basic.lean#L1204\">this one</a></p>",
        "id": 471067700,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726599689
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/270676-lean4/topic/private.20access/near/471063225\">said</a>:</p>\n<blockquote>\n<p>Hmm, is there a list of some examples? It would be good to record them in some place. Because I think this just needs fixing.</p>\n</blockquote>\n<p>If core agrees that this is a good idea, the best thing to do would be to just start sending PRs. But I'm not sure core agrees; API improvements that aren't bug fixes don't seem to be a high priority (understandably, given that we can usually work around them).</p>",
        "id": 471082688,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1726603748
    },
    {
        "content": "<p>There is tension here:</p>\n<ul>\n<li>keeping things private means we can change the implementation without worrying about compatibility: it adds cost to us to make things public</li>\n<li>sometimes people have good uses cases downstream that depend on the implementation: and we end up sad that <code>open private</code> is being used, and we are being pushed into supporting an implementation detail.</li>\n</ul>",
        "id": 471129899,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726619443
    },
    {
        "content": "<p>I think we are open to making some private things public. But it should go through the RFC process, rather than starting with a PR. The RFC should</p>\n<ul>\n<li>explain the use case downstream</li>\n<li>point to evidence that it is necessary for a significant project (&lt;---)</li>\n<li>explain why it is not possible to use the public API to achieve that effect</li>\n<li>if there are any relevant suggestions about changing the API as we make it public, make those</li>\n</ul>",
        "id": 471129915,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726619454
    },
    {
        "content": "<p>Doing a first round of prioritisation here on zulip would be even better. If someone could identify the current uses of <code>open private</code> that Mathlib most heavily depends on having, that would be a great way to triage work in this direction.</p>",
        "id": 471129918,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726619455
    },
    {
        "content": "<p>One reason <code>open private</code> is better than copy paste is that the upstream version changes too instead of having slight variations on the same code promulgate</p>",
        "id": 471180610,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726641687
    },
    {
        "content": "<blockquote>\n<p>we are being pushed into supporting an implementation detail</p>\n</blockquote>\n<p>I don't think anyone is advocating for that. Using <code>open private</code> is voiding your warranty, I don't think anyone thinks otherwise</p>",
        "id": 471180738,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726641734
    },
    {
        "content": "<p>I regularly have to fix code adjacent to an <code>open private</code>. Warranty might be voided, but it's often still my problem. :-) Outside of Batteries/Mathlib, sure, go wild.</p>",
        "id": 471181356,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726641987
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/private.20access/near/471129915\">said</a>:</p>\n<blockquote>\n<p>I think we are open to making some private things public. But it should go through the RFC process, rather than starting with a PR. The RFC should</p>\n<ul>\n<li>explain the use case downstream</li>\n<li>point to evidence that it is necessary for a significant project (&lt;---)</li>\n<li>explain why it is not possible to use the public API to achieve that effect</li>\n<li>if there are any relevant suggestions about changing the API as we make it public, make those</li>\n</ul>\n</blockquote>\n<p>The trouble is that this is an extremely heavyweight process given that there are hundreds or thousands of private definitions in <code>Lean</code>. I can't imagine any scenario where it would be worth it. If it was just a matter of recording when, where and why <code>open private</code> is being used in downstream projects, that is reasonable, but <code>open private</code> is a conflict avoidance method, and writing an RFC is not.</p>",
        "id": 471181386,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642000
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/private.20access/near/471180610\">said</a>:</p>\n<blockquote>\n<p>One reason <code>open private</code> is better than copy paste is that if the upstream version changes too instead of having slight variations on the same code promulgate</p>\n</blockquote>\n<p>Definitely agree on this one. Fixing subtle ancient variations of the internals of <code>simp</code> copy-pasted into downstream projects is not fun.</p>",
        "id": 471181474,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642043
    },
    {
        "content": "<p>100s or 1000s is a straw man. I'm talking about <code>open private</code> on the critical path to Mathlib, and I think there's more like half a dozen.</p>",
        "id": 471181616,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642101
    },
    {
        "content": "<p>the list evolves regularly, and it is difficult to predict what will be on it</p>",
        "id": 471181684,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642135
    },
    {
        "content": "<p>I think batteries is currently <code>open private</code>-free?</p>",
        "id": 471181721,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642157
    },
    {
        "content": "<p>I should grep rather than guess</p>",
        "id": 471181748,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642170
    },
    {
        "content": "<p>2 in batteries, 1 in aesop</p>",
        "id": 471181969,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642252
    },
    {
        "content": "<p>so half a dozen was an overestimate</p>",
        "id": 471181987,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642258
    },
    {
        "content": "<p>Batteries:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">mkMetaContext</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">preprocess</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">SimpTheorems</span>\n</code></pre></div>\n<p>Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">getElimNameInfo</span><span class=\"w\"> </span><span class=\"n\">generalizeTargets</span><span class=\"w\"> </span><span class=\"n\">generalizeVars</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Induction</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">getIntrosSize</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Intro</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">dischargeUsingAssumption?</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Rewrite</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">withFreshCache</span><span class=\"w\"> </span><span class=\"n\">mkAuxMVarType</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span>\n</code></pre></div>",
        "id": 471181992,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642261
    },
    {
        "content": "<p>The one in Aesop is getIntrosSize again</p>",
        "id": 471182090,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642310
    },
    {
        "content": "<p>is there more information you need besides the function names? I can try to reconstruct why these functions are being used, but a common reason is that these are the functions one level below an entry point function and we need to modify the entry point behavior</p>",
        "id": 471182263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642375
    },
    {
        "content": "<p>also of note is that my test file contains 11 <code>open private</code>s. When debugging lean code it is very useful to be able to inline lean functions and this means you have to be able to <code>open private</code> to copy the function body</p>",
        "id": 471182621,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642512
    },
    {
        "content": "<p>No complaints about test files using it!</p>",
        "id": 471182665,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642537
    },
    {
        "content": "<p><code>mkMetaContext</code> is a bit embarrassing, you can't create a CommandElabM state without it</p>",
        "id": 471183013,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642661
    },
    {
        "content": "<p>well, you could copy paste the list of settings in that object, but it's basically a config struct with default settings, you can imagine the nightmare if that gets out of date</p>",
        "id": 471183208,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642741
    },
    {
        "content": "<p>I think there is already an issue which suggests that those settings should be the default values so that <code>{}</code> works</p>",
        "id": 471183298,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642790
    },
    {
        "content": "<p>currently there is an issue where depending on how you run a command (i.e. which entry point) you can end up running it with either <code>mkMetaContext</code> or <code>{}</code> as the setting, which affects some extremely obsure elaboration details. Debugging that one was not fun</p>",
        "id": 471183588,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726642865
    }
]