[
    {
        "content": "<p>Hi,<br>\nI'm new to Zulip, so please let me know if I'm doing it wrong.</p>\n<p>I'm interested in using Lean4 as a hardware description language (HDL) using similar techniques as <a href=\"https://clash-lang.org/\">CLASH</a>. This would enable proving the correctness of designs while taking advantage of the very nice Lean tooling, types, metaprogramming, and language.</p>\n<p>To do this I'm trying to understand the Compiler internals, and would appreciate pointers about how it fits together or where to look for documentation.</p>\n<p>Particular things I'm looking for are how to:</p>\n<div class=\"codehilite\"><pre><span></span><code>- Get the abstract syntax tree (AST) or intermediate representations (IR) of functions, definitions, constants, etc...\n- Get the types of objects in the AST (for determining wire bus widths and slicing in the resulting HDL)\n- Normalize and perform constant propagation on this AST\n- Lower match patterns to decision trees\n- Specialize and inline arguments to functions (especially for higher-order functions which can&#39;t otherwise be synthesized to hardware).\n- How to prevent inlining of certain functions (for making primitive operations which compile to the equivalent underlying HDL constructs). Perhaps however `opaque` is handled is sufficient for this?\n</code></pre></div>\n\n<p>Also I saw that there's a new compiler? How does that effect things?</p>\n<p>The rest of this post contains things I've discovered by spelunking in the code-base.</p>\n<p>I've figured out that <code>importModules</code> enables importing definitions from the <code>.olean</code> generated by <code>lake exe</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">constant_info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"uh oh\"</span>\n</code></pre></div>\n<p>though I'm not sure if this is how one is supposed to read <code>olean</code> files. The <code>ConstantInfo</code> seems like it has all the information I'd need, but I would like to re-use as much of Lean's compiler internals as possible instead of re-writing everything starting from <code>ConstantInfo</code> and <code>Expr</code>.</p>\n<p>enabling <a href=\"http://trace.compiler.ir\">trace.compiler.ir</a> with <code>set_option trace.compiler.ir true</code> shows me (for example):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"o\">[</span><span class=\"n\">init</span><span class=\"o\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_4</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_5</span>\n</code></pre></div>\n<p>which indicates to me that the decision tree lowering I'd need is somewhere in the compiler. This particular output seems to be coming from <code>Lean.IR.compileAux</code>. Are those <code>obj</code> untyped or is the type information accesible but not pretty-printed? Following the callstack (<code>Lean.IR.compile</code> &gt; <code>Lean.Compiler.LCNF.PassManager.run</code> &gt; <code>Lean.Compiler.LCNF.compile</code> and <code>Lean.Compiler.LCNF.main</code>) for this I see several types that seem important such as</p>\n<div class=\"codehilite\"><pre><span></span><code>- PassManager\n- CoreM\n- CompilerM\n</code></pre></div>\n\n<p>which I don't understand. What is this whole Pass system in LCNF? What is the correct way to construct <code>Lean.Core.Context</code> and <code>Lean.Core.State</code> for using <code>CoreM</code>?</p>",
        "id": 525636041,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750828440
    },
    {
        "content": "<p>I am not familiar with CLASH and HDLs, but what are you trying to achieve? If you're trying to formalize a language, so make a kind of DSL and AST, you don't need to look into how Lean generates code.</p>",
        "id": 525643764,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1750833370
    },
    {
        "content": "<p>(In which case, <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/\">https://leanprover-community.github.io/lean4-metaprogramming-book/</a> and <a href=\"https://lean-lang.org/doc/reference/latest/Notations-and-Macros/#language-extension\">https://lean-lang.org/doc/reference/latest/Notations-and-Macros/#language-extension</a> might help)</p>",
        "id": 525643938,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1750833477
    },
    {
        "content": "<p>Maybe you can give a very small ideal example of how you want your thing to be ultimately used by end users?</p>",
        "id": 525644922,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1750834028
    },
    {
        "content": "<p>The idea of Clash is that a significant subset of pure functional languages (non-recursive functions and datatypes plus a few exceptions like vectors with type level length plus recursion which can be fully unfolded at compile time through inlining, specialization, and monomorphization) can be compiled from a pure language into a hardware description. Clash uses Haskell. Since Lean is a pure language it should be possible to compile a large subset of Lean into a hardware description.</p>\n<p>For example:<br>\ngiven</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">UInt16</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>usage of <code>MyType n</code> would generate a wire bus of 1 + max(n, (1 + 16)) bits for the discriminant and maximum possible payload. Similarly for a function which returns a <code>MyType n</code>.</p>\n<p>A function gets translated into a combinatorial circuit with a bus of wires for its input and a bus of wires for its output.<br>\nStateful hardware components are represented by Mealy machines, or in other words, a function of the form <code>input -&gt; state -&gt; (state, output)</code> or <code>Œ± -&gt; StateM œÉ Œ≤</code>.</p>\n<p>Control flow gets compiled into muxes.</p>\n<p>To make this work higher-order functions have to be specialized into first-order functions.</p>\n<p>It's not a DSL, but a direct compilation of a subset of the Functional language. The appeal is that it intends to make writing the hardware simpler. In this case it would also enable using Lean's ability to prove theorems about Lean.</p>",
        "id": 525653960,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750838081
    },
    {
        "content": "<p>Also, I have read the metaprogramming book but it doesn't cover <code>CoreM</code>. Just <code>MetaM</code> and <code>ElabM</code> inside <code>elab</code> and <code>macro</code>, where the monad is magically ran for you, which doesn't help in regard to <code>Lean.Compiler.LCNF.compile</code>.</p>",
        "id": 525654873,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750838389
    },
    {
        "content": "<p>The way I'd hope this could be used is by making an executable or function which can take a monomorphic \"top-level-entity\" function defined in Lean and recursively generate the corresponding hardware description in System Verilog.</p>",
        "id": 525655939,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750838731
    },
    {
        "content": "<blockquote>\n<p>It's not a DSL, but a direct compilation of a subset of the Functional language. The appeal is that it intends to make writing the hardware simpler. In this case it would also enable using Lean's ability to prove theorems about Lean.</p>\n</blockquote>\n<p>I don't really understand why you want to be able to compile <em>arbitrary lean code</em> instead of defining a language within Lean, as is usually done. If you're trying to add another compilation target for lean, you're going to be exposed to changes in the compiler, which will probably be a maintenance nightmare. And you still have access to a lot of lean's language features, as long as you can \"compile\" them into terms of your language.</p>",
        "id": 525667124,
        "sender_full_name": "neil",
        "timestamp": 1750842401
    },
    {
        "content": "<p>looks like Clash has something to this effect in their docs as well:</p>\n<blockquote>\n<p>Due to the Clash‚Äôs tight integration with GHC, updates to the GHC version that Clash uses result in changes to the Clash version. As GHC‚Äôs internals change frequently, even for minor bumps, it cannot be guaranteed that these changes will not result in Clash changes.</p>\n</blockquote>\n<p>so clash is sort of a fork of a given version of GHC; I was wondering how that worked</p>",
        "id": 525668025,
        "sender_full_name": "neil",
        "timestamp": 1750842703
    },
    {
        "content": "<blockquote>\n<p>I don't really understand why you want to be able to compile arbitrary lean code instead of defining a language within Lean, as is usually done.</p>\n</blockquote>\n<p>On why you would want to do this instead of an embedded DSL I'll quote directly from <a href=\"https://research.utwente.nl/en/publications/digital-circuit-in-c%CE%BBash-functional-specifications-and-type-direc\">Digital Circuits in CŒªaSH: Functional Specifications and Type-Directed Synthesis by Christiaan P.R. Baaij</a></p>\n<blockquote>\n<p>One popular approach to alleviate the implementation burden is to create an embedded domain specific language (DSL) for circuit design, which is the approach taken by, for example, the Lava HDL [...].</p>\n</blockquote>\n<blockquote>\n<p>One technical difficulty is that these circuit generators will, in the presence of feedback loops, generate infinite trees, which have to be folded back into a graph structure [24]. One deficit of the embedded language approach is that not all of the (desirable) features of the host-language can be used for circuit description. Most importantly, the choice-constructs (such as case-statements) of the host language cannot be used to describe choice-constructs in the eventual circuit [...].</p>\n</blockquote>\n<p>and</p>\n<blockquote>\n<p>Haskell has a rich set of choice-constructs, including features such as guards and pattern matching. In the style of embedding chosen by Lava, these choice-constructs can, however, not be used to model choice-structures in the circuit. This is a direct consequence of using Haskell‚Äôs evaluation mechanism to construct the circuit graph: choice-constructs can be used to guide the construction of the circuit graph, but it is not possible to observe all the alternatives. The problem is that functions must operate on values of type <code>Signal a</code> in order to build the data-structure that will represent the circuit. The Signal type is, however, not transparent in terms of pattern-matching. That is, given a value <code>s</code>, of type <code>Signal Bool</code>, the expression <code>case s of {True ‚Üí ... ¬†; False ‚Üí ...}</code>, is invalid. That is, even though <code>True</code> and <code>False</code> are indeed the constructors of <code>Bool</code>, they are not the constructors of <code>Signal Bool</code>.</p>\n</blockquote>\n<p>I'll also add that implementing hardware synthesis as a new backend for the language enables using the language to \"simulate\" the hardware design simply by compiling and running it regularly to software, which is very nice for testability.</p>\n<p>If I used a DSL instead of Lean directly I imagine I would need to write an interpreter of the circuits and then write proofs about the interpreter of the DSL on circuit source trees, which sounds like it adds an unnecessary extra step to all the proofs.</p>\n<p>It doesn't make sense to me to make this a DSL because the semantics match those of Lean. If I wrote a DSL it would just be a re-implementation of Lean, which is what I'm trying to avoid.</p>\n<blockquote>\n<p>If you're trying to add another compilation target for lean [...]</p>\n</blockquote>\n<p>Yes, adding another compilation target for Lean is probably similar to what I'm trying to do. In <a href=\"https://pp.ipd.kit.edu/uploads/publikationen/demoura21lean4.pdf\">The Lean 4 Theorem Prover and Programming Language by Leonardo de Moura and Sebastian Ullrich</a>, it states</p>\n<blockquote>\n<p>The IR is a collection of Lean data structures, and users can implement support for backends other than C by writing Lean programs that import Lean.Compiler.IR.</p>\n</blockquote>\n<p>which seemed to imply code and cultural support for adding compiler backends. Is this no longer the case?</p>\n<blockquote>\n<p>you're going to be exposed to changes in the compiler, which will probably be a maintenance nightmare.</p>\n</blockquote>\n<p>There has to be some level that's expected to be stable. The <code>Expr</code> is public API used by macros and seems to contain all the information needed. I would hope this doesn't change constantly since that would break any metaprogramming that anyone writes, and makes me question the metaprogramming utility in Lean. The question is how much of the compiler can I re-use while transforming this, to hopefully jumpstart the project, even if I have to diverge in how compilation is done over time.</p>",
        "id": 525753022,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750869857
    },
    {
        "content": "<p>You can use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"bp\">.</span><span class=\"n\">findEnvDecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`Lean.IR.findEnvDecl</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n</code></pre></div>\n<p>which is probably reasonably stable but <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> can probably tell you more</p>",
        "id": 525759543,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750872288
    },
    {
        "content": "<p>The problem with that seems to be that types get erased to <code>Lean.IR.IRType.object</code></p>\n<p>as part of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">IRType</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">float</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">uint8</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">uint16</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">uint32</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">uint64</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">usize</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">irrelevant</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tobject</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">float32</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">leanTypeName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">types</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">IRType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IRType</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">union</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">leanTypeName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">types</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">IRType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IRType</span>\n<span class=\"w\">¬† </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n</code></pre></div>\n<p>, but to synthesize to hardware the types have to be concrete and known</p>",
        "id": 525762510,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750873627
    },
    {
        "content": "<p>I would assume this is possible, otherwise I don't know how Lean plans on doing unbox optimizations.</p>",
        "id": 525762713,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750873713
    },
    {
        "content": "<p>(unboxing is precisely what the hardware synthesis requires)</p>",
        "id": 525764699,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750874518
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/near/525762713\">schrieb</a>:</p>\n<blockquote>\n<p>otherwise I don't know how Lean plans on doing unbox optimizations</p>\n</blockquote>\n<p>The <code>struct</code> and <code>union</code> types already exist and they will probably then get used for unbox optimization (more or less significantly changing the compiler and backend). But no, the IR doesn't contain that, maybe the <code>mono</code> compilation stage would be better suited?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">LCNF</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">ppDecl'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getMonoDecl?</span><span class=\"w\"> </span><span class=\"ss\">``Option.get!</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n</code></pre></div>",
        "id": 525765801,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750874957
    },
    {
        "content": "<p>That particular code panics with <code>PANIC at Option.get! Init.Data.Option.BasicAux:21:14: value is none</code>.</p>\n<p>Trying ``_root_.main after defining a main function similarly panics, so I'm not sure what state it's reading from.</p>",
        "id": 525767251,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750875608
    },
    {
        "content": "<p>For reference this also panics on the <code>Option.get!</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">LCNF</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">ppDecl'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getMonoDecl?</span><span class=\"w\"> </span><span class=\"ss\">``Option.get!</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">core_state</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">core_state</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">toIO'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"ToString.toString v = {ToString.toString v}\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"s2\">\"uh oh\"</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>(and surprisingly still prints the match statement? I guess panics don't abort the process?)</p>",
        "id": 525769179,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750876539
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/near/525767251\">schrieb</a>:</p>\n<blockquote>\n<p>That particular code panics with <code>PANIC at Option.get! Init.Data.Option.BasicAux:21:14: value is none</code>.</p>\n<p>Trying ``_root_.main after defining a main function similarly panics, so I'm not sure what state it's reading from.</p>\n</blockquote>\n<p>You need to use the latest nightly with the new compiler</p>",
        "id": 525782025,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750882295
    },
    {
        "content": "<p>It's reading new compiler state</p>",
        "id": 525782064,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750882314
    },
    {
        "content": "<p>Thanks for reaching out, <span class=\"user-mention\" data-user-id=\"932169\">@Easyoakland</span>! I am, for lack of a better description, the current code owner of the Lean compiler. I also happen to have some industrial experience with RTL and tooling for HDLs, and am interested in seeing people apply Lean to HW verification.</p>\n<p>The main problem I see with a Clash-like approach for Lean is that it's not obvious what your <code>Signal</code> equivalent should be. Lean does support encodings of coinductive predicates, but it doesn't support coinductive types with computational rules.</p>\n<p>If you're looking to reuse pieces of the existing compiler, then you definitely want to look more at <code>LCNF</code> (the mostly pure middle-end) as opposed to <code>IR</code> (the impure backend, highly coupled with Lean's runtime system).  Unlike GHC's Core, which preserves types throughout the compiler, LCNF is an ultimately untyped representation that attempts to preserve types as much as possible as hints for specialization, inlining, etc. This works because use a mostly uniform representation of values, but any HDL would need to use a highly non-uniform representation.</p>",
        "id": 525787441,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1750884351
    },
    {
        "content": "<blockquote>\n<p>I am, for lack of a better description, the current code owner of the Lean compiler. I also happen to have some industrial experience with RTL and tooling for HDLs, and am interested in seeing people apply Lean to HW verification.</p>\n</blockquote>\n<p>Happy to hear!</p>\n<blockquote>\n<p>The main problem I see with a Clash-like approach for Lean is that it's not obvious what your <code>Signal</code> equivalent should be.</p>\n</blockquote>\n<p>The first draft of Clash (as I understand it) was based on Mealy machines instead of based on lazy infinite lists in the <code>Signal</code> type. I suspect having state be explicit will be useful for proof anyway (for example proving a predicate on state after n cycles/transitions) so I don't think it's a big loss.</p>\n<p>Something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">transition</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span>\n<span class=\"w\">  </span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">œÉ</span>\n</code></pre></div>\n<p>for a single clock domain, and something like a tuple/HList of concrete <code>Mealy</code> for entities with multiple clock domains, where each machine will have a corresponding clock domain.</p>\n<blockquote>\n<p>Lean does support encodings of coinductive predicates, but it doesn't support coinductive types with computational rules.</p>\n</blockquote>\n<p>I don't know what you mean by coinductive predicates or coinductive types with computational rules in Lean, but the above Mealy machine should encode the coinductive computational behavior in the transition function.</p>\n<blockquote>\n<p>If you're looking to reuse pieces of the existing compiler, then you definitely want to look more at <code>LCNF</code> (the mostly pure middle-end) as opposed to <code>IR</code> (the impure backend, highly coupled with Lean's runtime system).</p>\n</blockquote>\n<p>This is very helpful to know.</p>\n<blockquote>\n<p>Unlike GHC's Core, which preserves types throughout the compiler, LCNF is an ultimately untyped representation that attempts to preserve types as much as possible as hints for specialization, inlining, etc. This works because use a mostly uniform representation of values, but any HDL would need to use a highly non-uniform representation.</p>\n</blockquote>\n<p>Sounds like I will have to work on a separate representation.</p>\n<p>Can you point me to where/how the compiler de-sugars match statements? Even if the representations turn out different, re-using the same ideas will be helpful.</p>",
        "id": 525794913,
        "sender_full_name": "Easyoakland",
        "timestamp": 1750887794
    },
    {
        "content": "<p>I agree that using Mealy machines should work.</p>\n<blockquote>\n<p>Can you point me to where/how the compiler de-sugars match statements? Even if the representations turn out different, re-using the same ideas will be helpful.</p>\n</blockquote>\n<p>You probably want to see all of the code called from here: <a href=\"https://github.com/leanprover/lean4/blob/25b1b46572db22b300471ff0668d15ca3091e10a/src/Lean/Compiler/LCNF/ToLCNF.lean#L699-L700\">https://github.com/leanprover/lean4/blob/25b1b46572db22b300471ff0668d15ca3091e10a/src/Lean/Compiler/LCNF/ToLCNF.lean#L699-L700</a></p>",
        "id": 525795729,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1750888342
    },
    {
        "content": "<p>As a recent clash user, I am watching with interest. That is all <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 525857303,
        "sender_full_name": "Elliot Potts",
        "timestamp": 1750928733
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"932169\">@Easyoakland</span> I thought about it a bit after making that post and realized that I did agree with you, ultimately, but thank you for sharing all that reasoning.</p>",
        "id": 526177133,
        "sender_full_name": "neil",
        "timestamp": 1751086266
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"656225\">Cameron Zwarich</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/near/525787441\">said</a>:</p>\n<blockquote>\n<p>Lean does support encodings of coinductive predicates, but it doesn't support coinductive types with computational rules.</p>\n</blockquote>\n<p>Could  you expand on this? What does it mean that Lean supports encoding coinductive predicates but not with computational rules?</p>",
        "id": 526891783,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751497655
    },
    {
        "content": "<p>You can write a type which is isomorphic to a coinductive type, for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.Seq#src\">src#Stream'.Seq</a> is morally a coinductive type (you can see the definition one would like to write just above it) and it has the corecursor, destructor, and a bisimulation principle like you would have from a real coinductive type. But the definition itself doesn't look at all like a coinductive type, it's encoded using streams of options. The main thing that you do not get from this kind of construction is the computational rules, e.g. <code>destruct (corec f b) = omap (corec f) (f b)</code>, which would be definitional equalities in a system which had coinductive types built in. The best we can do is have them as simp lemmas.</p>",
        "id": 526893306,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751498817
    },
    {
        "content": "<p>I was informed about <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27#src\">src#Stream'</a> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/with/526157423\">here</a>. The problem with it was quadratic runtime.</p>\n<p>This still allows a model that has both a computational behavior and proof of that computational behavior? I thought <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> had meant something else.</p>\n<p>How does <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/QPF/Univariate/Basic.html#QPF\">QPF</a> relate? Is it also a way of getting \"corecursor, destructor, and a bisimulation principle [...]. But [...] doesn't look at all like a coinductive type\"?</p>",
        "id": 526894777,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751499800
    },
    {
        "content": "<p>Right, you don't want to use the model construction as the actual implementation, it has the wrong order of evaluation and results in worse asymptotics</p>",
        "id": 526897976,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502345
    },
    {
        "content": "<p>the definitional equality I mentioned is the actual way you want this to compute</p>",
        "id": 526898000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502368
    },
    {
        "content": "<p>and that requires special support from the compiler to recognize that the definition of <code>corec</code> in terms of the model should not be taken at face value and compiled to code</p>",
        "id": 526898028,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502404
    },
    {
        "content": "<p>and yes, QPF is basically doing this for general coinductive types, and it suffers from the same issues as Stream'</p>",
        "id": 526898082,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502439
    },
    {
        "content": "<p>it's basically just some metaprogram that will actually implement a <code>coinductive</code> keyword which automates model constructions in the style of Stream', but because it's not part of the compiler it can't fix the computation issue</p>",
        "id": 526898146,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502512
    },
    {
        "content": "<p>There is an alternative definition which has the right computational behavior but lives in the wrong universe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> ! -/</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">corec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">destruct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">destruct_corec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">corec</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">destruct</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">corec</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 526898584,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502914
    },
    {
        "content": "<p>it also doesn't have the right universe polymorphism; <code>corec</code> should allow the type <code>Œ±</code> to be in <code>Sort u</code> but it only works for <code>Œ± : Type</code></p>",
        "id": 526898670,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751502985
    },
    {
        "content": "<p>So ideally the compiler should be able to swap out the model definition of <code>corec</code> with this definition. This can almost be done already today using <code>implemented_by</code>, but it has an issue where it will delete some projections that are necessary to maintain the separation between the model implementation and the computational implementation. There was a fix for it (<a href=\"https://github.com/leanprover/lean4/pull/2292\">lean4#2292</a>) but it never got merged and the new compiler did not fix the issue.</p>",
        "id": 526898882,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751503190
    },
    {
        "content": "<p>This has been blocking coinductives for years <span aria-label=\"sob\" class=\"emoji emoji-1f62d\" role=\"img\" title=\"sob\">:sob:</span></p>",
        "id": 526898964,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751503257
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I didn't realize that this is all that is blocking a performant implementation of coinductive types, so thanks for explaining that.</p>",
        "id": 526903905,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751507915
    },
    {
        "content": "<p>well, this and a ton of non-core work to actually write a good coinductive package</p>",
        "id": 526903982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751507991
    },
    {
        "content": "<p>For this particular project (HDL) I think only a performant <code>Stream</code> type would be needed to replace the manual state machines, so I would be interested if that gets unblocked.</p>",
        "id": 526904303,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751508213
    },
    {
        "content": "<p>depending on your application the above existential type implementation might actually work for you</p>",
        "id": 526904349,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751508262
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/near/526904349\">said</a>:</p>\n<blockquote>\n<p>depending on your application the above existential type implementation might actually work for you</p>\n</blockquote>\n<p>Because it's only a problem if I need universe polymorphism?</p>",
        "id": 526904543,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751508369
    },
    {
        "content": "<p>well it makes the type have a weirdly large universe, which means you can't use it in <code>IO</code> and some other things</p>",
        "id": 526904582,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751508404
    },
    {
        "content": "<p>so it may or may not be a problem</p>",
        "id": 526904621,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751508431
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"656225\">Cameron Zwarich</span> <a href=\"#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/near/525795729\">said</a>:</p>\n<blockquote>\n<p>You probably want to see all of the code called from here: <a href=\"https://github.com/leanprover/lean4/blob/25b1b46572db22b300471ff0668d15ca3091e10a/src/Lean/Compiler/LCNF/ToLCNF.lean#L699-L700\">https://github.com/leanprover/lean4/blob/25b1b46572db22b300471ff0668d15ca3091e10a/src/Lean/Compiler/LCNF/ToLCNF.lean#L699-L700</a></p>\n</blockquote>\n<p>It looks like the ToLCNF is just about collecting <code>Expr</code> into the ANF format to perform code optimization.</p>\n<p>I don't (at least for now) need to do code optimization, beyond partial evaluation, so I don't think this really matters to me.</p>\n<p>Currently I'm compiling directly from <code>Expr</code> to a netlist while simultaneously normalizing/reducing the term using <code>whnf</code>.</p>\n<p>The way I'm handling matching right now is by unfolding until it hits a recursor and then compiling the recursors themselves. I had to write my own <code>whnfImp</code> because <code>Lean.Meta.whnf</code> doesn't unfold auxiliary matches. For that I'm using <code>Lean.Compiler.LCNF.inlineMatchers</code>. Is there a <code>whnf</code> which doesn't stop at auxiliary match statements?</p>\n<p>Why are auxiliary match statements treated so specially by the compiler (in that they are unfolded as unoften as possible), and why are many recursors not supported directly by the Lean code generator?</p>\n<p>My current progress on this project is <a href=\"https://github.com/Easyoakland/HDLean\">here</a>. It seems to handle combinational logic correctly for the most part such as all of the following functions.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotL</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">false</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">true</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">undef</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">undef</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mynot</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mynot</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotE'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mynotL</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mynotL</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotE''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mynot</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mynotL</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotEIf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"w\"> </span><span class=\"n\">LBool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">¬† </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mynotEIf'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">¬† </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"o\">:</span><span class=\"bp\">!</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">suffices</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">this.elim</span>\n<span class=\"w\">¬† ¬† </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">contradiction</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyS</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">:=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">:=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">:=</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"n\">MyS</span><span class=\"o\">}</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">:=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">:=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">:=</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"n\">MyS</span><span class=\"o\">}</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">:=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">:=</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"n\">MyS</span><span class=\"o\">}</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test4</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyS</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.a</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test5</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyS</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.b</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">MyS.test6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyS</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.c</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">saturatingAddMono</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">saturatingAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"o\">:=</span><span class=\"mi\">2</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x.ult</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">t3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x.ule</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>\n<p>where</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">MyS</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">¬† </span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">¬† </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">¬† </span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">_root_.BitVec.natMax</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">}:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- since -1 is all `1`s it is also the largest unsigned value</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">wouldOverflow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">¬† </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">¬† </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">saturatingAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">¬† </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">wouldOverflow</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">BitVec.natMax</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">¬† </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>\n</div></div>\n<p>If you have any feedback on the code as it stands, e.g., am I doing things weird or re-implementing logic which already exists, I would appreciate it.</p>\n<hr>\n<p>I believe the current issue I'm facing is that <code>Acc.rec</code> isn't reduced by <code>whnf</code>. I'm guessing this is related to reduction getting stuck as described <a href=\"https://lean-lang.org/theorem_proving_in_lean4/Axioms-and-Computation/#axioms-and-computation\">Theorem Proving in Lean4</a>.</p>\n<p>When does <code>Acc.rec</code> get used? Is it part of compiling functions that are terminating by well-foundedness?</p>\n<p>I encountered it while trying to compile <code>len_manual_mono</code> in</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">len_manual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x.elimAsList</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">hl</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">‚ü©</span>\n<span class=\"w\">¬† </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">¬† ¬† </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">¬† ¬† ¬† </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"bp\">?</span>\n<span class=\"w\">¬† ¬† ¬† </span><span class=\"n\">omega</span>\n<span class=\"w\">¬† ¬† </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">len_manual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:=</span><span class=\"n\">n</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">b.toArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"bp\">?</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">castSucc</span><span class=\"w\"> </span><span class=\"bp\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">]))</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">len_manual_mono</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">len_manual</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>where <code>#eval len_manual_mono</code> is <code>2</code> as expected but it doesn't <code>reduce</code> to 2, and instead gets stuck at a really long term whose head is <code>Acc.rec</code>.</p>\n<ol>\n<li>\n<p>When are recursors not reducible? <code>True.rec</code>, <code>False.rec</code>, and <code>Nat.rec</code> all reduce while <code>Acc.rec</code> and <code>Eq.rec</code> don't.</p>\n</li>\n<li>\n<p>Theorem Proving in Lean4 says \"But in nontrivial examples, eliminating cast changes the type of the term, which might make an ambient expression type incorrect\". What nontrivial examples? Is the issue of type correctness still present if proofs are erased with <code>lcProof</code>? Or in other words, is the type-correctness failure only in proof terms, or does it also affect inhabitants of <code>Type</code>s such as inhabitants of <code>Nat</code> or <code>Fin</code>?</p>\n</li>\n<li>\n<p>Is the the issue of type correctness related to whatever \"subject reduction\" is?</p>\n</li>\n<li>\n<p>How should I modify <code>whnf</code> to reduce these kinds of stuck recursors? I'm guessing I need some kind of <code>whnf-eval</code> hybrid?</p>\n</li>\n</ol>",
        "id": 531281007,
        "sender_full_name": "Easyoakland",
        "timestamp": 1753682228
    },
    {
        "content": "<p><a href=\"#narrow/channel/270676-lean4/topic/Lean.20as.20an.20HDL/near/531281007\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL/with/526904621\">#lean4 &gt; Understanding compiler internals to use Lean as HDL</a> by <span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span>.</p>",
        "id": 531282162,
        "sender_full_name": "Notification Bot",
        "timestamp": 1753682710
    },
    {
        "content": "<p><del>I tried to rename the topic, and it looks like Zulip just made a new one instead and moved my message there. Here's a link to the new topic and message continuing the thread: <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Lean.20as.20an.20HDL/with/531375719\">#lean4 &gt; Lean as an HDL</a></del><br>\nEdit: Looks like the previous topic messages were moved here.</p>",
        "id": 531282334,
        "sender_full_name": "Easyoakland",
        "timestamp": 1753682786
    },
    {
        "content": "<p>44 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Understanding.20compiler.20internals.20to.20use.20Lean.20as.20HDL\">#lean4 &gt; Understanding compiler internals to use Lean as HDL</a> by <span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span>.</p>",
        "id": 531375719,
        "sender_full_name": "Notification Bot",
        "timestamp": 1753710587
    },
    {
        "content": "<blockquote>\n<p>I believe the current issue I'm facing is that <code>Acc.rec</code> isn't reduced by <code>whnf</code>. I'm guessing this is related to reduction getting stuck as described <a href=\"https://lean-lang.org/theorem_proving_in_lean4/Axioms-and-Computation/#axioms-and-computation\">Theorem Proving in Lean4</a>.</p>\n</blockquote>\n<p>I just noticed that recursive functions (even those defined by well-founded recursion) have an auxiliary <code>._unsafe_rec</code> which recurses by name and which <code>toLCNF</code> uses. That fixes the <code>Acc.rec</code> issue since <code>Acc.rec</code> only shows up in the model definition.</p>",
        "id": 532636831,
        "sender_full_name": "Easyoakland",
        "timestamp": 1754278975
    },
    {
        "content": "<p>I do still think I'm going to need to modify whnf to be more like eval, but the path for doing so is clearer to me now.</p>",
        "id": 532637403,
        "sender_full_name": "Easyoakland",
        "timestamp": 1754279339
    },
    {
        "content": "<p>Hellow,</p>\n<p>I recently tried a new HDL and the HDL &lt;-&gt; theorem prover thing came back into my mind.</p>\n<p>Here is the thing: Most hardware description is done in Verilog/SV/VHDL. </p>\n<p>While this thread went in the opposite direction, my idea is that Verilog/SV/VHDL code could be translated into lean4 to verify the circuits.</p>\n<p>Advantage of this would be, that already existent codebases could be verified using lean4.</p>",
        "id": 541907523,
        "sender_full_name": "Nina Chlo√© Kassi",
        "timestamp": 1759080687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"940514\">Nina Chlo√© Kassi</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20as.20an.20HDL/near/541907523\">said</a>:</p>\n<blockquote>\n<p>While this thread went in the opposite direction, my idea is that Verilog/SV/VHDL code could be translated into lean4 to verify the circuits.</p>\n</blockquote>\n<p>I don't know how you would describe the circuits in lean4, without having effectively a full hardware description language in lean anyway.</p>",
        "id": 541910937,
        "sender_full_name": "Easyoakland",
        "timestamp": 1759084695
    },
    {
        "content": "<p>a full HDL in this case would mean a lot of bells and whistles that a minimal HDL can avoid by just providing a way to write RTL.</p>",
        "id": 541916391,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1759090863
    },
    {
        "content": "<p>Fwiw, I am not sure why wouldn't want to try the Lava approach. Write a monad that builds the circuit expression and prove things about it.</p>",
        "id": 541916425,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1759090913
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20as.20an.20HDL/near/541916425\">said</a>:</p>\n<blockquote>\n<p>Fwiw, I am not sure why wouldn't want to try the Lava approach. Write a monad that builds the circuit expression and prove things about it.</p>\n</blockquote>\n<p>In this scheme <code>BitVec.and</code>, for example, translates to hardware as an <code>and</code>, and in addition can be reasoned about using all the tooling which already exists in Lean for dealing with bitvectors since it is just a regular function to the Lean type system. If you wanted to do the Lava approach I think you'd need to add a bunch of axioms that the circuit is equivalent to the model. If you have to write the logical model equivalence anyway, it seems reasonable to go all the way and use the native operations directly so that the translation is two-way instead of one-way. That way writing the hardware feels nicer (syntax matches regular Lean), and there's not a weird translation layer to bootstrap the logic that shows up in proofs.</p>\n<p>This method also enables simulating the circuit directly in Lean, without having to write a custom interpreter for the circuit graph generated by a lava-like approach.</p>\n<p>Additionally, while the ability to verify hardware designs is one of the reasons I'm working on this, I also just want to make an HDL which is nice to use and has good tooling (which I get almost automatically by using Lean's front-end).</p>",
        "id": 541918424,
        "sender_full_name": "Easyoakland",
        "timestamp": 1759093200
    },
    {
        "content": "<p>If you're interested, while the compiler is still very much in progress, something like this (a flip-flop which outputs the next element of the fibonacci series on each clock):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cyclic_fibonacci_series</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Mealy</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">scan</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reset</span><span class=\"o\">:=(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">prev2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prev1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prev2</span><span class=\"bp\">+</span><span class=\"n\">prev1</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">prev2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prev1</span><span class=\"o\">,</span><span class=\"n\">next</span><span class=\"o\">)))</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cyclic_fibonacci_series_mono</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cyclic_fibonacci_series</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:=</span><span class=\"mi\">18</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>already works and translates to (the admittedly not pretty)</p>\n<div class=\"codehilite\" data-code-language=\"systemverilog\"><pre><span></span><code><span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">cyclic_fibonacci_series_mono</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"k\">input</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">clk</span>\n<span class=\"w\">  </span><span class=\"p\">,</span><span class=\"k\">input</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">rst</span>\n<span class=\"w\">  </span><span class=\"p\">,</span><span class=\"k\">output</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">o</span>\n<span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">36</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">36</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15340</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15341</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15361</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15361</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15370</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15370</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"p\">[</span><span class=\"mi\">36</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">18</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15376</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15376</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15381</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15381</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"p\">[</span><span class=\"mi\">36</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">18</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15341</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15340</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15361</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15370</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15376</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15381</span><span class=\"p\">)}};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">18</span><span class=\"m\">'0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"m\">'1</span><span class=\"p\">};</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15339</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15340</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15341</span><span class=\"p\">;</span>\n<span class=\"k\">endmodule</span>\n</code></pre></div>",
        "id": 541918687,
        "sender_full_name": "Easyoakland",
        "timestamp": 1759093529
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/270676-lean4/topic/Lean.20as.20an.20HDL/near/541916391\">said</a>:</p>\n<blockquote>\n<p>a full HDL in this case would mean a lot of bells and whistles that a minimal HDL can avoid by just providing a way to write RTL.</p>\n</blockquote>\n<p>That's what I meant. With this approach, the bells and whistles can be implemented in just library code written in Lean. The only special support you need is the primitives and the ability to compose them.</p>",
        "id": 541919058,
        "sender_full_name": "Easyoakland",
        "timestamp": 1759093982
    },
    {
        "content": "<p>And while I'm posting stuff which works, this is neat. (There's no special support in the compiler for <code>delay</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delay1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.scan</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">st</span><span class=\"o\">,</span><span class=\"n\">v</span><span class=\"o\">))</span>\n\n<span class=\"c1\">-- Ok, this is cool and It Just Works‚Ñ¢.</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delayN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id.run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delay1</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delay4</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Mealy</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delayN</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">delay4_mono</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delay4</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"o\">:=</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cyclic_fibonacci_series</span><span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>compiled output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"systemverilog\"><pre><span></span><code><span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">delay4_mono</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"k\">input</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">clk</span>\n<span class=\"w\">  </span><span class=\"p\">,</span><span class=\"k\">input</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">rst</span>\n<span class=\"w\">  </span><span class=\"p\">,</span><span class=\"k\">output</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">o</span>\n<span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15693</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15694</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15695</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15702</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15703</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15704</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15711</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15712</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15713</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15720</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15721</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15722</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15730</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15731</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15751</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15751</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15760</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15760</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">3</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15766</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15766</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"kt\">var</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15771</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15771</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">3</span><span class=\"p\">];</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15731</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15730</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15751</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15760</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">Prod_mk_field_0___Compiler_ToSystemVerilog__hyg_15766</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Prod_mk_field_1___Compiler_ToSystemVerilog__hyg_15771</span><span class=\"p\">)}};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">3</span><span class=\"m\">'0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"m\">'1</span><span class=\"p\">};</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15729</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15730</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15722</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15721</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15720</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15731</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15720</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"m\">'0</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15720</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15721</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15713</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15712</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15711</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15722</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15711</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"m\">'0</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15711</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15712</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15704</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15703</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15702</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15713</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15702</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"m\">'0</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15702</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15703</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15695</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15694</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15693</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15704</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">always_ff</span><span class=\"w\"> </span><span class=\"p\">@(</span><span class=\"k\">posedge</span><span class=\"w\"> </span><span class=\"n\">clk</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">case</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">rst</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15693</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"m\">'0</span><span class=\"p\">;</span>\n<span class=\"w\">      </span><span class=\"k\">default</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">registerState___Compiler_ToSystemVerilog__hyg_15693</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">newRegisterState___Compiler_ToSystemVerilog__hyg_15694</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">endcase</span>\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">registerOutput___Compiler_ToSystemVerilog__hyg_15695</span><span class=\"p\">;</span>\n<span class=\"k\">endmodule</span>\n</code></pre></div>\n</div></div>",
        "id": 541919591,
        "sender_full_name": "Easyoakland",
        "timestamp": 1759094626
    },
    {
        "content": "<p>Right this is a high level synchronous hdl (like clash ofc). Suddenly your design choices make sense.</p>",
        "id": 541921065,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1759096412
    },
    {
        "content": "<p>I am not writing an hdl per se, but the skeleton of one (still private for now) which is shallow embedded to verify much more weird circuit properties. I haven‚Äôt figured out how to translate this into provably correct verilog because HDls and their synthesis tools behave in rather unpleasant ways at this level unless you hand control every piece of the RTL.</p>",
        "id": 541921214,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1759096605
    },
    {
        "content": "<p>This means you need to avoid the high level combinator stuff getting translated into arbitrary numbers of  flipflops. The FPGA HDLs that Pl people develop usually don‚Äôt have this issue. So it is kind of safe to generate registers where required and let the layout tools handle the optimisations.</p>",
        "id": 541921347,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1759096785
    }
]