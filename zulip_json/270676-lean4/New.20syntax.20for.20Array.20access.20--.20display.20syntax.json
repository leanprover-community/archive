[
    {
        "content": "<p>Hi! As part of the <a href=\"https://github.com/cryspen/hax/pull/1590\">Hax backend for Lean</a> I'm trying to create a new syntax <code>a[i]_?</code> for array accesses that returns a custom Option type (that's why I'm not using <code>a[i]?</code> directly -- overriding GetElem? is not an option in my case).</p>\n<p>I've copied the Lean <a href=\"https://github.com/leanprover/lean4/blob/30ceb3260d7d7536092fedff969b4b2e8de7f942/src/Init/GetElem.lean#L92-L107\">definition of <code>GetElem</code></a>, and modified it to return an <code>Result</code> (a custom Option type with error cases) </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">GetElemResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">coll</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getElemResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">coll</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">elem</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">GetElemResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getElemResult</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">getElemResult</span><span class=\"kd\">]</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">withoutPosition</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"_?\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">_?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">getElemResult</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">instGetElemResultArray</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GetElemResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getElemResult</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"n\">arrayOutOfBounds</span>\n</code></pre></div>\n<p>It works, but internally, Lean does not keep the <code>a[i]_?</code>, but inlines them as calls to <code>getElemResult</code>, as can be seen by doing : </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">][</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">_?</span><span class=\"w\"> </span><span class=\"c1\">-- getElemResult #[0,1,2,3] 1 : Result Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">][</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"c1\">-- #[0,1,2,3][1]? : Option Nat</span>\n</code></pre></div>\n<p>Am I missing a notation definition in addition to the macro ? I can't find any in the GetElem.lean file, unless perhaps this <a href=\"https://github.com/leanprover/lean4/blob/30ceb3260d7d7536092fedff969b4b2e8de7f942/src/Init/GetElem.lean#L412\">instance on Syntax</a> ?<br>\nThank you !</p>",
        "id": 532720800,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1754311703
    },
    {
        "content": "<p>You need an unexpander or a delaborator</p>",
        "id": 532729658,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754314654
    },
    {
        "content": "<p>they're <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=unexpandGetElem#doc\">docs#unexpandGetElem</a> and friends</p>",
        "id": 532730042,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754314788
    },
    {
        "content": "<p>Nice! Thank you! This works perfectly</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">getElemResult</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpandGetElemResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">array</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">index</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">array</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">index</span><span class=\"o\">]</span><span class=\"bp\">_?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 532732580,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1754315576
    }
]