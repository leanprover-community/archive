[
    {
        "content": "<p>The following simp call fails for me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- set_option maxRecDepth 1600</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  tactic 'simp' failed, nested error:</span>\n<span class=\"cm\">  maximum recursion depth has been reached</span>\n<span class=\"cm\">  use `set_option maxRecDepth &lt;num&gt;` to increase limit</span>\n<span class=\"cm\">  use `set_option diagnostics true` to get diagnostic information</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">reduceOfInt</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 491035217,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336192
    },
    {
        "content": "<p>and can be fixed with a sufficiently large maxRecDepth of 1600.</p>",
        "id": 491035281,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336215
    },
    {
        "content": "<p>AFAIU this should not happen.</p>",
        "id": 491035291,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336222
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">reduction</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1536</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"mi\">1536</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"mi\">1534</span>\n<span class=\"o\">[</span><span class=\"n\">reduction</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">reducible</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1536</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"mi\">1536</span>\n</code></pre></div>",
        "id": 491035319,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336249
    },
    {
        "content": "<p>The elaboration time with maxRecDepth increased is fast, but setting this globally triggers timeouts in other parts of my project.</p>",
        "id": 491035357,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336291
    },
    {
        "content": "<p>Any ideas how to debug this best?</p>",
        "id": 491035368,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735336305
    },
    {
        "content": "<p>With</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"o\">:={</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">reduceOfInt</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>we get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">unify</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">eq_self</span><span class=\"o\">:</span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">unify</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">            </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">          </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">        </span><span class=\"n\">true</span>\n\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">unify</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">eq_self</span><span class=\"o\">:</span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">unify</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">            </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">          </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">        </span><span class=\"n\">true</span>\n</code></pre></div>\n<p><code>eq_self</code> is one of the <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/Tactic/Simp.lean#L297\">simp only builtins</a></p>\n<p>looking at the trace of the unifier:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"o\">:={</span><span class=\"n\">failIfUnchanged</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">reduceOfInt</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>there seems to be a query at the end that goes bad:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">          </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">          </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">          </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span>\n<span class=\"w\">      </span><span class=\"o\">((</span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span>\n<span class=\"w\">            </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span>\n<span class=\"w\">          </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">        </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>Unfodling this trace it unfolds everything to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negSucc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">89884656743115795386465259539451236680898848947115328636715040578866337902750481566354238661203768010560056939935696678829394884407208311246423715319737062188883946712432742638151109800623047059726541476042502884419075341171231440736956555270413618581675255342293149119973622969239858152417678094443367890944</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">1023</span>\n</code></pre></div>\n<p>and at this point we are presumably computing <code>2 ^ 1023</code> in <code>whnf</code> and loose.</p>\n<p>I'm not quite sure what is creating the <code>?h</code> query but it looks similar to the ones that <code>eq_self</code> is asking for so it's potentially responsible here I guess?</p>",
        "id": 491035896,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1735336719
    },
    {
        "content": "<p>The same failure arises with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">--set_option maxRecDepth 1600</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">70368744177664</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">70368040490200</span><span class=\"bp\">#</span><span class=\"mi\">1023</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  tactic 'simp' failed, nested error:</span>\n<span class=\"cm\">  maximum recursion depth has been reached</span>\n<span class=\"cm\">  use `set_option maxRecDepth &lt;num&gt;` to increase limit</span>\n<span class=\"cm\">  use `set_option diagnostics true` to get diagnostic information</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> equal to `simp only [reduceOfInt]`-/</span>\n<span class=\"w\">  </span><span class=\"n\">simp?</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">reduceNeg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">reduceOfInt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">reduceAnd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">ofNat_eq_ofNat</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">-</span><span class=\"n\">bne_self_eq_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false_eq_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">reduceIte</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">reduceCtorEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">eq_self</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">-</span><span class=\"n\">bne_iff_ne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">ite_self</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">some_eq_ite_none_right</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">some_eq_ite_none_left</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Which should be equal to <code>simp only [reduceOfInt]</code>, but should not add eq_self to the simp set AFAIU.</p>",
        "id": 491037034,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735337656
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 491037039,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735337660
    },
    {
        "content": "<p>Yeah the simp.rewrit trace doesn't show it anymore like that but the defeq query remains, not clear to me what part of the system creates the defeq query then</p>",
        "id": 491037231,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1735337854
    },
    {
        "content": "<p>Is it possible that ground terms in an if-condition are somehow evaluated? Even though before reduction, the argument of the condition contained some variables.</p>",
        "id": 491037290,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735337885
    },
    {
        "content": "<p>If I am not mistaken, <code>simprocArrayCore</code> and <code>simprocCore</code> seem to create these equalities at <a href=\"https://github.com/leanprover/lean4/blob/fe45ddd6105078a0a3bd855e5d94673e794f6b88/src/Lean/Meta/Tactic/Simp/Simproc.lean#L312\">https://github.com/leanprover/lean4/blob/fe45ddd6105078a0a3bd855e5d94673e794f6b88/src/Lean/Meta/Tactic/Simp/Simproc.lean#L312</a> to apply the result of the simpproc.</p>",
        "id": 491068571,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735369937
    },
    {
        "content": "<p>This also seems relevant:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Given `h‚ÇÅ : a = b` and `h‚ÇÇ : b = c` returns a proof of `a = c`. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkEqTrans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"bp\">.</span><span class=\"n\">isAppOf</span><span class=\"w\"> </span><span class=\"ss\">``Eq.refl</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"bp\">.</span><span class=\"n\">isAppOf</span><span class=\"w\"> </span><span class=\"ss\">``Eq.refl</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">infer</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">infer</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÅ</span><span class=\"bp\">.</span><span class=\"n\">eq?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÇ</span><span class=\"bp\">.</span><span class=\"n\">eq?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getLevel</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkApp6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Eq.trans</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">u</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwAppBuilderException</span><span class=\"w\"> </span><span class=\"ss\">``Eq.trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"equality proof expected\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">hasTypeMsg</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÅ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwAppBuilderException</span><span class=\"w\"> </span><span class=\"ss\">``Eq.trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"equality proof expected\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">hasTypeMsg</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"w\"> </span><span class=\"n\">hType‚ÇÇ</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 491069518,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735370773
    },
    {
        "content": "<p>I guess mkEqTrans is creating <code>Eq.refl</code> in our case?</p>",
        "id": 491069535,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1735370812
    }
]