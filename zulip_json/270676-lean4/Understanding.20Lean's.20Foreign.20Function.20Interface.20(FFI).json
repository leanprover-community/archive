[
    {
        "content": "<p>I am sharing here a document that started as a few notes, morphed into a full blown reference and ended somewhere in between as a guide to understand how Lean does FFI today. It tries to approach the topic from a beginners point of view, but can get down to details too.</p>\n<p>I hope this is helpful to others here: <a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b\">Understanding Lean's Foreign Function Interface (FFI)</a></p>\n<p>And if you see mistakes, omissions or any feedback, please, let me know.</p>",
        "id": 452101098,
        "sender_full_name": "Yuri",
        "timestamp": 1721228373
    },
    {
        "content": "<p>BTW: I still want to add content for how to deal with external objects and closures.</p>",
        "id": 452102570,
        "sender_full_name": "Yuri",
        "timestamp": 1721228661
    },
    {
        "content": "<p>If you want to keep expanding on this, I really liked <a href=\"https://ocaml.org/manual/5.2/intfc.html\">https://ocaml.org/manual/5.2/intfc.html</a> and would love if we had a guide in this direction.</p>",
        "id": 452105491,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721229330
    },
    {
        "content": "<p>Hi, <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>! That’s a possibility, but I plan to spend some time gathering corrections and feedback before making any major changes.</p>\n<p>One concern I have, based on my experience so far, is that the FFI could benefit from a significant redesign to enhance its usability as a general FFI. While it works well as a low-overhead interface between C/C++ and Lean, it falls short in other areas.</p>\n<p>Therefore, I would think twice before investing much more energy into a comprehensive documentation revamp.</p>",
        "id": 452107090,
        "sender_full_name": "Yuri",
        "timestamp": 1721229656
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Lean's.20Foreign.20Function.20Interface.20.28FFI.29/near/452105491\">said</a>:</p>\n<blockquote>\n<p>If you want to keep expanding on this, I really liked <a href=\"https://ocaml.org/manual/5.2/intfc.html\">https://ocaml.org/manual/5.2/intfc.html</a> and would love if we had a guide in this direction.</p>\n</blockquote>\n<p>Out of curiosity, what specifically attracted you to it aside from presentation?</p>",
        "id": 452107773,
        "sender_full_name": "Yuri",
        "timestamp": 1721229837
    },
    {
        "content": "<p>Proposing to change:</p>\n<ul>\n<li>In \"Declaring Opaque Types\" <code>Inhabited</code> -&gt; <code>Nonempty</code> (certain operations -&gt; opaque functions' return types must be nonempty (and IIRC Inhabited if not marked extern?))</li>\n<li>Constructors without fields are stored as <code>lean_box(tag)</code>, the example <code>c_fallible_operation</code> allocates ctor obj for <code>Option.none</code></li>\n<li>Constructor layout mentions that <code>Char</code>s are stored with <code>UInt32</code>s, while they are stored with objects</li>\n<li>In \"Using C Structs Directly with Accessor Functions\" <code>Int32</code> and <code>lean_box_int32</code> are used, but they are not defined</li>\n<li>In \"Error Handling in Lean Code\" <code>()</code> is used as a type, and the wording in some places seems to advise using <code>IO</code> for fallible operations, regardless of purity</li>\n<li><code>IO</code> functions C implementations lack the \"RealWorld\" argument (UB?)</li>\n</ul>\n<p>Something that can be added:</p>\n<ul>\n<li>LEAN_CC environment variable</li>\n<li>Marking objects as MT/persistent</li>\n<li>Handling of constants (<code>Unit -&gt; T</code>)</li>\n<li>Thread initialization/finalization</li>\n<li><code>BaseIO</code> and <code>EIO</code></li>\n<li><code>@[extern c inline \"...\"]</code></li>\n<li>Precompile option in lakefile</li>\n<li>Example of using <code>lean_alloc_external</code>, <code>initialize</code> (<code>builtin_initialize</code>) external code (which can be used to initialize external object classes)</li>\n<li>Trivial wrappers</li>\n<li><code>Alloy</code> library and <code>lean_sys</code> rust crate</li>\n</ul>",
        "id": 452117587,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1721232372
    },
    {
        "content": "<p>This is a great list, thanks!</p>",
        "id": 452141517,
        "sender_full_name": "Yuri",
        "timestamp": 1721237499
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"463095\">@Yuri de Wit</span> Thanks for this. One thing that confused me: \"We pass <code>UInt8</code>, <code>UInt32</code>, and <code>Float</code> as unboxed values\"  seems to contradict \"<code>UInt64</code>, <code>USize</code>, and <code>Float</code> are always passed as boxed values\". Is <code>Float</code> boxed or an unboxed <code>double</code> in C?</p>",
        "id": 452242587,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1721276437
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"266304\">Siddhartha Gadgil</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Lean's.20Foreign.20Function.20Interface.20.28FFI.29/near/452242587\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> Thanks for this. One thing that confused me: \"We pass <code>UInt8</code>, <code>UInt32</code>, and <code>Float</code> as unboxed values\"  seems to contradict \"<code>UInt64</code>, <code>USize</code>, and <code>Float</code> are always passed as boxed values\". Is <code>Float</code> boxed or an unboxed <code>double</code> in C?</p>\n</blockquote>\n<p>Hi <span class=\"user-mention\" data-user-id=\"266304\">@Siddhartha Gadgil</span> , thanks for the feedback. I should make that clearer. When the scalar crosses the FFI bounded through an <code>@[extern ..]</code> function declaration it is passed unboxed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"c_process_scalars\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">processScalars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>And the corresponding C function:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">c_process_scalars</span><span class=\"o\">(</span><span class=\"n\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"bp\">..</span>\n</code></pre></div>\n<p>Note that <code>uint32_t</code> and <code>double</code> are passed unboxed and not as <code>lean_obj_arg</code> (boxed).</p>\n<p>In addition, Lean constructors (structure/inductive) have a layout that also stores scalars unboxed after all the boxed fields.</p>\n<p>One place where where I see the need to explicitly box and unbox scalar values in FFI is when dealing with closures in FFI, since the API expects always a <code>lean_object*</code> boxed parameter. But I guess there could be other places I am not aware. This makes me think that boxing and unboxing of scalars may have gotten more attention than it deserved.</p>",
        "id": 452324818,
        "sender_full_name": "Yuri",
        "timestamp": 1721303850
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"266304\">@Siddhartha Gadgil</span> , sorry, but I think I missed your original question:</p>\n<p><code>* </code>UInt8<code>, </code>UInt16<code>, and </code>Bool<code> are always passed unboxed in function calls.</code><br>\nvs<br>\n<code>* </code>UInt64<code>, </code>USize<code>, and </code>Float<code> are always passed as boxed values.</code></p>\n<p>What I meant to say here is that when you <code>lean_box_uint64</code> a <code>UInt64</code> you are effectively creating a constructor with one scalar field. The resulting <code>lean_object*</code> points to this constructor in the heap containing the scalar. Since <code>UInt8</code>, <code>Uint16</code> and maybe (depending on the machine architecture) <code>UInt32</code> can fit in a machine word, this constructor wrapping does not happen there and the scalar is stored in the actual pointer with the lowest bit set to  <code>1</code>.</p>\n<p>I will fix the doc.</p>",
        "id": 452326554,
        "sender_full_name": "Yuri",
        "timestamp": 1721304304
    },
    {
        "content": "<p>this is a great reference, thanks for making it!</p>",
        "id": 452334338,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1721306601
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"587706\">Daniil Kisel</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Lean's.20Foreign.20Function.20Interface.20.28FFI.29/near/452117587\">said</a>:</p>\n<blockquote>\n<ul>\n<li>Constructor layout mentions that <code>Char</code>s are stored with <code>UInt32</code>s, while they are stored with objects</li>\n</ul>\n</blockquote>\n<p>is this accurate? I thought <code>Char</code> is represented as <code>uint32_t</code> as a trivial wrapper struct but haven't tested anything. Just surprised because I think my code is working right now treating it as a <code>uint32_t</code> <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 452334741,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1721306698
    },
    {
        "content": "<p>oh, wait, trivial wrappers still change the layout when used in constructors... got it......</p>",
        "id": 452334922,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1721306742
    }
]