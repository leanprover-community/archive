[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover/lean4/pull/7428\">lean4#7428</a>, I added a <code>dsimp</code> cache to the <code>simp</code> state, so that in a single <code>simp</code> call different calls to <code>dsimp</code> share their cache.</p>\n<p>For example, when simplifying <code>a * b</code> for some <code>a b : A</code>, currently <code>dsimp</code> is ran on each <code>A</code> with a fresh cache, thus duplicating the work (recall <code>a * b</code> is <code>HMul.hMul A A A _ a b</code>). By keeping the cache, <code>A</code> only needs to be visited once.</p>\n<p>The resulting <a href=\"https://github.com/leanprover-community/mathlib4/pull/22812#issuecomment-2712043349\">Mathlib speedup</a> is enormous:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Metric</span><span class=\"w\">                 </span><span class=\"n\">Change</span>\n<span class=\"bp\">=============================</span>\n<span class=\"n\">instructions</span><span class=\"w\">            </span><span class=\"bp\">-</span><span class=\"mf\">8.1</span><span class=\"bp\">%</span>\n<span class=\"n\">task</span><span class=\"bp\">-</span><span class=\"n\">clock</span><span class=\"w\">              </span><span class=\"bp\">-</span><span class=\"mf\">7.4</span><span class=\"bp\">%</span>\n<span class=\"n\">simp</span><span class=\"w\">                   </span><span class=\"bp\">-</span><span class=\"mf\">45.6</span><span class=\"bp\">%</span>\n<span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">metavars</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mf\">11.7</span><span class=\"bp\">%</span>\n<span class=\"n\">share</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">exprs</span><span class=\"w\">      </span><span class=\"bp\">-</span><span class=\"mf\">8.2</span><span class=\"bp\">%</span>\n</code></pre></div>",
        "id": 504707070,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1741649288
    },
    {
        "content": "<p><code>build: -13458.961⬝10⁹(-8.06%)</code>!</p>",
        "id": 504707854,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741649733
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Enormous.20speedup.20from.20.60dsimp.60.20caching.20in.20.60simp.60/near/504707070\">said</a>:</p>\n<blockquote>\n<p>recall <code>a * b</code> is <code>HMul.hMul A A A _ a b</code></p>\n</blockquote>\n<p>Or more often (e.g. for <code>Field A</code>),</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">HMul</span><span class=\"bp\">.</span><span class=\"n\">hMul</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instHMul</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Distrib</span><span class=\"bp\">.</span><span class=\"n\">toMul</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">NonUnitalNonAssocSemiring</span><span class=\"bp\">.</span><span class=\"n\">toDistrib</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">NonUnitalNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">NonUnitalNonAssocCommRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">NonUnitalCommRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocCommRing</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">CommRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalCommRing</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">EuclideanDomain</span><span class=\"bp\">.</span><span class=\"n\">toCommRing</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">toEuclideanDomain</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">instField</span><span class=\"o\">)))))))))</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>which has 15 <code>A</code>s!</p>",
        "id": 504707954,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741649776
    },
    {
        "content": "<p>The performance gains seem to be very biased towards Category theory and AlgebraicGeometry, which makes since given that these have many dsimp-able expressions in place of types</p>",
        "id": 504708309,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741649973
    },
    {
        "content": "<p>I wonder if this also removes the need for the sequence <code>dsimp; simp</code>, which is sometimes faster than <code>simp</code>.</p>",
        "id": 504713474,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1741652657
    },
    {
        "content": "<p>This is great! The suggested <code>transformWithCache</code> seems pretty useful in itself.</p>",
        "id": 504852442,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741702161
    },
    {
        "content": "<p>Is there something that this PR is still waiting for?</p>",
        "id": 505974883,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742144369
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> we really don't want to touch <code>simp</code> at the moment, but I appreciate this speedup is extraordinary. It's on the radar, we aren't ignoring it.</p>",
        "id": 506072018,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742199009
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>, and others interested.</p>\n<p>After talking to Leo, we've decided we want to wait on this one, the considerable speed-up notwithstanding.</p>\n<p><code>simp</code> still needs a thorough overhaul, and it makes sense to do this all at once. (There's the outstanding issue of <code>dsimp</code> getting bogged down in proofs --- and the related question of how this PR interacts with that problem --- plus the bigger issue of <code>simp</code> switching to <code>dsimp</code> in implicit arguments often breaking reducible-level typechecking. There's also still problems with what <code>simp?</code> reports in some situations, etc. etc.)</p>\n<p>Next quarter Leo is doing some substantial work on extensions to <code>grind</code>, including work on Grobner bases and AC rewriting/matching. We think that <em>after</em> that we'll be well placed to return to <code>simp</code> (and possibly be able to integrate some of those features into <code>simp</code> itself), and so we want to bundle changes like this into that overhaul, which we expect to do in Q3 this year.</p>\n<p>I appreciate that this is a while to wait, but hopefully you can appreciate both that changes like this are touching absolutely critical components and we want to consider them carefully (not just for the impact on Mathlib), and that for the sake of efficiency we want to avoid too much context switching in the automation development work, and hence want to bundle this with other planned changes.</p>",
        "id": 507117106,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742526677
    },
    {
        "content": "<p>Although I would still really like to see the dsimp caching fixed in lean, if this isn't happening any time soon, at least we can go ahead and merge <a href=\"https://github.com/leanprover-community/mathlib4/pull/21330\">#21330</a>.</p>\n<p>I originally wanted to wait for the improvements in <code>simp</code> to see whether <a href=\"https://github.com/leanprover-community/mathlib4/pull/21330\">#21330</a> is still needed after that, but in the status quo, it is definitely an improvement.</p>",
        "id": 508938718,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743266504
    },
    {
        "content": "<p>Are there any public details about the planned Grobner bases support? E.g., what's the target generality?</p>",
        "id": 509093965,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1743391526
    },
    {
        "content": "<p>re: coefficients? That I'm not sure, I will ask.</p>",
        "id": 509095880,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743392973
    },
    {
        "content": "<p>I wonder how much work will we need to duplicate to make it useful for dealing with <code>CommRing</code>s or <code>ZMod</code>.</p>",
        "id": 509178564,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1743422254
    }
]