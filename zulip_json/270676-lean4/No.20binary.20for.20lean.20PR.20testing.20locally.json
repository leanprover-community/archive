[
    {
        "content": "<p>I noticed that binaries (sometimes?) seem to be only generated for Linux. This makes working on adaptations on the <code>lean-pr-testing-NNNN</code> branch locally awkward. (Here's <a href=\"#narrow/stream/287929-mathlib4/topic/optionEquivLeft_apply.20simp/near/446139289\">another message</a> I found about the same issue.)</p>\n<p>However, I'm not sure if this is typical now, or is just due to my (experimental) PR modifying basic meta code and updating stage0; I don't recall encountering this issue previously.</p>\n<p>I figure the current options are</p>\n<ol>\n<li>figure out how to make the release yourself from your fork</li>\n<li>ask a maintainer to add the release-ci label</li>\n<li>get access to a Linux machine somehow</li>\n</ol>\n<p>Are these in fact the only options?</p>\n<p>If this is just for stage0-modifying PRs, it's probably not too much of an issue. But I was curious if it's (now) a more widespread phenomenon, given that I saw another message about it. In that case, I'd wonder if it would be worth adding another option—for instance, the ability to add the release-ci label via a comment. (For reference, the PR I'm experimenting with is <a href=\"https://github.com/leanprover/lean4/pull/5341\">lean4#5341</a>.)</p>",
        "id": 470059696,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726267254
    },
    {
        "content": "<p>They are created for macos as well - we decided not to do windows, balancing fast CI vs me needing the toolchains on Mac regularly.</p>",
        "id": 470084771,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726284530
    },
    {
        "content": "<p>Hmm, I’m currently on Mac as well.</p>",
        "id": 470084788,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726284559
    },
    {
        "content": "<p>(But still got an error message involving ‘darwin’.)</p>",
        "id": 470084858,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726284623
    },
    {
        "content": "<p>I added release-ci</p>",
        "id": 470084965,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726284711
    },
    {
        "content": "<p>Not sure what's going on. I use release PRs on mac every day.</p>",
        "id": 470085097,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726284771
    },
    {
        "content": "<p>Are you on an M1/2/3 Mac, maybe? (I’m on an older Intel-based Mac.) (No idea if this is relevant.)</p>",
        "id": 470085155,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726284811
    },
    {
        "content": "<p>Yes, M2</p>",
        "id": 470089107,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726286667
    },
    {
        "content": "<p>Adding the label via a comment seems good. There's an existing workflow for this, so it just needs another case. Happy to merge such a PR.</p>",
        "id": 470089134,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726286694
    },
    {
        "content": "<p>I wonder what the right place is for people to hear that they need to comment <code>release-ci</code> if the PR testing toolchain doesn't work on their device.</p>\n<p>I put it in (1.) the pull request template for now, but could also imagine (2.) the PR testing bot comment and/or (3.) the <a href=\"https://leanprover-community.github.io/contribute/tags_and_branches.html\">docs</a> linked to by the PR testing bot comment.</p>\n<p>(Note: I think simply mentioning that the user can manage the tag if they want leaves too much information off the table, given the rather opaque tooltip on that tag, and the lack of reason to think that <code>toolchain-available</code> might not actually mean that the toolchain <em>you</em> need is available! :) )</p>",
        "id": 470108803,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726294030
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5343\">lean4#5343</a></p>",
        "id": 470108823,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726294037
    },
    {
        "content": "<p>Out of sheer coincidence, I also noticed that that PR (<a href=\"https://github.com/leanprover/lean4/pull/5343\">lean4#5343</a>) was generating every binary in CI even though I hadn't added <code>release-ci</code>! Note that the <code>level</code>, as seen under \"configure build matrix\" in <a href=\"https://github.com/leanprover/lean4/actions/runs/10859763037/job/30139540920\">these logs</a>, is 2 (the level for release CI PRs) when it should be 0.</p>\n<p>This led me to a bug: when the <code>check-level</code> is set in the workflow, we get the labels of the PR via <code>gh</code>, but some arguments to <code>gh</code> are unintentionally outside of the command subsitution (e.g. <code>$(gh ...) &lt;args&gt;</code> instead of <code>$(gh ... &lt;args&gt;)</code>).</p>\n<p>Fixed in <a href=\"https://github.com/leanprover/lean4/pull/5344\">lean4#5344</a>.</p>",
        "id": 470110304,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726294390
    },
    {
        "content": "<p>The relevant bit of logic was</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">labels</span><span class=\"bp\">=</span><span class=\"s2\">\"$(gh api repos/leanprover/lean4/pulls/5343) --jq '.labels'\"</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"$labels\"</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"s2\">\"release-ci\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"n\">check_level</span><span class=\"bp\">=</span><span class=\"mi\">2</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>The <code>grep</code> was then looking through the entire output of <code>gh api repos/leanprover/lean4/pulls/5343</code> (with <code>\"--jq '.labels'\"</code> appended), and since that PR happened to mention <code>release-ci</code>, it dutifully set the check level to 2 and behaved as though it were tagged <code>release-ci</code>!</p>\n<p>So, as an ultra-short-term workaround before <a href=\"https://github.com/leanprover/lean4/pull/5343\">lean4#5343</a> is merged, you can generate all toolchains by just adding <code>release-ci</code> to your PR description. <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 470112586,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726295683
    },
    {
        "content": "<p>Oops, thank you for sorting that out!</p>",
        "id": 470116615,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726298611
    }
]