[
    {
        "content": "<p>The following (partially minimized) code crashes on the last line with Lean v4.11.0-rc2. Happy to file an issue if that's the next step, but I thought I'd ask here first.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">UInt</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">CommRing</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int64</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">natCast</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">reprPrec</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">7</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"bp\">.</span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"bp\">⟩⟩</span>\n\n<span class=\"c1\">-- Crash here</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨-</span><span class=\"mi\">60</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 463049853,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723929348
    },
    {
        "content": "<p>Not related to <code>UInt64.CommRing</code> after all. Here's more minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">UInt</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"bp\">.</span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fixed</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n\n<span class=\"c1\">-- Crash here</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fixed</span><span class=\"bp\">.</span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">7</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨-</span><span class=\"mi\">60</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 463050697,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930109
    },
    {
        "content": "<p>Minimized further:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">UInt</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- Crash here</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">60</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 463050843,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930277
    },
    {
        "content": "<p>Your last mwe does not crash on <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a></p>",
        "id": 463051111,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930587
    },
    {
        "content": "<p>Neither does the first</p>",
        "id": 463051116,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930602
    },
    {
        "content": "<p>I'm on leanprover/lean4:v4.11.0-rc2. Does that match?</p>",
        "id": 463051136,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930647
    },
    {
        "content": "<p>Lean.versionString gives the same on live yes</p>",
        "id": 463051151,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930681
    },
    {
        "content": "<p>can you locally mwe it further to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- Crash here</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"bp\">-</span><span class=\"mi\">60</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>?</p>",
        "id": 463051288,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930809
    },
    {
        "content": "<p>just to get mathlib out of the picture entirely</p>",
        "id": 463051326,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930872
    },
    {
        "content": "<p>No, I'm using UInt64 negation and shifting. I updated mathlib again and it didn't make a difference.</p>",
        "id": 463051361,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930888
    },
    {
        "content": "<p>I suppose I need to pull out the definitions of those two operators next.</p>",
        "id": 463051368,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930900
    },
    {
        "content": "<p>shifting is a built in</p>",
        "id": 463051372,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930907
    },
    {
        "content": "<p>negation should be equivalent to <code>0 - 60</code>?</p>",
        "id": 463051376,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930914
    },
    {
        "content": "<p>Changing it to <code>0 - 60</code> fixes it.</p>",
        "id": 463051419,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723930935
    },
    {
        "content": "<p>Aha, so mathlib's neg instance is up to something</p>",
        "id": 463051423,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930946
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">        </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>hmmm</p>",
        "id": 463051435,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723930987
    },
    {
        "content": "<p>that should be fine assuming the negation on Fin n is correct</p>",
        "id": 463051446,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931022
    },
    {
        "content": "<p>I inlined the two instances but then it doesn't crash:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mod_lt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"bp\">⟩⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- Doesn't crash</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">repoint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">60</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 463051516,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931077
    },
    {
        "content": "<p>Inlining just the <code>Neg UInt64</code> instance and importing <code>Data.Fin.Basic</code> also fixes the crash.</p>",
        "id": 463051670,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931154
    },
    {
        "content": "<p>That sure is interesting</p>",
        "id": 463051769,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931174
    },
    {
        "content": "<p>So something that mathlib is doing is making this misbehave</p>",
        "id": 463051801,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931184
    },
    {
        "content": "<p>I'm not replicating this crash</p>",
        "id": 463051866,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931206
    },
    {
        "content": "<p>I am suspecting some runtime issue</p>",
        "id": 463051919,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931228
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span> what platform are you on?</p>",
        "id": 463051954,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931239
    },
    {
        "content": "<p>Mac, and I'm getting the crash in both VSCode and on the commandline.</p>",
        "id": 463052004,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931260
    },
    {
        "content": "<p>intel or ARM mac?</p>",
        "id": 463052040,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931272
    },
    {
        "content": "<p>could be GMP related</p>",
        "id": 463052046,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931274
    },
    {
        "content": "<p>Does it replicate with UInt8 instead of UInt64?</p>",
        "id": 463052137,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931292
    },
    {
        "content": "<p>I thought we didn't depend on GMP?</p>",
        "id": 463052140,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931293
    },
    {
        "content": "<p>mac doesn't depend on GMP</p>",
        "id": 463052251,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931336
    },
    {
        "content": "<p>UInt8, 16, 32 are fine. Only 64 is bad.</p>",
        "id": 463052291,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931350
    },
    {
        "content": "<p>It sure is confusing that it works with the instances inlined but not when the code is in mathlib</p>",
        "id": 463052423,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931399
    },
    {
        "content": "<p>And that it doesn't replicate for others!</p>",
        "id": 463052499,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931411
    },
    {
        "content": "<p>how would that change the behavior of GMP if GMP is at fault</p>",
        "id": 463052513,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931415
    },
    {
        "content": "<p>well i assume mario is not on mac, neither am I</p>",
        "id": 463052534,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1723931422
    },
    {
        "content": "<p>Try deleting the cache files for mathlib and rebuild <code>Mathlib.Data.UInt</code> locally</p>",
        "id": 463052546,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931426
    },
    {
        "content": "<p>The cache files are not completely architecture independent, because they are stored in GMP format only when GMP is enabled</p>",
        "id": 463052764,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931490
    },
    {
        "content": "<p>leangz has to make the appropriate conversion based on the OS, but if lean has recently changed the settings on when GMP is enabled there could be an issue here</p>",
        "id": 463052930,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931539
    },
    {
        "content": "<p>because for some reason this isn't logged in the file at all so leangz has to make an educated guess</p>",
        "id": 463053050,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931580
    },
    {
        "content": "<p>Building without a cache fixes it.</p>",
        "id": 463053318,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931655
    },
    {
        "content": "<p>Yikes!</p>",
        "id": 463053355,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723931667
    },
    {
        "content": "<p>I double checked the release settings, seems GMP is still enabled on linux x64</p>",
        "id": 463053908,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931846
    },
    {
        "content": "<p>it's really annoying that there is no easy <code>#eval Lean.useGMP</code> declaration I can look at</p>",
        "id": 463054045,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931883
    },
    {
        "content": "<p>it just silently changes the entire ABI of the application with no other visible differences</p>",
        "id": 463054114,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931909
    },
    {
        "content": "<p>But in that case I'm still confused, has something changed in the non-GMP ABI recently?</p>",
        "id": 463054258,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723931963
    },
    {
        "content": "<p>ARM Mac, by the way: M2 MacBook Air.</p>",
        "id": 463054523,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723932173
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span> I have a test for you: Can you check out <a href=\"https://github.com/leanprover-community/mathlib4/tree/mpz-test\">branch#mpz-test</a> (downloading the cache), create a new file, import <code>Mathlib.MpzTest</code> and see what <code>#print foo</code> gives?</p>",
        "id": 463055134,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723932886
    },
    {
        "content": "<p>the correct result is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MpzTest</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"c1\">-- def foo : Nat :=</span>\n<span class=\"c1\">-- 68915718021581205938132336367</span>\n</code></pre></div>",
        "id": 463055170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723932944
    },
    {
        "content": "<p>but if something is broken you might end up seeing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"bp\">******************************</span>\n</code></pre></div>\n<p>instead</p>",
        "id": 463055224,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723932982
    },
    {
        "content": "<p>Will try tomorrow; off to sleep now.</p>",
        "id": 463055231,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1723932998
    },
    {
        "content": "<p>anyone else on an ARM mac is welcome to try the test</p>",
        "id": 463055241,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723933014
    },
    {
        "content": "<p>On ARM mac, I see</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"mi\">0</span>\n</code></pre></div>\n<p>:-(</p>",
        "id": 463066214,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723939066
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Can you open <code>.lake/build/lib/Mathlib/MpzTest.olean</code> with the vscode hex editor and search for <code>EFBE</code>?</p>",
        "id": 463067240,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723939909
    },
    {
        "content": "<p>or actually just send me the olean file</p>",
        "id": 463067290,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723939929
    },
    {
        "content": "<p>I get the same output as <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, and here's <code>MpzTest.olean</code>:</p>\n<p><a href=\"/user_uploads/3121/fWIbEDWVY2fT4iwm8sLwkNKt/MpzTest.olean\">MpzTest.olean</a></p>",
        "id": 463229002,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724009732
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span> Could you also delete <code>MpzTest.olean</code>, run <code>lake build Mathlib.MpzTest</code> to regenerate it, then send me that olean file as well?</p>",
        "id": 463241895,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015076
    },
    {
        "content": "<p>Done, but it still says foo is 0. Is <code>rm .lake/build/lib/Mathlib/MpzTest.*</code> the wrong command to have run before building?</p>\n<p><a href=\"/user_uploads/3121/c7ayNq3Dw5tc6_QSQK-kIToX/MpzTest-rebuilt.olean\">MpzTest-rebuilt.olean</a></p>",
        "id": 463242036,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724015193
    },
    {
        "content": "<p>oh that's weird, you could try just nuking <code>.lake</code> altogether and then <code>lake build Mathlib.MpzTest</code>, since it has no dependencies</p>",
        "id": 463242092,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015267
    },
    {
        "content": "<p>Okay, now foo is 68915718021581205938132336367.</p>\n<p><a href=\"/user_uploads/3121/v5xd0Wai_31r-kx4eJXVICht/MpzTest-fresh.olean\">MpzTest-fresh.olean</a></p>",
        "id": 463242210,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724015347
    },
    {
        "content": "<p>...this is a GMP enabled olean file, it's identical to my linux x86 olean</p>",
        "id": 463242395,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015496
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Crashing.20bug.2C.20possibly.20related.20to.20UInt64.20arithmetic/near/463054045\">said</a>:</p>\n<blockquote>\n<p>it's really annoying that there is no easy <code>#eval Lean.useGMP</code> declaration I can look at</p>\n</blockquote>\n<p>Presumably you also want this flag in the olean file itself, and for them to be checked for consistency at olean-load time?</p>",
        "id": 463242414,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724015515
    },
    {
        "content": "<p>indeed</p>",
        "id": 463242461,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015525
    },
    {
        "content": "<p>Just need some way of detecting whether GMP is used by doing certain very complicated calculations.</p>\n<p><a href=\"https://en.wikipedia.org/wiki/Dark_Integers\">https://en.wikipedia.org/wiki/Dark_Integers</a></p>",
        "id": 463242503,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724015585
    },
    {
        "content": "<p>it's actually pretty easy to tell by looking at an olean file whether it's using GMP or non-GMP bignums, they look quite different in the binary. The trouble is that leangz has to make a guess whether the lean it's supposed to be generating an olean file for uses GMP or not, the input file doesn't know anything about that since it's cross platform</p>",
        "id": 463242641,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015723
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span> just to confirm, what's your <code>lean-toolchain</code>?</p>",
        "id": 463242751,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724015789
    },
    {
        "content": "<p>leanprover/lean4:v4.11.0-rc2</p>",
        "id": 463242777,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724015809
    },
    {
        "content": "<p>indeed, the <a href=\"https://github.com/leanprover/lean4/blob/0edf1bac392f7e2fe0266b28b51c498306363a84/.github/workflows/ci.yml#L191-L213\">workflow file</a> no longer says <code>USE_GMP=OFF</code> on macos (both x86 and arm)</p>",
        "id": 463243338,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016292
    },
    {
        "content": "<p>changed in <a href=\"https://github.com/leanprover/lean4/commit/d1a96f6d8f867100428a243521f2047fb9d9217e\">https://github.com/leanprover/lean4/commit/d1a96f6d8f867100428a243521f2047fb9d9217e</a> by <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span></p>",
        "id": 463243654,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016574
    },
    {
        "content": "<p>That looks like it was most likely a typo. Are there any CI tests that would catch this?</p>",
        "id": 463243772,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724016664
    },
    {
        "content": "<p>if mathlib CI had some kind of MPZ test in it then possibly lean's nightly-testing or PR testing branches of mathlib would have caught the issue</p>",
        "id": 463243953,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016758
    },
    {
        "content": "<p>currently, MPZ representation is the only architecture dependent behavior leangz has to deal with during decompression</p>",
        "id": 463243995,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016806
    },
    {
        "content": "<p>(and it's not even architecture dependent, it's cmake option dependent, which means this breaks whenever someone thinks that it's fine to change the default cmake options on release builds for an arch)</p>",
        "id": 463244110,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016921
    },
    {
        "content": "<p>BTW this also impacts FFI code trying to interact with lean</p>",
        "id": 463244132,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016954
    },
    {
        "content": "<p>Certainly the <code>olean</code> file format should be platform independent, in the sense that any platform can read any platform's generated oleans.</p>",
        "id": 463244176,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724016970
    },
    {
        "content": "<p>this is definitely not the case</p>",
        "id": 463244190,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724016987
    },
    {
        "content": "<p>But not for any fundamental reason, right?</p>",
        "id": 463244193,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724016999
    },
    {
        "content": "<p>yes for a fundamental reason, it's an in memory data structure serialized directly to disk</p>",
        "id": 463244211,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017023
    },
    {
        "content": "<p>the only reason we don't have worse issues is because we don't care to support big endian architectures</p>",
        "id": 463244228,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017047
    },
    {
        "content": "<p>Ah, and also mmapped back, which blocks flags being the solution.</p>",
        "id": 463244236,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724017055
    },
    {
        "content": "<p>oleans would look completely different there</p>",
        "id": 463244239,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017061
    },
    {
        "content": "<p>oleans aren't deserialized, they are mmapped, there is no opportunity to make modifications to the bits unless you do platform independent data structure access at runtime</p>",
        "id": 463244303,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017104
    },
    {
        "content": "<p>that's why leangz has to deal with the issue, because it actually does have a deserialization step</p>",
        "id": 463244318,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017129
    },
    {
        "content": "<p><code>olean</code>s weren't really designed as something intended to be shared between devices, right? That's just the way mathlib has always used them?</p>",
        "id": 463244320,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724017134
    },
    {
        "content": "<p>yes, they really should have considered this issue from the start but they didn't and now we are stuck with this design</p>",
        "id": 463244341,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724017163
    },
    {
        "content": "<p>It still seems like we can benefit from oleans being platform independent, in the sense of adding the flags, even if we only use the flags to yell.</p>",
        "id": 463244452,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724017268
    },
    {
        "content": "<p>The flags can then in theory be used to do the translation wherever.</p>",
        "id": 463244472,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724017282
    },
    {
        "content": "<p>It's delightful that this commit is the one that lifted Apple Silicon Macs from Tier 2 to Tier 1. :)</p>",
        "id": 463245056,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724017772
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> After talking about this issue with some others, I think the best fix is to bump the olean version from 1 to 2, since this is a data format change which should really be recorded in the olean file itself. Unfortunately we'll have some casualties for all in between versions, which is unfortunate since it's everything from v4.9.0-rc1 to v4.11.0-rc2.</p>",
        "id": 463275372,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724033078
    },
    {
        "content": "<p>leangz patch prepared at <a href=\"https://github.com/digama0/leangz/compare/olean2\">https://github.com/digama0/leangz/compare/olean2</a> , but this version will need to be updated every lean release until the olean version is bumped (<a href=\"https://github.com/leanprover/lean4/pull/5089\">lean4#5089</a>)</p>",
        "id": 463283926,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724037006
    },
    {
        "content": "<p>the best fix would be if lean could just record the status of flags like <code>USE_GMP</code> in a json file or similar somewhere in the distribution, so that external tools can just read that instead of making guesses</p>",
        "id": 463284165,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724037156
    },
    {
        "content": "<p>I believe we'll want to go back to using GMP on every platform, former restrictions are not applicable anymore. And then bump the olean version again.</p>",
        "id": 463428033,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724079464
    },
    {
        "content": "<p>What were the restrictions before?</p>",
        "id": 463441021,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1724082607
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/270676-lean4/topic/Crashing.20bug.2C.20possibly.20related.20to.20UInt64.20arithmetic/near/463428033\">said</a>:</p>\n<blockquote>\n<p>I believe we'll want to go back to using GMP on every platform, former restrictions are not applicable anymore. And then bump the olean version again.</p>\n</blockquote>\n<p>Even if this is the case, if the build-from-source still permits non GMP builds, then it would be useful to encode this flag in the oleans</p>",
        "id": 466498773,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725096183
    },
    {
        "content": "<p>Has this bug been fixed yet? <code>leanprover/lean4:v4.12.0</code> seems to still be broken.</p>",
        "id": 474354843,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1727889751
    },
    {
        "content": "<p>No</p>",
        "id": 474374968,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727895752
    },
    {
        "content": "<p>but watch <a href=\"https://github.com/leanprover/lean4/pull/5144\">lean4#5144</a> for movement</p>",
        "id": 474375214,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727895816
    },
    {
        "content": "<p>Oh it's actually green? incredible</p>",
        "id": 474377609,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1727896436
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span> The fix is now on mathlib master, so LMK if things look alright now.</p>",
        "id": 480436573,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730724525
    },
    {
        "content": "<p>Confirmed that it works fine now, thank you! <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 481365516,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1731090278
    }
]