[
    {
        "content": "<p>If I'm writing a metaprogramming function that takes some syntax of a particular non-extensible kind (in the particular example below, <code>Lean.Parser.Term.bracketedBinder</code>), analyses it and outputs other syntax using syntax quasiquotation, what is the most best monad to put it in so that it's accessible from  as many of the metaprogramming monads as possible?</p>\n<p>To be precise, the function uses  the <code>`(stuff $x stuff...)</code> notation to match the input syntax and to produce the output syntax. It also needs a default return for the 'fallback' case of the match. Most code I've seen uses <code>throwUnsupportedSyntax</code> here, but it seems to me that in this case <code>unreachable!</code> would also be appropriate since the syntax comes from a non-extensible parser so we know all possible notations for it in advance.</p>\n<p>If <code>unreachable!</code> is fine, then a <code>MonadQuotation</code> monad is the most general monad usable here, but if <code>throwUnsupportedSyntax</code> is used, then <code>MonadError</code> is also needed, and <code>MonadQuotation</code>, <code>MonadError</code> both extend <code>MonadRef</code> which makes me wary. Is there a common typeclass extending both <code>MonadQuotation</code> and <code>MonadError</code>? Alternatively, is there some fixed monad like <code>CoreM</code> or something that will silently lift to any monad used in practice? (<code>CoreM</code> lifts to <code>MetaM</code> and <code>TermElabM</code> but not <code>CommandElabM</code>, which surprises me, since I thought <code>CommandElabM</code> extends <code>MetaM</code>.)</p>\n<p>For concreteness, here is one such function:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">splitBinder</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadQuotation</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``bracketedBinder</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``bracketedBinder</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">ids</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">ids</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">})</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">⦄)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">ids</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">⦄)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">])]</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bracketedBinderF</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">])]</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>",
        "id": 525397511,
        "sender_full_name": "Raghuram",
        "timestamp": 1750707719
    },
    {
        "content": "<p>I think <code>MacroM</code> can be called from a lot of places but I'm not really sure</p>",
        "id": 525397824,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750707899
    },
    {
        "content": "<p>Actually <code>MacroM</code> can't be called from <code>MetaM</code> so I'm not so sure anymore</p>",
        "id": 525398900,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750708438
    },
    {
        "content": "<p>the best option is to just use a bunch of monad classes</p>",
        "id": 525402057,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750709921
    },
    {
        "content": "<p>core doesn't really care about diamond problems unless they actually result in different behavior</p>",
        "id": 525402168,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750709976
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"501683\">Raghuram</span> <a href=\"#narrow/channel/270676-lean4/topic/Appropriate.20monad.20for.20functions.20using.20syntax.20quasiquotation/near/525397511\">said</a>:</p>\n<blockquote>\n<p>since I thought <code>CommandElabM</code> extends <code>MetaM</code></p>\n</blockquote>\n<p>it doesn't. <code>CommandElabM</code> is separate from the <code>CoreM</code> -&gt; <code>MetaM</code> -&gt; <code>TermElabM</code> -&gt; <code>TacticM</code> chain</p>",
        "id": 525402356,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750710071
    },
    {
        "content": "<p>there are adaptor functions you can call going in lots of directions but you can't just coerce</p>",
        "id": 525402427,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750710099
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/04_metam.html\">Huh</a>. Should this be edited then?</p>\n<blockquote>\n<p>These monads extend each other, so a <code>MetaM</code> operation also has access to the environment and a <code>TermElabM</code> computation can use metavariables. There are also other monads which do not neatly fit into this hierarchy, e.g. <code>CommandElabM</code> extends <code>MetaM</code> but neither extends nor is extended by <code>TermElabM</code>.</p>\n</blockquote>",
        "id": 525402490,
        "sender_full_name": "Raghuram",
        "timestamp": 1750710128
    },
    {
        "content": "<p>yeah that line is just wrong</p>",
        "id": 525402612,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750710189
    },
    {
        "content": "<p>Here's a monad map maintained on the mathlib wiki: <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Monad-map\">https://github.com/leanprover-community/mathlib4/wiki/Monad-map</a></p>",
        "id": 525404024,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750710920
    },
    {
        "content": "<blockquote>\n<p>In this diagram, you see <strong>bold</strong> lines and <strong>dotted</strong> lines. The direction of the <strong>dotted</strong> lines is correct, however you should mentally reverse the direction of the <strong>bold</strong> lines (we cannot easily reverse them in the diagram because of the mermaid graph limitations!).</p>\n</blockquote>\n<p>I feel like this line does more to make me confused about what direction things go in than if it were to just not say this and own the direction given (because now for the description saying \"a bold arrow from LEFT to RIGHT\" I don't know whether I should apply a reversal when reading this)</p>",
        "id": 525404415,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750711150
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"501683\">@Raghuram</span> It's pretty common to run CoreM/MetaM/TermElabM from CommandElabM. Random examples from core:</p>\n<ul>\n<li><a href=\"https://github.com/leanprover/lean4/blob/22cd34c341200986cbcbdbb8d1d40c24db595bf5/src/Lean/Elab/MutualInductive.lean#L1041-L1042\">https://github.com/leanprover/lean4/blob/22cd34c341200986cbcbdbb8d1d40c24db595bf5/src/Lean/Elab/MutualInductive.lean#L1041-L1042</a></li>\n<li><a href=\"https://github.com/leanprover/lean4/blob/22cd34c341200986cbcbdbb8d1d40c24db595bf5/src/Lean/Elab/Deriving/DecEq.lean#L124-L129\">https://github.com/leanprover/lean4/blob/22cd34c341200986cbcbdbb8d1d40c24db595bf5/src/Lean/Elab/Deriving/DecEq.lean#L124-L129</a></li>\n</ul>\n<p>The second one in particular is for assembling a big command using syntax quotations, then running the command. Basically a MetaM-directed macro.</p>",
        "id": 525404419,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750711153
    },
    {
        "content": "<p>the dotted lines are also not even directed</p>",
        "id": 525404469,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750711182
    },
    {
        "content": "<p>I guess the answer to my original question is \"use typeclasses and don't worry about diamonds\" then.</p>",
        "id": 525425085,
        "sender_full_name": "Raghuram",
        "timestamp": 1750725120
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"501683\">Raghuram</span> has marked this topic as resolved.</p>",
        "id": 525425094,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750725123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"501683\">Raghuram</span> <a href=\"#narrow/channel/270676-lean4/topic/.E2.9C.94.20Appropriate.20monad.20for.20functions.20using.20syntax.20quasiquota.2E.2E.2E/near/525397511\">said</a>:</p>\n<blockquote>\n<p><code>unreachable!</code> would also be appropriate since the syntax comes from a non-extensible parser so we know all possible notations for it in advance.</p>\n</blockquote>\n<p>This is not fine by the way, since the syntax might come from a parse error.</p>",
        "id": 525425305,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750725403
    },
    {
        "content": "<p>I don't think I understand - if there's a parse error, the syntax shouldn't get passed to the rest of the system (macro, elab, etc.) right?</p>",
        "id": 525425383,
        "sender_full_name": "Raghuram",
        "timestamp": 1750725494
    },
    {
        "content": "<p>It does get passed to the rest of the system. This partial syntax is what helps the system make some progress and give useful information.</p>",
        "id": 525425475,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750725584
    },
    {
        "content": "<p>For example, here you can hover over <code>x</code> and <code>3</code> and see that the system says that they are <code>Nat</code>s:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>That's despite the fact that the rest of the <code>let</code> expression is missing.</p>",
        "id": 525425637,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750725686
    },
    {
        "content": "<p>in general syntax match is not great at handling syntax with missing pieces though</p>",
        "id": 525425837,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750725847
    },
    {
        "content": "<p>the matching code is written as though <code>.missing</code> doesn't exist and then the functions do their best to propagate something, which means it's not really clear what invariants you can count on after a match</p>",
        "id": 525425904,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750725917
    },
    {
        "content": "<p>Yeah, this <code>let</code> thing only works because it doesn't use syntax matches, it extracts components from the syntax manually. Still, you can't count on having correctly formed Syntax.</p>",
        "id": 525426062,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750726072
    },
    {
        "content": "<p>There are a number of subtle things in the elaborator with <code>.missing</code>. For example, <code>binderIdent</code> tends to have an explicit check for whether it's an <code>ident</code>, and then if not it assumes it was a <code>_</code>. That means that when it's <code>.missing</code> the elaborator still does something sensible. (If it were to assume it were actually an <code>ident</code>, you'd get <code>Name.anonymous</code> if I remember correctly)</p>",
        "id": 525426127,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750726147
    }
]