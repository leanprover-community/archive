[
    {
        "content": "<p>So I'm trying very simple examples of metaprogramming. I want to replace a given syntax with the literal 4. But this seems to fail in an incomprehensible way.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">yellow</span>\n\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>In particular I don't understand what \"elaboration function for 'num' has not been implemented\" is supposed to do. All I want is to replace yellow by 4</p>",
        "id": 526886766,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751494172
    },
    {
        "content": "<p>You wrote <code>syntax (name := a) \"yellow\" : command</code>, surely what you actually want is <code>syntax (name := a) \"yellow\" : term</code>?</p>",
        "id": 526887070,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751494394
    },
    {
        "content": "<p>I don't know. I used the first example and modified it a bit. <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/02_overview.html\">https://leanprover-community.github.io/lean4-metaprogramming-book/main/02_overview.html</a></p>",
        "id": 526887309,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751494564
    },
    {
        "content": "<p>But yes, everything works by replacing command with term</p>",
        "id": 526887349,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751494591
    },
    {
        "content": "<p>I guess commands are outside of defs? And terms are inside of defs?</p>",
        "id": 526887413,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751494626
    },
    {
        "content": "<p>Commands are stuff like <code>#check id</code>, <code>set_option pp.all true</code>, <code>def x : True := trivial</code>, and <code>open Lean Elab Command</code></p>",
        "id": 526887581,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751494726
    },
    {
        "content": "<p>Terms are stuff like <code>3 + 3</code>, <code>Int</code>, <code>fun x =&gt; -x + 3</code>, and <code>if h : ∃ (x : α), f x = y then h.choose else Classical.arbitrary α</code>.</p>",
        "id": 526887678,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751494788
    },
    {
        "content": "<p>Ah, so everything that is red in vscode is a command? <br>\n<a href=\"/user_uploads/3121/e8e1g1vp-h5Hxe-TbbVGoeSF/image.png\">image.png</a><br>\nWell except the import it seems</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/e8e1g1vp-h5Hxe-TbbVGoeSF/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"405x309\" src=\"/user_uploads/thumbnail/3121/e8e1g1vp-h5Hxe-TbbVGoeSF/image.png/840x560.webp\"></a></div>",
        "id": 526887752,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751494832
    },
    {
        "content": "<p>I'm not sure if <code>import</code> counts as a command</p>",
        "id": 526887803,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751494861
    },
    {
        "content": "<p>Other than the <code>import Lean</code> you have four commands here, they are<br>\nthe open namespaces</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n</code></pre></div>\n<p>the syntax declaration</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>\n<p>the macro definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n</code></pre></div>\n<p>and the test definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">yellow</span>\n\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 526887986,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751494975
    },
    {
        "content": "<p>You also have a lot of terms, they are</p>\n<ul>\n<li><code>Syntax.mkNatLit</code></li>\n<li><code>4</code></li>\n<li><code>Syntax.mkNatLit 4</code></li>\n<li><code>return Syntax.mkNatLit 4</code></li>\n<li><code>fun stx =&gt; return Syntax.mkNatLit 4</code></li>\n<li><code>Macro</code></li>\n<li><code>True</code></li>\n<li><code>yellow</code></li>\n<li><code>by\n  let a := yellow\n  sorry</code></li>\n</ul>",
        "id": 526888670,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751495370
    },
    {
        "content": "<p>Ah ok, I see. I tried to do a tactic that does nothing.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">yellow</span>\n<span class=\"w\">  </span><span class=\"n\">testTactic</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I want to learn the desugared version first.</p>",
        "id": 526889020,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751495573
    },
    {
        "content": "<p>Or is command_elab wrong here?</p>",
        "id": 526889124,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751495615
    },
    {
        "content": "<p><code>command_elab</code> is for commands, you want <code>@[tactic b]</code></p>",
        "id": 526889128,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751495620
    },
    {
        "content": "<p>Ah I see But the picture here doesn't have this one listed.<br>\n<a href=\"/user_uploads/3121/MvGWOG_9ORfPXeNQ_YOpKskg/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/MvGWOG_9ORfPXeNQ_YOpKskg/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1549x1401\" src=\"/user_uploads/thumbnail/3121/MvGWOG_9ORfPXeNQ_YOpKskg/image.png/840x560.webp\"></a></div>",
        "id": 526889222,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751495678
    },
    {
        "content": "<p>yeah, so I had to figure it out by trial and error</p>",
        "id": 526889269,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751495706
    },
    {
        "content": "<p><code>@[tactic b]</code> expects a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.Tactic#doc\">docs#Lean.Elab.Tactic.Tactic</a>, which is defined as <code>Syntax → TacticM Unit</code></p>",
        "id": 526889313,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751495744
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">yellow</span>\n<span class=\"w\">  </span><span class=\"n\">testTactic</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>This one works <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 526889408,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751495817
    },
    {
        "content": "<p>Yeah what's very confusing is there are many different ways to define stuff. <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/09_tactics.html\">https://leanprover-community.github.io/lean4-metaprogramming-book/main/09_tactics.html</a> has another approach and I don't know what they are doing.</p>",
        "id": 526889558,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751495936
    },
    {
        "content": "<p>All of them desugar to what you wrote now</p>",
        "id": 526889631,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1751495985
    },
    {
        "content": "<p>Ah perfect, so this is the desugared version. Also another question. how can I think about fun stx =&gt; withMaincontext do ... Is this injecting a MainContext so that I have it available in the do block or what is it doing.</p>\n<p>The type appears to be (TacticM a ) -&gt; (TacticM a), so in principle, if there were multiple monads I could just concatenate them like withMainContext withSecondaryMonad withCustomMonad do ...? Do I see this correctly?</p>",
        "id": 526889865,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496182
    },
    {
        "content": "<p>It puts you into the local context of the main goal's meta variable, that should be explained in the book.</p>",
        "id": 526889924,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1751496235
    },
    {
        "content": "<p>Yeah, but that's not what I was asking.I know what it does on an abstract level, I just don't understand the notation as it is unfamiliar notation compared to other programming languages. Could I in principle chain those monads if I need more of them. Because learning this looks kind of weird.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">But</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">our</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">withMainContext</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">computes</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>This is the section of the mainContext, could I in principle combine the mainContext with something custom made, that extends my tactics in a special way?</p>",
        "id": 526890415,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496625
    },
    {
        "content": "<p>Can you give an example? I don't really understand what you mean.</p>",
        "id": 526890467,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751496674
    },
    {
        "content": "<p>Yes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span>\n</code></pre></div>",
        "id": 526890533,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496725
    },
    {
        "content": "<p>Except replace the second withMainContext with a different monad that has custom functionality.</p>",
        "id": 526890592,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496762
    },
    {
        "content": "<p>It's just an unfamiliar paradigm to me.</p>",
        "id": 526890622,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496783
    },
    {
        "content": "<p>Just to check, you're aware that <code>withMainContext </code> is not syntax and just a regular function call?</p>",
        "id": 526890668,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751496821
    },
    {
        "content": "<p>The <code>do</code> notation above is sugar for <code>fun stx =&gt; withMainContext (withMainContext (pure ()))</code></p>",
        "id": 526890735,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751496869
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"725717\">metakuntyyy</span> <a href=\"#narrow/channel/270676-lean4/topic/Metaprogramming.20syntax/near/526889865\">said</a>:</p>\n<blockquote>\n<p>Ah perfect, so this is the desugared version. Also another question. how can I think about fun stx =&gt; withMaincontext do ... Is this injecting a MainContext so that I have it available in the do block or what is it doing.</p>\n<p>The type appears to be (TacticM a ) -&gt; (TacticM a), so in principle, if there were multiple monads I could just concatenate them like withMainContext withSecondaryMonad withCustomMonad do ...? Do I see this correctly?</p>\n</blockquote>\n<p>Yeah, I wrote that it is a TacticM to TacticM function. I want to know if I have multiple of those if I can chain them so that I can get functionality of all of them?</p>",
        "id": 526890765,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751496890
    },
    {
        "content": "<p>Yes, for example <code>Term.withSynthesize &lt;| withMainContext do (stuff)</code></p>",
        "id": 526890974,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751497050
    },
    {
        "content": "<p>Ah, let me find out what &lt;| means.</p>",
        "id": 526891040,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751497113
    },
    {
        "content": "<p>It's just simpler syntax for parenthesis <code>Term.withSynthesize (withMainContext do (stuff))</code></p>",
        "id": 526891070,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1751497144
    },
    {
        "content": "<p><code>f &lt;| x</code> and <code>f $ x</code> both mean just <code>f x</code>, but function application binds strongly and <code>&lt;|</code> and <code>$</code> both bind weakly so <code>f &lt;| a b c &lt;| d e</code> will be <code>f (a b c (d e))</code></p>",
        "id": 526891128,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751497196
    },
    {
        "content": "<p>Got it, so it's just sugar to get rid of parentheses? I could accomplish the same with parentheses?<br>\nMaybe I should read the Programming in lean book first.</p>",
        "id": 526891495,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751497445
    },
    {
        "content": "<p>You could accomplish the same with parentheses, but the <code>do</code> block is 6 lines long so not having the keep track of the parentheses is better for me</p>",
        "id": 526891689,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751497585
    },
    {
        "content": "<p>Why is this not printing anything when I place my cursor after the tactic?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"yellow\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMacro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">formatStx</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">pretty</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">yellow</span>\n<span class=\"w\">  </span><span class=\"n\">testTactic</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 526892233,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751497981
    },
    {
        "content": "<p>It prints on the <code>def</code></p>",
        "id": 526892395,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751498112
    },
    {
        "content": "<p>You can also use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.logInfo#doc\">docs#Lean.logInfo</a> to print at the tactic</p>",
        "id": 526892409,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751498123
    },
    {
        "content": "<p>Oh I didn't see that one <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> I was expecting it in the infoview</p>",
        "id": 526892428,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751498144
    },
    {
        "content": "<p>Cool this works.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">formatStx</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"w\"> </span><span class=\"s2\">\"Length is: {x.pretty.length}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">testTactic</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Thank you very much for your help, I'll try something slightly more complicated tomorrow.</p>",
        "id": 526893071,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751498656
    },
    {
        "content": "<p>Since you did <code>open Lean</code> at the top you can just put <code>logInfo</code></p>",
        "id": 526893120,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751498689
    },
    {
        "content": "<p>Also <code>logInfo</code> takes a message data so you can also write stuff like <code>logInfo m!\"true{indentExpr (.const ``True [])}}\"</code></p>",
        "id": 526893174,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751498737
    },
    {
        "content": "<p>Aaah too many concepts in one sentence. <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span> I'd also have then to ask what this is. I assume m! is the constructor for MessageData, maybe I don't need to know.</p>\n<p>The code is understandable as always.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">m!</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">interpStr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">interpStr</span><span class=\"bp\">.</span><span class=\"n\">expandInterpolatedStr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MessageData</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">toMessageData</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>Also I tried pasting it in and I get \"expected '}'\" as an error message. Counting the parentheses they seem to be matching so yeah, at the current level this error message is not something I can understand yet.</p>",
        "id": 526893628,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499048
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/BTT9zGf_ZZURY22qk97KdSNb/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/BTT9zGf_ZZURY22qk97KdSNb/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"738x192\" src=\"/user_uploads/thumbnail/3121/BTT9zGf_ZZURY22qk97KdSNb/image.png/840x560.webp\"></a></div>",
        "id": 526893664,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499074
    },
    {
        "content": "<p>ah I had an extra bracket, edited.</p>",
        "id": 526893871,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751499198
    },
    {
        "content": "<p>Ah I see what it does <br>\n<a href=\"/user_uploads/3121/445pccgNt4twtl5QDKfRMxpa/image.png\">image.png</a><br>\nvery cool indeed.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/445pccgNt4twtl5QDKfRMxpa/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"245x124\" src=\"/user_uploads/thumbnail/3121/445pccgNt4twtl5QDKfRMxpa/image.png/840x560.webp\"></a></div>",
        "id": 526894031,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499260
    },
    {
        "content": "<p>I also get typing information, which is helpful.</p>",
        "id": 526894062,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499283
    },
    {
        "content": "<p>You can also print the goal like <code>logInfo m!\"goal:{← getMainGoal}\"</code></p>",
        "id": 526894193,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751499332
    },
    {
        "content": "<p>Yeah, I'll try tomorrow bunch of printing, printing hypotheses, printing goals, and stuff like that.</p>",
        "id": 526894314,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499424
    },
    {
        "content": "<p>Should be very fun, I don't see any easier way to learn it than to just learn what's possible.</p>",
        "id": 526894357,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499450
    },
    {
        "content": "<p>also maybe a stupid question but I can also write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n</code></pre></div>\n<p>So that I don't have to type it every time, right?</p>",
        "id": 526894440,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751499512
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"725717\">metakuntyyy</span> has marked this topic as resolved.</p>",
        "id": 526894788,
        "sender_full_name": "Notification Bot",
        "timestamp": 1751499811
    }
]