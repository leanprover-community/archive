[
    {
        "content": "<p>Having a <code>structure</code> with lots of fields seems to have bad performance. Has anyone tried to tackle that issue? (/cc <span class=\"user-mention\" data-user-id=\"122318\">@Tobias Grosser</span> <span class=\"user-mention\" data-user-id=\"780481\">@Léon Frenot</span> )</p>",
        "id": 495061568,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737469113
    },
    {
        "content": "<p>In which particular context? Do you have a lean only test case? Is there a lean pr?</p>",
        "id": 495061878,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737469176
    },
    {
        "content": "<p>It would be useful to understand what the reason for this performance issue is.</p>",
        "id": 495061980,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737469203
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/nG82osfWtYtECMtNTTPtb_ET/HugeStructure.lean\">HugeStructure.lean</a></p>",
        "id": 495063570,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737469499
    },
    {
        "content": "<p>Are you saying just declaring the struct is slow?</p>",
        "id": 495065015,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737469757
    },
    {
        "content": "<p>Is time to declare a struct non linear. I would find that surprising.</p>",
        "id": 495065184,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737469786
    },
    {
        "content": "<p>I haven't spent any thought on it. I wouldn't find it surprising if it was quadratic, since generally fields in structs can depend on the type of earlier fields</p>",
        "id": 495066131,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737469961
    },
    {
        "content": "<p>Almost all of the time is spent in <code>  [Meta.injective] [2.639434] Foo.mk ▶</code> according to the profiler</p>",
        "id": 495066797,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737470104
    },
    {
        "content": "<p>What does this mean?</p>",
        "id": 495067253,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737470175
    },
    {
        "content": "<p>That lean spends almost all the time computing the injectivity theorems for the type</p>",
        "id": 495067496,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737470222
    },
    {
        "content": "<p>Ah yes.</p>",
        "id": 495068285,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737470360
    },
    {
        "content": "<p>Of course you could also try to merge these up into a big BitVec and just not care^^</p>",
        "id": 495068398,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737470376
    },
    {
        "content": "<p>Would prefer that over splitting up the structure <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 495069105,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737470511
    },
    {
        "content": "<p>Interesting. I would check with growing examples if the asymptomatics are quadratic. If they are, there may be a faster algorithm.</p>",
        "id": 495069305,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737470542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/performance.20of.20large.20structures/near/495067496\">said</a>:</p>\n<blockquote>\n<p>That lean spends almost all the time computing the injectivity theorems for the type</p>\n</blockquote>\n<p>So <code>Foo.noConfusion</code> itself also seems to have linear length, doesn't it?</p>",
        "id": 495069416,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737470562
    },
    {
        "content": "<p>@jakob, do you already have an obvious mapping to bitvec mind.</p>",
        "id": 495069562,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1737470596
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> <a href=\"#narrow/channel/270676-lean4/topic/performance.20of.20large.20structures/near/495069562\">said</a>:</p>\n<blockquote>\n<p>@jakob, do you already have an obvious mapping to bitvec mind.</p>\n</blockquote>\n<p>-&gt; other channel <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 495069908,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737470645
    },
    {
        "content": "<p>We might want to consider generating the injectivity theorem lazily if e.g. you don't foresee needing it for your purposes, worth opening an issue</p>",
        "id": 495076594,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737471840
    },
    {
        "content": "<p>Do you think the generation is inherently quadratic?</p>",
        "id": 495078935,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737472363
    },
    {
        "content": "<p>I'd have to take a closer look. I do see an option <code>genInjectivity</code> as well</p>",
        "id": 495086058,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737474195
    },
    {
        "content": "<p>That option makes it actually acceptably fast for our purposes</p>",
        "id": 495088378,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737474820
    },
    {
        "content": "<p>(But it still struggles with the above file...)</p>",
        "id": 495089769,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1737475153
    },
    {
        "content": "<p>Can you quantify \"bad performance\" and \"struggles\"? From Henrik's comment it sounds like we're talking on the order of 5-10 seconds for a structure with over 5000 fields?</p>",
        "id": 495096632,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737476945
    },
    {
        "content": "<p>Ah, well I just gave it half a minute and it didn't finish elaboration, so get saying that Lean struggles with this one.</p>",
        "id": 495097116,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737477064
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/performance.20of.20large.20structures/near/495096632\">said</a>:</p>\n<blockquote>\n<p>Can you quantify \"bad performance\" and \"struggles\"? From Henrik's comment it sounds like we're talking on the order of 5-10 seconds for a structure with over 5000 fields?</p>\n</blockquote>\n<p>I cut out almost all the fields for the measurement :D</p>",
        "id": 495097598,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737477205
    }
]