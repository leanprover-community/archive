[
    {
        "content": "<p>This is a question about syntax quotations. In the example below, I'm wondering why the line <code>cases $t</code> fails without syntax category annotation, even though I've already specified <code>t:term</code>. I was just struggling with <span class=\"user-mention\" data-user-id=\"651332\">@Sven Manthe</span> for while to get <code>cases $t</code> to parse in a similar example.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"example\"</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" : \"</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"example_without_ident\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- this succeeds</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"cases_without_ident\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- this fails</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `(tactic|cases $t:term) -- this succeeds</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"c1\">-- for reference</span>\n</code></pre></div>",
        "id": 477618558,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729245039
    },
    {
        "content": "<p>I think the ambiguity here is caused by <code>cases h : x</code> notation existing</p>",
        "id": 477620309,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729245629
    },
    {
        "content": "<p>But agreed that I'd expect the annotation in <code>t:term</code> to suffice</p>",
        "id": 477620339,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729245638
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/syntax.20quotation.20with.20cases/near/477620309\">said</a>:</p>\n<blockquote>\n<p>I think the ambiguity here is caused by <code>cases h : x</code> notation existing</p>\n</blockquote>\n<p>I tried to simulate that with the <code>example</code> syntax, where I don't have to specify the syntax category of <code>$t</code>. But <code>cases</code> does have a bit more complicated arguments, which probably causes the difference.</p>",
        "id": 477623844,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729246966
    },
    {
        "content": "<p>The disambiguation of antiquotations is done at parse time, other information about <code>t</code> cannot be taken into account. Though now I'm wondering whether that could be delayed until elaboration time by producing choice nodes instead...</p>",
        "id": 477711627,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1729277304
    },
    {
        "content": "<p>I see, the error has nothing to do with optional arguments, just the fact that there is a different syntax category.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">myTerm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myCases</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"mycases \"</span><span class=\"w\"> </span><span class=\"n\">myTerm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"cases_without_ident\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">mycases</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- this fails</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `(tactic|mycases $t:term) -- this succeeds</span>\n</code></pre></div>\n<p>I think it's something that is easy to get wrong, but can be solved by giving more information. I am not experienced enough with syntax quotations to always know where/how to give more information.</p>",
        "id": 478574646,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729713974
    },
    {
        "content": "<p>It is the golden rule of quotation and antiquotation: in case of mysterious errors, add annotations before trying anything else.</p>",
        "id": 478583403,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1729717604
    }
]