[
    {
        "content": "<p>If I run:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Paths</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">initSrcSearchPath</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">findM?</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">main</span>\n</code></pre></div>\n<p>in a project, it prints something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Qq</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/./.</span>\n<span class=\"bp\">./././.</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">scott</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0-rc2/src/lean/lake</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">scott</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0-rc2/bin/../src/lean/lake</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">scott</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0-rc2/bin/../src/lean</span>\n</code></pre></div>\n<p>However when I <code>lake build</code>, it just prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">scott</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0-rc2/bin/../src/lean/lake</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">scott</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0-rc2/bin/../src/lean</span>\n</code></pre></div>\n<p>This is causing <code>polyrith</code> (which relies on this mechanism) to fail under <code>lake build</code> in any projects downstream of Mathlib.</p>",
        "id": 440833383,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716809025
    },
    {
        "content": "<p>What is the correct way to locate the <code>Mathlib/scripts/</code> folder in the Mathlib sources, in a downstream project, in a way that works in both VSCode and under <code>lake build</code>?</p>",
        "id": 440833493,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716809063
    },
    {
        "content": "<p>(Pinging <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>, who needs a fix for this for her polyrith tutorial.)</p>",
        "id": 440833661,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716809136
    },
    {
        "content": "<p>The underlying difference here is that the <code>LEAN_SRC_PATH</code> environment variable is set when we run in VS Code, but not set during <code>lake build</code>.</p>",
        "id": 440834641,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716809459
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>?</p>",
        "id": 440834672,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716809467
    },
    {
        "content": "<p>Does using <code>lake env lake build</code> work?</p>",
        "id": 440859251,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1716817690
    },
    {
        "content": "<p>When Lean is run from <code>lake build</code>, Lake only sets the the minimum environment needed for Lean to build properly., while the server getts the full Lake environment. However, doing otherwise would be a relatively trivial fix.</p>",
        "id": 440903346,
        "sender_full_name": "Mac Malone",
        "timestamp": 1716835316
    },
    {
        "content": "<p>Eric's <code>lake env lake build</code> is also a stop-gap fix.</p>",
        "id": 440903417,
        "sender_full_name": "Mac Malone",
        "timestamp": 1716835344
    },
    {
        "content": "<p>I couldn't get <code>lake env lake build</code> to work.</p>",
        "id": 440996322,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716887272
    },
    {
        "content": "<p>Ah!! It did work, but only after <code>lake clean</code>, because it replayed the result from without <code>lake env</code>.</p>",
        "id": 440996538,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716887353
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> can we have a proper fix for this? Currently <code>lake build</code> won't work on any project downstream of mathlib that uses <code>polyrith</code>.</p>\n<p>I've created <a href=\"https://github.com/leanprover/lean4/pull/4296\">lean#4296</a> to track this.</p>",
        "id": 440997137,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716887599
    },
    {
        "content": "<p>I've also created <a href=\"https://github.com/leanprover/lean4/pull/4297\">lean#4297</a> to discuss whether Lean-specific enviroment variables should be included in deciding whether to rebuild. I suspect the answer is no here, but I'm not sure.</p>",
        "id": 440998085,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1716887959
    },
    {
        "content": "<p>In theory it's possible for code to depend on non-lean specific environment variables too, at build time</p>",
        "id": 441002631,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1716889505
    },
    {
        "content": "<p>Looking at <a href=\"https://github.com/leanprover/lean4/pull/4296\">lean#4296</a>, I have the same use-case as <code>polyrith</code> (we have a library that invokes a Python script) and the same problem (<code>lake build</code> fails for users of our library, but <code>lake env lake build</code> succeeds).</p>",
        "id": 497828809,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1738742222
    },
    {
        "content": "<p>And have you evaluated using <code>include_str</code> for this purpose?</p>",
        "id": 497829490,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738742447
    },
    {
        "content": "<p>I'm willing to try, but I don't understand how it would work for my use case (invoking at runtime a Python script that ships together with my Lean library).</p>\n<p>Is the idea that I would <code>include_str</code> the script, and then at runtime when I need to run the script, save it to a file (whose path I know), then execute the Python interpreter on that file? That seems cumbersome.</p>",
        "id": 497831147,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1738743070
    },
    {
        "content": "<p>That's not necessary, you can just pass the script as stdin to <code>python</code></p>",
        "id": 497839814,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738745726
    },
    {
        "content": "<p>Just to evaluate other options, what seems to be done in Rust libraries for simple file packaging is to compile the path to the file into the binary at build time, which would be easily achieved in Lean via meta programming. You just can't move the binary afterwards without rebuilding, so it shouldn't be cached in the cloud either.</p>",
        "id": 497840838,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738746042
    },
    {
        "content": "<p>I see, that's  very helpful. Thank you!</p>\n<p>I think the easiest solution for me would be to compile the path into the binary. Does Lean already have a macro to get the path of the current file (similar to <code>file!</code> in Rust)?</p>",
        "id": 497845585,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1738747488
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/-- The directory of the file being currently compiled. -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">currentDirectory</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"currentDirectory!\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">currentDirectory</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabCurrentFilePath</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">currentDirectory!</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">readThe</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">FilePath</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">fileName</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"bp\">.</span><span class=\"n\">parent</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"cannot compute parent directory of '{srcPath}'\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{srcDir}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>\n<p>Here's an implementation of what I needed, for future reference in case anyone comes across this thread later.</p>",
        "id": 497851847,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1738749373
    },
    {
        "content": "<p>(I've been meaning to try using <code>include_str</code> for polyrith for long time, but still haven't. If anyone wants to try!! :-)</p>",
        "id": 498017552,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738806265
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> In <a href=\"https://github.com/leanprover-community/mathlib4/pull/17626\">#17626</a> I refactored Polyrith to remove the dependency on the Python script, and I used <code>include_str</code> for the script sent to the SageMath server. I wasn't aware of this issue here, so I don't know if my PR accidentally affected this issue.</p>",
        "id": 498018638,
        "sender_full_name": "Thomas Zhu",
        "timestamp": 1738806832
    },
    {
        "content": "<p>No no, <a href=\"https://github.com/leanprover-community/mathlib4/pull/17626\">#17626</a> is perfect, and I'd missed it. Thank you!</p>",
        "id": 498018760,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738806876
    },
    {
        "content": "<p>This solution is still a bit dangerous, especially when globally cached, because a change to the script does not actually rebuild anything, no? Likely there should be a comment in the script file to touch some magic hash in the corresponding .lean file to ensure that. In fact <code>include_str</code> should probably contain that hash, check it at build time, and offer a code action to refresh it.</p>",
        "id": 498066537,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738831989
    },
    {
        "content": "<p>Isn't the right mechanism here to tell lake that the Lean file depends on the data file?</p>",
        "id": 498272317,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738911751
    },
    {
        "content": "<p>For sure, but it should still be an annotation inside the file so the annotation and file path cannot go out of sync. So that will require feature work in both Lean and Lake.</p>",
        "id": 498286933,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738917880
    }
]