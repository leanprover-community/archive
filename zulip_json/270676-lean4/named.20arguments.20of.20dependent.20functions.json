[
    {
        "content": "<p>(this issue was found and minimized by <span class=\"user-mention\" data-user-id=\"651332\">@Sven Manthe</span>)</p>\n<p>The failure in the first example below is counterintuitive to me. Is this the intended behavior?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"c1\">--fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n\n<span class=\"c1\">-- if our function is not dependent, all four cases work</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n</code></pre></div>\n<p>The behavior seems to be:</p>\n<p>named arguments are processed first, and all dependent arguments (even the explicit ones) before named arguments are already inserted as metavariables.</p>\n<p>The fact that dependent arguments are already inserted as metavariables is counterintuitive to me, and is undesirable if <code>y</code> is an implicit argument (e.g. a type-class argument) and <code>x</code> is explicit, and you want to specify <code>y</code> explicitly. In that case, if you also want to give <code>x</code> explicitly, you are required to also write <code>x</code> as a named argument.</p>",
        "id": 443147810,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1717703459
    },
    {
        "content": "<p>I just came across this as well, and I agree it's counterintuitive. It's also not mentioned in the docs for implicit arguments and giving them explicitly.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instDecidableFalse</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">decide'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">decide'</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo_d</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Here's the example I came up with - the final line doesn't typecheck and I expected it should.</p>",
        "id": 444591292,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1718328214
    },
    {
        "content": "<p>I just realized this is already reported as <a href=\"https://github.com/leanprover/lean4/pull/1867\">lean4#1867</a>. Please upvote that issue if you have encountered this.</p>",
        "id": 463399504,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724072706
    },
    {
        "content": "<p>Recently I came across this comment explaining this behavior in the app elaborator: <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/App.lean#L547-L570\">https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/App.lean#L547-L570</a></p>\n<p>If a named argument depends on an explicit argument, that explicit argument becomes an implicit argument.</p>\n<p>It seems like the justification for this is for dot notation, which is implemented using the transformation <code>x.f</code> -&gt; <code>X.f (self := x)</code>. Perhaps this explicit-&gt;implicit conversion should only occur for this particular named argument?</p>",
        "id": 463463362,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724088074
    },
    {
        "content": "<p>Yes, I also read that comment yesterday, when clicking some links from <a href=\"https://github.com/leanprover/lean4/pull/1867\">lean4#1867</a>. <br>\nHonestly, I don't see why this special case was implemented. I.e. why don't we just keep explicit arguments explicit, even when a later dependent argument is given?<br>\nIt might be marginally useful sometimes, allowing you to omit the occasional underscore, but it is confusing, and I don't think the trade-off is worth it. This is a uncommon pattern that many users will not be familiar with. Case in point: a student of mine came to me with a type mismatch error caused by this, and I didn't know what was going on, despite having encountered it before.<br>\nFurthermore, giving the dependent argument doesn't necessarily specify the type completely, so the explicit-turned-implicit argument regularly still needs to be given.</p>\n<p>Lastly, the issue <a href=\"https://github.com/leanprover/lean4/pull/1851\">lean4#1851</a> reads a bit like <span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> just forgot to put an underscore in their code.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- on Lean from 2022-10-27</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Approx</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Approx</span><span class=\"w\"> </span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Approx</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">application type mismatch</span>\n<span class=\"cm\">  @Approx.val ?m.97 (Approx.val ?m.102) ?m.107 f</span>\n<span class=\"cm\">argument</span>\n<span class=\"cm\">  f</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  Approx f' (X → Y) : Type</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  Approx (Approx.val x') ?m.107 : Type</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Approx.val f' (Approx.val x') : Y</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div>",
        "id": 463694160,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724158627
    },
    {
        "content": "<p>To comment directly on your suggestion: I don't like the idea of having different behavior for <code>x.f</code> compared to <code>X.f (self := x)</code>. I think they are similar enough.</p>",
        "id": 463696533,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724158969
    }
]