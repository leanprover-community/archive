[
    {
        "content": "<p>I tried to do a <code>saveState</code> in <code>CanonM</code> and learned that there was no <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MonadBacktrack#doc\">docs#Lean.MonadBacktrack</a> instance for that monad.  Is this a fundamental difficulty, or is it something which could be implemented and just hasn't been done yet?</p>",
        "id": 484034814,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732340244
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Canonicalizer</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Canonicalizer</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadBacktrack</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">SavedState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">CanonM</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">saveState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">saveState</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">restoreState</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">    </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n</code></pre></div>\n<p>should work, I think</p>",
        "id": 484037660,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732343239
    },
    {
        "content": "<p>This will be inefficient because the <code>CanonM</code> <code>State</code> uses <code>Std.HashMap</code>, which is non-persistent. That is, the whole map will be copied for every snapshot.</p>",
        "id": 484071241,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1732374026
    },
    {
        "content": "<p>that's possibly okay if you don't snapshot too much</p>",
        "id": 484076968,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732379029
    },
    {
        "content": "<p>I guess one should put a note warning about this on the instance doc-string. It's a pity that hovering over <code>save</code> and <code>restore</code> can't show such doc-strings!</p>",
        "id": 484095519,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732395271
    },
    {
        "content": "<p>Heather, why are you trying to backtrack here in the first place. Do you actually want to backtrack the CanonM state, or only the lower layers?</p>",
        "id": 484095570,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732395326
    },
    {
        "content": "<p>After seeing Jannis' warning, I indeed switched to backtracking only the MetaM layer, and this seems to work fine.  (I hadn't realised I could do that.)</p>",
        "id": 484095672,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732395411
    }
]