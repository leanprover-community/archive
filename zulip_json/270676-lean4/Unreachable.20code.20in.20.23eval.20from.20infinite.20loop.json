[
    {
        "content": "<p>I noticed the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"c1\">-- unreachable code</span>\n</code></pre></div>\n<p>Interestingly, this behavior changes (to hanging as expected) if imports are removed. (Any import I've tried seems to be sufficient to produce 'unreachable code', not just <code>import Lean</code>.)</p>\n<p>I'm reporting this just in case it's a bug. :)</p>",
        "id": 533824916,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754928428
    },
    {
        "content": "<p>I think that importing <code>Lean.Message</code> gives <code>unreachable code</code>, but importing any of its imports hangs.</p>",
        "id": 533827124,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754929194
    },
    {
        "content": "<p>By deleting content in that file, I've minimized it further now to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">PPExt</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Sorry</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofFormatWithInfos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FormatWithInfos</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MessageData</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofLazy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PPContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Dynamic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hasSyntheticSorry</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetavarContext</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">TypeName</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">MessageData</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofFormat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofFormatWithInfos</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">fmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">ofLazy</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ofFormatWithInfos</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ppExprWithInfos</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Dynamic</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">instantiateMVarsCore</span><span class=\"w\"> </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">hasSyntheticSorry</span><span class=\"o\">)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"c1\">-- unreachable code</span>\n</code></pre></div>\n<p>Changing the names of <code>ofExpr</code> and <code>ofFormat</code> results in hanging. I haven't tried editing their bodies yet.</p>",
        "id": 533830236,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754930312
    },
    {
        "content": "<p>Changing the <em>names</em> that are not later referenced!  <span aria-label=\"open mouth\" class=\"emoji emoji-1f62e\" role=\"img\" title=\"open mouth\">:open_mouth:</span></p>",
        "id": 533830644,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754930450
    },
    {
        "content": "<p>Maybe this reveals the issue somewhat:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofFormat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"c1\">-- function expected ofFormat (repr (loopBool 4))</span>\n</code></pre></div>\n<p>(No imports!)</p>",
        "id": 533830912,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754930535
    },
    {
        "content": "<p>Well, you could minimize it further by evaluating at <code>0</code>, instead of <code>4</code>.  <span aria-label=\"lol\" class=\"emoji emoji-1f606\" role=\"img\" title=\"lol\">:lol:</span></p>",
        "id": 533831317,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754930669
    },
    {
        "content": "<p>You can also inline the <code>namespace</code> in <code>ofFormat</code>, if you prefer.</p>",
        "id": 533831455,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754930724
    },
    {
        "content": "<p>It's probably to do with how <code>#eval</code> displays the output</p>",
        "id": 533831472,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754930732
    },
    {
        "content": "<p>Lean.MessageData.ofFormat and Lean.MessageData.ofExpr must be special-cased somewhere. It looks like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.elabEvalCoreUnsafe#doc\">docs#Lean.Elab.Command.elabEvalCoreUnsafe</a>, <a href=\"https://github.com/leanprover/lean4/blob/30ceb3260d7d7536092fedff969b4b2e8de7f942/src/Lean/Elab/BuiltinEvalCommand.lean#L221\">here</a>, with <code>ofExpr</code> looked for <a href=\"https://github.com/leanprover/lean4/blob/30ceb3260d7d7536092fedff969b4b2e8de7f942/src/Lean/Elab/BuiltinEvalCommand.lean#L152\">here</a></p>",
        "id": 533831608,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754930782
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/Unreachable.20code.20in.20.23eval.20from.20infinite.20loop/near/533831472\">said</a>:</p>\n<blockquote>\n<p>It's probably to do with how <code>#eval</code> displays the output</p>\n</blockquote>\n<p>True, but it's a bit strange that there shouldn't <em>be</em> any output to display...</p>",
        "id": 533831767,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754930856
    },
    {
        "content": "<p>It seems that <code>#eval</code> compiles a definition of type <code>MessageData</code> whose body is <code>ofExpr (toExpr (loop 4))</code>, and then <code>evalConst</code> is called on this, which produces the error. In fact, <code>ofExpr</code> is irrelevant, and we find</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"ss\">``foo</span><span class=\"w\"> </span><span class=\"c1\">-- unreachable code</span>\n</code></pre></div>\n<p>or more generally</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"yes\"</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"s2\">\"no\"</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"ss\">``foo</span><span class=\"w\"> </span><span class=\"c1\">-- unreachable code</span>\n</code></pre></div>\n<p>Replacing <code>String</code> with <code>Bool</code> causes hanging (any other non-bool type seems to cause unreachable code).</p>",
        "id": 533839694,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754934141
    },
    {
        "content": "<p>Interestingly, changing the body of <code>loop</code> as follows changes the behavior:</p>\n<ul>\n<li><code>match n with | 0 =&gt; true | n =&gt; loop n</code>: hangs</li>\n<li><code>true || loop n</code>: returns true (expected, I'm guessing <code>loop n</code> is optimized away here)</li>\n<li><code>loop (n+1)</code>, <code>false || loop n</code>, <code>loop n || true</code>: unreachable code</li>\n</ul>",
        "id": 533840916,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754934687
    },
    {
        "content": "<p><code>evalConst</code> quickly bottoms out in an <code>extern</code>, so for now, this is as far as I go. :)</p>",
        "id": 533841322,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754934890
    },
    {
        "content": "<p>Wait, I just realized that <code>run_cmd</code> calls <code>elabEvalCoreUnsafe</code>—so maybe my conclusions aren't quite right here.</p>",
        "id": 533841652,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754935054
    },
    {
        "content": "<p>Perhaps this is a bit more convincing, but I'm still unsure if there's any weirdness in <code>elab</code>  and the <code>unsafe</code> wrapper.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"yes\"</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"s2\">\"no\"</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">discard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"ss\">``foo</span>\n\n<span class=\"bp\">#</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"c1\">-- unreachable code</span>\n</code></pre></div>",
        "id": 533842402,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754935341
    },
    {
        "content": "<p><code>#eval</code> changes behavior depending on what's imported; it falls back on some simpler pretty printing methods if certain definitions aren't available.</p>\n<p>I don't know why sometimes it's unreachable and sometimes it loops, but the key to why it's ever printing unreachable code is that the compiler is allowed to assume that all functions halt.</p>\n<p>If you take a look at the IR when <code>set_option trace.compiler.ir true</code> is enabled, you can see that the <code>_eval</code> definition reduces to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"bp\">⊥</span>\n</code></pre></div>\n<p>The first hint of bottom being introduced is the <code>elim_dead_branches</code> pass.</p>",
        "id": 534576729,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755215608
    }
]