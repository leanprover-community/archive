[
    {
        "content": "<p>Reduced from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Kernel.20error.20in.20list.20index.20notation/with/543556771\">#lean4 &gt; Kernel error in list index notation</a> :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">syntheticOpaque</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclQ</span><span class=\"w\"> </span><span class=\"ss\">`h</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"before: {e}\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- works fine without this line</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAuxTheorem</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">zetaDelta</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- or false, not really relevant</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"after: {e}\"</span>\n</code></pre></div>\n<p>gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">before</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">right</span>\n<span class=\"c1\">---</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"c1\">---</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"w\"> </span><span class=\"n\">variables</span><span class=\"w\"> </span><span class=\"bp\">'_</span><span class=\"n\">private</span><span class=\"bp\">.«</span><span class=\"n\">external</span><span class=\"o\">:</span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"bp\">///</span><span class=\"n\">MathlibDemo</span><span class=\"bp\">/</span><span class=\"n\">MathlibDemo</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">».</span><span class=\"m\">0</span><span class=\"bp\">._</span><span class=\"n\">proof_2'</span>\n</code></pre></div>\n<p>where the hover info for <code>_proof_2</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">_</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">fvar</span><span class=\"bp\">.</span><span class=\"m\">1002</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">True</span>\n</code></pre></div>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkAuxTheorem#doc\">docs#Lean.Meta.mkAuxTheorem</a> doesn't really make any strong promises about this in its docstring, but the module docstring claims:</p>\n<blockquote>\n<p>This module provides functions for \"closing\" open terms and creating auxiliary definitions. Here, we say a term is \"open\" if it contains free/meta-variables.</p>\n</blockquote>\n<p>which suggests that the metavariable should be handled</p>\n<p>(Edit: filed as <a href=\"https://github.com/leanprover/lean4/pull/10705\">lean4#10705</a>)</p>",
        "id": 543556722,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759849630
    },
    {
        "content": "<p>(Apologies for the Qq usage, building the term is more annoying without; but I don't think Qq is implicated here)</p>",
        "id": 543556883,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759849670
    },
    {
        "content": "<p>My hunch is that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newLocalDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">newLocalDecls</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">newLocalDeclsForMVars</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newLetDecls</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">newLetDecls</span><span class=\"bp\">.</span><span class=\"n\">reverse</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkForall</span><span class=\"w\"> </span><span class=\"n\">newLocalDecls</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkForall</span><span class=\"w\"> </span><span class=\"n\">newLetDecls</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkLambda</span><span class=\"w\"> </span><span class=\"n\">newLocalDecls</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkLambda</span><span class=\"w\"> </span><span class=\"n\">newLetDecls</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>is to blame, and in fact <code>newLocalDeclsForMVars</code>, <code>newLetDecls</code>, and <code>newLocalDecls</code> need to be interlaced in the order they are discovered</p>",
        "id": 543579655,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759855821
    },
    {
        "content": "<p>I think <a href=\"https://github.com/leanprover/lean4/pull/10704\">lean4#10704</a> is enough to resolve the notation overloading issue in the other thread, but leaves behind a performance bug in place of the behavior bug</p>",
        "id": 543596914,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759861452
    }
]