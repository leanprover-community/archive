[
    {
        "content": "<p>The current definition of <code>foldl</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>\n<p>However, Olivier Danvy in his paper <a href=\"https://www.doi.org/10.1017/S0956796822000156\">Folding left and right matters: Direct style, accumulators, and continuations</a> argues that this is wrong and it should be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldl'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">foldl'</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>\n<p>The advantages of <code>foldl'</code> over <code>foldl</code> are listed in the paper:<br>\n<a href=\"/user_uploads/3121/RnquXHkOodGQSW0mwN0xmiMJ/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/RnquXHkOodGQSW0mwN0xmiMJ/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"993x568\" src=\"/user_uploads/thumbnail/3121/RnquXHkOodGQSW0mwN0xmiMJ/image.png/840x560.webp\"></a></div><p>I would like to replace <code>foldl</code> with <code>foldl'</code>. Shall we do it?</p>\n<p>(Disclaimer: I am taking Danvy's module CS6217 Topics in Programming Languages and Software Engineering this semester at NUS.)</p>",
        "id": 570051311,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1769421868
    },
    {
        "content": "<p>This seems like far too large of a breaking change in the eco system to pull off at this point, you'd have to change thousands and thousands of invocations.</p>",
        "id": 570052115,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769422133
    },
    {
        "content": "<p>In that case, would it be possible to just add the <code>foldl'</code> function alongside and explain why Danvy prefers this?</p>",
        "id": 570054244,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1769422828
    },
    {
        "content": "<p>I mean <code>foldl' f</code> is just <code>foldl (flip f)</code>, right? This doesn't seem like we'd need a new definition</p>",
        "id": 570146709,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769447311
    },
    {
        "content": "<p>Then why did my lecturer write that paper?</p>",
        "id": 570218348,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1769477144
    },
    {
        "content": "<p>My guess is that point 1 of that paper is about providing the student with a better tool to remember which one is foldr and which is foldl</p>",
        "id": 570220721,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769478846
    },
    {
        "content": "<p>But we have docstrings to disambiguate that (or at least, we should)</p>",
        "id": 570220771,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769478878
    },
    {
        "content": "<p>Point 2 and 3 seem to be moot, because Lean is happy to generalize arguments behind the scenes when doing induction.</p>",
        "id": 570220922,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769478989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Swapping.20the.20arguments.20of.20foldl's.20f/near/570146709\">said</a>:</p>\n<blockquote>\n<p>I mean <code>foldl' f</code> is just <code>foldl (flip f)</code>, right? This doesn't seem like we'd need a new definition</p>\n</blockquote>\n<p>Right then</p>",
        "id": 570230404,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1769485935
    },
    {
        "content": "<p>Danvy's principal languages are Rocq, Scheme and OCaml, not Lean</p>",
        "id": 570230834,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1769486305
    },
    {
        "content": "<p>I decided to make a PR adding <code>foldl'</code> anyway, as <code>foldf</code>: <a href=\"https://github.com/leanprover/lean4/pull/12653\">lean4#12653</a></p>",
        "id": 575341106,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771864244
    },
    {
        "content": "<p>Re: the actual reasoning for <code>foldl'</code>: Interesting! I am not convinced by the first bullet applies for an eager language like lean, though. I would contend that in <code>f (f (f init 1) 2) 3</code>, it is <code>f init 1</code> that's happening \"first\". I'm curious if the author is referring to a different notion of \"order\"; \"evaluation order\" may admittedly not be the intended order here.</p>\n<p>I also think the current argument order for the argument to <code>foldl</code> nicely allows us to visualize the function as having accumulated the elements  \"behind\" the current element when looking at the current element, left-to-right: visually, if <code>f := fun acc x =&gt; ...</code>, we're dealing with a picture like <code>[ (acc), x, ...]</code>. The elements prior to <code>x</code> appear to have been aggregated \"in place\" to <code>acc</code>, and so it \"makes sense\" that the argument <code>acc</code> comes before <code>x</code>.</p>\n<p>The real benefits admittedly might be in the next two bullets, and I have not explored those myself. :)</p>",
        "id": 575354427,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1771867552
    },
    {
        "content": "<p>How do I fix this? I can't push to <code>lean-pr-testing-12653</code><br>\n<a href=\"/user_uploads/3121/X-F2R8rNo4o9jCbYg8tHksve/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/X-F2R8rNo4o9jCbYg8tHksve/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"884x192\" src=\"/user_uploads/thumbnail/3121/X-F2R8rNo4o9jCbYg8tHksve/image.png/840x560.webp\"></a></div>",
        "id": 575451536,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771909258
    },
    {
        "content": "<p>I don't think you linked to the right PR above</p>",
        "id": 575451751,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1771909419
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"380294\">Matt Diamond</span> <a href=\"#narrow/channel/270676-lean4/topic/Swapping.20the.20arguments.20of.20foldl's.20f/near/575451751\">said</a>:</p>\n<blockquote>\n<p>I don't think you linked to the right PR above</p>\n</blockquote>\n<p>Fixed</p>",
        "id": 575451788,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771909453
    },
    {
        "content": "<p>The procedure for mathlib CI is no longer clear from the linked docs</p>",
        "id": 575453498,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771910037
    },
    {
        "content": "<p>(PR has been downstreamed to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35713\">#35713</a>)</p>",
        "id": 575508143,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771929610
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/270676-lean4/topic/Swapping.20the.20arguments.20of.20foldl's.20f/near/575453498\">said</a>:</p>\n<blockquote>\n<p>The procedure for mathlib CI is no longer clear from the linked docs</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"598052\">@Jeremy Tan</span>, is there a particular point where the docs are unclear? I'd like to improve these.</p>\n<p>Yes, you can't push directly to lean-pr-testing-NNNN. I recommend making a PR to it, and pinging me (on Zulip).</p>",
        "id": 575514565,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771931452
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I do not think the docs say that you should make the mathlib adaptation PR on the nightly-testing repo. (Also, where do you make it for batteries?)</p>",
        "id": 575515368,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771931698
    }
]