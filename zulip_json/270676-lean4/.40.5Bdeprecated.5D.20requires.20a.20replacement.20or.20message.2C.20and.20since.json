[
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/6112\">lean#6112</a></p>\n<p>I would like to avoid having unactionable <code>@[deprecated]</code> attributes.</p>",
        "id": 483154601,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731977208
    },
    {
        "content": "<p>An obvious missing piece of functionality for <code>@[deprecated]</code> is to be able to specify when then declaration will be removed (rather than when it was slated for removal). As there are not currently any projects missing this functionality, I propose we don't implement it yet. :-)</p>",
        "id": 483154721,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731977268
    },
    {
        "content": "<p>I don't really like the fact that this encourages people to write custom messages that might no longer include the word \"deprecated\" (which would foil my grepping!)</p>",
        "id": 483155615,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731977706
    },
    {
        "content": "<p>Maybe the linter could always add <code>Deprecated linter:</code> at the beginning of each warning, or <code>[Deprecated linter]</code> at the end?</p>",
        "id": 483156190,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731977964
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483155615\">said</a>:</p>\n<blockquote>\n<p>I don't really like the fact that this encourages people to write custom messages that might no longer include the word \"deprecated\" (which would foil my grepping!)</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>, we could print \"<code>X</code> has been deprecated: &lt;custom-message&gt;\".</p>",
        "id": 483161204,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731980384
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/6112/commits/cbfb0a103e8fba55b1ca726d666e9a77b2bd96a7\">https://github.com/leanprover/lean4/pull/6112/commits/cbfb0a103e8fba55b1ca726d666e9a77b2bd96a7</a></p>",
        "id": 483161694,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731980625
    },
    {
        "content": "<p>It'd relatedly be nice if whenever the replacement was present it also came with a code action to perform the replacement.</p>",
        "id": 483168025,
        "sender_full_name": "Julian Berman",
        "timestamp": 1731983814
    },
    {
        "content": "<p>We have this, don't we? It's in Batteries somewhere, but perhaps not being imported correctly in Mathlib.</p>",
        "id": 483181968,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731991907
    },
    {
        "content": "<p>It is in Batteries.CodeAction.Deprecated, which is imported by Batteries.Tactic.Alias, which is imported in most of Mathlib. So it \"should\" already be working?</p>",
        "id": 483182183,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731992039
    },
    {
        "content": "<p>It definitely doesn't work, though I think it did at some point</p>",
        "id": 483191076,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1731997891
    },
    {
        "content": "<p>note that the batteries code action is restricted to only work in cases where it knows it will be correct</p>",
        "id": 483206389,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732004964
    },
    {
        "content": "<p>maybe that's not worth it?</p>",
        "id": 483206408,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732004970
    },
    {
        "content": "<p>in particular, it only activates when you use <code>@[deprecated] alias</code> specifically, not the fake version of this that lean core uses</p>",
        "id": 483206610,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005028
    },
    {
        "content": "<p>There is an extension <code>machineApplicableDeprecated</code> which one can add to to make the code action fire</p>",
        "id": 483206751,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005080
    },
    {
        "content": "<p>but again, core doesn't do this because it isn't formally marking machine applicable deprecations</p>",
        "id": 483206793,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005102
    },
    {
        "content": "<p>maybe we should have a <code>deprecated!</code> attribute, or <code>deprecated?</code> for the non-machine applicable kind</p>",
        "id": 483206989,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005169
    },
    {
        "content": "<p>what about <code>@[deprecated ~other_thm]</code> for the non-machine applicable kind?</p>",
        "id": 483207282,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005275
    },
    {
        "content": "<p>I really wish core would stop handrolling <code>alias</code> when they are such a major customer</p>",
        "id": 483207696,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732005426
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483207696\">said</a>:</p>\n<blockquote>\n<p>I really wish core would stop handrolling <code>alias</code> when they are such a major customer</p>\n</blockquote>\n<p>The obstacle here is that we don't want <code>alias</code> + <code>abbrev</code>, and want to have just one keyword here, but haven't thought about details beyond that.</p>",
        "id": 483216841,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732008280
    },
    {
        "content": "<p>Could we just turn on the code action whenever there is a designated replacement?</p>",
        "id": 483216972,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732008315
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483206389\">said</a>:</p>\n<blockquote>\n<p>note that the batteries code action is restricted to only work in cases where it knows it will be correct</p>\n</blockquote>\n<p>I think we want the action whether it's correct or not; even when it's an estimate, the first step is to type it. We could switch between a quick fix and a suggestion if we want to handle the two cases differently</p>",
        "id": 483219671,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732009194
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483216841\">said</a>:</p>\n<blockquote>\n<p>The obstacle here is that we don't want <code>alias</code> + <code>abbrev</code>, and want to have just one keyword here, but haven't thought about details beyond that.</p>\n</blockquote>\n<p>I'm aware of this (I disagree but we don't have to have that discussion), but even a private-to-core-only <code>alias</code> would be better than the status quo</p>",
        "id": 483219760,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732009213
    },
    {
        "content": "<p>Do you mean just something that is a macro for <code>@[deprecated foo (since := \"data\")] abbrev bar := @foo</code>? I'm not quite sure how to insist (technically or socially) that such a macro is private, but if we can think of a way to do that in the interim I'm happy to do this.</p>",
        "id": 483236902,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732014426
    },
    {
        "content": "<p>No, I mean something that acts more or less like that but also comes with the other features of <code>alias</code>, in particular copying docstrings and formally registering it in a database of aliases</p>",
        "id": 483254085,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732020165
    },
    {
        "content": "<p>most of the actual work alias does is in this backend stuff. It's about managing namespace evolution in libraries, it's really not about <code>abbrev</code>. Lean itself could do much better than to make an abbrev, by explicitly manipulating name resolution instead of adding useless declarations</p>",
        "id": 483254584,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732020348
    },
    {
        "content": "<p>when you have an explicit marker that you are trying to do a name move and want to limit breakage of code using the original name, there are so many things you can do better with that information in hand</p>",
        "id": 483254922,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732020454
    },
    {
        "content": "<p>By the way, <code>alias</code> doesn't even make <code>abbrev</code>s currently. It copies the reducibility of the target</p>",
        "id": 483255644,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732020676
    },
    {
        "content": "<blockquote>\n<p>I'm not quite sure how to insist (technically or socially) that such a macro is private</p>\n</blockquote>\n<p>Just make it scary looking enough: put a <code>%</code> on the end or stick <code>lean_internal_</code> on it. There are plenty of macros in lean core which are internal use only</p>",
        "id": 483256704,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732020977
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483206389\">said</a>:</p>\n<blockquote>\n<p>note that the batteries code action is restricted to only work in cases where it knows it will be correct</p>\n</blockquote>\n<p>(yesterday afternoon, before I posted the message, I was doing a bunch of refactoring in the Carleson project which is downstream of Mathlib deprecations, and it definitely didn't work there for me. I'll see if I can go back and see why, now that I know something exists already.)</p>\n<p>It also would definitely be nice to have a \"replace all deprecations\" all at once action, but yeah I guess worth seeing why the existing one doesn't work yet before anything additional.</p>",
        "id": 483311326,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732035617
    },
    {
        "content": "<blockquote>\n<p>It also would definitely be nice to have a \"replace all deprecations\" all at once action, but yeah I guess worth seeing why the existing one doesn't work yet before anything additional.</p>\n</blockquote>\n<p>That's a <code>lake exe refactor</code> task</p>",
        "id": 483333078,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732042670
    },
    {
        "content": "<p>replace all isn't really a thing code actions do</p>",
        "id": 483333115,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732042682
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/13483\">#13483</a> is such an action (in the style of <code>refactor</code>): I have not merged it because it has been so much time since I last used it, that I want to test it again before merging it.</p>",
        "id": 483336052,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732043729
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/.40.5Bdeprecated.5D.20requires.20a.20replacement.20or.20message.2C.20and.20since/near/483333115\">said</a>:</p>\n<blockquote>\n<p>replace all isn't really a thing code actions do</p>\n</blockquote>\n<p>In Lean, or in general? In other languages, they do/can. E.g. <a href=\"https://docs.astral.sh/ruff/editors/features/#code-actions\">ruff</a> has a \"fix all auto-fixable problems\".</p>",
        "id": 483342236,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732046080
    },
    {
        "content": "<p>in vscode</p>",
        "id": 483342262,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046095
    },
    {
        "content": "<p>I should fact check this though</p>",
        "id": 483342281,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046104
    },
    {
        "content": "<p>Not that I've checked, but VSCode will be able to use that ruff code action, it's just a normal one.</p>",
        "id": 483342334,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732046131
    },
    {
        "content": "<p>but my recollection is that they aren't as capable of doing project-wide changes as e.g. rename request handlers</p>",
        "id": 483342349,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046139
    },
    {
        "content": "<p><em>Project</em>-wide no, just file-wide though I think is fine.</p>",
        "id": 483342378,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732046153
    },
    {
        "content": "<p>it's also not really well suited to code actions from an interface perspective though</p>",
        "id": 483342489,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046201
    },
    {
        "content": "<p>it's a lightbulb that pops up on the specific line you are looking at</p>",
        "id": 483342520,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046215
    },
    {
        "content": "<p>should it just pop up anywhere in the file? If it only pops up on the deprecation warning itself, then it seems misleading because it looks like it would act on that warning and not all of them</p>",
        "id": 483342609,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046253
    },
    {
        "content": "<p>something like fix all warnings would be better suited as just a top level command you could select from the ctrl-P menu</p>",
        "id": 483342714,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732046286
    },
    {
        "content": "<p>(I'm not convinced myself, I'm just thinking of what would have been convenient), and certainly not claiming that kind of functionality <em>must</em> be done via code actions, but I don't recall any other more suitable LSP method for it immediately without rereading -- my intuition (if it were a code action) would not be to show it literally everywhere, most likely just on a line with a deprecation, show 2 actions, one to fix that one, one to fix all at once. IIRC I've seen other actions do this but I can't recall which at the minute, probably some Lua one.</p>",
        "id": 483343031,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732046410
    },
    {
        "content": "<p>Anyways I don't know how to use <code>lake exe refactor</code> so I'm sure I should look at that before having any opinion at all as well.</p>",
        "id": 483343267,
        "sender_full_name": "Julian Berman",
        "timestamp": 1732046511
    }
]