[
    {
        "content": "<p>I hit a very bizarre bug today: the following innocuous-looking code segfaults when attempting to run the compiled version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Char</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TrivialParser</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">sepBy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"s2\">\" \"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">anyToken</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello!\"</span>\n</code></pre></div>\n<p>This only happens when running the compiled code, everything looks fine in VSCode. It also goes away if one uses <code>foo[0]!</code> instead of the proof with <code>h</code> in <code>foobar</code>. Note that the offending code doesn't even get executed here -- it just sits there.</p>\n<p>The <code>Parser</code> library above is <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span>'s <a href=\"https://github.com/fgdorais/lean4-parser/\">parser library</a>; unfortunately I haven't managed to get an MWE without this dependency (I tried switching to different monads and so on, to no avail).</p>\n<p>In any case, the bug can be reproduced on a fresh new Lean repo on version 4.15.0-rc1, with the above in <code>Main.lean</code>, and the following in <code>lakefile.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">mwe</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add package configuration options here</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Mwe</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Enables the use of the Lean interpreter by the executable (e.g.,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `runFrontend`) at the expense of increased binary size on Linux.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Remove this line if you do not need such functionality.</span>\n<span class=\"w\">  </span><span class=\"c1\">--supportInterpreter := true</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/fgdorais/lean4-parser\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n</code></pre></div>\n<p>I can work around it of course, but I thought I would report this here.</p>",
        "id": 489592666,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1734479792
    },
    {
        "content": "<p>Looks like a compiler error. The C output has a couple of suspicious things but I haven't been able to pinpoint the issue.</p>",
        "id": 489601372,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734485209
    },
    {
        "content": "<p>Yeah, that's what it looks like.</p>",
        "id": 489602209,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1734485807
    },
    {
        "content": "<p>I'll try some debugging but this is likely over my head. The import might be necessary for a MWE (though not this specific import <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>). My guess is that since the import is not actually used, some parts of initialization get optimized out and later init code unexpectedly tries to access an invalid memory location.</p>",
        "id": 489620972,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734498532
    },
    {
        "content": "<p>the symptoms sound similar to <a href=\"https://github.com/leanprover/lean4/pull/1965\">lean4#1965</a></p>",
        "id": 489741054,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734523111
    }
]