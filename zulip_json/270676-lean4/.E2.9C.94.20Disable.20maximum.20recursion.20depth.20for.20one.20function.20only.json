[
    {
        "content": "<p>I have a REPL-like function that calls itself after one command has finished. After a few hundred iterations it will exceed the maximum recursion depth. Is there a way to circumvent this restriction without raising the <code>maxRecDepth</code>? If not is there a way to disable <code>maxRecDepth</code>?</p>",
        "id": 474678226,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727988165
    },
    {
        "content": "<p>you need to make sure to call yourself tail-recursively</p>",
        "id": 474679844,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727988880
    },
    {
        "content": "<p>unfortunately some of the transformations of do notation don't preserve this property, can you show the code or an MWE version of it?</p>",
        "id": 474679911,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727988917
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Disable.20maximum.20recursion.20depth.20for.20one.20function.20only/near/474679911\">said</a>:</p>\n<blockquote>\n<p>unfortunately some of the transformations of do notation don't preserve this property, can you show the code or an MWE version of it?</p>\n</blockquote>\n<p>the only looping part is this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MainM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.getStdin</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">command.trim.length</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">parseCommand</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean.toJson</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"command\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">desc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">}:</span><span class=\"w\"> </span><span class=\"n\">InteractionError</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Using `Lean.Json.compress` here to prevent newline</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">error.compress</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">execute</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">state.options.printJsonPretty</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ret.pretty</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ret.compress</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">str</span>\n<span class=\"w\">  </span><span class=\"n\">loop</span>\n</code></pre></div>",
        "id": 474681901,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727989742
    },
    {
        "content": "<p>I can also show you the full code if needed but this is the function for the REPL</p>",
        "id": 474682098,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727989832
    },
    {
        "content": "<p>Lean REPL uses the same format: <a href=\"https://github.com/leanprover-community/repl/blob/master/REPL/Main.lean\">https://github.com/leanprover-community/repl/blob/master/REPL/Main.lean</a></p>",
        "id": 474682453,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727990027
    },
    {
        "content": "<p>How can I change the max recursion depth for a Lean executable? <code>set_option maxRecDepth 10000</code> doesn't seem to change the behaviour</p>",
        "id": 474683318,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727990446
    },
    {
        "content": "<p>try using an <code>else</code> on the early return</p>",
        "id": 474686870,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992312
    },
    {
        "content": "<p>What error are you getting at stack overflow?</p>",
        "id": 474686982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992358
    },
    {
        "content": "<p>I don't think there is a maxRecDepth for lean executables, the bigger issue is that even if you turn it up you will run out of C stack</p>",
        "id": 474687021,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992387
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Disable.20maximum.20recursion.20depth.20for.20one.20function.20only/near/474686982\">said</a>:</p>\n<blockquote>\n<p>What error are you getting at stack overflow?</p>\n</blockquote>\n<p>its just \"max recursion depth has been reached\"</p>",
        "id": 474691146,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727994649
    },
    {
        "content": "<p>Also I run <code>repl</code> with this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- NOTE: A more sophisticated scheme of command line argument handling is needed.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Separate imports and options</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"--version\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{Pantograph.version}\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n\n<span class=\"w\">  </span><span class=\"n\">Pantograph.initSearch</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">coreContext</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">args.filterMap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s.startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"--\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">s.drop</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toArray</span><span class=\"w\"> </span><span class=\"bp\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">Pantograph.createCoreContext</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args.filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s.startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"--\"</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">coreState</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Pantograph.createCoreState</span><span class=\"w\"> </span><span class=\"n\">imports.toArray</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">imports</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">coreM</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop.run</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"ready.\"</span>\n<span class=\"w\">    </span><span class=\"n\">discard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">coreM.toIO</span><span class=\"w\"> </span><span class=\"n\">coreContext</span><span class=\"w\"> </span><span class=\"n\">coreState</span>\n<span class=\"w\">  </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"Uncaught IO exception\"</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">ex.toString</span>\n</code></pre></div>\n<p>it is not a problem on the caller side right?</p>",
        "id": 474691414,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727994803
    },
    {
        "content": "<p><del>I narrowed it down and it doesn't seem to be an issue of the main loop, but a line here triggered the problem:</del></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goalStates</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args.stateIds.foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">map.erase</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">state.goalStates</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">goalStates</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n</code></pre></div>\n<p><code>state.goalStates</code> is a <code>HashMap</code>.</p>\n<p>Edit: It seems like this program is too deeply nested for the default rec depth. Sometimes there are calls to <code>aesop</code> that exceed the rec depth</p>",
        "id": 474692101,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1727995199
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> has marked this topic as resolved.</p>",
        "id": 474876402,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728065170
    }
]