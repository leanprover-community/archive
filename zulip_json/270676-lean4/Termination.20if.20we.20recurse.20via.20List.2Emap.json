[
    {
        "content": "<p>What's the cleanest way to show that this function terminates? It's straightforward recursion, except that part of the recursion goes via <code>List.map</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Tower</span>\n\n<span class=\"c1\">-- fail to show termination for Tower.value</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 500753164,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1740003286
    },
    {
        "content": "<p>Explained in <a href=\"https://lean-lang.org/blog/2024-1-11-recursive-definitions-in-lean/\">https://lean-lang.org/blog/2024-1-11-recursive-definitions-in-lean/</a>, tldr <code>List.attach</code> will do the job</p>",
        "id": 500753250,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740003319
    },
    {
        "content": "<p>Perfect, thank you!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tower</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">attach</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">t</span><span class=\"o\">,</span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 500753574,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1740003456
    },
    {
        "content": "<p>And language support for this happening automatically is coming soon!</p>",
        "id": 500786317,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740021860
    },
    {
        "content": "<p>On nightly, this already works:<br>\n<a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=FASwdgJgrgxgLiAbgUwAQBUD2B3ZAnVALgwE8AHNbAC32WFVQB9UxMI1iAZEAZzgxz5UgJMJUACm59UAIUyYANiJlz5ASiVZceYMAC0u1ADMAhiEVxMqHlRyo4+ALbhjCTGCOYCm/ADpEx+Sg6dkMBLT8AoKIwoVFZBWBmH1Z2KyNUAF4APnSxHh8HYzJUf0DkVWAgA\">https://live.lean-lang.org/#project=lean-nightly&amp;codez=FASwdgJgrgxgLiAbgUwAQBUD2B3ZAnVALgwE8AHNbAC32WFVQB9UxMI1iAZEAZzgxz5UgJMJUACm59UAIUyYANiJlz5ASiVZceYMAC0u1ADMAhiEVxMqHlRyo4+ALbhjCTGCOYCm/ADpEx+Sg6dkMBLT8AoKIwoVFZBWBmH1Z2KyNUAF4APnSxHh8HYzJUf0DkVWAgA</a></p>",
        "id": 500826153,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1740041930
    },
    {
        "content": "<p>If you get a red squiggly error, that’s because of a bug in lean4web (<a href=\"https://github.com/leanprover-community/lean4web/issues/41\">https://github.com/leanprover-community/lean4web/issues/41</a>) that processes the file with both versions of lean at the same time, and shows you the diagnostics from the old one. <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span> , is there any chance to fix this? This would also affect for example <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> should he use a lean4web instance for his course.</p>",
        "id": 500829418,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1740042984
    },
    {
        "content": "<p>Thanks for the warning! I confirm it would be great to fix such a bug before next Friday (the 28th).</p>",
        "id": 500829760,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740043086
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/Termination.20if.20we.20recurse.20via.20List.2Emap/near/500829760\">said</a>:</p>\n<blockquote>\n<p>Thanks for the warning! I confirm it would be great to fix such a bug before next Friday (the 28th).</p>\n</blockquote>\n<p>(At least it would like not bother you too much because the faulty Lean version running in the background should be \"Mathlib stable\" which is what you'll use anyways.)</p>",
        "id": 500843851,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1740047304
    },
    {
        "content": "<p>If they import a file that doesn’t exist in the background, the import would have a permanent squiggly line, I assume?<br>\n(As seen on <a href=\"https://lean.math.hhu.de/#project=DuperDemo&amp;codez=JYWwDg9gTgLgBAEQK5gKZQakEBQOg\">https://lean.math.hhu.de/#project=DuperDemo&amp;codez=JYWwDg9gTgLgBAEQK5gKZQakEBQOg</a>)</p>",
        "id": 500844677,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1740047549
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/270676-lean4/topic/Termination.20if.20we.20recurse.20via.20List.2Emap/near/500829418\">said</a>:</p>\n<blockquote>\n<p>If you get a red squiggly error, that’s because of a bug in lean4web (<a href=\"https://github.com/leanprover-community/lean4web/issues/41\">https://github.com/leanprover-community/lean4web/issues/41</a>) that processes the file with both versions of lean at the same time, and shows you the diagnostics from the old one. <span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> , is there any chance to fix this? This would also affect for example <span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> should he use a lean4web instance for his course.</p>\n</blockquote>\n<p>That seems also to cause some other weird behavior, such as the infoView-popup with the type and docstring of identifiers being duplicated, and autocomplete suggesting the same declaration twice.</p>",
        "id": 500865614,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740054408
    },
    {
        "content": "<p>fixed</p>",
        "id": 501262752,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1740229010
    },
    {
        "content": "<p>Thanks Jon!</p>",
        "id": 501277039,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740238374
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span>, I would have expected the following minimal example to succeed without needing the <code>decreasing_by</code> clause. Would this be possible to implement?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Tree</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"s2\">\", \"</span><span class=\"bp\">.</span><span class=\"n\">intercalate</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">  </span><span class=\"n\">decreasing_trivial</span>\n</code></pre></div>",
        "id": 571944592,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1770219627
    },
    {
        "content": "<p>This will work once we use <code>grind</code> for termination checking (and <code>grind</code> knows about <code>size</code>). It’s on the roadmap  I think.</p>",
        "id": 571949548,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1770220740
    },
    {
        "content": "<p>The workaround I usually use is to define the function by pattern matching on <code>t</code>, then the existing tactics can handle it.</p>",
        "id": 571950213,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1770220874
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Termination.20if.20we.20recurse.20via.20List.2Emap/near/500786317\">said</a>:</p>\n<blockquote>\n<p>And language support for this happening automatically is coming soon!</p>\n</blockquote>\n<p>Ooh this is cool.</p>",
        "id": 571976266,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1770228061
    }
]