[
    {
        "content": "<p>In the following example, the canonicalizer seems to be failing when asked to canonicalize the expression <code>∃ f : Nat → Nat, ∀ x, f x = 0</code>.  The error message is \"unexpected bound variable <code>#1</code>\".  Is this a bug?  If so, any diagnoses?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Canonicalizer</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">debug</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"canonicalizing {e}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">run'</span>\n<span class=\"w\">  </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">debug</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"canonicalized it to {e'}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works fine</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">debug</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- unexpected bound variable #1</span>\n</code></pre></div>",
        "id": 482483448,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731618616
    },
    {
        "content": "<p>Yes, the problem is in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Canonicalizer.mkKey#src\">src#Lean.Meta.Canonicalizer.mkKey</a></p>",
        "id": 482486882,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731620050
    },
    {
        "content": "<p>When we call <code>mkKey</code> on the <code>f</code> inside the existential, we hit the <code>app</code> branch with <code>f</code> being a bound variable, and then <code>getFunInfo</code> calls <code>inferType</code> on it and crashes with the observed error.</p>",
        "id": 482486971,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731620103
    },
    {
        "content": "<p>I'm uncertain whether we should be replacing the bound variables via an appropriate <code>telescope</code> function, or just adding an extra <code>isBVar</code> test after the current <code>isMVar</code> test.</p>",
        "id": 482487147,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731620172
    },
    {
        "content": "<p>OK, thanks for investigating and confirming!  I can open an issue if you like, let me know.</p>",
        "id": 482487327,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731620266
    },
    {
        "content": "<p>No need for an issue. <a href=\"https://github.com/leanprover/lean4/pull/6082\">lean#6082</a> fixes the reported problem, and doesn't break <code>omega</code> tests, but my spidey-sense says that I am doing it wrong... <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, could you take a quick look at this?</p>",
        "id": 482490960,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731621850
    },
    {
        "content": "<p>Even better. Thanks!</p>",
        "id": 482491107,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731621928
    }
]