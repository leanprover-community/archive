[
    {
        "content": "<p>The <code>.lake/</code> directory can grow quite large, and I think it should be marked for exclusion from backups as it can be recreated from the rest of the files. Adding a <a href=\"https://bford.info/cachedir/\">CACHEDIR.TAG</a> file to <code>.lake/</code> directory would accomplish this as many backup tools support it, including restic, Borg and GNU tar. And while at it, (some parts of) <code>~/.elan/</code> directory should also be marked as cache.</p>\n<p>Other programming languages are already doing this, like Rust that is excluding both <a href=\"https://github.com/rust-lang/cargo/pull/8378\"><code>target</code>/</a> and <a href=\"https://github.com/rust-lang/cargo/pull/10553\"><code>~/.cargo/{git,registry}</code></a> directories.</p>",
        "id": 456856463,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1722950812
    },
    {
        "content": "<p>Sounds like a good idea to me, and if we can just follow exactly what rust does it's probably a no brainer. </p>\n<p>Would you mind opening this as an issue on the lean4 repository? If it is sufficiently straightforward <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> might also be happy to see a PR implementing this, but I'd defer any decision making to him.</p>",
        "id": 459608305,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723253118
    },
    {
        "content": "<p>I would be happy with a PR creating a <code>.lake/CACHDIR.TAG</code> on <code>lake init</code>/<code>lake new</code>. Also, feel free to make an issue for this feature on the Lean 4 repository, so that we can keep tract of the request.</p>",
        "id": 459608632,
        "sender_full_name": "Mac Malone",
        "timestamp": 1723253293
    },
    {
        "content": "<p>Opened <a href=\"https://github.com/leanprover/lean4/issues/4998\">an issue</a>.</p>",
        "id": 460028414,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723451142
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/Exclude.20.2Elake.20directory.20from.20backups.20with.20CACHEDIR.2ETAG/near/459608632\">said</a>:</p>\n<blockquote>\n<p>I would be happy with a PR creating a <code>.lake/CACHDIR.TAG</code> on <code>lake init</code>/<code>lake new</code>.</p>\n</blockquote>\n<p>I think creating <code>.lake/CACHEDIR.TAG</code> only on <code>lake init</code> and <code>lake new</code> is too conservative. Say you clone Mathlib and run <code>lake build</code> or <code>lake exe cache get</code>. In this case, <code>.lake/CACHEDIR.TAG</code> should also be created.</p>",
        "id": 460028669,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723451237
    },
    {
        "content": "<p>The specification says the following:</p>\n<blockquote>\n<p>The application should also regenerate the cache directory tag if it disappears: e.g., if the entire contents of the cache directory is deleted without the directory itself being deleted.</p>\n</blockquote>\n<p>I don't think we should be this strict with the re-creation of the tag. Maybe a suitable middle ground would be to create <code>.lake/CACHEDIR.TAG</code> whenever <code>.lake/</code> directory gets created, whether it is by <code>lake new</code> or <code>lake build</code>.</p>",
        "id": 460029041,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723451396
    },
    {
        "content": "<p>Given we are in a <code>git</code>-only ecosystem, there is some advantage to only creating it at <code>new</code> and <code>init</code>: if the maintainer of the project really doesn't want it, they can make it go away simply by not committing it.</p>",
        "id": 460056279,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723460074
    },
    {
        "content": "<p>I think I prefer the simplicity of just having this be part of the new project templating system, rather than new logic attached to the \"create <code>.lake</code>\" step.</p>",
        "id": 460056356,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723460109
    },
    {
        "content": "<p>this sounds like more of a \"what should be the default\" than a \"should this exist\" argument... an option allowing the user to opt-in or -out of \"always creating the tag\" seems reasonable to me...</p>",
        "id": 460058268,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723460714
    },
    {
        "content": "<p>and then the logic would be \"if an author really doesn't want it, they can disable the feature adding it\"</p>",
        "id": 460058460,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1723460780
    },
    {
        "content": "<p>I agree, but also -- having an option to disable is extra complexity for a marginally valuable feature.</p>",
        "id": 460058531,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723460815
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"734614\">Henrik Lievonen</span> <a href=\"#narrow/stream/270676-lean4/topic/Exclude.20.2Elake.20directory.20from.20backups.20with.20CACHEDIR.2ETAG/near/460028669\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/Exclude.20.2Elake.20directory.20from.20backups.20with.20CACHEDIR.2ETAG/near/459608632\">said</a>:</p>\n<blockquote>\n<p>I would be happy with a PR creating a <code>.lake/CACHDIR.TAG</code> on <code>lake init</code>/<code>lake new</code>.</p>\n</blockquote>\n<p>I think creating <code>.lake/CACHEDIR.TAG</code> only on <code>lake init</code> and <code>lake new</code> is too conservative. Say you clone Mathlib and run <code>lake build</code> or <code>lake exe cache get</code>. In this case, <code>.lake/CACHEDIR.TAG</code> should also be created.</p>\n</blockquote>\n<p>I agree with this. Wiping <code>.lake</code> is a very common rescue action, so itâ€™s valuable that <code>.lake</code> as a whole is never committed to <code>git</code>.</p>",
        "id": 460059287,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1723461077
    },
    {
        "content": "<p>Considering that the default template has <code>/.lake</code> in <code>.gitignore</code>, none of <code>.lake/</code> should be included in the repository. This includes <code>CACHEDIR.TAG</code>. It is there to only mark that this directory is something that can be automatically recreated if necessary, and hence deleting it e.g. by ignoring it from backups should not have a catastrophic effect.</p>",
        "id": 460063181,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723462320
    },
    {
        "content": "<p>Also, if ignoring whole <code>.lake/</code> directory seems too much, adding <code>CACHEDIR.TAG</code> to all <code>.lake/build/</code> directories would already take us a long way. Those should definitely never include anything that cannot be recreated.</p>",
        "id": 460063416,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723462408
    },
    {
        "content": "<p>Can't we just have <code>.lake/CACHEDIR.TAG</code> in git, and everything else ignored?</p>",
        "id": 460067053,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723463701
    },
    {
        "content": "<p>I guess, by adding <code>!/.lake/CACHEDIR.TAG</code> to <code>.gitignore</code>, but I don't see what it would accomplish. The file is there just to indicate that the contents of the directory are computer-generated.</p>",
        "id": 460067592,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723463907
    },
    {
        "content": "<p>Given that people routinely <code>rm -rf .lake</code> it does sound like we would have to regenerate this file on every <code>lake build</code>. To be honest it sounds like not worth the bother, but I'll defer to Mac.</p>",
        "id": 460067919,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723464020
    },
    {
        "content": "<p>I also agree with Joachim that <code>rm -rf .lake/</code> is a very common thing to do when debugging if something is a problem with your own setup or a bug in <code>lake</code>.</p>\n<p>I wonder if it's rather <code>lake clean</code> (or <code>lake update</code>, dont know the exact details about which parts of them are overlapping) that could regenerate such a file. I thought <code>lake build</code> calls one of them if <code>.lake</code> (or the manifest) is missing and that's probably the right time to create this file, too.</p>",
        "id": 460072607,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1723465715
    },
    {
        "content": "<p>I would take <code>rm -rf .lake/</code> as one more reason to not have <code>CACHEDIR.TAG</code> in git. Instead, it should be recreated whenever <code>.lake/</code> directory gets created by lake.</p>",
        "id": 460081539,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723468880
    },
    {
        "content": "<p>Managed to find a couple of hours to implement this: <a href=\"https://github.com/leanprover/lean4/pull/5059\">lean4#5059</a></p>",
        "id": 462579081,
        "sender_full_name": "Henrik Lievonen",
        "timestamp": 1723736400
    }
]