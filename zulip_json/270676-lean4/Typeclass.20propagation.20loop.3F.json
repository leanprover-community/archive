[
    {
        "content": "<p>Here's a fascinating failure I came across while implementing the concrete category refactor for <code>MonCat</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Bottom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Bottom</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Bottom</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Middle₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Left</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Right</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Middle₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Middle₁</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">Top</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Middle₂</span><span class=\"w\"> </span><span class=\"n\">X</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Bundled</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Left</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"n\">loopy</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Middle₂</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Middle₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bundled.mk</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace.Meta.synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Top</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Right</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"c1\">-- Fails after 256 lines of \"[resume] propagating Middle₂ (Bundled.mk X).X to subgoal Middle₂ X of Middle₂ X\"</span>\n</code></pre></div>\n<p>I <em>think</em> this is because in the <code>loopy</code> instance, <code>(Bundled.mk X).X</code> can be reduced to <code>X</code> so somehow this gets Lean confused and makes it think has solved the wrong subgoal?</p>",
        "id": 496524064,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738149481
    },
    {
        "content": "<p>If we collapse <code>Middle₁</code> and <code>Middle₂</code> into one <code>Middle</code> class, we only get 128 passes through the <code>[resume] propagating</code> loop before we exit, which makes Lean happy to apply the instance.</p>",
        "id": 496524379,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738149580
    },
    {
        "content": "<p>Yes, fascinating! Maybe that should be in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a> ?</p>",
        "id": 496527634,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1738150651
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Typeclass.20propagation.20loop.3F\">#mathlib4 &gt; Typeclass propagation loop?</a> by <span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span>.</p>",
        "id": 496534389,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738152935
    },
    {
        "content": "<p>using <code>set_option pp.explicit true</code>, we can see that each next type (of the 256) contains an extra application of <code>loopy</code>. The part of the code that checks whether a new instance is different from the previous ones uses <code>==</code>, and it has a comment:</p>\n<p>Remark: isDefEq here is too expensive. TODO: if <code>==</code> is too imprecise, add some light normalization to <code>resultType</code> at <code>addAnswer</code></p>",
        "id": 497136903,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738392077
    }
]