[
    {
        "content": "<p>I'm encountering a symbol lookup error when working with external (FFI) C functions and standalone lean files (for testing and debugging).</p>\n<p>Here's a minimal working example:</p>\n<p>I have a <code>lakefile.lean</code> with a small workspace that defines a C file, compiles it to an object file, and links it into a Lean library:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span><span class=\"w\"> </span><span class=\"n\">System</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">ffi</span>\n\n<span class=\"n\">input_file</span><span class=\"w\"> </span><span class=\"n\">a.c</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a.c\"</span>\n<span class=\"w\">  </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">a.o</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">a.c.fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg.buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"a.o\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">buildO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"n\">flags</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">a.o</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>The C file <code>a.c</code> looks like:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;stdint.h&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"kt\">int8_t</span><span class=\"w\"> </span><span class=\"nf\">increment8</span><span class=\"p\">(</span><span class=\"kt\">int8_t</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><code>A.lean</code> defines the extern binding:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"increment8\"</span><span class=\"kd\">]</span>\n<span class=\"n\">opaque</span><span class=\"w\"> </span><span class=\"n\">A.increment8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int8</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Int8</span>\n</code></pre></div>\n<p><code>B.lean</code> uses <code>A.increment8</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">B.increment8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A.increment8</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">B.increment8</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Running <code>lake lean B.lean</code> correctly prints <code>2</code>.</p>\n<p>However, if I copy this into a separate <em>standalone</em> file <code>C.lean</code> (same contents, just renaming <code>B.increment8</code> to <code>C.increment8</code>) and run <code>lake lean C.lean</code>, I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">path</span><span class=\"bp\">/</span><span class=\"n\">to</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.20.0-rc5/bin/lean: symbol lookup error: /path/to/.lake/build/lib/lean/A.so: undefined symbol: increment8</span>\n</code></pre></div>\n<p>Interestingly, if I create <code>D.lean</code> that imports <code>B</code> instead of <code>A</code>, it works again:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">D.increment8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A.increment8</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">D.increment8</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>But if I remove <code>precompileModules := true</code> from <code>B</code> in the <code>lakefile</code>, <code>D.lean</code> also fails with the same undefined symbol error.</p>\n<p>Is this expected? Or is this a bug in how <code>lake lean</code> handles object files outside of a proper workspace context? And is there a recommended way to test such FFI bindings in standalone files?</p>\n<p>Any help understanding this behavior (or how to work around it) would be appreciated!</p>",
        "id": 519914947,
        "sender_full_name": "Abdalrhman M Mohamed",
        "timestamp": 1747945366
    },
    {
        "content": "<p>This is a natural consequence of how Lake currently handles precompilation and <code>lake lean</code> for files outside the workspace. However, it seems like undesirable behavior, so I would welcome an GitHub issue for this. Also, thank you for creating such a strightforward MWE!</p>",
        "id": 519956064,
        "sender_full_name": "Mac Malone",
        "timestamp": 1747968776
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/issues/8448\">https://github.com/leanprover/lean4/issues/8448</a></p>",
        "id": 519958910,
        "sender_full_name": "Abdalrhman M Mohamed",
        "timestamp": 1747970759
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"417967\">Abdalrhman M Mohamed</span> has marked this topic as resolved.</p>",
        "id": 525764888,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750874583
    }
]