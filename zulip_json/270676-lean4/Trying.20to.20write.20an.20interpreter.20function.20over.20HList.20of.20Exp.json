[
    {
        "content": "<p>Hello,</p>\n<p>I was working through a compiler book that uses Racket.</p>\n<p>However, I don't fancy dynamic types, so I wanted to see if I could implement the designs they present in the book in a dependently typed language.</p>\n<p>I started off using Idris2 awhile back, but I've switched to learning Lean recently and attempted to port over what little I had started on.</p>\n<p>I can't get the interpreter function in Lean to compile, however, it compiles and runs just fine in Idris2.</p>\n<p>Here's the Idris2 code:</p>\n<div class=\"codehilite\" data-code-language=\"Idris\"><pre><span></span><code><span class=\"kr\">module</span><span class=\"w\"> </span><span class=\"nn\">MinInterp</span>\n\n<span class=\"kr\">import</span><span class=\"w\"> </span><span class=\"nn\">Data.String</span>\n\n<span class=\"c1\">------------------------------------------------------------</span>\n<span class=\"c1\">-- Define Expression Types</span>\n<span class=\"kr\">record</span><span class=\"w\"> </span><span class=\"kt\">IntExp</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"kr\">constructor</span><span class=\"w\"> </span><span class=\"kt\">MkIntExp</span>\n<span class=\"w\">  </span><span class=\"nf\">x</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Int</span>\n\n<span class=\"kr\">record</span><span class=\"w\"> </span><span class=\"kt\">BoolExp</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"kr\">constructor</span><span class=\"w\"> </span><span class=\"kt\">MkBoolExp</span>\n<span class=\"w\">  </span><span class=\"nf\">x</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Bool</span>\n\n<span class=\"kr\">record</span><span class=\"w\"> </span><span class=\"kt\">StringExp</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"kr\">constructor</span><span class=\"w\"> </span><span class=\"kt\">MkStringExp</span>\n<span class=\"w\">  </span><span class=\"nf\">x</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">String</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define `HList`</span>\n\n<span class=\"kr\">data</span><span class=\"w\"> </span><span class=\"kt\">HList</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"nf\">HNil</span><span class=\"w\">  </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">HList</span><span class=\"w\"> </span><span class=\"kt\">Nil</span>\n<span class=\"w\">  </span><span class=\"ow\">(:::)</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"ow\">{</span>t<span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"ow\">}</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span>t<span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">HList</span><span class=\"w\"> </span>ts<span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">HList</span><span class=\"w\"> </span><span class=\"ow\">(</span>t<span class=\"w\"> </span><span class=\"ow\">::</span><span class=\"w\"> </span>ts<span class=\"ow\">)</span>\n\n<span class=\"kr\">infixr</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"ow\">:::</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define Primitive Operations</span>\n\n<span class=\"kr\">record</span><span class=\"w\"> </span><span class=\"kt\">Prim</span><span class=\"w\"> </span><span class=\"ow\">(</span>e<span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"kr\">constructor</span><span class=\"w\"> </span><span class=\"kt\">MkPrim</span>\n<span class=\"w\">  </span><span class=\"nf\">op</span><span class=\"w\">      </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">String</span>\n<span class=\"w\">  </span><span class=\"nf\">args</span><span class=\"w\">    </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">HList</span><span class=\"w\"> </span>e\n\n<span class=\"c1\">-- Example instances</span>\n<span class=\"nf\">eight</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">IntExp</span>\neight<span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"nf\">neg_eight</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Prim</span><span class=\"w\"> </span><span class=\"ow\">[</span><span class=\"kt\">IntExp</span><span class=\"ow\">]</span>\nneg_eight<span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"-\"</span><span class=\"w\"> </span><span class=\"ow\">(</span>eight<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">HNil</span><span class=\"ow\">)</span>\n\n<span class=\"nf\">rd</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Prim</span><span class=\"w\"> </span><span class=\"kt\">Nil</span>\nrd<span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"read\"</span><span class=\"w\"> </span><span class=\"kt\">HNil</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Result Type</span>\n\n<span class=\"kr\">data</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span><span class=\"nf\">IntResult</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Int</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span>\n<span class=\"w\">  </span><span class=\"nf\">BoolResult</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span>\n<span class=\"w\">  </span><span class=\"nf\">StringResult</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">String</span><span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span>\n\n<span class=\"kt\">Show</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"kr\">where</span>\n<span class=\"w\">  </span>show<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">IntResult</span><span class=\"w\"> </span>i<span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"s\">\"IntResult \"</span><span class=\"w\"> </span><span class=\"ow\">++</span><span class=\"w\"> </span>show<span class=\"w\"> </span>i\n<span class=\"w\">  </span>show<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">BoolResult</span><span class=\"w\"> </span>b<span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"s\">\"BoolResult \"</span><span class=\"w\"> </span><span class=\"ow\">++</span><span class=\"w\"> </span>show<span class=\"w\"> </span>b\n<span class=\"w\">  </span>show<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">StringResult</span><span class=\"w\"> </span>s<span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"s\">\"StringResult </span><span class=\"se\">\\\"</span><span class=\"s\">\"</span><span class=\"w\"> </span><span class=\"ow\">++</span><span class=\"w\"> </span>s<span class=\"w\"> </span><span class=\"ow\">++</span><span class=\"w\"> </span><span class=\"s\">\"</span><span class=\"se\">\\\"</span><span class=\"s\">\"</span>\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Interpreter</span>\n<span class=\"nf\">interpPrim</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">Prim</span><span class=\"w\"> </span>e<span class=\"w\"> </span><span class=\"ow\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Maybe</span><span class=\"w\"> </span><span class=\"kt\">Result</span>\ninterpPrim<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"read\"</span><span class=\"w\"> </span><span class=\"kt\">HNil</span><span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">Just</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">IntResult</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"ow\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Replace with actual read operation</span>\ninterpPrim<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"-\"</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">HNil</span><span class=\"ow\">))</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">Just</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">IntResult</span><span class=\"w\"> </span><span class=\"ow\">(-</span>x<span class=\"ow\">))</span>\ninterpPrim<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"+\"</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span>y<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">HNil</span><span class=\"ow\">))</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">Just</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">IntResult</span><span class=\"w\"> </span><span class=\"ow\">(</span>x<span class=\"w\"> </span><span class=\"ow\">+</span><span class=\"w\"> </span>y<span class=\"ow\">))</span>\ninterpPrim<span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkPrim</span><span class=\"w\"> </span><span class=\"s\">\"-\"</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">MkIntExp</span><span class=\"w\"> </span>y<span class=\"w\"> </span><span class=\"ow\">:::</span><span class=\"w\"> </span><span class=\"kt\">HNil</span><span class=\"ow\">))</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">Just</span><span class=\"w\"> </span><span class=\"ow\">(</span><span class=\"kt\">IntResult</span><span class=\"w\"> </span><span class=\"ow\">(</span>x<span class=\"w\"> </span><span class=\"ow\">-</span><span class=\"w\"> </span>y<span class=\"ow\">))</span>\ninterpPrim<span class=\"w\"> </span><span class=\"kr\">_</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kt\">Nothing</span>\n\n\n<span class=\"nf\">main</span><span class=\"w\"> </span><span class=\"ow\">:</span><span class=\"w\"> </span><span class=\"kt\">IO</span><span class=\"w\"> </span><span class=\"ow\">()</span>\nmain<span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"kr\">do</span>\n<span class=\"w\">  </span><span class=\"kr\">let</span><span class=\"w\"> </span>x<span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span>interpPrim<span class=\"w\"> </span>neg_eight\n<span class=\"w\">  </span>putStrLn<span class=\"w\"> </span><span class=\"ow\">(</span>show<span class=\"w\"> </span>x<span class=\"ow\">)</span>\n</code></pre></div>\n<p>And here's the Lean4 code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">------------------------------------------------------------</span>\n<span class=\"c1\">-- Define Expression Types</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">BoolExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">StringExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define `HList`</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c1\">-- fails to compile without the '1' in 'Type 1'</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixr</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"s2\">\" ::: \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">cons</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define Primitive Operations</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IntExp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eight</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Result Type</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">BoolResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">StringResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Interpreter</span>\n\n<span class=\"c1\">-- Doesn't compile:</span>\n<span class=\"c1\">-- Line that has the pattern match ({ x := 9001 } : Int Exp) :: HList.nil</span>\n<span class=\"c1\">-- fails to compile with the following error message:</span>\n<span class=\"c1\">-- pattern</span>\n<span class=\"c1\">--   { x := _fvar.5221 }</span>\n<span class=\"c1\">-- has type</span>\n<span class=\"c1\">--   IntExp : Type</span>\n<span class=\"c1\">-- but is expected to have type</span>\n<span class=\"c1\">--   t✝ : Type</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"c1\">-- replace with actual read operation</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span>\n</code></pre></div>\n<p>Is there no way to get this to compile?</p>",
        "id": 462466087,
        "sender_full_name": "James Good",
        "timestamp": 1723695520
    },
    {
        "content": "<p>you can define HList to avoid a universe bump but you need to define it by recursion instead of induction</p>",
        "id": 462470600,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723697629
    },
    {
        "content": "<p>here's a version which  uses a recursive definition of HList:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-----------------------------------------------------</span>\n<span class=\"c1\">-- Define Expression Types</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">BoolExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">StringExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define `HList`</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">ts</span>\n\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define Primitive Operations</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IntExp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eight</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Result Type</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">BoolResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">StringResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Interpreter</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"c1\">-- replace with actual read operation</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"o\">([</span><span class=\"n\">IntExp</span><span class=\"o\">]),</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span>\n</code></pre></div>",
        "id": 462471528,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723698037
    },
    {
        "content": "<p>However, it doesn't fix the main issue, and I think you can't really do this in lean. The trouble is that in your second pattern match, the expression <code>((IntExp.mk a) ::: HList.nil)</code> forces a certain type for <code>e: List Type</code>, which is to say the <code>_</code> is actually <code>[IntExp]</code> here, but while you can pattern match the <code>List Type</code> to have form <code>[_]</code>, you can't use pattern matching to make it <code>IntExp</code> without deciding type equality.</p>",
        "id": 462471895,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723698201
    },
    {
        "content": "<p>The right solution to this is the <a href=\"https://www.youtube.com/watch?v=AWeT_G04a0A\">universe pattern</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"AWeT_G04a0A\" href=\"https://www.youtube.com/watch?v=AWeT_G04a0A\"><img src=\"https://uploads.zulipusercontent.net/e527293f4481d55d5a61addbb58429a9cdc97bf5/68747470733a2f2f692e7974696d672e636f6d2f76692f415765545f4730346130412f64656661756c742e6a7067\"></a></div>",
        "id": 462471930,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723698242
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-----------------------------------------------------</span>\n<span class=\"c1\">-- Define Expression Types</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">BoolExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">StringExp</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">string</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"bp\">.</span><span class=\"n\">toExp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IntExp</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">BoolExp</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">StringExp</span>\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define `HList`</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">toExp</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">ts</span>\n\n<span class=\"c1\">-----------------------------------------------------------</span>\n<span class=\"c1\">-- Define Primitive Operations</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">int</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eight</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Result Type</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">BoolResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">StringResult</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n\n\n<span class=\"c1\">----------------------------------------------</span>\n<span class=\"c1\">-- Define Interpreter</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TypeCode</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Prim</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Result</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"read\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"c1\">-- replace with actual read operation</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">int</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IntExp</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">int_result</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">interpret_prim</span><span class=\"w\"> </span><span class=\"n\">neg_eight</span>\n</code></pre></div>",
        "id": 462472607,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723698487
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Trying.20to.20write.20an.20interpreter.20function.20over.20HList.20of.20Exp/near/462471930\">said</a>:</p>\n<blockquote>\n<p>The right solution to this is the <a href=\"https://www.youtube.com/watch?v=AWeT_G04a0A\">universe pattern</a></p>\n</blockquote>\n<p>Thank you for taking the time to reply.</p>\n<p>I can understand why this shouldn't work after seeing the explanation, regarding the identity function, as to why you wouldn't want to pattern match on types.</p>\n<p>However, I suppose my initial reason for expecting it to work is because the Idris2 version does compile, whereas the Lean4 version does not.</p>\n<p>I'll have to give chapter 8 of the Functional Programming in Lean book a read.</p>",
        "id": 462651074,
        "sender_full_name": "James Good",
        "timestamp": 1723760394
    },
    {
        "content": "<p>Out of curiosity, what is the underlying reason why Idris compiles the original code fine and Lean doesn't?</p>",
        "id": 465538727,
        "sender_full_name": "Yuri",
        "timestamp": 1724786180
    },
    {
        "content": "<p>maybe <span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span> knows?</p>",
        "id": 465576967,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724796063
    },
    {
        "content": "<p>I'm a bit out of the loop on modern Idris, but my understanding is that pattern matching the universe is allowed. Type erasure and something akin to parametricity (don't know if it is exactly that or not) is then achieved through the quantity system, by declaring them irrelevant. This is just a vague recollection, though - a quick search didn't point me to anywhere in the docs that describes this in particular.</p>",
        "id": 465626199,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1724819726
    }
]