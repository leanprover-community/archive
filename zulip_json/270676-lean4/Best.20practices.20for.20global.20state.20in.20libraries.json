[
    {
        "content": "<p>I'm currently playing around with writing a library. As part of this library I'd like to have some global state that my functions will make use of. Naturally then, I suppose I must use a state monad, but as I'd like my library to be general and composable with client code making use of other monads, I'll have to use a StateT monad transformer?</p>\n<p>I'm a little new to monad transformers as I haven't used them before. I've put together the following that kinda works, but it fails to typecheck if I don't appropriately annotate certain terms:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Library Code</span>\n\n<span class=\"c1\">-- Some Global State, A counter</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">counter</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">V</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"bp\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">incr</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">   </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"w\">   </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">counter_value</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">   </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">counter</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n\n\n<span class=\"c1\">-- Client code</span>\n<span class=\"c1\">-- User decides to define their own String state</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">M</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">StringData</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">res</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">res</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">StringData</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getString</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n\n<span class=\"c1\">-- client code, using</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">StringData</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">incr</span><span class=\"w\"> </span><span class=\"c1\">-- fails to typecheck unless I add a type annotation</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">counter_value</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getString</span>\n<span class=\"w\">   </span><span class=\"n\">return</span>\n</code></pre></div>\n<p>What am I doing wrong? Is this the correct model of what I should expect client code to look like? am I missing some instances?<br>\nThanks!</p>",
        "id": 482844665,
        "sender_full_name": "Kiran",
        "timestamp": 1731833907
    },
    {
        "content": "<p>Just to clarify here, <code>GlobalState.incr</code> fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">incr</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1859</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">1858</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>and the type annotation that succeeds is <code>show GlobalStateT IO Unit from GlobalState.incr</code>. I'd also like to know if there is a better way!</p>",
        "id": 482849585,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731838882
    },
    {
        "content": "<p>sorry if this question is too simple, I am a beginner and quite unfamiliar to idiomatic uses of monad transformers. I would really appreciate any help.</p>\n<p>From looking at code online, I guess the best way of doing it is using MonadStateOf?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">counter</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">get</span>\n<span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">            </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">counter</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">counter</span>\n<span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">            </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">modifyGet</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">counter</span>\n<span class=\"w\">            </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">            </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">out</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"kn\">extends</span>\n<span class=\"w\">    </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Global</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n<span class=\"w\">    </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MonadStateOf</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getCounter</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">    </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">counter</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">incrCounter</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">    </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">          </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">CanonicalInstance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">LiftInstance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">monadLift</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Global</span>\n\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Global</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">    </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"o\">)</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n</code></pre></div>\n<p>This seems to do what I want, and seems to be composable with other monad transformers, but I wonder if it's overkill?</p>",
        "id": 482849696,
        "sender_full_name": "Kiran",
        "timestamp": 1731838963
    },
    {
        "content": "<p>I think the issue with <code>GlobalState.incr</code> is usually solved in lean core by having a typeclass for monads that extend <code>GlobalStateT</code></p>",
        "id": 482849876,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839125
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/Best.20practices.20for.20global.20state.20in.20libraries/near/482849585\">said</a>:</p>\n<blockquote>\n<p>Just to clarify here, <code>GlobalState.incr</code> fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">incr</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1859</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">1858</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>and the type annotation that succeeds is <code>show GlobalStateT IO Unit from GlobalState.incr</code>. I'd also like to know if there is a better way!</p>\n</blockquote>\n<p>Yep, this is exactly the problem I'm having. I can kinda see that lean is having some kinof difficulty working out that <code>?m.1859</code> should be IO and then invoking monadLift, but I don't quite have a good enough model of what exactly's going on to understand why this inference is failing, and like where the annotation overhead should be placed in terms of clients vs. libraries</p>",
        "id": 482850018,
        "sender_full_name": "Kiran",
        "timestamp": 1731839240
    },
    {
        "content": "<p>A <code>MonadStateOf Nat</code> instance is a bad idea, that type is too general and will cause conflicts with other state monads in the stack</p>",
        "id": 482850024,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839247
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Best.20practices.20for.20global.20state.20in.20libraries/near/482849876\">said</a>:</p>\n<blockquote>\n<p>I think the issue with <code>GlobalState.incr</code> is usually solved in lean core by having a typeclass for monads that extend <code>GlobalStateT</code></p>\n</blockquote>\n<p>ah, so could I ask for like user defined libraries, what would be the recommendation of the way to composably define like global state? or do I just have to tell clients of my library that they may need to add annotations?</p>",
        "id": 482850110,
        "sender_full_name": "Kiran",
        "timestamp": 1731839331
    },
    {
        "content": "<p>this also works with <code>MonadLift</code> like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getEnv</span><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Environment</span>\n<span class=\"w\">  </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getEnv</span><span class=\"w\"> </span><span class=\"n\">modifyEnv</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getEnv</span><span class=\"w\">    </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getEnv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 482850138,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839363
    },
    {
        "content": "<p>no annotations are needed</p>",
        "id": 482850143,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839376
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Best.20practices.20for.20global.20state.20in.20libraries/near/482850138\">said</a>:</p>\n<blockquote>\n<p>this also works with <code>MonadLift</code> like so:</p>\n</blockquote>\n<p>could you give an example of what the client code using it would look like? I'm going to try it out now, but if you have it off the top of your head, that might be faster.</p>",
        "id": 482850257,
        "sender_full_name": "Kiran",
        "timestamp": 1731839476
    },
    {
        "content": "<p>this basically just works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">counter</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">V</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GlobalStateT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"bp\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">incr</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">   </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"w\">   </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">counter_value</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadStateOf</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">   </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">counter</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span>\n\n\n<span class=\"c1\">-- Client code</span>\n<span class=\"c1\">-- User decides to define their own String state</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">M</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">StringData</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">res</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">res</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">StringData</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getString</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StringDataT</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n\n<span class=\"c1\">-- client code, using</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">StringData</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">incr</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">GlobalState</span><span class=\"bp\">.</span><span class=\"n\">counter_value</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getString</span>\n<span class=\"w\">   </span><span class=\"n\">return</span>\n</code></pre></div>",
        "id": 482850268,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839494
    },
    {
        "content": "<p>from what I've seen of lean core metaprogramming though, it's pretty rare for a library to provide a monad transformer instead of just a monad of its own</p>",
        "id": 482850416,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839630
    },
    {
        "content": "<p>you would need whatever your core algorithm is to depend on user code in the wrapped monad for it to be worth it</p>",
        "id": 482850485,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839658
    },
    {
        "content": "<p>I think in general you would want to avoid that, in the same way that in haskell you try to avoid having your whole program live in IO if you can do most of the work in pure functions</p>",
        "id": 482850545,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839749
    },
    {
        "content": "<p>carrying around additional user state everywhere is just overhead if you aren't doing anything with it</p>",
        "id": 482850605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731839773
    },
    {
        "content": "<p>Ahh, thanks thanks, this works exactly! So I guess the recommended way is to use <code>MonadStateOf</code> with a specific enough type that it doesn't clash with other things.</p>\n<p>In my case, this isn't for a metaprogramming application, but a (non-metaprogramming, non-proof related) lean library , I just want the library to have some global state that gets manipulated over time without constraining the user to a particular monad stack.</p>",
        "id": 482850795,
        "sender_full_name": "Kiran",
        "timestamp": 1731839974
    },
    {
        "content": "<p>also, if you want literally <em>global</em> state you can also use <code>initialize</code></p>",
        "id": 482850874,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840034
    },
    {
        "content": "<p>I know you aren't asking about metaprogramming, but a lot of the issues and design questions around library design for programming in lean have already come up in lean core somewhere because it's a big compiler program with several identifiable subcomponents that service each other and user code</p>",
        "id": 482850989,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840138
    },
    {
        "content": "<p>The <code>MonadEnv</code> approach can be thought of as a slightly more specific version of <code>MonadStateOf Environment</code>, which avoids the issues with clashing types, shortens the name, and hides more implementation details around what state you are tracking</p>",
        "id": 482851163,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840290
    },
    {
        "content": "<p>Sorry my monad programming is a little rusty, but at least for the example I've given above, with the mix of a user defined string state monad and the library's global state, isn't the monad transformer the most ergonomic way to ensure that both can be composed?</p>",
        "id": 482851185,
        "sender_full_name": "Kiran",
        "timestamp": 1731840308
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/Best.20practices.20for.20global.20state.20in.20libraries/near/482851163\">said</a>:</p>\n<blockquote>\n<p>The <code>MonadEnv</code> approach can be thought of as a slightly more specific version of <code>MonadStateOf Environment</code>, which avoids the issues with clashing types, shortens the name, and hides more implementation details around what state you are tracking</p>\n</blockquote>\n<p>Ahh, okay, I guess I'll use the MonadEnv approach instead. You mentioned that <code>MonadStateOf Nat</code> would clash with other monads in the stack --- I guess that's because Nat is a generic enough type that if the client were also using this encoding, then they might also add instances for MonadStateOf Nat leading to conflicts? or are there parts of vanilla lean even that would clash with this?</p>",
        "id": 482851283,
        "sender_full_name": "Kiran",
        "timestamp": 1731840398
    },
    {
        "content": "<p>maybe? The code doesn't really do anything so it's difficult to say if this is the best way to accomplish the goal</p>",
        "id": 482851292,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840413
    },
    {
        "content": "<p>Yes you understood my point about <code>MonadStateOf Nat</code> correctly. The kind of data hiding that <code>MonadStateOf MyType</code> still lacks is that this is a state monad and not a reader or exception monad etc</p>",
        "id": 482851334,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840470
    },
    {
        "content": "<p>the <code>MonadEnv</code> approach lets you decide what functions you actually need for the implementation, and it need not even be public API to construct an instance</p>",
        "id": 482851446,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731840592
    },
    {
        "content": "<p>awesome, thanks for the advice! I think I kinda understand how to best monadically encode global state for a library</p>",
        "id": 482851566,
        "sender_full_name": "Kiran",
        "timestamp": 1731840700
    }
]