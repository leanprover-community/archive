[
    {
        "content": "<p>I have this error, which looks like a Lean bug. It seems that the double-nested dependency is required, the class parameter (specifically a class) is required as well, and the mutual recursion in the string functions is also needed.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">Class</span> <span class=\"n\">where</span>\n<span class=\"kd\">instance</span> <span class=\"n\">empty</span><span class=\"o\">:</span> <span class=\"n\">Class</span> <span class=\"o\">:=</span> <span class=\"o\">{}</span>\n\n<span class=\"kd\">mutual</span>\n<span class=\"kd\">inductive</span> <span class=\"n\">T</span> <span class=\"o\">(</span><span class=\"n\">δ</span><span class=\"o\">:</span> <span class=\"n\">Class</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">(</span><span class=\"n\">ss</span><span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"o\">(</span><span class=\"n\">S</span> <span class=\"n\">δ</span><span class=\"o\">))</span>\n\n<span class=\"kd\">inductive</span> <span class=\"n\">S</span> <span class=\"o\">(</span><span class=\"n\">δ</span><span class=\"o\">:</span> <span class=\"n\">Class</span><span class=\"o\">)</span> <span class=\"n\">where</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">(</span><span class=\"n\">ts</span><span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"o\">(</span><span class=\"n\">T</span> <span class=\"n\">δ</span><span class=\"o\">))</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">mutual</span>\n<span class=\"n\">partial</span> <span class=\"kd\">def</span> <span class=\"n\">str_T</span><span class=\"o\">:</span> <span class=\"n\">T</span> <span class=\"n\">δ</span> <span class=\"bp\">→</span> <span class=\"n\">String</span>\n<span class=\"bp\">|</span> <span class=\"bp\">.</span><span class=\"n\">mk</span> <span class=\"n\">ss</span> <span class=\"bp\">=&gt;</span> <span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"bp\">.</span><span class=\"n\">intercalate</span> <span class=\"o\">(</span><span class=\"n\">ss.map</span> <span class=\"n\">str_S</span><span class=\"o\">)</span>\n\n<span class=\"n\">partial</span> <span class=\"kd\">def</span> <span class=\"n\">str_S</span><span class=\"o\">:</span> <span class=\"n\">S</span> <span class=\"n\">δ</span> <span class=\"bp\">→</span> <span class=\"n\">String</span>\n<span class=\"bp\">|</span> <span class=\"bp\">.</span><span class=\"n\">mk</span> <span class=\"n\">ts</span> <span class=\"bp\">=&gt;</span> <span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"bp\">.</span><span class=\"n\">intercalate</span> <span class=\"o\">(</span><span class=\"n\">ts.map</span> <span class=\"n\">str_T</span><span class=\"o\">)</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">error</span> <span class=\"o\">:=</span> <span class=\"n\">str_T</span> <span class=\"o\">(</span><span class=\"n\">T.mk</span> <span class=\"o\">(</span><span class=\"n\">δ</span> <span class=\"o\">:=</span> <span class=\"n\">empty</span><span class=\"o\">)</span> <span class=\"o\">[])</span>\n<span class=\"c1\">-- (kernel) unknown constant 'str_T._at.error._spec_1'</span>\n</code></pre></div>\n<p>Cc <span class=\"user-mention\" data-user-id=\"130575\">@Siddharth Bhat</span></p>",
        "id": 283750650,
        "sender_full_name": "Sébastien Michelland",
        "timestamp": 1653401381
    },
    {
        "content": "<p>Temporary workaround for us: make the <code>str_*</code> functions total by not using <code>map</code>.</p>",
        "id": 283769123,
        "sender_full_name": "Sébastien Michelland",
        "timestamp": 1653408758
    },
    {
        "content": "<p>Pushed a fix for this.</p>",
        "id": 283966689,
        "sender_full_name": "Leonardo de Moura",
        "timestamp": 1653536390
    },
    {
        "content": "<p>I got a similar error, which I have minimized here. It seems to be due to a problem with specializing in a mutual recursive definition. Using a single monad instead of a stack like <code>ReaderT Unit (ReaderT Unit Id)</code> does work fine.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n\n<span class=\"kn\">mutual</span>\n<span class=\"w\">  </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"n\">B</span>\n\n<span class=\"w\">  </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"n\">A</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">oops</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"c1\">-- (kernel) unknown constant 'A._at.oops._spec_1'</span>\n</code></pre></div>\n<p>From copying the implementation of <code>ReaderT</code>, it seems this problem can be solved by modifying the <code>@[inline]</code> annotations in the <code>ReaderT</code> implementation: either add @[inline] to the instance <code>Monad (ReaderT ρ m)</code>, or remove it from <code>ReaderT.bind</code>.</p>",
        "id": 472677973,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1727265091
    },
    {
        "content": "<p>My temporary workaround is to add the inlined instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">bind</span>\n</code></pre></div>",
        "id": 472678742,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1727265350
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>, could you please create an issue for this one?</p>",
        "id": 472793987,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727311640
    },
    {
        "content": "<p>Sorry for the delay, here is the issue: <a href=\"https://github.com/leanprover/lean4/pull/5651\">lean4#5651</a></p>",
        "id": 475546051,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1728389224
    }
]