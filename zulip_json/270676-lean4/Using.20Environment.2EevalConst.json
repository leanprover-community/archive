[
    {
        "content": "<p>I'm trying to look at exported values (for introspection scripts in the Equational Theories project), and I can't get <code>Environment.evalConst</code> to work. </p>\n<p>I've been able to reproduce with a small example, based on the initial repo generated by lake. This is <code>Main.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">SearchPath</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Testimport</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello, {hello}!\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">searchPathRef</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">compile_time_search_path</span><span class=\"bp\">%</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Testimport</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"ss\">`Testimport.Basic.hello</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello, {value}!\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">err</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">err</span>\n</code></pre></div>\n<p>When running this (after allowing the interpreter in the lakefile) I'm getting this output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Hello</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">world!</span>\n<span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Testimport</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">hello'</span>\n</code></pre></div>\n<p>What am I doing wrong? How can I access exported values by name?</p>",
        "id": 476447645,
        "sender_full_name": "Amir Livne Bar-on",
        "timestamp": 1728675355
    },
    {
        "content": "<p>I don't think the definition is namespaced? Try <code> `hello </code></p>",
        "id": 476453706,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1728678228
    },
    {
        "content": "<p>Yes, this works. But the analogue doesn't work in the equational theories project, I'll try to dig into why.</p>",
        "id": 476472071,
        "sender_full_name": "Amir Livne Bar-on",
        "timestamp": 1728688939
    },
    {
        "content": "<p>The definitions I'm interested in (\"equations\") are defined through a tag declaration extension. The relevant part of the code is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">magmaLawExt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagDeclarationExtension</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkTagDeclarationExtension</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"equation \"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">tsyn</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lawName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Law{i.getNat}\"</span>\n<span class=\"w\">  </span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">defnDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lawName</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">addMarkup</span><span class=\"w\"> </span><span class=\"n\">lawName</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">magmaLawExt</span><span class=\"bp\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">lawName</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and in the extraction script I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"ss\">`Law1</span>\n</code></pre></div>\n<p>finding the expression for the definition, but</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"n\">Law</span><span class=\"bp\">.</span><span class=\"n\">NatMagmaLaw</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"ss\">`Law1</span>\n</code></pre></div>\n<p>failing to evaluate it (with <code>unknown declaration</code>).</p>",
        "id": 476472912,
        "sender_full_name": "Amir Livne Bar-on",
        "timestamp": 1728689614
    },
    {
        "content": "<p>You should use <code>addAndCompile</code> in that case instead of <code>addDecl</code></p>",
        "id": 476514260,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1728729352
    },
    {
        "content": "<p>sorry, mea culpa</p>",
        "id": 476522276,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728737569
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Using.20Environment.2EevalConst/near/476522276\">said</a>:</p>\n<blockquote>\n<p>sorry, mea culpa</p>\n</blockquote>\n<p>Are you changing this? I don't feel comfortable touching this foundational part of the code (though I verified it works in our case)</p>",
        "id": 476523024,
        "sender_full_name": "Amir Livne Bar-on",
        "timestamp": 1728738332
    },
    {
        "content": "<p>yes I'm writing the PR</p>",
        "id": 476523811,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739065
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/530\">equational#530</a></p>",
        "id": 476524770,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739992
    }
]