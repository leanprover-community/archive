[
    {
        "content": "<p>I am currently making the Lean ranges more polymorphic. In this context, the following issue occurred:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsValid</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">unit</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: expected type must not contain free variables</span>\n<span class=\"sd\">  IsValid true 1</span>\n<span class=\"sd\">Use the '+revert' option to automatically cleanup and revert free variables.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Just bear with me that the <code>MyType</code> construct is necessary for reasons unclear from the MWE. I'm trying to use <code>decide</code> to prove the <code>0 &lt; 1</code> condition (in general, this will just be any decidable predicate). Unfortunately, <code>decide</code> doesn't beta-reduce the <code>1</code>, which is actually an <code>OfNat</code> expression of type <code>MyType (n, true).2</code>. I would have expected this to be definitionally equal to <code>Nat</code>. Because the <code>OfNat</code> instance is actually <code>instOfNatNat 1</code>,  I expected <code>decide</code> to work, but it doesn't.</p>\n<p>I also tried <code>dsimp</code>, <code>omega</code>, <code>unfold Prod.snd</code>, <code>rw [Prod.snd.eq_def]</code> (yes, I was getting increasingly desperate), but none of them worked. <code>simp</code> is actually able to completely close the goal, but I want this to work for other decidable predicates, too.</p>\n<p>Is there any way to make Lean reduce the type (<code>(n, true).2 = true</code>), so that <code>decide</code> will work?</p>\n<p>(Aside: I have seen <a href=\"https://github.com/leanprover/lean4/issues/7833\">https://github.com/leanprover/lean4/issues/7833</a> and agree that the new ranges should provide a way to hook in more tactics besides <code>decide</code>. Still, I hope that <code>decide</code> will close many of the goals out of the box.)</p>",
        "id": 522742678,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1749203408
    },
    {
        "content": "<p>An update: I don't need this anymore, so I'll resolve the topic. However, I'm still interested in a solution for purely intellectual reasons ;)</p>",
        "id": 522753621,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1749207772
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221653\">Paul Reichert</span> has marked this topic as resolved.</p>",
        "id": 522753631,
        "sender_full_name": "Notification Bot",
        "timestamp": 1749207776
    },
    {
        "content": "<p>I think it would be nice if <code>unfold Prod.snd</code> would reduce the projection (could you make an issue?)</p>",
        "id": 522801405,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749223851
    },
    {
        "content": "<p>The <code>decide</code> tactic preprocessing is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.preprocessPropToDecide#doc\">docs#Lean.Elab.Tactic.preprocessPropToDecide</a>, which only does zeta-delta reduction I think, to try to eliminate dependence on the local context.</p>\n<p>I think it would be reasonable if it did a few other greek-letter reductions, especially since that shouldn't affect <code>Decidable</code> instance synthesis. Maybe there ought to be a little reduction module with a configuration to adjust which reductions you want to have done. Then <code>decide</code> could use it.</p>\n<p>On the other hand, <code>dsimp only; decidable</code> is a much more flexible system!</p>",
        "id": 522802877,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749224340
    }
]