[
    {
        "content": "<p>What exactly are the semantics of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.Range#doc\">docs#String.Range</a> as output by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Syntax.getRange%3F#doc\">docs#Syntax.getRange?</a></p>\n<p>Context: A lot of Mathlib linters use the output of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Syntax.getRange%3F#doc\">docs#Syntax.getRange?</a> to make decisions about what to lint. For example, the unused tactics linter uses the range of a piece of syntax as a unique reference:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"bp\">...</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">kind</span>\n<span class=\"w\">        </span><span class=\"c1\">-- if the tactic is allowed to not change the goals</span>\n<span class=\"w\">        </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·.</span><span class=\"n\">erase</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But while developing the tactic analysis framework in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28802\">#28802</a>, it turns out that <code>Syntax.getRange?</code> isn't shrinking as we go deeper into infotrees: <code>def foo where ...</code> expands to <code>def foo := { ... }</code>, which ends a couple bytes further on.</p>\n<p>So the questions are: is this intended behaviour? More generally, can we use the numbers reported by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Syntax.getRange%3F#doc\">docs#Syntax.getRange?</a> for anything, or are they all for internal use?</p>",
        "id": 536203324,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1756203052
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.SourceInfo#doc\">docs#Lean.SourceInfo</a></p>\n<blockquote>\n<p>is this intended behaviour?</p>\n</blockquote>\n<p>Yes. For <code>where</code>, we use the end of the trailing whitespace for the <code>SourceInfo</code> of the expanded syntax so that we can provide auto-completions for structure fields in whitespace.</p>\n<blockquote>\n<p>More generally, can we use the numbers reported by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Syntax.getRange%3F#doc\">docs#Syntax.getRange?</a> for anything</p>\n</blockquote>\n<p>It depends on what you want to do with them, but they certainly are not intended to uniquely identify a piece of original syntax across the <code>InfoTree</code>. Non-canonical synthetic ranges are mostly (but not always) ignored by the language server, canonical synthetic ranges are intended to represent some meaningful range in the source for a macro expansion and original ranges represent syntax as it exists in the source. </p>\n<p>Do you really want to lint the syntax produced by macro expansions, or only original syntax? In the latter case, you should probably limit linting to <code>original</code> <code>SourceInfo</code>, in which case the range should represent what you expect it to represent. In the former case, the ranges are definitely not intended to uniquely identify the original syntax across the <code>InfoTree</code>. I suppose you could use <code>MacroExpansionInfo</code>s during traversal to build a mapping, though.</p>",
        "id": 536216156,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1756208217
    },
    {
        "content": "<p>Anne, I don't know if this is useful for your application, but sometimes the <code>getRange?</code> dance is helpful to figure out whether some tactic that is executed by multiple branches of the proof is used at least in one branch or it is never used.</p>",
        "id": 536282572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756228821
    },
    {
        "content": "<p>Also, I often use the pair <code>(range, substring)</code> as a stand-in for something that is <code>HashHable</code> and a decent replacement for <code>Syntax</code>.</p>",
        "id": 536282588,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756228832
    }
]