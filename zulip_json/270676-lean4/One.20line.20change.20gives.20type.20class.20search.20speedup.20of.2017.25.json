[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover/lean4/pull/8915\">lean#8915</a>, I replaced <code>if (‚Üê isDefEq mvar instVal) then</code> with <code>mvar.mvarId!.assign instVal</code> in the type class search code that instantiates a type class goal with its value. This is possible, because <code>mvar</code> is an unassigned metavariable, and a different <code>isDefEq</code> call a few lines earlier guarantees that the type of <code>mvar</code> and <code>instVal</code> are the same.</p>\n<p>The <a href=\"https://github.com/leanprover-community/mathlib4/pull/26163#issuecomment-2989785397\">result on mathlib</a> is pretty big:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">typeclass</span><span class=\"w\"> </span><span class=\"n\">inference</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">2104</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\">               </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mf\">8500.60</span><span class=\"bp\">‚¨ù</span><span class=\"mi\">10</span><span class=\"bp\">‚Åπ</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mf\">5.62</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">lint</span><span class=\"w\">                </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mf\">407.986</span><span class=\"bp\">‚¨ù</span><span class=\"mi\">10</span><span class=\"bp\">‚Åπ</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mf\">5.78</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n</code></pre></div>\n<p>A small catch</p>\n<p>There is a bug that got exposed by this, which is that <code>synthPending</code> can assign metavariables that live in a lower <code>withNewMCtxDepth</code> depth. This bug has a funny interaction with the instance projection binderinfos that were changed in <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a>. For example, if you write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsOrderedMonoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">IsOrderedMonoid</span><span class=\"bp\">.</span><span class=\"n\">mul_le_mul_left</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"c1\">-- IsOrderedMonoid.mul_le_mul_left {Œ± : Type u} {_ : CommMonoid Œ±} {_ : PartialOrder Œ±}</span>\n<span class=\"c1\">--   [self : IsOrderedMonoid Œ±] (a b : Œ±) : a ‚â§ b ‚Üí ‚àÄ (c : Œ±), c * a ‚â§ c * b</span>\n</code></pre></div>\n<p>Then type class synthesis gets the goal <code>@IsOrderedMonoid Œ± ?m.97 ?m.98</code>, and these two metavariables get assigned illegally during the type class search, due to the bug. But if <code>IsOrderedMonoid.mul_le_mul_left</code> would have had the original (<code>[CommMonoid Œ±] [PartialOrder Œ±]</code>) binderinfos, this problem wouldn't arise.</p>\n<p>There were only two places in mathlib where I had to fix something related to this.</p>\n<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> had already proposed to switch the binderinfos back to how they were in another conversation (<a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/projection.20instance.20binderinfo.20problem/near/505861385\">#lean4 &gt; projection instance binderinfo problem @ üí¨</a>), so this gives another reason to do so.</p>",
        "id": 525174615,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750533016
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525174615\">said</a>:</p>\n<blockquote>\n<p>This is possible, because <code>mvar</code> is an unassigned metavariable</p>\n</blockquote>\n<p>Why does this invariant hold? It seems to me that instances can appear inside the types of other instance metavariables, and through previous isDefEqs they might be partially solved for. Is that not the case?</p>",
        "id": 525176697,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750536478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525174615\">said</a>:</p>\n<blockquote>\n<p>There is a bug that got exposed by this</p>\n</blockquote>\n<p>Could you clarify whether this is a pre-existing bug or if it is a bug introduced by using <code>MVarId.assign</code> without doing any checks that the assignment is valid?</p>",
        "id": 525176756,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750536578
    },
    {
        "content": "<p>The bug is pre-existing, and <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a> caused Lean to rely on this bug when elaborating class projections.</p>",
        "id": 525177072,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750537117
    },
    {
        "content": "<p>Typeclass inference shouldn't be making illegal metavariable assignments no matter which way the <code>class</code> command decides to set up binderinfos. I'm sure you know this, but I'm not sure I understand why you mention fixing mathlib instead of fixing a bug in <code>synthPending</code> (or what the bug in <code>synthPending</code> is ‚Äî I don't see anything in <a href=\"https://github.com/leanprover/lean4/pull/8915\">lean4#8915</a>).</p>\n<p>Do you agree that the bug in <code>synthPendingImp</code> is that it's using <code>Lean.MVarId.assign</code> directly instead of using <code>isDefEq</code>, which would verify the assignment is allowed?</p>",
        "id": 525177542,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750537852
    },
    {
        "content": "<p>I think the better fix would be to just add an explicit check for the <code>depth</code> in <code>synthPendingImp</code>. I don't think that the assignment created by <code>synthPendingImp</code> needs to be checked using an occurs check.</p>",
        "id": 525177702,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750538172
    },
    {
        "content": "<p>The reason why I haven't yet added a fix for the bug in <a href=\"https://github.com/leanprover/lean4/pull/8915\">lean#8915</a> is that then I would have to also revert the change made in <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a>. Which would get rid of half of the speedup. Instead of plainly reverting <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a>, I'd rather see some version of your proposal about choosing a better synthOrder. Although I guess that could also be done in a later PR.</p>",
        "id": 525177832,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750538466
    },
    {
        "content": "<p>(The fix in mathlib here is not meant as a permanent fix, but instead to be able to do the benchmarking)</p>",
        "id": 525177859,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750538522
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525176697\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525174615\">said</a>:</p>\n<blockquote>\n<p>This is possible, because <code>mvar</code> is an unassigned metavariable</p>\n</blockquote>\n<p>Why does this invariant hold?</p>\n</blockquote>\n<p>Good point, but looking closely, we can see that in <code>consume</code>, we filter out all the subgoals that already have been assigned. Thus, new <code>gNode</code>s will always have their metavariable unassigned (and since they store their own metavariable context without changing it, the metavariable stays unassigned).</p>",
        "id": 525178131,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750539090
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525177702\">said</a>:</p>\n<blockquote>\n<p>I don't think that the assignment created by <code>synthPendingImp</code> needs to be checked using an occurs check.</p>\n</blockquote>\n<p>Maybe it's impossible to induce a cycle, but I don't see why it's correct without an occurs check.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525177832\">said</a>:</p>\n<blockquote>\n<p>Instead of plainly reverting <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a></p>\n</blockquote>\n<p>I have to check: are you working with any core developers on any of these changes? Touching typeclass inference is not something I understood anyone was going to be doing right now.</p>\n<p>Reverting this is not going to happen just to avoid a bug in <code>synthPendingImp</code>. The synthOrder algorithm definitely needs to be fixed, but as far as I'm understanding it, it is independent of your changes to <code>tryResolve</code>, except in that your changes let it trigger a bug.</p>\n<p>Here's my feeling about this:</p>\n<ul>\n<li>I'm still not convinced that using MVarId.assign instead of isDefEq is correct here.</li>\n<li>Getting speedups by using unsafe functions is not surprising (interesting, but not surprising). Just because there's a speedup using unsafe functions does not mean it's worth pursuing right now.</li>\n<li>I don't see why you aren't attributing the bugs to this change in tryResolve. Doesn't it seem suspicious that this causes errors elsewhere? What is <code>assign</code> not doing that <code>isDefEq</code> does?</li>\n<li>For core to be interested, I think it needs to be extremely well justified, and come at the right time, when someone is actively working on typeclass inference. It's a lot easier to get a bug fix in than a performance improvement that requires a careful understanding of subtle invariants in a complicated system as well.</li>\n<li>My understanding is that touching typeclass inference now is not the right time. I could be wrong though, since it's not my area of Lean.</li>\n</ul>\n<p>Sorry to pour cold water on this (especially if I'm wrong and there's a core developer interested in pursuing your idea right now!)</p>",
        "id": 525178677,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750540197
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525178677\">said</a>:</p>\n<blockquote>\n<p>Maybe it's impossible to induce a cycle, but I don't see why it's correct without an occurs check.</p>\n</blockquote>\n<p>I'm not sure what you mean here. I thought the occurs check is to check that we don't induce a cycle.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525178677\">said</a>:</p>\n<blockquote>\n<p>are you working with any core developers?</p>\n</blockquote>\n<p>No, I'm working on this myself</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525178677\">said</a>:</p>\n<blockquote>\n<ul>\n<li>I'm still not convinced that using MVarId.assign instead of isDefEq is correct here.</li>\n</ul>\n</blockquote>\n<p>The things we need to check are: (1) the metavariable is unassigned, (2) the type of the assignment is correct, and (3) we don't introduce cycles.</p>\n<ol>\n<li>As I explained above, when creating a <code>gNode</code>, we have already checked that the <code>mvar</code> is not assigned</li>\n<li>With <code>isDefEq mvarTypeBody instTypeBody</code> we checked that the forall-body of the type of <code>mvar</code> is the same as the type of the lambda body of the <code>instVal</code> that we are assigning to it, which gives what we want. And we know that the <code>mkLambdaFVars xs</code> isn't doing any funny business to metavariables, because the metavariables in <code>instVal</code> don't depend on any of the <code>xs</code>.</li>\n<li><code>instVal</code> is created by applying an instance to the forall-body of the type of <code>mvar</code>. <code>mvar</code> is created in type class search, so it cannot appear in the (local) instances. And <code>mvar</code> cannot appear in any way in the type of <code>mvar</code>. So the constructed <code>instVal</code> cannot in any way contain <code>mvar</code>. Hence we don't need an occurs check.</li>\n</ol>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525178677\">said</a>:</p>\n<blockquote>\n<ul>\n<li>Doesn't it seem suspicious that this causes errors elsewhere? What is <code>assign</code> not doing that <code>isDefEq</code> does?</li>\n</ul>\n</blockquote>\n<p>I agree that this is extremely  suspicious, but I can explain it. In the current implementation, this <code>isDefEq</code> at some point reaches a subgoal that looks like <code>f ?m =?= f ?m</code>. Then instead of terminating with a <code>true</code>, the function <code>isDefEqArgs</code> calls the function <code>trySynthPending</code> on argument <code>?m</code>, which causes <code>?m</code> to be illegally assigned. So even though <code>?m =?= ?m</code> already is true, <code>isDefEq</code> still decides to assign<code>?m</code> to the synthesized value. So the 2 mathlib failures were cases where this illegal assignment didn't happend; and thus we were left with a metavariable that Lean didn't know how to fill in.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/One.20line.20change.20gives.20type.20class.20search.20speedup.20of.2017.25/near/525178677\">said</a>:</p>\n<blockquote>\n<ul>\n<li>For core to be interested, I think it needs to be extremely well justified</li>\n</ul>\n</blockquote>\n<p>Of course that makes a lot of sense, and I hope that I can justify it well enough.</p>",
        "id": 525182841,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750547748
    },
    {
        "content": "<p>As you say, I think the most sensible order to fix these things is to</p>\n<ul>\n<li>fix the binderinfos (to what they were before <a href=\"https://github.com/leanprover/lean4/pull/5376\">lean#5376</a>) and improve the synthOrder algorithm</li>\n<li>then fix the <code>synthPendingImp</code> bug</li>\n<li>and then the improvement that I'm proposing here.</li>\n</ul>",
        "id": 525182973,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750547973
    },
    {
        "content": "<p>I'd be happy to have a go at the first point some time.</p>",
        "id": 525182979,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750547993
    },
    {
        "content": "<p>Here's the <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> where <code>isDefEq</code> does something that <code>MVarId.assign</code> doesn't do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SuccOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PredOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsSuccArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"bp\">.</span><span class=\"n\">exists_pred_iterate_of_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The trace starts with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">LinearLocallyFiniteOrder</span><span class=\"bp\">.</span><span class=\"n\">instIsPredArchimedeanOfLocallyFiniteOrder</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1260</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1256</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">LinearLocallyFiniteOrder</span><span class=\"bp\">.</span><span class=\"n\">instIsPredArchimedeanOfLocallyFiniteOrder</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1256</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">assignable</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">LinearLocallyFiniteOrder</span><span class=\"bp\">.</span><span class=\"n\">instIsPredArchimedeanOfLocallyFiniteOrder</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonassignable</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">IsPredArchimedean</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">instDistribLatticeOfLinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toSemilatticeInf</span><span class=\"bp\">.</span><span class=\"n\">toPreorder</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">instDistribLatticeOfLinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toSemilatticeInf</span><span class=\"bp\">.</span><span class=\"n\">toPreorder</span>\n<span class=\"w\">          </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">PredOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">‚úù¬π</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">‚úù¬π</span>\n</code></pre></div>\n<p>The last <code>isDefEq</code> in the trace is the one that I removed in my PR. It reaches the subgoal <code>IsPredArchimedean Œ± =?= IsPredArchimedean Œ±</code>, which is actually <code>@IsPredArchimedean Œ± _ ?m.1251 =?= @IsPredArchimedean Œ± _ ?m.1251</code>. And here the metavariable <code>?m.1251</code> gets illegally assigned.</p>",
        "id": 525301533,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750675159
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> , <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> Do you think that the bug in <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Bug.20in.20instance.20synthesis.3F/near/525980562\">#mathlib4 &gt; Bug in instance synthesis? @ üí¨</a>  could be related to the one described in this thread? (it probably features prominently synthPending and various reducibility settings)</p>",
        "id": 526026250,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1751009103
    },
    {
        "content": "<p>(I can't test myself if the issue disappears with the branch of <a href=\"https://github.com/leanprover-community/mathlib4/pull/26163\">#26163</a>, as the Lean binaries are not available)</p>",
        "id": 526041229,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1751014886
    }
]