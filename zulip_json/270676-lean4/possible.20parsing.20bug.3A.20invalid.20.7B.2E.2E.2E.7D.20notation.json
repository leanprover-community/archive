[
    {
        "content": "<p>Is this a bug in the parser?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">----- Works:</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c1\">----- Does not work:</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">X</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">-- invalid {...} notation, exactly one explicit source is required when using '[&lt;index&gt;] := &lt;value&gt;' update notation</span>\n</code></pre></div>",
        "id": 564231675,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1765972132
    },
    {
        "content": "<p>Assuming that I understood what you want, it \"works\" with curly brackets:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 564238407,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974293
    },
    {
        "content": "<p>(or nothing at all!)</p>",
        "id": 564238491,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974322
    },
    {
        "content": "<p>Another workaround I found:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 564239019,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1765974509
    },
    {
        "content": "<p>My second comment was very cryptic: this also works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 564239152,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974553
    },
    {
        "content": "<p>I got it, thanks!</p>",
        "id": 564239227,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1765974576
    },
    {
        "content": "<p>You can see that the typeclass assumption is auto-introduced here.</p>",
        "id": 564239231,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974578
    },
    {
        "content": "<p>I think that there is a lot of matching and assignment that it would be nice to have in that position, but not much is actually implemented (EDIT: or feasible).</p>",
        "id": 564239387,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974631
    },
    {
        "content": "<p>So, yeah, in practice this is unlikely to be a real issue. Still, the behavior is inconsistent and probably not intended.</p>",
        "id": 564239510,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1765974673
    },
    {
        "content": "<p>Anyway, I am happy with the workarounds you and I found.</p>",
        "id": 564239612,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1765974708
    },
    {
        "content": "<p>At the very least, the error message could be more explicit about what the issue is, I think.</p>",
        "id": 564239664,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765974725
    },
    {
        "content": "<p>It's not a bug exactly, but a complication from structure notation. The <code>where ...</code> syntax is essentially a macro for <code>:= { ... }</code>, and in <code>{ ... }</code> you can use <code>[...]</code> to update array-like fields (internally called a \"modifyOp\"), like in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">change0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>It only works with <code>with</code> though, which isn't present in <code>where</code> syntax, so the restriction is a little pointless here.</p>\n<p>Something that is a little counterintuitive is that in <code>where</code>/<code>{...}</code> notation, the binder lists are effectively <code>fun</code> binder lists. The binder list here comes from the expected type, so all you need to do is provide identifiers, not <code>(...)</code>/<code>[...]</code>/<code>{...}</code>/<code>{{...}}</code> brackets. In this case, since the <code>X</code> parameter is implicit, it's automatically introduced anyway:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>Damiano already pointed this one out, but this is the reason for not needing to mention the parameter at all.</p>",
        "id": 564286063,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765987052
    },
    {
        "content": "<p>(One way this could be improved is to put <code>noWs</code> into the modifyOp parser. There's no reason to accept <code>xs [0] := x</code>.)</p>",
        "id": 564286317,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765987117
    },
    {
        "content": "<p>Oh, I did not realise that the error message was coming from a <code>modifyOp</code>!</p>",
        "id": 564287220,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765987338
    }
]