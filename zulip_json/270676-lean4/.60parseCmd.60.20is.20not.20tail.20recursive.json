[
    {
        "content": "<p>I am getting a stack overflow running <code>lean</code> (in CLI mode) on a really large file (actually not even that large, it fails on about the 7000th command). Running gdb shows the following repeating pattern in the stack trace:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"mi\">101</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff76e900a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">102</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff76e8849</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__4</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">103</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff76f69fb</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__9</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">104</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff76fa3cb</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__10</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">105</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff7705609</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__15</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">106</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff7706797</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__17</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">107</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff7707aec</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd___lambda__21</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n<span class=\"bp\">#</span><span class=\"mi\">108</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00007ffff76e900a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Language_Lean_process_parseCmd</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.19.0/bin/../lib/lean/libleanshared.so</span>\n</code></pre></div>\n<p>which implicates <a href=\"https://github.com/leanprover/lean4/blob/1f85fd2db8aadcd64990ef8da93b72c514df3498/src/Lean/Language/Lean.lean#L532-L718\">this function</a>, cc: <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span></p>",
        "id": 517351662,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746962801
    },
    {
        "content": "<p>I think we'll have to wait for improved TCO in the new compiler for that</p>",
        "id": 517351950,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746963016
    },
    {
        "content": "<p>is there any way to typecheck large files?</p>",
        "id": 517351974,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963035
    },
    {
        "content": "<p>can I turn off snapshotting?</p>",
        "id": 517351996,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963046
    },
    {
        "content": "<p>From the looks of that function it would not be automatically TCO'd anyway, because it's doing some stuff with async combinators</p>",
        "id": 517352159,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963132
    },
    {
        "content": "<p>Increase the stack size?</p>",
        "id": 517352181,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746963151
    },
    {
        "content": "<p>it also calls itself twice, I'm not sure which one is the main one</p>",
        "id": 517352188,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963157
    },
    {
        "content": "<p>is that a CLI option?</p>",
        "id": 517352249,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963214
    },
    {
        "content": "<p>It should be because this is not on the main thread</p>",
        "id": 517352282,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1746963241
    },
    {
        "content": "<p><code>lean -s 50000</code> seems to do the trick</p>",
        "id": 517353075,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746963920
    },
    {
        "content": "<p>the sub-call involved in the loop is the last one, which is nested in 6 lambdas mostly because of bad compilation of monadic bind (hopefully this is what the new compiler will fix), plus <a href=\"https://github.com/leanprover/lean4/blob/1f85fd2db8aadcd64990ef8da93b72c514df3498/src/Lean/Language/Lean.lean#L613\">this</a> combinator:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"c1\">-- Start new task when leaving fast-forwarding path; see \"General notes\" above</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">sync</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">do</span>\n</code></pre></div>\n<p>which should probably be rewritten to use something less combinator-looking (I think the case in question is always using the <code>else</code> branch here)</p>",
        "id": 517355707,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746965970
    }
]