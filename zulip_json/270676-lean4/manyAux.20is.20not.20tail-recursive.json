[
    {
        "content": "<p>I'm still not entirely sure I have this correct, but I have a perf report containing a huge stack of calls to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.manyAux#doc\">docs#Lean.Parser.manyAux</a> when parsing a very long list of commands using a syntax similar to a mutual block. The only reasonable conclusion is that <code>manyAux</code> is not tail-recursive, even though it is written in a style that implies it should be</p>",
        "id": 476524087,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739345
    },
    {
        "content": "<p>oh and indeed the IR reveals that it is not - one sided <code>if</code> strikes again</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"bp\">._</span><span class=\"n\">lambda_2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decLt</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_10</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">optionalFn</span><span class=\"bp\">._</span><span class=\"n\">closed_2</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkNode</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_13</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"bp\">._</span><span class=\"n\">lambda_3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"bp\">._</span><span class=\"n\">lambda_2</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_10</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"bp\">._</span><span class=\"n\">lambda_3</span><span class=\"bp\">._</span><span class=\"n\">closed_1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_14</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_14</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">beqOption</span><span class=\"bp\">.«_@».</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"bp\">._</span><span class=\"n\">hyg</span><span class=\"bp\">.</span><span class=\"m\">159</span><span class=\"bp\">._</span><span class=\"n\">at</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"bp\">._</span><span class=\"n\">spec_1</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">    </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">      </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_6</span>\n<span class=\"w\">    </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_12</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_14</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">manyAux</span><span class=\"bp\">._</span><span class=\"n\">lambda_3</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_14</span>\n</code></pre></div>",
        "id": 476524232,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739505
    },
    {
        "content": "<p>This is the code for <code>manyAux</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"s2\">\"invalid 'many' parser combinator application, parser did not consume anything\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkNode</span><span class=\"w\"> </span><span class=\"n\">nullKind</span><span class=\"w\"> </span><span class=\"n\">iniSz</span>\n<span class=\"w\">  </span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>\n<p>I have seen this issue before, the fix is to avoid early <code>return</code> in this kind of code because it generates lambdas for the join points that become part of a mutual tail recursion, which the code generator does not support</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">iniPos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"s2\">\"invalid 'many' parser combinator application, parser did not consume anything\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">stackSize</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">iniSz</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mkNode</span><span class=\"w\"> </span><span class=\"n\">nullKind</span><span class=\"w\"> </span><span class=\"n\">iniSz</span>\n<span class=\"w\">  </span><span class=\"n\">manyAux</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 476524386,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739671
    },
    {
        "content": "<p>cc: <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span></p>",
        "id": 476524425,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728739687
    },
    {
        "content": "<p>I came across this when optimizing the JSON parser a bit as well (<a href=\"https://github.com/leanprover/lean4/pull/4900\">lean4#4900</a>), though the effect there was mostly just slower code.</p>",
        "id": 476526119,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1728741433
    },
    {
        "content": "<p>I did not get a stack overflow, but parsing was suspiciously slow (like, minutes)</p>",
        "id": 476526201,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728741500
    },
    {
        "content": "<p>yup, ran into this issue with early return braking tail recursion as well recently.</p>",
        "id": 476531478,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728746559
    },
    {
        "content": "<p>Do we have an issue tracking this?</p>",
        "id": 476887488,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1728962798
    },
    {
        "content": "<p>Should we have a linter that flags recursive but not tail-recursive functions? Is it possible to figure out in a linter?</p>",
        "id": 476889644,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728963715
    },
    {
        "content": "<p>IMHO, having to explicitly say \"yes, I know that this function isn't tail-recursive\" is a low price for avoiding footguns (but I don't know if such a linter is possible).</p>",
        "id": 476889796,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728963775
    },
    {
        "content": "<p>What does tail recursive mean?</p>",
        "id": 476903511,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728971849
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/270676-lean4/topic/manyAux.20is.20not.20tail-recursive/near/476889796\">said</a>:</p>\n<blockquote>\n<p>IMHO, having to explicitly say \"yes, I know that this function isn't tail-recursive\" is a low price for avoiding footguns (but I don't know if such a linter is possible).</p>\n</blockquote>\n<p>The linter would have to inspect the IR not the surface level code. But yes its possible to do such things. However I'd say it should only check whether the function is TR if explicitly asked so, there are lots of non tail rec functions and lots of valid reasons to write them in Lean</p>",
        "id": 476903720,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728971958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/manyAux.20is.20not.20tail-recursive/near/476903511\">said</a>:</p>\n<blockquote>\n<p>What does tail recursive mean?</p>\n</blockquote>\n<p>That the recursive call of a function is the last thing that happens, that allows a sufficiently smart compiler to turn the function into a loop instead of consuming stack space.</p>",
        "id": 476903903,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728972019
    },
    {
        "content": "<p>Ok, checking that the last line is a call to the function itself and that no call to the function happened earlier should be relatively easy.  Is that really all that there is to it, or are there other issues?</p>",
        "id": 476905502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728972535
    },
    {
        "content": "<p>As you can see in this thread no that's not at all enough. You have to inspect the IR for this.</p>",
        "id": 476906018,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728972696
    },
    {
        "content": "<p>And again this should not be a default thing that runs on all functions, there is plenty of valid reasons to write non tail rec functions in lean</p>",
        "id": 476906137,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728972737
    },
    {
        "content": "<p>Ok, so would it be enough that the function is never called before the last line of all the declarations that are generated by the given one?</p>",
        "id": 476907242,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728973145
    },
    {
        "content": "<p>If you want to make absolutely sure something like that for looking at the closure of IR declarations generated by the function in question would probably work yes.</p>",
        "id": 476911793,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728974589
    },
    {
        "content": "<p>Though that's quite an over approximation given that there is lots of specialization happening so it will perform sub optimally on large code bases</p>",
        "id": 476911929,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728974630
    },
    {
        "content": "<p>Are IR declaration just regular declarations that are added to the environment, just some you would usually never inspect?</p>",
        "id": 476912214,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728974714
    },
    {
        "content": "<p>No they are fundamentally different. They're stored in an environment extension using a custom IR type. Leans IR is different (though not <em>very</em> different) from Expr or Syntax.</p>",
        "id": 476912590,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728974820
    },
    {
        "content": "<p>Ok, I would need to learn about that.  It is a regular environment extension and it will have its underlying inductive, right?  This is what I gather from your message.</p>",
        "id": 476912927,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728974915
    },
    {
        "content": "<p>Yes, there's also 3 different stages stored in the environment, you most likely only want to check the last</p>",
        "id": 476913513,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728975078
    },
    {
        "content": "<p>Ah, these are the declarations that I sometimes see ending in <code>stageN</code>?</p>",
        "id": 476913698,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728975124
    },
    {
        "content": "<p>But again, this should not be a check enabled by default, there are many valid reasons to have non tail rec functions. It should be an on demand check.</p>",
        "id": 476913788,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728975158
    },
    {
        "content": "<p>Yes, I understand.  However, before the check is not enabled by default, it should exist!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 476913990,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728975222
    }
]