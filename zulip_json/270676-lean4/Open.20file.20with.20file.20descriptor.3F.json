[
    {
        "content": "<p>Is there a way to access the file descriptor table?</p>\n<p>I want to write a systemd service which uses socket activation. The way this works is that systemd manages the socket file. When it detects a connection, it starts up the associated service, and passes the socket to the service by assigning it to file descriptor 3.</p>",
        "id": 448770223,
        "sender_full_name": "James Sully",
        "timestamp": 1719989387
    },
    {
        "content": "<p>No we do not have an API for that, in general most UNIX low level operations are lacking. I'm also not sure its a good idea to allow direct access to that table. This would allow users to close fds under the nose of other parts of their program. Maybe we could have a function that does something more limited but still allows you what you want to do?</p>",
        "id": 448770749,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719989608
    },
    {
        "content": "<p>hm, I'm not sure what that would look like though. I guess I have to resort to learning FFI for now.</p>",
        "id": 448770983,
        "sender_full_name": "James Sully",
        "timestamp": 1719989704
    },
    {
        "content": "<p>Do you know how this works in e.g. rust?</p>",
        "id": 448771075,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719989744
    },
    {
        "content": "<p>looks like there's an <code>unsafe</code> function<br>\n<a href=\"https://doc.rust-lang.org/std/os/fd/trait.FromRawFd.html\">https://doc.rust-lang.org/std/os/fd/trait.FromRawFd.html</a></p>",
        "id": 448771198,
        "sender_full_name": "James Sully",
        "timestamp": 1719989793
    },
    {
        "content": "<p>an example usage for my exact use case in this crate:<br>\n<a href=\"https://github.com/mitsuhiko/listenfd/blob/7d4675c314f65f237f9f5be129129128d3fefc8e/src/unix.rs#L84\">https://github.com/mitsuhiko/listenfd/blob/7d4675c314f65f237f9f5be129129128d3fefc8e/src/unix.rs#L84</a></p>",
        "id": 448771666,
        "sender_full_name": "James Sully",
        "timestamp": 1719990018
    },
    {
        "content": "<p>Hmnm, well we have unsafe in Lean as well but it is more restricting than rust unsafe. I guess we could add a fromFd function to Socket.lean that has a big warning attached to it in the doc string. Would you want to PR that?</p>",
        "id": 448772413,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719990318
    },
    {
        "content": "<p>sure, I'll see if I can suss it out</p>",
        "id": 448772642,
        "sender_full_name": "James Sully",
        "timestamp": 1719990396
    },
    {
        "content": "<p>I'm immediately stumped by trying to figure out what lean type corresponds to a c <code>int</code>. All the UInt* have correspondences, but <code>int</code> is signed. Lean's <code>Int</code> doesn't seem right because it can be of arbitrary size</p>",
        "id": 448779490,
        "sender_full_name": "James Sully",
        "timestamp": 1719992705
    },
    {
        "content": "<p>is there a reason lean doesn't have a suite of <code>Int8</code>, <code>Int32</code>, etc?</p>",
        "id": 448779593,
        "sender_full_name": "James Sully",
        "timestamp": 1719992734
    },
    {
        "content": "<p>We do want to add those. But if it's about a (mostly) opaque number like file descriptors, I think it's okay to go with the unsigned variant for now</p>",
        "id": 448779912,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1719992827
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/270676-lean4/topic/Open.20file.20with.20file.20descriptor.3F/near/448779490\">said</a>:</p>\n<blockquote>\n<p>I'm immediately stumped by trying to figure out what lean type corresponds to a c <code>int</code>. All the UInt* have correspondences, but <code>int</code> is signed. Lean's <code>Int</code> doesn't seem right because it can be of arbitrary size</p>\n</blockquote>\n<p>Besides that there is the issue that technically speaking the size of <code>int</code> is not determined, the C standard merely puts a lower limit on the size (that is 16 bit instead of the 32 that we have on most platforms). But I think we can just hope nobody uses obscure targets from the past and stick to <code>UInt32</code></p>",
        "id": 448781380,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719993319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> I'm not very fluent in c, so I'm a little confused. I'm trying to understand this function:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"lean_mk_sockaddr_un\"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SockAddrUnix</span><span class=\"bp\">.</span><span class=\"n\">unix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">FilePath</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SockAddrUnix</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">sockaddr_un</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">sa</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">malloc</span><span class=\"o\">(</span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">sockaddr_un</span><span class=\"o\">))</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sa</span><span class=\"bp\">-&gt;</span><span class=\"n\">sun_family</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">AF_UNIX</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">strncpy</span><span class=\"o\">(</span><span class=\"n\">sa</span><span class=\"bp\">-&gt;</span><span class=\"n\">sun_path</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean_string_cstr</span><span class=\"o\">(</span><span class=\"n\">path</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">sa</span><span class=\"bp\">-&gt;</span><span class=\"n\">sun_path</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">to_lean</span><span class=\"bp\">&lt;</span><span class=\"n\">SockAddrUnix</span><span class=\"bp\">&gt;</span><span class=\"o\">(</span><span class=\"n\">sa</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>Doing some research, it seems like <code>struct sockaddr_un</code> uses a very confusing feature called \"flexible array members\" for the <code>sun_path</code> field.</p>\n<p>My understanding was that <code>sizeof(struct sockaddr_un)</code> does not include <code>sun_path</code>, since it's variable length. I would have thought you would need to <code>malloc</code> not just the size of the struct, but the size of the struct plus the calculated length the <code>sun_path</code> will need to be. Am I misunderstanding something?</p>",
        "id": 448828521,
        "sender_full_name": "James Sully",
        "timestamp": 1720007752
    },
    {
        "content": "<p>Maybe according to the standard? But in practice sockaddr_un should is defined as a struct with an array that has some max size for the path AFAIK. The general reasoning here is that all sockaddrs should have the same size so for example sockaddr_in just has some useless padding data in the end. The whole sockaddr thing is pretty messy :D</p>",
        "id": 448828944,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720007901
    },
    {
        "content": "<p>ok, thanks. Messy indeed</p>",
        "id": 448829056,
        "sender_full_name": "James Sully",
        "timestamp": 1720007937
    },
    {
        "content": "<p>Yeah <code>unix(7)</code> says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">   </span><span class=\"n\">Address</span><span class=\"w\"> </span><span class=\"n\">format</span>\n<span class=\"w\">       </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">UNIX</span><span class=\"w\"> </span><span class=\"n\">domain</span><span class=\"w\"> </span><span class=\"n\">socket</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">represented</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"o\">:</span>\n\n<span class=\"w\">           </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">sockaddr_un</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">               </span><span class=\"n\">sa_family_t</span><span class=\"w\"> </span><span class=\"n\">sun_family</span><span class=\"bp\">;</span><span class=\"w\">               </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">AF_UNIX</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"w\">               </span><span class=\"n\">char</span><span class=\"w\">        </span><span class=\"n\">sun_path</span><span class=\"o\">[</span><span class=\"mi\">108</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\">            </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">Pathname</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"w\">           </span><span class=\"o\">}</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>So that's just the arbitrary upper limit :D</p>",
        "id": 448829827,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720008149
    },
    {
        "content": "<p>lmfao 108. obviously</p>",
        "id": 448830008,
        "sender_full_name": "James Sully",
        "timestamp": 1720008186
    },
    {
        "content": "<p>Surely there is some reasoning <span aria-label=\"tm\" class=\"emoji emoji-2122\" role=\"img\" title=\"tm\">:tm:</span> to this</p>",
        "id": 448830118,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720008206
    },
    {
        "content": "<p>I was reading <code>man sockaddr_un</code>. Silly of me</p>",
        "id": 448830321,
        "sender_full_name": "James Sully",
        "timestamp": 1720008241
    }
]