[
    {
        "content": "<p>I noticed two issues with codeblocks in hovers:</p>\n<p><strong>In editor hovers</strong>: markdown codeblocks that use “lean4” as the language are syntax-highlighted correctly, but ones that use “lean” aren’t. Currently almost all of the codeblocks in mathlib use “lean”, not “lean4”, and so aren’t highlighted.</p>\n<p>Should (can?) “lean” be supported, or should we stick to \"lean4\" (possibly providing a linter that corrects lean to lean4)?</p>\n<p><strong>In infoview hovers</strong>: although there is code in the extension that attempts to syntax highlight codeblocks, it doesn’t seem to be working; no language seems to get highlighted.</p>\n<p>I'm happy to open issues on the extension repo, but thought I ought to bring them up here first (in case there's an easy fix, or if we're already collectively aware of the behavior).</p>\n<p>MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Compare the syntax highlighting in these code blocks when hovering on `x`:</span>\n\n<span class=\"sd\">```lean</span>\n<span class=\"sd\">example : True := by trivial -- 'lean': Not highlighted</span>\n<span class=\"sd\">```</span>\n\n<span class=\"sd\">```lean4</span>\n<span class=\"sd\">example : True := by trivial -- 'lean4': Highlighted</span>\n<span class=\"sd\">```</span>\n\n<span class=\"sd\">```</span>\n<span class=\"sd\">example : True := by trivial -- none: Highlighted by fallback to editor highlighting</span>\n<span class=\"sd\">```</span>\n\n<span class=\"sd\">```js</span>\n<span class=\"sd\">function foo() { return \"bar\" } // Might be highlighted or not depending on system</span>\n<span class=\"sd\">```</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Hover on `x` in the infoview; no highlighting</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 479972325,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730416488
    },
    {
        "content": "<p>If you install the lean3 extension, then both will work</p>",
        "id": 479973110,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417039
    },
    {
        "content": "<p>My guess would be that vscode is using its syntax database (keyed by language name) to format markdown code blocks</p>",
        "id": 479973438,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417274
    },
    {
        "content": "<p>And registering both lean3 and lean4 with the same name would make it impossible to use both extensions at the same time</p>",
        "id": 479973511,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417299
    },
    {
        "content": "<p>Another consideration here is that pygments, which Zulip and <code>\\usepackage{minted}</code> use, calls the languages <code>lean</code> and <code>lean4</code></p>",
        "id": 479973571,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417343
    },
    {
        "content": "<p>But to be clear, if I install the lean3 extension, these codeblocks will be highlighted in lean3, right?</p>",
        "id": 479973873,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730417524
    },
    {
        "content": "<p>Yes</p>",
        "id": 479973887,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417533
    },
    {
        "content": "<p>That makes me wonder if we ought to have <code>lean</code> mean <code>lean4</code> now, and <code>lean3</code> reserved for <code>lean3</code></p>",
        "id": 479973902,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730417550
    },
    {
        "content": "<p>(Though I suppose that might break old repos...)</p>",
        "id": 479973918,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730417569
    },
    {
        "content": "<p>Does <code> ```lean </code> vs <code> ```lean4 </code> make any difference to doc-gen?</p>",
        "id": 479973970,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417625
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Issues.20with.20syntax.20highlighting.20in.20docstring.20codeblocks/near/479973918\">said</a>:</p>\n<blockquote>\n<p>(Though I suppose that might break old repos...)</p>\n</blockquote>\n<p>Optimistically things would be ok (within vscode), but this would require a re-release of the lean3 extension</p>",
        "id": 479974035,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417655
    },
    {
        "content": "<p>Changing pygments is slightly more obnoxious, as this would cause rebuilds of old LaTeX documents to start highlighting lean3 code as lean4, and makes it harder to spot whether zulip code is lean3 or lean4</p>",
        "id": 479974098,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417726
    },
    {
        "content": "<p>(and also changes to pygments are on a 6-month release cycle)</p>",
        "id": 479974115,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730417744
    },
    {
        "content": "<p>Hmmm, I guess that means the benefits of consistency ought to be taken into account: it might be odd for lean to mean lean4 in VS code and lean3 in e.g. LaTeX. Though I personally could get on board with pushing for lean to mean lean4 in as many places as reasonably possible...</p>",
        "id": 479974359,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730417944
    },
    {
        "content": "<p>Perhaps also of note:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- this is a ```lean codeblock, which links to both playgrounds to avoid confusion</span>\n<span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">not_in_lean3</span>\n<span class=\"kd\">abbreviation</span><span class=\"w\"> </span><span class=\"n\">i_only_exist_in_lean3</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- this is a ```lean3 codeblock, which zulip cannot treat differently from the above</span>\n<span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">not_in_lean3</span>\n<span class=\"kd\">abbreviation</span><span class=\"w\"> </span><span class=\"n\">i_only_exist_in_lean3</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- this is a ```lean4 codeblock, which links only to the lean4 playground</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">i_only_exist_in_lean4</span>\n<span class=\"n\">abbreviation</span><span class=\"w\"> </span><span class=\"n\">not_in_lean4</span>\n</code></pre></div>\n<p>which is controlled by a mixture of <a href=\"https://github.com/pygments/pygments/blob/4306a4708b24bbee06a2d7fb618c64448a00a377/pygments/lexers/lean.py#L25-L27\">these lines in Pygments</a> and the Zulip settings</p>",
        "id": 479974538,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730418082
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/Issues.20with.20syntax.20highlighting.20in.20docstring.20codeblocks/near/479973970\">said</a>:</p>\n<blockquote>\n<p>Does <code> ```lean </code> vs <code> ```lean4 </code> make any difference to doc-gen?</p>\n</blockquote>\n<p>It seems like doc-gen doesn't do any lean syntax highlighting for code blocks (whether <code>lean</code>, <code>lean4</code>, or no language specified).</p>",
        "id": 479975528,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730418878
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/List/TFAE.html#List.forall_tfae\">Here's</a> <code>lean</code>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/Eqns.html\">here's</a> <code>lean4</code>, and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/Zify.html\">here's</a> no language specified. I'm not sure if it influences the linkification of constants in any way...)</p>",
        "id": 479975716,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1730419025
    }
]