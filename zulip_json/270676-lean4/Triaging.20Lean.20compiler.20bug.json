[
    {
        "content": "<p>I have a file in a project that when compiled, never finishes compiling and Lean keeps using more and more memory. Is there a canonical way to triage this problem?</p>",
        "id": 516659070,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746620090
    },
    {
        "content": "<p>These tracing options don't do anything:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>I'm using <code>lake lean Test/FileInQuestion.lean</code> to compile the file.</p>",
        "id": 516660192,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746620436
    },
    {
        "content": "<p>Try using the <code>trace.compiler.*</code> options, the <code>trace.Compiler.*</code> ones don't seem to do anything yet.</p>",
        "id": 516660566,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746620548
    },
    {
        "content": "<p>Lean got stuck after printing this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">compiler</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">compiling</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Catenary</span><span class=\"bp\">.</span><span class=\"n\">Test</span><span class=\"bp\">.</span><span class=\"n\">Mystery</span><span class=\"bp\">._</span><span class=\"n\">example</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>where the example is</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat.succ.injEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq.trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat.succ_add</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat.succ_add</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">implies_congr</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">Eq.mpr</span><span class=\"w\"> </span><span class=\"n\">h3</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n</code></pre></div>\n<p>Correction: It seems like the infinite loop originated in <code>def</code> code and not this example.</p>",
        "id": 516660735,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746620622
    },
    {
        "content": "<p>After running for a while:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Test</span><span class=\"bp\">/</span><span class=\"n\">Mystery</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">174</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`delab</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"bp\">.</span><span class=\"o\">(</span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">lazy</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 516672538,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746623539
    },
    {
        "content": "<p><del>Could it be because there are too few type annotations in the file so isDefEq ate all the heartbeat?</del></p>",
        "id": 516672743,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746623597
    },
    {
        "content": "<p>If this is about the old compiler then the answer is very easy: it will never be fixed. The new compiler is around the corner.</p>",
        "id": 516746456,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1746644061
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/Triaging.20Lean.20compiler.20bug/near/516746456\">said</a>:</p>\n<blockquote>\n<p>If this is about the old compiler then the answer is very easy: it will never be fixed. The new compiler is around the corner.</p>\n</blockquote>\n<p>Will it be in Lean v4.20?</p>",
        "id": 516746498,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746644078
    },
    {
        "content": "<p>No, it’s not that close. But it’s close enough to make sure the old compiler won’t get any fix (unless there is something really massively urgent).</p>",
        "id": 516746674,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1746644137
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/channel/270676-lean4/topic/Triaging.20Lean.20compiler.20bug/near/516672538\">said</a>:</p>\n<blockquote>\n<p>After running for a while:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Test</span><span class=\"bp\">/</span><span class=\"n\">Mystery</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">174</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`delab</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"bp\">.</span><span class=\"o\">(</span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">lazy</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This error message just doesn't look like a compiler error at all to me? It's timing out in delaboration</p>",
        "id": 516755767,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1746647625
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/Triaging.20Lean.20compiler.20bug/near/516755767\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/channel/270676-lean4/topic/Triaging.20Lean.20compiler.20bug/near/516672538\">said</a>:</p>\n<blockquote>\n<p>After running for a while:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Test</span><span class=\"bp\">/</span><span class=\"n\">Mystery</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">174</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`delab</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"bp\">.</span><span class=\"o\">(</span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">lazy</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This error message just doesn't look like a compiler error at all to me? It's timing out in delaboration</p>\n</blockquote>\n<p>Yes, it was because I set <code>set_option trace.compiler true</code>. I couldn't figure out what was timing out the compiler.</p>",
        "id": 516755871,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746647653
    },
    {
        "content": "<p>And have you actually confirmed that it is a compiler error/timeout by other means?</p>",
        "id": 516756059,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1746647738
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/Triaging.20Lean.20compiler.20bug/near/516756059\">said</a>:</p>\n<blockquote>\n<p>And have you actually confirmed that it is a compiler error by other means?</p>\n</blockquote>\n<p>If I comment out a section of the code (which is a standard test harness) I have, the compiler doesnt time out anymore. That is all the evidence I have. <code>lake test</code> gets stuck at <code>[90/96] Test.Mystery...</code> so the infinite loop probably happens at compile time.</p>",
        "id": 516756300,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1746647834
    }
]