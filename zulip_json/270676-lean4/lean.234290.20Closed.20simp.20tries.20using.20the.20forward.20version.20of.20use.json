[
    {
        "content": "<p>Not sure where to put this so that it is seen, but I just noticed that my issue <a href=\"https://github.com/leanprover/lean4/pull/4290\">lean#4290</a> wasn't quite fully fixed. If someone could reopen it, it would be great!</p>",
        "id": 511817034,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744468934
    },
    {
        "content": "<p>My impression was that your new example is intended behaviour!</p>",
        "id": 511828019,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744477450
    },
    {
        "content": "<p>I just left a comment on the issue:</p>\n<blockquote>\n<p>I'd say that is a different issue, and in particular you're now asking for a new feature.</p>\n<p><code>simp</code> treats constants specially. It does not see <code>foo_eq_bar n</code> as having anything to do with <code>foo_eq_bar</code>, because once the term isn't just a constant, it goes through an elaboration process.</p>\n<p>It seems reasonable, but there are a number of questions. The first that come to mind:</p>\n<ul>\n<li>if you have <code>simp [foo_eq_bar n]</code>, should that erase the generic <code>foo_eq_bar</code>?</li>\n<li>if you have <code>simp [← fun n =&gt; foo_eq_bar n]</code> should that erase <code>foo_eq_bar</code>? (Why I ask: simp abstracts metavariables, so it would have to process lambdas. The question is \"should simp detect the lemma to erase syntactically or post-elaboration\".)</li>\n<li>would you be surprised if <code>simp [← id foo_eq_bar n]</code> erased <code>id</code>, if <code>id</code> were marked with <code>@[simp]</code>?</li>\n</ul>\n</blockquote>",
        "id": 511836322,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744484737
    },
    {
        "content": "<p>I perfectly understand why this happens (identifier vs proof term), but from a usability point of view it is quite sad that specifying an argument can lead to your simp suddenly looping</p>",
        "id": 511851799,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744498925
    },
    {
        "content": "<p>To answer your questions following that usability PoV:</p>\n<ul>\n<li>Yes, that's what the user expects when they specify an argument</li>\n<li>I see no use case for lambdas in simp (never saw one in four years of Lean), so happy to see it unsupported</li>\n<li>I can't come up with a reasonable example where applying a lemma changes its shape enough for it to act like a different lemma when rewritten backwards (it's actually even quite hard to come up with an appropriate description here)</li>\n</ul>",
        "id": 511852095,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744499198
    },
    {
        "content": "<p>Basically, all I want is for simp to detect a plain application of a lemma, no more.</p>",
        "id": 511852124,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744499229
    },
    {
        "content": "<p>This will solve all the cases I encountered where simp did something \"clearly stupid\" by rewriting with the same lemma back and forth many times</p>",
        "id": 511852201,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744499289
    },
    {
        "content": "<p>My reading of the lambda point is that the lambdas are inserted implicitly, so <code>simp [add_comm _ b]</code> ends up the same as <code>simp [fun a =&gt; add_comm a b]</code>.</p>",
        "id": 511855145,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744502429
    },
    {
        "content": "<p>But in principle the loop-detection step could happen prior to this transformation</p>",
        "id": 511855164,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744502451
    },
    {
        "content": "<p>For the first point, I disagree that's what the user expects. If <code>foo_eq_bar</code> is a simp lemma, and I call <code>simp [foo_eq_bar n]</code>, then I don't expect anything at all to be removed from the simp set!</p>",
        "id": 511855364,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744502597
    },
    {
        "content": "<p>I'd expect <code>simp [foo_eq_bar n]</code> to mean <code>simp [foo_eq_bar n, - ←foo_eq_bar n]</code> if that were legal syntax, but that might not be well-specified</p>",
        "id": 511856932,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744503971
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/270676-lean4/topic/lean.234290.20Closed.20simp.20tries.20using.20the.20forward.20version.20of.20use/near/511852095\">said</a>:</p>\n<blockquote>\n<ul>\n<li>Yes, that's what the user expects when they specify an argument</li>\n</ul>\n</blockquote>\n<p>I'm a Lean user too, and this user wouldn't necessarily expect this, hence my question.</p>\n<blockquote>\n<p>all I want is for simp to detect a plain application of a lemma, no more.</p>\n</blockquote>\n<p>Does that mean you would not expect <code>@foo_eq_bar n</code> or <code>(foo_eq_bar n)</code> to have special support? Only <code>foo_eq_bar n</code>? I would find this to be surprising.</p>\n<blockquote>\n<ul>\n<li>I see no use case for lambdas in simp (never saw one in four years of Lean), so happy to see it unsupported</li>\n</ul>\n</blockquote>\n<p>Eric is correct, lambdas are inserted implicitly. This is what \"simp abstracts metavariables\" means. It's very relevant, and I ask because I'm sure that you would bring up this issue again if simp lemma terms that elaborate to lambdas did not erase lemmas.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/270676-lean4/topic/lean.234290.20Closed.20simp.20tries.20using.20the.20forward.20version.20of.20use/near/511852201\">said</a>:</p>\n<blockquote>\n<p>This will solve all the cases I encountered where simp did something \"clearly stupid\" by rewriting with the same lemma back and forth many times</p>\n</blockquote>\n<p>Please collect examples!</p>",
        "id": 511868688,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744514910
    }
]