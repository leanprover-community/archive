[
    {
        "content": "<p>I'm trying to run a fairly expensive computation in the MetaM monad by visiting some nodes in an infotree and using <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Elab/InfoTree/Main.html#Lean.Elab.ContextInfo.runMetaM\">Lean.Elab.ContextInfo.runMetaM</a>. I tried setting the maxHeartbeats to 0, but I'm still hitting deterministic timeouts. I think I must be doing something wrong in setting the maxHeartbeats option. Here is a somewhat minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Frontend</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">searchPathRef.set</span><span class=\"w\"> </span><span class=\"n\">compile_time_search_path</span><span class=\"bp\">%</span>\n<span class=\"w\">  </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.FS.readFile</span><span class=\"w\"> </span><span class=\"s2\">\".lake/packages/mathlib/Mathlib/Algebra/Homology/Bifunctor.lean\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean.Parser.InputContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean.Parser.mkInputContext</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean.Parser.parseHeader</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats.set</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">processHeader</span><span class=\"w\"> </span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmdState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Command.mkState</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">options</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmdState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">cmdState</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">infoState.enabled</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.processCommands</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"w\"> </span><span class=\"n\">cmdState</span><span class=\"w\"> </span><span class=\"bp\">&lt;&amp;&gt;</span><span class=\"w\"> </span><span class=\"n\">Frontend.State.commandState</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.infoState.trees</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">tree.visitM'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctxInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofTermInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctxInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">ctxInfo</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats.set</span><span class=\"w\"> </span><span class=\"n\">ctxInfo.options</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">ctxInfo.runMetaM</span><span class=\"w\"> </span><span class=\"n\">info.lctx</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta.inferType</span><span class=\"w\"> </span><span class=\"n\">info.expr</span>\n<span class=\"w\">        </span><span class=\"n\">discard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Meta.whnf</span><span class=\"w\"> </span><span class=\"n\">tp</span>\n<span class=\"w\">        </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRemainingHeartbeats</span>\n</code></pre></div>\n<p>(run it in a project with <code>mathlib</code>).<br>\nThis doesn't hit a deterministic timeout, but it at least demonstrates that the remaining heartbeats is decreasing when I would expect it not to. What am I doing wrong?</p>",
        "id": 480223624,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730557549
    },
    {
        "content": "<p>You need to set the maxheartbeats in the core state I think; the ones in options have no effect</p>",
        "id": 480239290,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730570858
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> \"withHeartbeats\"</p>",
        "id": 480239353,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730570884
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Util/Heartbeats.html#Lean.withHeartbeats\">Lean.withHeartbeats</a></p>",
        "id": 480239354,
        "sender_full_name": "loogle",
        "timestamp": 1730570885
    },
    {
        "content": "<p>(nevermind, I'm thinking of something else)</p>",
        "id": 480239412,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730570952
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.State#doc\">docs#Lean.Core.State</a></p>",
        "id": 480239567,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730571102
    },
    {
        "content": "<p>Where in the state?</p>",
        "id": 480239623,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730571138
    },
    {
        "content": "<p>Is it in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.Context#doc\">docs#Lean.Core.Context</a> maybe?</p>",
        "id": 480239635,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730571155
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 480241885,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730573310
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/270676-lean4/topic/maxHeartbeats.20in.20ContextInfo.2ErunMetaM/near/480239635\">said</a>:</p>\n<blockquote>\n<p>Is it in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.Context#doc\">docs#Lean.Core.Context</a> maybe?</p>\n</blockquote>\n<p>Yes, that's what I was thinking of, thanks!</p>",
        "id": 480241931,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730573369
    },
    {
        "content": "<p>Should this be considered a bug in <code>ContextInfo.runCoreM</code>?</p>",
        "id": 480242015,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730573426
    },
    {
        "content": "<p>Another possible bug here is that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ContextInfo.runCoreM#src\">src#ContextInfo.runCoreM</a> does not set <code>initHeartbeats</code>, and so the hearbeat counter resets to zero each time</p>",
        "id": 480242023,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730573436
    },
    {
        "content": "<p>In fact I think this _is_ the bug, because if <code>IO.getNumHeartbeats</code> is greater than your limit before you even start, then you can'd do anything in CoreM</p>",
        "id": 480242098,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730573521
    },
    {
        "content": "<p>I have a patch somewhere fixing 5-10 \"didn't propagate hearbeats\" issues like this, but won't be able to find it now until after my vacation</p>",
        "id": 480242201,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730573600
    },
    {
        "content": "<p>That actually explains most issues I’ve been encountering. I thought I had a memory leak somewhere at some point, but I’m now quite sure it’s the bug Eric describes above.</p>",
        "id": 480243252,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730574536
    },
    {
        "content": "<p>In case it helps anyone else, for now I'm using the following, which works for my purposes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.ContextInfo</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">runCoreM'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">initHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.getNumHeartbeats</span>\n<span class=\"w\">  </span><span class=\"n\">Prod.fst</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">x.toIO</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.currNamespace</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.openDecls</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;InfoTree&gt;\"</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">initHeartbeats</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">initHeartbeats</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats.get</span><span class=\"w\"> </span><span class=\"n\">info.options</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.options</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ngen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.ngen</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">runMetaM'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Prod.fst</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">info.runCoreM'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x.run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info.mctx</span><span class=\"w\"> </span><span class=\"o\">})</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">ppGoals'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goals</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">goals.isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"no goals\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">ctx.runMetaM'</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Std.Format.prefixJoin</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goals.mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Meta.ppGoal</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)))</span>\n</code></pre></div>",
        "id": 480306970,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730640015
    },
    {
        "content": "<p>I think that Kyle recently made some of the monadic lift functions keep track of more of the available context.  If I remember correctly, these changes have been merged into core, but may not have trickled down to mathlib yet.</p>",
        "id": 480315772,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730647995
    },
    {
        "content": "<p>Maybe <a href=\"https://github.com/leanprover/lean4/pull/5800\">lean4#5800</a>?</p>",
        "id": 480315971,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730648168
    },
    {
        "content": "<p>The functions I’m using are all from core</p>",
        "id": 480316627,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1730648816
    },
    {
        "content": "<p>Ok, besides, I don't think that the heartbeats were present in Kyle's extra context.</p>",
        "id": 480316844,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730648904
    },
    {
        "content": "<p>I think my diagnosis above must have been incorrect, as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.CoreM.toIO#src\">src#Lean.Core.CoreM.toIO</a> sets <code>initHeartbeats</code> after all</p>",
        "id": 492140420,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736181639
    }
]