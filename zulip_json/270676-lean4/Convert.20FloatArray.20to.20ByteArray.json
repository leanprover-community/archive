[
    {
        "content": "<p>How do I convert <code>FloatArray</code> to <code>ByteArray</code> and vice versa? Both are represented as <code>lean_sarray_object</code> but just modifying <code>m_size</code> and casting does not work.</p>\n<p>On lean level I define these two functions</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"scilean_float_array_to_byte_array\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">toByteArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"scilean_byte_array_to_float_array\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">toFloatArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span>\n</code></pre></div>\n<p>Which are implemented by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">scilean_float_array_to_byte_array</span><span class=\"o\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">){</span>\n<span class=\"w\">  </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean_is_exclusive</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_copy_float_array</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">lean_to_sarray</span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_size</span><span class=\"w\"> </span><span class=\"bp\">*=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_to_float_array</span><span class=\"o\">(</span><span class=\"n\">lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">){</span>\n<span class=\"w\">  </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean_is_exclusive</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_copy_byte_array</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">lean_to_sarray</span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_size</span><span class=\"w\"> </span><span class=\"bp\">/=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>However when I run</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"o\">,</span><span class=\"mf\">2.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">,</span><span class=\"mf\">4.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"o\">,</span><span class=\"mf\">2.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">,</span><span class=\"mf\">4.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toByteArray</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"o\">,</span><span class=\"mf\">2.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">,</span><span class=\"mf\">4.0</span><span class=\"o\">,</span><span class=\"mf\">3.0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toByteArray</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toFloatArray</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"mf\">0.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">0.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">0.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">0.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">0.000000</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"mf\">1.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">2.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">3.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">4.000000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">3.000000</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 492373921,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1736278447
    },
    {
        "content": "<p>Do you need to set the capacity as well?</p>",
        "id": 492377834,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736280001
    },
    {
        "content": "<p>I think you also need to set <code>m_other = 1</code> when converting to a byte_array, and <code>m_other = 8</code> when going back to float64</p>",
        "id": 492378082,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736280075
    },
    {
        "content": "<p>Yes you are right. Looking at lean 4 source code exactly aligns with that.</p>\n<p><a href=\"https://github.com/leanprover/lean4/blob/0da5be1ba18c4d5ff7dd471903d9ee9d59b1b622/src/include/lean/lean.h#L859\"><code>lean_alloc_sarray</code></a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_sarray</span><span class=\"o\">(</span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">elem_size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">capacity</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_sarray_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean_sarray_object</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"n\">lean_alloc_object</span><span class=\"o\">(</span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">lean_sarray_object</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">elem_size</span><span class=\"bp\">*</span><span class=\"n\">capacity</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">lean_set_st_header</span><span class=\"o\">((</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"n\">o</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LeanScalarArray</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">elem_size</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_capacity</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">capacity</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"n\">o</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p><a href=\"https://github.com/leanprover/lean4/blob/0da5be1ba18c4d5ff7dd471903d9ee9d59b1b622/src/include/lean/lean.h#L517\"><code>lean_set_st_header</code></a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">lean_set_st_header</span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_rc</span><span class=\"w\">       </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_tag</span><span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_other</span><span class=\"w\">    </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"bp\">-&gt;</span><span class=\"n\">m_cs_sz</span><span class=\"w\">    </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n</code></pre></div>",
        "id": 492382528,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1736281995
    },
    {
        "content": "<p>And it seems to work as expected now.</p>",
        "id": 492383823,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1736282560
    }
]