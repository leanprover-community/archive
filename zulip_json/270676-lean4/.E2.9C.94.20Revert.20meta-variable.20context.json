[
    {
        "content": "<p>I am sorry that I failed to provide a minimal reproducible example about this.<br>\nMy question is: How can I saved the meta-variable context, and all other state about the <code>TacticM</code> (and <code>MetaM</code> and other lower monads), and revert them in the future?</p>\n<p>I am writing a tactic, which would invoke many other tactic candidates to solve a goal. so there is a for loop that calls <code>evalTactic</code>.</p>\n<p>I tried to use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"n\">finally</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">withNewMCtxDepth</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withoutModifyingMCtx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withoutModifyingEnv</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">withoutModifyingState</span><span class=\"w\"> </span><span class=\"k\">do</span>\n</code></pre></div>\n<p>to revert state.</p>\n<p>strange case 1: after the new tactic solves the main goal, hover the end of this new tactic, the infoview says <code>Error updating: Error fetching goals: Rpc error: InternalError: unknown metavariable '?_uniq.5340'.</code>, but no error in the message and <code>lake build</code>.</p>\n<p>strange case 2: some proofs can not checked with this tactic, says meta variable stuck in instance resolution. but manually use the candidate tactic, instead of use the new tactic, would complete the goal successfully.</p>",
        "id": 517193761,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1746828196
    },
    {
        "content": "<p>Are you reverting the context just on failed tactics or on successful invocations too?</p>",
        "id": 517195117,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746829156
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/Revert.20meta-variable.20context/near/517195117\">发言道</a>：</p>\n<blockquote>\n<p>Are you reverting the context just on failed tactics or on successful invocations too?</p>\n</blockquote>\n<p>Both, all candidates would be evaluated. So both failed and succeed</p>",
        "id": 517195893,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1746829666
    },
    {
        "content": "<p>What about when you execute the successful tactic at the end?</p>",
        "id": 517196366,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746829965
    },
    {
        "content": "<p>Still failed with previous two cases. I have no clue</p>",
        "id": 517196902,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1746830336
    },
    {
        "content": "<p>Turns out in the tactic, there is a <code>elabTermEnsuringType</code> call with <code>.none</code> as expected type, which has some side-effects that can not be reverted. I tried to lift all common subexpressions in my tactic, and give <code>.some type</code> as expected type, meta variable stuck problems are gone.</p>\n<p>Although my code works now, I still do not known how to revert the side-effects on meta-variables by <code>elabTermEnsuringType</code>...</p>",
        "id": 517237691,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1746864956
    },
    {
        "content": "<p>Oh, you have to revert the infotree too</p>",
        "id": 517263121,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746887415
    },
    {
        "content": "<p>I think <code>s.restore (restoreInfo := true)</code> will do that</p>",
        "id": 517263192,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746887489
    },
    {
        "content": "<p>The infotree is what gets you those \"expected type\" hovers and it also holds the tactic state and stuff</p>",
        "id": 517263424,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746887670
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"638718\">Alissa Tung</span> has marked this topic as resolved.</p>",
        "id": 517371530,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746977814
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/Revert.20meta-variable.20context/near/517263424\">发言道</a>：</p>\n<blockquote>\n<p>The infotree is what gets you those \"expected type\" hovers and it also holds the tactic state and stuff</p>\n</blockquote>\n<p>Thank you a lot!</p>",
        "id": 517371534,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1746977819
    },
    {
        "content": "<p>Thanks to <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> for pointing out the <code>(restoreInfo := true)</code>! In short:</p>\n<ol>\n<li><code>withoutModifyState</code> will not revert some meta vars state, use <code>.restore (restoreInfo := true)</code></li>\n<li><code>withoutModifyState</code> won't catch exception</li>\n</ol>",
        "id": 517548910,
        "sender_full_name": "Alissa Tung",
        "timestamp": 1747057261
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"638718\">Alissa Tung</span> has marked this topic as unresolved.</p>",
        "id": 517548930,
        "sender_full_name": "Notification Bot",
        "timestamp": 1747057266
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"638718\">Alissa Tung</span> has marked this topic as resolved.</p>",
        "id": 520371123,
        "sender_full_name": "Notification Bot",
        "timestamp": 1748242352
    }
]