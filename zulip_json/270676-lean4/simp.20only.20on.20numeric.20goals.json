[
    {
        "content": "<p>Is the following discrepancy in the behaviour of <code>simp only</code> known?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- goal `False`</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- \"simp made no progress\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- goal `False`</span>\n</code></pre></div>\n<p>I'm curious about why.  (Is this a similar issue to <a href=\"https://github.com/leanprover/lean4/pull/1994\">lean4#1994</a>?)</p>\n<p>Personally I think the \"simp made no progress\" is better, because this preserves consistency with the behaviour on non-special-cased types, such as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- \"simp made no progress\"</span>\n</code></pre></div>",
        "id": 462436744,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723680818
    },
    {
        "content": "<p>I think the pattern here is that it works when the outer constructors are different</p>",
        "id": 462438367,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723681321
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span>\n</code></pre></div>\n<p>fails too</p>",
        "id": 462438450,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723681340
    },
    {
        "content": "<p>In your examples, the constructors are respectively <code>succ,zero</code> (ok), <code>ofNat,ofNat</code> (fail), and <code>negSucc,ofNat</code> (ok)</p>",
        "id": 462438599,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723681406
    },
    {
        "content": "<p>That seems plausible, indeed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- goal `False`</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- \"simp made no progress\"</span>\n</code></pre></div>",
        "id": 462438873,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723681538
    },
    {
        "content": "<p>Would someone on the FRO comment on whether they would consider getting rid of this feature?  Perhaps it could be made a simp-proc, rather than baked into <code>simp only</code>.</p>",
        "id": 462439453,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723681756
    },
    {
        "content": "<p>I just found where it's defined: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Simp.simpCtorEq#doc\">docs#Lean.Meta.Simp.simpCtorEq</a> (it does exactly what Eric inferred, which is \"replace equalities between different constructors with False\")</p>",
        "id": 462439811,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723681880
    },
    {
        "content": "<p>The issue I see with the current behaviour is that various flavours of simp occur all over the place inside other tactics, so if there's no way to avoid this behaviour, it makes those tactics unpredictable too.  Here's the example where I noticed this, from <code>simp</code> occurring as a cleanup after failure in Mathlib's <code>ring</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">error: unsolved goals</span>\n<span class=\"cm\">⊢ 1 = 0</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">error: unsolved goals</span>\n<span class=\"cm\">⊢ False</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 462440071,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723681964
    },
    {
        "content": "<p>The first case is actually much more informative -- <code>simp</code> has done less cleanup, so the user gets better information back from the tactic about what went wrong in <code>ring</code>.</p>",
        "id": 462440141,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723682017
    },
    {
        "content": "<p>I don't think I can comment at the moment on whether or not to include this feature — maybe it's worth creating a Lean issue explaining why this leads to unpredictability? and why it affects teaching goals?</p>",
        "id": 462440217,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723682054
    },
    {
        "content": "<p>Sure, although I don't think it's a teaching issue so much as a general user issue.</p>",
        "id": 462440240,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723682086
    },
    {
        "content": "<p>Is the above explanation sufficient or is there something else I should address?</p>",
        "id": 462440284,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723682115
    },
    {
        "content": "<p>It seems reasonable making it be a user simproc, but there might be a reason it is where it is.</p>\n<p>I'm also wondering whether this builtin simproc should be upgraded to be stronger than it is (in particular, be able to reason about injectivity of constructors completely, so for example be able to reduce <code>left x = left y</code> to <code>x = y</code> automatically), though it might lead to some bad behavior with Nat...</p>",
        "id": 462440476,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723682275
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/270676-lean4/topic/simp.20only.20on.20numeric.20goals/near/462440284\">said</a>:</p>\n<blockquote>\n<p>Is the above explanation sufficient or is there something else I should address?</p>\n</blockquote>\n<p>This isn't a part of Lean that I work on, so I'm not sure what we would want to see, but I think it would be good creating an issue just to log that it's surprising that simp sees natural number literals as being constructor expressions in this context. The impact on automation like <code>ring</code> can help with the story too.</p>",
        "id": 462440767,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723682465
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 462440841,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723682519
    },
    {
        "content": "<p>Something suspect about this simproc is that when it figures out the constructors, it puts both sides of the expression into WHNF. For example, this triggers an error in the WHNF algorithm, despite <code>simp</code> being configured to do essentially nothing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">9999</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">neutralConfig</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">only</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">exponent 10000 exceeds the threshold 256, exponentiation operation was not evaluated,</span>\n<span class=\"cm\">use `set_option exponentiation.threshold &lt;num&gt;` to set a new threshold</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 462441239,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723682814
    },
    {
        "content": "<p>Sorry, I don't follow -- what is <code>Lean.Meta.Simp.neutralConfig</code>?  Is it the default, or if not then what does it turn off?</p>",
        "id": 462441940,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723683287
    },
    {
        "content": "<p><code>neutralConfig</code> sets every simp config option that's got to do with some sort of simplification to <code>false</code></p>",
        "id": 462441982,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723683334
    },
    {
        "content": "<p>The behaviour you noted still occurs when you just write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">9999</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span>\n</code></pre></div>\n<p>so I assume you were just including <code>Lean.Meta.Simp.neutralConfig</code> to be careful?</p>",
        "id": 462442172,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723683464
    },
    {
        "content": "<p>Yeah, I wanted to be sure none of the standard reductions did it</p>",
        "id": 462442308,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723683525
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> The simproc <code>simpCtorEq</code> turns up twice in <br>\n<a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Tactic/Simp/Rewrite.lean\">https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Tactic/Simp/Rewrite.lean</a><br>\n1) in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Simp.postSEval#doc\">docs#Lean.Meta.Simp.postSEval</a> and 2) in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Simp.postDefault#doc\">docs#Lean.Meta.Simp.postDefault</a>.  Do you know which of these two lists of simprocs is the one which controls what <code>simp only</code> does?</p>",
        "id": 462448037,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723685997
    },
    {
        "content": "<p><code>postDefault</code> is for <code>simp only</code> and <code>postSEval</code> is for <code>simp (config := { ground := true }) only</code> (this is a special mode for symbolically evaluating ground terms)</p>",
        "id": 462448328,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723686162
    },
    {
        "content": "<p>RFC at <a href=\"https://github.com/leanprover/lean4/pull/5046\">lean4#5046</a></p>",
        "id": 462451940,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723688080
    }
]