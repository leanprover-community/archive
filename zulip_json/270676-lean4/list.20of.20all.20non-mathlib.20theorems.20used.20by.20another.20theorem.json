[
    {
        "content": "<p>Hi everyone,</p>\n<p>I'm working on a formalization project using a blueprint setup, but updating the dependency graph by manually editing the <code>content.tex</code> file after every new definition and refactoring is cumbersome. It would be nice to have a tool that automatically analyzes the code and creates or updates the <code>.tex</code> files. Is there such a tool available?</p>\n<p>If not, is there an easy way to extract a list of all the non-mathlib theorems, definitions, instances, etc., used by other theorems, definitions, or instances? This would help me implement such a tool myself.</p>",
        "id": 456780305,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1722926581
    },
    {
        "content": "<p>This is a small adaptation of a command that counts all declarations in mathlib: I tweaked it to exclude the declarations defined in files whose path starts with one of <code>Init</code>, <code>Lean</code>, <code>Qq</code>, <code>ImportGraph</code>, <code>ProofWidgets</code>, <code>Std</code>, <code>Aesop</code>, <code>Batteries</code>, <code>Mathlib</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">excludedRootNames</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Init</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Qq</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`ImportGraph</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`ProofWidgets</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Std</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Aesop</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Batteries</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span>\n\n<span class=\"sd\">/-- `AllowedModIdxs env` returns the `ModuleIdx`s corresponding to imports in the environment `env`</span>\n<span class=\"sd\">whose root component does not belong to `excludedRootNames`. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AllowedModIdxs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allowedImports</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">excludedRootNames</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">getRoot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">allowedImports</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">      </span><span class=\"n\">modsSeen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">imp</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modIdx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#not_in_mathlib\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">allowed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AllowedModIdxs</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newDeclNames</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">({}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdxFor?</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">newDeclNames</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"No declarations outside of</span><span class=\"se\">\\n</span><span class=\"s2\">{(excludedRootNames.toArray.qsort Name.lt)}\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{n} declaration{if n == 1 then \"\" else \"</span><span class=\"n\">s</span><span class=\"s2\">\"} found in the modules</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">                      {(mods.toArray.qsort Name.lt)}</span><span class=\"se\">\\n\\n\\</span>\n<span class=\"s2\">                      {newDeclNames.toArray.qsort Name.lt}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">not_in_mathlib</span><span class=\"w\">  </span><span class=\"c1\">-- of course it reports 0!</span>\n</code></pre></div>",
        "id": 456817070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722939471
    },
    {
        "content": "<p>Thank you so much! It looks great. I’ll try it and let you know if I run into any issues.</p>",
        "id": 456889685,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1722959206
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/list.20of.20all.20non-mathlib.20theorems.20used.20by.20another.20theorem/near/456817070\">said</a>:</p>\n<blockquote>\n<p>This is a small adaptation of a command that counts all declarations in mathlib: I tweaked it to exclude the declarations defined in files whose path starts with one of <code>Init</code>, <code>Lean</code>, <code>Qq</code>, <code>ImportGraph</code>, <code>ProofWidgets</code>, <code>Std</code>, <code>Aesop</code>, <code>Batteries</code>, <code>Mathlib</code>.</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">excludedRootNames</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Init</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Qq</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`ImportGraph</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`ProofWidgets</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Std</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Aesop</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Batteries</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span>\n\n<span class=\"sd\">/-- `AllowedModIdxs env` returns the `ModuleIdx`s corresponding to imports in the environment `env`</span>\n<span class=\"sd\">whose root component does not belong to `excludedRootNames`. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AllowedModIdxs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allowedImports</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">excludedRootNames</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">getRoot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">allowedImports</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">      </span><span class=\"n\">modsSeen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">imp</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modIdx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">modsSeen</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#not_in_mathlib\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">allowed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AllowedModIdxs</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newDeclNames</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">({}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdxFor?</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">newDeclNames</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"No declarations outside of</span><span class=\"se\">\\n</span><span class=\"s2\">{(excludedRootNames.toArray.qsort Name.lt)}\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{n} declaration{if n == 1 then \"\" else \"</span><span class=\"n\">s</span><span class=\"s2\">\"} found in the modules</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">                      {(mods.toArray.qsort Name.lt)}</span><span class=\"se\">\\n\\n\\</span>\n<span class=\"s2\">                      {newDeclNames.toArray.qsort Name.lt}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">not_in_mathlib</span><span class=\"w\">  </span><span class=\"c1\">-- of course it reports 0!</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This just lists all the non-mathlib declarations, right? However, I also need the dependency relations between them. How can I modify this code to take the name of a declaration and output all the declarations it depends on?</p>\n<p>Additionally, where can I learn more about these things? Is there any documentation or tutorial available?</p>",
        "id": 457013502,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1723008254
    },
    {
        "content": "<p>I'm not at a computer now, but you can try adapting the code at <a href=\"#narrow/stream/270676-lean4/topic/Unused.20theorems\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Unused.20theorems</a>: the first function should return (some of) the dependencies of a declaration.</p>",
        "id": 457018685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723010908
    },
    {
        "content": "<p>In general, there is a difference between the dependencies for the <em>term</em> produced by the declaration and the dependencies that are needed to <em>produce</em> that term.</p>",
        "id": 457018829,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723010979
    },
    {
        "content": "<p>For instance, tactics and syntax are mostly invisible to the term.</p>",
        "id": 457018874,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723011000
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/list.20of.20all.20non-mathlib.20theorems.20used.20by.20another.20theorem/near/457018685\">said</a>:</p>\n<blockquote>\n<p>I'm not at a computer now, but you can try adapting the code at <a href=\"#narrow/stream/270676-lean4/topic/Unused.20theorems\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Unused.20theorems</a>: the first function should return (some of) the dependencies of a declaration.</p>\n</blockquote>\n<p>Thank you so much! I’ve been experimenting with the codes you provided, and they’ve been very useful. Do you know how I can get the docstring of a definition?</p>",
        "id": 459742140,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1723315339
    },
    {
        "content": "<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.TSyntax.getDocString#doc\">docs#Lean.TSyntax.getDocString</a>: I think that you extract from the <code>declModifiers</code> syntax node the <code>docComment</code> one and apply this one.  I have not tried it, though.</p>",
        "id": 459756495,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723321509
    },
    {
        "content": "<p>Let me know if you need more support and I can look at this!  (I'm switching off my computer now, though!)</p>",
        "id": 459756546,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723321530
    },
    {
        "content": "<p>I just realized that maybe you wanted the docstring starting from a <code>Name</code>: this is one way of getting it</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">DocString</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``Nat.succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`WhoAmI</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``Nat.zero_le</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">nms</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findDocString?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"sorry, no doc-string found for '{nm}'\"</span>\n</code></pre></div>",
        "id": 459869263,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723370001
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/list.20of.20all.20non-mathlib.20theorems.20used.20by.20another.20theorem/near/459869263\">said</a>:</p>\n<blockquote>\n<p>I just realized that maybe you wanted the docstring starting from a <code>Name</code>: this is one way of getting it</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">DocString</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``Nat.succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`WhoAmI</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``Nat.zero_le</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">nms</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findDocString?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"sorry, no doc-string found for '{nm}'\"</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Sorry for the late response. Somehow Zulip didn't notify me about your reply. </p>\n<p>Thank you so much! Right now, I can get all the user-defined declarations, their docstrings, and their dependencies. But for a declaration, I need to differentiate between two kinds of dependencies: </p>\n<ol>\n<li>Those that are used in the type of the declaration (e.g. the statement of the theorem)</li>\n<li>Those that are used in the construction of the declaration (e.g. the proof of the theorem)</li>\n</ol>\n<p>I don't really know how to approach this. Do you have any idea?</p>",
        "id": 462198008,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1723577561
    },
    {
        "content": "<p>From the environment, you can extract the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ConstantInfo#doc\">docs#Lean.ConstantInfo</a> of each declaration.  The <code>ConstantInfo</code>s  encode what kind of declaration you have: an axiom, a theorem, a definition and so on.  Each one of these kinds ConstantInfo has some more information associated to them.  Some of them have a <code>type</code> (e.g. probably what you mean when you say \"the statement of the theorem\") and a <code>value</code> (e.g. probably what you mean when you say \"the proof of the theorem\").</p>",
        "id": 462216955,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723585454
    },
    {
        "content": "<p>Carefully extracting this kind of information and feeding it to the <code>visited</code> machinery should yield what you want.</p>",
        "id": 462216994,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723585482
    },
    {
        "content": "<p>Btw, the kind of filtering that you are doing seems like it could be useful for mathlib as well: do share some of the code, if you feel like it!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 462217055,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723585516
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/list.20of.20all.20non-mathlib.20theorems.20used.20by.20another.20theorem/near/462216955\">said</a>:</p>\n<blockquote>\n<p>From the environment, you can extract the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ConstantInfo#doc\">docs#Lean.ConstantInfo</a> of each declaration.  The <code>ConstantInfo</code>s  encode what kind of declaration you have: an axiom, a theorem, a definition and so on.  Each one of these kinds ConstantInfo has some more information associated to them.  Some of them have a <code>type</code> (e.g. probably what you mean when you say \"the statement of the theorem\") and a <code>value</code> (e.g. probably what you mean when you say \"the proof of the theorem\").</p>\n</blockquote>\n<p>Hi again!  In your examples, you always used logInfo, but since  I need to write the results to a file, I want to work with a function Main : IO String. The function that reads the declarations has type CommandElabM String but I couldn't managed to convert it to IO String. Do you have any idea?</p>",
        "id": 462965083,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1723890801
    },
    {
        "content": "<p>If you are in <code>CommandElabM</code> you should already have access to <code>IO</code>.  The other way round, running code in <code>CommandElabM</code> from <code>IO</code>, should also be possible, but you would have to use some monad lifting/state creation.  There is a Monad map on the wikipage for Mathlib that has a lot of information about what lifts/runs are available.</p>",
        "id": 462972727,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723896342
    },
    {
        "content": "<p>However, unless you want to <em>avoid</em> <code>CommandElabM</code>, you should be able to work within it and not have to worry about lifting from IO to CommandElabM.</p>",
        "id": 462972935,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723896397
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/list.20of.20all.20non-mathlib.20theorems.20used.20by.20another.20theorem/near/462972935\">said</a>:</p>\n<blockquote>\n<p>However, unless you want to <em>avoid</em> <code>CommandElabM</code>, you should be able to work within it and not have to worry about lifting from IO to CommandElabM.</p>\n</blockquote>\n<p>Yeah, I misphrased my intention. The thing is, I want my script to be executable but lean requires the main function to use the IO monad.</p>",
        "id": 462980022,
        "sender_full_name": "Metin Ersin Arıcan",
        "timestamp": 1723899232
    },
    {
        "content": "<p>This page is very useful for all monadic lifts:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/wiki/Monad-map\">https://github.com/leanprover-community/mathlib4/wiki/Monad-map</a></p>",
        "id": 462982179,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723901110
    },
    {
        "content": "<p>There does not seem to be a direct path to run <code>CommandElabM</code> code in <code>IO</code>, but maybe you can lift it to CoreM or TermElabM and then run it from there?</p>",
        "id": 462982328,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723901233
    },
    {
        "content": "<p>Someone else may have a better suggestion, though.</p>",
        "id": 462982342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723901252
    }
]