[
    {
        "content": "<p>Is there something in core like <code>box</code> (as defined below) for benchmarking purposes?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">never_extract</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">box</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>I want to call functions and ignore their returns, but I don't want their calls to be simplified away</p>",
        "id": 517821327,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1747140433
    },
    {
        "content": "<p>Maybe <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=dbgTrace#doc\">docs#dbgTrace</a></p>",
        "id": 517822409,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747140681
    },
    {
        "content": "<p>That would pollute stdout. I'm fine with <code>box</code> as I implemented above. I was just wondering if core already had something for this specific purpose.</p>",
        "id": 517823000,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1747140821
    },
    {
        "content": "<p>Here's a list of all constants that are marked <code>@[never_extract]</code>:</p>\n<ul>\n<li><code>outOfBounds</code></li>\n<li><code>sorryAx</code></li>\n<li><code>panicWithPos</code></li>\n<li><code>panic</code></li>\n<li><code>dbgTraceIfShared</code></li>\n<li><code>panicWithPosWithDecl</code></li>\n<li><code>dbgStackTrace</code></li>\n<li><code>panicCore</code></li>\n<li><code>dbgTrace</code></li>\n</ul>",
        "id": 517844020,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747145934
    },
    {
        "content": "<p>I usually just implement <code>box</code> on the fly exactly like that</p>",
        "id": 518150075,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747253317
    },
    {
        "content": "<p>actually you probably want to have an opaque identity function, not a unit function</p>",
        "id": 518150127,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747253336
    },
    {
        "content": "<p>unit functions are frequently (always?) deleted</p>",
        "id": 518150183,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747253359
    },
    {
        "content": "<p>Even with <code>never_extract</code>?</p>",
        "id": 518162832,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1747258414
    },
    {
        "content": "<p>I can test it later. I still haven't had the chance</p>",
        "id": 518166048,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1747260027
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/channel/270676-lean4/topic/box.20for.20benchmarking/near/518162832\">said</a>:</p>\n<blockquote>\n<p>Even with <code>never_extract</code>?</p>\n</blockquote>\n<p><code>never_extract</code> turns off closed term extraction, meaning that if you have <code>box 1</code> then this will not be lifted to a top level definition even though it's a closed term. It does not actually change the execution semantics, and lean still does optimizations that would be legal for any pure function. If you want to avoid something getting optimized out it needs to be placed <em>in</em> the data flow, which is why things like <code>dbgTrace</code> have a callback.</p>",
        "id": 518187504,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747271739
    },
    {
        "content": "<p>I tried a similar approach to prevent function optimization when benchmarking the Fibonacci function, but unless I mark <code>fib</code> itself with <code>never_extract</code> the benchmark time is constant around 170ns. This occurs even for inputs like <code>fib 45</code> which clearly take several seconds to run. How can I place the result in the data flow or otherwise create a black box wrapper function?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">never_extract</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">blackBox</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"c1\">-- Copy of  `dbgTrace` logic</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"bp\">.</span><span class=\"n\">funArgs</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">never_extract</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">blackBox'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"c1\">--@[never_extract]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n'</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">monoNanosNow</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">blackBox</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"mi\">40</span>\n<span class=\"w\">  </span><span class=\"c1\">--let result := blackBox' \"\" (fun _ =&gt; fib) 40 -- This also doesn't work</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">monoNanosNow</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">1000000000</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Fib result: {result}\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Time: {diff}s\"</span>\n</code></pre></div>",
        "id": 523108300,
        "sender_full_name": "Sam Burnham",
        "timestamp": 1749480600
    },
    {
        "content": "<p>It still inlines <code>blackBox</code>; you need to use <code>noinline</code></p>",
        "id": 523110782,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749481417
    },
    {
        "content": "<p>That works! Thank you</p>",
        "id": 523111062,
        "sender_full_name": "Sam Burnham",
        "timestamp": 1749481513
    },
    {
        "content": "<p>See also this <a href=\"https://github.com/leanprover/lean4/issues/8591\">issue</a> on benchmarking pure functions I opened last week</p>",
        "id": 523233050,
        "sender_full_name": "Simon Dima",
        "timestamp": 1749543533
    }
]