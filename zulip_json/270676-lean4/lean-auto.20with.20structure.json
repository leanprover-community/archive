[
    {
        "content": "<p>Hi everyone,</p>\n<p>I was trying this simple example to use lean-auto to find sat/unsat for a trivial case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">printCommands</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">unsatCore</span><span class=\"bp\">.</span><span class=\"n\">leanExprs</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">unfoldedTestRec</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span>\n</code></pre></div>\n<p>which gives the following error <code>_private.Auto.Translation.LamFOL2SMT.0.Auto.SMT.lamTerm2STermAux :: Unexpected head term Auto.Embedding.Lam.LamTerm.lam (.atom 1) (.bvar 2)</code>. I was expecting the <code>auto</code> tactic to return <code>Sat</code>. </p>\n<p>Could someone please help me understand what is causing this error for cases like this?</p>",
        "id": 558489892,
        "sender_full_name": "Kaushik Raghavan",
        "timestamp": 1763659836
    },
    {
        "content": "<p>It appears that in Lean-auto's quest to identify definitional equalities between constants, it ends up unfolding <code>Auto.Bool.ite'</code> (auto's own version of <code>ite</code>). That unfolding introduces a higher-order lambda term, which cannot be translated to SMT-LIB. (Higher-order constructs were recently added in SMT-LIB 2.7, which no solver fully supports yet.)</p>\n<p>I see three possible ways to work around this:</p>\n<ol>\n<li>\n<p><strong>Mark <code>Auto.Bool.ite'</code> as <code>@[irreducible]</code>.</strong> Lean-auto does not unfold irreducible constants by default, so this avoids introducing the higher-order lambda. This would require a small change on Lean-auto's side (ping <span class=\"user-mention\" data-user-id=\"524339\">@Yicheng Qian</span>).</p>\n</li>\n<li>\n<p><strong>Restrict Lean-auto's transparency mode to unfold only reducible constants.</strong> This prevents unfolding <code>Auto.Bool.ite'</code>, but may cause Lean-auto to miss some otherwise obvious equalities. If you use this approach, you may also want to set <code>auto.mono.termLikeDefEq.mode</code> to <code>\"reducible\"</code>:</p>\n</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">mono</span><span class=\"bp\">.</span><span class=\"n\">ciInstDefEq</span><span class=\"bp\">.</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"s2\">\"reducible\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">[</span><span class=\"n\">unfoldedTestRec</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">[</span><span class=\"n\">unfoldedTestRec</span><span class=\"o\">]</span>\n</code></pre></div>\n<ol start=\"3\">\n<li><strong>Keep the default transparency mode but force Lean-auto to reduce the goal to FOL.</strong> By default Lean-auto supports higher-order reasoning with duper; switching to FOL mode can avoid the problematic lambda term. Since this reduction may fail (and <em>does</em> fail here), you should also tell Lean-auto to ignore hints it cannot reduce to FOL:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto.mono.mode</span><span class=\"w\"> </span><span class=\"s2\">\"fol\"</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto.mono.ignoreNonQuasiHigherOrder</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">[</span><span class=\"n\">unfoldedTestRec</span><span class=\"o\">]</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldedTestRec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">[</span><span class=\"n\">unfoldedTestRec</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 558591853,
        "sender_full_name": "Abdalrhman M Mohamed",
        "timestamp": 1763709544
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"417967\">@Abdalrhman M Mohamed</span> Thanks for looking into the issue! I have marked <code>Auto.Bool.ite'</code> and <code>Auto.Bool.ofProp</code> as <code>irreducible</code>.</p>",
        "id": 558622282,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1763719761
    },
    {
        "content": "<p>Thanks a lot for the detailed response and the quick fix <span class=\"user-mention\" data-user-id=\"417967\">@Abdalrhman M Mohamed</span>  and <span class=\"user-mention\" data-user-id=\"524339\">@Yicheng Qian</span> !</p>",
        "id": 558713376,
        "sender_full_name": "Kaushik Raghavan",
        "timestamp": 1763745497
    }
]