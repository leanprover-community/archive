[
    {
        "content": "<p>I believe I found a bug in <code>apply</code>. In the following code, <code>refine</code> works, but <code>apply</code> claims a sorry is not necessary. The following bug reproduced on the playground (i.e., latest mathlib), but also on Lean 4.12.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Integral</span><span class=\"bp\">.</span><span class=\"n\">Lebesgue</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">CompletePartialOrder</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">MeasureSpace</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- the actual definition is an expression involving y (and extra parameters).</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lintegral_monoOn</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hfg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∂</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∂</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">errors</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"c1\">-- This is fine: `refine` accepts this code.</span>\n<span class=\"w\">      </span><span class=\"c1\">-- bug: replacing \"refine\" by \"apply\" yields an error \"no goals to be solved\" on the sorry</span>\n<span class=\"w\">      </span><span class=\"c1\">-- (which is bogus: removing the sorry leads to the expected goal state)</span>\n<span class=\"w\">      </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">lintegral_monoOn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">y'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hy'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">      </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I presume this is a core bug. If not, please feel free to move to the <code>mathlib4</code> stream!</p>",
        "id": 481149697,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730994698
    },
    {
        "content": "<p>I minimized the imports; help diagnosing or minimizing this (e.g., making mathlib-free) would be very welcome!</p>",
        "id": 481150379,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730994913
    },
    {
        "content": "<p>I don’t think <code>apply</code> supports the <code>?_</code> syntax to create new goals, and if I just write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lintegral_monoOn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">y'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hy'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>then I get an error on <code>?_</code> saying </p>\n<blockquote>\n<p>don't know how to synthesize placeholder</p>\n</blockquote>",
        "id": 481154724,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1730996297
    },
    {
        "content": "<p>You can use it in some situations: <code>rg apply | grep \"?_\" | wc -l</code> on Mathlib prints 518, and there aren't too many grep false positives.</p>",
        "id": 481184306,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1731006886
    },
    {
        "content": "<p>For example <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/MeasureTheory/Function/Jacobian.lean#L583\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/MeasureTheory/Function/Jacobian.lean#L583</a></p>",
        "id": 481184503,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1731006962
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"577182\">@Gabriel Dahia</span> told me this less than a month ago and I was very surprised)</p>",
        "id": 481184625,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1731007003
    },
    {
        "content": "<p>What's super fun about <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span>'s example is that you get different behavior if you remove the pattern match and write <code>apply lintegral_monoOn fun arg =&gt; ?_</code> instead</p>",
        "id": 481184868,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1731007090
    },
    {
        "content": "<p>Hmm, ok, I take that back then. I thought there is a difference between how <code>refine</code> and <code>apply</code> treat <code>?_</code>?</p>",
        "id": 481200790,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1731013852
    },
    {
        "content": "<p>I'm guessing this is a bug in <code>apply</code> due to how the match <code>fun</code> is being elaborated (matches can be postponed, and it seems that it's being postponed until <em>after</em> <code>apply</code> figures out the new goals). It would be great if someone could find a mathlib-free example!</p>",
        "id": 481342994,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731081718
    }
]