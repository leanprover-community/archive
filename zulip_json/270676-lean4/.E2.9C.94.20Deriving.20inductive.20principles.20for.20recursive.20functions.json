[
    {
        "content": "<p>Sometimes, I find myself writing code like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">gt_one</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">dvd</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">padicVal</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}(</span><span class=\"n\">pp</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">)(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">padicVal</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_lt_self</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">gt_one</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">padicVal</span><span class=\"bp\">.</span><span class=\"n\">ind</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}(</span><span class=\"n\">pp</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">neg</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">/</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicVal</span><span class=\"bp\">.</span><span class=\"n\">ind</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"w\"> </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">/</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_lt_self</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">gt_one</span>\n</code></pre></div>\n<p>It seems like the inductive principle for a recursive function could be derived in a fully automated way. By any chance, does Lean already support something similar?</p>",
        "id": 500740759,
        "sender_full_name": "suhr",
        "timestamp": 1739998559
    },
    {
        "content": "<p>(can you make this a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> ? It's much easier for people to answer this way if you edit your post and add this small amount of extra effort: for example readers can then click on \"view in Lean 4 playground\" and it just works)</p>",
        "id": 500741467,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739998821
    },
    {
        "content": "<p>Sure, here's a working example: <a href=\"https://live.lean-lang.org/#codez=M4FwTgrgxiFgpgAgHIEMQDoAKYCWBbJACgDsAuFdASgpwHsAHRAdwAt4EAoRRAcxAD6dEvAoBGRAB5EJbogAmAN3kVAAEQBrADSJ1iQMREMxICTCHYgC8iCYAoiUxdmd58AGaIGqebigA1VABtEAN4MFGggAL5EDMGu2HiEVKQh1EkgiGRmcrguAqwUTAYkiIDkRIgADFKGIOyyPDxuHt5+rkykiAD0rlRy8L7A8HI8pZwgHPi4JOi4wgIARgCeMg7wUAiowOO8s3NyCE7jSKEYHooCvoJ9vtmsGABMzRj8QiKcSy71nj6+GOPygdGhESieViBHgXVqgXwdBAuEUokoqRMoWMiHoDDCA0QpHgvDUhS0iAANZF9IYSuVpCQqCioTC4YZ1ODapE6MA8TptCSCsUyhUqTTobDiCQ2gxqboTLShQymTxWuoUjREFL6fi0hkeFlELlXKTCuS+YgqvAarUGKyGdqse9Gl8fs0ZDjXBbSKLxUyen1MSJeJbWMNRuNJtN5otHCt4GsNlsds59gijrDTucei5rncog9BMJ+kA\">https://live.lean-lang.org/#codez=M4FwTgrgxiFgpgAgHIEMQDoAKYCWBbJACgDsAuFdASgpwHsAHRAdwAt4EAoRRAcxAD6dEvAoBGRAB5EJbogAmAN3kVAAEQBrADSJ1iQMREMxICTCHYgC8iCYAoiUxdmd58AGaIGqebigA1VABtEAN4MFGggAL5EDMGu2HiEVKQh1EkgiGRmcrguAqwUTAYkiIDkRIgADFKGIOyyPDxuHt5+rkykiAD0rlRy8L7A8HI8pZwgHPi4JOi4wgIARgCeMg7wUAiowOO8s3NyCE7jSKEYHooCvoJ9vtmsGABMzRj8QiKcSy71nj6+GOPygdGhESieViBHgXVqgXwdBAuEUokoqRMoWMiHoDDCA0QpHgvDUhS0iAANZF9IYSuVpCQqCioTC4YZ1ODapE6MA8TptCSCsUyhUqTTobDiCQ2gxqboTLShQymTxWuoUjREFL6fi0hkeFlELlXKTCuS+YgqvAarUGKyGdqse9Gl8fs0ZDjXBbSKLxUyen1MSJeJbWMNRuNJtN5otHCt4GsNlsds59gijrDTucei5rncog9BMJ+kA</a></p>\n<p>What I'd like to have is Lean deriving the <code>padicVal.ind</code> lemma from the definition of <code>padicVal</code>.</p>",
        "id": 500742235,
        "sender_full_name": "suhr",
        "timestamp": 1739999090
    },
    {
        "content": "<blockquote>\n<p>Sure, here's a working example</p>\n</blockquote>\n<p>I mean \"edit your original post to make it a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>\" (click on the three dots and \"edit message\"). This is the standard way that people ask questions here. It's just a suggestion but it's a good habit to get into. It's much better than links or screenshots.</p>",
        "id": 500742598,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739999222
    },
    {
        "content": "<p>Done.</p>",
        "id": 500742971,
        "sender_full_name": "suhr",
        "timestamp": 1739999377
    },
    {
        "content": "<p>I agree that what you want doesn't seem to be there. If you <code>import Mathlib.Util.WhatsNew</code> then <code>whatsnew in</code> before your def prints out what is currently generated under the hood, and the closest is <code>padicVal._unsafe_rec</code> which is <code>partial</code>.</p>\n<p>There might even be other things which are only generated on the fly when someone asks for them, but I don't know how to check for these.</p>",
        "id": 500743601,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739999595
    },
    {
        "content": "<p><code>padicVal.induct</code> is generated on the fly and might do what you need.</p>",
        "id": 500743901,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1739999707
    },
    {
        "content": "<p>See <a href=\"https://lean-lang.org/blog/2024-5-17-functional-induction/\">https://lean-lang.org/blog/2024-5-17-functional-induction/</a></p>",
        "id": 500743947,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1739999723
    },
    {
        "content": "<p>Indeed, this is what I'm looking for! Thanks.</p>",
        "id": 500744932,
        "sender_full_name": "suhr",
        "timestamp": 1740000115
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"394485\">suhr</span> has marked this topic as resolved.</p>",
        "id": 500745021,
        "sender_full_name": "Notification Bot",
        "timestamp": 1740000141
    },
    {
        "content": "<p>Darn it, this \"generate stuff on the fly\" thing really decreases the value of things like <code>whatsnew</code>. Is it possible to have a variant of <code>whatsnew</code> called <code>what_will_be_new</code> which also tells the user the secret things which Lean will generate if the user refers to them?</p>",
        "id": 500748088,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740001353
    },
    {
        "content": "<p>Probably yes and no... My understanding is that these things get defined when identifiers get resolved, meaning such a command will likely either be some sort of hard-coded logic, or a brute-force attempt to find all new names with length less than <code>n</code>. <br>\nTo me the hard-coding sounds bad, but the brute forcing sounds <em>worse</em>. Although depending on exactly how the resolving decides to generate a declaration we might be able to reuse some of the internals, so the command is automatically updated?</p>",
        "id": 500752606,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1740003058
    },
    {
        "content": "<p>How does resolving identifiers work?</p>",
        "id": 500753831,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1740003572
    },
    {
        "content": "<p>If we hard-code what lazy declarations are added when, the duty of maintaining seems to fall on the community. If we depend on the internals, it will cost flexibility on the side of the FRO, which also seems bad to me.</p>",
        "id": 500753854,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1740003582
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/113489-new-members/topic/.E2.9C.94.20Can.20I.20know.20exactly.20what.20collaterals.20are.20added.20by.20commands.3F/near/493022191\">said</a>:</p>\n<blockquote>\n<p>(If you search the Lean codebase for <code>registerReservedNameAction</code> you can see different modules that register code that does additional actions when resolving names, for example these <code>eq_*</code> lemmas.)</p>\n</blockquote>",
        "id": 500754745,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1740003937
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20Deriving.20inductive.20principles.20for.20recursive.20functions/near/500753831\">said</a>:</p>\n<blockquote>\n<p>How does resolving identifiers work?</p>\n</blockquote>\n<p>I don't know, but the above might help in finding out</p>",
        "id": 500754890,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1740003980
    },
    {
        "content": "<p>I was able to find Lean/ReservedNameAction.lean, I will read up this</p>",
        "id": 500757077,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1740004892
    }
]