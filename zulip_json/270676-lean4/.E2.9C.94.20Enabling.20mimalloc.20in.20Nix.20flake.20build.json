[
    {
        "content": "<p>I don't know where I should ask this question so I am posting it here. Apologies if there is a more suitable channel.</p>\n<p>I maintain lean4-nix and I am trying to get it to build with mimalloc via a patch: <a href=\"https://github.com/lenianiva/lean4-nix/pull/52\">https://github.com/lenianiva/lean4-nix/pull/52</a></p>\n<p>However CMake complains that it could not find the mimalloc header when building on Linux (on aarch64-darwin it seems to be fine)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">       </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">CMake</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">CMakeLists</span><span class=\"bp\">.</span><span class=\"n\">txt</span><span class=\"o\">:</span><span class=\"mi\">558</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">file</span><span class=\"o\">):</span>\n<span class=\"w\">       </span><span class=\"bp\">&gt;</span><span class=\"w\">   </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">COPY</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">find</span>\n<span class=\"w\">       </span><span class=\"bp\">&gt;</span><span class=\"w\">   </span><span class=\"s2\">\"/nix/store/9ljhaakj0s6fdrzhcr5r9030d9w83gg9-source/include/mimalloc.h\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span>\n<span class=\"w\">       </span><span class=\"bp\">&gt;</span><span class=\"w\">   </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>After investigating this issue for a couple of hours I still don't have any clue what is happening. If you know Nix could you take a look what could be the issue?</p>",
        "id": 524477349,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750173510
    },
    {
        "content": "<p>Have you seen <a href=\"#narrow/channel/270676-lean4/topic/.E2.9C.94.20Check.20if.20Lean.20uses.20mimalloc/with/516018405\">this topic</a>? I don't know if the specifics are related to your goal, but it's also about mimalloc and building Lean with Nix, so maybe <span class=\"user-mention\" data-user-id=\"674423\">@jthulhu</span> has an idea</p>",
        "id": 524481660,
        "sender_full_name": "Simon Dima",
        "timestamp": 1750174780
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"893179\">Simon Dima</span> <a href=\"#narrow/channel/270676-lean4/topic/Enabling.20mimalloc.20in.20Nix.20flake.20build/near/524481660\">said</a>:</p>\n<blockquote>\n<p>Have you seen <a href=\"#narrow/channel/270676-lean4/topic/.E2.9C.94.20Check.20if.20Lean.20uses.20mimalloc/with/516018405\">this topic</a>? I don't know if the specifics are related to your goal, but it's also about mimalloc and building Lean with Nix, so maybe <span class=\"user-mention silent\" data-user-id=\"674423\">jthulhu</span> has an idea</p>\n</blockquote>\n<p>jthulhu is the one who raised the possibility of having mimalloc in this build in the first place</p>",
        "id": 524504027,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750183482
    },
    {
        "content": "<p>I suspect it's due to Nix's sandboxing mechanism. You shouldn't refer to an arbitrary path (including those fetched by fetchGit) during the build process. Nix isolates the file system namespace, meaning you can't access anything that hasn't been explicitly set as a build input.</p>\n<p>Also, I think the way Lean uses mimalloc today is very unconventional (see <a href=\"https://github.com/leanprover/lean4/pull/7710\">https://github.com/leanprover/lean4/pull/7710</a>). Rather than managing the mimalloc dependency using CMake, the current implementation manually copy files around, which makes external packaging very difficult. Is there any specific reason for the current approach?</p>",
        "id": 524783880,
        "sender_full_name": "Yanning Chen (LightQuantum)",
        "timestamp": 1750280816
    },
    {
        "content": "<p>I opened a PR and fixed the original issue. Nevertheless, Lean's CMake build script could be improved.</p>",
        "id": 524792495,
        "sender_full_name": "Yanning Chen (LightQuantum)",
        "timestamp": 1750286365
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> has marked this topic as resolved.</p>",
        "id": 524945624,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750365608
    }
]