[
    {
        "content": "<p>I have a project that has branches that live between versions. E.g. in one the <code>lakefile.toml</code> contains</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"batteries\"</span>\n<span class=\"w\">  </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n</code></pre></div>\n<p>and in the other</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"batteries\"</span>\n<span class=\"w\">  </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.23.0-rc2\"</span>\n</code></pre></div>\n<p>I'm having trouble switching between the two without pain; what steps should I be running? If I go from the latter to the former and do <code>lake clean &amp;&amp; lake update &amp;&amp; lake build</code>, the last step fails with (among many others)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=/</span><span class=\"n\">workplace</span><span class=\"bp\">/</span><span class=\"n\">codyroux</span><span class=\"bp\">/</span><span class=\"n\">plausible</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"bp\">/</span><span class=\"n\">workplace</span><span class=\"bp\">/</span><span class=\"n\">codyroux</span><span class=\"bp\">/</span><span class=\"n\">plausible</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"kn\">local</span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">codyroux</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.23.0-rc2/bin/lean /workplace/codyroux/plausible/.lake/packages/batteries/Batteries/Data/Rat/Float.lean -o /workplace/codyroux/plausible/.lake/packages/batteries/.lake/build/lib/lean/Batteries/Data/Rat/Float.olean -i /workplace/codyroux/plausible/.lake/packages/batteries/.lake/build/lib/lean/Batteries/Data/Rat/Float.ilean -c /workplace/codyroux/plausible/.lake/packages/batteries/.lake/build/ir/Batteries/Data/Rat/Float.c --setup /workplace/codyroux/plausible/.lake/packages/batteries/.lake/build/ir/Batteries/Data/Rat/Float.setup.json --json</span>\n<span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Rat</span><span class=\"bp\">/</span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">provide</span><span class=\"w\"> </span><span class=\"n\">concrete</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">semi</span><span class=\"bp\">-</span><span class=\"o\">)</span><span class=\"n\">out</span><span class=\"bp\">-</span><span class=\"n\">params</span>\n<span class=\"w\">  </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">Rat</span><span class=\"w\"> </span><span class=\"n\">Float</span>\n</code></pre></div>\n<p>which suggests that there's a mismatch between the lean <code>Std</code> and <code>Batteries</code>.</p>\n<p>What <em>should</em> I be doing? Why is this error occurring?</p>",
        "id": 542137715,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759179208
    },
    {
        "content": "<p>Running <code>lake update</code> on the branch that points to batteries at <code>main</code> will cause it update the version of batteries used to the latest <code>main</code>.</p>",
        "id": 542138003,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759179291
    },
    {
        "content": "<p>Ideally, all you should need to run is <code>lake build</code> when swtiching between branches. Lake should be smart enough to checkout the right versions of dependencies and rebuild the changed files.</p>",
        "id": 542138466,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759179447
    },
    {
        "content": "<p>So how could I possibly be getting the error above?</p>",
        "id": 542138992,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759179647
    },
    {
        "content": "<p>Let me clarify: the issue is that the wrong version of lean is being used; and that's very likely the culprit.</p>\n<p>but <code>lake-toolchain</code> is correctly showing <code>v4.24.0-rc1</code>!</p>",
        "id": 542139431,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759179809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116028\">Cody Roux</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.3A.20bouncing.20between.20versions/near/542139431\">said</a>:</p>\n<blockquote>\n<p>Let me clarify: the issue is that the wrong version of lean is being used; and that's very likely the culprit.</p>\n</blockquote>\n<p>I am confused. What makes you htink the wrong version of Lean is being used? I don't see anything in the error message you posted that suggests that. Do you have more information?</p>",
        "id": 542140653,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759180194
    },
    {
        "content": "<p>ooooh; shucks; I figured it out: there was a <code>elan override</code> active I had forgotten about.</p>",
        "id": 542140660,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759180197
    },
    {
        "content": "<p>(I updated the error message, the version being used was <code>4.23.x</code>)</p>",
        "id": 542140717,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759180220
    },
    {
        "content": "<p>on a slightly different note, I'm a little disturbed that <code>lean update</code> smashes the <code>lean-toolchain</code> file; is that reasonable?</p>",
        "id": 542140975,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759180305
    },
    {
        "content": "<p>This is considered a feature, not a bug :)</p>",
        "id": 542147881,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1759183669
    },
    {
        "content": "<p>I guess I get it. Made my first attempt at backporting quite confusing, though :)</p>",
        "id": 542148619,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759184151
    },
    {
        "content": "<p><del>(I also note that <code>--keep-toolchain</code> doesn't seem to appear in the <code>--help</code> docs)</del></p>",
        "id": 542148713,
        "sender_full_name": "Cody Roux",
        "timestamp": 1759184218
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.3A.20bouncing.20between.20versions/near/542147881\">said</a>:</p>\n<blockquote>\n<p>This is considered a feature, not a bug :)</p>\n</blockquote>\n<p>is there any way to turn off that \"feature\" if we don't want it? e.g. if you want to use a specific lean version and add a dependency, how do you fetch the dependency without lake changing the lean version?</p>",
        "id": 546841786,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1761295126
    },
    {
        "content": "<p>You cannot do this, unless the dependency also has the same lean version. If you are in this later case, you can write <code>rev = commithashhere</code> under the corresponding entry in the lakefile, where <code>commithashhere</code> refers to a commit of the dependency that is on the same lean version as the rest of your project</p>",
        "id": 546842392,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1761295320
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315434\">Andrés Goens</span> <a href=\"#narrow/channel/270676-lean4/topic/lake.3A.20bouncing.20between.20versions/near/546841786\">said</a>:</p>\n<blockquote>\n<p>e.g. if you want to use a specific lean version and add a dependency, how do you fetch the dependency without lake changing the lean version?</p>\n</blockquote>\n<p><code>lake update --keep-toolchain</code></p>",
        "id": 546955080,
        "sender_full_name": "Mac Malone",
        "timestamp": 1761329711
    },
    {
        "content": "<p>Better than specifying a SHA in the <code>rev</code> field is to specify a tag. Many projects in the Lean ecosystem add tag of the form <code>v4.X.0</code> when they first move to that toolchain.</p>",
        "id": 547032708,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761373179
    }
]