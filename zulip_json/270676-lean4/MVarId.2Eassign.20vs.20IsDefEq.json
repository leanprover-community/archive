[
    {
        "content": "<p>The docstring for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assign#doc\">docs#Lean.MVarId.assign</a> suggest to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.isDefEq#doc\">docs#Lean.Meta.isDefEq</a> instead. However, this doesn't have the same behavior for me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Simp</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"abstract\"</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"o\">:</span><span class=\"n\">ppDedent</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainTarget</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newGoal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">target</span>\n<span class=\"w\">  </span><span class=\"n\">setGoals</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">newGoal</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tacs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newGoal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">newGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newMVars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVars</span><span class=\"w\"> </span><span class=\"n\">newGoal</span>\n<span class=\"w\">  </span><span class=\"c1\">-- _ ← goal.assign newGoal -- uncomment this line and the kernel error disappears</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkMVar</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">newGoal</span>\n<span class=\"w\">  </span><span class=\"n\">setGoals</span><span class=\"w\"> </span><span class=\"n\">newMVars</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: unsolved goals</span>\n<span class=\"sd\">case left</span>\n<span class=\"sd\">f : True ∧ True → Nat</span>\n<span class=\"sd\">n : Nat</span>\n<span class=\"sd\">⊢ True</span>\n\n<span class=\"sd\">case right</span>\n<span class=\"sd\">f : True ∧ True → Nat</span>\n<span class=\"sd\">n : Nat</span>\n<span class=\"sd\">⊢ True</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">error: (kernel) declaration has metavariables '_example'</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">abstract</span><span class=\"w\"> </span><span class=\"n\">constructor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The <code>isDefEq</code> generates a kernel error, while the <code>assign</code> doesn't. What causes the difference? Am I doing something wrong? (This is a bare-bones version of <a href=\"https://github.com/leanprover-community/mathlib4/pull/22296\">#22296</a>, and I think I can safely use <code>assign</code> in this case.)</p>",
        "id": 502095906,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740588708
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 502097069,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740588998
    },
    {
        "content": "<p><code>isDefEq</code> does not assign synthetic opaque metavariables, so it is resolved with proof irrelevance.</p>",
        "id": 502097806,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1740589199
    },
    {
        "content": "<p><code>withAssignableSyntheticOpaque &lt;| isDefEq </code> indeed makes it work</p>",
        "id": 502098060,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740589249
    },
    {
        "content": "<p>What I usually see is doing <code>isDefEq</code> on the types, and then using <code>MVarId.assign</code> if that succeeds. The batteries function <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assignIfDefeq#doc\">docs#Lean.MVarId.assignIfDefeq</a> does this for you.</p>\n<p><code>MVarId.assign</code> does no checking of anything (not even occurs checks), and I think it probably shouldn't be used by metaprogrammers.</p>",
        "id": 502109569,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740592631
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/MVarId.2Eassign.20vs.20IsDefEq/near/502097806\">said</a>:</p>\n<blockquote>\n<p><code>isDefEq</code> does not assign synthetic opaque metavariables, so it is resolved with proof irrelevance.</p>\n</blockquote>\n<p>Thanks!</p>\n<p>Is there already a place where I can learn what the different kinds metavariables are, so that I can learn what this means? (The reference manual currently doesn't, but I just opened <a href=\"https://github.com/leanprover/reference-manual/pull/329\">leanprover/reference-manual#329</a> asking for it.)</p>",
        "id": 502171200,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740616179
    },
    {
        "content": "<p>There's at least the docstring to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarKind#doc\">docs#Lean.MetavarKind</a></p>\n<p>Synthetic mvars have a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.SyntheticMVarKind#doc\">docs#Lean.Elab.Term.SyntheticMVarKind</a> entry</p>\n<p>Synthetic opaque metavariables are generally used for goals. They exist because unification/elaboration might otherwise solve for a goal metavariable using an unassigned non-goal metavariable, causing the goal to disappear from the goal list.</p>",
        "id": 502173042,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740617280
    }
]