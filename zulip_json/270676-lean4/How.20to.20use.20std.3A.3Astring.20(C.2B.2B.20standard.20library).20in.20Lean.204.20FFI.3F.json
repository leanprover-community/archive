[
    {
        "content": "<p>I am trying to write a string processing function in c++ via lean 4 FFI.  But I got link errors when using <code>lake</code>. I asked a question in <a href=\"https://proofassistants.stackexchange.com/questions/4806\">PA.SE</a>, and was referred to here. Below are the main parts of my question, and any help is appreciated.</p>\n<p>I wanted to use the C++ <code>std::string</code> and its supporting functions in the C++ standard library (C++1x or C++20) in it.</p>\n<p>I re-used the <a href=\"https://github.com/leanprover/lean4/blob/master/src/lake/examples/ffi\">ffi example</a> in the Lean documentation, and added a (empty) <code>reverseString/c_reverse_string</code> function. </p>\n<p><code>lib/FFI/Add.lean</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>@[extern &quot;my_add&quot;]\nopaque myAdd : UInt32 → UInt32 → UInt32\n\n@[extern &quot;c_reverse_string&quot;]\nopaque reverseString (s : @&amp; String) : IO String\n</code></pre></div>\n\n<p><code>lib/c/ffi.cpp</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>#include &lt;lean/lean.h&gt;\n#include &lt;string&gt;\n\nextern &quot;C&quot; uint32_t my_add(uint32_t a, uint32_t b) {\n    return a + b;\n}\n\nextern &quot;C&quot; LEAN_EXPORT lean_obj_res c_reverse_string(lean_obj_arg s) {\n    std::string ss = &quot;hi&quot;;\n    lean_obj_res result = lean_mk_string(ss.c_str());\n    return lean_io_result_mk_ok(result);\n}\n//...\n</code></pre></div>\n\n<p>Note that I used <code>std::string</code> trivially in the c++ function. But the use of <code>std::string</code> here seems to cause link errors when building the project:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ lake -d lib build -v\n...\nℹ [17/18] Built Main:c.o (with exports)\ntrace: .&gt; /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/bin/clang -c -o lib/./.lake/build/ir/Main.c.o.export lib/./.lake/build/ir/Main.c -I /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/include -fstack-clash-protection -fwrapv -fPIC -fvisibility=hidden -Wno-unused-command-line-argument --sysroot /home/.../.elan/toolchains/leanprover--lean4---v4.16.0 -nostdinc -isystem /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/include/clang -O3 -DNDEBUG -DLEAN_EXPORTING\n✖ [18/18] Building test\ntrace: .&gt; /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/bin/clang -o lib/./.lake/build/bin/test lib/./.lake/build/ir/Main.c.o.export lib/./.lake/build/ir/FFI/Fn.c.o.export lib/./.lake/build/ir/FFI/Add.c.o.export lib/./.lake/build/ir/FFI.c.o.export lib/./.lake/build/lib/libleanffi.a --sysroot /home/.../.elan/toolchains/leanprover--lean4---v4.16.0 -L /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/lib -L /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc/libc_nonshared.a /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc/libpthread_nonshared.a -Wl,--as-needed -Wl,-Bstatic -lgmp -lunwind -luv -Wl,-Bdynamic -Wl,--no-as-needed -fuse-ld=lld -L /home/.../.elan/toolchains/leanprover--lean4---v4.16.0/lib/lean -Wl,--start-group -lleancpp -lLean -Wl,--end-group -lStd -Wl,--start-group -lInit -lleanrt -Wl,--end-group -Wl,-Bstatic -lc++ -lc++abi -Wl,-Bdynamic -lLake -Wl,--as-needed -lgmp -luv -lpthread -ldl -lrt -Wl,--no-as-needed -lm -ldl -pthread\ninfo: stderr:\nld.lld: error: undefined symbol: std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt;&gt;::c_str() const\n&gt;&gt;&gt; referenced by ffi.cpp\n&gt;&gt;&gt;               ffi.o:(c_reverse_string) in archive lib/./.lake/build/lib/libleanffi.a\n\nld.lld: error: undefined symbol: std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt;&gt;::~basic_string()\n&gt;&gt;&gt; referenced by ffi.cpp\n...\n</code></pre></div>\n\n<p>The <code>lakefile.lean</code> is:</p>\n<div class=\"codehilite\"><pre><span></span><code>import Lake\nopen System Lake DSL\n\npackage ffi where\n  srcDir := &quot;lean&quot;\n\nlean_lib FFI where\n  precompileModules := true\n\n@[default_target]\nlean_exe test where\n  root := `Main\n\ntarget ffi.o pkg : FilePath := do\n  let oFile := pkg.buildDir / &quot;c&quot; / &quot;ffi.o&quot;\n  let srcJob ← inputTextFile &lt;| pkg.dir / &quot;c&quot; / &quot;ffi.cpp&quot;\n  let weakArgs := #[&quot;-I&quot;, (← getLeanIncludeDir).toString]\n  buildO oFile srcJob weakArgs #[&quot;-fPIC&quot;] &quot;c++&quot; getLeanTrace\n\nextern_lib libleanffi pkg := do\n  let ffiO ← ffi.o.fetch\n  let name := nameToStaticLib &quot;leanffi&quot;\n  buildStaticLib (pkg.nativeLibDir / name) #[ffiO]\n</code></pre></div>\n\n<p>My questions are:</p>\n<p><em>How can I properly link C++ standard library (e.g. std::string) in a lakefile by fixing either example above?</em></p>\n<p>Also, I am new to writing lakefile.lean, and I was wondering how to add a second <code>.cpp</code> source file (in addition to <code>ffi.cpp</code>), so that I can put my new functions in separate files.</p>\n<p>(This is  under Ubuntu 24.04, lean 4 v4.16.0)</p>",
        "id": 504214368,
        "sender_full_name": "T L",
        "timestamp": 1741395926
    },
    {
        "content": "<p>You can try specifying LEAN_CC env var to gcc/clang/g++/clang++ (when running lake build). You can also try adding -lstdc++ or -lc++ to moreLinkArgs instead. I think both worked for me in different projects.</p>\n<p>See also:<br>\n<a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20FFI.20to.20C.2B.2B.3A.20GiNaC\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/.E2.9C.94.20FFI.20to.20C.2B.2B.3A.20GiNaC</a></p>",
        "id": 504258339,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1741427104
    },
    {
        "content": "<p>Thanks! I tried using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-lstdc++\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-lc++\"</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>in <code>lib/lean/lakefile.lean</code>. Then I got a different error when running ./test.sh:</p>\n<blockquote>\n<p>✖ [14/19] Building FFI<br>\ntrace: .&gt; LEAN_PATH=app/././../lib/.lake/build/lib:app/./.lake/build/lib LD_LIBRARY_PATH=app/././../lib/.lake/build/lib:app/././../lib/.lake/build/lib /home/.../.elan/toolchains/leanprover--lean4---v4.17.0/bin/lean app/././../lib/lean/./FFI.lean -R app/././../lib/lean/. -o app/././../lib/.lake/build/lib/FFI.olean -i app/././../lib/.lake/build/lib/FFI.ilean -c app/././../lib/.lake/build/ir/FFI.c --load-dynlib=app/././../lib/.lake/build/lib/libleanffi.so --load-dynlib=app/././../lib/.lake/build/lib/libFFI-Fn-1.so --load-dynlib=app/././../lib/.lake/build/lib/libFFI-Add-1.so --json<br>\ninfo: stderr:<br>\nlibc++abi: terminating due to uncaught exception of type lean::exception: error loading library, libc++.so.1: cannot open shared object file: No such file or directory</p>\n</blockquote>\n<p>It seems I can manually fix the output command by inserting <code>--load-dynlib=${HOME}/.elan/toolchains/leanprover--lean4---v4.17.0/lib/libc++.so.1</code> before the first <code>--load-dynlib=...</code>. But I am not sure how to specific the location of <code>libc++.so.1</code> in one of the two <code>lakefile.lean</code>.  Any suggestion on how to let lean find the <code>.so</code> for the c++ standard library?</p>",
        "id": 504383533,
        "sender_full_name": "T L",
        "timestamp": 1741519862
    },
    {
        "content": "<p>That should be simple as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-L/path/to/lib/dir\"</span><span class=\"o\">,</span><span class=\"s2\">\"-lstdc++\"</span><span class=\"o\">,</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>You just need to find the right directory on your system.</p>",
        "id": 504399839,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741531378
    },
    {
        "content": "<p>no, that does not seem to address the problem.<br>\nI added <code>moreLinkArgs := #[\"-L/home/.../.elan/toolchains/leanprover--lean4---v4.17.0/lib/libc++.so.1\", \"-lstdc++\", \"-lc++\"]</code> to both the <code>lib/</code> and <code>app/</code> lakefile.lean, and got the same error.</p>",
        "id": 504409087,
        "sender_full_name": "T L",
        "timestamp": 1741537960
    },
    {
        "content": "<p>For completeness, here is the slightly adapted ffi test from the lean v4.17.0 source:</p>\n<p><a href=\"/user_uploads/3121/n2wIYoZGuLUg8Ihb83S5i-PW/ffi_lean4-reverse_string.tgz\">ffi_lean4-reverse_string.tgz</a></p>\n<p>The only addition is the <code>reverseString</code> function and its C++ backend using <code>std::string</code>.  Any help on fixing the two <code>lakefile.lean</code> is appreciated.</p>",
        "id": 504437049,
        "sender_full_name": "T L",
        "timestamp": 1741558301
    }
]