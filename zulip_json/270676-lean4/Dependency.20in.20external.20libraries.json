[
    {
        "content": "<p>If a Lean library depends on an <code>extern_lib</code>, and the <code>extern_lib</code> links to other system libraries, how can I ensure the linker can link to these libraries? I have a setup like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">libmystery</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">leanRoot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getBuildDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cargo\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"build\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--release\"</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[(</span><span class=\"s2\">\"LEAN_ROOT\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">leanRoot</span><span class=\"o\">)],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"mystery\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"target\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"release\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDirAll</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">staticLibDir</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">staticLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeBinFile</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readBinFile</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">mystery</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n</code></pre></div>\n<p>and when I build this, it prints <code>ld.lld: error: undefined symbol ...</code> for the external libraries linked with <code>libmystery</code>.</p>",
        "id": 532495321,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1754175827
    },
    {
        "content": "<p>I think there are two ways to approach this:</p>\n<ol>\n<li>I see you're using Rust. You can have a create that has type <code>cdylib</code> so that you're producing a dynamic library, then use lake's support for linking shared libraries and it should just work.</li>\n<li>If all of the external library dependencies come from your crate dependencies, then it's very likely these crates have feature flags you can toggle on to build and link against a static library copy instead of linking against the dynamic library on your system.</li>\n</ol>",
        "id": 532513776,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754193632
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"766285\">Gavin Zhao</span> <a href=\"#narrow/channel/270676-lean4/topic/Dependency.20in.20external.20libraries/near/532513776\">said</a>:</p>\n<blockquote>\n<p>I think there are two ways to approach this:</p>\n<ol>\n<li>I see you're using Rust. You can have a create that has type <code>cdylib</code> so that you're producing a dynamic library, then use lake's support for linking shared libraries and it should just work.</li>\n<li>If all of the external library dependencies come from your crate dependencies, then it's very likely these crates have feature flags you can toggle on to build and link against a static library copy instead of linking against the dynamic library on your system.</li>\n</ol>\n</blockquote>\n<p>so instead of <code>pkg.staticLibDir</code> I just use <code>pkg.sharedLibDir</code>?</p>",
        "id": 532516403,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1754195893
    },
    {
        "content": "<p>More than that. I assume you want to go with 1? Then, you also need to c<a href=\"https://doc.rust-lang.org/cargo/reference/cargo-targets.html#library\">hange your Rust crate type to <code>cdylib</code></a> to produce a shared library. Then, your snippet should become:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">libmystery</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">leanRoot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getBuildDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cargo\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"build\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--release\"</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[(</span><span class=\"s2\">\"LEAN_ROOT\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">leanRoot</span><span class=\"o\">)],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToSharedLib</span><span class=\"w\"> </span><span class=\"s2\">\"mystery\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"target\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"release\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"c1\">-- check if this is actually the path</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDirAll</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeBinFile</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readBinFile</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">dstPath</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 532516844,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754196284
    },
    {
        "content": "<p>This <a href=\"https://docs.rust-embedded.org/book/interoperability/rust-with-c.html\">link</a> is for a different context but should help you get started. Basically the problem you're solving is how to build a dynamic/shared library from Rust.</p>",
        "id": 532517070,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754196458
    },
    {
        "content": "<p>I changed <code>crate-type = [\"cdylib\"]</code> and <code>staticLib</code> to <code>sharedLib</code> and now it all works!</p>",
        "id": 532517117,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1754196497
    },
    {
        "content": "<p>If your crate is <em>not</em> for the sole purpose of interfacing with Lean, you might want to have <code>crate-type = [\"lib\", \"cdylib\"]</code> so people can also use your crate in Rust.</p>",
        "id": 532517287,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1754196665
    }
]