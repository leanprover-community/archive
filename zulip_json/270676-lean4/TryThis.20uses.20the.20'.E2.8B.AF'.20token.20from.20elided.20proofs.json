[
    {
        "content": "<p>I was trying <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span>'s <a href=\"https://github.com/nomeata/lean-calcify\">Calcify</a> to golf <a href=\"https://github.com/teorth/equational_theories/blob/7789eca7e995abe4fbf8d99994763c496ac6fd0f/equational_theories/Completeness.lean#L195-L210\">this proof</a> in the <a class=\"stream\" data-stream-id=\"458659\" href=\"/#narrow/stream/458659-Equational\">#Equational</a> project, and it gives me some elided proofs back as <code>⋯</code>.  I presume it's a bug with <code>TryThis</code> and not <code>Calcify</code> although I wasn't sure. (Should this return the full proofs or just <code>_</code>s?)</p>\n<p>The example was just this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- FIXME: golf this!</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">FreeMagma</span><span class=\"bp\">.</span><span class=\"n\">EvalFreeMagmaWithLawsUniversalProperty</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"o\">(</span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ginst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modelsG</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">⊧</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">)(</span><span class=\"n\">ψ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"w\"> </span><span class=\"bp\">→◇</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">ψ</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟦.⟧</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Lf</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">modelsG</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ψ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">eq</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ψ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">mkMor</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">ψ</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">φ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">modelsG</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟦.⟧</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">φ'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ψ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">calcify</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">EvalFreeMagmaUniversalProperty</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">φ'</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MagmaHom</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">mkMor</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ψ'</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">liftEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>Which gives:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"k\">calc</span>\n<span class=\"w\">        </span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">evalInMagma</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">⟦</span><span class=\"n\">x</span><span class=\"bp\">⟧</span>\n<span class=\"w\">        </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">evalInMagma</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">⟦</span><span class=\"n\">x</span><span class=\"bp\">⟧</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ψ'</span><span class=\"bp\">.</span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">          </span><span class=\"n\">EvalFreeMagmaUniversalProperty</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">ψ'</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">ψ'</span><span class=\"bp\">.</span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Lf</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"o\">)))</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">id</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span>\n<span class=\"w\">                  </span><span class=\"o\">((</span><span class=\"bp\">⇑</span><span class=\"n\">ψ</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"bp\">⇑</span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">⟦</span><span class=\"n\">a</span><span class=\"bp\">⟧</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map_op'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FreeMagmaWithLaws</span><span class=\"bp\">.</span><span class=\"n\">mkMor</span><span class=\"bp\">.</span><span class=\"n\">proof_1</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">∘</span>\n<span class=\"w\">                    </span><span class=\"n\">Lf</span><span class=\"o\">))))</span>\n</code></pre></div>\n<p>Should I make an issue in core for this? Or is this a Calcify problem?</p>",
        "id": 476735567,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728899379
    },
    {
        "content": "<p>What happens if you add <code>set_option pp.proofs true</code> before calcify?</p>",
        "id": 476735884,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728899460
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> then it suggests the full proof terms correctly</p>",
        "id": 476736203,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728899525
    },
    {
        "content": "<p>So maybe this is a simple fix that could be embedded into calcify</p>",
        "id": 476736493,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728899604
    },
    {
        "content": "<p>I would think that <code>TryThis</code> should ignore (override) that option though, shouldn't it? Since the result is meant to be elaborated (or at least replace those with <code>_</code>s)</p>",
        "id": 476736541,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728899618
    },
    {
        "content": "<p>I'm not sure if it \"should\", but extract_goal also sets it's options in a similar way.</p>",
        "id": 476737272,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728899803
    },
    {
        "content": "<p>To me, it seems a feature, rather than a bug: you can get as verbose as you want, defaulting to the minimum.</p>",
        "id": 476737526,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728899874
    },
    {
        "content": "<p>This is a problem also with <code>show_term</code>, right? ( Of which <code>calcify</code> is an extension in a way.) Maybe it's worth setting this by default, although I'd prefer to see a more thorough solution to this, i.e. a delaboration mode that reliably produces elaboratable terms without including all too much information.</p>",
        "id": 476737547,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728899881
    },
    {
        "content": "<p>That's supposed to be <code>pp.analyze</code>, right?</p>",
        "id": 476737680,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1728899907
    },
    {
        "content": "<p>There could be a <code>calcify!</code> version that sets the option.</p>",
        "id": 476737755,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728899926
    },
    {
        "content": "<p>Fair enough, let me rephrase, shouldn't <code>TryThis</code> replace the <code>  ⋯  </code> tokens with <code>_</code>, if it's respecting the verbosity of pretty printing?</p>",
        "id": 476737770,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728899934
    },
    {
        "content": "<p>Right, but as I understand it isn't fully reliable. But yes, maybe I should just set that flag and deflect further complaints to that feature :-)</p>",
        "id": 476737903,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728899977
    },
    {
        "content": "<p>As is, it already isn't fully reliable, so this is definitely a fix!  <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span></p>",
        "id": 476738097,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728900017
    },
    {
        "content": "<p>I think try this already works on syntax, so it's too late there. But tools using trythis should set appropriate flags :-)</p>",
        "id": 476738115,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728900021
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/TryThis.20uses.20the.20'.E2.8B.AF'.20token.20from.20elided.20proofs/near/476737755\">said</a>:</p>\n<blockquote>\n<p>There could be a <code>calcify!</code> version that sets the option.</p>\n</blockquote>\n<p>I should write a Zulip bot that reacts with <span aria-label=\"bangbang\" class=\"emoji emoji-203c\" role=\"img\" title=\"bangbang\">:bangbang:</span> whenever someone suggests that the first variation of a tactic <code>foo</code> should be called <code>foo!</code> :-D</p>",
        "id": 476738443,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728900111
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/270676-lean4/topic/TryThis.20uses.20the.20'.E2.8B.AF'.20token.20from.20elided.20proofs/near/476738097\">said</a>:</p>\n<blockquote>\n<p>As is, it already isn't fully reliable, so this is definitely a fix!  <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span></p>\n</blockquote>\n<p>Does <code>pp.analyze</code> help in this particular case, <span class=\"user-mention\" data-user-id=\"315434\">@Andrés Goens</span>?</p>",
        "id": 476738611,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728900146
    },
    {
        "content": "<p>nope, <code>pp.analyze</code> leaves the <code>  ⋯  </code>s</p>",
        "id": 476738700,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728900173
    },
    {
        "content": "<p>(FWIW, since <code>  ⋯  </code> is elaborated as <code> _ </code> this still works, i.e. it is elaborated, but it gives a warning about it)</p>",
        "id": 476739766,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728900421
    },
    {
        "content": "<p>Is <code>pp.proofs</code> relevant?</p>",
        "id": 476746951,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728902388
    },
    {
        "content": "<p>Sorry, I see that was already mentioned</p>",
        "id": 476747079,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728902414
    },
    {
        "content": "<p>Since this isn't really written anywhere all in one place, here's an overview of pretty printer options that omit terms using <code>⋯</code>. (By the way, when hovering over a <code>⋯</code> in the Infoview, it tells you which option is responsible for it. Unfortunately this doesn't appear in the main \"try this\" string, but <code>show_term</code> prints it twice, and the second one is hoverable.)</p>\n<ul>\n<li><code>pp.proofs</code> (default: false). When false, any proof that isn't \"simple enough\" according to <code>pp.proofs.threshold</code> is omitted. Side note: <code>pp.proofs.type</code> gives you a type ascription if you want it.</li>\n<li><code>pp.maxSteps</code> (default: 5000). Once the pretty printer elaborates more than maxSteps expressions, terms start being omitted. This is a safeguard against extremely large terms overwhelming the Infoview.</li>\n<li><code>pp.deepTerms</code> (default: false). When false, deep terms are omitted. \"Depth\" means elaboration recursion depth. The definition of deep is controlled by <code>pp.deepTerms.threshold</code>. There is a heuristic where \"shallow\" terms still get pretty printed, a notion also controlled by this threshold, which helps things like numeric literals still pretty print despite the actual expression exceeding the depth limit.</li>\n</ul>",
        "id": 476815354,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728921291
    },
    {
        "content": "<p>For <code>show_term</code>'s \"try this\" suggestion, it seems to me that maxSteps and deepTerms should still be enabled, and it should be able to warn you when they've been activated. This is easy, since these options install OmissionInfo into the infotrees.</p>",
        "id": 476815365,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728921296
    },
    {
        "content": "<p>For <code>pp.proofs</code>, it's less clear to me what the correct thing to do is, and how it should interact with <code>pp.analysis</code>. I think <code>pp.analysis</code> should respect <code>pp.proofs</code>.</p>\n<p>Something that's come to mind is that <code>show_term</code> should set <code>pp.proofs</code> to <code>true</code> and <code>pp.analysis</code> to <code>true</code>, and then <code>pp.analysis</code> could try to omit proofs itself with <code>_</code> if they can be inferred from other arguments.</p>",
        "id": 476815367,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728921297
    }
]