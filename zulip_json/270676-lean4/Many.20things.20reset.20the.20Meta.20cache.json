[
    {
        "content": "<p>Lean keeps some cache in the <code>MetaM</code> and <code>CoreM</code> monads. In particular, results of type class search and <code>whnf</code> are cached. The function <code>modifyEnv</code>/<code>setEnv</code> clears this cache. There are many places calling <code>modifyEnv</code> where it is unneccessary to reset the cache. Examples include</p>\n<ul>\n<li>passing an argument to <code>simp</code> (because <code>isRflProof</code> calls <code>modifyEnv</code>)</li>\n<li>passing a configuration option to a tactic (e.g. <code>simp +zeta</code>) (because elaborating a structure <code>{ zeta := true }</code> calls <code>modifyEnv</code> because it looks up information about the structur in the environment)</li>\n</ul>\n<p>Here is some code demonstrating this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> Uncomment any of the lines of code, and observa that it resets the cache. -/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- evalTactic &lt;| ← `(tactic| simp [iff_self])</span>\n<span class=\"w\">  </span><span class=\"c1\">-- evalTactic &lt;| ← `(tactic| simp +zeta)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- evalTactic &lt;| ← `(tactic| simp only)</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- _ ← Term.elabTerm (← `({})) (Expr.const ``Simp.Config [])</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- recordExtraModUseFromDecl (isMeta := true) ``Simp.Config</span>\n<span class=\"w\">  </span><span class=\"c1\">-- _ ← computeStructureResolutionOrder ``Simp.Config true</span>\n<span class=\"w\">  </span><span class=\"c1\">-- _ ← isRflProof &lt;| mkConst ``iff_self</span>\n<span class=\"w\">  </span><span class=\"c1\">-- _ ← withoutExporting do return</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">trace: [Meta.synthInstance] ✅️ Mul α</span>\n<span class=\"sd\">  [Meta.synthInstance] result inst✝ (cached)</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">warning: declaration uses 'sorry'</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">test</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 555593433,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763128496
    },
    {
        "content": "<p>I made a testing PR to Lean that liberally avoids resetting the cache, and the result is a 2% speedup in Mathlib, which can be seen here: <a href=\"https://speed.lean-lang.org/mathlib4/compare/d26e9feb-7b9e-4568-ab85-cadd2c20d0f7/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=eff2dfbcb624fa536176b4b688e158695bc48671\">https://speed.lean-lang.org/mathlib4/compare/d26e9feb-7b9e-4568-ab85-cadd2c20d0f7/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=eff2dfbcb624fa536176b4b688e158695bc48671</a></p>",
        "id": 555593596,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763128532
    },
    {
        "content": "<p>including a 7.5% reduction in type-class resolution time!</p>",
        "id": 555594260,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1763128682
    }
]