[
    {
        "content": "<p>There's an in-progress mathlib linter (<a href=\"https://github.com/leanprover-community/mathlib4/pull/14378\">#14378</a>) which warns when a section or namespace is not closed at the end of the current file. Reviewing the implementation, I found that <code>Scope</code> is mostly undocumented. Would a PR adding documentation be welcome?</p>\n<p>Is the following roughly correct? Let me know if you have any corrections, or if some of this is an implementation detail you prefer not to mention or guarantee.</p>",
        "id": 450522583,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720634149
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">A `Scope` gathers context information which is inherently scoped: this contains</span>\n<span class=\"sd\">the current namespace and information about `open`, `universe` or `variable` declarations.</span>\n<span class=\"sd\">There is always a base scope; scopes can be nested.</span>\n\n<span class=\"sd\">`universe`, `open` and `variable` declarations only modify the current scope</span>\n<span class=\"sd\">(and all scopes nested below it): these declarations usually *append* to the context in the current scope; `variable` statements can also change existing items.</span>\n<span class=\"sd\">(xxx Is shadowing possible? If so, this should be reworded.)</span>\n<span class=\"sd\">Unclosed scopes are automatically closed at the end of the current module.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Scope</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">header</span><span class=\"w\">        </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">opts</span><span class=\"w\">          </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The current namespace: by default, this is an anonymous namespace -/</span>\n<span class=\"w\">  </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- All currently `open`ed namespaces</span>\n<span class=\"sd\">  openDecls     : List OpenDecl := []</span>\n<span class=\"sd\">  /-- All universe levels declared in the current scope -/</span>\n<span class=\"w\">  </span><span class=\"n\">levelNames</span><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- All variable binders in the current scope -/</span>\n<span class=\"w\">  </span><span class=\"n\">varDecls</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``Parser.Term.bracketedBinder</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Globally unique internal identifiers for the `varDecls` -/</span>\n<span class=\"w\">  </span><span class=\"n\">varUIds</span><span class=\"w\">       </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- noncomputable sections automatically add the `noncomputable` modifier to any declaration we cannot generate code for. -/</span>\n<span class=\"w\">  </span><span class=\"n\">isNoncomputable</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n</code></pre></div>",
        "id": 450522680,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720634177
    },
    {
        "content": "<p>Some other details I found worth documenting</p>\n<ul>\n<li>the base scope is always the last one in <code>getScopes</code></li>\n<li>noncomputability is inherited: scopes below a noncomputable scope remain noncomputable</li>\n</ul>\n<p>If there are not implementation details, I can also document them.</p>",
        "id": 450522908,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720634271
    },
    {
        "content": "<p>I didn't find anybody listed in CODEOWNERS for <code>Lean/Elab/Command</code>. <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> You made most recent changes to this module; would you like to comment? Should I ask somebody else instead?</p>",
        "id": 450523100,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720634332
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/270676-lean4/topic/Documenting.20.60Scope.60/near/450522680\">said</a>:</p>\n<blockquote>\n<p>/--<br>\nA <code>Scope</code> gathers context information which is inherently scoped: this contains<br>\nthe current namespace and information about <code>open</code>, <code>universe</code> or <code>variable</code> declarations.<br>\nThere is always a base scope; scopes can be nested.</p>\n<p><code>universe</code>, <code>open</code> and <code>variable</code> declarations only modify the current scope<br>\n(and all scopes nested below it), by appending to it. (Is shadowing possible? If so, this should be reworded.)<br>\nUnclosed scopes are automatically closed at the end of the current module.<br>\n-/<br>\nstructure Scope where<br>\n  header        : String<br>\n  opts          : Options := {}<br>\n  /-- The current namespace: by default, this is an anonymous namespace -/<br>\n  currNamespace : Name := Name.anonymous<br>\n  /-- All currently <code>open</code>ed namespaces<br>\n  openDecls     : List OpenDecl := []<br>\n  /-- All universe levels declared in the current scope -/<br>\n  levelNames    : List Name := []<br>\n  /-- All variable binders in the current scope -/<br>\n  varDecls      : Array (TSyntax <code>`Parser.Term.bracketedBinder) := #[]\n  /-- Globally unique internal identifiers for the </code>varDecls<code> -/\n  varUIds       : Array Name := #[]\n  /-- noncomputable sections automatically add the </code>noncomputable` modifier to any declaration we cannot generate code for. -/<br>\n  isNoncomputable : Bool := false<br>\n  deriving Inhabited</p>\n</blockquote>\n<p>Thanks! I find this documentation very useful and well-done, so I'd be all in favour to adding it. Perhaps the sentence \"...only modify the current scope (...) by appending to it\" can be clarified a bit more?</p>",
        "id": 450527504,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1720635560
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/stream/270676-lean4/topic/Documenting.20.60Scope.60/near/450527504\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/270676-lean4/topic/Documenting.20.60Scope.60/near/450522680\">said</a>:</p>\n<blockquote>\n<p>/--<br>\nA <code>Scope</code> gathers context information which is inherently scoped: this contains<br>\nthe current namespace and information about <code>open</code>, <code>universe</code> or <code>variable</code> declarations.<br>\nThere is always a base scope; scopes can be nested.</p>\n<p><code>universe</code>, <code>open</code> and <code>variable</code> declarations only modify the current scope<br>\n(and all scopes nested below it), by appending to it. (Is shadowing possible? If so, this should be reworded.)<br>\nUnclosed scopes are automatically closed at the end of the current module.<br>\n-/<br>\nstructure Scope where<br>\n  header        : String<br>\n  opts          : Options := {}<br>\n  /-- The current namespace: by default, this is an anonymous namespace -/<br>\n  currNamespace : Name := Name.anonymous<br>\n  /-- All currently <code>open</code>ed namespaces<br>\n  openDecls     : List OpenDecl := []<br>\n  /-- All universe levels declared in the current scope -/<br>\n  levelNames    : List Name := []<br>\n  /-- All variable binders in the current scope -/<br>\n  varDecls      : Array (TSyntax <code>`Parser.Term.bracketedBinder) := #[]\n  /-- Globally unique internal identifiers for the </code>varDecls<code> -/\n  varUIds       : Array Name := #[]\n  /-- noncomputable sections automatically add the </code>noncomputable` modifier to any declaration we cannot generate code for. -/<br>\n  isNoncomputable : Bool := false<br>\n  deriving Inhabited</p>\n</blockquote>\n<p>Thanks! I find this documentation very useful and well-done, so I'd be all in favour to adding it. Perhaps the sentence \"...only modify the current scope (...) by appending to it\" can be clarified a bit more?</p>\n</blockquote>\n<p>I edited that sentence, hopefully it's clearer now.</p>",
        "id": 450528318,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720635770
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> If you create a Lean PR and ping me, I'll fact check it carefully and make sure it gets in. We're happy to receive high-quality docstring PRs!</p>",
        "id": 450585099,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720652353
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thank you for the encouragement! I just submitted <a href=\"https://github.com/leanprover/lean4/pull/4748\">lean#4748</a> with this change.</p>",
        "id": 451520912,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721055551
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/4748\">lean#4748</a></p>",
        "id": 451828465,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721153939
    }
]