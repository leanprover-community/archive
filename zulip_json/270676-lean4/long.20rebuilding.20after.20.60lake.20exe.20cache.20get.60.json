[
    {
        "content": "<p>On <a href=\"https://github.com/leanprover-community/mathlib4/pull/21567\">#21567</a>, I'm told I need to run <code>shake</code>. To do this, I'd like to get the cache first, so that I don't have to wait to build mathlib on my own computer. But it seems I am not getting the cache for the build of my branch, since when I <code>lake build</code> afterwards, it has thousands of files left to go.</p>\n<ul>\n<li>When my code compiles, but the CI Build check fails due to a shake problem, does a cache get created?</li>\n<li>If not, could it be made to?</li>\n<li>In general, is there a way of seeing what cache was pulled / am I misinterpreting things here?</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">~/</span><span class=\"n\">Desktop</span><span class=\"bp\">/</span><span class=\"n\">mathlibcontribution</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">BoltonBailey</span><span class=\"bp\">/</span><span class=\"n\">split</span><span class=\"bp\">-</span><span class=\"n\">set</span><span class=\"bp\">-</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"bp\">...............</span><span class=\"w\"> </span><span class=\"n\">INT</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"mi\">27</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"o\">:</span><span class=\"mi\">32</span>\n<span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span>\n<span class=\"n\">Decompressing</span><span class=\"w\"> </span><span class=\"mi\">6048</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Unpacked</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">438</span><span class=\"w\"> </span><span class=\"n\">ms</span>\n<span class=\"n\">Completed</span><span class=\"w\"> </span><span class=\"n\">successfully!</span><span class=\"w\">                                                                             </span><span class=\"bp\">/</span><span class=\"mf\">1.7</span><span class=\"n\">s</span>\n\n<span class=\"bp\">~/</span><span class=\"n\">Desktop</span><span class=\"bp\">/</span><span class=\"n\">mathlibcontribution</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">BoltonBailey</span><span class=\"bp\">/</span><span class=\"n\">split</span><span class=\"bp\">-</span><span class=\"n\">set</span><span class=\"bp\">-</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"bp\">..........................</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"o\">:</span><span class=\"mi\">42</span>\n<span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"bp\">â£Ÿ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1955</span><span class=\"bp\">/</span><span class=\"mi\">6059</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">Lattice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"n\">C</span><span class=\"w\">                                  </span><span class=\"bp\">/</span><span class=\"mf\">7.5</span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 498479960,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1739001354
    },
    {
        "content": "<p>The cache should have been uploaded as soon as the earlier build step finished, whether it was successful or not.</p>",
        "id": 498480838,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739002175
    },
    {
        "content": "<p>Have you tried removing the <code>.lake</code> dir (or just the trace for Import graph.imports) and download the cache again?</p>",
        "id": 498480901,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739002214
    },
    {
        "content": "<p>I would be reluctant to remove <code>.lake</code>, since it would require recloning all the dependencies, and I have been having problems doing that consistently. By now it rebuilt on my laptop, but I can try this next time it happens though, thanks.</p>",
        "id": 498482277,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1739003610
    },
    {
        "content": "<p>My first try would be <code>lake exe cache get!</code> with exclamation mark</p>",
        "id": 498486159,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1739007144
    },
    {
        "content": "<p>My first try would be removing <code>.lake</code>, it currently has a high chance of fixing everything in my experience. If this is causing you problems then this sounds like a separate question.</p>",
        "id": 498486749,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739007688
    },
    {
        "content": "<p>If you'd like to help with testing, there are two commands you can try:</p>\n<p>1) <code>rm .lake/packages/importGraph/.lake/build/lib/ImportGraph/Imports.trace</code><br>\n2) <code>for file in `grep -Rl \"simp\\?.*says\" Mathlib`; do rm -v .lake/build/lib/${file%.lean}.trace; done</code></p>\n<p>Ideally, you'd run <code>lake exe cache get</code>and <code>lake build</code> after each of the two commands, to see if it was useful. Thanks!</p>",
        "id": 498496998,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1739016828
    },
    {
        "content": "<p>If neither works, please back up <code>.lake</code> and upload it somewhere, and please mention the exact mathlib commit you're testing. Deleting <code>.lake</code>afterwards is fine, but fixing the underlying bug is much harder if everyone just goes for the quick workaround!</p>",
        "id": 498497510,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1739017207
    },
    {
        "content": "<p>Yes, sorry, I'd love to get to the bottom of it, but it wasn't my priority last night and to my ironic frustration, <code>lake exe cache get ; lake build</code> now works fine.</p>",
        "id": 498515133,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1739031869
    }
]