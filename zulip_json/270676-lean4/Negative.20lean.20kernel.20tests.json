[
    {
        "content": "<p>If someone is implementing an external type checker (using lean4export), are there any 'negative' tests available to use? It would be useful to have:</p>\n<ul>\n<li>Invalid lean4export files that should cause a correctly implemented checker to produce an error</li>\n<li>Lean4 files that manually call <code>Lean.addDecl</code> with invalid declarations that should fail to typecheck in the kernel</li>\n</ul>\n<p>I saw a couple of uses of 'addDecl' in the lean4 tests that produce \"error: (kernel)\" - are there more of these that I can use to help with checker testing?</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span></p>",
        "id": 507508579,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1742690759
    },
    {
        "content": "<p>I have a few in the test suite for the rust checker <a href=\"https://github.com/ammkrn/nanoda_lib/tree/master/test_resources\">here</a>, the negative ones are labelled as should_panic in the runner <a href=\"https://github.com/ammkrn/nanoda_lib/blob/master/src/tests/declar.rs\">here</a>. </p>\n<p>In some cases it can be difficult to make negative tests because it's not feasible to make the whole lean environment by hand, so you need the lean code comprising the test cases to be admissible in order to use the exporter. You can get around this to some extent by either exporting then making small modifications, or by using <code>unsafe</code> (maybe other metaprogramming would be usable here too). </p>\n<p>Off the top of my head, some other ones:</p>\n<ul>\n<li>Declarations containing undeclared universe variables (e.g. asserting a type of <code>Sort u</code> but with an empty uparams array)</li>\n<li>Declarations containing free variables or loose bound variables</li>\n<li>Expr.const items with the wrong number of levels for the corresponding declaration</li>\n<li>Expr.const items that reference a nonexistent declaration</li>\n<li>Expr.proj items with an impermissibly high index, or a name that isn't a structure.</li>\n<li>Environments trying to reuse the same declaration name</li>\n<li>Inductives with nonpositive occurrences</li>\n<li>Constructors that quantify over an impermissibly large argument</li>\n<li>Constructors for a type <code>A</code> that purport to return an element of <code>B</code></li>\n</ul>",
        "id": 507510758,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1742692632
    },
    {
        "content": "<p>We ran the nanoda ones -- I think we're still going to try to put together a few more because we noticed even if we completely nerfed all the declaration checking functions and made them do nothing, we still only had 2 of the tests fail -- so we want to be sure we've actually written something which is really doing stuff!</p>\n<p>The examples you just gave should be super helpful! (as was the rest of what you put together clearly!)</p>",
        "id": 507568947,
        "sender_full_name": "Julian Berman",
        "timestamp": 1742739221
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/channel/270676-lean4/topic/Negative.20lean.20kernel.20tests/near/507568947\">said</a>:</p>\n<blockquote>\n<p>We ran the nanoda ones -- I think we're still going to try to put together a few more because we noticed even if we completely nerfed all the declaration checking functions and made them do nothing, we still only had 2 of the tests fail</p>\n</blockquote>\n<p>If we're still talking about the nanoda ones, some of them are supposed to fail because of the way they interact with the axiom whitelist in the config file, which may or may not apply to what you're doing. IIRC the main branch of lean4export skips unsafe declarations, so if you're using any of the test source files that have unsafe items without using the forked lean4export you may be getting less out the back than expected. </p>\n<p>Let me know if I can be of assistance or potentially save you some time. Is it public yet?</p>",
        "id": 507609464,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1742766606
    },
    {
        "content": "<p>Thanks!! We're not done yet with the actual type checker (possibly by at least a few more days work, which we're doing sporadically), but what we're working on is here: <a href=\"https://github.com/Julian/rpylean\">https://github.com/Julian/rpylean</a> I suspect the next time we meet we'll probably try to collect some of these into a suite</p>",
        "id": 507615974,
        "sender_full_name": "Julian Berman",
        "timestamp": 1742771272
    },
    {
        "content": "<p>(What's there doesn't run the Nanoda suite quite yet even, I see Aaron today got one of the additional tests working, yay.)</p>",
        "id": 507616048,
        "sender_full_name": "Julian Berman",
        "timestamp": 1742771318
    }
]