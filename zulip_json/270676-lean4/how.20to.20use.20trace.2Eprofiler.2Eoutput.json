[
    {
        "content": "<p>Sorry to be so clueless. I've seen several people talking about how they're profiling stuff using <code>set_option trace.profiler.output</code> but I don't know how to get anything to work.</p>\n<p>Step 1: I put <code>set_option trace.profiler.output \"/tmp/out.json\"</code> into a file in mathlib, just above the declaration I want to profile.</p>\n<p>Step 2: I recompile in VS Code and I don't get a file called <code>/tmp/out.json</code>.</p>\n<p>Step 3: I type random stuff on the command line which I don't understand at all like <code>lake env lake build Mathlib.FieldTheory.Galois.Basic</code> and I still don't get one.</p>\n<p>Step 4: even when I do get one, I won't know what to do with it other than the fact that I'm supposed to \"use the Firefox profiler\".</p>\n<p>Sorry, I'm a long way from being a computer scientist and would really appreciate some basic instructions. I've looked at a PR to core where this stuff was being tinkered with but that didn't help me either. I also watched Sebastian's youtube video from Bonn but it just assumed that I knew the basics, which is what I'm struggling with. I'm confident I'll understand the output once it's up and running because I've looked at many mathlib traces in the past but always through piping lake output to a file and opening with a text editor (or just reading in the infoview) and I'd like to upgrade to 2024.</p>",
        "id": 486769329,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733663903
    },
    {
        "content": "<p>Probably the idea is that you upload the trace (once you get it) to <a href=\"https://profiler.firefox.com/\">https://profiler.firefox.com/</a> ?</p>",
        "id": 486769581,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733664139
    },
    {
        "content": "<p><code>lake env lean Mathlib/FieldTheory/Galois/Basic.lean</code> paused for a long time...but still no json file :-)</p>",
        "id": 486769911,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733664462
    },
    {
        "content": "<p>Aah, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Dtrace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">=</span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Dtrace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">output</span><span class=\"bp\">=/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">profile</span><span class=\"bp\">.</span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">FieldTheory</span><span class=\"bp\">/</span><span class=\"n\">Galois</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n</code></pre></div>\n<p>(and but then I'm not sure what the point is of putting the <code>set_option</code> in the Lean file, and probably I also didn't use all the myriad mathlib options which would usually be fed to Lean?</p>",
        "id": 486770171,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733664635
    },
    {
        "content": "<p>Also, I only want to profile one declaration -- I think I might have just profiled an entire huge file?</p>",
        "id": 486770226,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733664693
    },
    {
        "content": "<p>That's not something that is well-exposed currently - but you should be able to move the first option to where you want it in the file and only leave the second option on the cmdline</p>",
        "id": 486770655,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733665043
    },
    {
        "content": "<p>Is there any way to set the output without invoking the command line directly?</p>",
        "id": 486830609,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733714468
    },
    {
        "content": "<p>It's a little annoying to have to find all the <code>--load_dynlib</code> arguments that lake would pass automatically</p>",
        "id": 486830651,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733714495
    },
    {
        "content": "<p>(We tried to do this in Providence last week by changing the Lean server args, but ended up just having to reassemble the full command line)</p>",
        "id": 486830747,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733714550
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> You can use <code>lake lean</code> to have  Lake provide the poper arguments (and build any imports). For instance, adapting Kevin's example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">FieldTheory</span><span class=\"bp\">/</span><span class=\"n\">Galois</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">-- -Dtrace.profiler=true -Dtrace.profiler.output=/tmp/profile.json</span>\n</code></pre></div>",
        "id": 486845943,
        "sender_full_name": "Mac Malone",
        "timestamp": 1733723199
    },
    {
        "content": "<p>Perhaps Lean core should provide a linter warning that <code>set_option trace.profiler.output \"foo\"</code> doesn't actually do anything, and you have to use the command line?</p>",
        "id": 488146431,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733936809
    }
]