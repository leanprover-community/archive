[
    {
        "content": "<p>Minimized:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">HasFoo</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"n\">where</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">Bool</span>\n<span class=\"kd\">class</span> <span class=\"n\">GoodFoo</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">Bool</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span>\n<span class=\"kd\">class</span> <span class=\"n\">BetterFoo</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">Bool</span><span class=\"o\">)</span> <span class=\"kd\">extends</span> <span class=\"n\">GoodFoo</span> <span class=\"n\">α</span> <span class=\"n\">foo</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">noncanonical</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">HasFoo</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">HasFoo</span> <span class=\"n\">α</span> <span class=\"n\">where</span> <span class=\"n\">foo</span> <span class=\"n\">a</span> <span class=\"o\">:=</span> <span class=\"n\">f.foo</span> <span class=\"n\">a</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">true</span>\n<span class=\"kd\">instance</span> <span class=\"o\">[</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">HasFoo</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">GoodFoo</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"n\">noncanonical</span> <span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">foo</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">HasFoo</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">BetterFoo</span> <span class=\"n\">Nat</span> <span class=\"n\">HasFoo.foo</span> <span class=\"o\">:=</span> <span class=\"gr\">sorry</span>\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">GoodFoo</span> <span class=\"n\">Nat</span> <span class=\"n\">HasFoo.foo</span> <span class=\"o\">:=</span> <span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>Commenting out the first instance makes the last line work. Tracing instance synthesis reveals that the inference process crashes when processing the first instance, meaning that the rest of the instance search is not tried and this very easy instance search problem fails. The expected behavior is that the first instance is ignored because it doesn't match.</p>",
        "id": 432836360,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1712902828
    },
    {
        "content": "<p>Yeah this was the problem in <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/Odd.20behaviour.20with.20inferring.20instances.2E\">#mathlib4 &gt; Odd behaviour with inferring instances.</a></p>",
        "id": 432906254,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1712929239
    },
    {
        "content": "<p>Do you want to open an issue to track this?</p>",
        "id": 433642292,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713324828
    },
    {
        "content": "<p>I've reported this at <a href=\"https://github.com/leanprover/lean4/pull/5032\">lean#5032</a>.</p>",
        "id": 462265467,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723612862
    }
]