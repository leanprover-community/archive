[
    {
        "content": "<p>I had thought that any bogus proof of FLT would be spottable with <code>#print axioms</code>, but this was just pointed out to me on the Xena Discord:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">section</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"bp\">.</span><span class=\"n\">skipKernelTC</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"so_sorry\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">closeMainGoal</span><span class=\"w\"> </span><span class=\"ss\">`so_sorry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``trivial</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">so_sorry</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">easy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FermatLastTheorem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">elim</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"n\">easy</span><span class=\"w\"> </span><span class=\"c1\">-- 'easy' depends on axioms: [propext]</span>\n</code></pre></div>\n<p>I am surprised that <code>debug.skipKernelTC true</code> isn't \"infectious\" like <code>partial</code> or <code>native_decide</code>. This means that I cannot trust any proof, even if <code>#print axioms</code> only mentions the standard three which are allowed in mathlib/FLT? I <em>need</em> to run it through a typechecker? (which will of course spot this hack).</p>",
        "id": 507604427,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742763060
    },
    {
        "content": "<p>See also <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/PSA.20about.20trusting.20Lean.20proofs/with/392684837\">#general &gt; PSA about trusting Lean proofs</a>, it looks to me like similar stuff is going on. That is, <code>closeMainGoal</code> is also adding a decl to the environment, and the debug option is turning off kernel-checking at that point</p>",
        "id": 507605186,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1742763568
    },
    {
        "content": "<p>I would say you should run it through a typechecker because axioms <a href=\"#narrow/channel/113488-general/topic/Code.20with.20Proofs.3A.20the.20Arena/near/482808260\">can also be redefined</a>, so even without <code>skipKernelTC</code> just checking <code>#print axioms</code> is insufficient.</p>",
        "id": 507605374,
        "sender_full_name": "ùö†ùöòùöìùöåùöíùöéùöåùöë ùöóùöäùö†ùöõùöòùöåùöîùöí",
        "timestamp": 1742763620
    },
    {
        "content": "<p>OK the message has finally sunk in :-)</p>",
        "id": 507605967,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742763956
    },
    {
        "content": "<p>Here's an example of adding a bad declaration without using the <code>debug.skipKernelTC</code> option:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.NumberTheory.FLT.Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">myBadTheorem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TheoremVal</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`bad</span>\n<span class=\"w\">  </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean.mkConst</span><span class=\"w\"> </span><span class=\"ss\">``False</span>\n<span class=\"w\">  </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean.mkConst</span><span class=\"w\"> </span><span class=\"ss\">``trivial</span>\n<span class=\"w\">  </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">currentEnv</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Lean.Kernel.Environment.addDeclWithoutChecking</span><span class=\"w\"> </span><span class=\"n\">currentEnv.toKernelEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"n\">myBadTheorem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">setEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Environment.ofKernelEnv</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"didn't work\"</span>\n\n<span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">flt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FermatLastTheorem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bad.elim</span>\n<span class=\"k\">#print</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"w\"> </span><span class=\"n\">flt</span><span class=\"w\"> </span><span class=\"c1\">-- 'flt' depends on axioms: [propext]</span>\n</code></pre></div>",
        "id": 507606777,
        "sender_full_name": "Niels Voss",
        "timestamp": 1742764518
    },
    {
        "content": "<p>Thanks Neils (nb who was the person who brought this to my attention on Discord). Yes I had suspected that \"grep for <code>debug.skipKernelTC</code>\" would not be enough.</p>",
        "id": 507617859,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742772883
    },
    {
        "content": "<p>We really need to make <code>lean4checker</code> a default part of the CI runs for new projects...</p>",
        "id": 507626868,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742779494
    },
    {
        "content": "<p>I just want to mention here that the existence of <code>debug.skipKernelTC</code> is what made me doubt the validity of <code>grind</code> proofs here: <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/A.20.28semi.29-autoformalization.20challenge.3A.20650.3D.3E448/near/518740525\">#Machine Learning for Theorem Proving &gt; A (semi)-autoformalization challenge: 650=&gt;448 @ üí¨</a></p>",
        "id": 518748382,
        "sender_full_name": "David Renshaw",
        "timestamp": 1747429917
    },
    {
        "content": "<p>Ah, I had been under the impression that <code>debug.skipKernelTC</code> was enabled by default for <code>bv_decide</code>, but apparently it's not: <a href=\"https://github.com/leanprover/lean4/blob/b7b95896aa6466eede97ccdc54e36e73d1e0c524/src/Lean/Elab/Tactic/BVDecide.lean#L32-L34\">https://github.com/leanprover/lean4/blob/b7b95896aa6466eede97ccdc54e36e73d1e0c524/src/Lean/Elab/Tactic/BVDecide.lean#L32-L34</a></p>\n<p>I would be uncomfortable if tactics in the core library relied on environment hacking by default. Fortunately, it seems that's not the case. :)</p>",
        "id": 518751455,
        "sender_full_name": "David Renshaw",
        "timestamp": 1747431431
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243791\">David Renshaw</span> <a href=\"#narrow/stream/270676-lean4/topic/debug.2EskipKernelTC.20true/near/518751455\">said</a>:</p>\n<blockquote>\n<p>Ah, I had been under the impression that <code>debug.skipKernelTC</code> was enabled by default for <code>bv_decide</code>, but apparently it's not: <a href=\"https://github.com/leanprover/lean4/blob/b7b95896aa6466eede97ccdc54e36e73d1e0c524/src/Lean/Elab/Tactic/BVDecide.lean#L32-L34\">https://github.com/leanprover/lean4/blob/b7b95896aa6466eede97ccdc54e36e73d1e0c524/src/Lean/Elab/Tactic/BVDecide.lean#L32-L34</a></p>\n</blockquote>\n<p>Why's that?</p>",
        "id": 518751555,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1747431480
    },
    {
        "content": "<p>Discussion on the Xena Discord that I had skimmed. (And poor reading comprehension on my part.)</p>",
        "id": 518751689,
        "sender_full_name": "David Renshaw",
        "timestamp": 1747431534
    },
    {
        "content": "<p>bv_decide does use <code>ofReduce(Bool|Int)</code> though</p>",
        "id": 518754785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747433463
    },
    {
        "content": "<p>We only have <code>ofReduceNat</code> not for <code>Int</code> unfortunately, <code>bv_decide</code> also only uses <code>ofReduceBool</code>.</p>",
        "id": 518754847,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1747433517
    },
    {
        "content": "<p>So you can't distinguish a \"safe\" <code>bv_decide</code> application from one of the things in <a href=\"#narrow/channel/113488-general/topic/Using.20.60native_decide.60.20to.20prove.20False.3F\">#general &gt; Using &#96;native_decide&#96; to prove False?</a> from the axioms alone</p>",
        "id": 518754934,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747433557
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik B√∂ving</span> <a href=\"#narrow/channel/270676-lean4/topic/debug.2EskipKernelTC.20true/near/518754847\">said</a>:</p>\n<blockquote>\n<p>We only have <code>ofReduceNat</code> not for <code>Int</code> unfortunately, <code>bv_decide</code> also only uses <code>ofReduceBool</code>.</p>\n</blockquote>\n<p>Can you remind me when <code>ofReduceNat</code> is used? Int was indeed a typo :)</p>",
        "id": 518754963,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747433574
    },
    {
        "content": "<p>Nobody uses it</p>",
        "id": 518754971,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1747433583
    },
    {
        "content": "<p>Is it even possible to use by hand?</p>",
        "id": 518754997,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747433597
    },
    {
        "content": "<p>Totally</p>",
        "id": 518755006,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1747433603
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"521331\">@Niels Voss</span> </p>\n<p>Your example now does not work. Does this mean that the issue was addressed by an update to Lean?</p>",
        "id": 522852137,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749247643
    },
    {
        "content": "<p>No, the interface changed but you can still do basically the same thing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">FLT</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myBadTheorem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TheoremVal</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`bad</span>\n<span class=\"w\">  </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``False</span>\n<span class=\"w\">  </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``trivial</span>\n<span class=\"w\">  </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">currentEnv</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">currentEnv</span><span class=\"bp\">.</span><span class=\"n\">addDeclCore</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"n\">myBadTheorem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">doCheck</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">setEnv</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"didn't work\"</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">flt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bad</span><span class=\"bp\">.</span><span class=\"n\">elim</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"n\">flt</span><span class=\"w\"> </span><span class=\"c1\">-- 'flt' depends on axioms: [propext]</span>\n</code></pre></div>",
        "id": 522854064,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749249063
    },
    {
        "content": "<blockquote>\n<p>No, the interface changed but you can still do basically the same thing:</p>\n</blockquote>\n<p>Thank you!!! <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> </p>\n<p>Is the important point in this example the use of <code>addDeclWithoutChecking</code>?<br>\nDoes this make it possible to do something similar to <code>skipKernelTC</code>?</p>",
        "id": 522855995,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749250608
    },
    {
        "content": "<p>Yes, <code>addDeclWithoutChecking</code> is what skips the kernel type checking. However, there are probably other ways to do the same thing, so just removing <code>addDeclWithoutChecking</code> won't actually fix the core issue.</p>",
        "id": 522856143,
        "sender_full_name": "Niels Voss",
        "timestamp": 1749250746
    },
    {
        "content": "<p>Is the following understanding correct?</p>\n<ul>\n<li>\n<p>It is not considered a bug that APIs like <code>skipKernelTC</code> allow one to easily bypass Lean's kernel type checker and write fake proofs.</p>\n</li>\n<li>\n<p>Apart from using <code>lean4lean</code>, there is no known automatic method for checking fake proofs. In particular, there is no automatic way to check for fake proofs in editor environments like Lean 4 Web.</p>\n</li>\n</ul>",
        "id": 522859149,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749253916
    },
    {
        "content": "<p>Yes I think that is correct. At the same time, metacode could redefine the #print axioms command or modify the pretty printer to show misleading output, or execute malicious code that modifies the behavior of the Lean program to not track axioms.</p>",
        "id": 522871411,
        "sender_full_name": "Niels Voss",
        "timestamp": 1749270604
    },
    {
        "content": "<p>So really, no matter what you do, there's no way to verify the integrity of a lean proof from the web editor and I don't see how Lean could ever be changed for this to become possible</p>",
        "id": 522871636,
        "sender_full_name": "Niels Voss",
        "timestamp": 1749270709
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/channel/270676-lean4/topic/debug.2EskipKernelTC.20true/near/522859149\">said</a>:</p>\n<blockquote>\n<ul>\n<li>Apart from using <code>lean4lean</code>, there is no known automatic method for checking fake proofs.</li>\n</ul>\n</blockquote>\n<p>This is incorrect. Any external checker will do, such as <code>lean4checker</code> already being run on Mathlib.</p>",
        "id": 522892412,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1749298768
    }
]