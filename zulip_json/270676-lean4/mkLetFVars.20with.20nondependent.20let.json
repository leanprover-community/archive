[
    {
        "content": "<p>When a let-binding is introduced via <code>withLetDecl (nondep := true)</code>, abstracting it away later via <code>mkLetFVars</code> does not produce a <code>have</code>, but rather a lambda. <del>It makes sense in terms of the implementation - nondependent bindings are stored as <code>cdecl</code>s - but is certainly quite unintuitive.</del> Should this be considered a bug or intended behavior?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"bp\">#</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"c1\">-- Lean 4.23.0-nightly-2025-07-26</span>\n\n<span class=\"c1\">-- let x := True.intro; x</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True.intro</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nondep</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">mkLetFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">t</span>\n\n<span class=\"c1\">-- fun x =&gt; x</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True.intro</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nondep</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">mkLetFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">t</span>\n</code></pre></div>",
        "id": 531001479,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1753562834
    },
    {
        "content": "<p>Oh, and it works as expected with <code>generalizeNondepLet := false</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- have x := True.intro; x</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``True.intro</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nondep</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">mkLetFVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">generalizeNondepLet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">t</span>\n</code></pre></div>\n<p>The documentation for it is buried far down, but it seems to be what I want here?</p>",
        "id": 531002257,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1753563199
    },
    {
        "content": "<p>Yes, this is intended behavior. <a href=\"https://github.com/leanprover/lean4/blob/2be6c75c2baba5764a2dac57cabfcb69d273d4c9/src/Lean/LocalContext.lean#L63\">https://github.com/leanprover/lean4/blob/2be6c75c2baba5764a2dac57cabfcb69d273d4c9/src/Lean/LocalContext.lean#L63</a></p>\n<p>If you are wanting to use withLetDecl and mkLetFVars in a pair like this, it's better to use <code>mapLetDecl</code></p>",
        "id": 531002509,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753563316
    },
    {
        "content": "<p>There's some more documentation at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarContext.MkBinding.mkBinding#doc\">docs#Lean.MetavarContext.MkBinding.mkBinding</a> too</p>",
        "id": 531002872,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753563485
    },
    {
        "content": "<p>Thanks! I can't use <code>mapLetDecl</code> because I am producing several <code>Expr</code>s whereas that only supports mapping one. I am basically inlining its implementation, though. The docstring on <code>ldecl</code> contains a mysterious remark:</p>\n<p><strong>Rule:</strong> never use <code>(generalizeNondepLet := false)</code> in <code>mkBinding</code>-family functions within a local context you do not own. See <code>LocalDecl.setNondep</code> for some additional discussion.</p>\n<p>What does it mean to 'own' a local context?</p>",
        "id": 531004198,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1753564131
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"128280\">ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’</span> <a href=\"#narrow/channel/270676-lean4/topic/mkLetFVars.20with.20nondependent.20let/near/531001479\">said</a>:</p>\n<blockquote>\n<p>nondependent bindings are stored as <code>cdecl</code>s</p>\n</blockquote>\n<p>They're being stored as <code>ldecl</code>s.</p>\n<p>I linked to docstrings with some explanation, but the short version is that there's an \"inside\" and an \"outside\" to nondependent <code>let</code>s. From \"inside\" the value is opaque, but from \"outside\" you can see what the value is. It's unfortunately more complex than you'd hope...</p>\n<p>The API is designed so that you can create a nondep let and call whatever you want (it will appear cdecl-like), and then you're able to abstract it as a <code>have</code> still.</p>",
        "id": 531004254,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753564155
    },
    {
        "content": "<p>\"own\" is supposed to mean \"I extended this local context with my own bindings, and I will only abstract those bindings\"</p>",
        "id": 531004460,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753564252
    },
    {
        "content": "<p>the point is that you shouldn't do <code>mk*FVars</code> with <code>(generalizeNondepLet := false)</code> with fvars that you don't know exactly where they came from.</p>",
        "id": 531004594,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753564317
    },
    {
        "content": "<p>Ah ok, maybe it would be clearer to say 'never use ... on a local context entry you did not create'? I can make a small doc PR. UPDATE: It's <a href=\"https://github.com/leanprover/lean4/pull/9570\">lean4#9570</a>.</p>",
        "id": 531005968,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1753565002
    }
]