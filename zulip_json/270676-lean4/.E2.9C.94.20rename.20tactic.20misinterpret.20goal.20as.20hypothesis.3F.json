[
    {
        "content": "<p>I hear about Lean recently, and have been casually playing with it while reading the TPIL documentation. </p>\n<p>I encountered an infinite loop issue while creating a custom tactic, and eventually, I discovered that it was because <code>rename</code> seemed to treat the goal as a hypothesis and successfully assigned it a usable name.</p>\n<p>Here is the MWP demonstrating this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rename</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p><a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=G4QwTgliBGA2CmACA3ogDogjogXIgCmAPYYC+AUOfAB4gC2aCu6igKYRa4C8i0AnuYkRh4AO3pIM7bJwB8iAOZEQsAYiLQALiAgjEgC/I0AGiyBL8i4KlKwQGMiIgM4awAV2saiYRAB4A3HKcQwFCwQA\">Playground</a> screenshot of proof state after <code>obtain</code>: </p>\n<p><a href=\"/user_uploads/3121/GgYEfmzHwe247QsY055e-w6t/.png\">state.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/GgYEfmzHwe247QsY055e-w6t/.png\" title=\"state.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"997x370\" src=\"/user_uploads/thumbnail/3121/GgYEfmzHwe247QsY055e-w6t/.png/840x560.webp\"></a></div><p>Of course, it won't admit the proof, but it will throw an error when attempting to construct the actual proof.</p>\n<p>However, I believe the fail should occur directly at <code>rename</code> itself. <br>\nI'm unsure whether this is an (obvious?) bug or a deliberate design choice.</p>",
        "id": 516274087,
        "sender_full_name": "7sDream",
        "timestamp": 1746471331
    },
    {
        "content": "<p><code>rename</code> seems to be renaming <code>_example</code> to <code>goal</code>, where <code>_example</code> is an auxiliary hypothesis used to implement recursive definitions</p>",
        "id": 516275234,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746471725
    },
    {
        "content": "<p>The fact that <code>rename</code> can rename implementation detail hypotheses is surprising to me, and I think this is a bug.</p>",
        "id": 516275409,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746471800
    },
    {
        "content": "<p>Yes, when I discovered that this code seems to be able to prove any proposition, I felt that this is probably a bug rather than the intended design.</p>",
        "id": 516275700,
        "sender_full_name": "7sDream",
        "timestamp": 1746471894
    },
    {
        "content": "<p>Should I create a github issue for it?</p>",
        "id": 516275779,
        "sender_full_name": "7sDream",
        "timestamp": 1746471922
    },
    {
        "content": "<p>It looks like <a href=\"https://github.com/leanprover/lean4/blob/af51e3e4b1c655df43476972c4d9aeae76e49046/src/Lean/Elab/Tactic/ElabTerm.lean#L344-L345\">these lines</a> forgot to check whether the local declaration is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalDecl.isImplementationDetail#doc\">docs#Lean.LocalDecl.isImplementationDetail</a>.</p>",
        "id": 516276325,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746472128
    },
    {
        "content": "<p>wow, quick and accurate diagnosis.</p>",
        "id": 516276972,
        "sender_full_name": "7sDream",
        "timestamp": 1746472363
    },
    {
        "content": "<p>Issue created: <a href=\"https://github.com/leanprover/lean4/issues/8240\">https://github.com/leanprover/lean4/issues/8240</a></p>",
        "id": 516279428,
        "sender_full_name": "7sDream",
        "timestamp": 1746473194
    },
    {
        "content": "<p>I tried opening a PR (<a href=\"https://github.com/leanprover/lean4/pull/8241\">lean4#8241</a>)</p>",
        "id": 516300628,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746480805
    },
    {
        "content": "<p>This is my first PR to lean core, I hope it goes well</p>",
        "id": 516300947,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746480926
    },
    {
        "content": "<p>note that it's easy to do the same thing without the <code>rename</code> tactic, it's just doing the equivalent of this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>That's why you get an error about \"failed to show termination\".</p>",
        "id": 516321478,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746491756
    },
    {
        "content": "<p>the constructor and trivial part is just shuffling symbols without really doing anything, the proof amounts to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>which also \"seems to be able to prove any proposition\", except that it doesn't because of the very important termination check it does at the end!</p>",
        "id": 516321742,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746491889
    },
    {
        "content": "<p>Yes, you are right. If we use <code>theorem</code> instead of <code>example</code>, directly referencing the current goal by the theorem's name can easily lead to a form of \"circular reasoning\".<br>\nHowever, I believe this does not change the fact that there is still an issue with <code>rename</code>, right? IMHO, In theory, it should not be able to capture the current goal and rename it, regardless of whether it is within a <code>theorem</code> or an <code>example</code>...</p>",
        "id": 516360831,
        "sender_full_name": "7sDream",
        "timestamp": 1746513775
    },
    {
        "content": "<p>But I'm not quite sure if in the case of <code>theorem</code>, is the<code>foo</code> is still a <code>LocalDeclKind.auxDecl</code>?</p>",
        "id": 516361062,
        "sender_full_name": "7sDream",
        "timestamp": 1746513865
    },
    {
        "content": "<p>oh, I just checked the doc, it is:</p>\n<blockquote>\n<p>For example: def foo (n : Nat) : Nat := _ adds the local declaration foo : Nat → Nat to allow recursive calls. This declaration has the auxDecl kind.</p>\n</blockquote>",
        "id": 516361224,
        "sender_full_name": "7sDream",
        "timestamp": 1746513938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/270676-lean4/topic/rename.20tactic.20misinterpret.20goal.20as.20hypothesis.3F/near/516300628\">said</a>:</p>\n<blockquote>\n<p>I tried opening a PR (<a href=\"https://github.com/leanprover/lean4/pull/8241\">lean4#8241</a>)</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>, I left a minor request. Otherwise looks good.</p>",
        "id": 516382119,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746520145
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"908488\">7sDream</span> has marked this topic as resolved.</p>",
        "id": 516620184,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746609411
    }
]