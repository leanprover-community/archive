[
    {
        "content": "<p>With recent changes to <code>lake</code> I'm unable to get my FFI setup working again.</p>\n<p>To demonstrate the problem I have set up a simple <a href=\"https://github.com/lecopivo/SimpleFFI\">project</a> which has:</p>\n<p><code>FFI/Basic.lean</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"world\"</span>\n</code></pre></div>\n<p><code>FFI/Compiled.lean</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"print_usize\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">printUSize</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n</code></pre></div>\n<p><code>FFI.lean</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"bp\">.</span><span class=\"n\">Compiled</span>\n</code></pre></div>\n<p><code>Main.lean</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">FFI</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello, {hello}!\"</span>\n<span class=\"w\">  </span><span class=\"n\">printUSize</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">main</span>\n</code></pre></div>\n<p><code>lakefile.lean</code> (inspired by lake ffi <a href=\"https://github.com/leanprover/lean4/blob/master/src/lake/examples/ffi/lib/lakefile.lean\">example</a>)</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>lakefile.lean</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">ffi</span><span class=\"w\"> </span><span class=\"n\">where</span>\n\n<span class=\"n\">input_file</span><span class=\"w\"> </span><span class=\"n\">ffi.c</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.c\"</span>\n<span class=\"w\">  </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">ffi.o</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ffi.c.fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg.buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.o\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">buildO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"cc\"</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">libleanffi</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ffiO</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ffi.o.fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"leanffi\"</span>\n<span class=\"w\">  </span><span class=\"n\">buildStaticLib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pkg.staticLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">ffiO</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">roots</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`FFI</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n</code></pre></div>\n</div></div>\n<p>I have few issues I do not know how to resolve:</p>\n<ol>\n<li><code>lake build</code> has no problem evaluating <code>#eval main</code> but infoview in VS Code and Emacs hangs on it.</li>\n<li>How can I change the setup such that <code>FFI/Basic.lean</code> is not compiled but <code>FFI/Compiled.lean</code> is compiled? The reason for doing this is that <code>FFI/Basic.lean</code> imports large part of mathlib which I do not want to compile.</li>\n</ol>\n<p>Previously I just replaced</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">roots</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`FFI</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFICompiled</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">roots</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`FFI.Compiled</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>but now this fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">initializer</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">initialize_FFICompiled'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">134</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">FFI</span>\n</code></pre></div>",
        "id": 521072538,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748517033
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span></p>",
        "id": 521075596,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1748518253
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> <code>FFICompiled</code> should be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"bp\">.</span><span class=\"n\">Compiled</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 521115973,
        "sender_full_name": "Mac Malone",
        "timestamp": 1748531801
    },
    {
        "content": "<p>What if I have 20 lean files I want to compile? Do I have to make one <code>lean_lib</code> for each?</p>",
        "id": 521116337,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748531918
    },
    {
        "content": "<p>Why is the name of <code>lean_lib</code> important? It didn't use to be. The files to compile were specified through the <code>roots</code> field.</p>",
        "id": 521117175,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748532164
    },
    {
        "content": "<p>Ok, I can turn <code>FFI.Compiled.lean</code> into a folder and all the files in it will be compiled. I'm still confused  about the <code>lean_lib</code> naming and the <code>roots</code> field.</p>",
        "id": 521118626,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748532657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/changes.20to.20lake.20and.20FFI/near/521116337\">said</a>:</p>\n<blockquote>\n<p>What if I have 20 lean files I want to compile? Do I have to make one <code>lean_lib</code> for each?</p>\n</blockquote>\n<p>The standard approach would to have a single precompiled root module which imports the 20.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/changes.20to.20lake.20and.20FFI/near/521117175\">said</a>:</p>\n<blockquote>\n<p>Why is the name of <code>lean_lib</code> important? It didn't use to be. The files to compile were specified through the <code>roots</code> field.</p>\n</blockquote>\n<p>Lake now tries to load the library as plugin if it can (i.e., via <code>lean --plugin</code> instead of <code>lean --load-dynlib</code>). This requires the root and the library to be named in a speciifc way and Lake's heuristic for detecting this is currently inaccurate. <a href=\"https://github.com/leanprover/lean4/pull/8528\">lean4#8528</a> will fix this.</p>",
        "id": 521118764,
        "sender_full_name": "Mac Malone",
        "timestamp": 1748532713
    },
    {
        "content": "<p>Why does the order of <code>lean_lib</code> matter?</p>\n<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"bp\">.</span><span class=\"n\">Compiled</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>but this does not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span><span class=\"bp\">.</span><span class=\"n\">Compiled</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkObjs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">libleanffi</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">FFI</span>\n</code></pre></div>\n<p>Why is that? I find it quite confusing as there has to be some dependency between the two that is not explicitly written.</p>",
        "id": 521132864,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748537523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/changes.20to.20lake.20and.20FFI/near/521132864\">said</a>:</p>\n<blockquote>\n<p>Why does the order of <code>lean_lib</code> matter?</p>\n</blockquote>\n<p>Later libraries shadow earlier ones. Both <code>FFI</code> and <code>FFI.Compiled</code> match  <code>FFI.Compiled</code>. That is, they overlap -- <code>FFI</code> matches any module <code>FFI.*</code> and <code>FFI.Compiled</code> matches any module <code>FFI.Compiled.*</code>.  If <code>FFI.Compiled</code> comes later, its configuration is used; otherwise, the configuration of <code>FFI</code> is used.</p>",
        "id": 521137277,
        "sender_full_name": "Mac Malone",
        "timestamp": 1748539269
    },
    {
        "content": "<p>Thanks! I have it working now on v4.19.0</p>",
        "id": 521247039,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748593962
    },
    {
        "content": "<p>However, not I'm trying to bump to <code>v4.20.0-rc5</code> and I'm getting bunch of undefined reference errors. For examples:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l_Array_emptyWithCapacity</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Congr</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">Documents</span><span class=\"bp\">/</span><span class=\"n\">LeanBLAS</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Batteries</span><span class=\"bp\">/</span><span class=\"n\">Tactic</span><span class=\"bp\">/</span><span class=\"n\">Congr</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">initialize_Batteries_Tactic_Congr</span><span class=\"o\">)</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>full error message</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>info: stderr:\nld.lld: error: undefined symbol: l_Array_emptyWithCapacity\n&gt;&gt;&gt; referenced by Congr.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/batteries/.lake/build/ir/Batteries/Tactic/Congr.c.o.export:(initialize_Batteries_Tactic_Congr)\n&gt;&gt;&gt; referenced by Util.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Util.c.o.export:(initialize_ProofWidgets_Util)\n&gt;&gt;&gt; referenced by Compat.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Compat.c.o.export:(initialize_ProofWidgets_Compat)\n\nld.lld: error: undefined symbol: l_Lean_Json_getObjValAs_x3f___at___private_Lean_Data_Lsp_Basic_0__Lean_Lsp_fromJsonTextEdit____x40_Lean_Data_Lsp_Basic___hyg_1976____spec__2\n&gt;&gt;&gt; referenced by MakeEditLink.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/MakeEditLink.c.o.export:(l___private_ProofWidgets_Component_MakeEditLink_0__ProofWidgets_fromJsonMakeEditLinkProps____x40_ProofWidgets_Component_MakeEditLink___hyg_147_)\n&gt;&gt;&gt; did you mean: l_Lean_Json_getObjValAs_x3f___at___private_Lean_Data_Lsp_Basic_0__Lean_Lsp_fromJsonTextEdit____x40_Lean_Data_Lsp_Basic___hyg_1976____spec__1\n&gt;&gt;&gt; defined in: /home/tskrivan/.elan/toolchains/leanprover--lean4---v4.20.0-rc5/lib/lean/libLean.a(Basic.o)\n\nld.lld: error: undefined symbol: l_Lean_Json_getObjValAs_x3f___at___private_Lean_Data_Lsp_Extra_0__Lean_Lsp_fromJsonRpcCallParams____x40_Lean_Data_Lsp_Extra___hyg_2014____spec__2\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l___private_ProofWidgets_Component_Basic_0__ProofWidgets_fromJsonRpcEncodablePacket____x40_ProofWidgets_Component_Basic___hyg_69_)\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l___private_ProofWidgets_Component_Basic_0__ProofWidgets_fromJsonRpcEncodablePacket____x40_ProofWidgets_Component_Basic___hyg_329_)\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l___private_ProofWidgets_Component_Basic_0__ProofWidgets_fromJsonRpcEncodablePacket____x40_ProofWidgets_Component_Basic___hyg_645_)\n\nld.lld: error: undefined symbol: l_List_flatMapTR_go___at___private_Lean_Util_Paths_0__Lean_toJsonLeanPaths____x40_Lean_Util_Paths___hyg_55____spec__2\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l___private_ProofWidgets_Component_Basic_0__ProofWidgets_toJsonRpcEncodablePacket____x40_ProofWidgets_Component_Basic___hyg_152_)\n&gt;&gt;&gt; referenced by MakeEditLink.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/MakeEditLink.c.o.export:(l___private_ProofWidgets_Component_MakeEditLink_0__ProofWidgets_toJsonMakeEditLinkProps____x40_ProofWidgets_Component_MakeEditLink___hyg_292_)\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l___private_ProofWidgets_Component_Basic_0__ProofWidgets_toJsonRpcEncodablePacket____x40_ProofWidgets_Component_Basic___hyg_412_)\n&gt;&gt;&gt; referenced 2 more times\n\nld.lld: error: undefined symbol: l___private_Lean_Widget_TaggedText_0__Lean_Widget_fromJsonTaggedText____x40_Lean_Widget_TaggedText___hyg_407____at_Lean_Widget_TaggedText_instRpcEncodable___spec__5\n&gt;&gt;&gt; referenced by Basic.c\n&gt;&gt;&gt;               /home/tskrivan/Documents/LeanBLAS/.lake/packages/proofwidgets/.lake/build/ir/ProofWidgets/Component/Basic.c.o.export:(l_ProofWidgets_instRpcEncodableInteractiveCodeProps_dec____x40_ProofWidgets_Component_Basic___hyg_44_)\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nerror: external command &#39;/home/tskrivan/.elan/toolchains/leanprover--lean4---v4.20.0-rc5/bin/clang&#39; exited with code 1\nSome required builds logged failures:\n- CBLASLevelOneTest\nerror: build failed\n</code></pre></div>\n</div></div>\n<p>Right now I do not know how to minimize it. I'm updating <a href=\"https://github.com/lecopivo/LeanBLAS\">LeanBLAS</a>, this <a href=\"https://github.com/lecopivo/LeanBLAS/commit/21ed3b7fe5d54de47d4d4fd63550d55e145d4442\"><code>v4.19.0</code> commit</a> works but this <a href=\"https://github.com/lecopivo/LeanBLAS/commit/37f21aba828fdcd63a8cc92d59c47c6232df516f\"><code>v4.20.0-rc5</code> commit</a> does not.</p>",
        "id": 521247987,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748594320
    },
    {
        "content": "<p>Interestingly it fails with a different error on Linux <a href=\"https://github.com/lecopivo/LeanBLAS/actions/runs/15342689972/job/43172064919\">during CI</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">libc_csu_fini</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">101</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">x86_64</span><span class=\"bp\">/</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">101</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.20.0-rc5/lib/Scrt1.o:(_start)</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">libc_csu_init</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">102</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">x86_64</span><span class=\"bp\">/</span><span class=\"n\">start</span><span class=\"bp\">.</span><span class=\"n\">S</span><span class=\"o\">:</span><span class=\"mi\">102</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.20.0-rc5/lib/Scrt1.o:(_start)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.20.0-rc5/bin/clang' exited with code 1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">CBLASLevelOneTest</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>\n<p>and on MacOS it passes</p>",
        "id": 521249730,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748594969
    },
    {
        "content": "<p>Now I'm updating SciLean that uses LeanBLAS and I'm getting an odd error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1847</span><span class=\"bp\">/</span><span class=\"mi\">1856</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">LeanBLAS</span><span class=\"bp\">.</span><span class=\"n\">FFI</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismtach</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">libleanblasc'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">filepath'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">unknown</span>\n</code></pre></div>\n<p>where <code>libleanblasc</code> is the target in LeanBLAS that build the C library</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">libleanblasc</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"bp\">...</span>\n<span class=\"w\">    </span><span class=\"n\">buildStaticLib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">oFiles</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 521267557,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748601415
    },
    {
        "content": "<p>This makes me wonder if there is an issue when having a project with FFI as a dependency. </p>\n<p>I try to reproduce it with the simple ffi project.</p>",
        "id": 521275363,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748604087
    },
    {
        "content": "<p>The first set of errors seems like it may be an issue caused by an incompatibility with the new LLVM toolchain used in Lean v4.20.0. LLVM has been upgraded from 15 to 19. On your local machine, it might be worth clobbering the <code>.lake</code> directory and seeing if that changes the errors to mirror the CI (some aspect of the version update may have not been caught by Lake).</p>\n<p>The 'filepath' issue, on the other hand, may more likely be a  Lake problem.</p>",
        "id": 521367034,
        "sender_full_name": "Mac Malone",
        "timestamp": 1748636791
    },
    {
        "content": "<p>I can't reproduce the <code>filepath</code> problem with the minimal example but with <code>LeanBLAS</code></p>\n<p>Steps to reproduce on Ubuntu:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">sudo</span><span class=\"w\"> </span><span class=\"n\">apt</span><span class=\"bp\">-</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"n\">libopenblas</span><span class=\"bp\">-</span><span class=\"n\">dev</span>\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"n\">leanblasdep</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">leanblasdep</span>\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"n\">leanblasdep</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n</code></pre></div>\n<p>replace <code>lakefile.lean</code> with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"s2\">\"leanblasdep\"</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v!</span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-L/usr/lib/x86_64-linux-gnu/\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-lblas\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-lm\"</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Leanblasdep</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"s2\">\"leanblasdep\"</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">leanblas</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/lecopivo/LeanBLAS\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"v4.20.1\"</span>\n</code></pre></div>\n<p>Now running  <code>lake build LeanBLAS.FFI:static</code> produces this error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">LeanBLAS</span><span class=\"bp\">.</span><span class=\"n\">FFI</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">13</span><span class=\"bp\">/</span><span class=\"mi\">14</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">libleanblasc</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">leveltwoext</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">leveltwoext</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/include -DNDEBUG -O3 -fPIC</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">util</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">util</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/include -DNDEBUG -O3 -fPIC</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">levelone</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">levelone</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/include -DNDEBUG -O3 -fPIC</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">leveltwo</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/</span><span class=\"n\">doodle</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">leanblasdep</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">c</span><span class=\"bp\">/</span><span class=\"n\">leveltwo</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/include -DNDEBUG -O3 -fPIC</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/bin/llvm-ar rcs /home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/lib/libleanblasc.a /home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/c/leveltwoext.o /home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/c/util.o /home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/c/levelone.o /home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/c/leveltwo.o</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/bin/llvm-ar: error: unable to load '/home/tskrivan/doodle/lean/leanblasdep/.lake/packages/leanblas/.lake/build/lib/libleanblasc.a': file too small to be an archive</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.21.0-rc3/bin/llvm-ar' exited with code 1</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">14</span><span class=\"bp\">/</span><span class=\"mi\">14</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">LeanBLAS</span><span class=\"bp\">.</span><span class=\"n\">FFI</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismtach</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">libleanblasc'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">filepath'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">unknown</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">leanblas</span><span class=\"bp\">/</span><span class=\"n\">libleanblasc</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">LeanBLAS</span><span class=\"bp\">.</span><span class=\"n\">FFI</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 522900650,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749308326
    },
    {
        "content": "<p>I can reproduce with the <code>SimpleFFI</code> project now.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>mkdir<span class=\"w\"> </span>SimpleFFIDep<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"nb\">cd</span><span class=\"w\"> </span>SimpleFFIDep\nlake<span class=\"w\"> </span>init<span class=\"w\"> </span>simpleffidep<span class=\"w\"> </span>.lean\n<span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s1\">'require ffi from git \"https://github.com/lecopivo/SimpleFFI\" @ \"alt\"'</span><span class=\"w\"> </span>&gt;&gt;<span class=\"w\"> </span>lakefile.lean\n<span class=\"o\">{</span><span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s1\">'import FFI'</span><span class=\"p\">;</span><span class=\"w\"> </span>cat<span class=\"w\"> </span>Main.lean<span class=\"p\">;</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span>&gt;<span class=\"w\"> </span>tmp.lean<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>mv<span class=\"w\"> </span>tmp.lean<span class=\"w\"> </span>Main.lean\nlake<span class=\"w\"> </span>update\nlake<span class=\"w\"> </span>build\n</code></pre></div>\n<p>which ends with</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">13</span>/23<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>FFI.Compiled:shared\nerror:<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>mismtach<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>target<span class=\"w\"> </span><span class=\"s1\">'libleanffi'</span>:<span class=\"w\"> </span>expected<span class=\"w\"> </span><span class=\"s1\">'filepath'</span>,<span class=\"w\"> </span>got<span class=\"w\"> </span>unknown\n✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">23</span>/23<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>simpleffidep\nerror:<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>mismtach<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>target<span class=\"w\"> </span><span class=\"s1\">'libleanffi'</span>:<span class=\"w\"> </span>expected<span class=\"w\"> </span><span class=\"s1\">'filepath'</span>,<span class=\"w\"> </span>got<span class=\"w\"> </span>unknown\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>FFI.Compiled:shared\n-<span class=\"w\"> </span>simpleffidep\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>",
        "id": 522968953,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749378387
    },
    {
        "content": "<p>It has to do something with building the <code>*.c</code> files with</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">input_file</span><span class=\"w\"> </span><span class=\"n\">ffi.c</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.c\"</span>\n<span class=\"w\">  </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">ffi.o</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ffi.c.fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg.buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.o\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">buildO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"cc\"</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">libleanffi</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ffiO</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ffi.o.fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"leanffi\"</span>\n<span class=\"w\">  </span><span class=\"n\">buildStaticLib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pkg.staticLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">ffiO</span><span class=\"o\">]</span>\n</code></pre></div>\n</div></div>\n<p>vs</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">libleanffi</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">pkg.afterBuildCacheAsync</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">oFiles</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Job</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pkg.dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">readDir</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">file.path.extension</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg.buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">file.fileName.stripSuffix</span><span class=\"w\"> </span><span class=\"s2\">\".c\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\".o\"</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inputTextFile</span><span class=\"w\"> </span><span class=\"n\">file.path</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">oFiles</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">oFiles.push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-DNDEBUG\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-O3\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"s2\">\"gcc\"</span><span class=\"w\"> </span><span class=\"n\">getLeanTrace</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"leanffi\"</span>\n\n<span class=\"w\">    </span><span class=\"n\">buildStaticLib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pkg.sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">oFiles</span><span class=\"o\">)</span>\n</code></pre></div>\n</div></div>\n<p>The first version works, the second does not. It is not clear to me how to generalize the first approach if I want to just compile all the <code>*.c</code> files in the <code>c/</code> directory.</p>",
        "id": 522969119,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749378604
    },
    {
        "content": "<p>Ahh, it has something to do with <code>pkg.afterBuildCacheAsync</code>. It is leftover code when I was experimenting with github releases. Removing it solves the problem with <code>filepath</code></p>",
        "id": 522969302,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749378841
    },
    {
        "content": "<p>However, I still have the problem executing ffi functions in the editor.</p>\n<p>mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>clone<span class=\"w\"> </span>git@github.com:lecopivo/SimpleFFI.git\n<span class=\"nb\">cd</span><span class=\"w\"> </span>SimpleFFI\nlake<span class=\"w\"> </span>update\nlake<span class=\"w\"> </span>build\n</code></pre></div>\n<p>Open <code>Main.lean</code> in VS Code and the orange line does not go away for me. Same happens in emacs.</p>",
        "id": 522969737,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749379428
    },
    {
        "content": "<p>Did anything change regarding the memory layout of Lean objects from 4.21 to 4.23? Like the ordering of constructor pointers or anything else?</p>\n<p>Our FFI glue code is now segfaulting. We're trying to minimize the problem but any clue would help. Thanks a lot!</p>",
        "id": 540298359,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1758220393
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 540304342,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1758222727
    }
]