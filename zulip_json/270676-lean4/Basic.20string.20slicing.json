[
    {
        "content": "<p>What's the new way of spelling the following?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"s2\">\"hello world\"</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">6</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">11</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>this fails, since I'm no longer allowed to construct the index in this way.</p>",
        "id": 571151258,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769822753
    },
    {
        "content": "<p>Is there a better answer than</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"bp\">.</span><span class=\"n\">nextn</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"bp\">.</span><span class=\"n\">nextn</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"s2\">\"hello world\"</span>\n</code></pre></div>\n<p>which is very verbose?</p>",
        "id": 571151461,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769822930
    },
    {
        "content": "<p>Is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"bp\">.</span><span class=\"n\">nextn</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>reasonable?</p>",
        "id": 571151559,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769823010
    },
    {
        "content": "<p>If you limit yourself to ascii, you can use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">Raw</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"s2\">\"hello world\"</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">6</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">11</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>But what do you specifically need this for?</p>",
        "id": 571151707,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769823140
    },
    {
        "content": "<p>I have a string of the form <code>foo_YYYY_bar_Z</code> and want to extract the components</p>",
        "id": 571151991,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769823391
    },
    {
        "content": "<p>Since <code>foo</code> and <code>bar</code> are known at compile-time and the fields are fixed-width, I just want to write something short</p>",
        "id": 571152053,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769823433
    },
    {
        "content": "<p><code>String.Pos.Raw.extract</code> seems like a weird place for that function to live, considering dot notation</p>",
        "id": 571152091,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769823471
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/Basic.20string.20slicing/near/571152091\">said</a>:</p>\n<blockquote>\n<p><code>String.Pos.Raw.extract</code> seems like a weird place for that function to live, considering dot notation</p>\n</blockquote>\n<p>I think the reason for this is simply that you're not really supposed to use it, and are supposed to work with <code>String.Slice</code>s now instead?</p>\n<p>Though it does seem like there's no easy way to construct a <code>Slice</code> or even an <code>s.Pos</code> by character count without that verbose <code>startPos</code> in there...</p>",
        "id": 571155205,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769826487
    },
    {
        "content": "<p>Is the OfNat instance a bad idea (and therefore missing from core) because it encourages doing the linear utf8 search twice?</p>",
        "id": 571155407,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769826672
    },
    {
        "content": "<p>I think so! My guess is that we would ideally have something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">slice'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">startingFrom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Slice</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>(but with a better name).</p>\n<p>Even more ideally, we would have dependent slices (I asked about this on zulip a little while ago and I believe the answer was that they're in the works!) so that this could return a <code>String.SliceOf s</code> (or equivalent), and we could reuse the resulting <code>endPos</code> as a starting pos for the next <code>String.slice'</code> call :)</p>",
        "id": 571157072,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769828649
    },
    {
        "content": "<p>We don't want to make this too short, because it needs to be clear from the code that getting the byte index of the n-th character is a linear-time operation.</p>\n<p>If you know that you're dealing with Ascii, then <code>#eval (fun s =&gt; s.extract (s.pos! ⟨6⟩) (s.pos! ⟨11⟩)) \"hello world\"</code> is also a possibility, or, if you don't actually want to copy out the result, <code>#eval (fun s =&gt; s.slice! (s.pos! ⟨6⟩) (s.pos! ⟨11⟩)) \"hello world!\"</code>.</p>",
        "id": 571167026,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1769839159
    },
    {
        "content": "<p>(And if you're not dealing with Ascii, I don't think there is much you can do, because what you perceive as <code>YYYY</code> in <code>foo_YYYY_bar_Z</code> could be any number of codepoints.)</p>",
        "id": 571167295,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1769839319
    },
    {
        "content": "<p>I guess what I'd like here is to be able to write <code>s.slice! (.pos! ⟨6⟩) (.pos! ⟨11⟩))</code> to avoid repeating <code>s</code></p>",
        "id": 571168718,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769840590
    },
    {
        "content": "<p>That's reasonable. I'll see what I can do.</p>",
        "id": 571170712,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1769842902
    },
    {
        "content": "<p>I suppose <code>open String (pos!)</code> then <code>s.slice! (pos! _ x) (pos! _ y)</code>, letting unification repeat the string, is not the worst</p>",
        "id": 571170977,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769843127
    },
    {
        "content": "<p>Maybe having a less verbose way to write the following would also be good</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"s2\">\"hello world!\"</span><span class=\"bp\">.</span><span class=\"n\">sliceFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">pos!</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">6</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">sliceTo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Slice</span><span class=\"bp\">.</span><span class=\"n\">pos!</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">5</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>which I guess is an argument for moving the <code>.pos!</code> namespace so I can write the same thing for both positions</p>",
        "id": 571171067,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769843220
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260921\">Markus Himmel</span> <a href=\"#narrow/channel/270676-lean4/topic/Basic.20string.20slicing/near/571167026\">said</a>:</p>\n<blockquote>\n<p>We don't want to make this too short, because it needs to be clear from the code that getting the byte index of the n-th character is a linear-time operation.</p>\n</blockquote>\n<p>True, but one thing I'd like to mention here is that Eric's first \"lawful\" approach was equivalent to <code>String.slice (s.startPos.nextn a) (s.startPos.nextn b)</code>, which counts from the start twice. If it existed, a hypothetical definition of the form of <code>slice'</code> could be more efficient by remembering <code>aPos := s.startPos.nextn a</code> and finding <code>aPos.nextn (b-a)</code>.</p>\n<p>Anecdotally, I also saw something of the form <code>s.positions.count - (s.dropWhile patt).positions.count</code> recently, to count the number of characters dropped by <code>dropWhile</code>.</p>\n<p>So the general point I'm trying to make is that while I certainly agree that it should be hard to construct a footgun, I think it is a bit of a balance, as too little API will cause people to reach for the simplest inefficient things when they need to anyway—and these tend to become more inefficient the more you combine them! <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 571171428,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769843593
    },
    {
        "content": "<p>My unverified guess is that this was some version of mathlib's <code>whitespace</code> linter (i.e., <a href=\"https://github.com/leanprover-community/mathlib4/pull/30658\">#30658</a>). :-)</p>",
        "id": 571186043,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1769856467
    },
    {
        "content": "<p>Correct! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> (Namely, the <del>present version on master</del> version on master last night!) Also, I tried briefly to find a better way, and couldn't come up with one that wasn't more awkward or required new API, so I'm \"people\" here too. :)</p>",
        "id": 571218851,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769882480
    },
    {
        "content": "<p>(<a href=\"#narrow/channel/113488-general/topic/.60linear_combination.60.20performance.20regression.20in.20v4.2E28.2E0-rc1/with/571156943\">Context</a> for other readers of this thread: the PR that upgraded to slices from (sub)strings was reverted because it hurt performance! I'm not sure if it was this line specifically, but <code>positions.count</code> seemed related based on the thread.)</p>",
        "id": 571219374,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769882869
    }
]