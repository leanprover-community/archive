[
    {
        "content": "<p>Hi. I'm relatively new to Lean and I'm writing a cryptography library in Lean, called CryptWalker.<br>\nI'm a little hesitant to post his question because there's a lot of code involved and I don't<br>\nwant to write too much or take up too much of anyone's time.</p>\n<p>I have a HList of KEMs, key encapsulation mechanisms. And my goal here is to write a unit test which<br>\niterates over the HList of KEMs and tests each KEM by using it to generate a key pair and then<br>\nencapsulate a secret with the public key and decapsulate it with the private key:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testKEM</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">kemInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">alicePublicKey</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">alicePrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">kemInstance</span><span class=\"bp\">.</span><span class=\"n\">generateKeyPair</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ciphertext</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bobSharedSecret</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">kemInstance</span><span class=\"bp\">.</span><span class=\"n\">encapsulate</span><span class=\"w\"> </span><span class=\"n\">kem</span><span class=\"w\"> </span><span class=\"n\">alicePublicKey</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">aliceSharedSecret</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">kemInstance</span><span class=\"bp\">.</span><span class=\"n\">decapsulate</span><span class=\"w\"> </span><span class=\"n\">kem</span><span class=\"w\"> </span><span class=\"n\">alicePrivateKey</span><span class=\"w\"> </span><span class=\"n\">ciphertext</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">bobSharedSecret</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">aliceSharedSecret</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Shared secrets match!\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"KEM test failed!\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"All KEM tests passed!\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">kem</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">testKEM</span><span class=\"w\"> </span><span class=\"n\">kem</span>\n<span class=\"w\">  </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"n\">rest</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"n\">Schemes</span>\n</code></pre></div>\n<p>Currently the test doesn't compile because the HList i'm passing in has a type mismatch:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"n\">Schemes</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">Schemes</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">HList</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519</span><span class=\"bp\">.</span><span class=\"n\">X25519Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x448</span><span class=\"bp\">.</span><span class=\"n\">X448Scheme</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x41417</span><span class=\"bp\">.</span><span class=\"n\">X41417Scheme</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">14139</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù‚Å∏</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù‚Å∑</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù‚Å∂</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù‚Åµ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù‚Å¥</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù¬≥</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù¬≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù¬π</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚úù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">testKEM</span><span class=\"w\"> </span><span class=\"n\">kem</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">kem</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Here's my KEM type class which is polymorphic over the specific KEM \"scheme\":</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">key</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">privkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">privkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pubkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">pubkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"w\">  </span><span class=\"n\">generateKeyPair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">encapsulate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">decapsulate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">privateKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">publicKeySize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">encodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">encodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n</code></pre></div>\n<p>HList I got from community discussion threads:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"n\">Œ±s</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"bp\">::</span><span class=\"n\">Œ±s</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But I saw various other definitions of HList that might work for this use case.</p>\n<p>and here's how I generate my list of KEM schemes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Sha256.hash</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">X25519AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">X448AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">X41417AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Schemes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HList</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">HList.cons</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X25519AsKEM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">  </span><span class=\"n\">HList.cons</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X448AsKEM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">  </span><span class=\"n\">HList.cons</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X41417AsKEM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">  </span><span class=\"n\">HList.nil</span>\n</code></pre></div>",
        "id": 465630454,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724820735
    },
    {
        "content": "<p>Something general to note is that in Lean types don't have computational content, and are erased in compilation.<br>\nSpecifically here, there are a few problems:</p>\n<ul>\n<li>In <code>testKEM</code>, there are two things with computational content - the <code>kemInstance</code>, and the <code>kem</code>. However, <code>testAllKEMs</code> only gets the <code>kemInstance</code> as input - it doesn't have the <code>kem</code> itself.</li>\n<li><code>testAllKEMs</code> doesn't know that the types in <code>ts</code> are KEMs, so it can't actually call <code>testKEM</code>.<br>\nI think this should work:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Œ£</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"All KEM tests passed!\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">‚ü®_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">kem</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">testKEM</span><span class=\"w\"> </span><span class=\"n\">kem</span>\n<span class=\"w\">  </span><span class=\"n\">testAllKEMs</span><span class=\"w\"> </span><span class=\"n\">rest</span>\n</code></pre></div>",
        "id": 465633349,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1724822200
    },
    {
        "content": "<p>Thanks! That helps. Turns out I had to change the NIKE scheme types to be a structure instead of a class.<br>\n I ended up constructing my list of KEMs like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Sha256</span><span class=\"bp\">.</span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adapter</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hash</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defaultHash</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X25519AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X448AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X41417AsKEM</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X25519Instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X25519Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X448Instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X448Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X41417Instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X41417Scheme</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Schemes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Œ£</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">KEM</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">‚ü®</span><span class=\"n\">X25519Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X25519AsKEM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">X25519Instance</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">‚ü®</span><span class=\"n\">X448Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X448AsKEM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">X448Instance</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">‚ü®</span><span class=\"n\">X41417Scheme</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X41417AsKEM</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">X41417Instance</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 465733423,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724843804
    }
]