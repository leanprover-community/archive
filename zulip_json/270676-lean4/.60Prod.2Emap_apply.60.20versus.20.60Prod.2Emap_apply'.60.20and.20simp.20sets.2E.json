[
    {
        "content": "<p>In core, we have the lemma </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">map_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>In Mathlib, there is the lemma:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- This was previously a `simp` lemma, but no longer is on the basis that it destructures the pair.</span>\n<span class=\"c1\">--  See `map_apply`, `map_fst`, and `map_snd` for slightly weaker lemmas in the `simp` set.</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">map_apply'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>Why is it bad for a <code>simp</code> lemma to destructure a pair? To me it seems like it's less likely to, for instance, give nice output for <code>simps</code>?</p>",
        "id": 520619009,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1748337315
    },
    {
        "content": "<p>I think this is the same line of reasoning that says you only want to unfold factorial when applied to 0 or (succ n), and not when applied to anything</p>",
        "id": 520631839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748341233
    },
    {
        "content": "<p>That case makes sense, but it feels somewhat different to me because I can't think of a time I wouldn't immediately want to deconstruct the Prod. <a href=\"http://Prod.map\">Prod.map</a> f g p is just not a fantastically useful form to work with in many ways!</p>",
        "id": 520633059,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1748341717
    },
    {
        "content": "<p>Whereas simplifying factorial (n) to n * factorial (n - 1) would obviously not be a good idea.</p>",
        "id": 520633136,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1748341750
    },
    {
        "content": "<p>Not sure if this is the reason, but <code>p</code> could be a very complicated expression that you'd duplicate</p>",
        "id": 520640491,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1748344289
    },
    {
        "content": "<p>This doesn't happen in the other lemma where you've literally got a pair of two independent parts</p>",
        "id": 520640593,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1748344321
    },
    {
        "content": "<p>Note that if you want this lemma to apply, you can always do <code>cases p</code> first</p>",
        "id": 520641363,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748344538
    },
    {
        "content": "<p>No, since <code>p</code> isn't always a free variable</p>",
        "id": 520641615,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748344593
    }
]