[
    {
        "content": "<p>Suppose I have a class that is a special case of another class: the example I am thinking of is <code>OrderHomClass</code>. In this case, this is defined using <code>abbrev</code>. Suppose I want to make this definition non-reducible. I don't think I can use <code>def</code> (because I want it to be recognised as a class), but I'm not sure how to therefore define it, as using <code>class</code> doesn't seem to work.</p>\n<p>I can make this work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- `OrderHomClass F α b` asserts that `F` is a type of `≤`-preserving morphisms. -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">OrderHomClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FunLike</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">extends</span>\n<span class=\"w\">  </span><span class=\"n\">RelHomClass</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But then things that define a RelHomClass don't seem to define this (I'm not sure precisely what <code>extends</code> does.)</p>\n<p>What is the best way to do this?</p>",
        "id": 536193123,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756199893
    },
    {
        "content": "<p>You seem to already get how it works. There are two options:</p>\n<ul>\n<li>use <code>abbrev</code>. This has the convenience that all existing instances also apply to your new class</li>\n<li>use <code>class</code>, possibly with an <code>extends</code> clause. This defines an entirely new class, so you will have to add all instances about it manually. In this may come with performance benefits.</li>\n</ul>",
        "id": 536369097,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756282644
    },
    {
        "content": "<p>Related question: <code>OrderEmbedding</code> is defined using <code>abbrev</code>. I could define it using <code>def</code> instead here, or I could do something similar to the above and use <code>structure</code> with a possible <code>extends</code> on <code>RelEmbedding</code>.</p>\n<p>We are minded to stop it being reducible, in part because we don't want all the instances of <code>RelEmbedding</code> to apply, or rather we want to be able to apply them if we choose but don't want them to automatically apply. My initial thought was to use <code>def</code> for this. Initial trials suggest this might work but it does give some undesired behaviour - in particular, I was having some issues with <code>simps</code>-generated lemmas not actually simplifying when they seem like they ought to, and in general it doesn't seem to be possible to define custom simps projections for the new structure. So perhaps this isn't actually recommended?</p>",
        "id": 536369997,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756283009
    },
    {
        "content": "<p>If the <code>simps</code> lemmas involve projections from <code>OrderEmbedding</code> applied to a term of type <code>RelEmbedding</code>, then that is some defeq abuse that <code>simp</code> doesn't support.</p>\n<p>And I think using <code>structure</code> + <code>extends</code> is a reasonable option (and it will probably be easier for <code>to_dual</code> to deal with)</p>",
        "id": 536371658,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756283634
    },
    {
        "content": "<p>Which instances are the ones that you would like to not apply automatically?</p>",
        "id": 536371739,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756283664
    },
    {
        "content": "<p>No, I was thinking of projections from OrderEmbedding applied to a term of type OrderEmbedding.</p>",
        "id": 536371746,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756283666
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Using.20.60abbrev.60.20for.20a.20class.2E/near/536371739\">said</a>:</p>\n<blockquote>\n<p>Which instances are the ones that you would like to not apply automatically?</p>\n</blockquote>\n<p>It is honestly hard to be sure about this because the current situation (where OrderHom is defined inconsistently to OrderEmbedding and OrderIso) is such a mess.</p>",
        "id": 536371877,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756283706
    },
    {
        "content": "<p>It's possible we do want them. But I think (<span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> is who I have been discussing this with) we are in general frustrated at the weird lack of API for Order* in places because you can \"just use Rel*\", even though sometimes that ends up a bit hacky.</p>",
        "id": 536372243,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756283822
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/270676-lean4/topic/Using.20.60abbrev.60.20for.20a.20class.2E/near/536371877\">said</a>:</p>\n<blockquote>\n<p>OrderHom is defined inconsistently to OrderEmbedding and OrderIso</p>\n</blockquote>\n<p>Oh, that doesn't look good. Is there consensus on which kind is the preferred form?</p>",
        "id": 536372631,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756283984
    },
    {
        "content": "<p>We <em>thought</em> that using a <code>def</code> for <code>Rel*</code> was going to be right. I am no longer certain of this!</p>",
        "id": 536372759,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284032
    },
    {
        "content": "<p>Essentially there's a number of tasks here - the file that defines them needs tidying and untangling a bit (I have a PR for this ready and up), then the re-definitions, probably doing \"fix OrderEmbedding and OrderIso\" and \"fix OrderHom\" separately. There's also some smaller tasks that reflect other issues.</p>",
        "id": 536372957,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284108
    },
    {
        "content": "<p>(<code>OrderHom</code> is also dependent on <code>Preorder</code> when the others aren't - I believe there is now consensus that this, at least, should be changed, i.e. we don't use the <code>Monotone</code> predicate but instead something equivalent that doesn't require <code>Preorder</code>.)</p>",
        "id": 536373159,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284186
    },
    {
        "content": "<p>Oh, why does <code>Monotone</code> even require <code>Preorder</code>?</p>",
        "id": 536373313,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756284243
    },
    {
        "content": "<p>Ultimately everyone agrees that they should be consistent - I would say we are <em>getting</em> to the point of consensus on what they should be but not quite there.</p>",
        "id": 536373367,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284262
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Using.20.60abbrev.60.20for.20a.20class.2E/near/536373313\">said</a>:</p>\n<blockquote>\n<p>Oh, why does <code>Monotone</code> even require <code>Preorder</code>?</p>\n</blockquote>\n<p>That is a different argument :)</p>",
        "id": 536373387,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284270
    },
    {
        "content": "<p>I feel similarly to you but it was changed to be dependent for reasons that made sense at the time at the very least.</p>",
        "id": 536373501,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284311
    },
    {
        "content": "<p>This patch is the one where I was working on changing <code>OrderEmbedding</code> and <code>OrderIso</code> to <code>def</code>. If you look at the file with sorries in it, some places that previously were solved with <code>simp</code> are no longer solved by it.</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28968/commits/d2e6c811bc8499294e4853d7a5cd19fab3fa249c\">https://github.com/leanprover-community/mathlib4/pull/28968/commits/d2e6c811bc8499294e4853d7a5cd19fab3fa249c</a></p>\n<p>You can rewrite them manually using the lemma generated by <code>simps</code>, but simp itself doesn't work, even if you explictly give it that lemma. Which is Weird Behaviour.</p>",
        "id": 536373983,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284471
    },
    {
        "content": "<p>And I think ultimately comes down to this thing of <code>simps</code> getting confused about the fact it's a def defined from a structure.</p>",
        "id": 536374058,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756284509
    },
    {
        "content": "<p>It is indeed as I suggested above, that the lemma is ill-typed in the <code>reducible</code> transparency, and therefore we can't rely on <code>simp</code> to apply it. The LHS is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α₁</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">α₂</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">RelIso</span><span class=\"bp\">.</span><span class=\"n\">instFunLike</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">ea</span><span class=\"bp\">.</span><span class=\"n\">sumCongr</span><span class=\"w\"> </span><span class=\"n\">eb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α₂</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β₂</span>\n</code></pre></div>\n<p>This implicit argument implies that <code>ea.sumCongr eb</code> has type <code>(fun x1 x2 ↦ x1 ≤ x2) ≃r fun x1 x2 ↦ x1 ≤ x2</code>. Which only holds in <code>default</code> transparency.</p>",
        "id": 536378235,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756285925
    },
    {
        "content": "<p>Yeah - what I don't get is why it's done it <code>reducible</code> as you say? Like this <em>does</em> work if it's <code>abbrev</code> but it <em>doesn't</em> work if it's <code>def</code>.</p>",
        "id": 536378350,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756285969
    },
    {
        "content": "<p>But indeed this does feel like a transparency issue and I will freely admit I don't fully understand them. It feels to me that using <code>def</code>, risking the existence of simps lemmas that do not apply in practice, is not good.</p>",
        "id": 536378544,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756286031
    },
    {
        "content": "<p>Arguably this is a bug in <code>simps</code>. It should not have <code>(fun x1 x2 ↦ x1 ≤ x2) ≃r fun x1 x2 ↦ x1 ≤ x2</code> there, but instead <code>α₁ ⊕ β₁ ≃o α₂ ⊕ β₂</code>.</p>",
        "id": 536378753,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756286102
    },
    {
        "content": "<p>Yes, that sounds right.</p>",
        "id": 536378845,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756286138
    },
    {
        "content": "<p>It's why I raised this in this stream rather than the mathlib one - while this is in mathlib it felt more like a discussion about how to define things \"right\" in Lean itself.</p>",
        "id": 536381646,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756287124
    },
    {
        "content": "<p>Here's the MWE of what's going on:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"n\">invFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">explicit</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">b_apply</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">b_apply (α : Type) (a : α) :</span>\n<span class=\"cm\">  @Eq α</span>\n<span class=\"cm\">    (@DFunLike.coe (Equiv α α) α (fun x =&gt; α) (@EquivLike.toFunLike (Equiv α α) α α (@Equiv.instEquivLike α α)) (b α) a)</span>\n<span class=\"cm\">    (@id α a)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Actually, I don't think we can blame <code>simps</code> here. Because in the definition of <code>b</code> we are constructing a <code>B α</code>, using the <code>Equiv.mk</code> constructor.</p>",
        "id": 536382087,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756287268
    },
    {
        "content": "<p>Right, ultimately what we want on some level is a way to go \"B is a new structure, but it is a copy of <code>Equiv α α</code> and I want an easy way of copying over instances on the latter to the former\".</p>",
        "id": 536382454,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756287414
    },
    {
        "content": "<p>Because then there would be a \"<a href=\"http://B.mk\">B.mk</a>\" (which currently there is not).</p>",
        "id": 536382481,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756287427
    },
    {
        "content": "<p>Doesn't <code>structure</code> + <code>extends</code> do exactly that?</p>",
        "id": 536382575,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756287461
    },
    {
        "content": "<p>Well, it isn't clear how to copy the instances. How would you implement <code>FunLike B α α</code> if you had <code>structure B extends Equiv α α</code>.</p>",
        "id": 536382758,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756287538
    },
    {
        "content": "<p>Ah, that's true</p>",
        "id": 536383404,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756287815
    },
    {
        "content": "<p>Obviously if you use <code>abbrev</code> you have the instances and there's no issue with <code>simps</code> but you kinda have the undesirable behaviour that the \"innards\" of <code>B</code> are exposed - in the context above, we kinda want <code>Order*</code> to maybe be semi-reducible at worst.</p>",
        "id": 536383685,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1756287912
    }
]