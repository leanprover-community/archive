[
    {
        "content": "<p>I'm trying to write an elab command that does some heavy computation (about 20 minutes' worth, currently). Especially for debugging, it would be nice if I could use <code>println!</code> to see intermediate results before the whole computation is finished. But as far as I can tell, all the output is only flushed when the command is done. Minimized example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">flushTest</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"Unflushed hello!\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO.sleep</span><span class=\"w\"> </span><span class=\"mi\">500</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"Flushed hello!\"</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.getStdout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"w\">  </span><span class=\"n\">IO.sleep</span><span class=\"w\"> </span><span class=\"mi\">500</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"Bye!\"</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#flushTest\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">Elab.Command.liftCoreM</span><span class=\"w\"> </span><span class=\"n\">flushTest</span>\n\n<span class=\"bp\">#</span><span class=\"n\">flushTest</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">flushTest</span>\n</code></pre></div>\n<p>I would expect that the three <code>println!</code>s would appear with 500 ms delay between each, or at least the \"Flushed hello!\" would appear before the \"Bye!\". But both in my editor (<code>nvim</code>) and building on the command line (with <code>lean flushTest.lean</code>) all three lines appear together, after a second of waiting. On the other hand, when I execute the code (using <code>lean --run flushTest.lean</code>) the three lines do appear separately with about 500ms delay between each as I would expect.</p>\n<p>Would it be possible to flush stdout in elab commands?</p>",
        "id": 479237217,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1730109865
    },
    {
        "content": "<p>I think that this came up other times and the answer was that this was not really possible.</p>\n<p>I would be very happy to have partial information available, though, so I hope that I am wrong about this!</p>",
        "id": 479237876,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730110057
    },
    {
        "content": "<p>Try passing <code>-D stderrAsMessages=true</code> to lean</p>",
        "id": 479255908,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1730115904
    },
    {
        "content": "<p>That doesn't seem to change anything :( (Also if I replace <code>(← IO.getStdout).flush</code> with <code>(← IO.getStderr).flush</code>...)</p>",
        "id": 479256237,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1730116005
    },
    {
        "content": "<p>What if you use <code>IO.eprintln</code>?</p>",
        "id": 479295177,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1730127439
    }
]