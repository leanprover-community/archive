[
    {
        "content": "<p>I'm messing around a bit with macros, and trying to define an n-ary conditional expressions (similar to <code>cond</code> in most Lisps). Here is my current code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">All</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">âˆ§</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">All</span><span class=\"w\"> </span><span class=\"n\">ps</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">lead</span><span class=\"w\"> </span><span class=\"s2\">\"cond\"</span>\n<span class=\"w\">  </span><span class=\"n\">withPosition</span><span class=\"o\">((</span><span class=\"n\">ppDedent</span><span class=\"o\">(</span><span class=\"n\">ppLine</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">colGe</span><span class=\"w\"> </span><span class=\"n\">notFollowedBy</span><span class=\"o\">(</span><span class=\"s2\">\"| \"</span><span class=\"w\"> </span><span class=\"n\">hole</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">darrow</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"| \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">darrow</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"bp\">*</span>\n<span class=\"w\">                </span><span class=\"n\">ppDedent</span><span class=\"o\">(</span><span class=\"n\">ppLine</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">colGe</span><span class=\"w\"> </span><span class=\"s2\">\"| \"</span><span class=\"w\"> </span><span class=\"n\">hole</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">darrow</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">],</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"n\">ite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">All</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e'</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>However, Lean reports the following syntax error:<br>\n<a href=\"/user_uploads/3121/3RoMbwll37r5gczHFxtQ-d0b/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/3RoMbwll37r5gczHFxtQ-d0b/image.png\" title=\"image.png\"><img data-original-dimensions=\"749x159\" src=\"/user_uploads/thumbnail/3121/3RoMbwll37r5gczHFxtQ-d0b/image.png/840x560.webp\"></a></div><p>What am I doing wrong here? Isn't this the syntax to expand splices?<br>\nI haven't found much examples doing these kind of things, but the ones I found were working fine and I'm not sure what I messed up there.</p>",
        "id": 488877544,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1734107221
    },
    {
        "content": "<p>You can't use a splice in that position because there is no repetition in the grammar there. You should splice the syntax together manually from smaller quotations using a for loop</p>",
        "id": 488941405,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734135047
    },
    {
        "content": "<p>What do you mean by \"there is no repetition in the grammar there\"?</p>",
        "id": 489070920,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1734256873
    },
    {
        "content": "<p>You're using <code>$[...]*</code> where there is no corresponding <code>*</code> in the parser</p>",
        "id": 489074593,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734260485
    },
    {
        "content": "<p>So basically, one can only expand splices (using the <code>$[...]*</code> syntax) in places where a repetition is meant to happen?</p>",
        "id": 489086855,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1734272020
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"747895\">Ghilain Bergeron</span> has marked this topic as resolved.</p>",
        "id": 489424011,
        "sender_full_name": "Notification Bot",
        "timestamp": 1734421944
    }
]