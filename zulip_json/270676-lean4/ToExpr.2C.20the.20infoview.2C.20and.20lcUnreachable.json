[
    {
        "content": "<p>Is it reasonable for <code>ToExpr</code> to produce <code>lcUnreachable</code> terms for expressions which can only partially be reconstructed? Now that <code>#eval</code> tries to convert things back to expressions for the infoview, there is an incentive to producea partial conversion over no conversion at all.</p>",
        "id": 526902408,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751506579
    },
    {
        "content": "<p>The case I have in mind is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/-- Produces an arbitrary representation of the form `mₒ ⊗ₜ n₀ + ...`.</span>\n\n<span class=\"sd\">This is only for use in the infoview; it produces expressions containing `lcUnreachable`. ! -/</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_5</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_6</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eM</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toTypeExprQ</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_5</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">M</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eN</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toTypeExprQ</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_6</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eR</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toTypeExprQ</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"c1\">-- we have no mechanism to obtain these instances, so just insert unreachables</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">em</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">en</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">    </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">em</span><span class=\"w\"> </span><span class=\"bp\">⊗ₜ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">en</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toTypeExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eM</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">eR</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eN</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">.</span><span class=\"n\">unquot</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>where <code>lcUnreachable</code> is being used in place of typeclass instances.</p>",
        "id": 526902441,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751506612
    },
    {
        "content": "<p>I suppose another option would be to insert <code>Expr.fvar</code>s or similar, but there is no NameGenerator around.</p>",
        "id": 526902513,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751506677
    },
    {
        "content": "<p>It's not unreachable though?</p>",
        "id": 526903667,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751507717
    },
    {
        "content": "<p>This one is a bit tricky</p>",
        "id": 526903710,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751507739
    },
    {
        "content": "<p>I guess it only works if you don't try to evaluate the expression again</p>",
        "id": 526903769,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751507787
    },
    {
        "content": "<p>I guess I could use <code>sorry</code> too?</p>",
        "id": 528749625,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752531571
    },
    {
        "content": "<p>A little more concretely, here's a mathlib-free example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NonemptyInterval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The starting point of an interval is smaller than the endpoint. -/</span>\n<span class=\"w\">  </span><span class=\"n\">fst_le_snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">snd</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">irreducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toTypeExprQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">toLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">toTypeExpr</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">NonemptyInterval</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eα</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toTypeExprQ</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eα</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">lcUnreachable</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toTypeExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">NonemptyInterval</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eα</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">NonemptyInterval</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eα</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span>\n<span class=\"w\">      </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eα</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eα</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">      </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">lcProof</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- this works!</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">NonemptyInterval</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 528750388,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752531973
    },
    {
        "content": "<p>Is this use of <code>lcUnreachable</code> sane? Is there a better option?</p>",
        "id": 528750409,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752531985
    },
    {
        "content": "<p>I'll ping <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>  since I think the <code>ToExpr</code> in <code>#eval</code> was your (great!) feature</p>",
        "id": 528750481,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532022
    },
    {
        "content": "<p>I wonder if there should be a namespace you could put these sorts of instances into, scoped, so that <code>#eval</code> can activate them?</p>",
        "id": 528750636,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532097
    },
    {
        "content": "<p>Is there any harm in them being global?</p>",
        "id": 528750677,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532116
    },
    {
        "content": "<p>(but if the answer is yes, indeed that sounds like a nice idea)</p>",
        "id": 528750746,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532148
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/ToExpr.2C.20the.20infoview.2C.20and.20lcUnreachable/near/526902513\">said</a>:</p>\n<blockquote>\n<p>I suppose another option would be to insert <code>Expr.fvar</code>s or similar, but there is no NameGenerator around.</p>\n</blockquote>\n<p>An extreme version of this would be to move <code>ToExpr</code> into <code>MetaM</code> so that it can allocate synthetic metavariables</p>",
        "id": 528750839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532198
    },
    {
        "content": "<p>Having \"fake\" ToExpr instances means you can't know if the result is truly reflecting the original value, which is it's main purpose.</p>\n<p>Another idea would be to have a parallel <code>ToExprForPP</code> class that could hook into <code>ToExpr</code> somehow — maybe by adding a local instance that bridges the two?</p>",
        "id": 528750985,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532269
    },
    {
        "content": "<p>There could also be a version of this that creates Syntax directly in some sort of Delab-like monad, with ToExpr being the base case (that's not great though, since you'd want it to be able to make use of these Delab instances for subexpressions).</p>",
        "id": 528751090,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532329
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/ToExpr.2C.20the.20infoview.2C.20and.20lcUnreachable/near/528750985\">said</a>:</p>\n<blockquote>\n<p>Another idea would be to have a parallel <code>ToExprForPP</code> class that could hook into <code>ToExpr</code> somehow — maybe by adding a local instance that bridges the two?</p>\n</blockquote>\n<p>This sounds impractical to me, since printing <code>List (MyUnreflectableType)</code> is going to make code duplication for <code>List</code></p>",
        "id": 528751205,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532387
    },
    {
        "content": "<p>Maybe <code>Lean.ToExpr T</code> could become <code>Lean.ToExpr T (lossy := false)</code>, and then the pp one would set <code>lossy : Bool</code> to <code>true</code></p>",
        "id": 528751263,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532420
    },
    {
        "content": "<p>So the container instances could just propagate the boolean unmodified</p>",
        "id": 528751300,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532436
    },
    {
        "content": "<p>What's the impracticality? I'd have thought that with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">instOfToExprForPP</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>then <code>#eval</code> could add <code>instOfToExprForPP</code> as a local instance when synthesizing a way to pretty print the result.</p>",
        "id": 528751493,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532540
    },
    {
        "content": "<p>It feels like a wart that <code>ToExprForPP (List MyUnreflectableType)</code> won't synthesize without the local instance</p>",
        "id": 528751578,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532594
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 528751614,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532617
    },
    {
        "content": "<p>Though I guess you could just write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instOfToExprForPP</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstance</span>\n</code></pre></div>",
        "id": 528751681,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532654
    },
    {
        "content": "<p>I don't think you'd ever have anything take <code>ToExprForPP</code> instances, just <code>ToExpr</code>. The only place <code>ToExprForPP</code> would need to appear is after the colon in the instance being defined.</p>",
        "id": 528751889,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532766
    },
    {
        "content": "<p>Loogle says there are <a href=\"https://loogle.lean-lang.org/?q=Lean.ToExpr+_+%E2%86%92+Lean.ToExpr+_\">9 instances matching <code>Lean.ToExpr _ → Lean.ToExpr _</code></a>, so adding such shortcuts by hand doesn't seem too bad</p>",
        "id": 528751901,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532772
    },
    {
        "content": "<p>Why would we be adding these shortcuts?</p>",
        "id": 528751976,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752532810
    },
    {
        "content": "<p>I'm thinking about an end user writing <code>#synth ToExprForPP (NotReflectable × List NotReflectable)</code> or similar to check that they set up their instances correcty, but it not working without <code>instOfToExprForPP </code> being scoped</p>",
        "id": 528752060,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532850
    },
    {
        "content": "<p>It's a little weird to have a typeclass whose useful instances aren't discoverable without opening a scope</p>",
        "id": 528752210,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752532935
    },
    {
        "content": "<p>Spelled out a bit more explicitly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">InCore</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">PP</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instOfToExprForPP</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">PP</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">InCore</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">UserCode</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PP</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- works</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PP</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- works, but should fail</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- this should work too</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails, as desired</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PP</span><span class=\"bp\">.</span><span class=\"n\">instOfToExprForPP</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstance</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- now works without the `open`</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- still fails, as desired</span>\n</code></pre></div>",
        "id": 528752534,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752533140
    },
    {
        "content": "<p>I think I claim that without the <code>ToExprForPP (List α)</code> instance this approach offers little over just declaring a preferred scope and telling users to put things in it</p>",
        "id": 528752711,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752533255
    },
    {
        "content": "<p>Making <code>ToExprForPP</code> work without enabling the scoped instance seems rather low priority to me. You're proposing that every downstream parameterized type needs to make a ToExprForPP instance too, right? That seems to be rather unfriendly.</p>\n<p>(Can we avoid the \"just\" word? If <code>ToExprForPP</code> offers little over \"just\" declaring a preferred scope, then you're saying they are just about equivalent, right? Then what basis are you comparing them against to say \"just\"? I am assuming you're saying \"using a scoped namespace avoids needing a separate <code>class</code>\", but it's worth spelling out exactly how you are evaluating this.)</p>\n<p>One possible reason to prefer a local instance to hook in these \"partial\" ToExpr instances: there's only a single instance that needs to be activated, rather than temporarily activating arbitrary number of instances. That's O(1) vs O(n).</p>",
        "id": 528753457,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752533724
    },
    {
        "content": "<p>Oh, I had forgotten that <code>open scoped</code> was O(n) !</p>",
        "id": 528753581,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752533808
    },
    {
        "content": "<p>This all said, I wish there were a better system for pretty printing <code>#eval</code> results. The autoderiving of ToExpr instances is not currently recursive (and it doesn't help you debug which ToExpr instances are missing), and there's no way to include arbitrary syntax, except by creating dummy Exprs that have custom pretty printers.</p>",
        "id": 528754066,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752534069
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/ToExpr.2C.20the.20infoview.2C.20and.20lcUnreachable/near/528754066\">said</a>:</p>\n<blockquote>\n<p>and there's no way to include arbitrary syntax, except by creating dummy Exprs that have custom pretty printers.</p>\n</blockquote>\n<p>This somewhat feels like a feature to me, as it helps enforce that the Exprs are actually well-formed!</p>",
        "id": 528754130,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752534110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/ToExpr.2C.20the.20infoview.2C.20and.20lcUnreachable/near/528751263\">said</a>:</p>\n<blockquote>\n<p>Maybe <code>Lean.ToExpr T</code> could become <code>Lean.ToExpr T (lossy := false)</code>, and then the pp one would set <code>lossy : Bool</code> to <code>true</code></p>\n</blockquote>\n<p>I tried an implementation of this, which works though is perhaps a confusing interface</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">InCore</span>\n\n<span class=\"c1\">-- replace `ToExpr`</span>\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppOnly</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n\n<span class=\"n\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- Any perfcet instance is accepted when a ppOnly one would suffice -/</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"n\">ToExpr.forPP</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- instances for parameterized types can propagate the `ppOnly` instance</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">ppOnly</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ppOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">ppOnly</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">ppOnly</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ppOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">InCore</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">UserCode</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"w\"> </span><span class=\"n\">where</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- works</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- fails, as intended</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ToExprForPP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NotReflectable</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n</div></div>\n<p><del>but without some worse typeclass hacks the <code>Prod</code> instance is not well-behaved</del></p>",
        "id": 528754383,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752534258
    },
    {
        "content": "<p>Edited to match your proposed names</p>",
        "id": 528754699,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752534433
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/ToExpr.2C.20the.20infoview.2C.20and.20lcUnreachable/near/528754066\">said</a>:</p>\n<blockquote>\n<p>The autoderiving of ToExpr instances is not currently recursive</p>\n</blockquote>\n<p>Oh, so you mean it doesn't add <code>[ToExpr _]</code> assumptions to the instance?</p>",
        "id": 528754810,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752534509
    },
    {
        "content": "<p>It adds those, definitely. The problem is that if you for example have a <code>List MyType</code> it won't auto-derive the <code>ToExpr MyType</code> instance.</p>",
        "id": 528754901,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752534557
    },
    {
        "content": "<p>Taking a step back, do you think it would be reasonable to add the unscoped <code>ToExpr</code> instances to mathlib if labelled with a Lean RFC of some kind?</p>",
        "id": 528755152,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752534684
    },
    {
        "content": "<p>Maybe instead of <code>lcUnreachable</code> you should use <code>sorry</code>, and maybe you could use an <code>unsafe instance</code> for this for the time being, to prevent it from accidentally being used in normal code?</p>\n<p><code>#eval</code> does work with <code>unsafe</code> instances:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Baz</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">Baz</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``sorryAx</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelOne</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">toTypeExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Baz</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Baz</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n</code></pre></div>\n<p>Rationale for avoiding <code>lcUnreachable</code>: if it ever slips into some actual expressions, evaluating it is undefined behavior, and also the compiler reasons about it in optimizations.</p>",
        "id": 528770208,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752547030
    },
    {
        "content": "<p>Another idea would be a type class like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToInstanceExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toInstanceExpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n</code></pre></div>\n<p>although that means a lot of instances to make</p>",
        "id": 529421721,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1752829674
    }
]