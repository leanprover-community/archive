[
    {
        "content": "<p>Can I  use a type with two different universes in the same declaration?<br>\ne.g. if I have <code>def foo {m : Type u -&gt; Type v}</code> can I use <code>m</code> with two different universes in the same formula?</p>",
        "id": 224370058,
        "sender_full_name": "Calvin Lee",
        "timestamp": 1611858138
    },
    {
        "content": "<p>If they're different <code>m</code>'s, then yes. You  can even be explicit with universes if needed.  Here's setting <code>u=0</code> and <code>v=1</code>: <code>foo.{0, 1}</code>.  This notation works with universe variables, too.</p>",
        "id": 224371502,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1611858748
    },
    {
        "content": "<p><em>In the definition of <code>foo</code></em> you cannot use <code>m</code> with a different universe level: you only have one <code>m</code> that has type <code>Type u -&gt; Type v</code>, and <code>u</code> and <code>v</code> are fixed in the definition of <code>foo</code>. <br>\n<em>After you have declared <code>foo</code></em> you can use it with <code>u</code> and <code>v</code> instantiated however you want.</p>",
        "id": 224372213,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1611859040
    },
    {
        "content": "<p>Is there any way to make a tuple of items in two different universes? e.g. could I have <code>def foo {m : Type u -&gt; Type v} {a : Type u} ... : Option (m a, a)</code> because I'm trying to do something like this and getting some type errors</p>",
        "id": 224372930,
        "sender_full_name": "Calvin Lee",
        "timestamp": 1611859349
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 224373309,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1611859548
    },
    {
        "content": "<p>I think you want <code>Option (m a × a)</code></p>",
        "id": 224373324,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1611859556
    },
    {
        "content": "<p>and this should work even if <code>m a</code> and <code>a</code> are in different universes</p>",
        "id": 224373405,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1611859574
    },
    {
        "content": "<p>If you have a pair, you can just take a product.<br>\nIf you need a sequence with <code>n</code> elements, this gets inconvenient, but it is possible with <code>Ulift</code>.</p>",
        "id": 224373499,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1611859615
    },
    {
        "content": "<p>I want my definition of category to depend on a choice of universe or something like that. Here's what I've got going right now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">notation</span> <span class=\"s2\">\"(\"</span>  <span class=\"n\">x</span>  <span class=\"s2\">\":\"</span>  <span class=\"n\">X</span>  <span class=\"s2\">\")\"</span> <span class=\"s2\">\"↦\"</span> <span class=\"n\">F</span> <span class=\"bp\">=&gt;</span> <span class=\"o\">(</span><span class=\"k\">fun</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">F</span><span class=\"o\">)</span>\n<span class=\"kd\">notation</span> <span class=\"s2\">\"Σ\"</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">X</span> <span class=\"s2\">\":\"</span> <span class=\"n\">A</span> <span class=\"s2\">\")\"</span> <span class=\"s2\">\":\"</span> <span class=\"n\">F</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">Σ'</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"o\">:</span> <span class=\"n\">A</span><span class=\"o\">),</span> <span class=\"n\">F</span>\n<span class=\"kd\">notation</span> <span class=\"s2\">\"Π\"</span> <span class=\"s2\">\"(\"</span> <span class=\"n\">X</span> <span class=\"s2\">\":\"</span> <span class=\"n\">A</span> <span class=\"s2\">\")\"</span> <span class=\"s2\">\":\"</span> <span class=\"n\">F</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">forall</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"o\">:</span> <span class=\"n\">A</span><span class=\"o\">),</span> <span class=\"n\">F</span>\n<span class=\"kd\">notation</span> <span class=\"s2\">\"*\"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">Unit.unit</span>\n<span class=\"kd\">notation</span> <span class=\"s2\">\"⊛\"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">Unit</span>\n<span class=\"kd\">notation</span> <span class=\"n\">x</span> <span class=\"s2\">\"==\"</span> <span class=\"n\">y</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">x</span><span class=\"bp\">=</span><span class=\"n\">y</span><span class=\"o\">):</span><span class=\"bp\">⊛</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">Cat</span> <span class=\"o\">:=</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">Obj</span><span class=\"o\">:</span><span class=\"kt\">Type</span> <span class=\"mi\">1</span><span class=\"o\">):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">Hom</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):(</span><span class=\"kt\">Type</span> <span class=\"mi\">1</span><span class=\"o\">)):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">Id</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):(</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">X</span><span class=\"o\">)):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">Comp</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Z</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">Y</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span><span class=\"o\">):(</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">Z</span><span class=\"o\">)):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">Y</span><span class=\"o\">):(</span><span class=\"n\">Comp</span> <span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Id</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"bp\">==</span> <span class=\"n\">f</span><span class=\"o\">):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">Y</span><span class=\"o\">):(</span><span class=\"n\">Comp</span> <span class=\"n\">X</span> <span class=\"n\">X</span> <span class=\"n\">Y</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">Id</span> <span class=\"n\">X</span><span class=\"o\">)</span> <span class=\"n\">f</span> <span class=\"bp\">==</span> <span class=\"n\">f</span><span class=\"o\">):</span>\n<span class=\"bp\">Σ</span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">:</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">Z</span><span class=\"o\">:</span><span class=\"n\">Obj</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">W</span> <span class=\"n\">X</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">X</span> <span class=\"n\">Y</span><span class=\"o\">):</span><span class=\"bp\">Π</span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"n\">Hom</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span><span class=\"o\">):(</span><span class=\"n\">Comp</span> <span class=\"n\">W</span> <span class=\"n\">X</span> <span class=\"n\">Z</span><span class=\"o\">)</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">Comp</span> <span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"n\">g</span> <span class=\"n\">h</span><span class=\"o\">)</span> <span class=\"bp\">==</span> <span class=\"n\">Comp</span> <span class=\"n\">W</span> <span class=\"n\">Y</span> <span class=\"n\">Z</span> <span class=\"o\">(</span><span class=\"n\">Comp</span> <span class=\"n\">W</span> <span class=\"n\">X</span> <span class=\"n\">Y</span> <span class=\"n\">f</span> <span class=\"n\">g</span><span class=\"o\">)</span> <span class=\"n\">h</span><span class=\"o\">):</span>\n<span class=\"bp\">⊛</span>\n</code></pre></div>\n<p>As you can see, Cat is a 7-tuple. I hope my notation isn't too purist.</p>\n<p>But I would like to switch Type 1 for something more general. How would I make it depend on a universe?</p>",
        "id": 319260342,
        "sender_full_name": "Kind Bubble",
        "timestamp": 1672772291
    },
    {
        "content": "<p>What happens if you replace the <code>1</code>s with <code>_</code>? Or with universe parameters?</p>",
        "id": 319262317,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1672772968
    },
    {
        "content": "<p>Also, what's the reason for introducing these notations?</p>",
        "id": 319262371,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1672772994
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/270676-lean4/topic/Universes/near/319262317\">said</a>:</p>\n<blockquote>\n<p>What happens if you replace the <code>1</code>s with <code>_</code>? Or with universe parameters?</p>\n</blockquote>\n<p>I don't know about this yet. How does that work? And what is the most general option?</p>",
        "id": 319262384,
        "sender_full_name": "Kind Bubble",
        "timestamp": 1672773001
    },
    {
        "content": "<p>An underscore will be an unspecified universe parameter, making your definition universe polymorphic.</p>",
        "id": 319262502,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1672773035
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/270676-lean4/topic/Universes/near/319262502\">said</a>:</p>\n<blockquote>\n<p>An underscore will be an unspecified universe parameter, making your definition universe polymorphic.</p>\n</blockquote>\n<p>ok this is good.</p>",
        "id": 319262633,
        "sender_full_name": "Kind Bubble",
        "timestamp": 1672773095
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"559197\">Kind Bubble</span> <a href=\"#narrow/stream/270676-lean4/topic/Universes/near/319262633\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/270676-lean4/topic/Universes/near/319262502\">said</a>:</p>\n<blockquote>\n<p>An underscore will be an unspecified universe parameter, making your definition universe polymorphic.</p>\n</blockquote>\n<p>ok this is good.</p>\n</blockquote>\n<p>And this will work for any universe now? Is the underscore the most general option?</p>",
        "id": 319262853,
        "sender_full_name": "Kind Bubble",
        "timestamp": 1672773160
    },
    {
        "content": "<p>An underscore will be (essentially) equivalent to introducing arbitrary universe variables and replacing the 1s with those variables.</p>",
        "id": 319263141,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1672773252
    },
    {
        "content": "<p>If you want to specify the universe parameters in a certain order, which can be useful sometimes (particularly in category theory!!) then you should introduce and use those variables explicitly</p>",
        "id": 319263286,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1672773313
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/270676-lean4/topic/Universes/near/319263141\">said</a>:</p>\n<blockquote>\n<p>An underscore will be (essentially) equivalent to introducing arbitrary universe variables and replacing the 1s with those variables.</p>\n</blockquote>\n<p>Ok thanks for your help. This is good.</p>",
        "id": 319263974,
        "sender_full_name": "Kind Bubble",
        "timestamp": 1672773580
    },
    {
        "content": "<p>You can also explicitly introduce universes with the <code>def Cat.{u,v} := ...</code> syntax, using <code>u</code> and <code>v</code> as levels like <code>Type u</code> and <code>Type v</code>. The main advantage of doing so is that the _ might be filled in with concrete universe levels (if something constrains them to a concrete level), whereas the explicit universes will raise a type error if accidentally constrained somehow.</p>",
        "id": 319264798,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1672773899
    },
    {
        "content": "<p>I know you've read here that universes don't matter, but I would like to implement the type of trees that gives (would give) rise to Russell's paradox, as explained in <a href=\"https://people.cs.nott.ac.uk/psztxa/ewscs-17/notes.pdf\">Thorsten Altenkirch's notes</a>.</p>\n<p>Here, a tree is just a note followed by a collection of true. Here is a possible definition, where the collection is a member of <code>Type 0</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TATree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TATree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TATree</span>\n</code></pre></div>\n<p>This gives <code>TATree : Type 1</code>, but I would like to allow more general collections, say, <code>I : Type u</code>, for some universe <code>u</code>, and I didn't manage the provide a definition that the compiler would accept.</p>",
        "id": 525028793,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1750420507
    },
    {
        "content": "<p><a href=\"#narrow/channel/270676-lean4/topic/Universes/near/525028793\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/IO.2EProcess.2Espawn.20doesn.27t.20work.20on.20Windows/with/524864822\">#lean4 &gt; IO.Process.spawn doesn't work on Windows</a> by <span class=\"user-mention silent\" data-user-id=\"130609\">Antoine Chambert-Loir</span>.</p>",
        "id": 525028962,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750420578
    },
    {
        "content": "<p>The error message in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TBTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"c1\">-- doesn't work</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TBTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TBTree</span>\n</code></pre></div>\n<p>suggests to me that the result (in <code>Type v</code>) should be at <code>max (u + 2) (v + 1)</code>, so that any universe <code>v</code> such that <code>u + 1 ≤ v</code>should work.<br>\nBut</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span>\n</code></pre></div>\n<p>gives an even more cryptic error message.</p>",
        "id": 525030149,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1750421053
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span>\n</code></pre></div>\n<p>works but oh god what the hell is that error message</p>",
        "id": 525030640,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750421244
    },
    {
        "content": "<p>There' s something fishy going on:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span>\n</code></pre></div>\n<p>The first two work, the last one fails...</p>",
        "id": 525031071,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750421424
    },
    {
        "content": "<p>I think it fails to generate the below and brec?</p>",
        "id": 525056888,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750431071
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> <a href=\"#narrow/channel/270676-lean4/topic/Universes/near/525031071\">said</a>:</p>\n<blockquote>\n<p>There' s something fishy going on:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree'</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span>\n</code></pre></div>\n<p>The first two work, the last one fails...</p>\n</blockquote>\n<p>Since <code>imax 0 u</code> and <code>imax 1 u</code> both reduce, but <code>imax 2 u</code> does not</p>",
        "id": 525057832,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750431411
    },
    {
        "content": "<p>Do we agree that something like this should work? What does <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> think?</p>",
        "id": 525166867,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1750521485
    },
    {
        "content": "<p>this looks like a bit of a nightmare case TBH</p>",
        "id": 525166927,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750521579
    },
    {
        "content": "<p>the details around which kinds of nested inductives are allowed are not very well defined</p>",
        "id": 525166953,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750521605
    },
    {
        "content": "<p>right now the only thing we have is some code and whatever that code accepts is legal</p>",
        "id": 525166972,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750521624
    },
    {
        "content": "<p>Thanks for the clarification.</p>",
        "id": 525167748,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1750522563
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"432410\">@Arthur Adjedj</span> do you have any opinion here?</p>",
        "id": 525167881,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750522768
    },
    {
        "content": "<p>It looks like the inductive itself is accepted but one of the generated functions fails</p>",
        "id": 525167921,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750522832
    },
    {
        "content": "<p>ah yes, this is not a kernel issue at all</p>",
        "id": 525167979,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750522945
    },
    {
        "content": "<p>you can <code>#print TCTree</code> immediately afterward and see that the declaration has been added to the environment even though it errored</p>",
        "id": 525168000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750522980
    },
    {
        "content": "<p>As far as I can see, the <code>sizeOf</code> auxiliary definitions are where it's failing.</p>",
        "id": 525168052,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523054
    },
    {
        "content": "<p>Ah nevermind, the order in which declarations appear with<code>whatsnew in</code> is not too consistent.</p>",
        "id": 525168104,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523124
    },
    {
        "content": "<p><code>TCTree''.below</code>s and <code>TCTree''.brecOn</code>s seem to be added as axioms instead of defs in the environment, I'm guessing it means the issue is happening there.</p>",
        "id": 525168182,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523248
    },
    {
        "content": "<p>are you sure? I see them as defs via print</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"bp\">.</span><span class=\"n\">brecOn</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"bp\">.</span><span class=\"n\">below</span>\n</code></pre></div>",
        "id": 525168248,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750523369
    },
    {
        "content": "<p>That's confusing, <code>whatsnew</code> shows me an axiom, but <code>#check</code> shows a def:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"n\">whatsnew</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span>\n<span class=\"c\">/-</span><span class=\"cm\">protected axiom TCTree''.below_1.{u} : {motive_1 : TCTree'' → Sort u} →</span>\n<span class=\"cm\">  {motive_2 : (I : Type 1) × (I → TCTree'') → Sort u} → (I : Type 1) × (I → TCTree'') → Sort (max 1 u)-/</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"bp\">.</span><span class=\"n\">below_1</span>\n<span class=\"c\">/-</span><span class=\"cm\">@[reducible] protected def TCTree''.below_1.{u} : {motive_1 : TCTree'' → Sort u} →</span>\n<span class=\"cm\">  {motive_2 : (I : Type 1) × (I → TCTree'') → Sort u} → (I : Type 1) × (I → TCTree'') → Sort (max 1 u) :=</span>\n<span class=\"cm\">fun {motive_1} {motive_2} t =&gt;</span>\n<span class=\"cm\">  TCTree''.rec_1 (fun a a_ih =&gt; motive_2 a ×' a_ih)</span>\n<span class=\"cm\">    (fun fst snd snd_ih =&gt; ((a : fst) → motive_1 (snd a)) ×' ((a : fst) → snd_ih a)) t-/</span>\n</code></pre></div>",
        "id": 525168325,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523474
    },
    {
        "content": "<p>maybe this has something to do with asynchronous environments</p>",
        "id": 525168355,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750523517
    },
    {
        "content": "<p>Are unrealized consts pretty-printed as axioms before they're realized ? would make sense.</p>",
        "id": 525168376,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523558
    },
    {
        "content": "<p>I don't think they should be, I just expect that <code>whatsnew in</code> hasn't been updated properly</p>",
        "id": 525168417,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750523594
    },
    {
        "content": "<p>Is there any chance <code>#whatsnew</code> also shows decls that have been added to the elab env before they've been validated in the kernel's env, leading false infos as to what really is available ?</p>",
        "id": 525168511,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523722
    },
    {
        "content": "<p>Because otherwise, I don't see what's supposedly failing here, the <a href=\"https://www.diffchecker.com/RlIkoIA4/\">diff</a> doesn't show much difference.</p>",
        "id": 525168537,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750523756
    },
    {
        "content": "<p>It works if you don't import anything</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">prelude</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">pp_using_anonymous_constructor</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">  </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">fst</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">unbox</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Sigma</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Sigma</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span>\n</code></pre></div>",
        "id": 525168757,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750524032
    },
    {
        "content": "<p>The <code>(kernel) application type mismatch</code> errors are from the same constants that <code>whatsnew in</code> reports as axioms</p>",
        "id": 525168983,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750524314
    },
    {
        "content": "<p>yes, the errors are in <code>TCTree''.below</code>, <code>TCTree''.below_1</code>, <code>TCTree''.brecOn</code>, <code>TCTree''.brecOn_1</code> in that order</p>",
        "id": 525169016,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750524360
    },
    {
        "content": "<p>the errors in <code>brecOn</code> seem to be because <code>TCTree''.below</code> doesn't unfold, so it was probably added as an axiom</p>",
        "id": 525169036,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750524394
    },
    {
        "content": "<p>and it seems that <code>TCTree''.below</code> was added to the environment despite the type error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">motive_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">TCTree''</span><span class=\"bp\">.</span><span class=\"n\">below</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"n\">delta</span><span class=\"w\"> </span><span class=\"n\">TCTree''</span><span class=\"bp\">.</span><span class=\"n\">below</span><span class=\"w\"> </span><span class=\"c1\">-- kernel error here</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 525169283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750524772
    },
    {
        "content": "<p>and the underlying issue is that <code>#check Sort (max (max 1 (imax 2 u)) 2 u) = Sort (max 1 u)</code> fails (correctly, these are not the same for <code>u = 1</code>)</p>",
        "id": 525169432,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750524983
    },
    {
        "content": "<p>somehow the code has decided that <code>TCTree''.below</code> should live in <code>Sort (max 1 u)</code> but that universe is not big enough</p>",
        "id": 525169531,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750525116
    },
    {
        "content": "<p>indeed, bumping the universe for <code>below</code> to <code>max 2 u</code> seems to fix the issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"bp\">.</span><span class=\"n\">below'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">motive_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TCTree</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive_2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">TCTree</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a_ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">motive_2</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">a_ih</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">snd_ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">snd_ih</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span>\n</code></pre></div>",
        "id": 525169552,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750525142
    },
    {
        "content": "<p>That code was recently touched by <span class=\"user-mention\" data-user-id=\"497571\">@Parth Shastri</span> , maybe it got fixed along the way?<br>\n<a href=\"https://github.com/leanprover/lean4/pull/7639\">https://github.com/leanprover/lean4/pull/7639</a></p>\n<hr>\n<p>No it didn't</p>",
        "id": 525176562,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750536263
    },
    {
        "content": "<p>My change in <a href=\"https://github.com/leanprover/lean4/pull/7639\">#7639</a> only affected reflexive inductive types. Even though <code>TCTree</code> should be considered reflexive (it contains <code>I → TCTree</code>), the way the kernel handles nested inductives makes it miss this case, and so the generated <code>below</code>/<code>brecOn</code> implementation uses the non-reflexive universe calculation, which is incorrect. I believe that with my previous change, the separate non-reflexive universe calculation is no longer needed, and I have opened <a href=\"https://github.com/leanprover/lean4/pull/8937\">#8937</a> to change the implementation to use the new universe calculation in all cases.</p>",
        "id": 525264669,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1750661391
    },
    {
        "content": "<p>Thanks! <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, <span class=\"user-mention\" data-user-id=\"432410\">@Arthur Adjedj</span> , since you have been looking at this here already, do you agree that this is a good fix?</p>",
        "id": 525267893,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750662829
    },
    {
        "content": "<p>LGTM. I think this also warrants some fix in the kernel to ensure the <code>reflexive</code> field is correctly set on such nested inductive types, but the field is not used in the kernel in practice, so this is not critical.</p>",
        "id": 525291046,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1750671182
    }
]