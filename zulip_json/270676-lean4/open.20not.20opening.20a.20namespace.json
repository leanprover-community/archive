[
    {
        "content": "<p>Is the following behavior intended?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"bp\">.</span><span class=\"n\">A</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> unknown identifier 'foo' -/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>I would expect <code>open A</code> to open <code>_root_.A</code> even though the current namespace ends with <code>.A</code>.</p>",
        "id": 491436479,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735674412
    },
    {
        "content": "<p>Compare with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> A.foo : Nat -/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 491436538,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735674481
    },
    {
        "content": "<p>I'm a bit surprised by this, because when I last read the <code>open</code> source code, <code>open A</code> opens <em>all</em> namespaces that <code>A</code> resolves to.</p>",
        "id": 491441289,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1735678518
    },
    {
        "content": "<p>since there has been no feedback for a while, I've done some more digging, and I've traced it back to how Lean interprets syntax itself</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">B</span><span class=\"bp\">.</span><span class=\"n\">foo1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"bp\">.</span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Test1</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"c1\">-- ... [Lean.Syntax.Preresolved.namespace `A.B]</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"bp\">|</span><span class=\"n\">B</span><span class=\"o\">)</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Test1</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Test2</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"c1\">-- ... [Lean.Syntax.Preresolved.namespace `B, Lean.Syntax.Preresolved.namespace `A.B]</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"bp\">|</span><span class=\"n\">B</span><span class=\"o\">)</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Test2</span>\n</code></pre></div>",
        "id": 547806749,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761770041
    },
    {
        "content": "<p>Lean decides what to open based on how it interprets the syntax, and in this case we can see that in Test1, at the level of syntax already something has gone wrong, where the namespace `B didn't get detected at all</p>",
        "id": 547806839,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761770073
    },
    {
        "content": "<p>and my intuition is that further digging might require reading C++ code</p>",
        "id": 547807057,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761770147
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> might you have any clue?</p>",
        "id": 547807088,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761770157
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/11014\">lean4#11014</a></p>",
        "id": 547809019,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761770904
    },
    {
        "content": "<p>I think the reason is that when you have a setup like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>we want the <code>#eval foo</code> to use the <code>foo</code> from the inner namespace and not the outer namespace; but if we resolved to both  <code>A.foo</code> and <code>_root_.foo</code>, we'd get an \"ambiguous identifier\" error. So we only resolve to the inner identifier and ignore the outer ones. This might not be the right behavior though when we <em>expect</em> multiple resolutions like in <code>open</code>.</p>",
        "id": 547816000,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1761773516
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> do you have a proposed solution</p>",
        "id": 547817303,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761774111
    },
    {
        "content": "<p>Well, we could explicitly distinguish between these two cases in name resolution using some kind of flag but I'm not quite sure whether that's a good idea</p>",
        "id": 547817450,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1761774178
    }
]