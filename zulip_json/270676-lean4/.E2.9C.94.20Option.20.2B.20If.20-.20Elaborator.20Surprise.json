[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> and I just found a combination of Option + If, where the elaborator behaves unexpectedly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">e : Option (BitVec 32)</span>\n<span class=\"cm\">⊢ (do</span>\n<span class=\"cm\">    let x ← e</span>\n<span class=\"cm\">    let __do_jp : BitVec 32 → Option (BitVec 32) := fun x =&gt; do</span>\n<span class=\"cm\">      let x_1 ← e</span>\n<span class=\"cm\">      some ((x ^^^ 1#32) + (x_1 ^^^ 1234#32))</span>\n<span class=\"cm\">    if 8#32 ≥ x then do</span>\n<span class=\"cm\">        let y ← none</span>\n<span class=\"cm\">        __do_jp y</span>\n<span class=\"cm\">      else do</span>\n<span class=\"cm\">        let y ← pure ((x ^^^ 1234#32) &gt;&gt;&gt; 8#32)</span>\n<span class=\"cm\">        __do_jp y) =</span>\n<span class=\"cm\">  some 12</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1234</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1234</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">e : Option (BitVec 32)</span>\n<span class=\"cm\">⊢ (do</span>\n<span class=\"cm\">    let x ← e</span>\n<span class=\"cm\">    let x ← if 8#32 ≥ x then none else pure ((x ^^^ 1234#32) &gt;&gt;&gt; 8#32)</span>\n<span class=\"cm\">    let x_1 ← e</span>\n<span class=\"cm\">    some ((x ^^^ 1#32) + (x_1 ^^^ 1234#32))) =</span>\n<span class=\"cm\">  some 12</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1234</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"mi\">1234</span><span class=\"bp\">#</span><span class=\"mi\">32</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 480258629,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730590092
    },
    {
        "content": "<p>In particular, the <code>()</code> around the if, seem to change the way this code is elaborated.</p>",
        "id": 480258653,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730590135
    },
    {
        "content": "<p>Is this expected?</p>",
        "id": 480258660,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730590143
    },
    {
        "content": "<p>I think the reason is that <code>let x &lt;- if ...</code> is <code>do</code> notation syntax, but adding parentheses turns the <code>if</code> into the <code>if</code> term. (Semantically meaningful parentheses are certainly surprising!)</p>",
        "id": 480260919,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730592433
    },
    {
        "content": "<p>Interesting.</p>",
        "id": 480261263,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730592756
    },
    {
        "content": "<p>Given that both de-elaborate to the version without parenthesis, there seems to be at least some issue here.</p>",
        "id": 480261276,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730592776
    },
    {
        "content": "<p>Maybe the issue is the de-elaborator not printing the right set of parenthesis.</p>",
        "id": 480261317,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730592835
    },
    {
        "content": "<p>The delaborator is definitely not aware of this parenthesization rule. The only thing it knows about are precedence levels for deciding where to insert discretionary parentheses...</p>",
        "id": 480261816,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730593297
    },
    {
        "content": "<p>(Feel free to make an issue for this)</p>",
        "id": 480261830,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730593311
    },
    {
        "content": "<p>OK, I will. Thank you.</p>",
        "id": 480261840,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730593322
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> has marked this topic as resolved.</p>",
        "id": 480355329,
        "sender_full_name": "Notification Bot",
        "timestamp": 1730685190
    }
]