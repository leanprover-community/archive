[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsingleton</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Let's say you have a very long proof of the theorem \"any additive magma is subsingleton\", so you'd want to sorry it first and then move on, but to your horror you notice that everything afterwards pass, and then as you inspect what was happening to the sorried instance, you discover to your horror:</p>\n<p><a href=\"/user_uploads/3121/QB5kBB8ki80ltnlaME08-zAo/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/QB5kBB8ki80ltnlaME08-zAo/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"920x185\" src=\"/user_uploads/thumbnail/3121/QB5kBB8ki80ltnlaME08-zAo/image.png/840x560.webp\"></a></div>",
        "id": 544585290,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760371289
    },
    {
        "content": "<p>yep, Lean automatically removed the unused <code>[Add G]</code> for you</p>",
        "id": 544585356,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760371312
    },
    {
        "content": "<p>now obviously mathlib does not allow sorries, but sorries are commonplace in downstream repos, and if you aren't careful you might end up proving something very strong <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 544585470,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760371352
    },
    {
        "content": "<p>This is a public call to all downstream repo projects, really, check your sorried instances!</p>",
        "id": 544586538,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760371779
    },
    {
        "content": "<p>Another fun issue with using <code>sorry</code> for instances is if you have multiple universe level parameters and some are supposed to be determined by the instance (you see this happen in category theory, where the parameter for the size of the hom sets is determined by the instance). This can lead to some overly general instances as well, but the risk here doesn't seem to be correctness, just that you start getting into impossible-to-figure-out situations.</p>",
        "id": 544587723,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1760372292
    },
    {
        "content": "<p>Another interpretation of this behaviour is that you should be careful of relying on <code>variable</code> for <code>def</code> and <code>instance</code>!</p>\n<p>I think it generally helps readability to explicitly write out all the explicit arguments for every <code>def</code> and <code>instance</code>.</p>",
        "id": 544638450,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1760402345
    },
    {
        "content": "<p>I'm confused now about how <code>variable</code> is meant to work, orthogonal to any occurrence of <code>sorry</code>. Consider :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"sd\">/-- info: foo1.{u} (G : Type u) (g : G) : g = g -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo1</span>\n<span class=\"sd\">/-- info: foo2.{u} (G : Type u) [Add G] (g : G) : g + g = g + g -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo2</span>\n</code></pre></div>\n<p>I read in <a href=\"https://lean-lang.org/doc/reference/latest/Namespaces-and-Sections/#Lean___Parser___Command___variable\">the language reference</a> that </p>\n<blockquote>\n<p>When the name of a section variable is encountered in a non-theorem declaration, it is added as a parameter. Any instance implicit section variables that mention the variable are also added.</p>\n</blockquote>\n<p>This would make me think that <code>[Add G]</code> should be added whenever <code>G</code> is mentioned. Specifically, I would have expected <code>foo</code> would have had <code>[Add G]</code>. Am I misreading the spec?</p>\n<p>(the behavior I seem to be seeing --- that instance implicits are added if they're actually <em>used</em> --- doesn't seem to be an unreasonable or undesirable behavior, though)</p>",
        "id": 544812006,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760465826
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"662452\">Jason Reed</span> <a href=\"#narrow/channel/270676-lean4/topic/the.20danger.20of.20sorried.20instances/near/544812006\">said</a>:</p>\n<blockquote>\n<p>I read in <a href=\"https://lean-lang.org/doc/reference/latest/Namespaces-and-Sections/#Lean___Parser___Command___variable\">the language reference</a> that </p>\n<blockquote>\n<p>When the name of a section variable is encountered in a non-theorem declaration, it is added as a parameter. Any instance implicit section variables that mention the variable are also added.</p>\n</blockquote>\n<p>This would make me think that <code>[Add G]</code> should be added whenever <code>G</code> is mentioned. Am I misreading the spec?</p>\n<p>(the behavior I seem to be seeing --- that instance implicits are added if they're actually <em>used</em> --- doesn't seem to be an unreasonable or undesirable behavior, though)</p>\n</blockquote>\n<p>It's added but then it wasn't used so at the end it's removed</p>",
        "id": 544812546,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760466066
    },
    {
        "content": "<p>Huh, ok. Removed by what process?</p>",
        "id": 544812651,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466103
    },
    {
        "content": "<p>There are some places you can include a variable </p>\n<ul>\n<li>when elaborating the theorem statement</li>\n<li>when elaborating the theorem body</li>\n<li>when adding the theorem to the environment</li>\n</ul>\n<p>In the first case, it is always included<br>\nIn the second case, Lean uses those criteria from the language reference you showed<br>\nIn the third case, it's only the used section variables that are included I think</p>",
        "id": 544813192,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760466349
    },
    {
        "content": "<p>Hmmm. All of your three bullet points involve theorems, and my example contained a non-theorem <code>def</code> declaration, so I thought I could take the passage I cited at face value. If I'm getting hung up on a distinction that doesn't matter, let me know...</p>",
        "id": 544813697,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466566
    },
    {
        "content": "<p>If there's some other process that removes unused instance implicit arguments later on in the elaboration process, I'd love to know about it.</p>",
        "id": 544813822,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466610
    },
    {
        "content": "<p>But if theorems and defs are treated differently, then I think I do perceive the relevance of <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> 's \"you should be careful of relying on <code>variable</code> for <code>def</code> and <code>instance</code>!\" above <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 544814082,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466711
    },
    {
        "content": "<p>I'm still scratching my head over the exact language of the reference manual versus the behavior I see though.</p>",
        "id": 544814158,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466736
    },
    {
        "content": "<p>I do note different behavior if I rewrite <code>def</code> to <code>theorem</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"sd\">/-- info: foo1.{u} (G : Type u) [Add G] (g : G) : g = g -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo1</span>\n<span class=\"sd\">/-- info: foo2.{u} (G : Type u) [Add G] (g : G) : g + g = g + g -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo2</span>\n</code></pre></div>",
        "id": 544814261,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466776
    },
    {
        "content": "<p>I get a warning at the definition of <code>foo1</code> that <code>[Add G]</code> is unused.</p>",
        "id": 544814725,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760466962
    },
    {
        "content": "<p>oh for definitions it's different</p>",
        "id": 544815500,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760467282
    },
    {
        "content": "<p>for definitions I think when elaborating the statement and body everything is included and when adding it to the environment only used things are included</p>",
        "id": 544815701,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760467371
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"662452\">Jason Reed</span> <a href=\"#narrow/channel/270676-lean4/topic/the.20danger.20of.20sorried.20instances/near/544814725\">said</a>:</p>\n<blockquote>\n<p>I get a warning at the definition of <code>foo1</code> that <code>[Add G]</code> is unused.</p>\n</blockquote>\n<p>I guess then I was wrong with what I said about only including the used variables</p>",
        "id": 544815836,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760467431
    },
    {
        "content": "<p>I believe for <code>()</code> and <code>{}</code> it includes when used but for <code>[]</code> it includes when all of the stuff it depends on is included.</p>",
        "id": 544817404,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760468046
    }
]