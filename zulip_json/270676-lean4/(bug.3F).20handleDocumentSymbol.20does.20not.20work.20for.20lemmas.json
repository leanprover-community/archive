[
    {
        "content": "<p>I noticed that the LSP <code>textDocument/documentSymbol</code> request is not returning mathlib's lemmas among the other declarations. For instance, you can check that in VSCode by clicking the three dots in the header line:</p>\n<p><a href=\"/user_uploads/3121/8lianRZ1c8MixcAs014JRwkh/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/8lianRZ1c8MixcAs014JRwkh/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"929x568\" src=\"/user_uploads/thumbnail/3121/8lianRZ1c8MixcAs014JRwkh/image.png/840x560.webp\"></a></div><p>I'm curious whether this bug is in the <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/Lemma.lean\">mathlib side</a> or <a href=\"https://github.com/leanprover/lean4/blob/8e7e55f2d5c9564e138519cef329179e94ec9e96/src/Lean/Server/FileWorker/RequestHandling.lean#L351-L371\">Lean's side</a>. It seems mathlib is properly expanding <code>lemma</code> to <code>theorem</code> and marking the lemma as a declaration, but somehow it's still not visible to the server?</p>",
        "id": 536936891,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756583865
    },
    {
        "content": "<p>It seems the problem is in the Lean side, because <code>foo</code> below also does not show:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"stupid\"</span><span class=\"w\"> </span><span class=\"n\">dec</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">dec</span>\n\n<span class=\"n\">stupid</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 536939172,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756586844
    },
    {
        "content": "<p>Well it only cares about <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Command.declaration#doc\">docs#Lean.Parser.Command.declaration</a>​s and <code>lemma</code> isn't a declaration, nor is your \"stupid\" macro</p>",
        "id": 536939265,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756586984
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> I don't think this is (exactly) the issue. If you look at the source of <code>lemma</code> in Mathlib, it does change the syntax kind. But perhaps the syntax after macro expansion is not considered</p>",
        "id": 536939308,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756587054
    },
    {
        "content": "<p>Yeah that's what I mean. It looks at the original syntax and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=lemma#doc\">docs#lemma</a> != <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Command.declaration#doc\">docs#Lean.Parser.Command.declaration</a></p>",
        "id": 536939346,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756587106
    },
    {
        "content": "<p>wouldn't it be desirable to apply macro expansion too? I found the fact <code>lemma</code>s are not reported a bit annoying, especially in Emacs where I like to navigate the file with imenu (which is like a TOC)</p>",
        "id": 536939427,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756587225
    },
    {
        "content": "<p>it also does not work with <code>open [identifier] in [command]</code> syntax. Leading to the slightly ironic fact that <code>handleDocumentSymbol</code> is not listing itself</p>",
        "id": 536942038,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756591085
    },
    {
        "content": "<p>Looks like a bug to me. (I think Robin is just explaining the error, not justifying it.)</p>\n<p>Want to report it on Github if it's not already there? <a href=\"https://github.com/leanprover/lean4/issues\">https://github.com/leanprover/lean4/issues</a></p>",
        "id": 536942488,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1756591699
    },
    {
        "content": "<p>I'm trying to learn more about Lean's internals, so I attempted an implementation myself</p>\n<p>but I'll try to report the issue there, I'm not sure if my way is the \"right\" way (via <code>Snapshot.infoTree</code>)</p>",
        "id": 536955012,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756611406
    },
    {
        "content": "<p>if I import it in another file, everything shows up in the list</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Server</span><span class=\"bp\">.</span><span class=\"n\">Requests</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">BuiltinCommand</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Declaration</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleDocumentSymbol</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbolParams</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbolResult</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbolResult</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"c1\">-- bad: we have to wait on elaboration of the entire file before we can report document symbols</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">cmdSnaps</span><span class=\"bp\">.</span><span class=\"n\">waitAll</span>\n<span class=\"w\">  </span><span class=\"n\">mapTaskCostly</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snaps</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snaps</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">infoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;section&gt;\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"kn\">namespace</span>\n<span class=\"w\">        </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"o\">}</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">        </span><span class=\"n\">selectionRange</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">        </span><span class=\"n\">children?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">children</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">syms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">    </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span>\n\n<span class=\"w\">  </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FileMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofCommandInfo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">elaborator</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">elaborator</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">``Command.elabNamespace</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">``Command.elabSection</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"o\">:</span><span class=\"n\">sectionHeader</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkLevel</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">``Command.elabEnd</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">syms</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">``Command.elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stxRange</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">selection</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">              </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"bp\">$_</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">np</span><span class=\"o\">:</span><span class=\"n\">namedPrio</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">ls</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">}]</span><span class=\"bp\">?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">declSig</span><span class=\"w\"> </span><span class=\"bp\">$_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">                </span><span class=\"o\">((</span><span class=\"bp\">·.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"instance {sig.raw.reprint.getD \"\"}\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">                </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">                </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">declId</span><span class=\"bp\">|$</span><span class=\"n\">id</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">ls</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">}]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">                  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx10</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">][</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">stx10</span><span class=\"bp\">.</span><span class=\"n\">isIdOrAtom?</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;unknown&gt;\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stx10</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">selRange</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">selection</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">                </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">                </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SymbolKind</span><span class=\"bp\">.</span><span class=\"n\">method</span>\n<span class=\"w\">                </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stxRange</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">                </span><span class=\"n\">selectionRange</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">selRange</span><span class=\"bp\">.</span><span class=\"n\">toLspRange</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">              </span><span class=\"o\">}</span>\n<span class=\"w\">              </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">syms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">toDocumentSymbols</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">syms</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"n\">up</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">source</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">syms</span>\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">FromJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbol</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">FromJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">DocumentSymbolResult</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">chainLspRequestHandler</span>\n<span class=\"w\">    </span><span class=\"s2\">\"textDocument/documentSymbol\"</span>\n<span class=\"w\">    </span><span class=\"n\">DocumentSymbolParams</span>\n<span class=\"w\">    </span><span class=\"n\">DocumentSymbolResult</span>\n<span class=\"w\">    </span><span class=\"n\">handleDocumentSymbol</span>\n</code></pre></div>\n</div></div>\n<p>edit: I made an issue <a href=\"https://github.com/leanprover/lean4/pull/10190\">lean4#10190</a></p>",
        "id": 536955290,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756611748
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> do you think I could turn this implementation into a PR?</p>",
        "id": 539144503,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757702389
    },
    {
        "content": "<p>Let's ping <span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span> about this issue (<a href=\"https://github.com/leanprover/lean4/pull/10190\">lean4#10190</a>), since he's responsible for LSP.</p>",
        "id": 539145544,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1757702901
    },
    {
        "content": "<p>I don't think the elaborator is a good thing to look at since the syntax may be completely different before macro expansion. I'd simply try macro expanding the syntax (or reading macro expansion info?) but I'm not sure how exactly you'd be able to do that in <code>RequestM</code></p>",
        "id": 539145668,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757702963
    },
    {
        "content": "<p>Do you have an example in mind of how different it could be? From my usage so far, only autogenerated identifiers sometimes look odd in the listing</p>",
        "id": 539146740,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757703421
    },
    {
        "content": "<p>and I think think this would be the biggest possible problem, for only the source position and identifier of the declaration are taken into account for the document symbols</p>",
        "id": 539147023,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757703506
    },
    {
        "content": "<p>I believe the <code>stupid</code> macro would already break the elaborator approach since you'd be looking at the wrong syntax, so it'd look at <code>theorem foo : 1 = 1 := rfl</code> instead of <code>foo</code></p>",
        "id": 539147231,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757703603
    },
    {
        "content": "<p>and then you just get <code>&lt;unknown&gt;</code></p>",
        "id": 539147288,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757703624
    },
    {
        "content": "<p>but in what sense it would \"break\" it? this is how it is reported with the patch:</p>\n<p><a href=\"/user_uploads/3121/Oz7cGqg7Ve_NnAl33zC3cYqy/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Oz7cGqg7Ve_NnAl33zC3cYqy/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2080x1022\" src=\"/user_uploads/thumbnail/3121/Oz7cGqg7Ve_NnAl33zC3cYqy/image.png/840x560.webp\"></a></div>",
        "id": 539147495,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757703722
    },
    {
        "content": "<p>personally, I like that the declarations with autogenerated names are listed as well</p>",
        "id": 539147678,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757703815
    },
    {
        "content": "<p>Hmm, does it work with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"slightly\"</span><span class=\"w\"> </span><span class=\"s2\">\"stupid\"</span><span class=\"w\"> </span><span class=\"n\">dec</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">dec</span>\n\n<span class=\"n\">slightly</span><span class=\"w\"> </span><span class=\"n\">stupid</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>too?</p>",
        "id": 539147697,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757703823
    },
    {
        "content": "<p>Oh wait are you looking at the info tree? I already wondered how you do that lol</p>",
        "id": 539147831,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757703878
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/b-SWpzq4Ob38Y3GyRiw1PTaT/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/b-SWpzq4Ob38Y3GyRiw1PTaT/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1441x1003\" src=\"/user_uploads/thumbnail/3121/b-SWpzq4Ob38Y3GyRiw1PTaT/image.png/840x560.webp\"></a></div>",
        "id": 539147848,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757703887
    },
    {
        "content": "<p>I guess maybe this approach does work then? I'm not too sure though, let's wait on what <span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span> thinks about this</p>",
        "id": 539147945,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757703929
    },
    {
        "content": "<p>I'd be happy to review a PR that fixes this issue. Having some tests for this feature would also be great.<br>\nNote that since the document symbols request is used for all kinds of UI features, not just the symbol search, it should attempt to not report any redundant entries.</p>\n<p>In the future, we may also still need to rewrite this feature entirely so that it doesn't have to wait for the full elaboration of the entire file anymore.</p>",
        "id": 539534027,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1757936777
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span> :-) I have two questions:</p>\n<ul>\n<li>What is the criterion for redundancy? In the example above, the <code>macro</code> expands to two named declarations. Should it report only one since they belong to the same position in the file? And if so, which one? Personally, I prefer both declarations to be listed. </li>\n<li>When you say it could be rewritten not to wait for the exaboration of the entire file, what is the idea here? To only apply macro expansion to the syntax, or to use some sort of cache?</li>\n</ul>",
        "id": 539594545,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757951369
    },
    {
        "content": "<p>Perhaps another question that should be considered first:</p>\n<ul>\n<li>What should count as an entry in the symbols list? Currently, it's a declaration, because they usually have names. That said, there is a special case for unnamed <code>instance</code>s, which show up as <code>instance : type annotation</code> in the list. Perhaps, we could add special cases for <code>macro</code>s and <code>syntax</code>s which often are not explicitely named as well.</li>\n</ul>",
        "id": 539596544,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757951828
    },
    {
        "content": "<p>Another idea would be to explicitely have a class <code>IsDocumentSymbol Name</code> for some syntax nodes, which could be instantiated by providing the way to get the name and position from the syntax.</p>",
        "id": 539598229,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1757952236
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span> I had this code sitting here for a while (I'm using it as a server plugin), so I made a PR <a href=\"https://github.com/leanprover/lean4/pull/11228\">lean4#11228</a>. I think the questions above are still valid, so feel free to modify or close it, but I'm still making a case for it as in Emacs having the symbols is very very convenient for jumping around the file fast.</p>",
        "id": 556998327,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1763451872
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/270676-lean4/topic/.28bug.3F.29.20handleDocumentSymbol.20does.20not.20work.20for.20lemmas/near/539534027\">said</a>:</p>\n<blockquote>\n<p>In the future, we may also still need to rewrite this feature entirely so that it doesn't have to wait for the full elaboration of the entire file anymore.</p>\n</blockquote>\n<p>Do you mean, report a partial list of symbols during elaboration?</p>",
        "id": 557965717,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1763479520
    }
]