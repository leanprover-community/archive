[
    {
        "content": "<p>While reading the constructor layout in the FFI documentation, I see that <code>Char</code> is stored as a non-scalar field.</p>\n<p>From the FFI manual:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ptr_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">usize_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span>\n<span class=\"w\">  </span><span class=\"n\">sc64_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">  </span><span class=\"n\">ptr_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"c1\">-- wrappers don't count as scalars</span>\n<span class=\"w\">  </span><span class=\"n\">sc64_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"c1\">-- `Float` is 64 bit</span>\n<span class=\"w\">  </span><span class=\"n\">sc8_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">sc16_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">sc8_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span>\n<span class=\"w\">  </span><span class=\"n\">sc64_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">  </span><span class=\"n\">usize_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span>\n<span class=\"w\">  </span><span class=\"n\">ptr_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"c1\">-- trivial wrapper around `UInt32`</span>\n<span class=\"w\">  </span><span class=\"n\">sc32_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n<span class=\"w\">  </span><span class=\"n\">sc16_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n</code></pre></div>\n<p>And the corresponding layout:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">ptr_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">ptr_2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">ptr_3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">usize_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_usize</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">usize_2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_usize</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc64_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint64</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc64_2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_float</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc64_3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint64</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc32_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint32</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc16_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint16</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc16_2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint16</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc8_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint8</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">)</span>\n<span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">sc8_2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint8</span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">void</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Considering that a  <code>Char</code> is a trivial constructor around <code>UInt32</code>, why is it stored as a non-scalar field?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The underlying unicode scalar value as a `UInt32`. -/</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\">   </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The value must be a legal codepoint. -/</span>\n<span class=\"w\">  </span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">isValidChar</span>\n</code></pre></div>\n<p>As I understand it, <code>Prop</code> is erased and <code>Char</code> becomes a trivial structure taking the shape of its only field, which is the UInt32 scalar.</p>\n<p>I was expecting to see <code>lean_ctor_get_uint32</code> right before <code>S.sc32_1</code>.</p>",
        "id": 449728888,
        "sender_full_name": "Yuri",
        "timestamp": 1720390481
    },
    {
        "content": "<p>This is kind of a nonanswer, but as <code>ptr_2</code> states: <code>wrappers don't count as scalars</code>. Why that is the case ¯\\_(ツ)_/¯</p>",
        "id": 449846435,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1720439723
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449846435\">said</a>:</p>\n<blockquote>\n<p>This is kind of a nonanswer, but as <code>ptr_2</code> states: <code>wrappers don't count as scalars</code>. Why that is the case ¯\\_(ツ)_/¯</p>\n</blockquote>\n<p>It is my understanding that in some cases <code>Prop</code> is not erased completely but passed as <code>lean_box(0)</code> at runtime: effectively being ignored instead of erased. I guess this could explain why <code>{ x : UInt64 // x &gt; 0 }</code> is a non-trivial structure.</p>\n<p>But by this logic both <code>Char</code> and <code>Subtype</code> would be non-trivial:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"c1\">-- Prop</span>\n</code></pre></div>\n<p>vs</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\">   </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n<span class=\"w\">  </span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">val.isValidChar</span><span class=\"w\"> </span><span class=\"c1\">-- Prop</span>\n</code></pre></div>",
        "id": 449851655,
        "sender_full_name": "Yuri",
        "timestamp": 1720441166
    },
    {
        "content": "<p>Or maybe the simplest explanation is that this is an optimization to-be-done once the new code generator is in place.</p>",
        "id": 449852573,
        "sender_full_name": "Yuri",
        "timestamp": 1720441388
    },
    {
        "content": "<p>I just checked the generated code and when Subtype is used as a function parameter, it is 'trivial' and the runtime representation is <code>α</code>.</p>\n<p>Only when stored in a structure it is not seen as 'trivial'.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkAa</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">char</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ptr_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}):</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">S.mk</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Array.mkEmpty</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- ptr_1</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- usize_1 : USize</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc64_1 : UInt64</span>\n<span class=\"w\">    </span><span class=\"n\">ptr_2</span><span class=\"w\">             </span><span class=\"c1\">-- ptr_2 : { x : UInt64 // x &gt; 0 }</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc64_2 : Float</span>\n<span class=\"w\">    </span><span class=\"n\">false</span><span class=\"w\">             </span><span class=\"c1\">-- sc8_1 : Bool</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc16_1 : UInt16</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc8_2 : UInt8</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc64_3 : UInt64</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- usize_2 : USize</span>\n<span class=\"w\">    </span><span class=\"n\">char</span><span class=\"w\">              </span><span class=\"c1\">-- ptr_3 : Char</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc32_1 : UInt32</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"w\">                 </span><span class=\"c1\">-- sc16_2 : UInt16</span>\n</code></pre></div>\n<p>And the generated code:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">l_mkAa</span><span class=\"p\">(</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_8</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_11</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_12</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_13</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_mkAa___closed__1</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_mkAa___closed__2</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_uint64</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// &lt;--- boxing the `uint64_t` representation of the Subtype value</span>\n<span class=\"w\">        </span><span class=\"n\">x_12</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_uint32</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">x_13</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// &lt;--- setting in the boxed fields section of the constructor</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_12</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_usize</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint64</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_float</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint8</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint8</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint64</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_usize</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint32</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">x_13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_13</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 449854338,
        "sender_full_name": "Yuri",
        "timestamp": 1720441703
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449851655\">said</a>:</p>\n<blockquote>\n<p>But by this logic both <code>Char</code> and <code>Subtype</code> would be non-trivial. </p>\n</blockquote>\n<p>And isn't that exactly how things are according to the documentation? (That is, I don't understand the problem.)</p>",
        "id": 449861526,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1720443311
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449861526\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449851655\">said</a>:</p>\n<blockquote>\n<p>But by this logic both <code>Char</code> and <code>Subtype</code> would be non-trivial. </p>\n</blockquote>\n<p>And isn't that exactly how things are according to the documentation? (That is, I don't understand the problem.)</p>\n</blockquote>\n<p>Maybe there is a problem. But my goal is to understand the generated code in the context of FFI and stumbled on this behavior.</p>",
        "id": 449862825,
        "sender_full_name": "Yuri",
        "timestamp": 1720443668
    },
    {
        "content": "<p>Ohhh, I see. I think the docs might be inconsistent. If I understand the following correctly, it does not match the documentation example you posted above:</p>\n<blockquote>\n<p>An inductive type with a <em>trivial structure</em>, that is,</p>\n<p>* it is none of the types described above<br>\n  * it is not marked <code>unsafe</code><br>\n  * it has a single constructor with a single parameter of <em>relevant</em> type</p>\n<p>is represented by the representation of that parameter's type.</p>\n<p>For example, <code>{ x : α // p }</code>, the <code>Subtype</code> structure of a value of type <code>α</code> and an irrelevant proof, is represented by the representation of <code>α</code>.</p>\n</blockquote>\n<p>I feel like this suggests that <code>Char</code> should be represented as a scalar. It is unclear to me what exactly counts as a \"relevant\" type though.</p>",
        "id": 449862842,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1720443673
    },
    {
        "content": "<p>Yes, this was the source of my confusion.</p>",
        "id": 449863131,
        "sender_full_name": "Yuri",
        "timestamp": 1720443750
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> wrote the layout docs, so perhaps he has some insights on this?</p>",
        "id": 449863976,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1720443992
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449862842\">said</a>:</p>\n<blockquote>\n<p>It is unclear to me what exactly counts as a \"relevant\" type though.</p>\n</blockquote>\n<p>They are described below in the same doc:</p>\n<blockquote>\n<p>A universe <code>Sort u</code>, type constructor <code>... → Sort u</code>, or proposition <code>p : Prop</code> is irrelevant and is either statically erased (see above) or represented as a <code>lean_object *</code> with the runtime value <code>lean_box(0)</code></p>\n</blockquote>",
        "id": 449864178,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1720444061
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"587706\">Daniil Kisel</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449864178\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449862842\">said</a>:</p>\n<blockquote>\n<p>It is unclear to me what exactly counts as a \"relevant\" type though.</p>\n</blockquote>\n<p>They are described below in the same doc:</p>\n<blockquote>\n<p>A universe <code>Sort u</code>, type constructor <code>... → Sort u</code>, or proposition <code>p : Prop</code> is irrelevant and is either statically erased (see above) or represented as a <code>lean_object *</code> with the runtime value <code>lean_box(0)</code><br>\n</p>\n</blockquote>\n</blockquote>\n<p>Yeah, I saw that, but wasn't sure if that's a complete list.</p>",
        "id": 449864349,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1720444113
    },
    {
        "content": "<p>My conclusion so far aside from potential doc fixes:</p>\n<ul>\n<li>trivial structures/inductives like Subtype and Char are represented as their underlying type when used as function parameters</li>\n<li>the structure layout does not see them as trivial and store them as regular boxed fields.</li>\n</ul>",
        "id": 449864765,
        "sender_full_name": "Yuri",
        "timestamp": 1720444240
    },
    {
        "content": "<p>It turns out that not only trivial structures are stored as boxed fields in a structure, but all of the scalars too: UInt8, UInt16, UInt32, UInt64, Float, USize.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkProd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkProd2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">UInt16</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkProd3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">USize</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">⟩</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_mkProd</span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_uint64_add</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_mkProd___closed__1</span><span class=\"p\">;</span>\n<span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_float_mul</span><span class=\"p\">(</span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_uint64</span><span class=\"p\">(</span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_float</span><span class=\"p\">(</span><span class=\"n\">x_6</span><span class=\"p\">);</span>\n<span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span><span class=\"w\">      </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">);</span><span class=\"w\">      </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_mkProd2</span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_uint8_add</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span>\n<span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_uint16_mul</span><span class=\"p\">(</span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box</span><span class=\"p\">(</span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box</span><span class=\"p\">(</span><span class=\"n\">x_6</span><span class=\"p\">);</span>\n<span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"p\">);</span><span class=\"w\">   </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">l_mkProd3</span><span class=\"p\">(</span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">;</span>\n<span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_usize</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span><span class=\"w\">  </span><span class=\"c1\">// &lt;-----</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 449990306,
        "sender_full_name": "Yuri",
        "timestamp": 1720475775
    },
    {
        "content": "<p>I wrote that part of the docs exactly because it's nonintuitive and arguably a bug. There isn't bandwidth to fix it, but at least we can document it</p>",
        "id": 449990610,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720475859
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449990306\">said</a>:</p>\n<blockquote>\n<p>It turns out that not only trivial structures are stored as boxed fields in a structure, but all of the scalars too: UInt8, UInt16, UInt32, UInt64, Float, USize.</p>\n</blockquote>\n<p>They are stored boxed when their type is not fixed in the structure. For example, <code>Prod</code> is generic and thus its arguments are always boxed.</p>",
        "id": 449990844,
        "sender_full_name": "Daniil Kisel",
        "timestamp": 1720475913
    },
    {
        "content": "<p>Yes, someone brought up that this was not sufficiently clear in the docs I wrote, as I used a nonparametric structure as an example</p>",
        "id": 449990993,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720475953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"587706\">@Daniil Kisel</span> yes, you are right: it is the polymorphic case!</p>",
        "id": 449991516,
        "sender_full_name": "Yuri",
        "timestamp": 1720476073
    },
    {
        "content": "<p>for parametric types, all type parameters are stored boxed, and the type layout is not recomputed when you insert concrete types. So <code>UInt32 x UInt32</code> will be stored as a ctor cell with two <code>lean_object*</code> fields, each storing a boxed integer (i.e. using no additional allocation but with the shift left trick) and taking up 16 bytes of data space (plus the header)</p>",
        "id": 449991529,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476076
    },
    {
        "content": "<p>whereas a <code>struct Foo := (x y : UInt32)</code> is stored as a ctor cell with 8 bytes of scalar space (plus the header)</p>",
        "id": 449991620,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476115
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449991620\">said</a>:</p>\n<blockquote>\n<p>whereas a <code>struct Foo := (x y : UInt32)</code> is stored as a ctor cell with 8 bytes of scalar space (plus the header)</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">l_mkFoo</span><span class=\"p\">(</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint32</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">lean_ctor_set_uint32</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 449991951,
        "sender_full_name": "Yuri",
        "timestamp": 1720476245
    },
    {
        "content": "<p>and <code>struct Foo := (x y : Char)</code> is again stored as 16 bytes of data space</p>",
        "id": 449992099,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476293
    },
    {
        "content": "<p>this is the \"arguably a bug\" part</p>",
        "id": 449992137,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476306
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/runtime.20constructor.20layout/near/449990610\">said</a>:</p>\n<blockquote>\n<p>I wrote that part of the docs exactly because it's nonintuitive and arguably a bug. There isn't bandwidth to fix it, but at least we can document it</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> what bug are you referring to: the fact that trivial structures/inductives are not stored in constructors as their wrapped value? Or do you have something different in mind?</p>",
        "id": 449992275,
        "sender_full_name": "Yuri",
        "timestamp": 1720476345
    },
    {
        "content": "<p>even though <code>Foo.mk : Char -&gt; Char -&gt; Foo</code> here will take its arguments unboxed as <code>uint32_t</code> in the function call ABI</p>",
        "id": 449992454,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476386
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"463095\">@Yuri de Wit</span> note, my response to your question outran the question</p>",
        "id": 449993019,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720476618
    },
    {
        "content": "<p>For my own sake:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">mkFoo2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo2</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>It is generated like this:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">l_mkFoo2</span><span class=\"p\">(</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_4</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_uint32</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_box_uint32</span><span class=\"p\">(</span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_ctor_set</span><span class=\"p\">(</span><span class=\"n\">x_5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>But should be something like (in addition to the get side):</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">l_mkFoo2</span><span class=\"p\">(</span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_box_uint32</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_box_uint32</span><span class=\"p\">(</span><span class=\"n\">x_3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 449993291,
        "sender_full_name": "Yuri",
        "timestamp": 1720476801
    }
]