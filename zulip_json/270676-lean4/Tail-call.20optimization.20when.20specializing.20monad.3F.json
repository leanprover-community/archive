[
    {
        "content": "<p>In Lean 4.18, the following code doesn't cause stack overflow:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n</code></pre></div>\n<p>, but the following does:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n<span class=\"c1\">-- Stack overflow detected. Aborting.</span>\n</code></pre></div>\n<p>Is there a way to ask the compiler to try to apply tail-call optimization when it's possible in the specialized code?</p>\n<p>Many thanks!</p>",
        "id": 511324681,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1744266899
    },
    {
        "content": "<p>Not very related to the original question, but I tried a few things and found the result intriguing.</p>\n<p>The following program causes a stack overflow, which can be unintuitive for someone more familiar with imperative constructs:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"c1\">-- Stack overflow detected. Aborting.</span>\n</code></pre></div>\n<p>The following program, however, keeps running without blowing up the stack: (at least I let it run until 8 digits)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>The following program causes an internal error. I wonder if it's a bug I should report:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"c1\">-- INTERNAL PANIC: unreachable code has been reached</span>\n</code></pre></div>",
        "id": 511560496,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1744346981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"476925\">Phil Nguyen</span> <a href=\"#narrow/channel/270676-lean4/topic/Tail-call.20optimization.20when.20specializing.20monad.3F/near/511560496\">said</a>:</p>\n<blockquote>\n<p>The following program causes an internal error. I wonder if it's a bug I should report:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"c1\">-- INTERNAL PANIC: unreachable code has been reached</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>That is a <em>feature</em> that dead loops without side effects will be compiled into unreachable code.</p>",
        "id": 511560781,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744347147
    },
    {
        "content": "<p>no, \"INTERNAL PANIC\" is not desirable behavior</p>",
        "id": 511598006,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744361898
    },
    {
        "content": "<p>Lean uses rust-style semantics on empty loops: they spin (as compared to C-style semantics of \"they cause UB\")</p>",
        "id": 511598299,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744361998
    },
    {
        "content": "<p>It is not sound for lean to allow empty loops to be optimized away</p>",
        "id": 511598445,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744362028
    },
    {
        "content": "<p>The above is a miscompilation. Please report it</p>",
        "id": 511598616,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744362085
    },
    {
        "content": "<p>The fact that <code>do repeat pure ()</code> stack overflows also seems like a bug, I would definitely expect that to have bounded stack usage and it sounds like an inlining issue</p>",
        "id": 511599001,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744362200
    },
    {
        "content": "<p>I filed the bugs on Github (<a href=\"https://github.com/leanprover/lean4/issues/7923\">1</a> and <a href=\"https://github.com/leanprover/lean4/issues/7925\">2</a>). Thanks!!</p>",
        "id": 511697786,
        "sender_full_name": "Phil Nguyen",
        "timestamp": 1744391159
    }
]