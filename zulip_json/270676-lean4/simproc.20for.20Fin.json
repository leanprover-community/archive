[
    {
        "content": "<p>Do we have a simproc or simp lemma for </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>or related explicit calculations? It seems to me like <code>Fin.isValue</code> is meant to do something like this, but currently (even in Mathlib) I can't see any automatic way of simplifying the lhs without already writing down the rhs.</p>",
        "id": 481723066,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731332035
    },
    {
        "content": "<p><code>rw [Fin.coe_ofNat_eq_mod]</code> works here (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.coe_ofNat_eq_mod#doc\">docs#Fin.coe_ofNat_eq_mod</a>)</p>",
        "id": 481724970,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332541
    },
    {
        "content": "<p><code>rewrite [Fin.coe_ofNat_eq_mod]</code> is a little less magic</p>",
        "id": 481725047,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332568
    },
    {
        "content": "<p>Maybe this should be <code>simp</code>?</p>",
        "id": 481725061,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332573
    },
    {
        "content": "<p>I just came across that lemma too, but it's marked <code>simp</code>. Why does <code>simp</code> not succeed using it?</p>",
        "id": 481725123,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731332589
    },
    {
        "content": "<p>Before finding that lemma I also tried making</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">coe_ofNat_of_lt</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">no_index</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mod_eq_of_lt</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>which also doesn't work with <code>simp</code> in this example</p>",
        "id": 481725314,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731332640
    },
    {
        "content": "<p>I would guess this is all related to the no_index trouble around ofNat (edit: <a href=\"https://github.com/leanprover/lean4/pull/3684\">lean4#3684</a>)</p>",
        "id": 481725457,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332669
    },
    {
        "content": "<p>Oh, it's a typo, <code>no_index OfNat.ofNat n</code> should be <code>no_index (OfNat.ofNat n)</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">coe_ofNat_eq_mod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">no_index</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 481726426,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332926
    },
    {
        "content": "<p>I always get the precedence of <code>no_index</code> wrong</p>",
        "id": 481726444,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731332934
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18872\">#18872</a></p>",
        "id": 481728307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731333418
    },
    {
        "content": "<p>There's two other instances of the pattern <code>no_index OfNat.ofNat n</code> in mathlib, do you want to change those in this PR too?</p>",
        "id": 481728884,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731333570
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/KbUa93LvYbKWlKYRqVvkaUv3/image.png\">image.png</a><br>\n(for your convenience!)</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/KbUa93LvYbKWlKYRqVvkaUv3/image.png\" title=\"image.png\"><img data-original-dimensions=\"309x143\" src=\"/user_uploads/thumbnail/3121/KbUa93LvYbKWlKYRqVvkaUv3/image.png/840x560.webp\"></a></div>",
        "id": 481730126,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731333874
    },
    {
        "content": "<p>We had a <code>norm_fin</code> tactic in mathlib3 that might be in scope for this. And, probably not what you wanted for your use site (you said you don't want to write the rhs), but <code>rfl</code> proves your original example.</p>",
        "id": 481742112,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1731337138
    },
    {
        "content": "<p>Yeah, <code>rfl</code> working is good but I'd really like other <code>simp</code> and <code>rw</code> lemmas to apply afterwards, so <code>rfl</code> isn't really sufficient here unfortunately</p>",
        "id": 481743258,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731337432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/simproc.20for.20Fin/near/481728307\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18872\">#18872</a></p>\n</blockquote>\n<p>I ended up removing <code>@[simp]</code> from this lemma because it's not very confluent. I think your version would be safer.</p>",
        "id": 482279546,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731540112
    }
]