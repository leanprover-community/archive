[
    {
        "content": "<p>I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"n\">find_theorems</span><span class=\"o\">)</span>\n  <span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"s2\">\"#find_theorems\"</span> <span class=\"o\">(</span><span class=\"n\">colGt</span> <span class=\"o\">(</span><span class=\"n\">strLit</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"n\">ident</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"o\">))</span><span class=\"bp\">+</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n</code></pre></div>\n<p>and it works, and I want to extend it to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"n\">find_theorems</span><span class=\"o\">)</span>\n  <span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"s2\">\"#find_theorems\"</span> <span class=\"o\">(</span><span class=\"n\">colGt</span> <span class=\"o\">(</span><span class=\"n\">strLit</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"n\">ident</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"o\">(</span><span class=\"s2\">\"⊢ \"</span> <span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"o\">)</span> <span class=\"bp\">&lt;|&gt;</span> <span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"o\">))</span><span class=\"bp\">+</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">command</span>\n</code></pre></div>\n<p>This is accepted, but if I then use</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">find_theorems</span> <span class=\"bp\">⊢</span> <span class=\"o\">(</span><span class=\"n\">tsum</span> <span class=\"n\">_</span> <span class=\"bp\">=</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">_</span> <span class=\"bp\">*</span> <span class=\"n\">_</span> <span class=\"bp\">^</span> <span class=\"n\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">elaboration</span> <span class=\"n\">function</span> <span class=\"n\">for</span> <span class=\"bp\">'</span><span class=\"n\">group'</span> <span class=\"n\">has</span> <span class=\"n\">not</span> <span class=\"n\">been</span> <span class=\"n\">implemented</span>\n  <span class=\"o\">[</span><span class=\"n\">Error</span> <span class=\"n\">pretty</span> <span class=\"n\">printing</span> <span class=\"n\">syntax</span><span class=\"o\">:</span> <span class=\"n\">unknown</span> <span class=\"kd\">constant</span> <span class=\"bp\">'</span><span class=\"n\">group'.</span> <span class=\"n\">Falling</span> <span class=\"n\">back</span> <span class=\"n\">to</span> <span class=\"n\">raw</span> <span class=\"n\">printer.</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">group</span> <span class=\"s2\">\"⊢\"</span> <span class=\"o\">(</span><span class=\"n\">Term.paren</span> <span class=\"s2\">\"(\"</span> <span class=\"o\">(</span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">=</span><span class=\"n\">_</span><span class=\"bp\">»</span> <span class=\"o\">(</span><span class=\"n\">Term.app</span> <span class=\"bp\">`</span><span class=\"n\">tsum</span> <span class=\"o\">[(</span><span class=\"n\">Term.hole</span> <span class=\"s2\">\"_\"</span><span class=\"o\">)])</span> <span class=\"s2\">\"=\"</span> <span class=\"o\">(</span><span class=\"n\">Term.hole</span> <span class=\"s2\">\"_\"</span><span class=\"o\">))</span> <span class=\"s2\">\")\"</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>I am parsing the argument list like this so far:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>    <span class=\"n\">for</span> <span class=\"n\">s</span> <span class=\"k\">in</span> <span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span> <span class=\"k\">do</span>\n      <span class=\"k\">match</span> <span class=\"n\">s</span> <span class=\"k\">with</span>\n      <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">ss</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n        <span class=\"k\">let</span> <span class=\"n\">str</span> <span class=\"o\">:=</span> <span class=\"n\">Lean.TSyntax.getString</span> <span class=\"n\">ss</span>\n        <span class=\"n\">name_pats</span> <span class=\"o\">:=</span> <span class=\"n\">name_pats.push</span> <span class=\"n\">str</span>\n      <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n        <span class=\"k\">let</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"n\">Lean.TSyntax.getId</span> <span class=\"n\">i</span>\n        <span class=\"n\">unless</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">contains</span> <span class=\"n\">n</span> <span class=\"k\">do</span>\n          <span class=\"n\">throwErrorAt</span> <span class=\"n\">i</span> <span class=\"s2\">\"Name {n} not in scope\"</span>\n        <span class=\"n\">idents</span> <span class=\"o\">:=</span> <span class=\"n\">idents.push</span> <span class=\"n\">n</span>\n      <span class=\"bp\">|</span> <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">group</span> <span class=\"s2\">\"⊢\"</span> <span class=\"bp\">$</span><span class=\"n\">st</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n        <span class=\"k\">let</span> <span class=\"n\">t</span> <span class=\"bp\">←</span> <span class=\"n\">Lean.Elab.Term.elabTerm</span> <span class=\"n\">st</span> <span class=\"n\">none</span>\n        <span class=\"n\">terms</span> <span class=\"o\">:=</span> <span class=\"n\">terms.push</span> <span class=\"o\">(</span><span class=\"n\">true</span><span class=\"o\">,</span> <span class=\"n\">t</span><span class=\"o\">)</span>\n      <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n        <span class=\"k\">let</span> <span class=\"n\">t</span> <span class=\"bp\">←</span> <span class=\"n\">Lean.Elab.Term.elabTerm</span> <span class=\"n\">s</span> <span class=\"n\">none</span>\n        <span class=\"n\">terms</span> <span class=\"o\">:=</span> <span class=\"n\">terms.push</span> <span class=\"o\">(</span><span class=\"n\">false</span><span class=\"o\">,</span> <span class=\"n\">t</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>where the second-to-last clause is new. I found in the docs of <code>&lt;|&gt;</code> that it adds a <code>group</code> node if necessary, but I am unsure how to match it, or if I am approaching this the wrong way.</p>",
        "id": 381538392,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1691078698
    },
    {
        "content": "<p>I think I figured it out.</p>",
        "id": 381556711,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1691082289
    },
    {
        "content": "<p>I'm running into this \"match on <code>group</code>\" thing now, was there a good solution? I would have thought an extra set of parens in the match would do the trick, but no cigar.</p>",
        "id": 524054474,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1749895496
    },
    {
        "content": "<p>Do you have a mwe? I think Joachim's is too old to reflect the current state of Lean.</p>",
        "id": 524122658,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749985079
    },
    {
        "content": "<p>Sure, in this example I want to process a list of tuples/products. The repeated part is grouped in the syntax part as <code>tuples:(..),*</code>. When I go to try and match on the elements of the TSepArray, they present with this additional <code>group</code> wrapper that I can't seem to figure out how to match on, as evidenced by neither of the match arms hitting.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#goMany\"</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"o\">:(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">),</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"OK 0\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(((</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"OK 1\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"failed to match: {stx}\"</span>\n\n\n<span class=\"c1\">-- failed to match: (group \"(\" (num \"0\") \",\" (str \"\\\"x\\\"\") \")\")</span>\n<span class=\"bp\">#</span><span class=\"n\">goMany</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"o\">)</span>\n<span class=\"o\">]</span>\n</code></pre></div>",
        "id": 524148795,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1750012922
    },
    {
        "content": "<p>You can also always just access the children directly</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#goMany\"</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"o\">:(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">),</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">goMany</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"o\">)</span>\n<span class=\"o\">]</span>\n</code></pre></div>",
        "id": 524149281,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750013556
    },
    {
        "content": "<p>Note that the default category of quotations is <code>term</code>, which is definitely incorrect here. So you need to specify the quotation parser, at which point you need to name it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#goMany\"</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"o\">:</span><span class=\"n\">pair</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tuples</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">tuple</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">pair</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"OK 0\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">     </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"failed to match: {stx}\"</span>\n</code></pre></div>",
        "id": 524199404,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1750060762
    },
    {
        "content": "<p>Thanks, I didn't know you could now shortcut the <code>declare_syntax_cat foo</code> with just <code>syntax foo</code> either.</p>",
        "id": 524373416,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1750137473
    }
]