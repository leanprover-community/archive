[
    {
        "content": "<p>Why <code>#check</code> succeed with mvars when there is an unrelated <code>instance</code>, but fail if no such <code>instance</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">C.rel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">C.rel</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span>\n<span class=\"c1\">-- @C.rel ?m.3298 α β ?m.3299 ?m.3300 : Type</span>\n</code></pre></div>\n<p>However, if I remove the two <code>instance</code>s, it becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3278</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"n\">Additional</span><span class=\"w\"> </span><span class=\"n\">diagnostic</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">available</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 530831547,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1753469783
    },
    {
        "content": "<p>Typeclass inference itself will throw an error if no instances can possibly apply. </p>\n<p>The <code>#check</code> command configures things to try synthesizing what can possibly be synthesized, but it allows stuck typeclass problems to not cause an error. \"Stuck\" means \"there's some metavariable that's making it unclear whether there aren't any instances that could apply\".</p>",
        "id": 530832062,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753470017
    },
    {
        "content": "<p>These instances are certainly not unrelated; using <code>k</code> for the metavariable would cause them to apply.</p>",
        "id": 530832206,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753470084
    },
    {
        "content": "<p>The reason <code>#check</code> allows stuck instances is that it's inconvenient when <code>#check</code> doesn't show you anything at all.</p>\n<p>Maybe it should still generate the error... That's doable.</p>",
        "id": 530832407,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753470189
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/Why.20.60.23check.60.20succeed.20with.20mvars.20when.20there.20is.20an.20.60instance.60/near/530832206\">said</a>:</p>\n<blockquote>\n<p>These instances are certainly not unrelated; using <code>k</code> for the metavariable would cause them to apply.</p>\n</blockquote>\n<p>Oh thanks, does that mean the instance <code>?m2 : C ?m1 α</code> may unify with something else, which triggers an assignment of <code>?m</code>? But if so, why not also create a <code>?m2</code> even when there is no <code>instance</code> for <code>C k α</code>?</p>",
        "id": 530833708,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1753470710
    },
    {
        "content": "<p>When you write <code>C.rel _ α β</code>, Lean elaborates this as <code>@C.rel ?k α β ?inst1 ?inst2</code> and adds <code>?inst1 : C ?k α</code> and <code>?inst2 : C ?k β</code> as pending instance problems.</p>\n<p>Eventually it will then start trying to synthesize <code>?inst1</code> and <code>?inst2</code>. When there are metavariables, it will try to decide whether the instance problem is <em>stuck</em>, in which case it will defer until later, if possible, or otherwise if there are no instances that could ever apply to this situation, it immediately throws a \"failed to synthesize\" error.</p>",
        "id": 530834870,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753471232
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/Why.20.60.23check.60.20succeed.20with.20mvars.20when.20there.20is.20an.20.60instance.60/near/530834870\">said</a>:</p>\n<blockquote>\n<p>When you write <code>C.rel _ α β</code>, Lean elaborates this as <code>@C.rel ?k α β ?inst1 ?inst2</code> and adds <code>?inst1 : C ?k α</code> and <code>?inst2 : C ?k β</code> as pending instance problems.</p>\n<p>Eventually it will then start trying to synthesize <code>?inst1</code> and <code>?inst2</code>. When there are metavariables, it will try to decide whether the instance problem is <em>stuck</em>, in which case it will defer until later, if possible, or otherwise if there are no instances that could ever apply to this situation, it immediately throws a \"failed to synthesize\" error.</p>\n</blockquote>\n<p>Thanks, I got it. So <code>?inst1 : C ?k α</code> will stuck if there is any instance for <code>C xxx α</code> (although <code>?k</code> might be unrelated with <code>xxx</code>) but will fail immediately if there is no such instance.</p>",
        "id": 530836181,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1753471832
    },
    {
        "content": "<p>Yes.</p>\n<p>However, what do you mean by \"unrelated\" precisely? The metavariable might be able to unify with <code>xxx</code>, so that instance could apply if there were more information.</p>",
        "id": 530837312,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753472297
    },
    {
        "content": "<p>I still feel they are not quite related, since the assignment of <code>?k</code> is not triggered by the existence of instance <code>C xxx α</code>.</p>",
        "id": 530838003,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1753472615
    },
    {
        "content": "<p>The instance is applied only after <code>?k</code> is assigned with <code>xxx</code> by some other things, isn't it?</p>",
        "id": 530838147,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1753472666
    },
    {
        "content": "<p>Yes, though <code>?k</code> represents the absence of an expression, so it has <em>potential</em> to be <code>xxx</code>, among other things.</p>",
        "id": 530838516,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753472820
    }
]