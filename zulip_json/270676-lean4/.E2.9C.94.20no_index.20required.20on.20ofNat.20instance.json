[
    {
        "content": "<p>I am currently trying to <a href=\"https://github.com/leanprover/lean4/pull/5081\">upstream</a> the following code to lean. I have two variants of the theorem I am interested in, one with <code>no_index</code> and the other one without. Only the <code>no_index</code> variant works on my example, and I have no idea why that is. Interestingly, the same theorem works flawlessly using <code>rw</code>. Any comments  and advice would be much appreciated. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ofInt_ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">no_index</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ofInt_ofNat_no_noindex</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofInt_ofNat</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- OK</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofInt_ofNat_no_noindex</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Fails</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span><span class=\"o\">]</span>\n\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofInt_ofNat_no_noindex</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- OK</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Interestingly, only for the first variant with <code>no_index</code> \"works\", as in</p>",
        "id": 463300187,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1724042140
    },
    {
        "content": "<p>See <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Polynomial.2Ecoeff.20example/near/395438147\">https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Polynomial.2Ecoeff.20example/near/395438147</a></p>",
        "id": 463306095,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724044393
    },
    {
        "content": "<p>(copy-pasted from Mathlib library note)</p>",
        "id": 463306120,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724044406
    },
    {
        "content": "<p>See also <a href=\"https://github.com/leanprover/lean4/issues/2867\">https://github.com/leanprover/lean4/issues/2867</a></p>",
        "id": 463306187,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724044444
    },
    {
        "content": "<p>Amazing, I added the following to my proposed commit message:</p>\n<blockquote>\n<p>We use <code>no_index</code> to work around special-handling of <code>OfNat.ofNat</code> in <code>DiscrTree</code>, which has been reported as an issue in <a href=\"https://github.com/leanprover/lean4/issues/2867\">#2867</a> and is currently in the process of being fixed in <a href=\"https://github.com/leanprover/lean4/pull/3684\">#3684</a>. As the fix seems non-trivial and might some time to arrive in-tree, we temporarily add the <code>no_index</code> keyword to the problematic subterm.</p>\n</blockquote>\n<p>If you could let me know if this accurately summarizes the issue.</p>",
        "id": 463307407,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1724044936
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> has marked this topic as resolved.</p>",
        "id": 463307631,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724045119
    },
    {
        "content": "<p>Thank you again for your help.</p>",
        "id": 463307646,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1724045126
    },
    {
        "content": "<p>I don't know any details.</p>",
        "id": 463307847,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724045235
    }
]