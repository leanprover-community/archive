[
    {
        "content": "<p>It's always frustrating when something doesn't unify and you think it should, in this case I got</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h_sub</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">h_sub</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">28873</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>but when I say <code>pp.analyze true</code> I get the no-more-useful</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h_sub</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">h_sub</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚àß</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"bp\">‚®Ü</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚®Ö</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®</span><span class=\"n\">MState</span><span class=\"bp\">.</span><span class=\"n\">exp_val</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ‚ü©</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚àß</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">28873</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p><span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span> <br>\n(I tried setting <code>pp.all true</code> and <code>pp.universes false</code> and it makes VSCode hang. This is on <code>4.17.0-rc1</code>)</p>",
        "id": 511493953,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744313581
    },
    {
        "content": "<p>Actually, after <code>clear</code>ing all the local variables I can, <code>pp.all true</code> doesn't hang any more, and the message is <a href=\"https://gist.github.com/Timeroot/8372d401f861d94b62dcb871030c2349\">this</a>. Which is still not very useful.</p>",
        "id": 511494487,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744313797
    },
    {
        "content": "<p>I analyzed this using a free online text comparison tool. Is the complete lattice arising from the complete linear order on <code>Prob</code> defeq to the complete lattice instance on <code>Icc 0 1</code>?</p>",
        "id": 511498491,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744315340
    },
    {
        "content": "<p>Indeed it turned out it was not. (But it was propositionally equal.)</p>",
        "id": 511498630,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744315400
    },
    {
        "content": "<p>I was able to move past this particular thing, but it's more just ... I would still <em>really</em> like a better way to highlight why unification fails.</p>",
        "id": 511498698,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744315432
    },
    {
        "content": "<p>I admit I have no idea how to actually accomplish this in Lean, because I am not a Lean programmer. But I can imagine a world where it comes down to \"pick the most atomic things in the expressions that were tested for defeq-ness and failed, and then expand pretty-printing up to that point to show which two failed\".</p>",
        "id": 511498925,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744315505
    },
    {
        "content": "<p>That actually sounds doable</p>",
        "id": 511499216,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744315614
    },
    {
        "content": "<p>One thing you can do is to put a <code>cast</code> in between the terms, and then <code>congr</code> on the resulting goal.</p>",
        "id": 511500125,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744315941
    },
    {
        "content": "<p>I did something similar to narrow it down - <code>convert &lt;term&gt;</code>, which pretty much does the <code>congr </code> automatically.</p>",
        "id": 511500231,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1744315990
    },
    {
        "content": "<p>There is a thing which does <code>diff</code> on the results of a type mismatch</p>",
        "id": 511502462,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744316854
    },
    {
        "content": "<p>Or at least I thought so... lean has both an expression diff and a text diff tool but the former is only being used to diff goal states (for green/red highlights) and the latter is used to diff <code>#guard_msgs</code> output</p>",
        "id": 511503143,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744317142
    },
    {
        "content": "<p>An expression diff is definitely being used in \"application type mismatch\" errors. (It doesn't use the red/green highlighting yet however.)</p>",
        "id": 511511815,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744320876
    },
    {
        "content": "<p>(<code>pp.analyze</code> is only for trying to make expressions round trip; it doesn't interact with expression diff, and the interaction is not tested)</p>",
        "id": 511511935,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744320930
    },
    {
        "content": "<p>Can you give an MWE <span class=\"user-mention\" data-user-id=\"448405\">@Alex Meiburg</span>?</p>\n<p>There have been a number of improvements to this feature over the last handful of releases (e.g. <a class=\"message-link\" href=\"/#narrow/channel/116290-rss/topic/Recent.20Commits.20to.20lean4.3Amaster/near/480103549\">#rss &gt; Recent Commits to lean4:master @ üí¨</a> ). We use examples to help improve it.</p>",
        "id": 511512323,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744321095
    },
    {
        "content": "<p>It's possible that in this example the expression diff gives up early because the RHS are clearly different (metavariable vs expression), even though the actual reason it's a type mismatch is because of subtle differences on the LHS</p>",
        "id": 511512443,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744321168
    },
    {
        "content": "<p>I was thinking that, but the algorithm tries temporarily assigning metavariables during diffing.</p>",
        "id": 511512500,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744321202
    }
]