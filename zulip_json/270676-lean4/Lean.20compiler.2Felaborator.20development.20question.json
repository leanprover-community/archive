[
    {
        "content": "<p>While perusing the Lean source code, I noticed that the array syntax <code>arr[i]!</code> is used quite a bit.  It seems it's used in <code>for</code> loops, things like <code>x.size.forM</code> loops etc.<br>\nI thought that was unfortunate given Lean is a safe language and wanted to try to do something about it.  I started by  implementing something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Array</span><span class=\"bp\">/</span><span class=\"n\">Iterate</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Array</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"bp\">...</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>which can subsequently be called as (e.g. in a test I added)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arr</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ii</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"bp\">.</span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\">    </span><span class=\"c1\">-- This now produces a sequence of `Fin arr.size`</span>\n<span class=\"w\">    </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"o\">[</span><span class=\"n\">ii</span><span class=\"o\">]</span><span class=\"w\">     </span><span class=\"c1\">-- ... so no []! required!</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">sum</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">]</span>\n\n<span class=\"sd\">/-- info: 15 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>Would something like this be useful/entertained if I turn it into a fully fledged PR?  I have some ideas to make it fully fledged:</p>\n<ul>\n<li>Make it generic via a type class, so e.g. both Array and List can use it</li>\n<li>Support different start and end indices</li>\n<li>Support co-iterating multiple arrays</li>\n</ul>\n<p>As a separate question, I am still trying to figure out <em>where</em> I can actually use it - I'm guessing how Lean is bootstrapped.  I read the \"bootstrapping\" document and rebuilt <code>stage0</code> but I still must be misunderstanding something.  For example, my new function can be used in <code>Elab/GuessLex.lean</code> to rewrite this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">formatTable</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">colWidths</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"n\">xss</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">hj</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">][</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">colWidths</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">colWidths</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">colWidths</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">][</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n</code></pre></div>\n<p>to this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"bp\">.</span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">][</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">colWidths</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">colWidths</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">colWidths</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">xss</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">][</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n</code></pre></div>\n<p>but I don't seem to be able to do the same thing in e.g. <code>Meta/FunInfo.lean</code>.  Any advice?</p>",
        "id": 472934715,
        "sender_full_name": "Tom",
        "timestamp": 1727368168
    },
    {
        "content": "<p><code>for i in indices arr do</code> (or, generically, <code>for i in indices arr do</code>) could be interesting. It might need to go through an RFC process after some discussion here. It'd be good to validate that using <code>indices</code> doesn't incur any runtime overhead. How did you implement it?</p>\n<p>Note that currently you can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arr</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">arr</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">sum</span>\n</code></pre></div>\n<p>and of course for such a simple example you can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arr</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">sum</span>\n</code></pre></div>\n<p>but I know that's not the point.</p>",
        "id": 472948991,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727373729
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> </p>\n<p>Thanks for the feedback.  I am open to a discussion/RFC because I have a few ideas in this area but not sure how many of them should be in the Compiler/Elaborator vs e.g. in a/some library.  I also didn't want to just introduce \"code churn\"  by refactoring the Lean codebase because I imagine that may not be well received.</p>\n<p>I created a draft PR against my own fork of Lean, in order not to clutter the main repo PR list: <a href=\"https://github.com/TomasPuverle/lean4/pull/1/files\">https://github.com/TomasPuverle/lean4/pull/1</a>.  </p>\n<p>In short, the implementation is based on <code>Data.Range</code>'s <code>ForIter</code> and comes out of my earlier experiments of trying to generalize <code>Range</code> itself to support other types than just <code>Nat</code> (i.e. turning the current <code>Range</code> into <code>structure Range (t : Type)</code>).  It also suffers from the same \"bug\" with step that I reported last night.</p>\n<p>I considered implementing <code>ForIter</code> in terms of the <code>for hi: i in [...]</code> but don't have a good grasp of the overheads involved/performance implications of that decision.</p>\n<p>I am aware of the other two forms of <code>for ... in</code>, yes.</p>\n<p>I briefly mentioned some additional ideas for improvements in the original message but as I said, I'd love to come up with an \"extensible core\" where you and others can help guide what should and should be part of the <code>Lean</code> package.</p>",
        "id": 472955260,
        "sender_full_name": "Tom",
        "timestamp": 1727376184
    },
    {
        "content": "<p>As a general observation though, do you know why <code>Fin</code> is not used more?  </p>\n<p>There are many other places where it seems \"like the right thing\" - e.g. even <code>zipWithIndex</code> for <code>Array</code> returns <code>(a x Nat)</code> rather than <code>(a x Fin x.size)</code>.  I'm guessing there are good reasons for this, so I would appreciate any insights to help me understand!</p>",
        "id": 472955823,
        "sender_full_name": "Tom",
        "timestamp": 1727376405
    },
    {
        "content": "<p>Another thought that just occurred to me is that since <code>[]</code> is just macro, perhaps the return type of Range could be <code>Fin x</code>, where <code>x</code> is the expression supplied for <code>end</code>.  In which case it would \"just work\", and ince <code>Fin</code> <code>coe</code>s to Nat, perhaps it wouldn't be too backward-incompatible?</p>",
        "id": 473876349,
        "sender_full_name": "Tom",
        "timestamp": 1727735949
    },
    {
        "content": "<p>nope, that's very backward incompatible.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"c1\">-- 6</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">foo'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n</code></pre></div>",
        "id": 473878337,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727736531
    },
    {
        "content": "<p>it's not that unusual to be doing arithmetic with the numbers yielded by a simple for loop of the form <code>for i in [a:b] do</code></p>",
        "id": 473878463,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727736570
    },
    {
        "content": "<p>I also don't think it's what you want most of the time, unless it is specifically a loop <code>for i in [0:arr.size] do</code> because you want to index into an array</p>",
        "id": 473878847,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727736691
    },
    {
        "content": "<p>and for that you can use another iterator wrapper</p>",
        "id": 473878879,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727736702
    },
    {
        "content": "<p>and IIRC <code>for _h : i in [0:arr.size]</code> is enough to make <code>arr[i]</code> indexing work</p>",
        "id": 473879010,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727736747
    },
    {
        "content": "<p>Good point about <code>Fin</code>!  </p>\n<p>I am (now) aware of the <code>for h: </code> but it was not obvious when I was just getting started.  </p>\n<p>As an aside, because I am not sure if that's the reason but perhaps because it's \"longer\" to type, it seems even the Lean source code itself still falls back on <code>[]!</code> quite a bit.  I am not sure if that's an indication of the fact the the syntax should be \"the other way around\".</p>",
        "id": 473935681,
        "sender_full_name": "Tom",
        "timestamp": 1727755581
    },
    {
        "content": "<p>For a long time the automation associated with array indexing was ~nonexistent, so it might be worthwhile to see how many of those <code>!</code>'s can be removed without further code changes</p>",
        "id": 473987195,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727773096
    },
    {
        "content": "<p>FWIW, I did a bunch of cleanup late last night: <a href=\"https://github.com/leanprover/lean4/pull/5552\">PR</a></p>",
        "id": 474063511,
        "sender_full_name": "Tom",
        "timestamp": 1727795896
    },
    {
        "content": "<p>Thanks for that, I merged that one because it’s just a nice feeling that the program will not do an array bounds check there anymore, even though it likely doesn’t matter on these code paths.</p>\n<p>In general, though, I'd ask external contributors to not be too eager with “cleanup PRs”. Often they have very very little impact (e.g. no improved user experience), and there is a tangible cost in terms of reviewing them, of noisy <code>git blame</code> and possible conflicts with existing PRs.</p>",
        "id": 474068246,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1727797342
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> !  I will make sure to check in the future.</p>",
        "id": 474068760,
        "sender_full_name": "Tom",
        "timestamp": 1727797543
    }
]