[
    {
        "content": "<p>Having incrementality in the new Lean version is really nice! </p>\n<p>I'm interested in writing my own incremental commands and tactics. Are there any simple examples of incremental commands? Also, I have noticed that <code>conv</code> is not incremental, how would I go about implementing an incremental elaborator for <code>convSeq</code>?</p>",
        "id": 448464406,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1719878981
    },
    {
        "content": "<p>I'm trying to make sense of <a href=\"https://github.com/leanprover/lean4/blob/d5a45dfa8b2600e300bd1968e91f2b17951d5e98/src/Lean/Elab/Tactic/BuiltinTactic.lean#L280\">https://github.com/leanprover/lean4/blob/d5a45dfa8b2600e300bd1968e91f2b17951d5e98/src/Lean/Elab/Tactic/BuiltinTactic.lean#L280</a> and <a href=\"https://github.com/leanprover/lean4/blob/d5a45dfa8b2600e300bd1968e91f2b17951d5e98/src/Lean/Elab/Term.lean#L356\">https://github.com/leanprover/lean4/blob/d5a45dfa8b2600e300bd1968e91f2b17951d5e98/src/Lean/Elab/Term.lean#L356</a>  <br>\nI'm a bit unsure if I'm digging too deep or not.</p>",
        "id": 448465087,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1719879366
    },
    {
        "content": "<p>You can take a look at the existing <code>builtin_incremental</code> tactics but it is very much not simple. There is some high-level documentation in the library note \"Incremental Command Elaboration\".</p>",
        "id": 448556611,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1719913400
    },
    {
        "content": "<p>Here is a simple macro <code>#def_strings a b c</code> which just expands into </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n</code></pre></div>\n<p>How can I make this incremental? </p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">:=</span><span class=\"n\">defStringsStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"#def_strings\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"n\">macro_rules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defStringsStx</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax.mkStrLit</span><span class=\"w\"> </span><span class=\"n\">x.getId.toString</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">def_strings</span>\n<span class=\"w\">  </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"n\">d</span>\n<span class=\"w\">  </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">f</span>\n\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n</div></div>",
        "id": 450607267,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1720663563
    },
    {
        "content": "<p>I have a solution! The command <code>#def_strings a b c ...</code> defines <code>def a := \"a\", def b := \"b\", ...</code> incrementally. To see the effect I made sure that each new definition takes 1s to elaborate.</p>\n<p>One big missing thing is to update the info tree, but I have no experience with that.</p>\n<p>The solution is an extremely stripped down version of <a href=\"https://github.com/leanprover/lean4/blob/fce82eba400ea282ebc8d29bc9ba55727647c9a6/src/Lean/Elab/Command.lean#L364\"><code>elabCommand</code></a></p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">:=</span><span class=\"n\">defStringsStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"#def_strings\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">CommandSeqSnapshot</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">Language.Snapshot</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Command.State</span><span class=\"o\">)</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TypeName</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language.ToSnapshotTree</span><span class=\"w\"> </span><span class=\"n\">CommandSeqSnapshot</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toSnapshotTree</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">s.toSnapshot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]⟩</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">defStringsStx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">defStringsElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withLogging</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withIncRecDepth</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withFreshMacroScope</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">snap</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oldSnap</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">snap.old</span><span class=\"bp\">?.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">val.get.toTyped</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">CommandSeqSnapshot</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">join</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oldData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">oldSnap</span><span class=\"bp\">?.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">old.data</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">reuse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">newData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">xs.size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">        </span><span class=\"c1\">-- reuse old state if possible</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">reuse</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">oldData.size</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">oldState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">oldData</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">oldState</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">newData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newData.push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">oldState</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"n\">reuse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax.mkStrLit</span><span class=\"w\"> </span><span class=\"n\">x.getId.toString</span>\n<span class=\"w\">        </span><span class=\"n\">withoutCommandIncrementality</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"n\">newData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newData.push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x.raw</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span>\n\n<span class=\"w\">      </span><span class=\"n\">snap.new.resolve</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofTyped</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">          </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">          </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newData</span>\n<span class=\"w\">          </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandSeqSnapshot</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"no snapshot\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n\n\n<span class=\"bp\">#</span><span class=\"n\">def_strings</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n</div></div>",
        "id": 450623514,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1720674720
    }
]