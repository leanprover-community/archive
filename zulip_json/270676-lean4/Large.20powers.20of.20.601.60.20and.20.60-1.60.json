[
    {
        "content": "<p>I was complaining to <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> that there is no <code>@[csimp]</code> lemma for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.negOnePow#doc\">docs#Int.negOnePow</a>, so this code overflows.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">NegOnePow</span>\n\n<span class=\"c1\">-- stack overflow</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negOnePow</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>Then I was confused, since <code>Int.negOnePow</code> would be evaluating <code>(-1) ^ 10 ^ 2 ^ 10</code>, which should presumably be some bignum computation that sees the base is <code>-1</code> and tests the exponent for even or odd. It turns out <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.pow#doc\">docs#Int.pow</a> is defined recursively instead of in terms of <code>Nat.pow</code>, so this also overflows.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- stack overflow</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>and while I was testing it for <code>Nat</code> I discovered that this panics:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- INTERNAL PANIC: Nat.pow exponent is too big</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>So</p>\n<ul>\n<li>should <code>Int.pow</code> be defined in terms of <code>Nat.pow</code>?</li>\n<li>should <code>Nat.pow</code> panic when the exponent is too big even when the base is <code>1</code> or <code>0</code>?</li>\n</ul>",
        "id": 530617797,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753379818
    },
    {
        "content": "<p>In the past I thought it was strange that we limit <code>b</code> in <code>a ^ b</code> and not <code>log a * b</code></p>",
        "id": 530630389,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753384629
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>, I believe you are talking about <a href=\"https://github.com/leanprover-community/mathlib4/pull/4637\">#4637</a>. That was about safe exponentiation in the kernel and in <code>whnf</code>. The bound for the exponent is 256 by default and can be changed using <code>set_option exponentiation.threshold</code>).</p>\n<p>What <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> is complaining about is what happens in compiled code, where the c++ for <code>Nat.pow</code>is this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_obj_res</span><span class=\"w\"> </span><span class=\"n\">lean_nat_pow</span><span class=\"o\">(</span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">lean_is_scalar</span><span class=\"o\">(</span><span class=\"n\">a2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">a2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">UINT_MAX</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">lean_internal_panic</span><span class=\"o\">(</span><span class=\"s2\">\"Nat.pow exponent is too big\"</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean_is_scalar</span><span class=\"o\">(</span><span class=\"n\">a1</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mpz_to_nat</span><span class=\"o\">(</span><span class=\"n\">mpz</span><span class=\"bp\">::</span><span class=\"n\">of_size_t</span><span class=\"o\">(</span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">a1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">pow</span><span class=\"o\">(</span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">a2</span><span class=\"o\">)))</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mpz_to_nat</span><span class=\"o\">(</span><span class=\"n\">mpz_value</span><span class=\"o\">(</span><span class=\"n\">a1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pow</span><span class=\"o\">(</span><span class=\"n\">lean_unbox</span><span class=\"o\">(</span><span class=\"n\">a2</span><span class=\"o\">)))</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>So, the bound for the exponent is 4294967296.</p>",
        "id": 530659736,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1753397636
    },
    {
        "content": "<p>I think the same argument for using some limit on<code>log a1 * a2</code> still applies, especially as log2 should be fast to compute on bignums</p>",
        "id": 530660024,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753397793
    }
]