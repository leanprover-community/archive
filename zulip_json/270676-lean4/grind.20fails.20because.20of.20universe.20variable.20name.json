[
    {
        "content": "<p>Below is an example where the name of a universe variable influences whether <code>grind</code> succeeds.<br>\nShall I open this as an issue to the Lean repository?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"c1\">-- We use `ULift Nat` as our (artificial) universe polymorphic type</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"c1\">-- replacing `.{v}` by `.{u}` makes the `grind` below succeed</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `grind [foo.{u}]` works.</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 570650335,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1769630787
    },
    {
        "content": "<p>Wow, <code>grind</code> must be not instantiating the universes in <code>foo.{u}</code>, and if another universe happens to already be called <code>u</code>, then that matches with this <code>u</code>.</p>",
        "id": 570690675,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1769650961
    },
    {
        "content": "<p>Thanks for the report! This is now fixed in <a href=\"https://github.com/leanprover/lean4/pull/12226\">lean#12226</a>.</p>\n<p>The bug was in <code>instantiateGroundTheorem</code> (used for theorems with no quantified parameters like your <code>foo</code>). It was passing <code>thm.proof</code> directly instead of calling <code>getProofWithFreshMVarLevels</code>, so ground theorems retained their original universe level params (like <code>foo.{v}</code>) instead of getting fresh level metavariables that could unify with the goal's universe levels.</p>",
        "id": 570697643,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769656232
    }
]