[
    {
        "content": "<p>I am confused by the following behaviour, which appears to suggest that abbreviations for projections of classes don't reduce, but abbreviations for projections of structures do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Elem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Elem_abbr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Elem</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Elem_abbr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Elem_abbr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Elem_abbr</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- passes</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Elem</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"c1\">-- passes</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Elem2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Elem2_abbr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Elem2</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Elem2_abbr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- passes</span>\n</code></pre></div>\n<p>Can anyone explain what is going on here?</p>",
        "id": 525227013,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750616639
    },
    {
        "content": "<p>I suppose this is to prevent something like <code>Neg.neg</code> on a reducible instance from reducing?</p>",
        "id": 525227719,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750617623
    },
    {
        "content": "<p>hmm<br>\ndoes this mean that abbreviations for classes are pointless? and you might as well use defs since you have to write API to reduce them anyway?</p>",
        "id": 525228069,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750618210
    },
    {
        "content": "<p>The relevant code appears to be <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Simp.reduceProjFn%3F#doc\">docs#Lean.Meta.Simp.reduceProjFn?</a></p>\n<p>I didn't take a look at the issue, but a comment in the code mentions that issue <a href=\"https://github.com/leanprover/lean4/pull/1869\">lean4#1869</a> led to an exception where simp will reduce a class projection applied to a constructor. It won't unfold the argument to see if it's a constructor. Maybe take a look at that issue?</p>",
        "id": 525229695,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750620621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60simp.60.20can't.20see.20through.20structure.20abbrevs.3F/near/525229695\">said</a>:</p>\n<blockquote>\n<p>The relevant code appears to be <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.Simp.reduceProjFn%3F#doc\">docs#Lean.Meta.Simp.reduceProjFn?</a></p>\n<p>I didn't take a look at the issue, but a comment in the code mentions that issue <a href=\"https://github.com/leanprover/lean4/pull/1869\">lean4#1869</a> led to an exception where simp will reduce a class projection applied to a constructor. It won't unfold the argument to see if it's a constructor. Maybe take a look at that issue?</p>\n</blockquote>\n<p>I can't find this declaration sorry</p>",
        "id": 525229780,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750620720
    },
    {
        "content": "<p>Maybe it's private?</p>",
        "id": 525229810,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750620767
    },
    {
        "content": "<p>Found it:<br>\n<a href=\"https://github.com/leanprover/lean4/blob/ded8a0cb57b806a90e0b6cc41e2b23118e286329/src/Lean/Meta/Tactic/Simp/Main.lean#L66-L105\">https://github.com/leanprover/lean4/blob/ded8a0cb57b806a90e0b6cc41e2b23118e286329/src/Lean/Meta/Tactic/Simp/Main.lean#L66-L105</a></p>",
        "id": 525229916,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750620898
    },
    {
        "content": "<p>I'm a bit confused. There's no projection of a <code>mk</code> in the example in <a href=\"https://github.com/leanprover/lean4/pull/1869\">lean4#1869</a><br>\nI don't think it's the same issue</p>",
        "id": 525230055,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750621118
    },
    {
        "content": "<p>Possibly you'll have to do some git-blame to figure out which commit introduced this feature to <code>reduceProjFn?</code>, in case the issue number in the comment is incorrect.</p>",
        "id": 525230213,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750621336
    },
    {
        "content": "<p>No I think it's right<br>\nanyway I see the issue<br>\nas lemma <code>test3</code> shows, <code>simp</code> <em>can</em> reduce a projection of a <code>mk</code> - that's not the problem!<br>\nthe problem comes when the class <code>mk</code> is gated behind an abbreviation<br>\nit's specifically this combination which causes problems: (1) a class structure <code>Class</code> (2) an abbreviation of <code>Class.mk</code> (3) a projection from <code>Class</code><br>\nif only 2 of these 3 are present, then <code>simp</code> succeeds as expected</p>",
        "id": 525231017,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750622498
    },
    {
        "content": "<p>in particular, this issue only applies to reducing projections - simp sees through abbrev perfectly well when searching up lemmas!</p>",
        "id": 525233284,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750625774
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 525233336,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750625865
    },
    {
        "content": "<p>OK <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> I had a look at the code, as you say it looks like <code>simp</code> doesn't unfold reducible definitions specifically when checking if the argument to a class projection is of the form <code>Class.mk ...</code><br>\nthis is unintended, right?</p>",
        "id": 525233624,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750626215
    },
    {
        "content": "<p>Not sure if it's unintended — it'll take figuring out why it was added exactly. (And why having an <code>abbrev</code> of a class constructor should be supported for whatever purpose this feature was added, or why your use of an <code>abbrev</code> class constructor should be supported.)</p>",
        "id": 525233717,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750626360
    },
    {
        "content": "<p>my (naive) understanding is that <code>abbrev</code> should be transparent to <code>simp</code><br>\nso my thought was that, whether or not <code>simp</code> should reduce <code>(Class.mk ...).proj</code> by default, it should do this uniformly at the level of reducibility</p>",
        "id": 525233821,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750626535
    },
    {
        "content": "<p>Take what I'm saying as \"this is the research that would need to be done to understand the situation, to decide whether anything needs to be done, and then make a case for changing things\". It's best when there's some demonstrable issue; and especially since there is special logic for class projections in simp, things seeming a little inconsistent isn't enough yet to go on.</p>\n<p>If I had some time I might look into this, but I can only give these pointers at the moment.</p>",
        "id": 525233983,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750626852
    },
    {
        "content": "<p>This demonstrable issue business is why I'm suggesting to look at the motivating issue, to see if something you're doing is somehow something that is related and should have been fixed too.</p>",
        "id": 525234019,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750626913
    },
    {
        "content": "<p>The thing that I'm doing is attempting to prove things about abbreviations for some <code>Class.mk</code> in a complicated mathlib setting</p>",
        "id": 525234189,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1750627220
    },
    {
        "content": "<p>Here is a similar issue I came across just now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">MyPair</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">myFst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyPair</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">mySnd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyPair</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myFst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">myFst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- Error: `simp` made no progress</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>This is causing Aesop to fail in some cases: because it does see through the <code>MyPair</code> abbreviation. So <code>myFst (x : MyPair)</code> gets case-split into <code>myFst (a, b)</code> and <code>simp_all</code> chokes on that.</p>",
        "id": 534442087,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1755163628
    },
    {
        "content": "<p>Hmm, there aren't any classes involved here, so it must be a slightly different issue</p>",
        "id": 534443694,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755164261
    },
    {
        "content": "<p>It's going to be to do with whatever simproc or whatever it's called fires on <code>Prod.fst (a,b)</code>, right?</p>",
        "id": 534444238,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755164476
    },
    {
        "content": "<p>I think it's the same <code>reduceProjFn?</code> code that goes wrong, but I have not actually tried to follow the code in action.</p>",
        "id": 534445691,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1755165072
    },
    {
        "content": "<p>From what I remember of that code, it must be a different thing, but I don't have access to an environment right now so I'm talking out my ass</p>",
        "id": 534445823,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755165130
    },
    {
        "content": "<p>It might be an issue, but I don't think that this is necessarily a bug in <code>reduceProjFn?</code>, since one could argue that it's working as designed (only projection functions get reduced — why is <code>myFst</code> a projection function?)</p>\n<p>One point of comparison is issue <a href=\"https://github.com/leanprover/lean4/pull/5606\">lean4#5606</a>, which was closed. That's a more involved case, where a subterm after unfolding a reducible definition can be simplified, but simp doesn't tentatively unfold reducible definitions.</p>\n<p>Maybe there should be a way to be able to <em>declare</em> that a function is meant to be a projection? After all, the <code>structure</code>/<code>class</code> commands themselves register that projection functions are projections.</p>",
        "id": 534574872,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755214400
    },
    {
        "content": "<p>To reiterate, <code>simp</code> <em>can</em> see through structure abbrevs to reduce a structure projection - but it can't do the same for class abbrevs. Nor, apparently, can it do so with other abbrevs.<br>\nThe issue to me is the inconsistency, because it makes it hard to design API</p>",
        "id": 534575066,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755214534
    }
]