[
    {
        "content": "<p>New user here. Trying to write a TOML parser as an exercise, but the type definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span>\n\n<span class=\"c1\">--</span>\n<span class=\"c1\">-- A definition of the kinds of types given in the TOML specification at</span>\n<span class=\"c1\">-- https://toml.io/en/v1.0.0#objectives.</span>\n<span class=\"c1\">--</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TOMLType</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">boolean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">float</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elems</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">TOMLType</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kvPairs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">TOMLType</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"c1\">-- TODO: add more types like DateTime here.</span>\n</code></pre></div>\n<p>throws the error</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span>/10<span class=\"o\">]</span><span class=\"w\"> </span>Building<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\ntrace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib<span class=\"w\"> </span><span class=\"nv\">DYLD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"w\"> </span>/usr/local/lean/v4.14.0/bin/lean<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/SantunLeanTOMLParser/TOMLTypes.c<span class=\"w\"> </span>--json\nerror:<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean:13:21:<span class=\"w\"> </span><span class=\"k\">function</span><span class=\"w\"> </span>expected<span class=\"w\"> </span>at\n<span class=\"w\">  </span>HashMap\nterm<span class=\"w\"> </span>has<span class=\"w\"> </span><span class=\"nb\">type</span>\n<span class=\"w\">  </span>?m.21\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>\n<p>What am I doing wrong?</p>",
        "id": 490861176,
        "sender_full_name": "Santtu",
        "timestamp": 1735208487
    },
    {
        "content": "<p>HashMap is scoped, you need to refer to <code>Std.HashMap</code>, the expects a function thing is Lean's auto implicit feature that turns names that are not bound into implicit arguments automatically. You can disable it if you want but you should also be able to tell by the semantic highlighting in your editor.</p>",
        "id": 490864590,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735210818
    },
    {
        "content": "<p>So I should import <code>Std.HashMap</code> instead? Also, I'm actually using just Vim with only a simple syntax highlighting file and no fancy LSP features, so I am a bit handicapped in that sense. :D</p>",
        "id": 490864973,
        "sender_full_name": "Santtu",
        "timestamp": 1735211020
    },
    {
        "content": "<p>No you should write <code>kvPairs : Std.HashMap String ..</code>.</p>\n<p>I would also not recommend using Lean without an LSP, it's going to be a significantly more difficult experience. There is a great neovim plugin if you want to use that.</p>",
        "id": 490865275,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735211122
    },
    {
        "content": "<p>Hmm. Without the import of <code>Std.HashMap</code> I get an error message</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>trace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib<span class=\"w\"> </span><span class=\"nv\">DYLD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"w\"> </span>/usr/local/lean/v4.14.0/bin/lean<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/SantunLeanTOMLParser/TOMLTypes.c<span class=\"w\"> </span>--json\nerror:<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean:11:24:<span class=\"w\"> </span>unknown<span class=\"w\"> </span>identifier<span class=\"w\"> </span><span class=\"s1\">'Std.HashMap'</span>\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>\n<p>With the import of <code>Std.HashMap</code> in place, I get</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>✖<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">3</span>/10<span class=\"o\">]</span><span class=\"w\"> </span>Building<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\ntrace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib<span class=\"w\"> </span><span class=\"nv\">DYLD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"w\"> </span>/usr/local/lean/v4.14.0/bin/lean<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/SantunLeanTOMLParser/TOMLTypes.c<span class=\"w\"> </span>--json\nerror:<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean:1:0:<span class=\"w\"> </span>object<span class=\"w\"> </span>file<span class=\"w\"> </span><span class=\"s1\">'/usr/local/lean/v4.14.0/lib/lean/Std/HashMap.olean'</span><span class=\"w\"> </span>of<span class=\"w\"> </span>module<span class=\"w\"> </span>Std.HashMap<span class=\"w\"> </span>does<span class=\"w\"> </span>not<span class=\"w\"> </span>exist\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>",
        "id": 490869065,
        "sender_full_name": "Santtu",
        "timestamp": 1735213317
    },
    {
        "content": "<p>Could this be related to my Lean installation? I copied the files from GitHub releases to <code>/usr/local/lean/...</code> and created symbolic links to the binaries in a folder in my path. But when I look at the installation location, I do not see any <code>.olean</code> files.</p>",
        "id": 490869700,
        "sender_full_name": "Santtu",
        "timestamp": 1735213694
    },
    {
        "content": "<p>No, you need to do <em>both</em></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span>\n</code></pre></div>\n<p><em>and</em> type<br>\n<code>Std.HashMap String ...</code></p>",
        "id": 490870500,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735214269
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"815145\">Santtu</span> <a href=\"#narrow/channel/270676-lean4/topic/HashMap.20expects.20a.20function/near/490869700\">said</a>:</p>\n<blockquote>\n<p>Could this be related to my Lean installation? I copied the files from GitHub releases to <code>/usr/local/lean/...</code> and created symbolic links to the binaries in a folder in my path. But when I look at the installation location, I do not see any <code>.olean</code> files.</p>\n</blockquote>\n<p>and regarding this i would <em>highly</em> recommend to use elan if you plan on stickign with lean for any amount of time</p>",
        "id": 490870567,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735214310
    },
    {
        "content": "<p>Right. I'll get to know elan, once I get this thing to compile. :D But the problem was that I needed to import <code>Std.Data.HashMap</code>, but when actually declaring the table type, I needed to use <code>Std.HashMap</code> instead. A bit confusing, but I guess that is just a namespace vs module thing? Now I get the error</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>trace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib<span class=\"w\"> </span><span class=\"nv\">DYLD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"w\"> </span>/usr/local/lean/v4.14.0/bin/lean<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/SantunLeanTOMLParser/TOMLTypes.c<span class=\"w\"> </span>--json\nerror:<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean:13:42:<span class=\"w\"> </span>application<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>mismatch\n<span class=\"w\">  </span>@Std.HashMap<span class=\"w\"> </span>String<span class=\"w\"> </span>fun<span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"o\">=</span>&gt;<span class=\"w\"> </span>TOMLType\nargument\n<span class=\"w\">  </span>fun<span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"o\">=</span>&gt;<span class=\"w\"> </span>TOMLType\nhas<span class=\"w\"> </span><span class=\"nb\">type</span>\n<span class=\"w\">  </span>?m.23<span class=\"w\"> </span>→<span class=\"w\"> </span>Type<span class=\"w\"> </span>?u.16<span class=\"w\"> </span>:<span class=\"w\"> </span>Sort<span class=\"w\"> </span><span class=\"o\">(</span>max<span class=\"w\"> </span><span class=\"o\">(</span>?u.16<span class=\"w\"> </span>+<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span>?u.22<span class=\"o\">)</span>\nbut<span class=\"w\"> </span>is<span class=\"w\"> </span>expected<span class=\"w\"> </span>to<span class=\"w\"> </span>have<span class=\"w\"> </span><span class=\"nb\">type</span>\n<span class=\"w\">  </span>Type<span class=\"w\"> </span>?u.20<span class=\"w\"> </span>:<span class=\"w\"> </span>Type<span class=\"w\"> </span><span class=\"o\">(</span>?u.20<span class=\"w\"> </span>+<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">)</span>\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>\n<p>Almost there.</p>",
        "id": 490870904,
        "sender_full_name": "Santtu",
        "timestamp": 1735214536
    },
    {
        "content": "<p>It seems like the second argument should not be a function at all, but something else. I guess this is related to kinds somehow?</p>",
        "id": 490871620,
        "sender_full_name": "Santtu",
        "timestamp": 1735215099
    },
    {
        "content": "<p>The second argument should just be <code>TOMLType</code></p>",
        "id": 490872183,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735215424
    },
    {
        "content": "<p>If the value type of the <code>HashMap</code> is changed to <code>TOMLType</code>, we get another error:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>trace:<span class=\"w\"> </span>.&gt;<span class=\"w\"> </span><span class=\"nv\">LEAN_PATH</span><span class=\"o\">=</span>././.lake/build/lib<span class=\"w\"> </span><span class=\"nv\">DYLD_LIBRARY_PATH</span><span class=\"o\">=</span><span class=\"w\"> </span>/usr/local/lean/v4.14.0/bin/lean<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean<span class=\"w\"> </span>-R<span class=\"w\"> </span>./././.<span class=\"w\"> </span>-o<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.olean<span class=\"w\"> </span>-i<span class=\"w\"> </span>././.lake/build/lib/SantunLeanTOMLParser/TOMLTypes.ilean<span class=\"w\"> </span>-c<span class=\"w\"> </span>././.lake/build/ir/SantunLeanTOMLParser/TOMLTypes.c<span class=\"w\"> </span>--json\nerror:<span class=\"w\"> </span>././././SantunLeanTOMLParser/TOMLTypes.lean:7:0:<span class=\"w\"> </span><span class=\"o\">(</span>kernel<span class=\"o\">)</span><span class=\"w\"> </span>arg<span class=\"w\"> </span><span class=\"c1\">#1 of '_nested.Std.HashMap_2.mk' contains a non valid occurrence of the datatypes being declared</span>\nerror:<span class=\"w\"> </span>Lean<span class=\"w\"> </span>exited<span class=\"w\"> </span>with<span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">1</span>\nSome<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>SantunLeanTOMLParser.TOMLTypes\nerror:<span class=\"w\"> </span>build<span class=\"w\"> </span>failed\n</code></pre></div>",
        "id": 490878372,
        "sender_full_name": "Santtu",
        "timestamp": 1735219648
    },
    {
        "content": "<p>Ah, looking at the documentation comment for <code>Std.Data.HashMap</code> we see a probable reason: <a href=\"https://github.com/leanprover/lean4/blob/8a1e50f0b98337f5d0f9a9697f95f10237c4a77c/src/Std/Data/HashMap/Basic.lean#L51-L54\">https://github.com/leanprover/lean4/blob/8a1e50f0b98337f5d0f9a9697f95f10237c4a77c/src/Std/Data/HashMap/Basic.lean#L51-L54</a></p>",
        "id": 490878732,
        "sender_full_name": "Santtu",
        "timestamp": 1735219857
    },
    {
        "content": "<p>So I guess standard <code>HashMap</code>s cannot be used in inductive types at all.</p>",
        "id": 490878810,
        "sender_full_name": "Santtu",
        "timestamp": 1735219916
    },
    {
        "content": "<p>And indeed, changing all instances of <code>HashMap</code> to <code>HashMap.Raw</code> allows the code to compile.</p>",
        "id": 490878962,
        "sender_full_name": "Santtu",
        "timestamp": 1735219996
    },
    {
        "content": "<p>But I guess this will carry some caveats regarding code safety.</p>",
        "id": 490879003,
        "sender_full_name": "Santtu",
        "timestamp": 1735220029
    }
]