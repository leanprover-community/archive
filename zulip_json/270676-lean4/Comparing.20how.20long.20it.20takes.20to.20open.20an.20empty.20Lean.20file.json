[
    {
        "content": "<p>I've been doing some light microbenchmarking to try and understand why <code>lean.nvim</code>'s test suite takes 30 seconds to run (it does a lot of creating throwaway Lean files). In the process I've been poking at differences in how long it takes to open a Lean file and get a sign from the LSP that Lean is ready to go. I'm not sure I have a real question or point yet but perhaps the below is interesting to someone -- I presume someone more familiar than I am with the details of lake serve's startup will know more precisely what's happening in the startup procedure in each scenario below.</p>\n<p>Specifically I timed how long it takes to open a Lean file and have it be ready to go in a few scenarios: 1 as a top level file in a Lean package with fewer dependencies, 2) a standalone file outside of a project 3) as a toplevel file in a project with heavier dependencies (Mathlib) 4) inside of the packages themselves 5) opening an existing file (I picked some random one from lean4export)</p>\n<p>Here's the results below:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Time until $/lean/fileProgress says we're done processing our file</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>⊙  hyperfine --warmup 3 -L file $DEVELOPMENT/Mathlib4/insideProject.lean,$DEVELOPMENT/Mathlib4/Mathlib4/insidePackage.lean,~/Desktop/outsideProject.lean,$DEVELOPMENT/lean4export/fewerDeps.lean,$DEVELOPMENT/lean4export/Export.lean &quot;nvim --cmd &#39;luafile $DEVELOPMENT/lean.nvim/microbench.lua&#39; {file}&quot;\nBenchmark 1: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/insideProject.lean\n  Time (mean ± σ):      1.987 s ±  0.212 s    [User: 0.233 s, System: 0.097 s]\n  Range (min … max):    1.511 s …  2.165 s    10 runs\n\nBenchmark 2: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/Mathlib4/insidePackage.lean\n  Time (mean ± σ):      2.225 s ±  0.038 s    [User: 0.259 s, System: 0.109 s]\n  Range (min … max):    2.172 s …  2.291 s    10 runs\n\nBenchmark 3: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; ~/Desktop/outsideProject.lean\n  Time (mean ± σ):      1.115 s ±  0.134 s    [User: 0.213 s, System: 0.085 s]\n  Range (min … max):    0.901 s …  1.340 s    10 runs\n\nBenchmark 4: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/fewerDeps.lean\n  Time (mean ± σ):     675.8 ms ±   4.0 ms    [User: 179.5 ms, System: 59.3 ms]\n  Range (min … max):   670.2 ms … 682.8 ms    10 runs\n\nBenchmark 5: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/Export.lean\n  Time (mean ± σ):     859.8 ms ±   2.3 ms    [User: 180.9 ms, System: 68.2 ms]\n  Range (min … max):   854.2 ms … 862.1 ms    10 runs\n\nSummary\n  nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/fewerDeps.lean ran\n    1.27 ± 0.01 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/Export.lean\n    1.65 ± 0.20 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; ~/Desktop/outsideProject.lean\n    2.94 ± 0.31 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/insideProject.lean\n    3.29 ± 0.06 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/Mathlib4/insidePackage.lean\n</code></pre></div>\n</div></div>\n<p>If we instead only wait until we <em>start</em> processing a file (i.e. until yellow bars show up), the results on my machine look like:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Time until $/lean/fileProgress says we started processing</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>⊙  hyperfine --warmup 3 -L file $DEVELOPMENT/Mathlib4/insideProject.lean,$DEVELOPMENT/Mathlib4/Mathlib4/insidePackage.lean,~/Desktop/outsideProject.lean,$DEVELOPMENT/lean4export/fewerDeps.lean,$DEVELOPMENT/lean4export/Export.lean &quot;nvim --cmd &#39;luafile $DEVELOPMENT/lean.nvim/microbench.lua&#39; {file}&quot;\nBenchmark 1: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/insideProject.lean\n  Time (mean ± σ):     784.3 ms ± 200.1 ms    [User: 157.5 ms, System: 88.7 ms]\n  Range (min … max):   448.8 ms … 1055.8 ms    10 runs\n\nBenchmark 2: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/Mathlib4/insidePackage.lean\n  Time (mean ± σ):      1.375 s ±  0.176 s    [User: 0.169 s, System: 0.099 s]\n  Range (min … max):    1.142 s …  1.644 s    10 runs\n\nBenchmark 3: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; ~/Desktop/outsideProject.lean\n  Time (mean ± σ):      1.058 s ±  0.056 s    [User: 0.176 s, System: 0.100 s]\n  Range (min … max):    0.959 s …  1.123 s    10 runs\n\nBenchmark 4: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/fewerDeps.lean\n  Time (mean ± σ):     713.7 ms ± 120.4 ms    [User: 201.4 ms, System: 101.7 ms]\n  Range (min … max):   520.4 ms … 962.2 ms    10 runs\n\nBenchmark 5: nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/Export.lean\n  Time (mean ± σ):     892.8 ms ± 172.7 ms    [User: 224.2 ms, System: 120.2 ms]\n  Range (min … max):   429.6 ms … 1023.9 ms    10 runs\n\n  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the &#39;--warmup&#39; or &#39;--prepare&#39; options.\n\nSummary\n  nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/fewerDeps.lean ran\n    1.10 ± 0.34 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/insideProject.lean\n    1.25 ± 0.32 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/lean4export/Export.lean\n    1.48 ± 0.26 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; ~/Desktop/outsideProject.lean\n    1.93 ± 0.41 times faster than nvim --cmd &#39;luafile /Users/julian/Development/lean.nvim/microbench.lua&#39; /Users/julian/Development/Mathlib4/Mathlib4/insidePackage.lean\n</code></pre></div>\n</div></div>\n<p>and here there is at least a minor interesting thing to note which is that there is a decent size cost paid when opening a standalone file until <code>lake</code> notices there is no lakefile and falls back to <code>lean --server</code>. Sometimes this is a full second of lost time. Again I'm not sure this is an area of interest but perhaps there's a bit of optimization possible there (e.g. by having the elan wrappers do a quick check for a lakefile before even trying to invoke lake?)</p>\n<p>For completeness here's my silly microbenchmark script in case anyone cares to try it:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>microbench.lua</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lua\"><pre><span></span><code><span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"nv\">f</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">io.open</span><span class=\"p\">(</span><span class=\"s2\">\"timing\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"w\"</span><span class=\"p\">)</span>\n<span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"nv\">t0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">uv</span><span class=\"p\">.</span><span class=\"nf\">hrtime</span><span class=\"p\">()</span>\n<span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"kr\">function</span><span class=\"w\"> </span><span class=\"nf\">log_time</span><span class=\"p\">(</span><span class=\"nv\">label</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"nv\">elapsed</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">uv</span><span class=\"p\">.</span><span class=\"nf\">hrtime</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"nv\">t0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mf\">1e9</span>\n<span class=\"w\">  </span><span class=\"nv\">f</span><span class=\"p\">:</span><span class=\"nf\">write</span><span class=\"p\">(</span><span class=\"nb\">string.format</span><span class=\"p\">(</span><span class=\"s2\">\"%s: %.3f</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">label</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">elapsed</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"nv\">f</span><span class=\"p\">:</span><span class=\"nf\">flush</span><span class=\"p\">()</span>\n<span class=\"kr\">end</span>\n\n<span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">api</span><span class=\"p\">.</span><span class=\"nf\">nvim_create_autocmd</span><span class=\"p\">(</span><span class=\"s2\">\"Filetype\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nv\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"lean\"</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nv\">once</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nv\">callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">function</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nf\">log_time</span><span class=\"p\">(</span><span class=\"s2\">\"Filetype\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"kr\">end</span><span class=\"p\">,</span>\n<span class=\"p\">})</span>\n<span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">api</span><span class=\"p\">.</span><span class=\"nf\">nvim_create_autocmd</span><span class=\"p\">(</span><span class=\"s2\">\"LspAttach\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nv\">once</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nv\">callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">function</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"nf\">log_time</span><span class=\"p\">(</span><span class=\"s2\">\"lsp is ready\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"kr\">end</span><span class=\"p\">,</span>\n<span class=\"p\">})</span>\n<span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">api</span><span class=\"p\">.</span><span class=\"nf\">nvim_create_autocmd</span><span class=\"p\">(</span><span class=\"s2\">\"User\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nv\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanProgressUpdate\"</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nv\">callback</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">function</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"nv\">progress</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">require</span><span class=\"p\">(</span><span class=\"s1\">'lean.progress'</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"kd\">local</span><span class=\"w\"> </span><span class=\"nv\">current</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nv\">progress</span><span class=\"p\">.</span><span class=\"nf\">at</span><span class=\"p\">(</span><span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">lsp</span><span class=\"p\">.</span><span class=\"py\">util</span><span class=\"p\">.</span><span class=\"nf\">make_position_params</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">'utf-16'</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"nv\">current</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nv\">progress</span><span class=\"p\">.</span><span class=\"py\">Kind</span><span class=\"p\">.</span><span class=\"py\">processing</span><span class=\"w\"> </span><span class=\"kr\">then</span>\n<span class=\"w\">      </span><span class=\"nf\">log_time</span><span class=\"p\">(</span><span class=\"s2\">\"$/lean/fileProgress processing\"</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"nv\">vim</span><span class=\"p\">.</span><span class=\"py\">cmd</span><span class=\"p\">.</span><span class=\"nf\">quitall</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"kr\">else</span>\n<span class=\"w\">      </span><span class=\"nf\">log_time</span><span class=\"p\">(</span><span class=\"s2\">\"$/lean/fileProgress finished\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"kr\">end</span>\n<span class=\"w\">  </span><span class=\"kr\">end</span><span class=\"p\">,</span>\n<span class=\"p\">})</span>\n</code></pre></div>\n</div></div>\n<p>(all the actual files in the hyperfine line don't exist on disk, other than <code>Export.lean</code> of course)</p>",
        "id": 528977184,
        "sender_full_name": "Julian Berman",
        "timestamp": 1752639411
    }
]