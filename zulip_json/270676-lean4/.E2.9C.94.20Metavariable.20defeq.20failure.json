[
    {
        "content": "<p><code>isDefEq</code> fails for unassignable metavariables, even in situations where it should succeed. For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Even though <code>(fun _ =&gt; ?x) ()</code> beta reduces to <code>?x</code>, <code>rfl</code> fails with:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>The error similarly occurs for <code>(?x, ()).fst</code>. Is this behavior intentional?</p>\n<hr>\n<p>The cause seems to be these lines in <code>isDefEqQuickOther</code>: <a href=\"https://github.com/leanprover/lean4/blob/708c5f1d9a92d6b21d0f581bb45b8d486c66160b/src/Lean/Meta/ExprDefEq.lean#L1751-L1800\">https://github.com/leanprover/lean4/blob/708c5f1d9a92d6b21d0f581bb45b8d486c66160b/src/Lean/Meta/ExprDefEq.lean#L1751-L1800</a>. The comment <code>Trying to unify `?m ... =?= ?n ...` where both `?m` and `?n` cannot be assigned.</code> suggests that this code path is intended to be reached when both sides are applications of metavariables, but the code is also reached when only one side is an unassignable metavariable and the other side is not an application metavariable. This makes me think the behavior is unintentional.</p>\n<hr>\n<p>I encountered this issue when trying to fix a bug where unsound unification hints are accepted (<a href=\"https://github.com/leanprover/lean4/issues/8982\">#8982</a>). My attempt to fix the bug in <a href=\"https://github.com/leanprover/lean4/pull/8988\">#8988</a> was to increase the depth when checking the conclusion to ensure that the conclusion is implied by the constraints, but tests are failing due to this issue. For example <a href=\"https://github.com/leanprover/lean4/blob/708c5f1d9a92d6b21d0f581bb45b8d486c66160b/tests/lean/unifHintAndTC.lean#L51-L54\">https://github.com/leanprover/lean4/blob/708c5f1d9a92d6b21d0f581bb45b8d486c66160b/tests/lean/unifHintAndTC.lean#L51-L54</a> fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">❌️</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">magmaOfMul</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3131</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3131</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">magmaOfMul</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3131</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonassignable</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3131</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonassignable</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 525630544,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1750823517
    },
    {
        "content": "<p>I reported this issue one year ago in <a href=\"#narrow/channel/270676-lean4/topic/.60isDefEq.60.20and.20non-assigneble.20metavariables\">#lean4 &gt; &#96;isDefEq&#96; and non-assigneble metavariables</a>, and <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> made an issue about it at <a href=\"https://github.com/leanprover/lean4/pull/3293\">lean#3293</a>, but so far nothing has been done about it.</p>",
        "id": 525857579,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750928816
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"497571\">Parth Shastri</span> has marked this topic as resolved.</p>",
        "id": 525900554,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750943215
    }
]