[
    {
        "content": "<p>abbrev size_of_deriv (derivation : BlendedDerivation g r s) :=<br>\n  match derivation with<br>\n  | .Terminal =&gt; 0<br>\n  | .Rule _ _ xs =&gt; 1 + size_of_deriv xs<br>\n  | .Concat a b =&gt; 1 + size_of_deriv a + size_of_deriv b</p>\n<p>Is there a way to write a function that I can use with <code>termination_by</code> like this, where <code>BlendedDerivation</code> is in Prop</p>",
        "id": 567939892,
        "sender_full_name": "Plecra",
        "timestamp": 1768384098
    },
    {
        "content": "<p>Propositions cannot eliminate into non-propositional things so no.</p>",
        "id": 567942150,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768384785
    },
    {
        "content": "<p>sure, but presumably termination_by could be fine with a well-founded measure in Prop?</p>",
        "id": 567942493,
        "sender_full_name": "Plecra",
        "timestamp": 1768384880
    },
    {
        "content": "<p>Of course, you can for example use <code>fun _ =&gt; 0</code> or something like that. But you cannot perform pattern matching on your <code>Prop</code> when you want to produce non-<code>Prop</code> data.</p>",
        "id": 567942907,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768384997
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 567943661,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768385204
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 567944297,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768385377
    },
    {
        "content": "<p>(Forget what I said that just looks like it achieves what you want)</p>",
        "id": 567944643,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768385472
    },
    {
        "content": "<p>I cant quite tell what you mean with fun _ =&gt; 0 there :) What can I use it for?</p>",
        "id": 567944675,
        "sender_full_name": "Plecra",
        "timestamp": 1768385479
    },
    {
        "content": "<p>The couple ways I tried to write it, it still belongs in Type</p>",
        "id": 567944728,
        "sender_full_name": "Plecra",
        "timestamp": 1768385495
    },
    {
        "content": "<p>You can in principle use that as a measure for a <code>Prop</code> thing but that's of course a very boring measure.</p>",
        "id": 567945133,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768385597
    },
    {
        "content": "<p>Then I guess I'm just asking my original question ^^ I have an inductive type:</p>\n<p>inductive BlendedDerivation : Grammar -&gt; Rule -&gt; Text -&gt; Prop where<br>\n| Terminal : BlendedDerivation g [(.Terminal s)] s<br>\n| Rule : MemberAt g rules n<br>\n  -&gt; rule ∈ rules<br>\n  -&gt; BlendedDerivation g rule s<br>\n  -&gt; BlendedDerivation g [(.NonTerminal n)] s<br>\n| Concat : BlendedDerivation g a s1 -&gt; BlendedDerivation g b s2 -&gt; BlendedDerivation g (a ++ b) (s1 ++ s2)</p>\n<p>and I want to use the wf relation between the constructors that I wrote above, but I want to do it without putting <code>BlendedDerivation</code> into Type. This seems pretty sensible in the abstract, in that we never actually need to eliminate out of the termination measure</p>",
        "id": 567945603,
        "sender_full_name": "Plecra",
        "timestamp": 1768385726
    },
    {
        "content": "<p>alternatively, how can I prove <code>extension_preserves_deriv_</code> when <code>BlendedDerivation g r t</code> is in Prop <a href=\"https://pastebin.com/raw/sP4gdzw0\">https://pastebin.com/raw/sP4gdzw0</a></p>",
        "id": 567946060,
        "sender_full_name": "Plecra",
        "timestamp": 1768385839
    },
    {
        "content": "<p>Style comment: please put your Lean code in <a href=\"https://github.com/leanprover-community/mathlib/wiki/Code-in-backticks\">#backticks</a> (and if you want us to be able to run the code, write a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>)</p>",
        "id": 567950164,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768386909
    },
    {
        "content": "<p>Doing so makes it much easier to help you - i.e. is nicer for everybody :-)</p>",
        "id": 567953721,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1768387852
    },
    {
        "content": "<p>While one would typically proceed by induction on <code>deriv : BlendedDerivation g r s</code>, here the elaborator proves termination automatically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">UInt8</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Pattern</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Terminal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Text</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Pattern</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">NonTerminal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Pattern</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Pattern</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Grammar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Rule</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Here</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">::</span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">There</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">::</span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Grammar</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Text</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Terminal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">.</span><span class=\"n\">Terminal</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">rules</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">rules</span>\n<span class=\"w\">  </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">.</span><span class=\"n\">NonTerminal</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Cons</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">::</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_member_loc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">generalizing</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">  </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"bp\">.</span><span class=\"n\">Here</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">MemberAt</span><span class=\"bp\">.</span><span class=\"n\">There</span>\n<span class=\"w\">  </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">childh</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">specialize</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"n\">childh</span>\n<span class=\"w\">  </span><span class=\"n\">assumption</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">InGrammar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Grammar</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Text</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Via</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">InGrammar</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_deriv_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">deriv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">g2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">deriv</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Terminal</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">BlendedDerivation</span><span class=\"bp\">.</span><span class=\"n\">Terminal</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"n\">rules_mem</span><span class=\"w\"> </span><span class=\"n\">rule_mem</span><span class=\"w\"> </span><span class=\"n\">rule_has_s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">BlendedDerivation</span><span class=\"bp\">.</span><span class=\"n\">Rule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">extension_preserves_member_loc</span><span class=\"w\"> </span><span class=\"n\">rules_mem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">rule_mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">extension_preserves_deriv_</span><span class=\"w\"> </span><span class=\"n\">rule_has_s</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Cons</span><span class=\"w\"> </span><span class=\"n\">hleft</span><span class=\"w\"> </span><span class=\"n\">hright</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">BlendedDerivation</span><span class=\"bp\">.</span><span class=\"n\">Cons</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_deriv_</span><span class=\"w\"> </span><span class=\"n\">hleft</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_deriv_</span><span class=\"w\"> </span><span class=\"n\">hright</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_deriv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InGrammar</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InGrammar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">g2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">InGrammar</span><span class=\"bp\">.</span><span class=\"n\">Via</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">extension_preserves_deriv_</span>\n<span class=\"w\">    </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 567954147,
        "sender_full_name": "Vlad",
        "timestamp": 1768387950
    },
    {
        "content": "<p>For terms in <code>Prop</code>, <code>theorem</code> is preferred over <code>def</code>.</p>",
        "id": 567955333,
        "sender_full_name": "Vlad",
        "timestamp": 1768388251
    }
]