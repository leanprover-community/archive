[
    {
        "content": "<p>I've isolated some weird/inconsistent behaviour. Is this a known bug? What is going on?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">R_copy_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoid</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> compiles -/</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">zero_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">add_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqz</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop?</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">R_copy_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submonoid</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> compiles -/</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqz</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">R_copy_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> unknown free variable '_fvar.5727' -/</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">zero_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">add_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqz</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqz</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">R_copy_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> compiles -/</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">zero_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">add_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqz</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n</code></pre></div>",
        "id": 489829029,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734550729
    },
    {
        "content": "<p>The <code>aesop</code>s can all be replaced with <code>sorry</code> and the bug remains, which is good new for <span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> :)</p>",
        "id": 489830606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734551445
    },
    {
        "content": "<p>A slight minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NonAssocSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">R_copy_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> (kernel) declaration has metavariables 'R_copy_3' -/</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">zero_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- remove the `by` and this works</span>\n<span class=\"w\">  </span><span class=\"n\">add_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eqw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 489831202,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734551666
    },
    {
        "content": "<p>(I guess strictly this is a different error)</p>",
        "id": 489831231,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734551694
    },
    {
        "content": "<p>Oh that's so weird I didn't even think to do that<br>\nYeah to be clear the error is due to the pattern match in <code>fun</code><br>\nif you remove that it all works<br>\nlike <code>fun x =&gt; by obtain ...</code></p>",
        "id": 489831416,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734551769
    },
    {
        "content": "<p>Looks like <a href=\"https://github.com/leanprover/lean4/pull/6354\">lean4#6354</a></p>",
        "id": 489833303,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734552531
    },
    {
        "content": "<p>Looks like we now have 5 independent people getting this bug!</p>",
        "id": 489833806,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1734552727
    },
    {
        "content": "<p>and how many dependent people?</p>",
        "id": 489841187,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734555923
    },
    {
        "content": "<p>I guess I cut and pasted the code and observed the error too, so at least one...</p>",
        "id": 489843167,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734556909
    },
    {
        "content": "<p>Now at least 5 independent and 2 dependent people have come across this bug now :-)</p>\n<p>I <em>think</em> <a href=\"https://github.com/leanprover/lean4/pull/6414\">lean4#6414</a> fixes it. The issue was triggered by having a synthetic metavariable (like a not-yet-evaluated tactic block) in the expected type of a <code>match</code> expression, which caused some meta code to create an invalid expression. Fixing that fixes the issues in <a href=\"https://github.com/leanprover/lean4/pull/6354\">lean4#6354</a>, but I haven't tested it on the examples from this thread — waiting on it and mathlib to build first.</p>",
        "id": 489867323,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734569344
    },
    {
        "content": "<p>Why did so many people hit this bug now, when the minimized example fails even in v4.0.0?</p>",
        "id": 489998848,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1734625359
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span> <a href=\"#narrow/channel/270676-lean4/topic/Possible.20bug.3A.20.22unknown.20free.20variable.22/near/489998848\">said</a>:</p>\n<blockquote>\n<p>Why did so many people hit this bug now, when the minimized example fails even in v4.0.0?</p>\n</blockquote>\n<p>I hit the bug while trying to pattern match within a lambda. Maybe this feature is more well known now?</p>",
        "id": 490012541,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734628062
    },
    {
        "content": "<p>Yeah, it's curious — I'm wondering if people have run into this frequently but either blamed themselves or figured this part of Lean isn't particularly stable so just worked around it. Maybe it's a combination of people being more confident that this should work and this part of Lean becoming more stable, so the bug stuck out more?</p>",
        "id": 490030505,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734634952
    },
    {
        "content": "<p>Yeah I mean I run into janky stuff all the time, and it's hard to tell if the reason is deep or not, so I generally just rejig the proof so it works. Not sure if that's the \"right\" approach but...</p>",
        "id": 490030621,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734635006
    }
]