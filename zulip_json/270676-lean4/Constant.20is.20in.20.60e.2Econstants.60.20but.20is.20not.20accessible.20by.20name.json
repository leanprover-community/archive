[
    {
        "content": "<p>This seems to be a behavior change in 4.19.0:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">map₂</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{n} : {c.type}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">._</span><span class=\"n\">cstage2</span>\n</code></pre></div>\n<p>Previously in v4.18.0, the <code>#print</code> would succeed, but in the latest rc it fails</p>",
        "id": 511008347,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744139586
    },
    {
        "content": "<p>Relatedly, the <code>logInfo</code> above results in an <code>_obj</code> in the infoview which produces <code>Error: Rpc error: InternalError: unknown constant '_obj'</code> when hovered over.</p>",
        "id": 511008428,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744139618
    },
    {
        "content": "<p>You can even redeclare it</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">map₂</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{n} : {c.type}\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">._</span><span class=\"n\">cstage2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">._</span><span class=\"n\">cstage2</span>\n</code></pre></div>",
        "id": 511009858,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744140183
    },
    {
        "content": "<p>You get a kernel error but the <code>#print</code> succeeds with the new definition</p>",
        "id": 511009903,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744140203
    },
    {
        "content": "<p>This is in contrast to what happens if you try to redeclare a regular definition, in that case the <code>#print</code> will print the original definition, but here it prints the new one.</p>",
        "id": 511010259,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744140357
    },
    {
        "content": "<p>Yes, this is a temporary regression until the old code generator is removed. If any metaprograms are broken by this, I would suggest ignoring constants from <code>map_2</code> that are not in <code>Environment.find?</code></p>",
        "id": 511105340,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744186359
    },
    {
        "content": "<p>Is the nonexistent <code>_obj</code> also going away?</p>",
        "id": 511115895,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744189111
    },
    {
        "content": "<p>I don't know but that has always been the case when pretty-printing IR</p>",
        "id": 511125329,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744191675
    }
]