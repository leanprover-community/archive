[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>  I've encountered an issue with doc-gen4 and filed it at <a href=\"https://github.com/leanprover/doc-gen4/issues/348\">https://github.com/leanprover/doc-gen4/issues/348</a></p>\n<p><strong>The problem:</strong> doc-gen4 panics when processing instances that prove structure predicates (like <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/Defs/Basic.html#Continuous\"><code>Continuous</code></a>) rather than class instances. The panic occurs because <code>Meta.isClass?</code> returns <code>none</code> for these declarations, and doc-gen4 currently expects it to always return <code>some</code>.</p>\n<p><strong>Example:</strong> In <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>'s <a href=\"https://github.com/kbuzzard/ClassFieldTheory\">ClassFieldTheory</a>, there's an instance <a href=\"https://github.com/kbuzzard/ClassFieldTheory/blob/main/ClassFieldTheory/LocalCFT/Continuity.lean#L90-L92\"><code>continuous_algebraMap_of_density : Continuous (algebraMap K L)</code></a>. Since <code>Continuous</code> is a <code>structure</code> (not a <code>class</code>), <code>isClass?</code> correctly returns <code>none</code>, triggering the panic.</p>\n<p>I've created an MWE here: <a href=\"https://github.com/NicolasRouquette/ClassFieldTheory/blob/bug/doc-gen4/isClass/MWE_isClass.lean\">https://github.com/NicolasRouquette/ClassFieldTheory/blob/bug/doc-gen4/isClass/MWE_isClass.lean</a></p>\n<p><strong>Questions:</strong></p>\n<ol>\n<li>\n<p>Is it expected that <code>instance</code> declarations can provide structure predicates (not just classes)? It seems valid in Lean but doc-gen4 didn't anticipate this case.</p>\n</li>\n<li>\n<p>What would be the preferred fix? Some options:</p>\n<ul>\n<li>Have <code>ofDefinitionInfo</code> return <code>Option InstanceInfo</code> and skip these cases</li>\n<li>Generalize the instance handling to support both classes and structures</li>\n<li>Log a warning instead of panicking</li>\n</ul>\n</li>\n</ol>\n<p>I'm happy to contribute a PR if there's guidance on the preferred approach. For now, this doesn't break my doc-verification-bridge pipeline since I catch the panic and continue, but it would be nice to handle it more gracefully.</p>\n<p>Thanks!</p>",
        "id": 568927403,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768872520
    },
    {
        "content": "<p>To the best of my understanding it is illegal to have instances for non-class types. So this might be worth an issue in core instead?</p>",
        "id": 568961569,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1768896412
    },
    {
        "content": "<p>Yeah that should definitely not be an instance! Maybe some linter should have caught this?</p>",
        "id": 568963342,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768897108
    },
    {
        "content": "<p>There's literally no error what</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>Is there any reason why you'd ever want to allow non-class instance declarations?<br>\nAlso, <em>huh</em>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">class</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choice</span>\n</code></pre></div>",
        "id": 569014067,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1768912882
    },
    {
        "content": "<p>Thanks everyone for the helpful discussion!</p>\n<p>Based on the insights shared here — particularly <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>'s observation that instances for non-class types should be illegal, <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> 's confirmation that the <code>Continuous</code> instance shouldn't have been an instance in the first place, and <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>'s surprising discovery that even <code>instance : Nat := 0</code> compiles — I've filed a GitHub issue: <a href=\"https://github.com/leanprover/lean4/issues/12075\">https://github.com/leanprover/lean4/issues/12075</a></p>\n<p>The root cause is that <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Instances.lean#L230\"><code>addInstance</code></a> doesn't check whether the target type is a class before registering the instance. Interestingly, <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/Instances.lean#L308\"><code>addDefaultInstance</code></a> in the same file <em>does</em> have this check.</p>\n<p>For now, the doc-gen4 workaround I'm using is to catch the panic and continue, but having Lean reject these instances at definition time would be the proper fix.</p>",
        "id": 569082126,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768928473
    }
]