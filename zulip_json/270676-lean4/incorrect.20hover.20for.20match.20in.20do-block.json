[
    {
        "content": "<p>In this code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"w\"> </span><span class=\"s2\">\"oops\"</span>\n</code></pre></div>\n<p>If I hover over <code>match</code>, <code>with</code> or either of the <code>|</code>, there is a subtle highlight on the match block (which has type Option Nat), but the hover information tells me that the type is <code>Option String</code> (which is the type of the whole do-block). So there is a mismatch between what expression it seems like I'm hovering over, and what expression I'm getting the type of.</p>\n<p>Replacing the <code>match</code>with an <code>if</code>-<code>let</code> fixes the problem (in the less preferred way), because there the hover highlight encompasses the whole do-block.</p>",
        "id": 496390228,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738086114
    },
    {
        "content": "<p>If you <code>#print foo</code>, you'll see that the <code>match</code> block got <a href=\"https://en.wikipedia.org/wiki/Continuation-passing_style\">cps</a>'d, and the corresponding match in the definition does have type <code>Option String</code>. This is probably why the hover also thinks the <code>match</code> block has type <code>Option String</code>. If you hover over the identifier being bound, the hover correctly displays <code>Nat</code> as the type.</p>\n<p>I don't know how to fix this.</p>",
        "id": 496396130,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738087867
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Hovers are generated during the elaboration process (surface syntax is associated to TermInfo data). The hover for <code>match</code> should be generated before any of the further transforms before the <code>do</code> notation.</p>",
        "id": 496397093,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738088184
    },
    {
        "content": "<p>There's <em>some</em> conceptual connection between them, but there does not have to be a direct correspondence between expressions you see in hovers and what appears in <code>#print</code>.</p>",
        "id": 496397235,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738088234
    },
    {
        "content": "<p>Reading <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.Do.ToCodeBlock.doLetArrowToCode#doc\">docs#Lean.Elab.Term.Do.ToCodeBlock.doLetArrowToCode</a>, it looks like the return type of the <code>match</code> really is <code>Option String</code> because <code>match</code> is a valid do element, and the code is transformed (I think) to something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"w\"> </span><span class=\"s2\">\"oops\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"w\"> </span><span class=\"s2\">\"oops\"</span>\n</code></pre></div>\n<p>So the cps-like transformation happens sort of at macro expansion time for <code>do</code> notation.</p>\n<p>If you wrap the <code>match</code> in parentheses, like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"w\"> </span><span class=\"s2\">\"oops\"</span>\n</code></pre></div>\n<p>that prevents the <code>match</code> from being recognized as a do element, and so it elaborates as a plain term. That causes it to have an <code>Option Nat</code> hover.</p>",
        "id": 496400266,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738089267
    },
    {
        "content": "<p>One fix could be to have doLetArowToCode mark the <code>match</code> as being synthetic syntax, which would prevent incorrect hover.</p>",
        "id": 496403350,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738090291
    }
]