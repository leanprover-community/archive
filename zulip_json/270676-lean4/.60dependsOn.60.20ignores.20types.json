[
    {
        "content": "<p>It seems that <code>dependsOn</code> does not insist on checking the types of fvars and mvars for dependence. (Nor does it chase down delayed assignments.)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"k\">from</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">lambdaBoundedTelescope</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Does the body `a` depend on `t`?</span>\n<span class=\"w\">    </span><span class=\"n\">dependsOn</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">fvarId!</span><span class=\"w\"> </span><span class=\"c1\">--`false`</span>\n</code></pre></div>\n<p>The workaround (if you want to see whether an expression \"really\" depends on a meta- or free variable) seems to be to either</p>\n<ol>\n<li>write a custom <code>dependsOn</code> to look up types of fvars and mvars</li>\n<li>(if dealing with an fvarId) <code>collectForwardDeps</code> of the <code>fvarId</code> in question, then see if the expression <code>dependsOn</code> any of them. (<code>collectForwardDeps</code> uses <code>dependsOn</code>, but manually insists on checking each fvarId's type.)</li>\n<li><del>use <code>mkLambdaFVars</code> with <code>(usedOnly := true)</code>, and test if the result is equal to the original expression</del> (EDIT: this doesn't seem to work, unexpectedly; I haven't checked if it's because <code>mkLambdaFVars</code> depends on <code>dependsOn</code>.)</li>\n</ol>\n<p>My concerns are (A.) that this is a footgun in the metaprogramming API, by naming it \"<code>dependsOn</code>\" (B.) that the correct workaround is more costly than it has to be, either in terms of requiring new code or in terms of performance (I'm doing extra work by collecting <em>all</em> forward dependencies).</p>\n<p><code>dependsOn</code> is used pretty deeply in Lean, so I imagine that it's intended to be this way! Is it? And if so, why?</p>",
        "id": 501193533,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1740175043
    },
    {
        "content": "<p>Tangent: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.dependsOn#doc\">docs#Lean.dependsOn</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.exprDependsOn#doc\">docs#Lean.exprDependsOn</a> are duplicates, are they not?</p>",
        "id": 501346892,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1740294971
    }
]