[
    {
        "content": "<p>The error message is unhelpful. The fix is to explicitly provide universe variable for Ordinal. Either by using <code>Ordinal.{0}</code> in definition of <code>Foo.ordinalLevel</code>, or <code>Foo.ordinalLevel.{0}</code> at call site. Is it possible to have a better error message in this case?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">Family</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Ordinal</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⨆</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: (kernel) declaration has metavariables 'Foo.sum'</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">error: (kernel) application type mismatch</span>\n<span class=\"sd\">  failed to pretty print expression (use 'set_option pp.rawOnError true' for raw representation)</span>\n<span class=\"sd\">argument has type</span>\n<span class=\"sd\">  failed to pretty print expression (use 'set_option pp.rawOnError true' for raw representation)</span>\n<span class=\"sd\">but function has type</span>\n<span class=\"sd\">  failed to pretty print expression (use 'set_option pp.rawOnError true' for raw representation)</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_wf</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">lt_succ</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⨆</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ordinalLevel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">le_iSup</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n</code></pre></div>",
        "id": 563984513,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765873053
    },
    {
        "content": "<p>does the termination checker not also check for universe mvars</p>",
        "id": 564015860,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765883371
    },
    {
        "content": "<p>Was that a question? I don't know the answer, because I didn't understood the question. In what way universe mvars have to be checked?</p>",
        "id": 564148108,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765926796
    },
    {
        "content": "<p>I think this is probably the reason for why you get such an error, is that the termination checker does not process unassigned universe metavariables</p>",
        "id": 564148481,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765927065
    },
    {
        "content": "<p>You think it should automatically default universe mvars that were left unsolved, to lowest possible?</p>",
        "id": 564149124,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765927478
    },
    {
        "content": "<p>Is there an example of Lean doing this in some other context?</p>",
        "id": 564149436,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765927681
    },
    {
        "content": "<p>I think it should throw an error actually</p>",
        "id": 564150675,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765928449
    },
    {
        "content": "<p>but with a better error message of course</p>",
        "id": 564150699,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765928461
    },
    {
        "content": "<p>Defaulting universe variables to lowest possible makes sense I think? I don't think setting universe variables lower can change solvable goal to unsolvable one? In worst case proof might require some ULift's.</p>",
        "id": 564156423,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765932760
    },
    {
        "content": "<p>it's done for definitions, for obvious reasons</p>",
        "id": 564156570,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932871
    },
    {
        "content": "<p>and it's done for proofs because proofs are handled the same as definitions</p>",
        "id": 564156589,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932890
    },
    {
        "content": "<p>I think for definitions the unsolved universe variables are put as universe variables of the definition?</p>",
        "id": 564156612,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765932910
    },
    {
        "content": "<p>...right</p>",
        "id": 564156626,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932923
    },
    {
        "content": "<p>yeah</p>",
        "id": 564156630,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932924
    },
    {
        "content": "<p>But I don't think it would make sense to put universe variables there are only used in the termination proof as part of the definition.</p>",
        "id": 564156691,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765932969
    },
    {
        "content": "<p>how does this work again?</p>",
        "id": 564156692,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932972
    },
    {
        "content": "<p>no wait that's not right</p>",
        "id": 564156712,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765932993
    },
    {
        "content": "<p>wait no</p>",
        "id": 564156727,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933006
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/Better.20error.20about.20uninstantiated.20universe.20variables/near/564156423\">said</a>:</p>\n<blockquote>\n<p>I don't think setting universe variables lower can change solvable goal to unsolvable one?</p>\n</blockquote>\n<p>Hmm, or maybe it actually could make a goal unsolvable? Because there's a significant difference between <code>Sort 0</code> and <code>Sort 1</code>.</p>",
        "id": 564156734,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765933010
    },
    {
        "content": "<p>I remember there was a behavior where if the universe is mentioned but it isn't used anywhere then it throws an error</p>",
        "id": 564156785,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933037
    },
    {
        "content": "<p>but that's not about metavariables</p>",
        "id": 564156800,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933050
    },
    {
        "content": "<p>and there is also the behavior that if in a theorem you leave a universe metavariable then it throws an error</p>",
        "id": 564156848,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933079
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/Better.20error.20about.20uninstantiated.20universe.20variables/near/564156423\">said</a>:</p>\n<blockquote>\n<p>Defaulting universe variables to lowest possible makes sense I think? I don't think setting universe variables lower can change solvable goal to unsolvable one? In worst case proof might require some ULift's.</p>\n</blockquote>\n<p>as an example take <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=UCompactlyGeneratedSpace#doc\">docs#UCompactlyGeneratedSpace</a></p>",
        "id": 564156909,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933124
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/Better.20error.20about.20uninstantiated.20universe.20variables/near/564156612\">said</a>:</p>\n<blockquote>\n<p>I think for definitions the unsolved universe variables are put as universe variables of the definition?</p>\n</blockquote>\n<p>Like, in the case of <code>Foo.universeLevel</code> Lean made this signature: <code>def Foo.ordinalLevel.{u_1} : {α : Type} → Foo α → Ordinal.{u_1}</code>. So it took the universe mvar that came from <code>Ordinal</code> and put it as a universe variable of the <code>Foo.ordinalLevel</code>.</p>",
        "id": 564156916,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765933132
    },
    {
        "content": "<p>but you mentioned it in the statement so that's a bit different</p>",
        "id": 564156941,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933155
    },
    {
        "content": "<p>I think it also lifts it out if you mention it in the body of a definition?</p>",
        "id": 564156977,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933187
    },
    {
        "content": "<p>but not the body of a proof...</p>",
        "id": 564156987,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933194
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/Better.20error.20about.20uninstantiated.20universe.20variables/near/564149436\">said</a>:</p>\n<blockquote>\n<p>Is there an example of Lean doing this in some other context?</p>\n</blockquote>\n<p>Not exactly the same, but I can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">3</span><span class=\"o\">})</span>\n</code></pre></div>\n<p>and Lean will pick <code>Foo : Type 4</code>, even though it could do <code>Foo : Type (max u 4)</code>.<br>\nSo in this case Lean automatically picks the lowest.<br>\nAnd, if I write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span>\n</code></pre></div>\n<p>then it will pick <code>Foo : Sort 1</code>, not <code>Foo : Sort 0</code>. So, in this case it doesn't pick lowest possible, but it picks lowest possible that doesn't introduce <code>Prop</code>.<br>\nMaybe similar behaviour would make sense for automatically instantiating universe variables in proofs?</p>",
        "id": 564157717,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765933730
    },
    {
        "content": "<p>that's inductive types</p>",
        "id": 564158006,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933935
    },
    {
        "content": "<p>I feel like that's different</p>",
        "id": 564158023,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765933945
    },
    {
        "content": "<p>That is different.</p>",
        "id": 564158055,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765933970
    },
    {
        "content": "<p><code>inductive</code> has a heuristic that if it's got only one-constructor, and that constructor has at least one field, and all fields are propositions, then it will chose <code>Prop</code>. That's because in this case it's a syntactic subsingleton and the kernel will generate a recursor that can eliminate into any universe. Plus, empirically people want an inductive predicate in this case (at least for <code>structure</code>).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"c1\">-- Foo (a : Nat) : Prop</span>\n</code></pre></div>\n<p>Otherwise it goes for <code>Type _</code>.</p>\n<p>The <code>inductive</code> command doesn't have (good) heuristics for universe level metavariables inside constructors. Currently it does different things depending on whether or not the universe for the inductive was provided. It can also do some crazy things like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"c1\">-- Foo.nil {α : Prop} (x : α) : Foo</span>\n</code></pre></div>\n<p>(It reasons \"well, the only level that works here is 0, so go with that\". I think this feature is my fault, probably from <a href=\"https://github.com/leanprover/lean4/pull/6125\">lean4#6125</a>.)</p>",
        "id": 564289483,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765987895
    },
    {
        "content": "<p>I've got your first message starred by the way, since it's a bug if the error is being reported from the kernel. The elaborator is responsible for reporting metavariable errors and localizing them in the source code.</p>",
        "id": 564290007,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765988016
    },
    {
        "content": "<p>By the way, the elaborator does assign level metavariables to 0 when it reports errors, as an error-recovery mechanism.</p>\n<p>It seems plausible that inside theorems, the elaborator could simply set them to 0 and not report anything — there shouldn't be any <code>Prop</code>/<code>Type _</code> issues, since the elaborator checks whether levels can/can't be zero as it elaborates. My primary concern is that if a proof has metavariables then it might be brittle.</p>",
        "id": 564291669,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765988417
    }
]