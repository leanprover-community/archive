[
    {
        "content": "<p>Hi! I'm currently attempting to update the <code>combinatorial-games</code> repository to the latest Mathlib. We had our own custom implementation of Dyadic rationals (directly as just a subtype of <code>ℚ</code>), so I'm currently trying to merge our implementations together.</p>\n<p>Here's a few questions that I have:</p>\n<ul>\n<li>What's the preferred way to write <code>1/2 : Dyadic</code>? There's a few candidates, like <code>Dyadic.ofOdd 1 2 sorry</code> or <code>1 &gt;&gt; 1</code>. Is there a reason for this to not just be a constant <code>Dyadic.half</code>?</li>\n<li>Where should all the Mathlib instances for this type go? I particularly want four of them: <code>CommRing</code>, <code>IsStrictOrderedRing</code>, <code>DenselyOrdered</code>, and <code>Archimedean</code>. <code>IsLocalization</code> would also be nice. (Maybe this question is off-topic, in which case I ask a different one: is anyone already working on this?)</li>\n<li>Would definitions <code>Dyadic.num</code> and <code>Dyadic.den</code> make sense? I make pretty heavy use of them in my own implementation. Or would it be preferred to just pass through <code>ℚ</code> for this?</li>\n</ul>",
        "id": 541162705,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758699854
    },
    {
        "content": "<ol>\n<li>I'd suggest <code>1 &gt;&gt; 1</code> to avoid needing extra API relating <code>half</code> back to everything else. But it wouldn't be terrible.</li>\n<li>Can the instances just go in <code>combinatorial-games</code> for now? If we identify another situation where people want these instances, we can move them to Mathlib then.</li>\n<li><code>num</code> and <code>den</code> sound good.</li>\n</ol>",
        "id": 541170161,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758702350
    },
    {
        "content": "<p>Alright then. I'll do the necessary adaptations over there. I'll link to the file here once I'm done in case you want to borrow anything <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 541171148,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758702628
    },
    {
        "content": "<p>Oh I just realized, we're missing these lemmas:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">toRat_shiftRight_int</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">shiftRight</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">div_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">shiftRight</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">div_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">shiftRight</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">toRat_ofOdd_eq_mul_two_pow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">neg_add</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">zpow_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">zpow_neg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">mul_assoc</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">toRat_shiftRight_nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">toRat_shiftRight_int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">toRat_shiftLeft_int</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toRat_shiftRight_int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">div_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">zpow_neg</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"bp\">.</span><span class=\"n\">toRat_shiftLeft_nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Dyadic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">toRat_shiftLeft_int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 541172205,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758702888
    },
    {
        "content": "<p>Another implementation question: is there a reason why <code>Dyadic.toRat</code> isn't a coercion?</p>",
        "id": 541172850,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758703076
    },
    {
        "content": "<p>You're right, I thought about that too; that would probably be best for the benefit of enabling <code>norm_cast</code></p>",
        "id": 541173378,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758703250
    },
    {
        "content": "<p>The CGT repo makes very heavy use of <code>norm_cast</code> (we have no less than five numeric types casting into games), so this would be very appreciated!</p>",
        "id": 541173633,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758703317
    },
    {
        "content": "<p>Another question. Shouldn't <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.lt_iff_toRat#doc\">docs#Dyadic.lt_iff_toRat</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.le_iff_toRat#doc\">docs#Dyadic.le_iff_toRat</a> be backwards? Then they could be made into simp lemmas.</p>",
        "id": 541174507,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758703570
    },
    {
        "content": "<p>Oh also, there should probably be an inhabited instance for <code>Dyadic</code></p>",
        "id": 541181953,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758705816
    },
    {
        "content": "<p><code>norm_cast</code> is great (none of these lemmas can be solved by <code>simp</code> alone)<br>\n<a href=\"/user_uploads/3121/rrbIZhqfV6kAIU3rdlGoFIWx/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/rrbIZhqfV6kAIU3rdlGoFIWx/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"615x220\" src=\"/user_uploads/thumbnail/3121/rrbIZhqfV6kAIU3rdlGoFIWx/image.png/840x560.webp\"></a></div>",
        "id": 541186390,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758707117
    },
    {
        "content": "<p>PRs very welcome (Robin's shift lemmas, making toRat a coercion, reversing lt_iff_toRat, and Inhabited)!</p>",
        "id": 541371597,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758777840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/270676-lean4/topic/Dyadic.20rationals/near/541174507\">schrieb</a>:</p>\n<blockquote>\n<p>Another question. Shouldn't <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.lt_iff_toRat#doc\">docs#Dyadic.lt_iff_toRat</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.le_iff_toRat#doc\">docs#Dyadic.le_iff_toRat</a> be backwards? Then they could be made into simp lemmas.</p>\n</blockquote>\n<p>I think on the side of core it makes more sense to use it in the other direction because we have more verification for <code>Rat</code> than for <code>Dyadic</code>. Anyways, you can still <code>attribute [simp ←] Dyadic.le_iff_toRat Dyadic.lt_iff_toRat</code> if it's useful to you</p>",
        "id": 541428019,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758797781
    },
    {
        "content": "<blockquote>\n<p>we have more verification for <code>Rat</code> than <code>Dyadic</code></p>\n</blockquote>\n<p>is this something that will remain true, or does it just reflect an unfinished API?</p>",
        "id": 541486300,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758813658
    },
    {
        "content": "<p>I would definitely say that <code>Dyadic</code> has unfinished API on core, at least in comparison to <code>Rat</code>. Most of that is made up through mathlib though so extending the API probably doesn't have too high priority right now</p>",
        "id": 541493846,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758815519
    },
    {
        "content": "<p>I guess of all of them, <code>&lt;&lt;&lt;</code> and <code>&gt;&gt;&gt;</code> probably need the most API extensions since we don't have type classes about them in mathlib</p>",
        "id": 541494340,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758815633
    },
    {
        "content": "<p>Maybe it'd be worth introducing <code>Dyadic.twoPow : Int -&gt; Dyadic</code> and then say <code>a &lt;&lt;&lt; b = a * twoPow b</code> and <code>a &gt;&gt;&gt; b = a * twoPow (-b)</code>?</p>",
        "id": 541495161,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758815862
    },
    {
        "content": "<p>That seems like a very reasonable idea, it'd give a more canonical way to write 1/2 as <code>twoPow (-1)</code></p>",
        "id": 541557907,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758842466
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/270676-lean4/topic/Dyadic.20rationals/near/541174507\">said</a>:</p>\n<blockquote>\n<p>Another question. Shouldn't <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.lt_iff_toRat#doc\">docs#Dyadic.lt_iff_toRat</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Dyadic.le_iff_toRat#doc\">docs#Dyadic.le_iff_toRat</a> be backwards? Then they could be made into simp lemmas.</p>\n</blockquote>\n<p>I agree that they're backwards, but you can add reverse direction <code>simp</code> lemmas with <code>@[simp ←]</code></p>",
        "id": 541753063,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758925098
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/10994\">lean#10994</a></p>",
        "id": 547419012,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761633350
    }
]