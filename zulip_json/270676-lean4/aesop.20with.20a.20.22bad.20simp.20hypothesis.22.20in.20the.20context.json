[
    {
        "content": "<p>It seems like aesop adds all the hypotheses in the current context to the simp-set it uses in the normalization phase. Is this correct? The issue with this is that it makes aesop unexpectedly fail when the user puts a hypothesis that would be a bad simp lemma in the context using <code>have</code> -- in fact I just got bitten by this. Here's a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Aesop</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>On this, I get the error <code>aesop: error in norm simp: tactic 'simp' failed, nested error: maximum recursion depth has been reached</code>, presumably because it keeps rewriting <code>1</code> into <code>1+1-1</code>.</p>\n<p>Is this a known issue? <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span></p>",
        "id": 493137167,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1736639367
    },
    {
        "content": "<p>There's</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">useSimpAll</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"o\">})</span>\n</code></pre></div>\n<p>The docs for this option say:<br>\nUse <code>simp_all</code>, rather than <code>simp at *</code>, for the builtin <code>simp</code> normalisation rule.</p>",
        "id": 493148029,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736650357
    },
    {
        "content": "<p>Yes, this is by design. Aesop's default <code>simp</code> is <code>simp_all</code>, which rewrites with equations in the context. This can lead to issues like this one, but they're surprisingly rare (from what I can tell, i.e. I rarely get complaints about this feature. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>)</p>\n<p>You can use the option mentioned by <span class=\"user-mention\" data-user-id=\"400289\">@Artie Khovanov</span> (thanks!) to switch to the less aggressive <code>simp at *</code>.</p>\n<p>The reason for this design choice is that <code>simp_all</code> is much more powerful than <code>simp at *</code> since it rewrites with propositions as well. E.g. <code>simp_all</code> closes the goal <code>h : A |- A \\/ B</code>.</p>\n<p>However, now that I think about this, it would be possible to use a hybrid between <code>simp_all</code> and <code>simp at *</code> that only does propositional rewriting but doesn't use equations. Maybe this would be the best default for Aesop.</p>",
        "id": 493579185,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736859215
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> I think you would need to compensate for that, for instance by having Aesop rewrite using hypotheses as an <code>unsafe 90%</code> rule application.</p>",
        "id": 493579624,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736859367
    },
    {
        "content": "<p>It would certainly weaken Aesop, but the more powerful behaviour would of course remain available. Unsafe rewriting is also an interesting idea.</p>",
        "id": 493580085,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736859520
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/aesop/pull/190\">aesop#190</a></p>",
        "id": 493580151,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736859542
    },
    {
        "content": "<p>I think this weaker variant could break a lot of common use cases, but I'm not 100% sure of that. It would certainly make using Aesop easier in some cases where I've had to eg remove hypotheses or avoid simp in Aesop altogether.</p>",
        "id": 493580488,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736859637
    },
    {
        "content": "<p>Yeah. I'll evaluate on Mathlib as usual before making any changes. (Would be nice if I could easily evaluate on non-Mathlib projects as well, but I don't know how many non-Mathlib code bases with substantial Aesop use are actually out there.)</p>",
        "id": 493581014,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736859774
    },
    {
        "content": "<p>I understand if not, but could you evaluate on <code>https://github.com/artie2000/real_closed_field</code>?</p>",
        "id": 493581275,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736859861
    },
    {
        "content": "<p>Sure, I've made a note in the issue.</p>",
        "id": 493581987,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736860095
    },
    {
        "content": "<p>thanks!</p>",
        "id": 493582051,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736860122
    },
    {
        "content": "<p>I see, thanks!</p>",
        "id": 493614505,
        "sender_full_name": "Frédéric Dupuis",
        "timestamp": 1736869660
    }
]