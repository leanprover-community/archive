[
    {
        "content": "<p>Hey all, I am an undergraduate learning Lean in a class this semester. I have been working on a course project, which I will soon be turning in. We discussed in class that since the behaviour of <code>simp</code> can change over updates, it is best practice to only have <code>simp only</code> in order to make code robust and maintainable. However, my code was riddled with 450+ unguarded <code>simp</code> statements, and converting them to <code>simp only</code> by first changing them to <code>simp?</code> and then clicking the suggestion in the infoview seemed to be very tedious. </p>\n<p>I therefore made a small tool which does this in quite a hacky way: <a href=\"https://github.com/mrigankpawagi/simpleafier\">https://github.com/mrigankpawagi/simpleafier</a>. I was able to transform all of my <code>simp</code>s in less than 30 seconds (with the \"fast\" mode) and had to spend only a minute or two more fixing 2 small errors that came up after the transformation.</p>\n<p>I would like to know if there's a cleaner way to do this that other people are aware of, for example, from inside Lean? I would also be happy to hear any feedback or suggestions. (PS my course project is <a href=\"https://github.com/mrigankpawagi/LeanearTemporalLogic\">here</a>).</p>",
        "id": 513155333,
        "sender_full_name": "Mrigank Pawagi",
        "timestamp": 1745056904
    },
    {
        "content": "<p>Thanks for asking, that's an interesting question! <br>\nLet me start with more of a side point: not <em>all</em> <code>simp</code>s are bad: if a simp closes a goal (it's a \"terminal simp\"), leaving it as simp is usually fine. (In fact, mathlib policy <em>asks</em> for such simps to be <code>simp</code> and not <code>simp only</code>s.)<br>\nThis leads me to a related tool: mathlib's <code>flexible</code> linter. You can activate it with <code>set_option linter.flexible true</code> in a file (or change your <code>lakefile</code>; if you don't know what this is, going file by file may be good enough). The linter will complain about every \"non-terminal simp\" (but will leave terminal simps alone) --- so you could use the linter as a means of checking \"which simps do I actually need to change\".</p>",
        "id": 513159297,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745060351
    },
    {
        "content": "<p>(If you're not on a very recent mathlib, you may need to <code>import Mathlib.Tactic.Linter.Flexible</code> to make the set_option work. On recent mathlib, that is never necessary any more.)</p>",
        "id": 513159319,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745060388
    },
    {
        "content": "<p>Thanks for your answer. You're right! My tool does, in fact, leave many <code>simp only</code>s at the end of proofs (it was a little tricky to manage them automatically). </p>\n<p>Good to know that there is a linter to help with this. It is generally better to take care of this while writing the proofs in the first place (before one ends up in a situation like mine with hundreds of bad <code>simp</code>s <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span>)!</p>",
        "id": 513159557,
        "sender_full_name": "Mrigank Pawagi",
        "timestamp": 1745060587
    },
    {
        "content": "<p>I have added <code>set_option linter.flexible true</code> to my file. It does not complain about terminal <code>simp only</code>s though <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>. For that I might just have to ctrl+F and check</p>",
        "id": 513169404,
        "sender_full_name": "Mrigank Pawagi",
        "timestamp": 1745068904
    },
    {
        "content": "<p>Indeed, the linter (currently) only checks one implication.</p>",
        "id": 513181204,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745077884
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> How difficult would it be to lint for terminal simps which are squeezed? (That should probably be covered by a new option, and cannot be enabled in mathlib yet either --- but it could help here or in downstream projects.)</p>",
        "id": 513181288,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745077940
    },
    {
        "content": "<p>Arriving late here.</p>\n<p>On the one hand, the <code>flexible</code> linter was written before the \"do not squeeze terminal <code>simp</code>s\" policy started, so it does not have any awareness of this.</p>\n<p>On the other hand, the linter already does so much with investigating the metavariable context that adding a check that terminal <code>simp</code>s are not squeezed should be really easy.</p>\n<p>Even more, if you make your code compliant with the <code>multiGoal</code> linter, then a regex check for terminal <code>simp</code>s may already take care of almost all of them and be even simpler to implement.</p>",
        "id": 516050723,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746380448
    },
    {
        "content": "<p>Interesting insights. Thanks!</p>",
        "id": 516255911,
        "sender_full_name": "Mrigank Pawagi",
        "timestamp": 1746464956
    },
    {
        "content": "<p>Sorry to bump an older thread, but it seems relevant. I would like to know what is the current style guideline about \"squeezing terminal simps\"? The public facing documentation <a href=\"https://leanprover-community.github.io/extras/simp.html#non-terminal-simps\">says</a> that calls to <code>simp</code> or <code>simp?</code> made during development should be replaced by <code>simp only [...]</code> tactics. Should that documentation be updated?</p>\n<p>This came recently in the discussion at <a href=\"https://github.com/leanprover-community/mathlib4/pull/25564\">#25564</a>.</p>",
        "id": 522999303,
        "sender_full_name": "Igor Khavkine",
        "timestamp": 1749415087
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"674314\">Igor Khavkine</span> <a href=\"#narrow/channel/270676-lean4/topic/Tool.20to.20convert.20.60simp.60.20to.20.60simp.20only.60/near/522999303\">said</a>:</p>\n<blockquote>\n<p>The public facing documentation <a href=\"https://leanprover-community.github.io/extras/simp.html#non-terminal-simps\">says</a> that calls to <code>simp</code> or <code>simp?</code> made during development should be replaced by <code>simp only [...]</code> tactics.</p>\n</blockquote>\n<p>The documentation says that about \"using <code>simp</code> in the middle of a proof\", i.e. non-terminal simps.</p>",
        "id": 522999416,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749415287
    },
    {
        "content": "<p>i believe the current consensus is that terminal simps <em>must not</em> be squeezed?</p>",
        "id": 522999469,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749415378
    },
    {
        "content": "<p>indeed, the <a href=\"https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls\">style guide</a> says not to (unless <em>really</em> necessary)</p>",
        "id": 522999528,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749415489
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/25564#discussion_r2134819670\">said</a> (at the github discussion):</p>\n<blockquote>\n<p>Ah! Can you raise on Zulip that <a href=\"https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls\">https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls</a> is misplaced?</p>\n</blockquote>\n<p>I don't think that this is misplaced? it's in style, as it is a style guideline... Where would you place it?</p>",
        "id": 522999633,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749415618
    },
    {
        "content": "<p>where we encourage the squeezing of simp calls</p>",
        "id": 522999691,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1749415723
    },
    {
        "content": "<p>maybe we should move the encouraging of squeezing simp calls, then</p>",
        "id": 522999727,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749415760
    },
    {
        "content": "<p>Sure, that is another option. It's just that right now they are in different places. No wonder so many newcomers squeeze their terminal simps :-)</p>",
        "id": 522999869,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1749415923
    },
    {
        "content": "<p>Add to this that mathlib also has many squeezed terminal simps, from before this policy was added.</p>",
        "id": 523001415,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1749417787
    },
    {
        "content": "<p>Re: where to place this? I would think it's good to</p>\n<ul>\n<li>augment the page about simp, with <em>at least</em> a note that <em>terminal</em> simps should not be squeezed (and a brief reference to the style guide)</li>\n<li>mention non-terminal simps in the style guide: currently, they are <em>only</em> mentioned on that page (which is definitely not ideal)</li>\n</ul>",
        "id": 523002003,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1749418660
    },
    {
        "content": "<p>Sounds good. And then similar changes could be made to #glossary</p>",
        "id": 523021070,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749441566
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/glossary.html\">https://leanprover-community.github.io/glossary.html</a></p>",
        "id": 523021089,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749441593
    }
]