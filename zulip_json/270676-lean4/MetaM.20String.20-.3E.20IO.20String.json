[
    {
        "content": "<p>hi! we're (<span class=\"user-mention\" data-user-id=\"337670\">@Alok Singh</span> ) having trouble transforming MetaM to IO</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">parseString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Parse the string into a `Syntax` object</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parserResult</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser.runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`module</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"c1\">-- only works on the happy path.</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">parserResult.toOption.get</span><span class=\"bp\">!</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">readFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">heading</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"-- {path}</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.FS.readFile</span><span class=\"w\"> </span><span class=\"n\">path</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{heading}{contents}\"</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">readFile</span><span class=\"w\"> </span><span class=\"s2\">\"Prooffusion/Fixture.lean\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let (stx, s, ms) ← parseString contents |&gt;.toIO</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">contents</span>\n</code></pre></div>\n<p>This is giving us</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ctxCore</span><span class=\"w\"> </span><span class=\"n\">sCore</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parseString</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"n\">ctxCore</span><span class=\"w\"> </span><span class=\"n\">sCore</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">495</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>What's a cheap way to construct Core.Context and Core.State elements correctly?</p>",
        "id": 462654120,
        "sender_full_name": "Quinn",
        "timestamp": 1723762103
    },
    {
        "content": "<p>What do you want <code>env</code> to contain? The environment in the loaded module?</p>",
        "id": 462654206,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723762172
    },
    {
        "content": "<p>I think it should contain that, yeah. right now the IO is just for sanity check printing</p>",
        "id": 462660784,
        "sender_full_name": "Quinn",
        "timestamp": 1723766143
    },
    {
        "content": "<p>so it doesn't even have to contain anything, really, at first</p>",
        "id": 462660794,
        "sender_full_name": "Quinn",
        "timestamp": 1723766155
    },
    {
        "content": "<p>There are various examples around that show how to do this</p>",
        "id": 462661569,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1723766535
    },
    {
        "content": "<p>One way is to first convert to CoreM then use one of the variants of <code>withImports</code></p>",
        "id": 462661630,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1723766570
    },
    {
        "content": "<p>Here's an example to illustrate:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CoreM.withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`Mathlib</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">m.run'</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">env.constants.toList.length</span>\n</code></pre></div>",
        "id": 462661946,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1723766771
    },
    {
        "content": "<p>cool! this works as written when mathlib is imported, still figuring out how to make it work in a mathlib-free project</p>",
        "id": 462850641,
        "sender_full_name": "Quinn",
        "timestamp": 1723839224
    },
    {
        "content": "<p><code>unknown constant 'Lean.Core.CoreM.withImportModules'</code></p>",
        "id": 462850720,
        "sender_full_name": "Quinn",
        "timestamp": 1723839260
    },
    {
        "content": "<p>oh dropping <code>CoreM</code> with <code>open Lean Meta</code> solved namespace issue</p>",
        "id": 462850982,
        "sender_full_name": "Quinn",
        "timestamp": 1723839439
    },
    {
        "content": "<p><code>CoreM.withImportModules</code> is a relatively thin wrapper around a function from core IIRC. You could therefore probably roll your own version by looking at the code</p>",
        "id": 462863065,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1723846177
    },
    {
        "content": "<p>For minimizing imports, try adding <code>set_option linter.minImports true</code> right after <code>import Mathlib</code> and see what it says.</p>\n<p>With meta-code it may not perform too well, but it may still be useful.</p>",
        "id": 462952400,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723882185
    }
]