[
    {
        "content": "<p>I found this definitions rather strange:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ForM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w₂</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Runs the monadic action `f` on each element of the collection `coll`.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">coll</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n</code></pre></div>\n<p>what is the <code>[Monad m]</code> argument doing there? Shouldn't it be up to individual instances to decide if they need <code>m</code> to be a <code>Monad</code>?</p>",
        "id": 537102158,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756730454
    },
    {
        "content": "<p><del>That not how it works</del> that's so weird</p>",
        "id": 537103390,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756730848
    },
    {
        "content": "<p>In particular, this means <code>instance : ForM Id _ _</code> requires you to implement <code>ForM</code> for any possible <code>Monad Id</code>, not just the canonical one.</p>",
        "id": 537103932,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756731024
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/10204\">lean4#10204</a> tries removing it</p>",
        "id": 537112975,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756734014
    },
    {
        "content": "<p>It is odd looking but it allows for the <code>Monad m</code> instance to be defined after the <code>ForM</code> instance.</p>",
        "id": 537317299,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1756828397
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> <a href=\"#narrow/channel/270676-lean4/topic/Monad.20assumptions.20in.20fields.20of.20other.20typeclasses/near/537317299\">said</a>:</p>\n<blockquote>\n<p>It is odd looking but it allows for the <code>Monad m</code> instance to be defined after the <code>ForM</code> instance.</p>\n</blockquote>\n<p>You can do that without hard-coding it into <code>ForM</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMonad</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">myMonad</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ForM</span><span class=\"w\"> </span><span class=\"n\">myMonad</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">myMonad</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 537318247,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756828683
    },
    {
        "content": "<p>Note that nowhere in core or batteries does this</p>",
        "id": 537318513,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756828759
    },
    {
        "content": "<p>You're totally right! I guess it just prevents hard-coding the monad. I don't know whether there is a good reason to do that.</p>",
        "id": 537319720,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1756829092
    },
    {
        "content": "<p>I think this is pretty clearly the wrong way to use typeclasses generally, and if this was deliberate it was a hack to make elaboration behave better</p>",
        "id": 537320640,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756829423
    },
    {
        "content": "<p>(there is a small elaboration regression that impacts two lean4 tests where the type of the monad cannot be inferred from the outside in)</p>",
        "id": 537320709,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756829445
    }
]