[
    {
        "content": "<p>so, I was writing some code, and I had <code>foo : IO Unit</code> and I did <code>foo ⟨⟩</code>, then BANG!, an effect of <code>foo</code> was ignored (or executed at the beginning of the program. Anyway, really weird)</p>\n<p>here is an example of what is happening</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"c1\">-- this is ok</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"1.1\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"1.2\"</span>\n\n<span class=\"sd\">/-- info: 1.1</span>\n<span class=\"sd\">1.2 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main1</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"2.1\"</span><span class=\"w\"> </span><span class=\"c1\">-- ok</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"2.2\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"2. error2 {e}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"sd\">/-- info: 2.1</span>\n<span class=\"sd\">2.2 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main2</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EIO</span><span class=\"w\"> </span><span class=\"n\">IO.Error</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"3.1\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"3. error1 {e}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"3.2\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"3. error2 {e}\"</span>\n\n<span class=\"sd\">/-- info: 3.1</span>\n<span class=\"sd\">3.2 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main3</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">IO.Error</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"4.1\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"4.2\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n\n<span class=\"sd\">/-- info: ok: () -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main4</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main5</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO.RealWorld</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">IO.Error</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"5.1\"</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"5.2\"</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- will be executed as if outside of IO</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n\n<span class=\"sd\">/-- info: ok: () -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main5</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"w\"> </span><span class=\"n\">IO.Error</span><span class=\"w\"> </span><span class=\"n\">IO.RealWorld</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"6.1\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- not executed</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"6.2\"</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"c1\">-- not executed</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">_e</span><span class=\"w\"> </span><span class=\"n\">_rw</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main6'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EIO</span><span class=\"w\"> </span><span class=\"n\">IO.Error</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">main6</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main6''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">main6</span>\n\n<span class=\"c1\">-- #guard_msgs in #eval main6 -- unable to synthesize 'MonadEval'</span>\n\n<span class=\"sd\">/-- -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main6'</span>\n\n<span class=\"sd\">/-- -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">main6''</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 1\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main1</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 2\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main2</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 3\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main3</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 4\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">main4</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 5\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">main5</span><span class=\"w\"> </span><span class=\"o\">⟨⟩)</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 6 (EStateM IO.Error IO.RealWorld Unit)\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main6</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 6 (EIO IO.Error Unit)\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main6'</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"s2\">\"========= 6 (IO Unit)\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">main6''</span>\n\n<span class=\"c1\">-- $ lake exe MyExe</span>\n<span class=\"c1\">-- 2.2</span>\n<span class=\"c1\">-- 3.1</span>\n<span class=\"c1\">-- 3.2</span>\n<span class=\"c1\">-- 4.1</span>\n<span class=\"c1\">-- 4.2</span>\n<span class=\"c1\">-- 5.1</span>\n<span class=\"c1\">-- 5.2</span>\n<span class=\"c1\">-- ========= 1</span>\n<span class=\"c1\">-- 1.1</span>\n<span class=\"c1\">-- 1.2</span>\n<span class=\"c1\">-- ========= 2</span>\n<span class=\"c1\">-- 2.1</span>\n<span class=\"c1\">-- ========= 3</span>\n<span class=\"c1\">-- ========= 4</span>\n<span class=\"c1\">-- ok: ()</span>\n<span class=\"c1\">-- ========= 5</span>\n<span class=\"c1\">-- ok: ()</span>\n<span class=\"c1\">-- ========= 6 (EStateM IO.Error IO.RealWorld Unit)</span>\n<span class=\"c1\">-- ========= 6 (EIO IO.Error Unit)</span>\n<span class=\"c1\">-- ========= 6 (IO Unit)</span>\n</code></pre></div>\n<p><a href=\"https://github.com/leanprover/lean4/issues/10192#issue-3371371729\">https://github.com/leanprover/lean4/issues/10192#issue-3371371729</a></p>",
        "id": 537039655,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1756707827
    },
    {
        "content": "<p>We already have <a href=\"https://github.com/leanprover/lean4/pull/2656\">lean4#2656</a> and <a href=\"https://github.com/leanprover/lean4/pull/9631\">lean4#9631</a> to fix this but I think the discussion got a bit stuck</p>",
        "id": 537046026,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756711028
    }
]