[
    {
        "content": "<p>I tried to define a helper macro that uses <code>#guard_msgs</code>. It does elaborate corrrectly, but the code action doesn’t show up. I tried to alias that code, but that didn’t work. Any suggestions? The <code>Elab.Tactic.GuardMsgs.guardMsgsCodeAction</code> code does not seem to look specifically for the <code>guardMsgsCmd</code> syntax or so, I believe.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">`/-- ... -/</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">guard_sig</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">checks</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">given</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span>\n<span class=\"n\">docstring</span><span class=\"bp\">.</span>\n\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">combination</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">`#</span><span class=\"n\">guard_msgs</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">`#</span><span class=\"n\">check</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">confgured</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"w\"> </span><span class=\"n\">through</span><span class=\"bp\">.</span>\n<span class=\"bp\">-/</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">guardSigCmd</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">doc?</span><span class=\"o\">:(</span><span class=\"n\">docComment</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"#guard_sig \"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pass</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CodeAction</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">builtin_command_code_action</span><span class=\"w\"> </span><span class=\"n\">guardSigCmd</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">guardSigCodeAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandCodeAction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GuardMsgs</span><span class=\"bp\">.</span><span class=\"n\">guardMsgsCodeAction</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard_sig</span><span class=\"w\"> </span><span class=\"n\">True</span>\n</code></pre></div>",
        "id": 518286376,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1747311529
    },
    {
        "content": "<p>Is the code action attached to a particular piece of syntax, and only exercised if that syntax is not synthetic?</p>",
        "id": 518287571,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747311820
    },
    {
        "content": "<p>Here is the code of that code action; I didn’t immediately  see anything like that:<br>\n<a href=\"https://github.com/leanprover/lean4/blob/81b85203c90439fb7d7e0cec32130d62d8cb7a2e/src/Lean/Elab/GuardMsgs.lean#L180-L212\">https://github.com/leanprover/lean4/blob/81b85203c90439fb7d7e0cec32130d62d8cb7a2e/src/Lean/Elab/GuardMsgs.lean#L180-L212</a></p>",
        "id": 518291670,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1747312869
    },
    {
        "content": "<p>With <code>#guard_msgs (pass trace, all) in #check True</code> the infotree structure the code action is seeing is this (pardon the ugly representation):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>node(commandInfo) [\n  context (\n    node(commandInfo) [\n      (context (context (node(termInfo) []))),\n      (context (context (node(completionInfo) [])))\n    ]),\n  node(customInfo) []\n]\n</code></pre></div>\n<p>but with <code>#guard_sig True</code> you get</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>node(commandInfo) [\n  node(macroExpansionInfo) [\n    context (\n      node(commandInfo) [\n        context (\n          node(commandInfo) [\n            context (context (node(termInfo) [])),\n            context (context (node(completionInfo) []))\n          ]),\n        node(customInfo) []\n      ])\n  ]\n]\n</code></pre></div>\n<p>The custom info is the one containing the replacement and the one the code action is searching for, but it doesn't find it because it expects it to be a child of the top node, and the code action doesn't search recursively.</p>",
        "id": 518299749,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747314880
    },
    {
        "content": "<p>TIL, thanks for the investigation!</p>",
        "id": 518315419,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1747318267
    },
    {
        "content": "<p>Watch out that <code>#guard_msgs</code> is treated specially in <code>elabCommandTopLevel</code>: <a href=\"https://github.com/leanprover/lean4/blob/528fe0b0ed673accd37d986d80a7c49f876a3087/src/Lean/Elab/Command.lean#L610-L615\">https://github.com/leanprover/lean4/blob/528fe0b0ed673accd37d986d80a7c49f876a3087/src/Lean/Elab/Command.lean#L610-L615</a></p>",
        "id": 518322315,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1747319767
    },
    {
        "content": "<p>Oh wey, I’ll park my attempts for now :-)</p>",
        "id": 518336544,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1747322877
    }
]