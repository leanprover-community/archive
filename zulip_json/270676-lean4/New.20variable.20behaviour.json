[
    {
        "content": "<p>It seems that lean has some new variable behaviour (I think?), and when I updated an old PR I get an error due to this. What would be the best way to resolve it? Here is the code (and variable statement)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ’®</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ’³</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">âŸ¶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">âŸ¶</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsCocartesian</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"o\">]</span>\n\n<span class=\"sd\">/-- Given a cocartesian morphism `Ï† : a âŸ¶ b` lying over `f : R âŸ¶ S` in `ğ’³`, and two morphisms</span>\n<span class=\"sd\">`Ïˆ Ïˆ' : b âŸ¶ b'` lifting `ğŸ™ S` such that `Ï† â‰« Ïˆ = Ï† â‰« Ïˆ'`. Then we must have `Ïˆ = Ïˆ'`. -/</span>\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ’³</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ïˆ</span><span class=\"w\"> </span><span class=\"n\">Ïˆ'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">âŸ¶</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsHomLift</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ğŸ™</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsHomLift</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ğŸ™</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Ïˆ'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"bp\">â‰«</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"bp\">â‰«</span><span class=\"w\"> </span><span class=\"n\">Ïˆ'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Ïˆ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_uniq</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"bp\">â‰«</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map_uniq</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"bp\">â‰«</span><span class=\"w\"> </span><span class=\"n\">Ïˆ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Ïˆ'</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I think I get an error since <code>f</code> is not mentioned in the lemma statement itself, so <code>f</code> is not defined when I try calling <code>map_uniq p f Ï† (Ï† â‰« Ïˆ) Ïˆ rfl</code> in the <code>rw</code> statement below.</p>\n<p>How do I deal with this in the cleanest way? Should I include the instance <code>[IsCocartesian p f Ï†]</code> in the statement, so that <code>f</code> will get recognized? Or is there some other way I can make <code>f</code> (and the instance <code>[IsCocartesian p f Ï†]</code>) get added as hypotheses?</p>",
        "id": 465341178,
        "sender_full_name": "Calle SÃ¶nne",
        "timestamp": 1724740400
    },
    {
        "content": "<p>You could use <code>variable â€¦ in â€¦</code>. But having explicit arguments in variable is not encouraged anyway.</p>",
        "id": 465342258,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724740612
    },
    {
        "content": "<p>Just move <code>[IsCocartesian ...]</code> into the lemma statement.</p>",
        "id": 465343921,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724740840
    },
    {
        "content": "<p>Thanks a lot!</p>",
        "id": 465348341,
        "sender_full_name": "Calle SÃ¶nne",
        "timestamp": 1724741704
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/New.20variable.20behaviour/near/465342258\">said</a>:</p>\n<blockquote>\n<p>You could use <code>variable â€¦ in â€¦</code>. But having explicit arguments in variable is not encouraged anyway.</p>\n</blockquote>\n<p>How come? Because it makes it harder to read?</p>",
        "id": 465348637,
        "sender_full_name": "Calle SÃ¶nne",
        "timestamp": 1724741762
    },
    {
        "content": "<p>It makes it harder to know how to use the lemma by looking at it in the source code.</p>",
        "id": 465363805,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724746298
    },
    {
        "content": "<p>you could also <code>include f in</code> the lemma here</p>",
        "id": 465577412,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724796270
    },
    {
        "content": "<p>Is there a writeup how the new <code>variable</code> command works in the docs/books somewhere?</p>\n<p>I saw the thread discussing the Mathlib \"port\" but couldn't quite understand what exactly the change did.</p>",
        "id": 465586230,
        "sender_full_name": "Adomas Baliuka",
        "timestamp": 1724801292
    },
    {
        "content": "<p>I am recollecting what <span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> explained last month: Basically the list of variables which are included in a theorem's statement is computed entirely from the variables mentioned in the statement and its dependencies.</p>",
        "id": 465590928,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724803807
    },
    {
        "content": "<p>So adding <code>[IsCocartesian p f ...]</code> will also include the variables <code>p</code> and <code>f</code> and the variables mentioned in their declaration and so on</p>",
        "id": 465591033,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724803908
    },
    {
        "content": "<p>What makes it different from before is that it won't include hypothesis that are only referred to in the proof.</p>",
        "id": 465591144,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724803961
    },
    {
        "content": "<p>The reasoning is roughly that in the earlier variant, a proof had to be processed before a theorem's statement could be fully determined, and this might affect how tactics work with that theorem in downstream proofs. For example the <code>apply t</code> tactic needs to know which hypotheses <code>t</code> needs . With the new version of <code>variable</code>, a theorem's assumptions are known by reading it's statement alone and proofs can be elaborated in parallel.</p>",
        "id": 465591433,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724804174
    },
    {
        "content": "<p>What is the deal with the new linter warning about unused type classes? </p>\n<p>mwe</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">I</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âˆ‘</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"c1\">-- linter warning: included section variable '[DecidableEq I]' is not used in 'sum_sum', consider excluding it</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sum_sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">âˆ‘</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- linter warning: included section variable '[Fintype I]' is not used in 'if_eq_true', consider excluding it</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">if_eq_true</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>Very often I have a list of theorem where I have <code>{I} [Fintype I] [DecidableEq I]</code>. Only few of the theorems use <code>[DecidableEq I]</code> and I get bunch of linter warning that I find really annoying. Sure I could group all those theorems that need <code>[DecidableEq I]</code> to a separate section but they are grouped based on different criteria which is more meaningful then the requirement of <code>[DecidableEq I]</code>.</p>\n<p>Honestly I usually opt out with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">deprecated</span><span class=\"bp\">.</span><span class=\"n\">oldSectionVars</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>Is there an option to turn off the warning about unused type class instance?</p>",
        "id": 465593390,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1724805228
    },
    {
        "content": "<p>do you want the theorems in question to use the variables or not?</p>",
        "id": 465593705,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724805301
    },
    {
        "content": "<p>I want <code>sum_sum</code> to only use <code>[Fintype I]</code> and <code>if_eq_true</code> only use <code>[DecidableEq I]</code>.</p>",
        "id": 465593905,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1724805357
    },
    {
        "content": "<p>AFAIK there isn't any way to really express this in the new system short of using <code>omit</code> or <code>include</code> on almost every theorem, which I find unsatisfactory</p>",
        "id": 465594759,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724805596
    },
    {
        "content": "<p>in fact, the version that actually shipped doesn't even have <code>omit</code> and <code>include</code> alone doesn't help, you have to use <code>variable ... in</code> on every theorem instead</p>",
        "id": 465595060,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724805670
    },
    {
        "content": "<p>This is quite unsatisfactory. </p>\n<p>Consider this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">I</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âˆ‘</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>\n<p>The type of <code>sum</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">{</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p>The order of the typeclasses is mixed up. <br>\nI prefer either one of these two styles:</p>\n<ol>\n<li>type binder followed with typeclasses for that type e.g. <code>{I} [Fintype I] {X} [AddCommMonoid X]</code></li>\n<li>all type binders first and then type class binders for those types in the same order e.g. <code>{I X} [Fintype I] [AddCommMonoid X]</code></li>\n</ol>\n<p>I can't easily achieve neither with the new variable command.</p>",
        "id": 465598695,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1724806373
    },
    {
        "content": "<p>There shouldn't be any change in the behavior of <code>def</code></p>",
        "id": 465636614,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724823336
    },
    {
        "content": "<p>If few of your theorems us <code>[DecidableEq I]</code>, the best solution is probably to remove it from the variables line and write for each of them</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 465650609,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1724826837
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"638715\">Adomas Baliuka</span> <a href=\"#narrow/stream/270676-lean4/topic/New.20variable.20behaviour/near/465586230\">said</a>:</p>\n<blockquote>\n<p>Is there a writeup how the new <code>variable</code> command works in the docs/books somewhere?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/blob/master/releases_drafts/new-variable.md\">https://github.com/leanprover/lean4/blob/master/releases_drafts/new-variable.md</a></p>",
        "id": 465666571,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724830413
    }
]