[
    {
        "content": "<p>I'm trying to build a timeout mechanism for IO computations, but it seems to work only with &gt;= 3 threads. MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Test.lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sleep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Time</span><span class=\"bp\">.</span><span class=\"n\">Millisecond</span><span class=\"bp\">.</span><span class=\"n\">Offset</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">cancelTk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">CancelToken</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">asTask</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapIO</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">checkCanceled</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">cancelTk</span><span class=\"bp\">.</span><span class=\"n\">set</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"timed out\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result??</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">waitAny</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">task</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span>\n<span class=\"w\">  </span><span class=\"n\">EIO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"n\">result??</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cancelTk</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">CancelToken</span><span class=\"bp\">.</span><span class=\"n\">new</span>\n<span class=\"w\">  </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"n\">cancelTk</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>env<span class=\"w\"> </span>lean<span class=\"w\"> </span>-j1<span class=\"w\"> </span>Test.lean<span class=\"w\"> </span><span class=\"c1\"># runs forever</span>\n$<span class=\"w\"> </span>lake<span class=\"w\"> </span>env<span class=\"w\"> </span>lean<span class=\"w\"> </span>-j2<span class=\"w\"> </span>Test.lean<span class=\"w\"> </span><span class=\"c1\"># runs forever</span>\n$<span class=\"w\"> </span>lake<span class=\"w\"> </span>env<span class=\"w\"> </span>lean<span class=\"w\"> </span>-j3<span class=\"w\"> </span>Test.lean\nTest.lean:15:0:<span class=\"w\"> </span>error:<span class=\"w\"> </span>timed<span class=\"w\"> </span>out\n</code></pre></div>\n<p>I don't really understand Lean's concurrency features well, so I'd be very grateful if someone could explain what's going on here. <span aria-label=\"thank you\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"thank you\">:thank_you:</span> cc <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> <span class=\"user-mention\" data-user-id=\"481858\">@Sofia Rodrigues</span> since much of the async code seems to be from you.</p>",
        "id": 544402625,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1760277573
    },
    {
        "content": "<p>(Tested on v4.20.0 in case that matters.)</p>",
        "id": 544402843,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1760277781
    },
    {
        "content": "<p>On v4.24.0-rc1, all three invocations seem to hit an <code>unreachable!</code>.</p>",
        "id": 544403124,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1760278039
    },
    {
        "content": "<p>This version works on v4.24.0-rc1 with &gt;= 2 threads, but not with 1:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sleep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Time</span><span class=\"bp\">.</span><span class=\"n\">Millisecond</span><span class=\"bp\">.</span><span class=\"n\">Offset</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">asTask</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapIO</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">checkCanceled</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">task</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"timed out\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result??</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">waitAny</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">task</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span>\n<span class=\"w\">  </span><span class=\"n\">EIO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"n\">result??</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">checkCanceled</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div>",
        "id": 544403642,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1760278625
    },
    {
        "content": "<p>Currently, the Async module works similarly to the Node.js event loop and execution model. If you run an infinite blocking <code>while</code> loop and try to create a <code>setInterval</code> in JS, the <code>setInterval</code> callback won’t execute because Node.js is single-threaded. So, you should avoid doing blocking stuff like infinite loops. In our case, we can summon multiple blocking tasks at the same time, but the limit depends on how many cores you have (Because Lean summons a fixed amount of threads to deal with Tasks). I <strong>think</strong> that right now, we spawn one thread per core. That’s probably the issue with the first code. With one thread, the main thread is running, and the other one will not be summoned. With two threads, both Tasks will be executed, but the third one with the timeout will not be executed because two tasks are blocking both threads.</p>\n<p>The <code>IO.CancelToken</code> isn’t something you use with raw tasks, I made it to work with the <code>Async</code> module, which summons multiple short lived tasks, so we can’t really control them directly with the current Task cancellation operations. Instead, you use <code>IO.checkCancelled</code> and <code>IO.cancel</code>, because a <code>Task</code> can’t be cancelled in the middle of execution unless you explicitly check for it.</p>\n<p>This is the correct way to use these things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sleep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Time</span><span class=\"bp\">.</span><span class=\"n\">Millisecond</span><span class=\"bp\">.</span><span class=\"n\">Offset</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">asTask</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapIO</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">task</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"timed out\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result??</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">waitAny</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">task</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">cancelTask</span>\n\n<span class=\"w\">  </span><span class=\"n\">EIO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"n\">result??</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withTimeoutCore</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">checkCanceled</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">break</span>\n\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"running\"</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">100</span>\n</code></pre></div>",
        "id": 544404737,
        "sender_full_name": "Sofia Rodrigues",
        "timestamp": 1760279705
    },
    {
        "content": "<p>About the last code that u sent, it’s not working with a single thread for the same reason I mentioned earlier about how many threads we have available for Tasks.</p>",
        "id": 544405193,
        "sender_full_name": "Sofia Rodrigues",
        "timestamp": 1760280149
    },
    {
        "content": "<p>I see, thank you for the thorough explanation! So I guess the question is which operations can be used to yield control to other async tasks. Python makes this explicit with <code>await</code>; I'm not familiar with JS's system. Is there something similar in Lean, or a set of operations that I can expect to yield?</p>\n<p>In any case, the real use case is cancelling a <code>CoreM</code> computation. (Hence the weird <code>CancelToken</code> in my first code.) I guess I shouldn't expect Lean functions to yield frequently, so a single-threaded timeout seems out of the question. I guess my best bet is to give Lean a bunch of threads and maybe disable async elaboration, to maximise the chance that the timeout thread actually gets to run? Or maybe a signal-based timeout, but afaict Lean doesn't let me set signal handlers atm.</p>",
        "id": 544406461,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1760281004
    },
    {
        "content": "<p>You'll want to use <code>(prio := .dedicated)</code> when starting any task that should not be enqueued in the thread pool, such as for your timeout task</p>",
        "id": 544408971,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1760283061
    }
]