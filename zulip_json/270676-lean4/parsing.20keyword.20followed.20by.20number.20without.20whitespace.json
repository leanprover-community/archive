[
    {
        "content": "<p>Hi, I would like to define a <code>syntax</code> such that it can parse numbers of the form <code>bv1</code>, <code>bv2</code>, ... as <code>1</code>, <code>2</code>, ... However, Lean always parses <code>bv1</code> as an identifier instead of <code>bv</code> followed by the number <code>1</code>, even for a syntax category where there are no identifiers allowed. Is there a way around this?</p>\n<p>The following illustrates the problem</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"bv\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">test</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabTest</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bv</span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test_elab \"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabTest</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test_elab</span><span class=\"w\"> </span><span class=\"n\">bv2</span>\n<span class=\"c1\">-- fails with unexpected identifier; expected test</span>\n<span class=\"c1\">-- should print 2 : Nat</span>\n</code></pre></div>",
        "id": 518267698,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1747306247
    },
    {
        "content": "<p>You can try <code>#bv1</code>, which I don't think is a legel identifier</p>",
        "id": 518269227,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747306685
    },
    {
        "content": "<p>Indeed, using '#bv1` would probably work. The problem is that I have an existing format that I would like to parse, so I would be interested if there are ways to do this without changing the format.</p>",
        "id": 518271321,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1747307310
    },
    {
        "content": "<p>You can always accept any identifiers and then parse/reject them when elaborating the syntax tree</p>",
        "id": 518271817,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1747307463
    },
    {
        "content": "<p>This sounds like it would be what I need. Do you have a pointer where I can see / learn how I can parse during elaboration?<br>\nSo far, I have based my code on <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/08_dsls.html\">Metaprogramming in Lean</a>, but I do not think this book explains how to call the parser from the elaborator.</p>",
        "id": 518273147,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1747307912
    },
    {
        "content": "<p>Oh I would parse that tiny remaining grammar manually, calling back into the Lean parser isn't necessary there</p>",
        "id": 518274028,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1747308206
    },
    {
        "content": "<p>I see, that is probably the easiest indeed. This approach seems to work! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span>  Thank you for your help!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">test</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabTest</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"bv\"</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"bp\">.</span><span class=\"n\">toNat?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test_elab \"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabTest</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test_elab</span><span class=\"w\"> </span><span class=\"n\">bv2</span>\n</code></pre></div>",
        "id": 518277315,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1747309153
    }
]