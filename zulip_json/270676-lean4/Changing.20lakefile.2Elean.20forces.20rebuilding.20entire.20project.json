[
    {
        "content": "<p>Changing the <code>lakefile.lean</code> in a trivial way (such as, changing a doc comment or the definition of an executable defined there) makes <code>lake build</code> rebuild the world: is this expected or known?</p>\n<p>This is obviously not very high priority, but if fixing it is easy, it might be worth it.</p>",
        "id": 452504867,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721373415
    },
    {
        "content": "<p>In general this is necessary because you might have changed some Lean options, right?</p>",
        "id": 452509457,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1721375129
    },
    {
        "content": "<p>Sure; I agree that rebuilding the entire project is needed <em>in the general case</em>. My <del>complaint</del> request is that lake seems to always rebuild, with no notion of \"no relevant changes were made, so let me skip this\".</p>",
        "id": 452509665,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721375195
    },
    {
        "content": "<p>I agree with the sentiment, but I think that measuring what counts as \"no relevant change\" is very hard.</p>",
        "id": 452509771,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721375242
    },
    {
        "content": "<p>Specifically to doc-comments, those are involved in some linters, so that would be even harder to check what counts as \"irrelevant change\".</p>",
        "id": 452509909,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721375295
    },
    {
        "content": "<p>Maybe, whitespace/comments-only changes?  And applicable to <em>every</em> lean file, not just lakefile.</p>",
        "id": 452510218,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721375455
    },
    {
        "content": "<p>How about \"only changes to executables\"? In my case, I was renaming the <code>checkYaml</code> executable, which is not used at all for building mathlib.</p>",
        "id": 452537643,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721383697
    },
    {
        "content": "<p>Would some kind of incremental compilation be able to detect this?</p>",
        "id": 452537677,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721383711
    },
    {
        "content": "<p>Lake should not rebuild things just because the configuration file changed. Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 452722183,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721454020
    },
    {
        "content": "<p>I have not experienced this beahavior before, so I am curious as to the context in which this occurs.</p>",
        "id": 452722334,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721454198
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/Changing.20lakefile.2Elean.20forces.20rebuilding.20entire.20project/near/452722183\">said</a>:</p>\n<blockquote>\n<p>Lake should not rebuild things just because the configuration file changed. Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>\n</blockquote>\n<p>I do: mathlib PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/14892\">#14892</a> - the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10004114134/job/27652208338\">workflow run</a> reveals that CI was rebuilding all of mathlib. (The \"build mathlib\" step should have taken less than two minutes, all of cache, instead of 45.) All I did was renaming the <code>checkYaml</code> executable, which has no bearing to building mathlib itself.</p>",
        "id": 452789905,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721460521
    },
    {
        "content": "<p>I can reproduce the same locally (on my linux notebook).</p>",
        "id": 452789937,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721460550
    },
    {
        "content": "<p>It's good to hear that this is meant to be different - gives me hope this might be fixed <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 452789945,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721460572
    },
    {
        "content": "<p>You're blaming the wrong software - this shows that <code>cache</code> does not work as expected, not Lake</p>",
        "id": 452791076,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721461187
    },
    {
        "content": "<p>I see - I apologise to lake then. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Can <code>cache</code> get fixed? How difficult would this be?</p>",
        "id": 452792185,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721461544
    },
    {
        "content": "<p>My understanding was that <code>cache</code> doesn't have access to Lake's data, and so the best effort thing to do is assume the data changed if the lakefile changed</p>",
        "id": 452838241,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721480974
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/270676-lean4/topic/Changing.20lakefile.2Elean.20forces.20rebuilding.20entire.20project/near/452789937\">said</a>:</p>\n<blockquote>\n<p>I can reproduce the same locally (on my linux notebook).</p>\n</blockquote>\n<p>Locally, <code>lake exe cache get</code> should only be run on a fresh checkout (of a git commit w/o without changes). After making changes, a <code>lake build</code> should only rebuild the changed files. There should not be a need to run <code>lake exe cache get</code> after making local changes, so the cache invalidation should not matter much.</p>",
        "id": 452856086,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721491114
    },
    {
        "content": "<p>Hmmmm, I think I disagree with this advice. I regularly, and successfully, run <code>cache get</code> on modified branches, expecting to get oleans for every thing prior to the changes.</p>",
        "id": 452866527,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721495990
    },
    {
        "content": "<p>I think it is a bad idea to mix changes to the lakefile and \"mathematical\" changes which would need lots of cache files. In the past it's usually been for either maintenance changes or new tools, neither of which really needs mathlib to be compiled locally</p>",
        "id": 452866816,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721496112
    }
]