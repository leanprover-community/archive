[
    {
        "content": "<p>I have a problem with disappearing brackets when pretty printing syntax</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"o\">:</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"o\">:</span><span class=\"mi\">71</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"o\">:</span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"return \"</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myterm</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"n\">myterm</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"before: {stx}\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"after: {r}\"</span>\n</code></pre></div>\n<p>prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">before</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"n\">after</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span>\n</code></pre></div>\n<p>Why did the bracket around <code>a + b</code> disappeared on the last line?</p>",
        "id": 564372013,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1766025252
    },
    {
        "content": "<p><del>Because it's parsed as <code>(return a) + (b * d)</code> I think?</del> Nope, that's not true.</p>",
        "id": 564379437,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766032259
    },
    {
        "content": "<p>The brackets in <code>before:</code> aren't the brackets you defined in <code>syntax \"(\" myterm \")\" : myterm</code>. In fact, you can comment this line and the brackets will still be there. I'm guessing the brackets were introduced by delabolator. It's still surprising why there are brackets in <code>before:</code>, but not in <code>after:</code>.</p>",
        "id": 564379987,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766032594
    },
    {
        "content": "<p>Yeah true, the bracket is not there as a syntax object. How can I add brackets automatically based on precedences?</p>",
        "id": 564398872,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1766044776
    },
    {
        "content": "<p>I suspect custom syntactic categories don't get their parenthesizer by default, because I can fix this with just forwarding what is practically a default implementation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Parenthesizer</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">category_parenthesizer</span><span class=\"w\"> </span><span class=\"n\">myterm</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mytermParenthesizer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CategoryParenthesizer</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span>\n<span class=\"w\">  </span><span class=\"n\">maybeParenthesize</span>\n<span class=\"w\">    </span><span class=\"ss\">`myterm</span>\n<span class=\"w\">    </span><span class=\"n\">false</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">âŸ¨</span><span class=\"n\">stx</span><span class=\"bp\">âŸ©</span><span class=\"o\">):</span><span class=\"n\">myterm</span><span class=\"o\">)))</span>\n<span class=\"w\">    </span><span class=\"n\">prec</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">parenthesizeCategoryCore</span><span class=\"w\"> </span><span class=\"ss\">`myterm</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: before: (aâœ + bâœ) * dâœ</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: after: return (aâœ + bâœ) * dâœ</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myterm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"n\">myterm</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"before: {stx}\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"after: {r}\"</span>\n</code></pre></div>",
        "id": 564408269,
        "sender_full_name": "FrantiÅ¡ek SilvÃ¡Å¡i ğŸ¦‰",
        "timestamp": 1766048063
    }
]