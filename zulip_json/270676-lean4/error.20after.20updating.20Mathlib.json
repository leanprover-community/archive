[
    {
        "content": "<p>I have experienced this twice in the last week: I move to a new version of Mathlib, get the cache, I open a file somewhere in the import hierarchy and I have to rebuild the file. During the rebuild, I get an error in proofwidgets.</p>\n<p>Last time I deleted by <code>.lake</code> file and that solved the issues, but since it is a recurring problem, here is the error I get.</p>\n<p>I am on the current Mathlib <code>bbaf1a0ef4e</code> have gotten the cache (<code>lake env lean Mathlib.lean</code> succeeds) and then open <code>Mathlib.Topology.Basic</code>. I get the message that I have to rebuild imports, and upon doing that I get the following error.</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>`c:\\Users\\Floris\\.elan\\toolchains\\leanprover--lean4---v4.15.0-rc1\\bin\\lake.exe setup-file C:/Users/Floris/projects/mathlib/Mathlib/Topology/Basic.lean Init Mathlib.Order.Filter.Lift Mathlib.Topology.Defs.Filter Mathlib.Topology.Defs.Basic Mathlib.Data.Set.Lattice Mathlib.Order.Filter.AtTopBot` failed:\n\nstderr:\n✖ [519/648] Building proofwidgets/widgetJsAll\ntrace: .\\.\\.lake/packages\\proofwidgets\\widget&gt; npm.cmd clean-install\ntrace: stderr:\nnode:internal/modules/cjs/loader:1228\n  throw err;\n  ^\n\nError: Cannot find module 'c:\\Users\\Floris\\projects\\mathlib\\.lake\\packages\\proofwidgets\\widget\\node_modules\\npm\\bin\\npm-prefix.js'\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1225:15)\n    at Module._load (node:internal/modules/cjs/loader:1051:27)\n    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)\n    at node:internal/main/run_main_module:28:49 {\n  code: 'MODULE_NOT_FOUND',\n  requireStack: []\n}\n\nNode.js v20.17.0\nnode:internal/modules/cjs/loader:1228\n  throw err;\n  ^\n\nError: Cannot find module 'c:\\Users\\Floris\\projects\\mathlib\\.lake\\packages\\proofwidgets\\widget\\node_modules\\npm\\bin\\npm-cli.js'\n    at Module._resolveFilename (node:internal/modules/cjs/loader:1225:15)\n    at Module._load (node:internal/modules/cjs/loader:1051:27)\n    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:174:12)\n    at node:internal/main/run_main_module:28:49 {\n  code: 'MODULE_NOT_FOUND',\n  requireStack: []\n}\n\nNode.js v20.17.0\nerror: external command 'npm.cmd' exited with code 1\nSome required builds logged failures:\n- proofwidgets/widgetJsAll\nerror: build failed\n</code></pre></div>\n<p>After opening these files, running <code>lake build</code> from the command line also gives this error.</p>",
        "id": 486088949,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733317769
    },
    {
        "content": "<p>(this is on Windows)</p>",
        "id": 486089126,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733317821
    },
    {
        "content": "<p>I think the conclusion was that local builds should never try to run <code>npm</code></p>",
        "id": 486089739,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733318016
    },
    {
        "content": "<p>And the reason they sometimes try to is related to lake caching conflicting with <code>lake exe cache</code> (?) or your local network connection (?)</p>",
        "id": 486089994,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733318088
    },
    {
        "content": "<p>This happens when I open a file in Mathlib, while having a cache that seems to work on the command line.</p>",
        "id": 486092058,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733318775
    },
    {
        "content": "<p>This happened to me several times this week when updating a branch to last mathlib version. Also on windows, working network connection. I solved it each time by deleting .lake, as you did.</p>",
        "id": 486096852,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1733320209
    },
    {
        "content": "<p>We are hoping that <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>'s <a href=\"https://github.com/leanprover-community/mathlib4/pull/19728\">#19728</a> (just sent to bors) resolves the problem.</p>",
        "id": 486195505,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733354294
    },
    {
        "content": "<p>I think it's indeed fixed now.</p>",
        "id": 487048573,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733763436
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span>  I've run into exactly the same error. So do I need to Update my Mathlib to the latest version (Right now I'm using v4.13.0)? Thanks. <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span></p>",
        "id": 489879320,
        "sender_full_name": "Weihang Xu",
        "timestamp": 1734578266
    },
    {
        "content": "<p>Try removing <code>.lake</code> and getting the cache again first</p>",
        "id": 489893314,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1734588870
    },
    {
        "content": "<p>Thank you for your suggestion! Now I'm building the latest mathlib4 project directly using <code>leanprover/lean4:v4.15.0-rc1</code>, instead of importing <code>Mathlib</code> as a package, the issue doesn't occur anymore. <span aria-label=\"frowning\" class=\"emoji emoji-1f626\" role=\"img\" title=\"frowning\">:frowning:</span></p>",
        "id": 489917889,
        "sender_full_name": "Weihang Xu",
        "timestamp": 1734599971
    }
]