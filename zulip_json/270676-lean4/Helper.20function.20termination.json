[
    {
        "content": "<p>I have this function which determines if a list is a sublist of another:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mystery</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"n\">iOffset</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">emptyWithCapacity</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h_iSrc'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">map</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h_iDst'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Alignment failed</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h_iOffset'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">iOffset</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Restart</span>\n<span class=\"w\">      </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">flag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">[</span><span class=\"n\">iSrc</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"o\">[</span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">iDst</span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">flag</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- We can advance one step forward</span>\n<span class=\"w\">      </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">iOffset</span><span class=\"w\"> </span><span class=\"n\">map</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Pairing is impossible</span>\n<span class=\"w\">      </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"n\">iDst</span><span class=\"w\"> </span><span class=\"n\">iSrc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iOffset</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">map</span>\n<span class=\"w\">  </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">iDst</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">map?</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">iter</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>but when I tried to prove termination of <code>iter</code> (the decreasing measure is obviously wrong but just here for the sake of examples), Lean says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">n'</span>\n</code></pre></div>\n<p>How can I prove termination of the function then? I noticed that if <code>n</code> shows up in the parameter list then there is no error.</p>",
        "id": 535570340,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1755806416
    },
    {
        "content": "<p>why do you need meta?</p>",
        "id": 535586711,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755814612
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/Helper.20function.20termination/near/535586711\">said</a>:</p>\n<blockquote>\n<p>why do you need meta?</p>\n</blockquote>\n<p>this was extracted from another algorithm that requires <code>MetaM</code></p>",
        "id": 535586770,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1755814650
    },
    {
        "content": "<p>i might be wrong, but the standard practice seems to be either to use <code>partial</code> with <code>meta</code>, or to not use meta</p>",
        "id": 535586795,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755814663
    },
    {
        "content": "<p>sure, but meta can also call regular functions</p>",
        "id": 535586828,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755814678
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/Helper.20function.20termination/near/535586795\">said</a>:</p>\n<blockquote>\n<p>i might be wrong, but the standard practice seems to be either to use <code>partial</code> with <code>meta</code>, or to not use meta</p>\n</blockquote>\n<p>In <code>Lean.Meta.Tactic.Apply</code>, there is a similar case of <code>MetaM</code> with a termination proof, so I thought this would be possible to prove as well.</p>",
        "id": 535586960,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1755814768
    },
    {
        "content": "<p>Not a proper diagnosis of what's going on with this example, but I just wanted to comment that the error yielded by the example is surprisingly brittle.</p>\n<p>In the original code, as Leni noted, Lean gives an <code>unknown identifier 'n'</code> error message. However, if any of the following variants are made, the error goes away and is replaced by the much more reasonable error that Lean is failing to prove termination:</p>\n<ul>\n<li>Replacing the line <code>let flag := src[iSrc] = dst[iSrc + iDst]</code> with <code>let flag := src[iSrc] = dst[iSrc + iDst]!</code> (just using <code>getElem!</code> instead of <code>getElem</code>).</li>\n<li>Replacing the line <code>termination_by n - iDst</code> with <code>termination_by dst.length - iDst</code>.</li>\n<li>Replacing the line <code>let n := dst.length</code> with <code>have n := dst.length; have hn : n = dst.length := sorry</code>.</li>\n</ul>\n<p>No clue what to make of any of this beyond the fact that this behavior strikes me as decidedly strange, and I'd be interested if someone were able to explain what was causing this discrepancy.</p>",
        "id": 535591515,
        "sender_full_name": "Josh Clune",
        "timestamp": 1755818134
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"436568\">Josh Clune</span> <a href=\"#narrow/channel/270676-lean4/topic/Helper.20function.20termination/near/535591515\">said</a>:</p>\n<blockquote>\n<p>Not a proper diagnosis of what's going on with this example, but I just wanted to comment that the error yielded by the example is surprisingly brittle.</p>\n<p>In the original code, as Leni noted, Lean gives an <code>unknown identifier 'n'</code> error message. However, if any of the following variants are made, the error goes away and is replaced by the much more reasonable error that Lean is failing to prove termination:</p>\n<ul>\n<li>Replacing the line <code>let flag := src[iSrc] = dst[iSrc + iDst]</code> with <code>let flag := src[iSrc] = dst[iSrc + iDst]!</code> (just using <code>getElem!</code> instead of <code>getElem</code>).</li>\n<li>Replacing the line <code>termination_by n - iDst</code> with <code>termination_by dst.length - iDst</code>.</li>\n<li>Replacing the line <code>let n := dst.length</code> with <code>have n := dst.length; have hn : n = dst.length := sorry</code>.</li>\n</ul>\n<p>No clue what to make of any of this beyond the fact that this behavior strikes me as decidedly strange, and I'd be interested if someone were able to explain what was causing this discrepancy.</p>\n</blockquote>\n<p>My initial hypothesis is that only arguments and variables introduced by <code>have</code> can show up in the <code>termination_by</code>, but then looking at <code>Lean.Meta.Tactic.Apply</code>, we have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rangeNumArgs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">hasMVarHead</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">numArgs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">numArgs</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">targetTypeNumArgs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpectedNumArgs</span><span class=\"w\"> </span><span class=\"n\">targetType</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">numArgs</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">targetTypeNumArgs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">numArgs</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span>\n<span class=\"cm\">    Auxiliary function for trying to add `n` underscores where `n ∈ [i: rangeNumArgs.stop)`</span>\n<span class=\"cm\">    See comment above</span>\n<span class=\"cm\">    -/</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">BinderInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">rangeNumArgs</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newMVars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">binderInfos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">eType</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEqApply</span><span class=\"w\"> </span><span class=\"n\">cfg</span><span class=\"bp\">.</span><span class=\"n\">approx</span><span class=\"w\"> </span><span class=\"n\">eType</span><span class=\"w\"> </span><span class=\"n\">targetType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newMVars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">binderInfos</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n<span class=\"w\">          </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">conclusionType?</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">rangeNumArgs</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">eType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">rangeNumArgs</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">throwApplyError</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"n\">eType</span><span class=\"w\"> </span><span class=\"n\">conclusionType?</span><span class=\"w\"> </span><span class=\"n\">targetType</span><span class=\"w\"> </span><span class=\"n\">term?</span>\n<span class=\"w\">      </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">rangeNumArgs</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>",
        "id": 535780571,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1755922789
    },
    {
        "content": "<p><del>I found out that if I explicitly provide the in-bound hypothesis <code>src[iSrc]'hz</code> where <code>hz</code> is derived from <code>h_iSrc</code>, then the error goes away as well. It seems like by not providing this hypothesis, there is some kind of variable elision going on</del></p>\n<p>Nevermind it does not</p>",
        "id": 535780753,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1755923100
    }
]