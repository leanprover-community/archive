[
    {
        "content": "<p>Ok, so I have the following function which makes the termination checker unhappy:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">advanceWhile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParseState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParseState</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">isOk</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">acceptNext</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ParseResult</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">state'</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">state'</span><span class=\"bp\">.</span><span class=\"n\">advanceWhile</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">state</span>\n</code></pre></div>\n<p>It's telling me that it cannot prove this:</p>\n<p><strong>state</strong> : ParseState<br>\n<strong>pred</strong> : Char → Bool<br>\n<strong>state'</strong> : ParseState<br>\n<strong>c</strong> : Char<br>\n<strong>isOk</strong> : state.acceptNext = ParseResult.ok state' c<br>\n<strong>h✝</strong> : pred c = true<br>\n<strong>⊢</strong> sizeOf state' &lt; sizeOf state</p>\n<p>Now, I actually proved this in a separate theorem.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">acceptNext_shrinks_state</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">state'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParseState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">acceptNext</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ParseResult</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">state'</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">state'</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>How do I tell the termination checker to look at that theorem?</p>",
        "id": 508655684,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743129599
    },
    {
        "content": "<p><code>decreasing_by exact acceptNext_shrinks_state</code> at the end of the definition</p>",
        "id": 508658805,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743131443
    },
    {
        "content": "<p>give or take</p>",
        "id": 508658865,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743131484
    },
    {
        "content": "<p>When I open decreasing_by, the goal is now:</p>\n<p><strong>⊢</strong> (invImage (fun x =&gt; PSigma.casesOn x fun state pred =&gt; state) instWellFoundedRelationOfSizeOf).1 ⟨state', pred⟩ ⟨state, pred⟩</p>\n<p>which is quite different from \"sizeOf state' &lt; sizeOf state\".<br>\nI then have to do a whole bunch of unfolding to get through the multiple layers of typeclasses. Is there a way around that?</p>",
        "id": 508659970,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743132194
    },
    {
        "content": "<p>hm, try adding <code>termination_by state</code> before the <code>decreasing_by</code></p>",
        "id": 508661740,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743133409
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/How.20do.20I.20tell.20the.20termination.20checker.20about.20a.20theorem.3F/near/508661740\">said</a>:</p>\n<blockquote>\n<p>hm, try adding <code>termination_by state</code> before the <code>decreasing_by</code></p>\n</blockquote>\n<p>It get \"no extra parameters bounds, please omit the <code>=&gt;</code>\"</p>",
        "id": 508662418,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743133854
    },
    {
        "content": "<p>note the edit</p>",
        "id": 508663535,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743134548
    },
    {
        "content": "<p>Ah yes. I tried that and it didn't change anything.</p>",
        "id": 508663566,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743134581
    },
    {
        "content": "<p>the goal in the decreasing_by should be different</p>",
        "id": 508663611,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743134621
    },
    {
        "content": "<p>you could also try <code>termination_by sizeOf state</code>, which should produce the same goal but maybe with a less obfuscated statement</p>",
        "id": 508663760,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743134716
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/How.20do.20I.20tell.20the.20termination.20checker.20about.20a.20theorem.3F/near/508663760\">said</a>:</p>\n<blockquote>\n<p>you could also try <code>termination_by sizeOf state</code>, which should produce the same goal but maybe with a less obfuscated statement</p>\n</blockquote>\n<p>I tried it three ways and it unfortunately isn't any simpler. (I do appreciate the help though)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- No termination_by</span>\n<span class=\"c1\">-- ⊢ (invImage (fun x =&gt; PSigma.casesOn x fun state pred =&gt; state) instWellFoundedRelationOfSizeOf).1 ⟨state', pred⟩ ⟨state, pred⟩</span>\n<span class=\"c1\">-- termination_by state</span>\n<span class=\"c1\">-- ⊢ (invImage (fun x =&gt; PSigma.casesOn x fun state pred =&gt; state) instWellFoundedRelationOfSizeOf).1 ⟨state', pred⟩ ⟨state, pred⟩</span>\n<span class=\"c1\">-- termination_by (sizeOf state)</span>\n<span class=\"c1\">-- ⊢ (invImage (fun x =&gt; PSigma.casesOn x fun state pred =&gt; sizeOf state) instWellFoundedRelationOfSizeOf).1 ⟨state', pred⟩ ⟨state, pred⟩</span>\n</code></pre></div>",
        "id": 508664249,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743135080
    },
    {
        "content": "<p>i guess it's fine, all three statements are really <code>sizeOf state' &lt; sizeOf state</code> in disguise</p>",
        "id": 508666976,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743136583
    },
    {
        "content": "<p><code>simp_wf</code> will clean them up</p>",
        "id": 508666991,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743136596
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/How.20do.20I.20tell.20the.20termination.20checker.20about.20a.20theorem.3F/near/508666991\">said</a>:</p>\n<blockquote>\n<p><code>simp_wf</code> will clean them up</p>\n</blockquote>\n<p>Forgot to reply earlier, but thanks, yes. simp_wf is a godsend.</p>",
        "id": 508765525,
        "sender_full_name": "Alex Zani",
        "timestamp": 1743171175
    }
]