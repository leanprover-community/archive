[
    {
        "content": "<p>In the example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kd\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span>\n\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- set_option trace.Meta.isLevelDefEq true in</span>\n<span class=\"c1\">-- set_option trace.Elab.step true in</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace.Elab.struct</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.all</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c1\">-- set_option trace.Elab.struct true in</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">▶ expected type (15:15-18:1)</span>\n<span class=\"sd\">α : Type u</span>\n<span class=\"sd\">β : Type v</span>\n<span class=\"sd\">γ : Type w</span>\n<span class=\"sd\">⊢ Foo.{max w v u}</span>\n\n<span class=\"sd\">▶ 15:15-16:1: information:</span>\n<span class=\"sd\">[Elab.struct] {type := (α ⊕ β) ⊕ γ}</span>\n\n<span class=\"sd\">[Elab.struct] elabStruct type := (α ⊕ β) ⊕ γ, Type ?u.226 → Foo.{?u.226}</span>\n\n<span class=\"sd\">[Elab.struct] before propagate Foo.mk.{max w v u} (Sum.{max v u, w} (Sum.{u, v} α β) γ)</span>\n<span class=\"sd\">-/</span>\n</code></pre></div>\n<p>It would seem that in the private <code>Lean.Elab.Term.StructInst.elabStructInstAux</code> which is called by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.StructInst.elabStructInst#doc\">docs#Lean.Elab.Term.StructInst.elabStructInst</a> we should know the universe levels of <code>foo</code> when the trace for <code>Elab.struct</code> on line 1190 is hit. However, when I try to act on expression at that point via <code>normalize</code>, nothing happens. It seems there is a level metavariable in expression at this point in elaboration despite the trace showing something else. </p>\n<ul>\n<li>Am I correct? </li>\n<li>Where is the trace pulling the information from?</li>\n<li>If correct, when is the metavariable actually instantiated?</li>\n</ul>",
        "id": 497461276,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738595484
    },
    {
        "content": "<p>It is true that the trace will instantiate metavariables, so it could be that there is still a metavariable in the expression, but that it has an assignment, so the trace doesn't show the metavariable.</p>",
        "id": 497795573,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738722162
    },
    {
        "content": "<p>If you use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>Then you can see that there is a step of <code>instantiateMVarsProfiling</code> that comes after the Elab.struct trace. So it seems probable that this is when they are instantiated.</p>",
        "id": 497796558,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738722804
    },
    {
        "content": "<p>the <code>trace</code> function makes a copy of the local context and metavariable context, in order to be able to nicely render the expressions, so that is how it gets the metavariable instantiations.</p>",
        "id": 497796761,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738722941
    },
    {
        "content": "<p>I've had this problem/confusion many times. But I just found out there is a solution: <code>set_option pp.instantiateMVars false</code>. <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 497797058,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738723101
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 497891501,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738761726
    }
]