[
    {
        "content": "<p>I am trying to use <code>InfoState.lazyAssignment</code> with async elaboration following <a href=\"https://github.com/leanprover/lean4/blob/32894e7349b367c57825855a2719847ea3758eb7/src/Lean/Elab/MutualDef.lean#L1197\">the <code>def</code> elaborator</a>. However, it seems that the info is not used by the server unless I put it in explicitly as opposed to using <code>InfoTree.hole</code>. This is surprising because the <code>def</code> elaborator doesn't seem to do that. What am I doing wrong here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"s2\">\"info_hole\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">infoHole</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">mkFreshMVarId</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">wi</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">WidgetInstance</span><span class=\"bp\">.</span><span class=\"n\">ofHash</span><span class=\"w\"> </span><span class=\"n\">TryThis</span><span class=\"bp\">.</span><span class=\"n\">tryThisWidget</span><span class=\"bp\">.</span><span class=\"n\">javascriptHash</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofUserWidgetInfo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">wi</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"n\">modifyInfoState</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"c1\">-- widget shows up with this \\/</span>\n<span class=\"w\">    </span><span class=\"c1\">--trees := s.trees.push info</span>\n<span class=\"w\">    </span><span class=\"n\">trees</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">trees</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"n\">infoHole</span>\n<span class=\"w\">    </span><span class=\"n\">lazyAssignment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">lazyAssignment</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">infoHole</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">info_hole</span><span class=\"w\"> </span><span class=\"c1\">-- no widget here</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 526446936,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1751303356
    },
    {
        "content": "<p>Huh, if you look at the infotrees, then they are correct and the widget appears.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">info_trees</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">info_hole</span><span class=\"w\"> </span><span class=\"c1\">-- no widget here</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 526451133,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751305111
    },
    {
        "content": "<p>But if you don't, then it's not there.</p>",
        "id": 526451167,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751305122
    },
    {
        "content": "<p>It also works with the pre-parallel-elaboration <code>assignment := s.assignment.insert infoHole info</code>. It looks like <code>InfoTree.visitM</code> just ignores holes. Should it be doing that? Is there a missing <code>InfoTree.instantiateMVars</code> (or whatever it's called) somewhere?</p>",
        "id": 526465212,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1751309225
    },
    {
        "content": "<p>There's a <code>InfoState.substituteLazy</code> function that's responsible for this, and either it's not being called, or maybe there's something subtle about nested lazy assignments?</p>",
        "id": 526467482,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751309898
    },
    {
        "content": "<p>You can see in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.InfoTrees.elabInfoTrees#doc\">docs#Lean.Elab.Tactic.InfoTrees.elabInfoTrees</a> that <code>substituteLazy</code> is called again</p>",
        "id": 526467588,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751309935
    },
    {
        "content": "<p>It's also higher latency to do this on the entire tree; the server should only wait on tasks that it actually needs. It would be easier if infotrees maintained the invariant that subtrees are always syntactic subranges, though, which iirc they sometimes don't.</p>",
        "id": 526468647,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1751310231
    },
    {
        "content": "<p>Finer-grained forcing of lazy assignments in the server is TBD, the simple current implementation assumes there are no lazy holes on the tactic level</p>",
        "id": 526481080,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1751314832
    }
]