[
    {
        "content": "<p>I have a problem with a termination proof in Lean4. I have a group of<br>\nmutually recursive functions, using fuel. They are in a <code>mutual</code> block<br>\nand each of them has at the end:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">fuel</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pred_lt_of_ne_zero</span><span class=\"w\"> </span><span class=\"bp\">‹</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">›</span>\n</code></pre></div>\n<p>I can see in the IDE that these tactics discharge all termination<br>\ngoals for each function. However, I am getting the following message<br>\nat the <code>mutual</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Cannot</span><span class=\"w\"> </span><span class=\"n\">derive</span><span class=\"w\"> </span><span class=\"n\">typecheckExpr</span><span class=\"bp\">._</span><span class=\"n\">mutual</span><span class=\"bp\">.</span><span class=\"n\">eq_def</span>\n<span class=\"w\">  </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">simp'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nested</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`simp</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"w\">  </span><span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"bp\">.</span>\n\n<span class=\"w\">  </span><span class=\"n\">Additional</span><span class=\"w\"> </span><span class=\"n\">diagnostic</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">available</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"bp\">.</span>\n\n<span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AsyncConsts</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span><span class=\"o\">:</span><span class=\"mi\">443</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"w\"> </span><span class=\"n\">normalized</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">typecheckExpr</span><span class=\"w\"> </span><span class=\"n\">vs</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">typecheckExpr</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">lord</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.20.1/lib/lean/libleanshared.so(lean_panic+0xf5) [0x7200f0f0e0a5]</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>I am a new Lean user and appreciate any advice on how to tackle this.</p>",
        "id": 527754186,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1752000322
    },
    {
        "content": "<p>Can you provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 527754587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752000499
    },
    {
        "content": "<p>I can try to trim it down. I will post one little later.</p>",
        "id": 527755761,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1752001029
    },
    {
        "content": "<p>Can you define the functions together in one def?</p>",
        "id": 527761744,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752003706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/270676-lean4/topic/termination.20proofs.20with.20fuel/near/527761744\">said</a>:</p>\n<blockquote>\n<p>Can you define the functions together in one def?</p>\n</blockquote>\n<p>Not sure how to do that. I thought you need \"mutual\" block for mutually recursive functions</p>",
        "id": 527768704,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1752006950
    },
    {
        "content": "<p>Also, my functions are returning <code>Except String</code> monad, if that relevant. (I am reading about <code>partial_fixpoint</code> which I do not fully comprehend yet)</p>",
        "id": 527777088,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1752011467
    },
    {
        "content": "<p>The solution was as simple as <code>set_option maxHeartbeats 400000</code> :)</p>",
        "id": 527779181,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1752012871
    }
]