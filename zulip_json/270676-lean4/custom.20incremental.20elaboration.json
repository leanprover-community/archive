[
    {
        "content": "<p>I have some alternative syntax with alternative tactics, in the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">my_tactics</span>\n<span class=\"w\">    </span><span class=\"n\">my_tac1</span>\n<span class=\"w\">    </span><span class=\"n\">my_tac2</span>\n<span class=\"w\">    </span><span class=\"n\">my_tac3</span>\n</code></pre></div>\n<p>And I would like to be able to use incremental elaboration on this, just like how a normal lean tactic sequence has. Can someone give a minimal example of how to do this? I know Verso does this kind of thing, but for the whole file instead of a tactic sequence.</p>\n<p>(<span class=\"user-mention\" data-user-id=\"133339\">@Mirek Olšák</span> was also curious about this)</p>",
        "id": 507054291,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742497342
    },
    {
        "content": "<p>I experimentally checked that <code>incremental</code> tag together with <code>evalTacticSeq</code> evaluates the tactics one by one but it doesn't save the intermediate state, as other scoped tactics do. So when I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"c1\">-- testing tactic, maybe lean calls it somehow</span>\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"echo \"</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"c1\">-- my_tactics scope</span>\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">my_tactics</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"my_tactics\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">tacticSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">my_tactics</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">myScopeElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">my_tactics</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tactics</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">evalTacticSeq</span><span class=\"w\"> </span><span class=\"n\">tactics</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">my_tactics</span>\n<span class=\"w\">    </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span>\n<span class=\"w\">    </span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">1000</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"world\"</span>\n<span class=\"w\">    </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>and change the last <code>world</code>, the entire sequence gets executed again. (but it doesn't in e.g. dotted scope)</p>",
        "id": 507057166,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742498295
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">my_tactics</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myScopeElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">withNarrowedArgTacticReuse</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">evalTacticSeq</span>\n</code></pre></div>\n<p>Not sure about the progress bar right now. Unfortunately all of this is quite finnicky, which is also why there are no simple docs for it.</p>",
        "id": 507229027,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1742549374
    },
    {
        "content": "<p>Thanks, however, as I was looking into it, I am still somewhat confused. We would like to do this with another state, possibly with a different monad which <code>Term.withNarrowedArgTacticReuse</code> seems to support. But I couldn't figure out what is going on inside <code>evalTacticSeq</code>. By looking into the code, <code>evalTacticSeq</code> is defined to call <code>evalTactic</code> which looks at the root of the syntax, finds <code>tacticSeq</code>, and should call <code>evalTacticSeq</code> back. Where is the code that actually process the tactics one by one, which is compatible with this incrementality?</p>",
        "id": 507352339,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742585433
    },
    {
        "content": "<p>In particular, could I write something instead of</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">my_scope</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">myScopeElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Term.withNarrowedArgTacticReuse</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">tacs</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">tacs.forM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">  </span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to keep the incremental evaluation but keep control over the loop?</p>",
        "id": 507359249,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742588073
    },
    {
        "content": "<p>Ah, you want to see the really gnarly details? They are in <code>evalSepTactics</code>, good luck!</p>",
        "id": 507445516,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1742645207
    },
    {
        "content": "<p>Oh, so</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">my_tactics</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">myScopeElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">evalSepTactics</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>actually also works, right? Or is there a catch that needs the <code>Term.withNarrowedArgTacticReuse 1</code> in front of it?</p>",
        "id": 507452864,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742650859
    },
    {
        "content": "<p>thanks, I will try :-)</p>",
        "id": 507453585,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742651360
    },
    {
        "content": "<p>The snapshots are currently stored in the <code>Term.Context.tacSnap?</code>, and when I naively tried to store them in a monad on top of the stack, it didn't work. Do you think it would be possible in principle to store the snapshots above (so it can support any state), or would I have to modify the <code>Term.Context</code>?</p>",
        "id": 507487868,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742674445
    },
    {
        "content": "<p>I think have found a way to do it -- <code>initialize</code> a custom <code>Extension</code>, use it in my custom tactic evaluation, and make a local copy of <code>evalSepTactics</code>, where I replace every <code>evalTactic</code> with my custom evaluation using that Extension, like here: <a href=\"https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean\">https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean</a></p>",
        "id": 507517713,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742698363
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> , do you think it could be reasonable to make the <code>evalSepTactics</code> more general in the standard library, to allow a custom <code>evalTactic</code>? Besides the \"human-proof\" (slightly alternative proof environment we are now looking at), there can be also environments displaying the goal in a custom form, or running a custom simplification every step...</p>",
        "id": 507519599,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742699892
    },
    {
        "content": "<p>Your <code>myEvalTactic</code> doesn't actually do anything that couldn't be done in regular tactic elaborators?</p>",
        "id": 507544734,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1742719762
    },
    {
        "content": "<p>True but it is just a demo. The real use case we are looking at does indeed something substantially different from just extending the tactic syntax by a few more tactics.</p>",
        "id": 507545099,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742720132
    },
    {
        "content": "<p>I  don't see the problem with copying it out. This code is unlikely to change (i.e. break) in core, while your requirements may change further.</p>",
        "id": 507547012,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1742721839
    },
    {
        "content": "<p>I think that having a custom tactic evaluation inside <code>evalSepTactic</code> (possibly with environment extension keeping the extra state) covers all possible use cases, so I don't really see how our requirements could change further. But sure, let us first try with a copy to check whether this extended <code>evalSepTactic</code> can be indeed used for what we want, and we will get back to you later.</p>",
        "id": 507548275,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742722864
    },
    {
        "content": "<p>I implemented the \"real\" thing with custom incremental elaboration -- our specific <a href=\"https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/BoxIncremental.lean\">proof environment</a>. I just wanted to say that it indeed didn't require anything more than a custom environment extension, and a custom command to evaluate a tactic inside the sequence (instead of the default `evalTactic). So I think that generalizing it in the library doesn't cost much, and could benefit more users in the future, who would like a custom proof environment. Having a custom script to run a line in the block is quite powerful for a tactic-writer. The only missing part (which we didn't need but some could find it helpful) would be detecting where the scope ends.</p>\n<p>I would be also curious if there is a better way of writing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">Term.withNarrowedArgTacticReuse</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"n\">Term.withNarrowedArgTacticReuse</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">      </span><span class=\"n\">Term.withNarrowedArgTacticReuse</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">customEvalSepTactics</span><span class=\"w\"> </span><span class=\"n\">myEvaluationOfOneTacticStep</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n</code></pre></div>\n<p>but when it works, it works, I guess :-).</p>\n<p>Should we make the PR for <code>customEvalSepTactics</code>?</p>",
        "id": 507886046,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1742854675
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/7702\">lean#7702</a></p>",
        "id": 508593919,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743100753
    }
]