[
    {
        "content": "<p>I'm having a hard time getting a mwe, but it seems as though the new compiler doesn't properly respect the <code>always_inline</code> attribute. For a particular function, I get the following compiled output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">saveBase</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IsComputable</span><span class=\"bp\">._</span><span class=\"n\">example</span><span class=\"bp\">._</span><span class=\"n\">nativeDecide_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instDecidableTrue</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">instInv</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instComputableOfNat1</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">IsComputable</span><span class=\"bp\">._</span><span class=\"n\">example</span><span class=\"bp\">._</span><span class=\"n\">nativeDecide_1</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">one</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instComputableOfNatAtLeastTwo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">◾;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instComputableInv</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">instDecidableLT</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">13</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">16</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">16</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">18</span>\n</code></pre></div>\n<p>Here <code>@instDecidableLT</code> is appearing in the output even though I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instDecidableLT</span><span class=\"w\"> </span><span class=\"bp\">....</span>\n</code></pre></div>\n<p>earlier in the file.</p>",
        "id": 527216196,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1751649887
    },
    {
        "content": "<p>This cropped up because I'm getting the result to be noncomputable, but it will become computable when it realizes that certain arguments can be dropped; but it's not dropping those arguments because it's not inlining enough.</p>\n<p>Alternately, it's not switching to the <code>_redArg</code> versions of functions as much as it could be, which would also work of course.</p>",
        "id": 527216339,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1751649946
    },
    {
        "content": "<p>Do you have a non-minimal WE you could share? Size doesn’t really matter for something like this.</p>",
        "id": 527217866,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751651026
    },
    {
        "content": "<p>Alright, here's a somewhat minimized version. (It was from a larger project.) <br>\n<a href=\"/user_uploads/3121/pz0cULZH5fhQnnd0Lt9nLnZp/not_really_mwe.lean\">not_really_mwe.lean</a></p>",
        "id": 527308802,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1751755808
    },
    {
        "content": "<p>Thanks! I think I understand why this is happening now. The compiler has two basic phases: base and mono. In the new compiler, we don't inline plain instance-producing calls (as opposed to projections from instances) in the base phase, only the mono phase. However, the <code>noncomputable</code> check occurs at the boundary between the two phases, and this unfortunate combination defeats your attempt of replacing <code>noncomputable</code> things with computable things via type classes.</p>\n<p>I guess we have 3 options here:</p>\n<ol>\n<li>Allow inlining for all instances in the base phase.</li>\n<li>Allow inlining for <code>Decidable</code> instances in the base phase (which at least seems motivated by the idea of inlining them before the <code>noncomputable</code> check).</li>\n<li>Use a simple relevance/dependency analysis for the <code>noncomputable</code> check, which would detect that <code>x</code> and <code>y</code> aren't even used by the instance and thus can't contribute to its user being <code>noncomputable</code>. There are other motivations for this idea, but your test case provides yet another good one.</li>\n</ol>\n<p>I'm curious about the impact of trying 1 or 2, so I'll probably run benchmarks to see what the fallout is (if it doesn't somehow cause some test failures), but without knowing more I think only 2 would be considered in practice. I am pretty sure 3 is coming eventually.</p>",
        "id": 527318185,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751770840
    },
    {
        "content": "<p>I thought of a way to do a mini version of 3 (using information already computed by an existing pass), implemented it, and it seems to be working. I’ll try to clean it up and land it tomorrow.</p>",
        "id": 527325160,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751780656
    },
    {
        "content": "<p>Cool, okay! I see the <code>_redArg</code> replacement happening, which I assume is for replacing functions with a reduced-argument version when some of the arguments are unused. Is that the \"already computed by an existing pass\"? Is there a reason why the instance isn't replaced by a _redArg version here?</p>",
        "id": 527353631,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1751815480
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"448405\">Alex Meiburg</span> <a href=\"#narrow/stream/270676-lean4/topic/new.20compiler.20doesn't.20.60always_inline.60/near/527353631\">said</a>:</p>\n<blockquote>\n<p>Cool, okay! I see the <code>_redArg</code> replacement happening, which I assume is for replacing functions with a reduced-argument version when some of the arguments are unused. Is that the \"already computed by an existing pass\"? Is there a reason why the instance isn't replaced by a _redArg version here?</p>\n</blockquote>\n<p>Yeah, that’s the pass I meant. The <code>._redArg</code> replacement isn’t occurring because the inlining of the rewritten plain decl with the call to the <code>._redArg</code> version occurs right after the boundary between the base and mono phases. I guess I could special-case the replacement here, although that means dealing with under/over-applied functions.</p>\n<p>The idea I had was to make the <code>reduceArity</code> pass rewrite the type of original decl to replace unused parameters with an erased type, and then have <code>toMono</code> consider arguments flowing into erased parameters to be irrelevant. If constructor mono types are also changed so that parameters are erased, then this would unify the handling of ordinary applications and constructor applications.</p>",
        "id": 527354800,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751816759
    },
    {
        "content": "<p>Neat. I can't say I followed 100% of that, but I guess I'm looking forward to hearing about it! :)</p>",
        "id": 527357698,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1751819665
    },
    {
        "content": "<p>After doing the ground work for this patch in <code>toMono</code>, I wrote the last bit for <code>reduceArity</code> as <a href=\"https://github.com/leanprover/lean4/pull/9226\">lean4#9226</a>. Unfortunately, it has an unexpected memory usage regression that I have verified locally. I'll need to debug what's going on here. We definitely want this change for other reasons, e.g. <a href=\"https://github.com/leanprover/lean4/pull/9021\">lean4#9021</a>.</p>",
        "id": 528179886,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1752195050
    },
    {
        "content": "<p>I did finally debug the issue and it revealed some issues with the approach and the interface between erased irrelevant terms and polymorphism. I was a bit nervous about changing this, and all of my attempts caused large code size regressions (due to more functions needing <code>_boxed</code> variants), so I abandoned it.</p>\n<p>I just decided to go back to the grog-brained approach of just replacing calls to decls with calls to their <code>_redArg</code> versions in <code>toMono</code>, so that the useless args are considered for the purposes of the <code>noncomputable</code> check. This should be getting merged right now in <a href=\"https://github.com/leanprover-community/mathlib4/pull/10040\">#10040</a>.</p>\n<p>Sorry about the delay! This would have been quicker if the original approach worked out.</p>",
        "id": 535599611,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1755825039
    }
]