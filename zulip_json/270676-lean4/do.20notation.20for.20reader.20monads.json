[
    {
        "content": "<p>Would it be possible to extend <code>do</code> notation to support <code>Reader</code> monads? That is, have syntax for</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">MyMonad</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">IO</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyMonad</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">withReader</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- error, `i` is not in the right do block</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>\n<p>which performs the necessary transformation to modify <code>i</code> within the reader monad then copy it back out?</p>",
        "id": 463884379,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193492
    },
    {
        "content": "<p>there is a general mechanism for supporting combinators, but it's not exposed at the user level, which means you have to modify Do.lean to do it</p>",
        "id": 463884568,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724193594
    },
    {
        "content": "<p>and in the past I have gotten a lot of pushback on making any changes to Do.lean</p>",
        "id": 463884645,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724193619
    },
    {
        "content": "<p>Having user-accessible hooks for such combinators would I think also resolve a large class of <code>Qq</code> bugs</p>",
        "id": 463884897,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193739
    },
    {
        "content": "<p>I don't think changes to <code>Do.lean</code> would be welcome at the moment, but if there were a solid RFC that proposes how to get <code>mut</code> variables to cross into combinators, that would would be a great first step.</p>\n<p>One question I have is whether a goal would be to have <code>return</code> work inside these combinators. I think it would be a necessary feature, since otherwise it would be confusing having the <code>do</code>s only partially connected, but this would be a large breaking change, with a lot of code that would need to be carefully re-reviewed.</p>",
        "id": 463885366,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193972
    },
    {
        "content": "<p>I agree that <code>return</code> and <code>let mut</code> should be handled at the same time</p>",
        "id": 463885540,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724194087
    },
    {
        "content": "<p>I wanted this before as well, but my main worry here is predictability. A user should be able to look at some code and have a reasonable chance of understanding which monadic effects reach where (without having to hover every single <code>return</code> or <code>throw</code>).</p>\n<p>Is it possible today to extend the do notation with custom per-combinator syntax in a library, e.g. for <code>withReader</code>?</p>\n<p>Or maybe there could be generic syntax that makes it clear what's happening, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"n\">withReader</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">...</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n</code></pre></div>\n<p>where <code>under ... do</code> is syntax and expects a (polymorphic enough) monad combinator.  But then one would want to generalize that to combinators taking multiple monadic actions, or some with arguments... And there is the risk that there result will be too hard to understand, and we'll lose users to perl6 for its simple syntax.</p>",
        "id": 463979647,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1724228331
    },
    {
        "content": "<p>I think my request here is not to have direct support for arbitrary combinators, but for it to be possible to extend the do syntax from outside core for particular combinators</p>",
        "id": 463979876,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724228408
    },
    {
        "content": "<p>So <code>with_reader</code> syntax rather than directly handling the <code>withReader</code> function</p>",
        "id": 463980394,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724228510
    },
    {
        "content": "<p>I have a work-in-progress extensible <code>do</code> syntax over at <a href=\"https://github.com/tydeu/imperia\">tydeu/imperia</a>, but it is not ready for prime time yet. I probably could implement a PoC of this idea (either in the <code>with_reader</code> or <code>under</code> form) there soon (e.g., in a weekend or two).</p>",
        "id": 464134770,
        "sender_full_name": "Mac Malone",
        "timestamp": 1724265367
    }
]