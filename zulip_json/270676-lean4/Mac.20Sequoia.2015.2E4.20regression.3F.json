[
    {
        "content": "<p>Over in <a href=\"#narrow/channel/187764-Lean-for-teaching/topic/Issue.20with.20.60Duper.60.20in.20.60The.20Mechanics.20of.20Proof.60\">#Lean for teaching &gt; Issue with &#96;Duper&#96; in &#96;The Mechanics of Proof&#96;</a> there is a conjecture that the following commands</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"bp\">@</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"o\">:</span><span class=\"n\">hrmacbeth</span><span class=\"bp\">/</span><span class=\"n\">math2001</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">math2001</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Math2001</span><span class=\"bp\">.</span><span class=\"n\">Homework</span><span class=\"bp\">.</span><span class=\"n\">hw9</span>\n</code></pre></div>\n<p>work fine on Mac OS Sequoia 15.3 (the file has <code>sorry</code>s in, that's the homework, but the build is error-free) but on Sequoia 15.4 (the version which I was just forcibly updated to because of my university's Ts and Cs) we get errors in the build (the gory output is in the thread and I'l post it again below). It also compiles fine on Ubuntu 24.04.</p>\n<p>tl;dr: Heather's repo is broken on the newest macs :-/</p>",
        "id": 511450449,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744300896
    },
    {
        "content": "<p>Sequoia 15.4 errors:</p>\n<blockquote>\n<p>[751/752] Building Math2001.Homework.hw9</p>\n<p>error: &gt; LEAN_PATH=./.lake/packages/std/.lake/build/lib:./.lake/packages/Qq/.lake/build/lib:./.lake/packages/aesop/.lake/build/lib:./.lake/packages/proofwidgets/.lake/build/lib:./.lake/packages/Cli/.lake/build/lib:./.lake/packages/mathlib/.lake/build/lib:./.lake/packages/Duper/.lake/build/lib:./.lake/packages/autograder/.lake/build/lib:./.lake/build/lib DYLD_LIBRARY_PATH=./.lake/packages/autograder/.lake/build/lib:./.lake/build/lib /Users/buzzard/.elan/toolchains/leanprover--lean4---v4.3.0/bin/lean -Dlinter.unusedVariables=false -DquotPrecheck=false -DwarningAsError=false -Dpp.unicode.fun=true ./././Math2001/Homework/hw9.lean -R ././. -o ./.lake/build/lib/Math2001/Homework/hw9.olean -i ./.lake/build/lib/Math2001/Homework/hw9.ilean -c ./.lake/build/ir/Math2001/Homework/hw9.c --load-dynlib=./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib</p>\n<p>error: stderr:</p>\n<p>libc++abi: terminating due to uncaught exception of type lean::exception: error loading library, dlopen(./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib, 0x0009): tried: './.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag), './.lake/build/lib/libAutograderLib-1.dylib' (no such file), './.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag), '/System/Volumes/Preboot/Cryptexes/OS./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (no such file), '/Users/buzzard/.elan/toolchains/leanprover--lean4---v4.3.0/lib/./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (no such file), '/Users/buzzard/.elan/toolchains/leanprover--lean4---v4.3.0/lib/lean/./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (no such file), '/usr/lib/./.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (no such file, not in dyld cache), './.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag), './.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag), './.lake/build/lib/libAutograderLib-1.dylib' (no such file), '/Users/buzzard/crap/math2001/.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag), '/System/Volumes/Preboot/Cryptexes/OS/Users/buzzard/crap/math2001/.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (no such file), '/Users/buzzard/crap/math2001/.lake/packages/autograder/.lake/build/lib/libAutograderLib-1.dylib' (__DATA_CONST segment missing SG_READ_ONLY flag)</p>\n<p>error: external command <code>/Users/buzzard/.elan/toolchains/leanprover--lean4---v4.3.0/bin/lean</code> exited with code 134</p>\n</blockquote>",
        "id": 511450532,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744300913
    },
    {
        "content": "<p>on arch linux, that file builds for me, but <code>lake build Math2001.«09_Sets».«02_Set_Operations»</code> fails.<br>\n<a href=\"/user_uploads/3121/f4UVKr2lbEDQCVKX5tHpPRW9/build_failure.txt\">build_failure.txt</a></p>",
        "id": 511456429,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744302581
    },
    {
        "content": "<p>I suspect that this is due to some shared libraries being updated, especially because this repo is on the old 4.3.0.</p>",
        "id": 511456919,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744302706
    },
    {
        "content": "<p>It's been a while since I last updated arch, so I'll get the latest packages and see if the error changes (or changes locations), which I suspect it might. (EDIT: same error after updating all my packages.)</p>",
        "id": 511457176,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744302771
    },
    {
        "content": "<p>Some more data points,<br>\nFor mac, I upgraded to Sequoia 15.5<br>\n<code>[err] $ lake build Math2001.Homework.hw9</code><br>\n<code>[err] $ lake build Math2001.«09_Sets».«02_Set_Operations»</code><br>\nMy debian stable box:<br>\n<code>[ ok] $ lake build Math2001.Homework.hw9</code><br>\n<code>[err] $ lake build Math2001.«09_Sets».«02_Set_Operations»</code></p>",
        "id": 511477382,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1744307559
    },
    {
        "content": "<p>On Ubuntu 24.04 <code>Math2001.Homework.hw9</code> is building for me and <code>Math2001.«09_Sets».«02_Set_Operations»</code> isn't (so same as Jireh's arch linux). On my 15.4 mac neither file builds; in the Set_Operations file I get an error building <code>Duper.Order</code>.</p>",
        "id": 511478568,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744307956
    },
    {
        "content": "<p><code>leanprover--lean4---v4.3.0</code> is pretty old...</p>",
        "id": 511481515,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744308983
    },
    {
        "content": "<p>Do we think the issue is that the C libraries changed and so (an old version of) Lean's linking is borked? I don't know enough about low-level Lean to tell if I'm spewing nonsense here.</p>",
        "id": 511483257,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744309597
    },
    {
        "content": "<p>That is my guess yes. When I would build lean itself, I often had things go haywire with compiling/linking after I upgraded the MacOS version. </p>\n<p>You might be able to pass some environment variable to lake to point it at the right thing. This is something I did in the past. But the easiest fix was to nuke the repo and clone a new one.</p>",
        "id": 511484678,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744310062
    },
    {
        "content": "<p>Not that I am saying nuking and restarting is a fix here.</p>",
        "id": 511484739,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744310088
    },
    {
        "content": "<p>It looks like this flag was new in Feb 2024 and the toolchain dates from Nov 2023. So maybe getting it up to v4.7.0 (or even v4.6.0) would be enough to take care of this issue</p>",
        "id": 511491451,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744312502
    },
    {
        "content": "<p>I can't build <code>main</code> on my machine (other errors besides this) so couldn't help with version bumping.</p>",
        "id": 511532185,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744330697
    },
    {
        "content": "<p>The design of the <code>cancel</code> tactic, which uses a bunch of <code>macro_rules</code>, hoping for one to succeed, seems incompatible with some change that occurred in v4.4.0, as the errors from failed rules are now stopping the tactic, rather than just silently proceeding to the next rule.</p>",
        "id": 511532655,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744330961
    },
    {
        "content": "<p>The <code>cancel</code> tactic is working now with v4.4.0, here's <a href=\"https://github.com/drhodes/math2001/commit/47c0bd8c7bb4438bac0bff3b4bcaa77655893dd5\">the diff</a> </p>\n<p>So, v4.4.0 builds with examples using the <code>exhaust</code> tactic commented out. Also the autograder attributes have been commented and the <code>autograder</code> and <code>duper</code> deps have been commented out in the lakefile.<br>\n<a href=\"https://github.com/drhodes/math2001/tree/v4.4.0\">https://github.com/drhodes/math2001/tree/v4.4.0</a></p>",
        "id": 511718745,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1744398903
    },
    {
        "content": "<p>duper is available for v4.16.0, and lean4-autograder-main for v4.15.0, so hopefully these shouldn't be obstacles.</p>",
        "id": 511861901,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744508446
    },
    {
        "content": "<p>Are your fixes for cancel backwards compatible with the main branch (i.e. without bumping the toolchain)? Maybe best to make those first.</p>",
        "id": 511861928,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744508477
    },
    {
        "content": "<blockquote>\n<p>Are your fixes for cancel backwards compatible with the main branch</p>\n</blockquote>\n<p>Hi, no - the issue was that some theorem names living inside the cancel macro were changed in mathlib v4.4.0, which caused the breakage. </p>\n<p>The macro uses a <code>try</code> combinator, which functions as a fallthrough trying different lemmas to close the goal, but also (a little surprising to me), from what I can tell, silently fails on the theorem name lookup and continues down to the fail case which has a more generic err message. </p>\n<p>Though, I'll see how far I can get, I'd like to get this working up to v4.16.0.</p>",
        "id": 511942546,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1744578390
    },
    {
        "content": "<p>Oh, sorry, I misunderstood, just a second,<br>\n[fails]  toolchain v4.3.0 / mathlib v4.4.0<br>\n[builds]  toolchain v4.4.0 / mathlib v4.4.0</p>",
        "id": 511946984,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1744582009
    },
    {
        "content": "<p>This error (specifically: <code>__DATA_CONST segment missing SG_READ_ONLY</code>) also occurs on latest Lean nightly: <a href=\"https://github.com/leanprover/lean4/pull/7917\">lean4#7917</a></p>",
        "id": 512069215,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1744634423
    },
    {
        "content": "<p>Getting similar issue trying to build verso <span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span></p>",
        "id": 512210150,
        "sender_full_name": "Alok Singh",
        "timestamp": 1744685018
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/channel/270676-lean4/topic/Mac.20Sequoia.2015.2E4.20regression.3F/near/512069215\">said</a>:</p>\n<blockquote>\n<p>This error (specifically: <code>__DATA_CONST segment missing SG_READ_ONLY</code>) also occurs on latest Lean nightly: <a href=\"https://github.com/leanprover/lean4/pull/7917\">lean4#7917</a></p>\n</blockquote>\n<p>I am also seeing <code>__DATA_CONST segment missing SG_READ_ONLY flag</code> when building MD4Lean.</p>",
        "id": 512310420,
        "sender_full_name": "Jeremy Lindsay",
        "timestamp": 1744721150
    },
    {
        "content": "<p>Thanks for the reports!</p>",
        "id": 512330525,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1744726035
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/6063\">lean#6063</a> has been resolved, testing using the next nightly welcome!</p>",
        "id": 513447505,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745259509
    },
    {
        "content": "<p>I was also running into <code>__DATA_CONST segment missing SG_READ_ONLY</code>, which did work itself out by updating to <code>nightly-2025-04-28</code>. However, now I'm running into problems with external symbols not being found:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">16</span><span class=\"bp\">/</span><span class=\"mi\">179</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">Egg</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Request</span><span class=\"bp\">.</span><span class=\"n\">EGraph</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">marcus</span><span class=\"bp\">/</span><span class=\"n\">Arbeit</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">egg</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">calcify</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">marcus</span><span class=\"bp\">/</span><span class=\"n\">Arbeit</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">egg</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">marcus</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4-nightly---nightly-2025-04-28/bin/lean /Users/marcus/Arbeit/lean-egg/Lean/Egg/Core/Request/EGraph.lean -R /Users/marcus/Arbeit/lean-egg/Lean -o /Users/marcus/Arbeit/lean-egg/.lake/build/lib/lean/Egg/Core/Request/EGraph.olean -i /Users/marcus/Arbeit/lean-egg/.lake/build/lib/lean/Egg/Core/Request/EGraph.ilean -c /Users/marcus/Arbeit/lean-egg/.lake/build/ir/Egg/Core/Request/EGraph.c --load-dynlib /Users/marcus/Arbeit/lean-egg/.lake/build/lib/libffi.dylib --load-dynlib /Users/marcus/Arbeit/lean-egg/.lake/build/lib/libegg_for_lean.dylib --load-dynlib /Users/marcus/Arbeit/lean-egg/.lake/build/lib/libslotted_for_lean.dylib --json</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">library</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dlopen</span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">marcus</span><span class=\"bp\">/</span><span class=\"n\">Arbeit</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">egg</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libffi</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0009</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">flat</span><span class=\"w\"> </span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"bp\">'_</span><span class=\"n\">egg_free_egraph'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">134</span>\n</code></pre></div>\n<p>This used to just work in Lean <code>v4.18.0</code> on macOS 15.3 (now I'm on 15.4). If I run <code>nm</code> on relevant files I get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"n\">libffi</span><span class=\"bp\">.</span><span class=\"n\">dylib</span>\n<span class=\"bp\">...</span>\n<span class=\"mi\">0000000000001120</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">egg_egraph_to_lean</span>\n<span class=\"w\">                 </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">egg_free_egraph</span>\n<span class=\"mi\">000000000000129</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">egraph_to_lean</span>\n\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"n\">libegg_for_lean</span><span class=\"bp\">.</span><span class=\"n\">dylib</span>\n<span class=\"bp\">...</span>\n<span class=\"mi\">0000000000056978</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">egg_free_egraph</span>\n</code></pre></div>\n<p>The <code>libegg_for_lean.dylib</code> (and the <code>egg_free_egraph</code> function) come from Rust, with <code>libffi.dylib</code> just declaring the function as <code>extern</code>.</p>\n<p>Does this look more like user error, or should this continue to just work?</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Lakefile for Reference</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"s2\">\"nomeata\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"calcify\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"master\"</span>\n\n<span class=\"c1\">-- Cf. https://github.com/lurk-lab/RustFFI.lean</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Lean\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- See https://github.com/leanprover/lean4/tree/master/src/lake#github-release-builds</span>\n<span class=\"w\">  </span><span class=\"n\">preferReleaseBuild</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">releaseRepo?</span><span class=\"w\">       </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">buildArchive?</span><span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">Egg</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This enables the interpreter to run functions marked `@[extern]`.</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">importTarget</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">afterBuildCacheAsync</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.o\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inputTextFile</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"ffi.c\"</span>\n<span class=\"w\">    </span><span class=\"n\">buildFileAfterDep</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">srcFile</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">compileO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcFile</span><span class=\"w\"> </span><span class=\"n\">flags</span>\n\n<span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">ffi</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">job</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"ss\">``importTarget</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">libFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"ffi\"</span>\n<span class=\"w\">  </span><span class=\"n\">buildStaticLib</span><span class=\"w\"> </span><span class=\"n\">libFile</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">job</span><span class=\"o\">]</span>\n\n<span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">egg_for_lean</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">afterBuildCacheAsync</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"egg_for_lean\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Egg\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"target\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"release\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"egg.trace\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildUnlessUpToDate?</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getTrace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cargo\"</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"rustc\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--release\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-C\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"relocation-model=pic\"</span><span class=\"o\">],</span>\n<span class=\"w\">        </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Egg\"</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDirAll</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeBinFile</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readBinFile</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span>\n\n<span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">slotted_for_lean</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">afterBuildCacheAsync</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"slotted_for_lean\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Slotted\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"target\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"release\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"slotted.trace\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildUnlessUpToDate?</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getTrace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">traceFile</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cargo\"</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"rustc\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--release\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-C\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"relocation-model=pic\"</span><span class=\"o\">],</span>\n<span class=\"w\">        </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Slotted\"</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDirAll</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">sharedLibDir</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeBinFile</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readBinFile</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span>\n</code></pre></div>\n</div></div>",
        "id": 514813170,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1745846607
    },
    {
        "content": "<p>It sounds like your <code>libffi.dylib</code> should be linking against <code>libegg_for_lean.dylib</code> if it uses its symbols</p>",
        "id": 514814472,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745846940
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> That is, update the <code>extern_lib ffi</code> declaration in the lakefile in some fashion?</p>",
        "id": 514821485,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1745848624
    },
    {
        "content": "<p>And do you have an idea of how this could have worked before, but now stopped working?</p>",
        "id": 514821619,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1745848663
    },
    {
        "content": "<p>Ah, it seems this is also being discussed (and fixed) in <a href=\"#narrow/stream/270676-lean4/topic/Multiple.20extern_lib\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Multiple.20extern_lib</a></p>",
        "id": 514822506,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1745848831
    }
]