[
    {
        "content": "<p>Hi. I am converting a FStar module to Lean and looking for advice on the best way of representing  it.</p>\n<p>The original module looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"FStar\"><pre><span></span><code><span class=\"k\">module</span> <span class=\"nc\">Foo</span>\n<span class=\"k\">val</span> <span class=\"n\">concrete_st</span> <span class=\"o\">:</span> <span class=\"nc\">Type0</span>\n<span class=\"k\">val</span> <span class=\"n\">app_op_t</span> <span class=\"o\">:</span> <span class=\"n\">eqtype</span>\n<span class=\"k\">type</span> <span class=\"n\">op_t</span> <span class=\"o\">=</span> <span class=\"n\">pos</span> <span class=\"o\">&amp;</span> <span class=\"o\">(</span><span class=\"n\">nat</span> <span class=\"o\">&amp;</span> <span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n<span class=\"k\">val</span> <span class=\"n\">app</span> <span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">concrete_st</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">:</span><span class=\"n\">op_t</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">concrete_st</span>\n<span class=\"k\">end</span> <span class=\"nc\">Foo</span>\n</code></pre></div>\n<p>In Lean terms <code>op_t</code> is an <code>abbrev</code> that depends on the fields of <code>Foo</code>. </p>\n<p>Something like this does not work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">mutual</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app_op_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">op_t</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n<span class=\"kn\">end</span>\n<span class=\"c1\">-- invalid mutual block: either all elements of the block must be</span>\n<span class=\"c1\">-- inductive/structure declarations, or they must all be definitions/theorems/abbrevs</span>\n</code></pre></div>\n<p>The <code>Foo</code> class will have many other fields that depend on <code>op_t</code>, so it's cumbersome to inline the definition everywhere, and using a <code>macro</code> for this seems weird.</p>\n<p>What's the best way to represent this in Lean?</p>",
        "id": 532883166,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1754388627
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app_op_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">op_t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span>\n</code></pre></div>",
        "id": 532895031,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393256
    },
    {
        "content": "<p>No, that'd make <code>op_t</code> a field with a default value</p>",
        "id": 532895199,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754393315
    },
    {
        "content": "<p>Isn't that the intent?</p>",
        "id": 532895219,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393325
    },
    {
        "content": "<p>I thought it should be fixed to <code>Nat x Nat x app_op_t</code>?</p>",
        "id": 532895267,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754393345
    },
    {
        "content": "<p>I would've done</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app_op_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">op_t</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">app'</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">op</span>\n</code></pre></div>\n<p>instead</p>",
        "id": 532895337,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754393374
    },
    {
        "content": "<p>Then you must define it for an arbitrary instance</p>",
        "id": 532895439,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393409
    },
    {
        "content": "<p>Hmm what do you mean?</p>",
        "id": 532895716,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754393497
    },
    {
        "content": "<p>Right this makes more sense<br>\n<span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Replicating.20ML-style.20modules.20with.20classes.20.2F.20structures/near/532895337\">said</a>:</p>\n<blockquote>\n<p>I would've done</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app_op_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">op_t</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">app'</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">op</span>\n</code></pre></div>\n<p>instead</p>\n</blockquote>",
        "id": 532895735,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393503
    },
    {
        "content": "<p>The original example makes no sense to me because it looks like the you want to either have a default value for the type <code>op_t</code> or impose a constraint that <code>op_t  = Nat x (Nat x app_op_t)</code></p>",
        "id": 532895952,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393572
    },
    {
        "content": "<p>Otherwise, saying <code>Foo.&lt;field&gt; = &lt;val&gt;</code> makes no sense because a field belongs to an instance of the class</p>",
        "id": 532896108,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754393624
    },
    {
        "content": "<p>A variant that is close to the original code is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">FooBase</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">concrete_st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">app_op_t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">FooBase</span><span class=\"bp\">.</span><span class=\"n\">op_t</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FooBase</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">app_op_t</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">FooBase</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">FooBase</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">op_t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">concrete_st</span>\n</code></pre></div>\n<p>Of course this whole module style is not very prevalent in Lean but I am always interested to hear how it works out and if there are any remaining elaboration issues with it</p>",
        "id": 532896855,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754393896
    },
    {
        "content": "<p>That's very helpful. Thank you, everyone!</p>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>'s suggestion is the closest to what I intended. I'll try it out and see how far it gets me.</p>",
        "id": 532898415,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1754394465
    },
    {
        "content": "<p>Glad to hear it. <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>  : To describe my issue more succinctly, I think we don't have a concept of associated types like rust do we?</p>",
        "id": 532903042,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1754395901
    }
]