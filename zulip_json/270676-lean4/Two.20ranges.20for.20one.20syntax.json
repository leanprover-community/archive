[
    {
        "content": "<p>I am trying to match the string input for a Lean command, to the pretty-printed version of the same command.</p>",
        "id": 505536620,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904453
    },
    {
        "content": "<p>If I traverse the syntax tree of the command, each node will give me precise range information of where I can retrieve in the input string the \"source\" of each node.</p>",
        "id": 505536637,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904464
    },
    {
        "content": "<p>Something similar should happen also from the pretty-printed version of the same syntax tree.  Is there some easy way to access it?</p>",
        "id": 505536657,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904471
    },
    {
        "content": "<p>Here is an example.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"format_me \"</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">ppCategory</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">alternateString</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"bp\">.</span><span class=\"n\">pretty</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"The command looks like this:</span><span class=\"se\">\\n</span><span class=\"s2\">---</span><span class=\"se\">\\n</span><span class=\"s2\">{alternateString}</span><span class=\"se\">\\n</span><span class=\"s2\">---\"</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: The command looks like this:</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">example : True :=</span>\n<span class=\"sd\">  trivial</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">format_me</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"w\">  </span><span class=\"c1\">-- `cmd` carries information about this line</span>\n</code></pre></div>",
        "id": 505536668,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904476
    },
    {
        "content": "<p>Is there some way to assign ranges in <code>alternateString</code> from nodes of <code>cmd</code>?</p>",
        "id": 505536673,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904478
    },
    {
        "content": "<p>I don't see anything here that would tie down the source.<br>\nHere's the raw format:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">group</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">group</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">nest</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\"example\"</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">nest</span>\n<span class=\"w\">            </span><span class=\"mi\">2</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\" :\"</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">line</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">group</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">nest</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"mi\">519</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\"True\"</span><span class=\"o\">)))</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">FlattenBehavior</span><span class=\"bp\">.</span><span class=\"n\">fill</span><span class=\"o\">)))))</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\" :=\"</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">append</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">group</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">nest</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"mi\">527</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"s2\">\"trivial\"</span><span class=\"o\">)))</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">FlattenBehavior</span><span class=\"bp\">.</span><span class=\"n\">fill</span><span class=\"o\">)))))))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">FlattenBehavior</span><span class=\"bp\">.</span><span class=\"n\">fill</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">FlattenBehavior</span><span class=\"bp\">.</span><span class=\"n\">fill</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 505537528,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741904890
    },
    {
        "content": "<p>I agree that the <code>Format</code> does not carry position information, but <em>something</em> has converted the syntax into a format and eventually into a string, so I am wondering if it is possible to establish a correspondence <em>somehow</em>.</p>",
        "id": 505537650,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741904978
    },
    {
        "content": "<p>Btw, I do not insist on going through a <code>Format</code>, I am happy with getting any kind of reasonably formatted string out of the syntax, as long as there is a way to match parts of the user input string with parts of the \"formatted\" string.</p>",
        "id": 505538329,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741905306
    },
    {
        "content": "<p>However, it is essential that whitespace is (largely) accounted for, since this is precisely for the linter that tells you how to format code following the guidelines.</p>",
        "id": 505538502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741905378
    },
    {
        "content": "<p>So, you want to index into the formatted string using the syntax object?</p>",
        "id": 505540046,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741906059
    },
    {
        "content": "<p>That would be the most convenient.  Right now, any principled way of going from the original string to the formatted one is probably useful.</p>",
        "id": 505541438,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741906730
    },
    {
        "content": "<p>What the linter currently does is to replace line breaks and all the following spaces with a single space on the formatted text and tries its best at matching this string with the user input.</p>",
        "id": 505541531,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741906780
    },
    {
        "content": "<p>Where they differ, it (usually) flags an issue.</p>",
        "id": 505541577,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741906802
    },
    {
        "content": "<p>This is very flimsy though and it breaks often.</p>",
        "id": 505541757,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741906839
    },
    {
        "content": "<p>Although it works surprisingly well for the part of the declarations that contains the variables, which is where the scope of the linter is currently limited.</p>",
        "id": 505541844,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741906874
    },
    {
        "content": "<p>You could \"inject\" a special character into the formatted string, and then index that character.</p>",
        "id": 505543295,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741907548
    }
]