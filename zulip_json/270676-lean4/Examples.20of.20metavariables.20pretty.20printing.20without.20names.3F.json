[
    {
        "content": "<p>I'm wondering if anyone's recently run into the issue of a metavariable like <code>?a</code> pretty printing later as <code>?m.123 x y z</code>. If you know what I'm talking about and can make a mwe, that would be helpful!</p>\n<p>I run into this occasionally, but I've been having a hard time reproducing it.</p>",
        "id": 524603073,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750197511
    },
    {
        "content": "<p>Does this mean the mvar somehow lost its user name?</p>",
        "id": 524948700,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750367533
    },
    {
        "content": "<p>I previously had a problem like this, where there are some goals produced by an <code>apply</code>.  e.g. <code>?a ?b ?c</code>. These are not synthetic opaque.</p>\n<p>Later on another tactic comes in and say acts on <code>?a</code>, then the solution of <code>?a</code> affects <code>?b</code> and assigns <code>?b := ?x</code>. If <code>?b</code> occurs in <code>?c</code> it might show up as <code>?x</code> instead.</p>\n<p>I'm not sure if this is the behaviour you're referring to. I had to suppress it by setting the generated mvars to <code>.syntheticOpaque</code>.</p>",
        "id": 524948864,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750367633
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/issues/5279\">https://github.com/leanprover/lean4/issues/5279</a></p>",
        "id": 524948907,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750367664
    },
    {
        "content": "<p>like this?<br>\n<a href=\"/user_uploads/3121/2iB4y_S4AZAQKntzNhFCn-K7/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/2iB4y_S4AZAQKntzNhFCn-K7/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"960x1040\" src=\"/user_uploads/thumbnail/3121/2iB4y_S4AZAQKntzNhFCn-K7/image.png/840x560.webp\"></a></div>",
        "id": 524948985,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750367708
    },
    {
        "content": "<p>I think that one is different <span class=\"user-mention\" data-user-id=\"599027\">@Leni Aniva</span>.</p>\n<p>The issue I'm talking about involves only synthetic opaque metavariables, and I believe it's from chains of them being created (via revert or others).</p>",
        "id": 524949029,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750367738
    },
    {
        "content": "<p>I believe that is also different <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>, since the type of the <code>?_</code> isn't a synthetic opaque metavariable, so it gets reverted differently.</p>",
        "id": 524949138,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750367834
    },
    {
        "content": "<p>Could this be related to delay assigned mvars?</p>",
        "id": 524949176,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750367865
    },
    {
        "content": "<p>Yes, pretty printing delayed assignment metavariables is the motivation for my question.</p>",
        "id": 524949231,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750367899
    },
    {
        "content": "<p>you could probably create these mvars using intro and revert where the descendant mvar has a smaller or larger context than the parent</p>",
        "id": 524949434,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1750368036
    },
    {
        "content": "<p>Speaking of pretty printing delay assigned metavariables, here's an example that came up yesterday:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">p_imp_p_true</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">show_term</span><span class=\"w\"> </span><span class=\"c1\">-- Try this: refine fun h =&gt; ?_</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">constructor</span>\n</code></pre></div>\n<p>Whereas you'd want this to say <code>refine fun h =&gt; ⟨?_, ?_⟩</code></p>",
        "id": 524953650,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750371418
    },
    {
        "content": "<p>Yes, I have that noted (I was on that thread). I'm looking for something specific here, and that's a different issue.</p>",
        "id": 524953732,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750371497
    },
    {
        "content": "<p>Note that if I click on the <code>?_</code> in <code>refine fun h =&gt; ?_</code>, it expands to <code>?_ h : p ∧ True</code>. So the <code>?_</code> magically became <code>?_ h</code></p>",
        "id": 524953894,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750371665
    },
    {
        "content": "<p>Yes, that's a feature I implemented so that you don't have to see the fvars in delayed assignments.</p>",
        "id": 524953924,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750371699
    },
    {
        "content": "<p>You can turn it off with <code>pp.mvars.delayed true</code> I think. (That means \"pretty print the delayed assignment metavariable itself.\")</p>",
        "id": 524953936,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750371708
    },
    {
        "content": "<p>Then, like this?<br>\n<a href=\"/user_uploads/3121/FNdxahv4W_7Aaye8B10LaUjz/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/FNdxahv4W_7Aaye8B10LaUjz/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1920x1040\" src=\"/user_uploads/thumbnail/3121/FNdxahv4W_7Aaye8B10LaUjz/image.png/840x560.webp\"></a></div>",
        "id": 524954649,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750372377
    },
    {
        "content": "<p>Ah, yes, that works.</p>\n<p>Here's a minimized version of what I'm guessing the principle is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"postpone% \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">tryPostpone</span>\n<span class=\"w\">  </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">postpone</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> second goal:</span>\n<span class=\"cm\">  f : Nat → Nat := fun x ↦ ?m.439</span>\n<span class=\"cm\">  ⊢ True</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 524955043,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750372824
    },
    {
        "content": "<p>I can't look into it right now, but I think <code>?m.439</code> is a synthetic opaque that's been assigned to be an application of a delayed assignment for <code>?a</code>. The pretty printer isn't following this sort of chain.</p>",
        "id": 524955251,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750373039
    }
]