[
    {
        "content": "<p>I have a custom class <code>IndexType I</code>that extends <code>Fintype I</code> which provides faster functions to iterate over elements. I'm now profiling my program and I can clearly see that <code>Multiset.product</code> slows down my program. </p>\n<p>I want to use <code>Fintype</code> only for specification, any tips how can I make sure that I do not accidentally run any of the <code>Fintype</code> code? And that Lean does not even attempt to construct the <code>Fintype</code> instances at runtime?</p>",
        "id": 509317080,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461199
    },
    {
        "content": "<p>Why are you <code>extend</code>ing <code>Fintype</code> if you don't want to use <code>Fintype</code>?</p>",
        "id": 509317315,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743461302
    },
    {
        "content": "<p>For examples one way to deal with this would be:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fintype</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span>\n\n<span class=\"kn\">noncomputable</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">.</span><span class=\"n\">fintype</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n</code></pre></div>\n<p>but this would create bunch of instance diamonds</p>",
        "id": 509317337,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461310
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317080\">said</a>:</p>\n<blockquote>\n<p>I have a custom class <code>IndexType I</code>that extends <code>Fintype I</code> which provides faster functions to iterate over elements. I'm now profiling my program and I can clearly see that <code>Multiset.product</code> slows down my program. </p>\n<p>I want to use <code>Fintype</code> only for specification, any tips how can I make sure that I do not accidentally run any of the <code>Fintype</code> code? And that Lean does not even attempt to construct the <code>Fintype</code> instances at runtime?</p>\n</blockquote>\n<p>You'll probably have to provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> because I have no idea how that could happen.</p>",
        "id": 509317500,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743461367
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317315\">said</a>:</p>\n<blockquote>\n<p>Why are you <code>extend</code>ing <code>Fintype</code> if you don't want to use <code>Fintype</code>?</p>\n</blockquote>\n<p>As I said, for specification. I often work with <code>I ‚Üí X</code> and I need that an instance of <code>NormedAddCommGroup (I ‚Üí X)</code> which requires <code>I</code> to by <code>Fintype</code>.</p>",
        "id": 509317554,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461388
    },
    {
        "content": "<p>What's the concrete implementation of <code>IndexType</code>? Is it some bijection with <code>Fin n</code> or something?</p>\n<p>Maybe a solution is to have <code>IndexType</code> have a <code>Finite</code> instance and have the theory be about <code>Finite</code> rather than <code>Fintype</code></p>",
        "id": 509317556,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743461391
    },
    {
        "content": "<p>Could you write a  more-performant <code>NormedAddCommGroup (I -&gt; X)</code> if there's an <code>IndexedType I</code> instance?</p>",
        "id": 509317766,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743461462
    },
    {
        "content": "<p>It looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Size'</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">fromIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">I</span>\n\n<span class=\"w\">  </span><span class=\"n\">toFin</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">fromFin</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">I</span>\n\n<span class=\"w\">  </span><span class=\"n\">toFin_eq_toIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">toFin</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">fromIdx_eq_fromFin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">fromIdx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fromFin</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">toFin</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">left_inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LeftInverse</span><span class=\"w\"> </span><span class=\"n\">fromFin</span><span class=\"w\"> </span><span class=\"n\">toFin</span>\n<span class=\"w\">  </span><span class=\"n\">right_inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RightInverse</span><span class=\"w\"> </span><span class=\"n\">fromFin</span><span class=\"w\"> </span><span class=\"n\">toFin</span>\n</code></pre></div>",
        "id": 509317780,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461467
    },
    {
        "content": "<p>Can you show the code that is being slowed by <code>Multiset.product</code>?</p>",
        "id": 509317966,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743461544
    },
    {
        "content": "<p>I'm pretty sure that my code is not really using any of the data of <code>Fintype</code> right now. However, when profiling my code I can clearly see <code>Multiset.product</code> to take significant amount of type.</p>",
        "id": 509318021,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461570
    },
    {
        "content": "<p>Can you point at least to a file in a project on github that demonstrates this?</p>",
        "id": 509318079,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743461595
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317966\">said</a>:</p>\n<blockquote>\n<p>Can you show the code that is being slowed by <code>Multiset.product</code>?</p>\n</blockquote>\n<p>This is the particular code, but there are layers of abstraction so I'm not sure if it makes sense</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unpackQ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">logdiag</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[((</span><span class=\"n\">d</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚äû</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">       </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">logdiag</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">])</span>\n<span class=\"w\">       </span><span class=\"k\">else</span>\n<span class=\"w\">         </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">d</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">toUSize</span><span class=\"bp\">*</span><span class=\"n\">j</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">         </span><span class=\"o\">(</span><span class=\"n\">lt</span><span class=\"o\">[</span><span class=\"n\">idx</span><span class=\"o\">])</span>\n</code></pre></div>",
        "id": 509318244,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461669
    },
    {
        "content": "<p>Can you share the profile data?</p>",
        "id": 509318294,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743461702
    },
    {
        "content": "<p>I would assume if you're seeing <code>Multiset.product</code>, then you have a sum over a product type somewhere</p>",
        "id": 509318337,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743461722
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317337\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fintype</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>How about</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- compute lazily</span>\n<span class=\"w\">  </span><span class=\"n\">fintype</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thunk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and then call <code>letI := fintype</code> when you need it</p>",
        "id": 509318415,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743461762
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509318415\">said</a>:</p>\n<blockquote>\n<p>and then call <code>letI := fintype</code> when you need it</p>\n</blockquote>\n<p>How would that work? I mainly need an instance of <code>Fintype</code> to state differentiation rules. So the theorem statements would contain <code>letI := fintype</code>?</p>",
        "id": 509318742,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743461890
    },
    {
        "content": "<p>Here is a screenshot from <code>hotspot</code><br>\n<a href=\"/user_uploads/3121/NR07WTYYmsoz40crYDKTZQJ2/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/NR07WTYYmsoz40crYDKTZQJ2/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"850x428\" src=\"/user_uploads/thumbnail/3121/NR07WTYYmsoz40crYDKTZQJ2/image.png/840x560.webp\"></a></div><p>The <code>perf.data</code> has over 100MB</p>",
        "id": 509319091,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743462038
    },
    {
        "content": "<p>Are you able to upload it to the firefox web profiler and share the URL?</p>",
        "id": 509319344,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462146
    },
    {
        "content": "<p>From that screenshot, probably we need the code of <code>instProdHMulNat</code></p>",
        "id": 509319411,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462179
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509318742\">said</a>:</p>\n<blockquote>\n<p>How would that work? I mainly need an instance of <code>Fintype</code> to state differentiation rules. So the theorem statements would contain <code>letI := fintype</code>?</p>\n</blockquote>\n<p>Maybe even</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">.</span><span class=\"n\">fintype</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>would be ok</p>",
        "id": 509319505,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509319411\">said</a>:</p>\n<blockquote>\n<p>From that screenshot, probably we need the code of <code>instProdHMulNat</code></p>\n</blockquote>\n<p>The instance is defined here: <a href=\"https://github.com/lecopivo/SciLean/blob/293f29a17c15fe0623348b78d0a0181c25f18d78/SciLean/Data/IndexType/Basic.lean#L125\">https://github.com/lecopivo/SciLean/blob/293f29a17c15fe0623348b78d0a0181c25f18d78/SciLean/Data/IndexType/Basic.lean#L125</a></p>",
        "id": 509319587,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743462253
    },
    {
        "content": "<p>I think the <code>Thunk</code> approach will work</p>",
        "id": 509319628,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462280
    },
    {
        "content": "<p>Another option might be marking some stuff inline</p>",
        "id": 509319701,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462317
    },
    {
        "content": "<p>If lean is able to inline the <code>IndexType</code> structure, then it will see the <code>fintype</code> piece is not needed and throw it away</p>",
        "id": 509319725,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462332
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317556\">said</a>:</p>\n<blockquote>\n<p>What's the concrete implementation of <code>IndexType</code>? Is it some bijection with <code>Fin n</code> or something?</p>\n<p>Maybe a solution is to have <code>IndexType</code> have a <code>Finite</code> instance and have the theory be about <code>Finite</code> rather than <code>Fintype</code></p>\n</blockquote>\n<p>Ohh I didn't know about <code>FInite</code>. I will look into it, it might be enough for my usecases and I can ditch  <code>Fintype</code>.</p>",
        "id": 509319733,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743462333
    },
    {
        "content": "<p>Can you share the source for the other entries in the stack, above <code>instProdHMulNat</code>?</p>",
        "id": 509319844,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743462371
    },
    {
        "content": "<p>Here is the whole file I'm running and the offending function <a href=\"https://github.com/lecopivo/SciLean/blob/87d632d2179cf467c8d6e9d6bd570c850875f606/examples/Profile/GMM.lean#L19\"><code>unpacQ</code></a></p>",
        "id": 509320476,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743462690
    },
    {
        "content": "<p>But It is likely hard to understand what is exactly going on if you are not familiar with SciLean</p>",
        "id": 509320590,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743462730
    },
    {
        "content": "<p>Does putting <code>@[specialize]</code> on <code>unpackQ</code> help? Either way, does the stack change?</p>",
        "id": 509321202,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463029
    },
    {
        "content": "<p>You can <em>maybe</em> diagnose this without profiling; your goal is to find a combination of attributes such that <code>set_option trace.compiler.output</code> does not mention exactly <code>instProdHMulNat</code></p>",
        "id": 509321334,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463098
    },
    {
        "content": "<p>What is <code>specialize</code> doing exactly?</p>",
        "id": 509321387,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463137
    },
    {
        "content": "<p>I believe it tells lean to emit a new copy of the program for every <code>d</code></p>",
        "id": 509321412,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509320590\">said</a>:</p>\n<blockquote>\n<p>But It is likely hard to understand what is exactly going on if you are not familiar with SciLean</p>\n</blockquote>\n<p>Can you point out which line specifically is using the <code>IndexType</code> instance?</p>",
        "id": 509321551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463218
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321412\">said</a>:</p>\n<blockquote>\n<p>I believe it tells lean to emit a new copy of the program for every <code>d</code></p>\n</blockquote>\n<p>Yeah that is what I thought but it is unclear to me what <code>?</code> should be in \"for every ?\"</p>",
        "id": 509321564,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463231
    },
    {
        "content": "<p>Probably the <code>specialize</code> / <code>inline</code> belongs on whatever the <code>lt[idx]</code> compiles to</p>",
        "id": 509321661,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321551\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509320590\">said</a>:</p>\n<blockquote>\n<p>But It is likely hard to understand what is exactly going on if you are not familiar with SciLean</p>\n</blockquote>\n<p>Can you point out which line specifically is using the <code>IndexType</code> instance?</p>\n</blockquote>\n<p>This is a lambda style notation for creating matrices and should unfold into two for loops</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚äû</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n</code></pre></div>\n<p>That should be the place which uses <code>IndexType (Idx d √ó Idx d)</code></p>",
        "id": 509321866,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463402
    },
    {
        "content": "<p>But even <code>Float^[d,d]</code> uses <code>IndexType (Idx d √ó Idx d)</code> in its definition</p>",
        "id": 509321921,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463433
    },
    {
        "content": "<p>One generally applicable pattern here would be to split <code>IndexType</code> into an <code>IndexTypeBase</code> class, and use that in the implementation and <code>IndexType</code> in the theorems</p>",
        "id": 509322202,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463580
    },
    {
        "content": "<p>(a bit like <code>Monad</code> and <code>LawfulMonad</code>)</p>",
        "id": 509322224,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463590
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321866\">said</a>:</p>\n<blockquote>\n<p>This is a lambda style notation for creating matrices and should unfold into two for loops</p>\n</blockquote>\n<p>Can you point to the code that does this? It's been really difficult navigating SciLean since there's no docs</p>",
        "id": 509322437,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743463711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509322202\">said</a>:</p>\n<blockquote>\n<p>One generally applicable pattern here would be to split <code>IndexType</code> into an <code>IndexTypeBase</code> class, and use that in the implementation and <code>IndexType</code> in the theorems</p>\n</blockquote>\n<p>Yeah, that would work and I might have to do it. But I'm getting a bit tired of this pattern as sometimes the laundry list of all class instances is getting ridiculous.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>recent_example</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>This is a recent (unrelated) theorem I had to write :/</p>\n<div class=\"codehilite\"><pre><span></span><code>@[data_synth]\ntheorem SciLean.tmul.arg_yx.HasVecFwdFDeriv_comp_rule\n    {YZ} [NormedAddCommGroup YZ] [AdjointSpace ùïú YZ] [TensorProductType ùïú Y Z YZ]\n    {WZ} [NormedAddCommGroup WZ] [AdjointSpace ùïú WZ] [TensorProductType ùïú W Z WZ]\n    {YZ_W} [NormedAddCommGroup YZ_W] [AdjointSpace ùïú YZ_W] [TensorProductType ùïú YZ W YZ_W]\n    {Y_ZW} [NormedAddCommGroup Y_ZW] [AdjointSpace ùïú Y_ZW] [TensorProductType ùïú Y ZW Y_ZW]\n    {YW_Z} [NormedAddCommGroup YW_Z] [AdjointSpace ùïú YW_Z] [TensorProductType ùïú YW Z YW_Z]\n    {Y_WZ} [NormedAddCommGroup Y_WZ] [AdjointSpace ùïú Y_WZ] [TensorProductType ùïú Y WZ Y_WZ]\n    [TensorProductGetRXY ùïú Y WZ Y_WZ] [TensorProductGetRXY ùïú W Z WZ]\n    [TensorProductGetRXY ùïú YW Z YW_Z] [TensorProductGetRXY ùïú Y W YW]\n    [TensorProductGetRXY ùïú Y ZW Y_ZW] [TensorProductGetRXY ùïú Z W ZW]\n    {f : X ‚Üí Y} {g : X ‚Üí Z} {f&#39; g&#39;}\n    (hf : HasVecFwdFDeriv ùïú W f f&#39;) (hg : HasVecFwdFDeriv ùïú W g g&#39;) :\n    HasVecFwdFDeriv ùïú W\n      (fun x =&gt; f x ‚äó g x)\n      (fun x dx =&gt;\n        let&#39; (y, dy) := f&#39; x dx;\n        let&#39; (z, dz) := g&#39; x dx;\n        (y ‚äó z,\n          let y_dz : (Y ‚äó Z) ‚äó W := tassocl (y ‚äó dz)\n          let asdf := dy ‚äó z\n          let dy_z : (Y ‚äó Z) ‚äó W := tassocl (tswapRight (tassocr (dy ‚äó z)))\n          y_dz + dy_z)) := by\n  sorry_proof\n</code></pre></div>\n</div></div>",
        "id": 509322555,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463788
    },
    {
        "content": "<p>If the <code>Thunk</code> pattern works then that's probably simplest, though it comes at the cost of carrying around a mutex with every object</p>",
        "id": 509322872,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463934
    },
    {
        "content": "<p>I'm spinning up a gitpod now to see if I can <code>inline</code> something useful</p>",
        "id": 509322905,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743463958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509322437\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321866\">said</a>:</p>\n<blockquote>\n<p>This is a lambda style notation for creating matrices and should unfold into two for loops</p>\n</blockquote>\n<p>Can you point to the code that does this? It's been really difficult navigating SciLean since there's no docs</p>\n</blockquote>\n<p>Do you mean missing <code>doc-gen4</code> generated docs? Good point, I had some issues with it long time ago and I have never fixed it. I will make it working soon!</p>",
        "id": 509322933,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743463970
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509322437\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321866\">said</a>:</p>\n<blockquote>\n<p>This is a lambda style notation for creating matrices and should unfold into two for loops</p>\n</blockquote>\n<p>Can you point to the code that does this? It's been really difficult navigating SciLean since there's no docs</p>\n</blockquote>\n<p>The key functions are <a href=\"https://github.com/lecopivo/SciLean/blob/87d632d2179cf467c8d6e9d6bd570c850875f606/SciLean/Data/DataArray/DataArray.lean#L151\"><code>DataArray.intro</code></a> which uses for loop notation which is implemented through <code>Fold</code> class which in this case is running these instances: <a href=\"https://github.com/lecopivo/SciLean/blob/87d632d2179cf467c8d6e9d6bd570c850875f606/SciLean/Data/IndexType/Fold.lean#L95\">for product</a> and <a href=\"https://github.com/lecopivo/SciLean/blob/87d632d2179cf467c8d6e9d6bd570c850875f606/SciLean/Data/IndexType/Fold.lean#L180\">for <code>Idx n</code></a></p>",
        "id": 509323472,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743464274
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509322905\">said</a>:</p>\n<blockquote>\n<p>I'm spinning up a gitpod now to see if I can <code>inline</code> something useful</p>\n</blockquote>\n<p>I'm curious if you find something, I feel I went on <code>inline</code> rampage sometime ago :) and I was putting <code>specialize</code> too for a good measure without fully understanding if it is necessary or not.</p>",
        "id": 509323720,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743464402
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509317556\">said</a>:</p>\n<blockquote>\n<p>What's the concrete implementation of <code>IndexType</code>? Is it some bijection with <code>Fin n</code> or something?</p>\n<p>Maybe a solution is to have <code>IndexType</code> have a <code>Finite</code> instance and have the theory be about <code>Finite</code> rather than <code>Fintype</code></p>\n</blockquote>\n<p>Hmm the issue is that <code>Pi.normedCommGroup</code> requires <code>Fintype</code> and if I would derive it with <code>Fintype.ofFinite</code> wouldn't I get diamonds everywhere?</p>",
        "id": 509324309,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743464696
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509321202\">said</a>:</p>\n<blockquote>\n<p>Does putting <code>@[specialize]</code> on <code>unpackQ</code> help? Either way, does the stack change?</p>\n</blockquote>\n<p>Yes this help! <code>instProdHMulNat</code> and <code>Multiset.product</code> is gone!</p>",
        "id": 509325184,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743465128
    },
    {
        "content": "<p>I think this is probably the wrong solution, since you don't want a separate C function for each <code>d</code></p>",
        "id": 509326664,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743465775
    },
    {
        "content": "<p>I would guess <code>inline</code> on <code>instProdHMulNat</code> does the job?</p>",
        "id": 509327239,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743466019
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509326664\">said</a>:</p>\n<blockquote>\n<p>I think this is probably the wrong solution, since you don't want a separate C function for each <code>d</code></p>\n</blockquote>\n<p>Probably not. Now I see a huge stack of <code>lean_apply</code> mixed with the <code>loop</code> function</p>\n<p><a href=\"/user_uploads/3121/YbNIk6hw29je7EKdrJcGz7qi/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/YbNIk6hw29je7EKdrJcGz7qi/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"801x617\" src=\"/user_uploads/thumbnail/3121/YbNIk6hw29je7EKdrJcGz7qi/image.png/840x560.webp\"></a></div>",
        "id": 509327419,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743466104
    },
    {
        "content": "<p>I think</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unpackQ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚äû</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n</code></pre></div>\n<p>is enough to debug this</p>",
        "id": 509327540,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743466191
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509327239\">said</a>:</p>\n<blockquote>\n<p>I would guess <code>inline</code> on <code>instProdHMulNat</code> does the job?</p>\n</blockquote>\n<p>I thought <code>inline</code> on instances was useless as they are always inline. Or is that true only for their projections?</p>",
        "id": 509327542,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743466193
    },
    {
        "content": "<p>Can you minimize the Scilean imports in the above?</p>",
        "id": 509327916,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743466380
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">SciLean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">DataArray</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">SciLean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unpackQ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚äû</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mf\">0.0</span>\n</code></pre></div>",
        "id": 509328078,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743466451
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509327916\">said</a>:</p>\n<blockquote>\n<p>Can you minimize the Scilean imports in the above?</p>\n</blockquote>\n<p>If you are actually running SciLean, make sure you are on <code>blas</code> branch. <code>main</code> is quite outdated right now.</p>",
        "id": 509328216,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743466525
    },
    {
        "content": "<p>I checked out the commit you linked</p>",
        "id": 509328265,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743466556
    },
    {
        "content": "<p>I think this fixes it?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fold</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">toIdx</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">d'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mkZero</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">fullRange</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">d'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d'</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sorry_proof</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">d'</span>\n</code></pre></div>",
        "id": 509330104,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467439
    },
    {
        "content": "<p>Certainly this made <code>instProdHMulNat</code> disappear from the <code>trace.compiler.ir.result</code> data</p>",
        "id": 509330311,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467556
    },
    {
        "content": "<p>Not sure as </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unpackQ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">fullRange</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">linSet</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"n\">sorry_proof</span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>shows <code>let x_5 : obj := Multiset.product._rarg x_4 x_4;</code> in <code>ir</code></p>",
        "id": 509330337,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743467571
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509330104\">said</a>:</p>\n<blockquote>\n<p>I think this fixes it?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fold</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">toIdx</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">d'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mkZero</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">fullRange</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">d'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d'</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sorry_proof</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">d'</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>What is the idea behind writing it like this? That it should specialize for every <code>toIdx</code>?</p>",
        "id": 509330550,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743467673
    },
    {
        "content": "<p>No, really we care about it specializing to every <code>f</code></p>",
        "id": 509330587,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467705
    },
    {
        "content": "<p>But we want to make sure that the <code>toIdx</code> projection is inlined first</p>",
        "id": 509330606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467717
    },
    {
        "content": "<p><code>A.linSet</code> needs a similar change</p>",
        "id": 509330761,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467792
    },
    {
        "content": "<p><del>Any function taking an <code>IndexType</code> needs to be inlined into one that passes <code>toIdx</code> directly</del></p>",
        "id": 509330802,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467814
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/.60Fintype.60.20slows.20my.20programs/near/509330761\">said</a>:</p>\n<blockquote>\n<p><code>A.linSet</code> needs a similar change</p>\n</blockquote>\n<p>Isn't <code>linSet</code> fine? but <code>DataArrayN.get</code> and <code>DataArrayN.set</code> probably should change</p>",
        "id": 509331047,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743467949
    },
    {
        "content": "<p>Maybe...</p>",
        "id": 509331077,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743467965
    },
    {
        "content": "<p>From </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DataArrayN</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArrayN</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">toIdx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DataArrayN</span><span class=\"bp\">.</span><span class=\"n\">get'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArrayN</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">toIdx</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toIdx'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">toIdx'</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>this?</p>",
        "id": 509331248,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743468055
    },
    {
        "content": "<p>I don't understand why</p>",
        "id": 509331309,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743468097
    },
    {
        "content": "<p>Did that help?</p>",
        "id": 509331324,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743468106
    },
    {
        "content": "<p>The example above doesn't even use <code>get</code>, does it?</p>",
        "id": 509331428,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743468151
    },
    {
        "content": "<p>No it does not, and <code>linSet</code> is not using <code>toIdx</code></p>",
        "id": 509331476,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743468189
    },
    {
        "content": "<p>I think there is a question here about whether CSE runs before or after extracting closures</p>",
        "id": 509331648,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743468284
    },
    {
        "content": "<p>anyway, I'll have to leave you alone with <code>trace.compiler.ir.*</code> for the rest of the day</p>",
        "id": 509331671,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743468302
    },
    {
        "content": "<p>No worries, you helped a lot, thanks!</p>",
        "id": 509331755,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743468351
    },
    {
        "content": "<p>In this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">SciLean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">DataArray</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">SciLean</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ≤</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">toUSize</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sorry_proof</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">x</span>\n\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unpackQ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">^</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">d</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">DataArray</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"o\">:=</span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Idx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">linSet</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)))</span>\n\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>adding <code>@[specialize]</code> on <code>loop</code> in <code>fold</code> makes <code>Multiset.product</code> to dis/appear in IR.</p>",
        "id": 509335427,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743470568
    },
    {
        "content": "<p>Fixed by changing the definition of <code>DataArrayN</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">DataArrayN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PlainDataType</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IndexType</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DataArray</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">  </span><span class=\"n\">h_size</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n</code></pre></div>\n<p>by replacing <code>IndexType Œπ n</code> with <code>Size' Œπ n</code> solve the problem. The class <code>Size'</code> just attaches number <code>n</code> to the type <code>Œπ</code>.</p>\n<p>I guess the take away is that TC requirements in type definition should be reduced as much as possible and anything that I don't want at runtime should not be there.</p>",
        "id": 509338634,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743472421
    },
    {
        "content": "<p>When running <code>perf</code> the function <code>unpackQ</code> is barely visible now!</p>",
        "id": 509338747,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1743472464
    }
]