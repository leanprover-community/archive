[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">Entry</span>\n  <span class=\"bp\">|</span> <span class=\"n\">str</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">int</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">Int</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">float</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">Float</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">null</span>\n\n<span class=\"kd\">constant</span> <span class=\"n\">NULL</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span> <span class=\"o\">:=</span> <span class=\"n\">Entry.null</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Coe</span> <span class=\"n\">Int</span> <span class=\"n\">Entry</span> <span class=\"n\">where</span>\n  <span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"n\">Entry.int</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Coe</span> <span class=\"n\">String</span> <span class=\"n\">Entry</span> <span class=\"n\">where</span>\n  <span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"n\">Entry.str</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Coe</span> <span class=\"n\">Float</span> <span class=\"n\">Entry</span> <span class=\"n\">where</span>\n  <span class=\"n\">coe</span> <span class=\"o\">:=</span> <span class=\"n\">Entry.float</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">OfScientific</span> <span class=\"n\">Entry</span> <span class=\"n\">where</span>\n  <span class=\"n\">ofScientific</span> <span class=\"n\">m</span> <span class=\"n\">s</span> <span class=\"n\">e</span> <span class=\"o\">:=</span> <span class=\"n\">Entry.float</span> <span class=\"o\">(</span><span class=\"n\">OfScientific.ofScientific</span> <span class=\"n\">m</span> <span class=\"n\">s</span> <span class=\"n\">e</span><span class=\"o\">)</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">Entry</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">toString'</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"k\">match</span> <span class=\"n\">e</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"n\">Entry.str</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"'{e}'\"</span>\n  <span class=\"bp\">|</span> <span class=\"n\">Entry.int</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">toString</span> <span class=\"n\">e</span>\n  <span class=\"bp\">|</span> <span class=\"n\">Entry.float</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">toString</span> <span class=\"n\">e</span>\n  <span class=\"bp\">|</span> <span class=\"n\">Entry.null</span> <span class=\"bp\">=&gt;</span> <span class=\"s2\">\"NULL\"</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">ToString</span> <span class=\"n\">Entry</span> <span class=\"n\">where</span>\n  <span class=\"n\">toString</span> <span class=\"n\">e</span> <span class=\"o\">:=</span> <span class=\"n\">e.toString'</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">Entry</span>\n\n<span class=\"n\">abbrev</span> <span class=\"n\">Row</span> <span class=\"o\">:=</span> <span class=\"n\">List</span> <span class=\"n\">Entry</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">Row</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">toStrings</span> <span class=\"o\">(</span><span class=\"n\">r</span> <span class=\"o\">:</span> <span class=\"n\">Row</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"n\">r.map</span> <span class=\"n\">Entry.toString'</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">build</span> <span class=\"o\">(</span><span class=\"n\">r</span> <span class=\"o\">:</span> <span class=\"n\">Row</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"({\"</span><span class=\"o\">,</span><span class=\"s2\">\".intercalate (r.toStrings)})\"</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">Row</span>\n\n<span class=\"kd\">structure</span> <span class=\"n\">Column</span> <span class=\"n\">where</span>\n  <span class=\"n\">name</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n  <span class=\"n\">type</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n  <span class=\"n\">deriving</span> <span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">Column</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">build</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Column</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c.name} {c.type}\"</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">Column</span>\n\n<span class=\"n\">abbrev</span> <span class=\"n\">TableScheme</span> <span class=\"o\">:=</span> <span class=\"n\">List</span> <span class=\"n\">Column</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">TableScheme</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">build</span> <span class=\"o\">(</span><span class=\"n\">ts</span> <span class=\"o\">:</span> <span class=\"n\">TableScheme</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n  <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"({\"</span><span class=\"o\">,</span><span class=\"s2\">\".intercalate (ts.map λ v =&gt; v.build)})\"</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">TableScheme</span>\n\n<span class=\"n\">abbrev</span> <span class=\"n\">Col</span> <span class=\"o\">:=</span> <span class=\"n\">Lean.Name</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">Col</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">toString</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">Lean.Name.toString</span> <span class=\"n\">c</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">Col</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">inductive</span> <span class=\"n\">ColProp</span>\n  <span class=\"bp\">|</span> <span class=\"n\">EqE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">NeqE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">LeE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">LE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">GeE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">GE</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Entry</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">EqC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">NeqC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">LeC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">LC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">GeC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">GC</span> <span class=\"o\">(</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">c'</span> <span class=\"o\">:</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">And</span> <span class=\"o\">(</span><span class=\"n\">cp</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">cp'</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"n\">Or</span> <span class=\"o\">(</span><span class=\"n\">cp</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">cp'</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span>\n\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" = \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.EqE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≠ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.NeqE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≤ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.LeE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" &lt; \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.LE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≥ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.GeE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" &gt; \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.GE</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" = \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.EqC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≠ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.NeqC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≤ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.LeC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" &lt; \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.LC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" ≥ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.GeC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\" &gt; \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.GC</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">25</span> <span class=\"s2\">\" ∧ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.And</span>\n<span class=\"kd\">infix</span><span class=\"o\">:</span><span class=\"mi\">25</span> <span class=\"s2\">\" ∨ \"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">ColProp.Or</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">ColProp</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">toString</span> <span class=\"o\">(</span><span class=\"n\">cp</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"k\">match</span> <span class=\"n\">cp</span> <span class=\"k\">with</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.EqE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}={e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.NeqE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≠{e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.LeE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≤{e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.LE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}&lt;{e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.GeE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≥{e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.GE</span> <span class=\"n\">c</span> <span class=\"n\">e</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}&gt;{e}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.EqC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}={c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.NeqC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≠{c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.LeC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≤{c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.LC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}&lt;{c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.GeC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}≥{c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.GC</span> <span class=\"n\">c</span> <span class=\"n\">c'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{c}&gt;{c'}\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.And</span> <span class=\"n\">cp</span> <span class=\"n\">cp'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"({toString cp}) and ({toString cp'})\"</span>\n<span class=\"bp\">|</span> <span class=\"n\">ColProp.Or</span> <span class=\"n\">cp</span> <span class=\"n\">cp'</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"({toString cp}) or ({toString cp'})\"</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">ToString</span> <span class=\"n\">ColProp</span> <span class=\"n\">where</span>\n  <span class=\"n\">toString</span> <span class=\"n\">cp</span> <span class=\"o\">:=</span> <span class=\"n\">cp.toString</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">ColProp</span>\n\n\n<span class=\"kd\">mutual</span>\n  <span class=\"kd\">inductive</span> <span class=\"n\">Query</span>\n    <span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"o\">(</span><span class=\"n\">name</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">steps</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">QueryStep</span><span class=\"o\">)</span>\n  <span class=\"kn\">private</span> <span class=\"kd\">inductive</span> <span class=\"n\">QueryStep</span>\n    <span class=\"bp\">|</span> <span class=\"n\">select</span> <span class=\"o\">(</span><span class=\"n\">l</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Col</span><span class=\"o\">)</span>\n    <span class=\"bp\">|</span> <span class=\"n\">filter</span> <span class=\"o\">(</span><span class=\"n\">cp</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span>\n    <span class=\"bp\">|</span> <span class=\"n\">join</span> <span class=\"o\">(</span><span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">on</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">how</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span>\n    <span class=\"n\">deriving</span> <span class=\"n\">Inhabited</span>\n<span class=\"kd\">end</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">table</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"o\">:=</span> <span class=\"o\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"o\">[]⟩</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">Query</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">name</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"bp\">→</span> <span class=\"n\">String</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"n\">name</span> <span class=\"n\">_</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">name</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">steps</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"bp\">→</span> <span class=\"n\">List</span> <span class=\"n\">QueryStep</span>\n<span class=\"bp\">|</span> <span class=\"n\">mk</span> <span class=\"n\">_</span> <span class=\"n\">steps</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">steps</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">Query</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">select</span> <span class=\"o\">(</span><span class=\"n\">l</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">Col</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"n\">q.name</span><span class=\"o\">,</span> <span class=\"n\">q.steps.concat</span> <span class=\"o\">(</span><span class=\"n\">QueryStep.select</span> <span class=\"n\">l</span><span class=\"o\">)⟩</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">filter</span> <span class=\"o\">(</span><span class=\"n\">cp</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span>  <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"n\">q.name</span><span class=\"o\">,</span> <span class=\"n\">q.steps.concat</span> <span class=\"o\">(</span><span class=\"n\">QueryStep.filter</span> <span class=\"n\">cp</span><span class=\"o\">)⟩</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">join</span> <span class=\"o\">(</span><span class=\"n\">q'</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">on</span> <span class=\"o\">:</span> <span class=\"n\">ColProp</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">how</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨</span><span class=\"n\">q.name</span><span class=\"o\">,</span> <span class=\"n\">q.steps.concat</span> <span class=\"o\">(</span><span class=\"n\">QueryStep.join</span> <span class=\"n\">q'</span> <span class=\"n\">on</span> <span class=\"n\">how</span><span class=\"o\">)⟩</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">transform</span> <span class=\"o\">(</span><span class=\"n\">q</span> <span class=\"o\">:</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"bp\">→</span> <span class=\"n\">Query</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Query</span> <span class=\"o\">:=</span> <span class=\"n\">f</span> <span class=\"n\">q</span>\n\n<span class=\"kd\">infixl</span><span class=\"o\">:</span><span class=\"mi\">50</span> <span class=\"s2\">\"↠\"</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">transform</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">structure</span> <span class=\"n\">SQL</span> <span class=\"n\">where</span>\n  <span class=\"n\">Select</span> <span class=\"o\">:</span> <span class=\"n\">List</span> <span class=\"n\">String</span>\n  <span class=\"n\">From</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n  <span class=\"n\">Where</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n  <span class=\"n\">As</span> <span class=\"o\">:</span> <span class=\"n\">String</span>\n\n<span class=\"kn\">namespace</span> <span class=\"n\">SQL</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">init</span> <span class=\"o\">(</span><span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">as</span> <span class=\"o\">:</span> <span class=\"n\">String</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">SQL</span> <span class=\"o\">:=</span>\n<span class=\"o\">⟨[],</span> <span class=\"n\">t</span><span class=\"o\">,</span> <span class=\"s2\">\"true\"</span><span class=\"o\">,</span> <span class=\"n\">as</span><span class=\"o\">⟩</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">toString</span> <span class=\"o\">(</span><span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">SQL</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span>\n<span class=\"k\">let</span> <span class=\"n\">select</span> <span class=\"o\">:=</span> <span class=\"k\">if</span> <span class=\"n\">b.Select</span> <span class=\"bp\">=</span> <span class=\"o\">[]</span> <span class=\"k\">then</span> <span class=\"s2\">\"*\"</span> <span class=\"k\">else</span> <span class=\"s2\">\",\"</span><span class=\"bp\">.</span><span class=\"n\">intercalate</span> <span class=\"n\">b.Select</span>\n<span class=\"k\">if</span> <span class=\"n\">b.As</span> <span class=\"bp\">=</span> <span class=\"s2\">\"\"</span> <span class=\"k\">then</span>\n  <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"select {select} from {b.From} where {b.Where}\"</span>\n<span class=\"k\">else</span>\n  <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"(select {select} from {b.From} where {b.Where}) as {b.As}\"</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">SQL</span>\n\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">applyStep</span> <span class=\"o\">(</span><span class=\"n\">sql</span> <span class=\"o\">:</span> <span class=\"n\">SQL</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">step</span> <span class=\"o\">:</span> <span class=\"n\">QueryStep</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">SQL</span> <span class=\"o\">:=</span>\n<span class=\"k\">match</span> <span class=\"n\">step</span> <span class=\"k\">with</span>\n<span class=\"bp\">|</span> <span class=\"n\">QueryStep.select</span> <span class=\"n\">l</span> <span class=\"bp\">=&gt;</span>\n  <span class=\"k\">let</span> <span class=\"n\">newList</span> <span class=\"o\">:=</span> <span class=\"n\">l.map</span> <span class=\"n\">Col.toString</span>\n  <span class=\"k\">if</span> <span class=\"n\">sql.Select</span> <span class=\"bp\">=</span> <span class=\"o\">[]</span> <span class=\"k\">then</span>\n    <span class=\"o\">⟨</span><span class=\"n\">newList</span><span class=\"o\">,</span> <span class=\"n\">sql.From</span><span class=\"o\">,</span> <span class=\"n\">sql.Where</span><span class=\"o\">,</span> <span class=\"n\">sql.As</span><span class=\"o\">⟩</span>\n  <span class=\"k\">else</span>\n    <span class=\"o\">⟨</span><span class=\"n\">sql.Select.filter</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">s</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">newList.contains</span> <span class=\"n\">s</span><span class=\"o\">),</span> <span class=\"n\">sql.From</span><span class=\"o\">,</span> <span class=\"n\">sql.Where</span><span class=\"o\">,</span> <span class=\"n\">sql.As</span><span class=\"o\">⟩</span>\n<span class=\"bp\">|</span> <span class=\"n\">QueryStep.filter</span> <span class=\"n\">cp</span> <span class=\"bp\">=&gt;</span> <span class=\"o\">⟨</span><span class=\"n\">sql.Select</span><span class=\"o\">,</span> <span class=\"n\">sql.From</span><span class=\"o\">,</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{sql.Where} and ({cp})\"</span><span class=\"o\">,</span> <span class=\"n\">sql.As</span><span class=\"o\">⟩</span>\n<span class=\"bp\">|</span> <span class=\"n\">QueryStep.join</span> <span class=\"n\">q</span> <span class=\"n\">on</span> <span class=\"n\">how</span> <span class=\"bp\">=&gt;</span>\n  <span class=\"k\">let</span> <span class=\"n\">newSQL</span> <span class=\"o\">:</span> <span class=\"n\">SQL</span> <span class=\"o\">:=</span> <span class=\"n\">q.steps.foldl</span> <span class=\"n\">applyStep</span> <span class=\"o\">(</span><span class=\"n\">SQL.init</span> <span class=\"n\">q.name</span> <span class=\"n\">q.name</span><span class=\"o\">)</span>\n  <span class=\"k\">let</span> <span class=\"n\">newFrom</span> <span class=\"o\">:</span> <span class=\"n\">String</span> <span class=\"o\">:=</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{sql.From} {how} join {newSQL.toString} on {on}\"</span>\n  <span class=\"o\">⟨</span><span class=\"n\">sql.Select</span><span class=\"o\">,</span> <span class=\"n\">newFrom</span><span class=\"o\">,</span> <span class=\"n\">sql.Where</span><span class=\"o\">,</span> <span class=\"n\">sql.As</span><span class=\"o\">⟩</span>\n<span class=\"n\">termination_by</span> <span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Sorry for the long MWE! My difficulty is on the definition of the last function: <code>applyStep</code>. The problem arises when I try to use <code>newFrom</code> in the output of the function. It says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span> <span class=\"n\">unknown</span> <span class=\"kd\">constant</span> <span class=\"bp\">'</span><span class=\"n\">_private.0.applyStep'</span>\n</code></pre></div>",
        "id": 263049841,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1638210908
    },
    {
        "content": "<p>I already get errors on <code>private def toString</code>, because it's noncomputable.</p>",
        "id": 263051289,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1638211623
    },
    {
        "content": "<p>How come? Here it computes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"n\">SQL.toString</span> <span class=\"o\">⟨[</span><span class=\"s2\">\"c1\"</span><span class=\"o\">,</span> <span class=\"s2\">\"c2\"</span><span class=\"o\">],</span> <span class=\"s2\">\"table1\"</span><span class=\"o\">,</span> <span class=\"s2\">\"c1&gt;1\"</span><span class=\"o\">,</span> <span class=\"s2\">\"\"</span><span class=\"o\">⟩</span>\n<span class=\"c1\">-- \"select c1,c2 from table1 where c1&gt;1\"</span>\n</code></pre></div>",
        "id": 263052086,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1638211902
    },
    {
        "content": "<p>Ah sorry, I had some other code in the same file.</p>",
        "id": 263052187,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1638211950
    },
    {
        "content": "<p>Note that declaring the function as <code>partial</code> or <code>unsafe</code> removes the error.<br>\nYou might not like this fix if you intend to also prove things about your functions</p>",
        "id": 263052441,
        "sender_full_name": "Horațiu Cheval",
        "timestamp": 1638212081
    },
    {
        "content": "<p>Totally fine at the moment. Thanks!!</p>",
        "id": 263052726,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1638212244
    },
    {
        "content": "<p>Hmm, so I thought it might be the <code>sorry</code>. But adding <code>axiom hf : False</code> and <code>termination_by False.elim hf</code> has the same issue.</p>",
        "id": 263052760,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1638212264
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 263052830,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1638212288
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"451983\">@Arthur Paulino</span> why are so many of the definitions/constants <code>private</code>?</p>",
        "id": 263053145,
        "sender_full_name": "Mac",
        "timestamp": 1638212430
    },
    {
        "content": "<p>A lot of these functions seem like they should not be (for example, the various <code>toString</code> functions).</p>",
        "id": 263053184,
        "sender_full_name": "Mac",
        "timestamp": 1638212461
    }
]