[
    {
        "content": "<p>In the code below, if I <code>Ctrl-Click</code> on <code>in</code> I get redirected to the elaborator for the command <code>in</code>.</p>\n<p>Where is the information about the ranges for such redirection?  How can I access these ranges?</p>\n<p>Thanks!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c\">/-</span><span class=\"cm\">!-/</span>\n</code></pre></div>",
        "id": 537744717,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757016701
    },
    {
        "content": "<p>It's just the range of the entire <code>in</code> syntax node, at least where it is not covered by ranges of subcommands. There is no explicit range for the token <code>in</code> itself being used.</p>",
        "id": 537750957,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757018709
    },
    {
        "content": "<p>Yes, I imagined that this is what it was, but where can I access those ranges?</p>",
        "id": 537751323,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757018824
    },
    {
        "content": "<p><code>Syntax.getRange?</code></p>",
        "id": 537751451,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757018865
    },
    {
        "content": "<p>I suspect that, when Lean parses the file, it stores somewhere this information and I would like to know where and how can I retrieve it.</p>",
        "id": 537751461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757018869
    },
    {
        "content": "<p>Ok, so then were can I retrieve the syntax for the file?</p>",
        "id": 537751502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757018885
    },
    {
        "content": "<p>I assume you know how to get the syntax of the current command? Your example does not make clear whether you need more. Only the server currently knows the syntax tree of the entire file.</p>",
        "id": 537751867,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757019012
    },
    {
        "content": "<p>What I have is a list of declaration names.  Looking at the declarationRange extension, I can retrieve the ranges for the corresponding <em>declarations</em>.  However, I would like to get the ranges for the <em>commands</em> that created those declarations.</p>",
        "id": 537752088,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757019097
    },
    {
        "content": "<p>Is there some way to obtain that?</p>",
        "id": 537752105,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757019103
    },
    {
        "content": "<p>In the example above, I can retrieve the ranges for the module doc, but I would really like to have the ranges for <code>in</code>.</p>",
        "id": 537752227,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757019148
    },
    {
        "content": "<p>That's not persisted anywhere, no</p>",
        "id": 537754083,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757019748
    },
    {
        "content": "<p>Ok, so what is the mechanism that <code>Go to definition</code> uses?</p>",
        "id": 537754326,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757019826
    },
    {
        "content": "<p>As I said, the server has that information. Other components don't.</p>",
        "id": 537755511,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757020194
    },
    {
        "content": "<p>I do not actually know what the server is, but I gather that it is not something that lean can access?</p>",
        "id": 537755806,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757020286
    },
    {
        "content": "<p>And so the process is that lean parses the file, temporarily creates the syntax of every command, passes (some of) the information to the server and then discards it?</p>",
        "id": 537756010,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757020348
    },
    {
        "content": "<p>You can kinda redo what the server does though:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fullReparse</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Module.header</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileMap</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ictx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InputContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"bp\">.</span><span class=\"n\">source</span>\n<span class=\"w\">    </span><span class=\"n\">fileName</span>\n<span class=\"w\">    </span><span class=\"n\">fileMap</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHeader</span><span class=\"w\"> </span><span class=\"n\">ictx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pmctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">    </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span>\n<span class=\"w\">    </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span>\n<span class=\"w\">    </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOpenDecls</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">messages</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"bp\">.</span><span class=\"n\">source</span><span class=\"bp\">.</span><span class=\"n\">atEnd</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newMessages</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parseCommand</span><span class=\"w\"> </span><span class=\"n\">ictx</span><span class=\"w\"> </span><span class=\"n\">pmctx</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">messages</span>\n<span class=\"w\">    </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newState</span>\n<span class=\"w\">    </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newMessages</span>\n<span class=\"w\">    </span><span class=\"n\">cmds</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">stx</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">whereAmI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">fullReparse</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">cmdRange</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">cmdRange</span><span class=\"bp\">.</span><span class=\"n\">includes</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"whereami\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whereAmI</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"no position found\"</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">whereami</span>\n</code></pre></div>\n<p>although this might not be fully accurate if there are <code>syntax</code> commands in between</p>",
        "id": 537813219,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757058834
    },
    {
        "content": "<p>Rather it will just fail on any file with notations, so please don't</p>",
        "id": 537813686,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1757059019
    },
    {
        "content": "<p>For my use-case, it is simpler to add a linter that simply emits the ranges of every command that it inspects.</p>",
        "id": 537813729,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757059037
    },
    {
        "content": "<p>I was simply hoping to be able to avoid having to rebuild each file, since at some point, the information that I want is computed.</p>",
        "id": 537813818,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757059072
    },
    {
        "content": "<p>To give some context: I am trying to write automation to remove \"old\" deprecated declarations.  For this, I can look in the environment to find</p>\n<ul>\n<li>which declarations have been deprecated in any given range of time (according to the <code>since</code> value);</li>\n<li>find the ranges of the <em>declarations</em> in their files;</li>\n<li>remove these ranges from the files.</li>\n</ul>\n<p>This process fails if there is something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"2025-02-30\"</span><span class=\"o\">)</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">alias</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>\n<p>because the <code>set_option</code> line would be left dangling (and would apply to the following command, if there is one).</p>",
        "id": 537814590,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757059339
    },
    {
        "content": "<p>If, instead, I can retrieve the <em>command</em> ranges that have generated the declarations, then I am done!</p>",
        "id": 537814724,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757059399
    },
    {
        "content": "<p>Currently, it seems that the simplest approach is to have a re-parsing step where a linter logs all the command ranges, and then use this information to remove the emitted command ranges that entirely contain the declaration ranges that I want to remove.</p>",
        "id": 537814892,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757059465
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/Ranges.20for.20Go-to-definition/near/537813686\">schrieb</a>:</p>\n<blockquote>\n<p>Rather it will just fail on any file with notations, so please don't</p>\n</blockquote>\n<p>I believe it will still work as long as you take the environment from the end of the file but there are definitely some edge cases</p>",
        "id": 537828777,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757064296
    },
    {
        "content": "<p>Would the code not complain about existing declarations, if you use the end environment?</p>",
        "id": 537829072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757064383
    },
    {
        "content": "<p>I mean it's just parsing; the parser doesn't care</p>",
        "id": 537829220,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757064431
    },
    {
        "content": "<p>Ah, ok, I thought that you were re-building all the file.</p>",
        "id": 537829368,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757064488
    },
    {
        "content": "<p>Anyway, maybe I can use the linter emitting ranges to emit more information as well and re-purpose it for more than just figuring out if there is an <code>in</code> before a declaration.</p>",
        "id": 537829630,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757064587
    },
    {
        "content": "<p>At least if feels less wasteful like this!  <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 537829713,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1757064610
    }
]