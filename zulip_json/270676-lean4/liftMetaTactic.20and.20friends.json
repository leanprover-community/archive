[
    {
        "content": "<p>The family of <code>liftMetaTactic</code> functions which lift a <code>MetaM</code> \"tactic-like\" action to <code>TacticM Unit</code> is in a bit of an unfortunate state re: naming:</p>\n<ul>\n<li><code>liftMetaTactic (tac : MVarId → MetaM (List MVarId)) : TacticM Unit</code></li>\n<li><code>liftMetaTactic1 (tac : MVarId → MetaM (Option MVarId)) : TacticM Unit</code></li>\n<li><code>liftMetaTactic' (tac : MVarId → MetaM MVarId) : TacticM Unit</code> (Mathlib)</li>\n<li><code>liftMetaFinishingTactic (tac : MVarId → MetaM Unit) : TacticM Unit</code></li>\n</ul>\n<p>(Is this the only instance of <code>1</code> being used in a name to indicate <code>Option</code>/\"1 or 0\"? <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>\n<p>Because of this, if you search for <code>liftMetaTactic</code> in Mathlib, you can see <code>liftMetaTactic</code> being used when another one of these is appropriate fairly often, yielding some extra brackets or lines in the code.</p>\n<p>Although I'd be happy with fixing the names of <code>liftMetaTactic1</code> and <code>liftMetaTactic'</code>, there is another option: change the type of <code>liftMetaTactic</code> to work in place of all of these:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToGoalList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">toGoalList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MVarId</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToGoalList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The advantage of this is that we reduce the small zoo of similarly-named functions in an already-complex API (and reap the benefits that doing so entails).</p>\n<p>The disadvantage is that now you can't read off the type of the action from the source as easily, and some actions might typecheck when you don't mean them to. (This is mitigated, I think, by the fact that <code>liftMetaTactic</code> mostly just calls some definition you're aware of the type of, but still ought to be considered.)</p>\n<p>I'm curious to hear others' opinions on what would be a nice approach here. :)</p>",
        "id": 544066236,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760056262
    },
    {
        "content": "<p>the <code>1</code> means it gives at most one goal as output, so yes to indicate <code>Option</code></p>",
        "id": 544066346,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760056340
    },
    {
        "content": "<p>The (aside) question isn't whether it indicates <code>Option</code>, but whether it's used in any other name to indicate <code>Option</code>/\"1 or 0\".</p>",
        "id": 544066398,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760056380
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.saturate1#doc\">docs#Lean.Meta.saturate1</a></p>",
        "id": 544066526,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760056463
    },
    {
        "content": "<p>I don't see anything else</p>",
        "id": 544066582,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760056503
    },
    {
        "content": "<p>And there, it seems like it indicates <code>Option (Array MVarId)</code>, and therefore means…at most 1 <code>Array MVarId</code>? <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 544066861,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760056702
    },
    {
        "content": "<p>(I suppose the idea might be that <code>1</code> is for functions of type <code>(_ -&gt; Option _) -&gt; _</code>, but I’m not sure this is a very legible convention.)</p>",
        "id": 544067117,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760056840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/liftMetaTactic.20and.20friends/near/544066861\">said</a>:</p>\n<blockquote>\n<p>And there, it seems like it indicates <code>Option (Array MVarId)</code>, and therefore means…at most 1 <code>Array MVarId</code>? <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n</blockquote>\n<p>Well <code>none</code> is for failure and <code>some [mvarid1, mvarid2, ...]</code> means success and here are your new goals</p>",
        "id": 544067440,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760057038
    },
    {
        "content": "<p>It’s definitely a good type signature (since <code>some #[]</code> means the goal is closed, and is distinct from <code>none</code>)! :) But naming-wise, if this <code>Option</code> is indeed the reason for <code>1</code> in the name, I feel like <code>saturate</code> would be sufficient (and the <code>1</code> isn’t evoking much).</p>",
        "id": 544068165,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760057489
    },
    {
        "content": "<p>It looks like the difference is actually (mostly) in the return type, going by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.saturate#doc\">docs#Lean.Meta.saturate</a>, which returns <code>MetaM (List MVarId)</code>. Therefore, I think <code>saturate?</code> might be more conventional for <code>saturate1</code>.</p>",
        "id": 544068775,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760057880
    },
    {
        "content": "<p>I worry that your typeclass proposal makes unification harder which seems likely to make do notation emit confusing type errors while you're in the process of writing the function</p>",
        "id": 544107835,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760082997
    },
    {
        "content": "<p>That's fair, though mitigated a bit by the fact that often arguments to <code>liftMetaTactic</code> are short, simple calls to declarations with types that don't need unification.</p>\n<p>(I'm actually a bit more worried about how the typeclass approach would create <em>no</em> error in the case of an unfinished <code>do</code> block that returns <code>Unit</code>, thus behaving like <code>liftMetaFinishingTactic</code> unintentionally! :) )</p>\n<p>I suppose it comes down to a tradeoff between API complexity and the complexity introduced by \"automatic\" flexibility (which renders the types less visible/readable, both in error messages and otherwise).</p>",
        "id": 544225240,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760120278
    },
    {
        "content": "<p>I would be happy if we could at least rename these functions and improve the documentation with pointers to the variants, which would be strictly better than the current state. :) (Happy to make those PRs if welcome.)</p>",
        "id": 544225274,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1760120292
    }
]