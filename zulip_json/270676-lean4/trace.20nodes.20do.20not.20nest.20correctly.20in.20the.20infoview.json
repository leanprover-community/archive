[
    {
        "content": "<p>The following code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`trace.Meta.foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{exceptEmoji e} foo\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"foo.log\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- does it nest if the name is within the current trace node?</span>\n<span class=\"w\">    </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`trace.Meta.foo.bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{exceptEmoji e} foo bar\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"foo.bar.log\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- does it nest if the name is not within the current trace node?</span>\n<span class=\"w\">    </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`trace.Meta.bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{exceptEmoji e} bar\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"bar.log\"</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"c1\">-- we can't register a new trace class in this file, so hijack an existing one</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>gives</p>\n<p><a href=\"/user_uploads/3121/A0tC_fYRiMkDicBn_kKcYyW6/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/A0tC_fYRiMkDicBn_kKcYyW6/image.png\" title=\"image.png\"><img data-original-dimensions=\"662x159\" src=\"/user_uploads/thumbnail/3121/A0tC_fYRiMkDicBn_kKcYyW6/image.png/840x560.webp\"></a></div><p>Should the <code>[bar]</code> nodes not be indented?</p>",
        "id": 487028252,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733758816
    },
    {
        "content": "<p>I would guess the cause is a missing <code>.group</code> in the formatter code?</p>",
        "id": 487030018,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733759239
    },
    {
        "content": "<p>I think this is most noticeable in the formatting of the <code>trace.Meta.synthInstance</code> output, which I was showing to a Rust user at Brown the other day, and he was confused that everything seemed to be flattened</p>",
        "id": 487030265,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733759287
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/6345\">lean4#6345</a> attempts a fix</p>",
        "id": 487032432,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733759634
    },
    {
        "content": "<p>You apparently didn't read the section because you didn't remove it <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 487121679,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1733787138
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span>, I'm afraid after multiple readings I don't understand your comment</p>",
        "id": 487154223,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733802735
    },
    {
        "content": "<p>Junyan refers to the very big \"Read this section before submitting\" in the issue description, which ends with the sentence:</p>\n<blockquote>\n<p>Remove this section, up to and including the <code>---</code> before submitting.</p>\n</blockquote>",
        "id": 487155476,
        "sender_full_name": "Christian Merten",
        "timestamp": 1733803289
    },
    {
        "content": "<p>Filed as a bug instead at <a href=\"https://github.com/leanprover/lean4/pull/6389\">lean4#6389</a>, since my patch didn't work.</p>",
        "id": 489042233,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734226312
    }
]