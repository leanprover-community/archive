[
    {
        "content": "<p>Not a mathlib free MWE, but I don't think it is needed here. <a href=\"https://github.com/leanprover/lean4/blob/21cf5881f5e0a78e75a3e68c38b677f9d2e2ea66/src/lake/Lake/Util/Family.lean#L150-L155\"><code>Lake.FamilyOut.fam_eq</code></a> is a <code>simp</code> lemma with a very permissive discrimination tree key (<code>@Eq _ _ _</code>). The file <code>Lake.Util.Family</code> is currently not imported in mathlib, but I recently transitively imported it in some meta program, which lead to some very confusing timeouts.</p>\n<p>A random example (from our favorite <code>JacobiZariski.lean</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Family</span>\n\n<span class=\"sd\">/-- info: @Eq _ _ _ -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">discr_tree_key</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">FamilyOut</span><span class=\"bp\">.</span><span class=\"n\">fam_eq</span>\n\n<span class=\"c1\">-- adding this line fixes the timeout</span>\n<span class=\"c1\">-- attribute [-simp] Lake.FamilyOut.fam_eq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">KaehlerDifferential</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">w₁</span><span class=\"w\"> </span><span class=\"n\">w₂</span><span class=\"w\"> </span><span class=\"n\">w₃</span><span class=\"w\"> </span><span class=\"n\">w₄</span><span class=\"w\"> </span><span class=\"n\">w₅</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"w\"> </span><span class=\"n\">u₃</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u₃</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w₂</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">map_comp_cotangentComplex_baseChange</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toComp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtensionHom</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">liftBaseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">∘ₗ</span>\n<span class=\"w\">      </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">cotangentComplex</span><span class=\"bp\">.</span><span class=\"n\">baseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">cotangentComplex</span><span class=\"w\"> </span><span class=\"bp\">∘ₗ</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">Cotangent</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toComp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtensionHom</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">liftBaseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map_cotangentComplex</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 568100757,
        "sender_full_name": "Christian Merten",
        "timestamp": 1768434812
    },
    {
        "content": "<p>Could the <code>simp</code> attribute on <code>Lake.FamilyOut.fam_eq</code> be scoped to the <code>Lake</code> namespace?</p>",
        "id": 568100812,
        "sender_full_name": "Christian Merten",
        "timestamp": 1768434849
    },
    {
        "content": "<p>Good catch! I've made it <code>[scoped simp]</code> in <a href=\"https://github.com/leanprover/lean4/pull/12178\">lean#12178</a></p>",
        "id": 570228715,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769484642
    }
]