[
    {
        "content": "<p>I am trying to learn a bit how expressions are handled, and I do not understand what I got wrong: in the example below, I am trying to set up a tactic that detects if there are functions in the context:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">ExtrApp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">lh</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">lh.type.isApp</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"yes\"</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"no\"</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">    </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"{xs}\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"o\">)</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"exists_app\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ExtrApp</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exists_app</span><span class=\"w\"> </span><span class=\"c1\">-- [no, no, no, no]</span>\n</code></pre></div>\n<p>If I modify the first <code>ExtrApp </code> changing <code>if lh.type.isApp then xs := \"yes\" :: xs</code> to <code>if lh.type.isForall then xs := \"yes\" :: xs</code> (so, AFAIU, asking for \"for all expressions\") I get <code>[yes, no, no, yes]</code>. I do not understand either of the outputs <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 466208157,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725009324
    },
    {
        "content": "<p><code>isApp</code> is for detecting function applications not function types themselves</p>",
        "id": 466209594,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725009725
    },
    {
        "content": "<p>A term of the form <code>f x</code> for some <code>f : X -&gt; Y</code> and some <code>x : X</code>?</p>",
        "id": 466209769,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725009792
    },
    {
        "content": "<p>yes</p>",
        "id": 466209785,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725009799
    },
    {
        "content": "<p>Have you read the constructors of Expr and their documentaiton?</p>",
        "id": 466209849,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725009819
    },
    {
        "content": "<p>Yes, I have <em>read</em> them. I wouldn't go as far as saying I <em>understood</em> them <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 466209999,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725009855
    },
    {
        "content": "<p>With which one are you having trouble then?</p>",
        "id": 466210090,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725009882
    },
    {
        "content": "<p>Well, I think I understand them when I read them (apart bvar that is a bit obscure due to this de Brujn index), but then I fail my exercices. So I have probably not understood them <em>properly</em>.</p>",
        "id": 466210557,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725010008
    },
    {
        "content": "<p>Also, I fail to understand the difference from <code>lambda</code>expressions and <code>forAll</code>.</p>",
        "id": 466210744,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725010054
    },
    {
        "content": "<p>Both are terms of some Pi type, no?</p>",
        "id": 466210833,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725010075
    },
    {
        "content": "<p>No, <code>lambda</code> is <code>fun x =&gt; ...</code> and <code>forall</code> is <code>(x : a) -&gt; b x</code></p>",
        "id": 466211745,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725010280
    },
    {
        "content": "<p>in particular forall also covers the case where the output type does not depend on the input value so <code>a -&gt; b</code> as well. So in general inferring the type of  a <code>lambda</code> should always yield a <code>forall</code></p>",
        "id": 466212001,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725010337
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Expressions/near/466209769\">said</a>:</p>\n<blockquote>\n<p>A term of the form <code>f x</code> for some <code>f : X -&gt; Y</code> and some <code>x : X</code>?</p>\n</blockquote>\n<p>Also this view is not quite right. <code>Expr</code> is just syntax, you can trivially construct type incorrect <code>Expr</code>. So <code>app</code> really just syntactically represents <code>f x</code>, whether <code>f</code> and <code>x</code> are of the right type is a whole other question.</p>",
        "id": 466212540,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725010427
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Expressions/near/466211745\">said</a>:</p>\n<blockquote>\n<p>No, <code>lambda</code> is <code>fun x =&gt; ...</code> and <code>forall</code> is <code>(x : a) -&gt; b x</code></p>\n</blockquote>\n<p>Not sure I understand this; I see your point below that these are \"pure syntax\" and can be wrong (in the sense that they do not typecheck), but why do you say that these things are different type-theoretically?</p>",
        "id": 466218293,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011490
    },
    {
        "content": "<p>They are very different: one can be the type of the other.</p>",
        "id": 466218635,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011544
    },
    {
        "content": "<p><code>fun x : Nat ↦ x</code> is a <code>lambda</code>, while <code>Nat → Nat</code> is a <code>forall</code>.</p>",
        "id": 466218910,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011585
    },
    {
        "content": "<p>The second one is the type of the first one.</p>",
        "id": 466218957,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011593
    },
    {
        "content": "<p>You mean that a forall is a Pi-Type?</p>",
        "id": 466219129,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011622
    },
    {
        "content": "<p>yes</p>",
        "id": 466219606,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011702
    },
    {
        "content": "<p>Oh sure, I was confused. <span aria-label=\"face with peeking eye\" class=\"emoji emoji-1fae3\" role=\"img\" title=\"face with peeking eye\">:face_with_peeking_eye:</span></p>",
        "id": 466219977,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011766
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Expressions/near/466219129\">said</a>:</p>\n<blockquote>\n<p>You mean that a forall is a Pi-Type?</p>\n</blockquote>\n<p>forall is not only a pi-type, it is <em>the</em> pi type</p>",
        "id": 466219996,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725011769
    },
    {
        "content": "<p>Yes yes, thanks. I think I am recovering from my blurred state of mind.</p>",
        "id": 466220302,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011829
    },
    {
        "content": "<p>So, going back to <code>Expr</code>, <code>IsForAll</code> recovers if something is a PiType and <code>IsLambda</code> recovers if it is a lambda-term (inside some PiType)?</p>",
        "id": 466220513,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011878
    },
    {
        "content": "<p>Those functions are so simple that the answer cannot be simpler than the definitions.</p>",
        "id": 466220891,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011964
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Return `true` if the given expression is a forall-expression aka (dependent) arrow. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isForall</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\">          </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"sd\">/-- Return `true` if the given expression is a lambda abstraction aka anonymous function. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isLambda</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">lam</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>",
        "id": 466220962,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725011980
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/270676-lean4/topic/Understanding.20Expressions/near/466220891\">said</a>:</p>\n<blockquote>\n<p>Those functions are so simple that the answer cannot be simpler than the definitions.</p>\n</blockquote>\n<p>Well, this answer is so simple that it cannot be more informative than the question <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 466221026,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725011997
    },
    {
        "content": "<p>The informative part was being copy-pasted.</p>",
        "id": 466221312,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725012051
    },
    {
        "content": "<p>I should have sent only one message, sorry.</p>",
        "id": 466221371,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725012067
    },
    {
        "content": "<p>This is really the analogue of </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">isZero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">isZero</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">isZero</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div>",
        "id": 466221868,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725012181
    },
    {
        "content": "<p>No problem, I just meant to say that I read those definitions, still I was a bit struggling. Perhaps an example would do, it is often helpful. Do we agree that <code>IsForall</code> should return <code>true</code> if it encounters</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>while  <code>IsLambda</code> should return <code>true</code> if it encounters </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>?</p>",
        "id": 466221995,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725012209
    },
    {
        "content": "<p>Did you mean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>in your first example? (arrow instead of comma)</p>",
        "id": 466242491,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725016431
    },
    {
        "content": "<p>I did (I am still fighting with the \"new\" notation for PiTypes: I would write <code>Π(n : Nat) Fin n</code>)</p>",
        "id": 466246680,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725017692
    },
    {
        "content": "<p>I think you can use the logical forall symbol, if you like it better</p>",
        "id": 466247824,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725018011
    },
    {
        "content": "<p>Anyway, if you meant the arrow instead of the comma, then the answer to your question is \"yes\"</p>",
        "id": 466247928,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725018032
    },
    {
        "content": "<p>Thanks! I realised that  most of my trouble came from the inconscious (and wrong, of course) intuition that \"Expressions\" found in the context could not be types...</p>",
        "id": 466248169,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725018088
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"300245\">@Filippo A. E. Nuccio</span> , you can play with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#descr\"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">last</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 466259427,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1725021573
    },
    {
        "content": "<p>Oh, that's nice! Thanks <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span></p>",
        "id": 466262241,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1725022410
    }
]