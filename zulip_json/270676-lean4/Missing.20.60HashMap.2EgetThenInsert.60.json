[
    {
        "content": "<p>I want to get a value of a <code>HashMap</code>, and set it to a new value at the same time. There is no standard function for doing both at the same time (there is <code>Std.HashMap.getThenInsertIfNew?</code> which is not what I want), so instead I manually <code>insert</code> and <code>get?</code> separately. But the generated code does the <code>insert</code> before the <code>get?</code>, which means that the <code>insert</code> cannot be done in-place. What is the recommended solution? mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">modifyGet</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Which compiles to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcRealWorld</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcRealWorld</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">lcRealWorld</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">Const</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_6</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">12</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"bp\">⊥</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">16</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"bp\">⊥</span>\n</code></pre></div>",
        "id": 553684853,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762280126
    },
    {
        "content": "<p>Oh no, looks like <a href=\"https://github.com/leanprover/lean4/pull/6058\">lean4#6058</a> has returned. This is very unfortunate. I guess you can \"launder\" the map like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">modifyGet</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This has a small overhead, but probably much less than a failure of linearity. Like in <a href=\"https://github.com/leanprover/lean4/pull/6058\">lean4#6058</a>, I still think that this should be considered a bug in the compiler, so I think you can create a new lean4 issue referencing the old one.</p>\n<p>Either way, adding an explicit <code>getThenInsert</code> is on the (long) containers TODO list. We might get to it this year, or we might not.</p>",
        "id": 553693945,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1762283379
    },
    {
        "content": "<p>Thanks!</p>\n<p>In my case the hashmap is actually very small, so it doesn't really matter. Do you know why there is the <code>getThenInsertIfNew?</code> function? It seems a bit arbitrary to have that one and not the other.</p>",
        "id": 553695479,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762284004
    },
    {
        "content": "<p>When we made the new <code>Std</code> hash map in early 2024 we made a long list of all of the functions that we want to have eventually and picked some subset of them to do immediately, leaving the others for the future (because there just wasn't enough time to do all of them). One of the criteria for immediate inclusion was that all functions that were present in the <code>Lean</code> and <code>Batteries</code> variants of the hash map needed to have an equivalent in the new hash map. The old <code>Lean.HashMap</code> had a function <code>Lean.HashMap.insertIfNew</code> which behaved like the new <code>getThenInsertIfNew?</code> , so that is why we added it immediately even though otherwise we probably would have postponed both <code>getThenInsertIfNew?</code> and <code>getThenInsert?</code>.</p>",
        "id": 553697757,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1762284827
    },
    {
        "content": "<p>I suppose that the example that I posted can similarly apply to something like <code>modifyGet fun arr =&gt; (arr.back!, arr.pop)</code>, so the issue is not fully resolved by having a <code>getThenInsert?</code>. Looking more closely at the compiled code (on nightly Lean, because we have zero cost <code>BaseIO</code> since very recently), I see the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"bp\">;</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tagged</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"bp\">◾;</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tobj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">Const</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_6</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>Would it be reasonable if the compiler could be able to figure out that it can save on <code>inc</code> and <code>dec</code> by swapping the order of operations? Because it could instead produce this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tobj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">Const</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_6</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">;</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Raw₀</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"bp\">;</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tagged</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Prim</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"bp\">◾;</span>\n</code></pre></div>",
        "id": 553974832,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762382184
    },
    {
        "content": "<p>Reordering let operations at this level of the IR is generally unsound so no that is not reasonable.</p>",
        "id": 553975445,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1762382539
    },
    {
        "content": "<p>Oh right, because then it could accidentally swap IO operations. Could this instead be done at an earlier level of the IR?</p>",
        "id": 553976427,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762383114
    }
]