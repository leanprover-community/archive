[
    {
        "content": "<p>I'm trying to wrap <code>struct winsize</code> from <code>&lt;termios.h&gt;</code>, which looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span>\n<span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">short</span><span class=\"w\"> </span><span class=\"n\">ws_row</span><span class=\"bp\">;</span><span class=\"w\">    </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">rows</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">characters</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"w\">  </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">short</span><span class=\"w\"> </span><span class=\"n\">ws_col</span><span class=\"bp\">;</span><span class=\"w\">    </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">columns</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">characters</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"w\">  </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">short</span><span class=\"w\"> </span><span class=\"n\">ws_xpixel</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">horizontal</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pixels</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"w\">  </span><span class=\"n\">unsigned</span><span class=\"w\"> </span><span class=\"n\">short</span><span class=\"w\"> </span><span class=\"n\">ws_ypixel</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">vertical</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pixels</span><span class=\"w\"> </span><span class=\"bp\">*/</span>\n<span class=\"o\">}</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>I was assuming <code>unsigned short</code> should correspond to <code>UInt16</code> in lean. I'm not quite sure how to use <code>extern_type</code>, I could only find examples of <code>opaque_extern_type</code>. Here's the relevant excerpt from my code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Alloy</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Alloy</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n\n<span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">termios</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">sys</span><span class=\"bp\">/</span><span class=\"n\">ioctl</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">unistd</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">stdio</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Terminal</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">col</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">xPixel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">yPixel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">extern_type</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">finalize</span><span class=\"o\">(</span><span class=\"n\">ptr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"o\">(</span><span class=\"n\">ptr</span><span class=\"o\">)</span>\n\n<span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getWinSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"n\">malloc</span><span class=\"o\">(</span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">ioctl</span><span class=\"o\">(</span><span class=\"n\">STDOUT_FILENO</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TIOCGWINSZ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_row: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_row</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_col: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_col</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_xpixel: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_xpixel</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_ypixel: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_ypixel</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"o\">(</span><span class=\"n\">to_lean</span><span class=\"bp\">&lt;</span><span class=\"n\">WinSize</span><span class=\"bp\">&gt;</span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"o\">))</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Terminal</span>\n</code></pre></div>\n<p>and main:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ws</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Terminal</span><span class=\"bp\">.</span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Terminal</span><span class=\"bp\">.</span><span class=\"n\">getWinSize</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">wsr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"n\">ws</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">wsr</span>\n</code></pre></div>\n<p>The output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">▷</span><span class=\"w\"> </span><span class=\"bp\">./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">sand</span>\n<span class=\"n\">ws_row</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">30</span>\n<span class=\"n\">ws_col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">225</span>\n<span class=\"n\">ws_xpixel</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">ws_ypixel</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">52112</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">16217</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">xPixel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">25014</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">yPixel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>as you can see, the lean values are wrong. What am I doing wrong? <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> (hope it's ok to tag)</p>",
        "id": 453162160,
        "sender_full_name": "James Sully",
        "timestamp": 1721650633
    },
    {
        "content": "<blockquote>\n<p>I was assuming <code>unsigned short</code> should correspond to <code>UInt16</code> in lean.</p>\n</blockquote>\n<p>These assumptions <em>can</em> be wrong, the C standard does not guarantee a size for int/short/long etc. it merely provides a lower bound to their size. E.g. the lower bound for <code>int</code>is in fact 16 bits and platforms like Arduino <a href=\"https://www.arduino.cc/reference/en/language/variables/data-types/int/\">do make use of this</a>.</p>\n<p>Secondly using a pre-existing <code>structure</code> with <code>extern_type</code> is not right. As you can see in <a href=\"https://github.com/hargoniX/socket.lean/blob/main/Socket.lean\">socket.lean</a> there does not exist a hand written type to mirror the <code>extern_type</code>s that I use. <code>extern_type</code>s are just some allocation that the Lean runtime manages for you and that's it. What I'm guessing is happening is that there is quite the fuckup going on regarding memory layout so it seems like you are getting valid values when you are not? Hard to tell.</p>\n<p>Anyways there are basically two approaches you can go here. Either have your custom <code>structure</code> type that just wraps a bunch of <code>UInt16</code> (hoping you will never be used outside of a <code>unsigned short = uint16_t</code> environment) and then when it comes to syscalls that want a winsize you'll have to manually convert your thing to a <code>winsize</code> (probably a stack allocated one) and be done.</p>\n<p>Or alternatively you can use an <code>extern_type</code> with explicit projection functions that give you <code>UInt16</code> by grabbing them from the C allocation that it is managing for you (here you also hope about the sizes, we don't really have a nice solution for that yet. Luckily deviating from \"common sizes\" is not the norm).</p>\n<p>I would probably go for number 2</p>",
        "id": 453168652,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721652662
    },
    {
        "content": "<blockquote>\n<p>These assumptions <em>can</em> be wrong</p>\n</blockquote>\n<p>Yeah, I know I'm playing a bit fast and loose here, and I'm planning to get more rigorous, but my understanding from research is that it's usually 16 bits in practice.</p>\n<blockquote>\n<p>using a pre-existing <code>structure</code> with <code>extern_type</code> is not right</p>\n</blockquote>\n<p>Ok, thanks. I had gotten it into my head that I was supposed to do that from cargo-culting <a href=\"https://github.com/tydeu/lean4-alloy/blob/7af65d3a57015a59ec67a2424519277a864be681/tests/compile/Test/RawStruct.lean#L27\">this</a> - I had assumed this was a difference between <code>opaque_extern_type</code> and <code>extern_type</code>.</p>",
        "id": 453169925,
        "sender_full_name": "James Sully",
        "timestamp": 1721652997
    },
    {
        "content": "<p>Does number 2 support record syntax?</p>",
        "id": 453170460,
        "sender_full_name": "James Sully",
        "timestamp": 1721653106
    },
    {
        "content": "<p>Oh, maybe it is supposed to work then, let's see what mac thinks.</p>\n<p>And no it doesn't.</p>",
        "id": 453170724,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721653176
    },
    {
        "content": "<p>Supposing for a moment that the pre-existing <code>structure</code> thing I was doing isn't right:</p>\n<ul>\n<li>I think I understand method 2 pretty well, you can just use <code>opaque_extern_type</code> like I'm used to with your <code>socket_wrapper</code>.</li>\n<li>I'm still a bit hazy on what you mean by method 1, and the details of going from a c struct to a lean value. I know I have to produce a <code>lean_object *</code>. How specifically do I accomplish that?</li>\n</ul>",
        "id": 453171801,
        "sender_full_name": "James Sully",
        "timestamp": 1721653499
    },
    {
        "content": "<p>Well you can just use a <code>structure</code> without an <code>extern_type</code> and then in your C code create a <code>struct winsize</code> from it on the fly and do stuff.</p>",
        "id": 453172279,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721653657
    },
    {
        "content": "<p>Sure, that makes sense, don't have structure wrap the struct. But I'm still not sure about the other direction - if I have 4 <code>uint_16_t</code> in c, how do I build the structure to give back to lean?</p>",
        "id": 453172579,
        "sender_full_name": "James Sully",
        "timestamp": 1721653768
    },
    {
        "content": "<p>using <code>lean_alloc_ctor</code> and relatives.</p>",
        "id": 453172627,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721653790
    },
    {
        "content": "<p>Ah, it's not mentioned in the <a href=\"https://lean-lang.org/lean4/doc/dev/ffi.html\">ffi section of the manual</a> yet. Thanks.<br>\n<a href=\"https://github.com/leanprover/lean4/blob/3a4d2cded30beb3343ba0e13a3ddb2809703e26d/src/include/lean/lean.h#L540\">linking the function for my reference</a><br>\nI'll try puzzle this out, cheers</p>",
        "id": 453173467,
        "sender_full_name": "James Sully",
        "timestamp": 1721654050
    },
    {
        "content": "<p>Linking this for my reference also:<br>\n<a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b\">Understanding Lean's Foreign Function Interface (FFI)</a></p>",
        "id": 453180226,
        "sender_full_name": "James Sully",
        "timestamp": 1721656068
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/270676-lean4/topic/Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453169925\">said</a>:</p>\n<blockquote>\n<p>Ok, thanks. I had gotten it into my head that I was supposed to do that from cargo-culting <a href=\"https://github.com/tydeu/lean4-alloy/blob/7af65d3a57015a59ec67a2424519277a864be681/tests/compile/Test/RawStruct.lean#L27\">this</a> - I had assumed this was a difference between <code>opaque_extern_type</code> and <code>extern_type</code>.</p>\n</blockquote>\n<p>The example uses magic that is not well-suppoted by Lean by the moment. While you could do something similar for <code>WinSize</code>, I would not advise doing so until the magic is better supported by Lean.</p>\n<p>In case you are curious what that test is doing, here is a brief explanation: It overwrites the default Lean runtime representation of Lean structure <code>RawY</code> with a  Lean external type wrapper around the C structure <code>Y</code>. The <code>extern_type</code> defines the relevant external wrapper type and associates it with <code>RawY</code>. The subsequeent <code>extern impl</code> definitions then overwrite the implementations of the constructor and projection functions of the <code>RawY</code> structure with FFI functions. These interact with this new runtime represenataton rather than with the default structure rrepresentation (of <code>lean_alloc_ctor</code>). Unfortunately, the Lean compiler does not reliably call these external implementations and often uses the standard builtins instead. Thus, this approach is not practical at the moment.</p>",
        "id": 453211780,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721662789
    },
    {
        "content": "<p>If you are interested in magic, there is some you could do. Since your <code>WinSize</code> structure is all scalar types of the same size (<code>UInt16</code>), the memory layout of Lean constructor's data exactly matches that of the <code>winsize</code> type. Thus, you can cast <code>lean_ctor_obj_cptr</code> directly to a <code>winsize</code>. Therefore, I believe the following should work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Alloy</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Alloy</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n\n<span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">termios</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">sys</span><span class=\"bp\">/</span><span class=\"n\">ioctl</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span><span class=\"w\">  </span><span class=\"bp\">&lt;</span><span class=\"n\">unistd</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">stdio</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Terminal</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">col</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">xPixel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">yPixel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt16</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getWinSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sizeof</span><span class=\"o\">(</span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">struct</span><span class=\"w\"> </span><span class=\"n\">winsize</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"n\">lean_ctor_obj_cptr</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">ioctl</span><span class=\"o\">(</span><span class=\"n\">STDOUT_FILENO</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TIOCGWINSZ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_row: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_row</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_col: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_col</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_xpixel: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_xpixel</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"ws_ypixel: %d</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">-&gt;</span><span class=\"n\">ws_ypixel</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 453215733,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721663972
    },
    {
        "content": "<p>/me shudders</p>",
        "id": 453221085,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721665272
    },
    {
        "content": "<p>Since I found this magic interesting, I added an adaption of it as <a href=\"https://github.com/tydeu/lean4-alloy/blob/a712058ff5ca47f670f6d25ea2b2a7385d9523ae/tests/compile/Test/ScalarStruct.lean\">a test</a> for Alloy.</p>",
        "id": 453231664,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721668306
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453221085\">said</a>:</p>\n<blockquote>\n<p>shudders</p>\n</blockquote>\n<p>This magic is surprisingly less hacky than it looks.  <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> The memory layout of constructor fields is well-defined in the Lean manaul (<a href=\"https://lean-lang.org/lean4/doc/dev/ffi.html#inductive-types\">src</a>), so this should reliably work.</p>",
        "id": 453233234,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721668736
    },
    {
        "content": "<p>Well defined with no stability guarantees yes yes :P</p>",
        "id": 453233475,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721668802
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Are the stability guarentees of the layout less than any other part of the FFI (which, admittedly, is all marked unstable <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> )? If anything, I would think the fact there is a expansive example of it in manual would indicate it is more stable than other less documented details of the FFI.</p>",
        "id": 453233931,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721668915
    },
    {
        "content": "<p>The memory layout of <code>lean_object</code> itself is not defined there is it? It is merely stated that you can obtain things with the wrapper functions. Apart from that I'd think that once we do improve the compiler, changing things about how certain types are represented in the FFI might be a thing that is very much possible</p>",
        "id": 453234553,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721669083
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453234553\">said</a>:</p>\n<blockquote>\n<p>The memory layout of <code>lean_object</code> itself is not defined there is it? It is merely stated that you can obtain things with the wrapper functions.</p>\n</blockquote>\n<p>It <em>is</em> (parially) defined there. The documentation states that the <code>lean_object</code> for a constructor is a <code>lean_ctor_object</code> with a <code>m_objs</code> member that is ordered in a precise way.  That order is what the above magic relies on. (The <code>lean_ctor_obj_ctor</code> is the API accesor for that <code>m_objs</code> field.)</p>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/270676-lean4/topic/Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453234553\">said</a>:</p>\n<blockquote>\n<p>Apart from that I'd think that once we do improve the compiler, changing things about how certain types are represented in the FFI might be a thing that is very much possible</p>\n</blockquote>\n<p>I imagine so as welll, but I also imagine that will break significant chunks of FFI code. I think the big <strong>unstable</strong> at the top of the documentation does help indicate this is expected to happen.</p>",
        "id": 453248775,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721673055
    },
    {
        "content": "<p>(The key due diligience I would expect here for significant breaking  changes would be for them to be mentioned in the relevant release notes.)</p>",
        "id": 453249318,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721673157
    },
    {
        "content": "<p>I generally just watch for changes to lean.h, I'm not sure how reliable any of the other mechanisms are and it's rare that anyone actually publicizes these changes or pings me even when I ask for it; I've seen this stuff break in production in the past because I maintain <a href=\"https://github.com/digama0/leangz\">some</a> <a href=\"https://github.com/digama0/lean-sys\">tools</a> that depend on the precise details of the lean ABI</p>",
        "id": 453265705,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721678214
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453215733\">said</a>:</p>\n<blockquote>\n<p>Thus, you can cast <code>lean_ctor_obj_cptr</code> directly to a <code>winsize</code></p>\n</blockquote>\n<p>Wow, that's fun!</p>",
        "id": 453298440,
        "sender_full_name": "James Sully",
        "timestamp": 1721694922
    },
    {
        "content": "<p>Thanks very much guys this was super helpful</p>",
        "id": 453299052,
        "sender_full_name": "James Sully",
        "timestamp": 1721695128
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> has marked this topic as resolved.</p>",
        "id": 453299060,
        "sender_full_name": "Notification Bot",
        "timestamp": 1721695134
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453215733\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">winsize</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">winsize</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">winsize</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">lean_ctor_obj_cptr</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>So if I'm understanding right, the first line allocates a constructor object with 0 boxed fields and space for scalar fields equal to <code>sizeof(struct winsize)</code>.</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\">   </span><span class=\"n\">m_header</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">m_objs</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_object</span><span class=\"p\">;</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">num_objs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">scalar_sz</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">LeanMaxCtorTag</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">num_objs</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_MAX_CTOR_FIELDS</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">scalar_sz</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_MAX_CTOR_SCALARS_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor_memory</span><span class=\"p\">(</span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"n\">lean_ctor_object</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"n\">num_objs</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">scalar_sz</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">lean_set_st_header</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">num_objs</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">lean_set_st_header</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">unsigned</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"o\">-&gt;</span><span class=\"n\">m_rc</span><span class=\"w\">       </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"o\">-&gt;</span><span class=\"n\">m_tag</span><span class=\"w\">      </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"o\">-&gt;</span><span class=\"n\">m_other</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">o</span><span class=\"o\">-&gt;</span><span class=\"n\">m_cs_sz</span><span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">**</span><span class=\"w\"> </span><span class=\"nf\">lean_ctor_obj_cptr</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">lean_is_ctor</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_to_ctor</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">m_objs</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Since the constructor has 0 boxed fields, <code>lean_ctor_obj_cptr(o)</code> just points to the scalar fields, which will be stored directly below the header</p>",
        "id": 453301050,
        "sender_full_name": "James Sully",
        "timestamp": 1721695893
    },
    {
        "content": "<p>In case we did have some boxed fields in addition to our scalar fields, I guess we would use:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"nf\">lean_ctor_scalar_cptr</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">lean_is_ctor</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint8_t</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">lean_ctor_obj_cptr</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_num_objs</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Instead of <code>lean_ctor_obj_cptr</code> directly</p>",
        "id": 453301737,
        "sender_full_name": "James Sully",
        "timestamp": 1721696271
    },
    {
        "content": "<p>As far as I can tell, the \"normal\" way of doing this would be:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">def</span><span class=\"w\"> </span><span class=\"n\">getWinSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">winsize</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"w\">  </span><span class=\"n\">ioctl</span><span class=\"p\">(</span><span class=\"n\">STDOUT_FILENO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">TIOCGWINSZ</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">w</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">))</span>\n<span class=\"w\">  </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">scalar_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_scalar_cptr</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// set the scalar fields</span>\n<span class=\"w\">  </span><span class=\"o\">*</span><span class=\"p\">((</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">scalar_ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_row</span>\n<span class=\"w\">  </span><span class=\"o\">*</span><span class=\"p\">((</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">scalar_ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_col</span>\n<span class=\"w\">  </span><span class=\"o\">*</span><span class=\"p\">((</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">scalar_ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_xpixel</span>\n<span class=\"w\">  </span><span class=\"o\">*</span><span class=\"p\">((</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">scalar_ptr</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_ypixel</span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>is that right? It seems like this relies in the precise memory layout just as much as Mac's \"hack\", so really they're no more or less morally corrupt than each other, Mac's is just faster.</p>",
        "id": 453303058,
        "sender_full_name": "James Sully",
        "timestamp": 1721697311
    },
    {
        "content": "<p>you could even <code>memcpy</code> it in if you already had the <code>winsize</code> lying around.</p>",
        "id": 453303097,
        "sender_full_name": "James Sully",
        "timestamp": 1721697360
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453303058\">said</a>:</p>\n<blockquote>\n<p>As far as I can tell, the \"normal\" way of doing this would be: [...]</p>\n</blockquote>\n<p>Close, the \"normal\" way to get/set values is with the <code>lean_ctor_get/set</code> helpers, like so:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">alloy</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"n\">def</span><span class=\"w\"> </span><span class=\"n\">getWinSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">WinSize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">winsize</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"w\">  </span><span class=\"n\">ioctl</span><span class=\"p\">(</span><span class=\"n\">STDOUT_FILENO</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">TIOCGWINSZ</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">w</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_ctor</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">))</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// set the scalar fields</span>\n<span class=\"w\">  </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_row</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_col</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_xpixel</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">lean_ctor_set_uint16</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"p\">.</span><span class=\"n\">ws_ypixel</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">lean_io_result_mk_ok</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>However, as you noted, since you still have to provide an offset, it relies on the precise memory layout as well.</p>",
        "id": 453575099,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721788367
    },
    {
        "content": "<p>I actually forgot that the helpers also relied on the offset. Sorry <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>, I guess that renders our discussion of the hackiness of this solution a bit moot .</p>",
        "id": 453575535,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721788676
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453301050\">said</a>:</p>\n<blockquote>\n<p>Since the constructor has 0 boxed fields, <code>lean_ctor_obj_cptr(o)</code> just points to the scalar fields, which will be stored directly below the header</p>\n</blockquote>\n<p>Once little caveat to keep in mind is that the scalar fields are stored in decreasing order of size then order (<a href=\"https://lean-lang.org/lean4/doc/dev/ffi.html#inductive-types\">src</a>). Thus all <code>UInt64</code> scalar fields appear firrst (in order), then likewise <code>UInt32</code>, <code>UInt16</code>, and <code>UInt8</code>.</p>",
        "id": 453576369,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721789081
    },
    {
        "content": "<p>Thus, you cannot use my hack for a C <code>struct</code> of scalar values of different sizes that do not follow this order (no matter how the Lean structure is ordered).</p>",
        "id": 453576444,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721789149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/270676-lean4/topic/.E2.9C.94.20Alloy.3A.20using.20extern_type.20.28not.20opaque.29/near/453575099\">said</a>:</p>\n<blockquote>\n<p>Close, the \"normal\" way to get/set values is with the <code>lean_ctor_get/set</code> helpers, like so:</p>\n</blockquote>\n<p>Ah thanks, somehow I got it into my head that that family was only for boxed fields</p>",
        "id": 453590818,
        "sender_full_name": "James Sully",
        "timestamp": 1721795174
    },
    {
        "content": "<p>yeah, I got that from <a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b#working-with-constructor-objects\">here</a></p>",
        "id": 453591397,
        "sender_full_name": "James Sully",
        "timestamp": 1721795296
    }
]