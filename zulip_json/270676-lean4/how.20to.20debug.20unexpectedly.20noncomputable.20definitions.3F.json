[
    {
        "content": "<p>Heya,</p>\n<p>I'm new to lean4, though I have some experience with Rocq. My focus is more in computer science / type theory at the moment, vs more standard mathematics, but I'm trying out lean for a new project because the programming experience seems much nicer than Rocq's.</p>\n<p>However, I've run into an issue where a function I've defined is unexpectedly noncomputable, and the message from the compiler is not useful.</p>\n<p>The function is quite small, so I can just share the full definition:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">             </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decoded</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">decoded</span>\n</code></pre></div>\n<p>Of the names used here which I've defined, I think Vector.segment and sExpr.bitLength are computable, in that they can be used with <code>#eval</code> commands. <code>sExpr.bitType</code> does not seem to be computable (e.g. <code>#eval sExpr.Int.bitType</code> yields <code>cannot evaluate, types are not computationally relevant</code>) (though I don't know why...), but it's not used in function body, above, only the type signature.</p>\n<p>The message from the compiler, regarding <code>segment</code> is the classic </p>\n<blockquote>\n<p>failed to compile definition, consider marking it as 'noncomputable' because it depends on 'segment.match_1', and it does not have executable code</p>\n</blockquote>\n<p>So, is there a good way to debug what's going on here?</p>",
        "id": 525428768,
        "sender_full_name": "neil",
        "timestamp": 1750728592
    },
    {
        "content": "<p>Based on only the error message, that's probably a bug in the compiler. Can you make a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> so that we can inspect your code independently?</p>",
        "id": 525429003,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750728803
    },
    {
        "content": "<p>sure. and I should post it here?</p>",
        "id": 525429023,
        "sender_full_name": "neil",
        "timestamp": 1750728829
    },
    {
        "content": "<p>Should I try to reproduce this without relying on my own Vector.segment definition, or just include that, though it'll add maybe a hundred lines to the MWE?</p>",
        "id": 525429086,
        "sender_full_name": "neil",
        "timestamp": 1750728914
    },
    {
        "content": "<p>Shorter is better, but if you can't reproduce the bug then long code is okay too.</p>",
        "id": 525429195,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750729040
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TagExpr</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagExpr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">length</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">bitType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"c1\">-- NOTE: for some reason, we have to explicitly unroll .asType, otherwise we</span>\n<span class=\"w\">  </span><span class=\"c1\">-- get type errors.</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitType</span>\n<span class=\"w\">                              </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- Split a vector at an exact index, resulting in two vectors of known length.</span>\n<span class=\"c1\">-- This is accomplished by requiring that the input vector's length is already</span>\n<span class=\"c1\">-- of the form (k + n) where k is the index of the desired split point.</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">SplitVector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">splitExact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SplitVector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Ensure that the 'head' of the split is length exactly k.</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">min_add_right_self</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Ensuring that the 'tail' of the split is length exactly n requires this</span>\n<span class=\"w\">  </span><span class=\"c1\">-- intermediate simplification, for legibility.</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">arith</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">SplitVector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">tail</span>\n\n\n<span class=\"c1\">-- no idea why simp +arith doesn't just discharge this immediately...</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_step</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_add_one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"c1\">-- The idea here is that a vector of length (k'.succ * s) can be</span>\n<span class=\"w\">        </span><span class=\"c1\">-- rearranged into (abusing notation) #v[s] + #v[k' * s]; the former is</span>\n<span class=\"w\">        </span><span class=\"c1\">-- one of our segments, while the latter is easily itself segmented.</span>\n<span class=\"w\">        </span><span class=\"c1\">--</span>\n<span class=\"w\">        </span><span class=\"c1\">-- First, we rearrange the length index in order to apply splitExact.</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">mul_step</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">splitExact</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">SplitVector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">this_segment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">singleton</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"bp\">.</span><span class=\"n\">head</span>\n<span class=\"w\">        </span><span class=\"c1\">-- Now, the 'tail' index is conveniently expressed for immediate</span>\n<span class=\"w\">        </span><span class=\"c1\">-- recursion of segment.</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rest_segments</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"c1\">-- Finally, we need to flip the length around in the index, since</span>\n<span class=\"w\">        </span><span class=\"c1\">-- `this.append rest` will have length 1 + k, but we need it to have</span>\n<span class=\"w\">        </span><span class=\"c1\">-- length k.succ, or k + 1.</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k'</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_one</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">this_segment</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"n\">rest_segments</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">             </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decoded</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">decoded</span>\n</code></pre></div>",
        "id": 525429219,
        "sender_full_name": "neil",
        "timestamp": 1750729067
    },
    {
        "content": "<p>here's basically everything involved for now, I'm going to see if I can define a separate, similar function on sExprs which still results in this error</p>",
        "id": 525429238,
        "sender_full_name": "neil",
        "timestamp": 1750729097
    },
    {
        "content": "<p>the \"problem\" is that I'm using indexed families sort of heavily, so it's difficult to just pull out a small piece</p>",
        "id": 525429273,
        "sender_full_name": "neil",
        "timestamp": 1750729127
    },
    {
        "content": "<p>ok actually I'm not going to try to define something smaller, because producing a valid s.bitType basically requires this much code, since you have to satisfy all the length requirements for the various Vectors</p>",
        "id": 525429380,
        "sender_full_name": "neil",
        "timestamp": 1750729238
    },
    {
        "content": "<p>(for context, I'm writing a type-directed de-/serialization framework, where users provide \"signatures\" [here the minimal type <code>sExpr</code>] which direct parsing bytestrings into host-language values [here the type <code>vExpr</code>, which is generic to support partial-parsing and other sorts of operations, and which is indexed because I want to experiment with relying on dependent types to make this as correct-by-construction as possible].</p>\n<p>I'm using dependent typing to ensure that bytestrings conform to the given signature, and to couple the resulting value expressions to that signature as well. Hence <code>sExpr.bitLength</code>, for the former, and <code>sExpr.bitType</code> / <code>sExpr.asType \\a</code>, for the latter.)<br>\n)</p>",
        "id": 525429951,
        "sender_full_name": "neil",
        "timestamp": 1750729792
    },
    {
        "content": "<p>something is wrong if a working function starts printing errors after turning on compiler tracing</p>",
        "id": 525430149,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730031
    },
    {
        "content": "<p>wait, sorry, I don't think that's what's happening in my case--the interactive lean output just puts a red quiggly on my definition of <code>segment</code> with the error message I posted. </p>\n<p>I haven't tried to \"use\" <code>segment</code>, so it's not that it \"was working\" but isn't when the compiler is given different commands</p>",
        "id": 525430374,
        "sender_full_name": "neil",
        "timestamp": 1750730280
    },
    {
        "content": "<p>what I meant by the topic title was that, based on its definition but independently of any actual feedback from lean, I would have expected <code>segment</code> to be computable as defined</p>",
        "id": 525430418,
        "sender_full_name": "neil",
        "timestamp": 1750730322
    },
    {
        "content": "<p>if you do try to do something like <code>#eval (segment .Bool #v[true])</code>, which should just be <code>vExpr.Bool #v[true]</code>, you instead get <code>(interpreter) unknown declaration '_eval'</code>, but maybe that's expected given that <code>segment</code> has failed to compile.</p>\n<p>Also, neither <code>segment</code> nor <code>Vector.segment</code> can be marked partial</p>",
        "id": 525430772,
        "sender_full_name": "neil",
        "timestamp": 1750730605
    },
    {
        "content": "<p>I have no idea what's going on, but this is what I have so far</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">WhatsNew</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TagExpr</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagExpr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- `sorry`ing this one fixes it so maybe something with `abbrev` being `@[reducible, inline]`?</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">length</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"bp\">.</span><span class=\"n\">bitType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"c1\">-- NOTE: for some reason, we have to explicitly unroll .asType, otherwise we</span>\n<span class=\"w\">  </span><span class=\"c1\">-- get type errors.</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitType</span>\n<span class=\"w\">                              </span><span class=\"n\">vExpr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">asType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- whatsnew in</span>\n<span class=\"c1\">-- set_option trace.compiler true in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bitVec</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">bitType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">             </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">length_segmented</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b_length_segmented</span><span class=\"bp\">.</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"bp\">.</span><span class=\"n\">bitLength</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decoded</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">segmented</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">segment</span><span class=\"w\"> </span><span class=\"n\">elem_type</span><span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">decoded</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`segment._cstage2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u?</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">u?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"n\">value!</span>\n</code></pre></div>",
        "id": 525430788,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730614
    },
    {
        "content": "<p>do you have no idea what's going on in a way that I can help by commenting on the mwe, or do you mean that you have no idea what's going on in a way that requires understanding the compiler</p>",
        "id": 525430846,
        "sender_full_name": "neil",
        "timestamp": 1750730677
    },
    {
        "content": "<p>I have no idea what's wrong with the compiler but look I got some cool trace messages</p>",
        "id": 525430876,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730706
    },
    {
        "content": "<p>lmao</p>",
        "id": 525430935,
        "sender_full_name": "neil",
        "timestamp": 1750730755
    },
    {
        "content": "<p>Maybe I'll study the compiler this week</p>",
        "id": 525430948,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730763
    },
    {
        "content": "<p>Actually since they're replacing it soon maybe not</p>",
        "id": 525430991,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730785
    },
    {
        "content": "<p>can you post the traces?</p>",
        "id": 525431086,
        "sender_full_name": "neil",
        "timestamp": 1750730879
    },
    {
        "content": "<p>maybe I should just actually install mathlib and generate them myself</p>",
        "id": 525431109,
        "sender_full_name": "neil",
        "timestamp": 1750730899
    },
    {
        "content": "<p>You can look at them on the web server</p>",
        "id": 525431129,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730916
    },
    {
        "content": "<p>hover over the code block and click the pop-out on the top right</p>",
        "id": 525431141,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750730932
    },
    {
        "content": "<p>i love Infrastructure</p>",
        "id": 525431180,
        "sender_full_name": "neil",
        "timestamp": 1750730973
    },
    {
        "content": "<p>wow ok you got it</p>",
        "id": 525431362,
        "sender_full_name": "neil",
        "timestamp": 1750731193
    },
    {
        "content": "<p>It seems to work fine on the new compiler so just update Lean maybe?</p>",
        "id": 525431370,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750731202
    },
    {
        "content": "<p>change the <code>abbrev sExpr.bitLength</code> to <code>@[reducible] def ...</code> and it works</p>",
        "id": 525431385,
        "sender_full_name": "neil",
        "timestamp": 1750731222
    },
    {
        "content": "<p>yeah, I'll just update Lean.</p>\n<p>fwiw when I was looking this up it looked like there were some issues with inlining and this same trace</p>",
        "id": 525431421,
        "sender_full_name": "neil",
        "timestamp": 1750731257
    },
    {
        "content": "<p>these docs implicitly suggest using the reducible-def : <a href=\"https://docs.lean-lang.org/lean4/doc/examples/interp.lean.html\">https://docs.lean-lang.org/lean4/doc/examples/interp.lean.html</a></p>\n<p>but the dependently typed programming section of \"functional programming in Lean\" suggests using <code>abbrev</code>, sooo</p>",
        "id": 525431488,
        "sender_full_name": "neil",
        "timestamp": 1750731328
    },
    {
        "content": "<p>how did you figure to start mucking with the abbrevs? was it just a case of trying to change anything that looked suspicious / bisecting, or was there some trace output that suggested making that particular change?</p>",
        "id": 525431526,
        "sender_full_name": "neil",
        "timestamp": 1750731370
    },
    {
        "content": "<p>The new compiler is enabled by default as of 3 days ago, so I don't think it's in any versions yet</p>",
        "id": 525431530,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750731374
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"931836\">neil</span> <a href=\"#narrow/channel/270676-lean4/topic/how.20to.20debug.20unexpectedly.20noncomputable.20definitions.3F/near/525431526\">said</a>:</p>\n<blockquote>\n<p>how did you figure to start mucking with the abbrevs? was it just a case of trying to change anything that looked suspicious / bisecting, or was there some trace output that suggested making that particular change?</p>\n</blockquote>\n<p>I was replacing definitions by <code>sorry</code> in an attempt to make the example more minimal, and then it suddenly started working</p>",
        "id": 525431570,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750731422
    },
    {
        "content": "<p>I don't understand how that works, in that wouldn't replacing definitions by sorry make it /less/ computable, not /more/?</p>",
        "id": 525431640,
        "sender_full_name": "neil",
        "timestamp": 1750731498
    },
    {
        "content": "<p>oh wow, I just replaced the definition of Vector.segment with sorry and there's nothing at all reported from the definition of segment. So I suppose, if you use sorry in a definition, lean is giving you the benefit of the doubt and marking it computable? I suppose that makes sorry much more useful for prototyping.</p>",
        "id": 525431708,
        "sender_full_name": "neil",
        "timestamp": 1750731588
    },
    {
        "content": "<p>I have encountered similar problem <a href=\"https://github.com/leanprover/lean4/issues/7874\">https://github.com/leanprover/lean4/issues/7874</a> it might be worth posting your example there too</p>",
        "id": 525436007,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1750736095
    },
    {
        "content": "<p>Both the bug described here as well as in the issue seems to be handled by the new compiler, coming soon to a Lean release near you.</p>",
        "id": 525454160,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1750749056
    }
]