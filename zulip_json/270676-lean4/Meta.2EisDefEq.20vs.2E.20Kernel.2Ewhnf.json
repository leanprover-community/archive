[
    {
        "content": "<p>(deleted)</p>",
        "id": 471906456,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1726908571
    },
    {
        "content": "<p>Is this  a bug or expected behaviour: I have an expression that isn’t <code>Meta.isDefEq</code> to it’s <code>Kernel.whnf</code>, even though I am running at transparency <code>.all</code>. Is there something else I have to so that <code>Meta.isDefEq</code> accepts this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: Reduced ⏎</span>\n<span class=\"sd\">  List.range.loop n []  o</span>\n<span class=\"sd\">  (Nat.rec</span>\n<span class=\"sd\">        ⟨(fun x f x_1 =&gt;</span>\n<span class=\"sd\">              (match (motive := (x : Nat) → List Nat → Nat.below (motive := fun x =&gt; List Nat → List Nat) x → List Nat)</span>\n<span class=\"sd\">                  x, x_1 with</span>\n<span class=\"sd\">                | 0, ns =&gt; fun x =&gt; ns</span>\n<span class=\"sd\">                | n.succ, ns =&gt; fun x =&gt; x.1 (n :: ns))</span>\n<span class=\"sd\">                f)</span>\n<span class=\"sd\">            Nat.zero PUnit.unit,</span>\n<span class=\"sd\">          PUnit.unit⟩</span>\n<span class=\"sd\">        (fun n n_ih =&gt;</span>\n<span class=\"sd\">          ⟨(fun x f x_1 =&gt;</span>\n<span class=\"sd\">                (match (motive :=</span>\n<span class=\"sd\">                    (x : Nat) → List Nat → Nat.below (motive := fun x =&gt; List Nat → List Nat) x → List Nat) x, x_1 with</span>\n<span class=\"sd\">                  | 0, ns =&gt; fun x =&gt; ns</span>\n<span class=\"sd\">                  | n.succ, ns =&gt; fun x =&gt; x.1 (n :: ns))</span>\n<span class=\"sd\">                  f)</span>\n<span class=\"sd\">              n.succ n_ih,</span>\n<span class=\"sd\">            n_ih⟩)</span>\n<span class=\"sd\">        n).1</span>\n<span class=\"sd\">    []</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: But not defeq (kernel says true)</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"ss\">`n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkApp2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``List.range.loop</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``List.nil</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"o\">[]))</span>\n<span class=\"w\">    </span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">whnf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"faild to whnf\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let e' ← withTransparency .all (Meta.whnf e)</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Reduced {indentExpr e}</span><span class=\"err\">\\</span><span class=\"s2\">to{indentExpr e'}\"</span>\n<span class=\"w\">    </span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">e'</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withTransparency</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">keq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">e'</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"failed to Kernel.isDefEq\"</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"But not defeq (kernel says {keq})\"</span>\n</code></pre></div>",
        "id": 471912822,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1726910837
    },
    {
        "content": "<p>This is likely expected. Smart unfolding, which the kernel knows nothing about, can block Meta reduction.</p>",
        "id": 471921905,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1726915517
    },
    {
        "content": "<p>I see, I thought it must be a corner like this. I'll see if I can disable smart unfolding</p>\n<p>Indeed, at least in this example <code>withOptions (smartUnfolding.set · false) </code> helps.</p>\n<p>And in my actual use case as well. That cost me more time than it should have, turns out my evaluator was type-correct after all <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span> But good to know that before the weekend starts properly.</p>",
        "id": 471922411,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1726915635
    }
]