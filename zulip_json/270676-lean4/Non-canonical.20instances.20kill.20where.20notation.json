[
    {
        "content": "<p>Where are we at in removing the new Lean 4 behavior of not letting instance arguments being filled in by unification? I just got hit by a nasty occurrence of it: After <a href=\"https://github.com/leanprover-community/mathlib4/pull/15021\">#15021</a>, <code>Kernel.mk</code> takes <code>[MeasurableSpace α] [MeasurableSpace β]</code> as instance arguments</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Kernel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myKernel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">noncanonical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">Kernel</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">noncanonical</span><span class=\"w\"> </span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized</span>\n<span class=\"cm\">  canonical</span>\n<span class=\"cm\">inferred</span>\n<span class=\"cm\">  noncanonical</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 460073498,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723466037
    },
    {
        "content": "<p>3 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"236604\" href=\"/#narrow/stream/236604-Zulip-meta/topic/Weird.20whitespace.20in.20code.20snippets\">#Zulip meta &gt; Weird whitespace in code snippets</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 460078437,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723467724
    },
    {
        "content": "<p><code>:= {}</code> also fails in the same way; you need <code>:= @Kernel.mk _ _ (_) (_)</code> to make this work</p>",
        "id": 460078492,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723467746
    },
    {
        "content": "<p>I know. That's precisely what I am complaining about.</p>",
        "id": 460078744,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723467841
    },
    {
        "content": "<p>If there was a way to customise the constructor that <code>where</code> notation uses (<a href=\"#narrow/stream/287929-mathlib4/topic/Notation.20with.20letter-like.20symbols/near/446466374\">wink wink</a>), I could just rename <code>Kernel.mk</code> to <code>Kernel.mk</code> and roll my own constructor with the correct implicitness, but that's currently not the case.</p>",
        "id": 460079217,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723468011
    },
    {
        "content": "<p>May I also complain that this \"synthesized type class instance is not definitionally equal to expression inferred by typing rules\" error is really unhelpful for debugging? Since it doesn't tell me which part of the expression the typeclass was found in and since it prevents type-checking, all I can do is guesswork to figure out which part of the expression is causing the issue.</p>",
        "id": 460081137,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723468722
    },
    {
        "content": "<p>In this specific case, it took me a solid 15min of debugging to find out that the <code>where</code> was the cause of the error (it was used in a pretty chunky definition whose parts I could not easily remove).</p>",
        "id": 460081283,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723468788
    },
    {
        "content": "<blockquote>\n<p>Where are we at in removing the new Lean 4 behavior of not letting instance arguments being filled in by unification?</p>\n</blockquote>\n<p>What's the context of this? As far as I know, there is no plan to backtrack on this feature, so I'm not sure what you mean by \"where are we at in removing [it]\".</p>\n<p>It helps prevent noncanonical instances from slipping into expressions, which can lead to much worse debugging issues.</p>",
        "id": 460089018,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723471320
    },
    {
        "content": "<blockquote>\n<p>May I also complain that this \"synthesized type class instance is not definitionally equal to expression inferred by typing rules\" error is really unhelpful for debugging?</p>\n</blockquote>\n<p>Sure, I think it should be possible to say which argument of which expression is at fault. Feel free to create an issue explaining how debugging this error can be difficult.</p>",
        "id": 460089332,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723471423
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Non-canonical.20instances.20kill.20where.20notation/near/460089018\">said</a>:</p>\n<blockquote>\n<p>What's the context of this? As far as I know, there is no plan to backtrack on this feature, so I'm not sure what you mean by \"where are we at in removing [it]\".</p>\n</blockquote>\n<p>Oh, when we talked about it in Bonn last September I had understood you had something in the works to make the new behavior useful against accidental noncanonical instances while allowing conscious ones. My understanding was along the lines of \"We only want to forbid simp from using non-canonical instances, but we instead forbid everyone (including the user). Let's not be so drastic.\".</p>",
        "id": 460091589,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723472162
    },
    {
        "content": "<p>Hmm, I remember talking about <code>simp</code>, though not the specifics. What ended up happening in the meantime is that <code>simp</code> now allows non-canonical instances via unification (in particular, it allows skipping synthesis resynthesis, which is also good for performance). For general elaboration though, it seems like relaxing this would create lots of confusing issues, so I would not expect to see it.</p>",
        "id": 460093147,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723472634
    },
    {
        "content": "<p>If I remember correctly, even Lean 3 was strict about this.</p>",
        "id": 460093270,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723472663
    },
    {
        "content": "<p>Here: <a href=\"https://github.com/leanprover-community/lean/blob/f91b574c40ad862c5134d48995ad083fe48e4cd4/src/frontends/lean/elaborator.cpp#L3633-L3634\">https://github.com/leanprover-community/lean/blob/f91b574c40ad862c5134d48995ad083fe48e4cd4/src/frontends/lean/elaborator.cpp#L3633-L3634</a></p>",
        "id": 460093465,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723472735
    },
    {
        "content": "<p>Interesting... that definitely disagrees with my (remembered) experience of Lean 3: <code>[]</code> arguments are unified if possible, and filled in by typeclass search if not</p>",
        "id": 460093812,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723472857
    },
    {
        "content": "<p>A compromise here might be to make these messages (disableable) warnings rather than errors</p>",
        "id": 460096713,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723473788
    },
    {
        "content": "<p>Yes, certainly it is strange that Lean tells me \"I can do this but I don't want to. Error.\" rather than just doing it + maybe warning me.</p>",
        "id": 460098187,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723474321
    },
    {
        "content": "<blockquote>\n<p>that definitely disagrees with my (remembered) experience of Lean 3</p>\n</blockquote>\n<p>I think we've collectively misremember this (I too thought this was a new Lean 4 feature for awhile), but perhaps we're just remembering that <code>simp</code> was more restrictive in Lean 4 until the changes I mentioned. I can't see anywhere that the Lean 3 elaborator would skip this defeq check.</p>\n<p>Eric's idea is interesting, and I think it's worth an RFC. I don't think we'll see disableable warnings, but I think we could see, perhaps, warnings in all contexts where <code>errToSorry</code> is true and errors where it's not, expanding the meaning of <code>errToSorry</code>.</p>",
        "id": 460104130,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723476081
    },
    {
        "content": "<p>Should I open a single RFC for both of mine and Eric's suggestion, or should they be two separate RFCs? The context and motivation are the same, but maybe they will be fixed separately.</p>",
        "id": 460106231,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723476880
    },
    {
        "content": "<p>Good question — I think yours could be an issue and Eric's suggestion could be a related RFC (or issue)? It's good to have usability issues clearly explained without any reference to a proposed solution. Eric's is on the edge between an issue and an RFC; the issue is that elaboration errors are getting in the way of debugging or otherwise working with the terms, and it's easily recoverable so there's no reason to be so strict.</p>",
        "id": 460107394,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723477294
    },
    {
        "content": "<blockquote>\n<p>I don't think we'll see disableable warnings,</p>\n</blockquote>\n<p>These are called linters, right?</p>",
        "id": 460107477,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723477323
    },
    {
        "content": "<p>A counterargument to relieving strict errors is that it can lead to compounding errors, and these can be confusing if you don't know the precipitating error.</p>",
        "id": 460107656,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723477373
    },
    {
        "content": "<p>I'm thinking of Yael's situation, where they'd prefer to write an \"I know what I'm doing\" command of some kind  rather than writing the ugly <code>(_)</code> thing.</p>",
        "id": 460107815,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723477420
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Certainly, but I don't mean whether disableable warnings are technically possible. I mean I doubt we'll see this be a disableable warning.</p>",
        "id": 460107823,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723477423
    },
    {
        "content": "<p>I take this back slightly — it's plausible (but still very unlikely anytime soon) that there could be a flag for instance metavariables that disables the defeq check. Then, there could be a term elaborator, like imagine <code>(with_relaxed_instances% {} : @Kernel α α noncanonical canonical)</code>, but given the fact that there are easy (even if slightly annoying) workarounds I would be surprised to see it implemented.</p>",
        "id": 460108575,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723477701
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/270676-lean4/topic/Non-canonical.20instances.20kill.20where.20notation/near/460107394\">said</a>:</p>\n<blockquote>\n<p>I think yours could be an issue and Eric's suggestion could be a related RFC (or issue)?</p>\n</blockquote>\n<p>I can't make a non-rfc non-bug issue though. Do you mean my suggestion should be a bug issue?</p>",
        "id": 460117165,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723480018
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/Non-canonical.20instances.20kill.20where.20notation/near/460117165\">said</a>:</p>\n<blockquote>\n<p>I can't make a non-rfc non-bug issue though.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/issues/new\">yes you can</a></p>",
        "id": 460117472,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723480091
    },
    {
        "content": "<p>(there is a \"create a blank issue\" button below the two you saw)</p>",
        "id": 460120319,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723480940
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5085\">lean#5085</a>, <a href=\"https://github.com/leanprover/lean4/pull/5086\">lean#5086</a></p>",
        "id": 463214025,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724004557
    }
]