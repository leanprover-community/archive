[
    {
        "content": "<p>How is simp meant to interact with local <code>let</code>s now? I know there were some changes fairly recently but the behaviour doesn't seem to make sense to me right now:</p>\n<p>I have two lets <code>c</code> and <code>d</code> in my local context, and <code>simp only</code> is unfolding <code>d</code> and not <code>c</code>, which is confusing behaviour to me. In particular this is annoying because I'd like to do the exact opposite (unfold <code>c</code> and not <code>d</code>), and I was hoping that <code>simp only [c]</code> would work, but it's going way too far.</p>\n<p>Here's an example with no dependency on mathlib</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span>\n</code></pre></div>\n<p>The simp only unfolds <code>d</code> but not <code>c</code>. What I actually wanted - in the original context - was to unfold <code>c</code> but not <code>d</code>, which I'd do with <code>simp only [c]</code>. But since <code>simp only</code> is unfolding <code>d</code> too, this breaks my proof idea. How can I use <code>simp</code> or variants on a goal like this?</p>",
        "id": 472463953,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727175375
    },
    {
        "content": "<p>The same thing happens when turning the config option <code>zeta</code> off too. zetaDelta says it's off by default, although this example seems to be exactly a zetaDelta reduction, but turning it off explicitly doesn't help either.</p>",
        "id": 472465198,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727175790
    },
    {
        "content": "<p>I'm surprised as well that <code>d</code> would be unfolded</p>",
        "id": 472465809,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1727176007
    },
    {
        "content": "<p>To make it even more surprising, changing <code>d</code> to <code>fun i =&gt; c i</code> returns the behaviour back to normal!</p>",
        "id": 472466144,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727176115
    },
    {
        "content": "<p>Mathlib has <code>unfold_let c</code>: does that do what you want?  It still does not answer why <code>simp</code> starts unfolding the latest <code>let</code>, but maybe it is good as a workaround.</p>",
        "id": 472466321,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727176178
    },
    {
        "content": "<p><del>Ah yeah this is a nice workaround in my context, thanks. (The workaround I was using was to <code>generalize</code> to force <code>simp only</code> not to unfold too far, but yours is cleaner!)</del> edit: unfortunately not, because I want to <code>simp only</code> with some other lemmas afterwards, and that one goes too far instead</p>",
        "id": 472466585,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727176259
    },
    {
        "content": "<p>Turning the <code>proj</code> option off does what you want in this case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">c</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I think it's a good idea to have the \"projection-reduction\" be aware of the <code>zetaDelta</code> (and <code>zeta</code>) options, and be more conservative if they are off.</p>",
        "id": 472481334,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727180768
    },
    {
        "content": "<p>maybe open an RFC?</p>",
        "id": 472481503,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727180815
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5455\">lean4#5455</a> (to keep things linked)</p>",
        "id": 472510901,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727188970
    },
    {
        "content": "<p>Oops sorry, meant to do this myself. Thanks!</p>",
        "id": 472510968,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727188988
    },
    {
        "content": "<p>Last time I investigated a similar issue the offending call to <code>whnf</code> is in <a href=\"https://github.com/leanprover/lean4/blob/a6f0112fc5c394af7ad4325199ccf6d44aa04aed/src/Lean/Meta/WHNF.lean#L576\"><code>project?</code></a> which is called in <a href=\"https://github.com/leanprover/lean4/blob/a6f0112fc5c394af7ad4325199ccf6d44aa04aed/src/Lean/Meta/WHNF.lean#L580\"><code>reduceProj?</code></a> which is called in <a href=\"https://github.com/leanprover/lean4/blob/a6f0112fc5c394af7ad4325199ccf6d44aa04aed/src/Lean/Meta/Tactic/Simp/Main.lean#L72\"><code>reduceProjFn?</code></a> which is part of the simplifier. I think that <code>whnf</code> call should inherit config from the simplifier. However I'm not sure what to do about <code>whnf</code> cache.</p>",
        "id": 472558833,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1727205544
    },
    {
        "content": "<p>The similar issue is that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">:=</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">*</span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n</code></pre></div>\n<p>reduces to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"n\">x</span>\n</code></pre></div>\n<p>instead of to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>with <code>zeta:=false</code></p>\n<p>I will reinvestigate this and comment on the GitHub issue.</p>",
        "id": 472559213,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1727205696
    }
]