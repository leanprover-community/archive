[
    {
        "content": "<p>I'd like to understand what is happening with error messages in the following code (which is a stripped-down version of the logic of the <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/LinearCombination.lean\">Mathlib <code>linear_combination</code> tactic</a>).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"tac1\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">))</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"tac2\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">norm</span><span class=\"o\">))</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- error here</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac1</span><span class=\"w\"> </span><span class=\"c1\">-- error here</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"c1\">-- \"hidden\" error</span>\n</code></pre></div>",
        "id": 464484185,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724362254
    },
    {
        "content": "<p>You need to have the \"ref\" set to some relevant syntax, to tag the components of the tactic with the source position from that ref.</p>\n<p>Here's acquiring the \"ref\" from the tactic syntax being elaborated.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"tac2\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">norm</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 464484396,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724362337
    },
    {
        "content": "<p>In the case of <code>tac2</code> here, the tactic is constructing the tactic sequence <code>rw [eq_comm]; rfl</code>, which doesn't solve the goal.  But there is no red underline on <code>tac2</code>.  Instead, there is a red underline on the <code>by</code>, but you can \"keep working\" on the proof for as long as you like, with no changes produced to the tactic state:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"c1\">-- \"hidden\" error</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- none of these sorries solve the goal</span>\n</code></pre></div>\n<p>I'm assuming that somehow the <code>Unhygienic.run</code> partially absorbs the error, although the error remains in whatever term is presented to the kernel.  Is that a correct interpretation?  And is there a workaround which \"preserves\" the error location?</p>",
        "id": 464484407,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724362343
    },
    {
        "content": "<p>The source position information inside the <code>norm</code> syntax will then be used for later error reporting.</p>",
        "id": 464484483,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724362385
    },
    {
        "content": "<p>By the way, you can use this to localize the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"tac2\"</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">norm</span><span class=\"o\">))</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"c1\">-- error only on tac2</span>\n</code></pre></div>",
        "id": 464484715,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724362496
    },
    {
        "content": "<p>Thanks!  I'm preparing the bugfix now, but can you suggest what to add to the test file?  The messages produced don't change, so <code>guard_msgs</code> doesn't work.</p>",
        "id": 464485103,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724362710
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16072\">#16072</a></p>",
        "id": 464486634,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724363536
    },
    {
        "content": "<p>I think probably for now just manually testing the error is where you want it is sufficient</p>",
        "id": 464489838,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365132
    },
    {
        "content": "<p>But agreed it would be nice to have a position-reporting version of <code>guard_msgs</code></p>",
        "id": 464489864,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Propagating.20errors.20through.20Unhygienic.2Erun/near/464489838\">said</a>:</p>\n<blockquote>\n<p>I think probably for now just manually testing the error is where you want it is sufficient</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Is there a way of doing that?</p>",
        "id": 464489867,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724365155
    },
    {
        "content": "<p>Manually testing? I mean open the file that tests for an error _somewhere_, and look at the red squiggle by eye!</p>",
        "id": 464489890,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365177
    },
    {
        "content": "<p>Ah ... I don't mean to ask how to check that the bugfix was working (I can see that it does!).  Rather, I was asking about what kind of test to add to the Mathlib test file for <code>linear_combination</code> (as is traditional after fixing a bug).</p>",
        "id": 464490037,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724365249
    },
    {
        "content": "<p>Yes, and my comment was \"I would be happy to merge it without such a test, since I think such a test is unreasonably hard to write!\"</p>",
        "id": 464490510,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365493
    },
    {
        "content": "<p>I think the way lean core handles this is to capture the stdout of lean, and compare it to a sample file</p>",
        "id": 464490551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365514
    },
    {
        "content": "<p>I don't think mathlib has the infrastructure for such tests, but I am happy to be proven wrong</p>",
        "id": 464490589,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365535
    },
    {
        "content": "<p>Perhap I'm missing something obvious here, but why do you need <code>Unhygienic.run</code> in the first place? Things seem to work fine in your mwe without it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"tac2\"</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">norm</span><span class=\"o\">))</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"tac2'\"</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq_comm</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">norm</span><span class=\"o\">))</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- error on this line</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tac2'</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"c1\">-- error on `tac2'`</span>\n</code></pre></div>",
        "id": 464490901,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724365700
    },
    {
        "content": "<p>It seems to work without it in the un-MWE'd code, too.  This line dates from <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>'s original code in <a href=\"https://github.com/leanprover-community/mathlib4/pull/605\">#605</a> -- Mario, do you remember what the <code>Unhygienic.run</code> is doing there?</p>",
        "id": 464491724,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724366133
    },
    {
        "content": "<p>If a syntax quotation doesn't need hygiene, I think it is more hygienic to use <code>Unhygienic.run</code> so that you can get the value as a pure value and not a monadic one. In particular, that makes it eligible for closed term extraction, unlike monadic syntax quotations.</p>",
        "id": 464491995,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724366288
    },
    {
        "content": "<p>I could see extending <code>#guard_msgs</code> to include relative source position information, with some option set. That would help here, right <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> ?</p>\n<p>(By the way, in core Lean's testing framework, there are interactive tests that use comments to pick out information that appears at particular source positions. <a href=\"https://github.com/leanprover/lean4/blob/master/tests/lean/interactive/4880.lean#L18\">Example source</a>, <a href=\"https://github.com/leanprover/lean4/blob/master/tests/lean/interactive/4880.lean.expected.out\">example out</a>)</p>",
        "id": 464493237,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724366670
    },
    {
        "content": "<p>Yes, seems like it!</p>",
        "id": 464493504,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724366742
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, since you agree with Mario's advice, could you PR a small docstring for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Unhygienic.run#doc\">docs#Lean.Unhygienic.run</a> to explain that use-case?</p>",
        "id": 464494092,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724366885
    },
    {
        "content": "<p>(documentation PRs from non-FRO members tend to get stuck on things like this, c.f. borrow notation)</p>",
        "id": 464494307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724366947
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Propagating.20errors.20through.20Unhygienic.2Erun/near/464494307\">said</a>:</p>\n<blockquote>\n<p>(documentation PRs from non-FRO members tend to get stuck on things like this, c.f. borrow notation)</p>\n</blockquote>\n<p>I see multiple unresolved questions in that PR and have thus marked it as <code>awaiting-author</code> now. Do you disagree with that?</p>",
        "id": 464638532,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724415993
    },
    {
        "content": "<blockquote>\n<p>Do you disagree with that?</p>\n</blockquote>\n<p>Yes, I think I'm waiting a ruling from the FRO on whether I should take David or Mac's suggestion. My point above was that if either of them owned the PR, then presumably such a ruling would be easier to arrive at internally.</p>",
        "id": 464642544,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724417108
    },
    {
        "content": "<p>But that was only one out of three open threads, with no response from you. The PR looked quite abandoned. Your new comments look much more helpful for leading this PR to a conclusion. I removed the label.</p>",
        "id": 464643845,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724417488
    }
]