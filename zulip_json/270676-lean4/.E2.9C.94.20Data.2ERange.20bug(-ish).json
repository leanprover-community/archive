[
    {
        "content": "<p>I am reading through the codebase on how <code>ForIn</code> and Range work, and I think found a \"bug\":  Because <code>Range</code> doesn't do any checking on construction that <code>step != 0</code>,  it's entirely driven by \"fuel\" and hence the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ii</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{ii} \"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>results in the output</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>I am happy to work on a fix if it's deemed this is not desirable.</p>",
        "id": 472814183,
        "sender_full_name": "Tom",
        "timestamp": 1727326428
    },
    {
        "content": "<p>Any thoughts?  This has \"scrolled off\" the main topic list for me now.</p>",
        "id": 473165035,
        "sender_full_name": "Tom",
        "timestamp": 1727457184
    },
    {
        "content": "<p>I think you can at least open an issue about it</p>",
        "id": 473165654,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727457329
    },
    {
        "content": "<p>Batteries has theorems that describe <a href=\"https://github.com/leanprover-community/batteries/blob/e0b13c946e9c3805f1eec785c72955e103a9cbaf/Batteries/Data/Range/Lemmas.lean#L14-L15\">precisely this behavior</a>. What alternative do you propose?</p>",
        "id": 473254842,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727482108
    },
    {
        "content": "<p>I don't propose anything.  I am not familiar with Batteries, since I'm only just learning and just using Lean from VSCode.  The above behavior seemed incorrect, I received no errors or warnings so I reported it.</p>\n<p>If my understanding is correct, I guess one thing that could be done is to add <code>isNZ: step != 0</code> to <code>Range</code>?</p>",
        "id": 473361234,
        "sender_full_name": "Tom",
        "timestamp": 1727539455
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> </p>\n<p>I don't fully understand Mario's explanation (or how to avoid the issue) but it sounds like he thinks it's not a problem.  Would you like me to still file a bug?</p>",
        "id": 473361674,
        "sender_full_name": "Tom",
        "timestamp": 1727539774
    },
    {
        "content": "<p>What I'm saying is that when you describe it as incorrect behavior, that implies that you expected to see something different. What did you expect?</p>",
        "id": 473363137,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727540825
    },
    {
        "content": "<p>Ideally for that not to compile?  So that e.g. <code>[0:n]</code> works but <code>[0:n:s]</code> would require a proof that <code>s != 0</code>?<br>\nI'm not sure if I'm thinking about it the right way.</p>",
        "id": 473363634,
        "sender_full_name": "Tom",
        "timestamp": 1727541210
    },
    {
        "content": "<p>Adding <code>step != 0</code> would also most likely result in surprising behavior, because e.g. <code>[start:stop:step]</code> syntax has no place for a proof and so it would probably totalize in some other garbage way, for example by setting <code>step</code> to 1 instead of 0. I think the most reasonable behavior for this case is to just produce the empty list, but the current behavior where it has some behavior but we don't really care because it's a garbage input is also okay to me.</p>",
        "id": 473363644,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727541224
    },
    {
        "content": "<p>When you say \"it has not place for a proof\", couldn't this be similar to something like array indexing, i.e. <code>arr[ii]'h</code>?  Looking at the source for <code>Range.lean</code>, I see the syntax does't exist at the moment but I'm not sure whether you're saying it's not possible for some other reason?</p>",
        "id": 473363931,
        "sender_full_name": "Tom",
        "timestamp": 1727541436
    },
    {
        "content": "<p>it could, sure, but I try to avoid proofs in the middle of programming code if it is at all possible to do so. In particular this would complicate any usage of ranges where the step is not a constant</p>",
        "id": 473364221,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727541659
    },
    {
        "content": "<p>Note also that there have been discussions about eliminating the step argument entirely and simplifying it to just step 1</p>",
        "id": 473364271,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727541707
    },
    {
        "content": "<p>I hear you on the programming aspect.  I am mostly interested in programming in Lean so I'm definitely keen on keeping things \"simple, but no simpler\".</p>\n<p>However, my experience with designing APIs it telling me that it seems that for something like this, perhaps Lean shouldn't be \"deciding the policy\" here?  What I mean is, and borrowing from the array notation, Lean has <code>[]!</code> and <code>[]'h</code> and it's up to the user to select the \"level of guarantee\" they require in their code.  I can imagine writing e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ii</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"c1\">-- probably common</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">step</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ii</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">step</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">exception</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>and also</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">ii</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">x</span><span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"c1\">-- I know better</span>\n</code></pre></div>\n<p>What do you think?</p>",
        "id": 473371222,
        "sender_full_name": "Tom",
        "timestamp": 1727547021
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> </p>\n<p>Regarding the above:  Should I file an issue?  Or just close this discussion?  Please LMK what would be most helpful.  Thanks!</p>",
        "id": 473864632,
        "sender_full_name": "Tom",
        "timestamp": 1727732389
    },
    {
        "content": "<p>I'm not the one to make the call on that</p>",
        "id": 473864814,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727732436
    },
    {
        "content": "<p>Ok, I'll file an issue.  From our discussion above, I got the feeling you perhaps felt the current behavior is ok/fine and I didn't want to file something which is not going to get any traction.</p>\n<p>Thanks.</p>",
        "id": 473865152,
        "sender_full_name": "Tom",
        "timestamp": 1727732539
    },
    {
        "content": "<p>Note by the way that the current behavior of <code>[a:b:c]</code> doesn't match any of your three syntaxes, which respectively auto-prove the assumption, take a manual proof and assert if it doesn't hold, while the current behavior is to not check at all and yield a garbage value instead</p>",
        "id": 473865214,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727732557
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> has marked this topic as resolved.</p>",
        "id": 473868271,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727733607
    }
]