[
    {
        "content": "<p>What is the memory layout for the <code>forallE</code> case of <code>Expr</code>? From what I have seen, <code>lean_ctor_get(e, 0)</code> (resp. 1, 2) correspond to then name, domain, and codomain, but how can I get the <code>BinderInfo</code>?</p>\n<p>I tried to get the binder info by querying <code>lean_ctor_scalar_cptr(p)[0]</code>, but the number I got was 219, while there are only 4 variants of <code>BinderInfo</code>.</p>",
        "id": 453333376,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1721713892
    },
    {
        "content": "<p><code>BinderInfo</code> is a simple enum type, so it is stored in the scalar data</p>",
        "id": 453345516,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721719636
    },
    {
        "content": "<p>Here's a simple experimental way to find out what the compiler thinks about any getter or setter function:</p>\n<p><code>Foo.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">bi</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">bi</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span>\n</code></pre></div>\n<p>resulting <code>Foo.c</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">l_foo</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">lean_obj_tag</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">;</span>\n<span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_ctor_get_uint8</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">);</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"k\">else</span>\n<span class=\"p\">{</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>so you have to check for tag 7 and then use <code>lean_ctor_get_uint8(x_1, sizeof(void*)*3 + 8)</code> to get the value out</p>",
        "id": 453346027,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721719867
    },
    {
        "content": "<p>It's +8 because there is a hidden UInt64 field for storing the <code>@[computed_field] data : Data</code></p>",
        "id": 453346327,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721720005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/Memory.20layout.20of.20.60Expr.60/near/453346327\">said</a>:</p>\n<blockquote>\n<p>It's +8 because there is a hidden UInt64 field for storing the <code>@[computed_field] data : Data</code></p>\n</blockquote>\n<p>I see. I read the FFI manual again and found out about this. I didn't know computed field gets lumped together with the expr</p>",
        "id": 453348516,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1721720860
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> has marked this topic as resolved.</p>",
        "id": 453349042,
        "sender_full_name": "Notification Bot",
        "timestamp": 1721721050
    }
]