[
    {
        "content": "<p>I'm a bit confused on how am I supposed to work with <code>extern</code> function that is <code>static inline</code> on C level similar to function like <code>lean_float_array_uget</code>.</p>\n<p>The way it seems to work is:</p>\n<p>Have <code>bytearray.c</code> with the function without <code>static inline</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span><span class=\"o\">(</span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">){</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">double</span><span class=\"bp\">*</span><span class=\"o\">)(</span><span class=\"n\">lean_sarray_cptr</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)))[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p><strong>and</strong> have <code>bytearray.h</code> with <code>static inline</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span><span class=\"o\">(</span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">){</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">double</span><span class=\"bp\">*</span><span class=\"o\">)(</span><span class=\"n\">lean_sarray_cptr</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)))[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>and add <code>moreLeancArgs := #[\"-include\", \"./C/bytearray.h\"]</code> to my project. Is this the intended way of doing this? Without the <code>bytearray.c</code> I get linker error complaining about undefined reference <code>scilean_byte_array_uget_float</code>.</p>",
        "id": 504963999,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741729760
    },
    {
        "content": "<p>A hacky option might be to put <code>__attribute__((used))</code> on the declaration in the header (and include it in the C file), though this is GCC-only</p>",
        "id": 504964674,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741730002
    },
    {
        "content": "<p>Doesn't Lean use clang now by default?</p>",
        "id": 504964839,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741730052
    },
    {
        "content": "<p>You need it in the c file one way or another because of callers that go from lean via <code>dlsym</code>, which needs the symbol to existing in the static library</p>",
        "id": 504964854,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741730057
    },
    {
        "content": "<p><a href=\"https://clang.llvm.org/docs/AttributeReference.html#used\">https://clang.llvm.org/docs/AttributeReference.html#used</a> suggests <code>used</code> is in clang too</p>",
        "id": 504964968,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741730105
    },
    {
        "content": "<p>Yeah that makes sense, so current approach is likely the right one.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/extern.20static.20inline.20function/near/504964674\">said</a>:</p>\n<blockquote>\n<p>A hacky option might be to put <code>__attribute__((used))</code> on the declaration in the header (and include it in the C file), though this is GCC-only</p>\n</blockquote>\n<p>What is this supposed to solve? I don't understand what is this mean to do.</p>",
        "id": 504965836,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741730374
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 504968073,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741731090
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504968073\">said</a>:</p>\n<blockquote>\n<p>(deleted)</p>\n</blockquote>\n<p>Not sure how to use <code>extern c inline</code> but this works </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">inline</span><span class=\"w\"> </span><span class=\"s2\">\"((double*)(lean_sarray_cptr(#1)))[#2]\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">ugetFloat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"bp\">*</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span>\n</code></pre></div>",
        "id": 504968921,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741731378
    },
    {
        "content": "<p>Concretely, my proposal was</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"c1\">// in bytearray.h</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;lean/lean.h&gt;</span>\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"kr\">inline</span><span class=\"w\"> </span><span class=\"kt\">double</span><span class=\"w\"> </span><span class=\"nf\">scilean_byte_array_uget_float</span><span class=\"p\">(</span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">used</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">double</span><span class=\"o\">*</span><span class=\"p\">)(</span><span class=\"n\">lean_sarray_cptr</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">)))[</span><span class=\"n\">i</span><span class=\"p\">];</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"c1\">// in bytearray.c</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;lean/lean.h&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">\"bytearray.h\"</span>\n</code></pre></div>",
        "id": 504969003,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731412
    },
    {
        "content": "<p>It solves the problem of the function being written twice</p>",
        "id": 504969062,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731432
    },
    {
        "content": "<p>It doesn't make sense to have it in both .c and .h, I think that just shows that your header file is currently unused. There is no way currently to add new includes to the generated C files.</p>",
        "id": 504969158,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741731473
    },
    {
        "content": "<p>It would make sense to have it in both <em>if</em> it was included in generated C files, right?</p>",
        "id": 504969378,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731548
    },
    {
        "content": "<p>The compiler flag <code>-include</code> has to work to include h file to generated c files. I'm getting 10x speed up in my code when I add it.</p>",
        "id": 504969454,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741731584
    },
    {
        "content": "<p><del>Is <code>-include</code> just  an alias for <code>-I</code>?</del> I assume <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> confused these the way I did. <code>-include</code> literally pastes <code>#include</code> in the file</p>",
        "id": 504969554,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731616
    },
    {
        "content": "<p>That's good to hear, I had to look that up just now. Then really you should find out where that undefined reference is coming from</p>",
        "id": 504969666,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741731662
    },
    {
        "content": "<p>It would be from the <code>dlsym</code> from the interpreter, I assume?</p>",
        "id": 504969720,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731681
    },
    {
        "content": "<p>That would not be a linker error</p>",
        "id": 504969777,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741731705
    },
    {
        "content": "<p>And it's not how the interpreter works iirc</p>",
        "id": 504969851,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1741731723
    },
    {
        "content": "<p>Ah, I did not se the word linker</p>",
        "id": 504969867,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731727
    },
    {
        "content": "<p>The interpreter <a href=\"https://github.com/leanprover/lean4/blob/589eff6187264addd6922fd87975daa10828b34d/src/library/compiler/ir_interpreter.cpp#L337\">definitely uses</a> <code>dlsym</code> to pick up <code>@[extern]</code>s</p>",
        "id": 504969934,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731758
    },
    {
        "content": "<p>Even if I have <code>precompiledModules:=true</code>?</p>",
        "id": 504970059,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741731808
    },
    {
        "content": "<p>What if you call a function in the same file it was defined? The module hasn't yet been precompiled in that case.</p>",
        "id": 504970138,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731827
    },
    {
        "content": "<p>Can you share the full linker error?</p>",
        "id": 504970268,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741731852
    },
    {
        "content": "<p>The linker error happens only if I have only the <code>bytearray.c</code> file and in there the function is marked <code>static inline</code></p>",
        "id": 504970949,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741731996
    },
    {
        "content": "<p>The error is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_SciLean_DataArrayN_iget2</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_SciLean_DataArrayN_iget2___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_ByteArray_iget2___rarg</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">times</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0/bin/clang' exited with code 1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 504971124,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732036
    },
    {
        "content": "<p>That's expected, since the function won't survive as static in the C file alone (without <code>used</code>, anyway)</p>",
        "id": 504971706,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741732161
    },
    {
        "content": "<p>What happens if you only have the <code>.h</code> file?</p>",
        "id": 504971718,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741732167
    },
    {
        "content": "<p>Yes the <code>.h</code> file + <code>-include</code> flag works fine</p>",
        "id": 504971831,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732203
    },
    {
        "content": "<p>Ohh sorry you said only the <code>.h</code> file, let me try.</p>",
        "id": 504971916,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732231
    },
    {
        "content": "<p>That gives me</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">SciLean</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_ByteArray_ugetFloat___boxed</span><span class=\"o\">)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0/bin/clang' exited with code 1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 504972078,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732287
    },
    {
        "content": "<p>Oh wait I added <code>-include</code> flag only to a separate <code>lean_exe</code> but I should add it to the whole project.</p>",
        "id": 504972277,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732351
    },
    {
        "content": "<p>Ok only <code>.h</code> file works too. </p>\n<p>I have to add <code>-include</code> to the whole project</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">SciLean</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">roots</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`SciLean</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">moreLeancArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-include\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"./C/bytearray.h\"</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>and in the <code>.h</code> file it is important to add <code>#pragma once</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">pragma</span><span class=\"w\"> </span><span class=\"n\">once</span>\n<span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span><span class=\"o\">(</span><span class=\"n\">b_lean_obj_arg</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size_t</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">){</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">double</span><span class=\"bp\">*</span><span class=\"o\">)(</span><span class=\"n\">lean_sarray_cptr</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)))[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 504972736,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732533
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504970138\">said</a>:</p>\n<blockquote>\n<p>What if you call a function in the same file it was defined? The module hasn't yet been precompiled in that case.</p>\n</blockquote>\n<p>Are you able to test this?</p>",
        "id": 504973110,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741732661
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504972736\">said</a>:</p>\n<blockquote>\n<p>I have to add <code>-include</code> to the whole project</p>\n</blockquote>\n<p>And every downstream project too, unless you provide the C file as well</p>",
        "id": 504973257,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741732703
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504973257\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504972736\">said</a>:</p>\n<blockquote>\n<p>I have to add <code>-include</code> to the whole project</p>\n</blockquote>\n<p>And every downstream project too, unless you provide the C file as well</p>\n</blockquote>\n<p>For this reason I'm going with <code>@[extern c inline \"((double*)(lean_sarray_cptr(#1)))[#2]\"]</code></p>",
        "id": 504973398,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732763
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504973110\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504970138\">said</a>:</p>\n<blockquote>\n<p>What if you call a function in the same file it was defined? The module hasn't yet been precompiled in that case.</p>\n</blockquote>\n<p>Are you able to test this?</p>\n</blockquote>\n<p>Does not work</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">ugetFloat'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">l_ByteArray_ugetFloat___boxed'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">l_ByteArray_ugetFloat'</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Std</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">relevant</span><span class=\"w\"> </span><span class=\"ss\">`lean_exe</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"ss\">`lakefile.lean</span><span class=\"bp\">`.</span>\n</code></pre></div>",
        "id": 504973467,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741732794
    },
    {
        "content": "<p>Does it work with <a href=\"\">the empty C file with <code>__attribute__((used))</code>?</a></p>",
        "id": 504973647,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741732843
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/extern.20static.20inline.20function/near/504973647\">said</a>:</p>\n<blockquote>\n<p>Does it work with <a href=\"\">the empty C file with <code>__attribute__((used))</code>?</a></p>\n</blockquote>\n<p>I tried this without the <code>-include</code> flag it it failed again with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">scilean_byte_array_uget_float</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_SciLean_DataArrayN_iget2</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_SciLean_DataArrayN_iget2___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">examples</span><span class=\"bp\">/</span><span class=\"n\">KMeansProfile</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_ByteArray_iget2___rarg</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">times</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">tskrivan</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0/bin/clang' exited with code 1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">KMeansProfile</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 504974607,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741733122
    },
    {
        "content": "<p>Interestingly enough I'm still getting 60% slower code using <code>ByteArray.ugetFloat</code> compared to <code>FloatArray.uget</code> for some reason :(</p>",
        "id": 504974945,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741733222
    },
    {
        "content": "<p>In that example are you compiling the <code>bytearray.c</code> file somehow?</p>",
        "id": 504976723,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741733889
    },
    {
        "content": "<p>Yes I think so, my current set up should gobble up all <code>.c</code> files in <code>./C/</code> directory.</p>",
        "id": 504976929,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1741733972
    }
]