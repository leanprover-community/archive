[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isAndNil</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Prop</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">li</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">li</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- invalid match-expression, type of pattern variable 'match_eq✝' contains metavariables</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>Can someone please explain why I am getting this error?</p>",
        "id": 507957779,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1742891849
    },
    {
        "content": "<p><code>return</code> (and <code>let mut</code>) is not supported inside Qq matches, because supporting it would require changes to <code>do</code> notation in Lean itself</p>",
        "id": 507987330,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742899607
    },
    {
        "content": "<p>(<code>match_expr</code>, while much less powerful, is immune to this problem precisely because <code>do</code> notation was modified to support it)</p>",
        "id": 507987594,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742899687
    },
    {
        "content": "<p>For your example, using <code>pure</code> will likely fix it</p>",
        "id": 507987670,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742899713
    },
    {
        "content": "<p>I just opened this in Lean - I'm wrong, there's something else happening here!</p>",
        "id": 507997799,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742902612
    },
    {
        "content": "<p>Yeah, and replacing <code>return</code> with <code>pure</code> doesn't work. It works if I swap the match blocks though.</p>",
        "id": 508007753,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1742905454
    },
    {
        "content": "<p>The issue seems to be that Qq is not solving for the first <code>u : Level</code> argument of QuotedDefEq</p>",
        "id": 508013653,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742907107
    },
    {
        "content": "<p>So, is there any workaround? Is it the problem with <code>do</code> blocks inside Qq?</p>",
        "id": 508766571,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1743171455
    },
    {
        "content": "<p>I think this is <a href=\"https://github.com/leanprover-community/quote4/issues/30\">https://github.com/leanprover-community/quote4/issues/30</a></p>",
        "id": 508767219,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743171602
    },
    {
        "content": "<p>So <code>match (generalizing := false) li with</code> is the workaround</p>",
        "id": 508767483,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743171667
    },
    {
        "content": "<p>Thanks! I think it's time for me to learn Qq's internals... I've really enjoyed using it, and I want to give back. Maybe by fixing this issue <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 508778706,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1743174570
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"552388\">Vasilii Nesterov</span> has marked this topic as resolved.</p>",
        "id": 508778817,
        "sender_full_name": "Notification Bot",
        "timestamp": 1743174602
    }
]