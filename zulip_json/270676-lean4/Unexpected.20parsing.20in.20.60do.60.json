[
    {
        "content": "<p>Here is some parsing behavior that might be a bit unexpected:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- succeeds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>Likewise, replacing <code>by exact true</code> with <code>return true</code> also succeeds, but in that case at least the unused variables linter fires on <code>c</code>. (Perhaps the silence of the unused variables linter here is its own issue.)</p>\n<p>The context I noticed this in was trying to use <code>by exact?</code> to fill in a proof argument, which was shaped like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"c1\">-- autogenerated `Unit` hypothesis in practice</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact?</span><span class=\"w\"> </span><span class=\"c1\">-- Try this: [apply] exact this</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 561251495,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764615484
    },
    {
        "content": "<p>You always need to use <code>&lt;|</code> in front of <code>by</code>. Then you get the expected behaviour.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 561259358,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764618005
    },
    {
        "content": "<p>My point is that I don't think that should be the case. :)</p>",
        "id": 561259444,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618037
    },
    {
        "content": "<p>A quick search shows about 4000 occurrences of <code>&lt;| by</code> in mathlib. So I guess with your proposed change, these can all be replaced with <code>by</code>?</p>",
        "id": 561259755,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764618147
    },
    {
        "content": "<p>It would make sense, because the <code>&lt;|</code> in <code>&lt;| do</code> is redundant, and I feel like <code>do</code> and <code>by</code> should do the same precedence-wise.</p>",
        "id": 561259949,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764618222
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Unexpected.20parsing.20in.20.60do.60/near/561259755\">said</a>:</p>\n<blockquote>\n<p>A quick search shows about 4000 occurrences of <code>&lt;| by</code> in mathlib. So I guess with your proposed change, these can all be replaced with <code>by</code>?</p>\n</blockquote>\n<p>I would expect so! :)</p>\n<p>Though admittedly I don't have an actual change to propose (yet). It's quite possible that this has already been tried and is infeasible or not worth the squeeze for certain parsing reasons; I haven't checked.</p>",
        "id": 561260238,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618275
    },
    {
        "content": "<p>Though given your observation about <code>do</code>, it seems that maybe one route is just making <code>by</code> the same as <code>do</code> precedence-wise? Is that the implication?</p>",
        "id": 561260396,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618340
    },
    {
        "content": "<p>I guess an important point here would also be the difference between</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">  error -/</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 561260498,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1764618378
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Unexpected.20parsing.20in.20.60do.60/near/561260396\">said</a>:</p>\n<blockquote>\n<p>It seems that maybe one route is just making <code>by</code> the same as <code>do</code> precedence-wise?</p>\n</blockquote>\n<p>Yes, I think this should be a reasonably straight forward change</p>",
        "id": 561260840,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764618507
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Unexpected.20parsing.20in.20.60do.60/near/561260498\">said</a>:</p>\n<blockquote>\n<p>I guess an important point here would also be the difference between</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">  error -/</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>and</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Oh, I see. So is this issue restricted to <code>by</code> as a <code>doElem</code>? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 561260991,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618565
    },
    {
        "content": "<p>It seems there's some issue within <code>by</code> blocks as well:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- unexpected token 'by'; expected command</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 561261248,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/270676-lean4/topic/Unexpected.20parsing.20in.20.60do.60/near/561260991\">said</a>:</p>\n<blockquote>\n<p>Oh, I see. So is this issue restricted to <code>by</code> as a <code>doElem</code>? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>\n</blockquote>\n<p>Nevermind--after looking at the syntax tree, it seems there is no special <code>by</code> <code>doElem</code> parser. It is indeed just interpreting <code>by exact true</code> as a term, the same as if you'd written <code>true</code> (up to this precedence difference).</p>",
        "id": 561261934,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764618910
    },
    {
        "content": "<p>The following is written in the lean source code.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Maximum precedence used in term parsers, in particular for terms in</span>\n<span class=\"sd\">function position (`ident`, `paren`, ...)</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"max\"</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span>\n<span class=\"sd\">/-- Precedence used for application arguments (`do`, `by`, ...). -/</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"arg\"</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1023</span><span class=\"o\">)</span>\n<span class=\"sd\">/-- Precedence used for terms not supposed to be used as arguments (`let`, `have`, ...). -/</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"lead\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1022</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>It claims that <code>by</code> has the <code>arg</code> precedence, but this is not true, because <code>by</code> currently has the <code>lead</code> precedence, not the <code>arg</code> precedence.</p>\n<p>This commit changed the precedence of <code>by</code> from <code>max</code> to <code>lead</code>: <a href=\"https://github.com/leanprover/lean4/commit/05e6a779ba7b44f61543ba3f8369d50584e0d74b\">https://github.com/leanprover/lean4/commit/05e6a779ba7b44f61543ba3f8369d50584e0d74b</a></p>\n<p>The reason stated in that commit was that there were issues with the <code>have A by B</code> notation. This problem should also apply to the <code>show A by B</code> term, and the <code>suffices A by B</code> tactic.</p>\n<p>However, we all know that it is possible to write <code>for A in B do</code> without any problem. The reason it that the <code>for</code> notation uses a trick: instead of parsing <code>B</code> with <code>termParser</code>, the notation uses <code>withForbidden \"do\" termParser</code>.</p>\n<p>The same workaround could be used for <code>by</code> to make <code>suffices A by B</code>etc. keep working.</p>",
        "id": 561265991,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764620268
    },
    {
        "content": "<p>Very nice! :)</p>",
        "id": 561267943,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1764620977
    },
    {
        "content": "<p>Yes, please, I've been wanting to get rid of all those <code>&lt;| by</code> in mathlib for a long long time</p>",
        "id": 561268615,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1764621221
    },
    {
        "content": "<p>I made a draft PR (<a href=\"https://github.com/leanprover/lean4/pull/11455\">lean#11455</a>), and the corresponding mathlib build failed in only one place, for which the fix is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/32342\">#32342</a>.</p>",
        "id": 561323272,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764650090
    }
]