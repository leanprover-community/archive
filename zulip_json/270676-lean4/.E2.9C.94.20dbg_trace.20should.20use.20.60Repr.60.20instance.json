[
    {
        "content": "<p>The current implementation of <code>dbg_trace</code> uses <code>ToString</code> instances, but I believe it should use <code>Repr</code> instances instead.</p>\n<p>There are two reasons for this:</p>\n<ul>\n<li><strong>ToString cannot be derived.</strong> It is inconvenient to implement a <code>ToString</code> instance solely for debugging purposes. In contrast, <code>Repr</code> can be derived, allowing for an implementation where a <code>Repr</code> instance is automatically generated if it does not already exist, similar to how <code>#eval</code> works when using <code>dbg_trace</code>.</li>\n<li><strong>ToString is not well-suited for debugging.</strong> It does not emphasize the differences between elements clearly enough for debugging purposes. For example, consider the following case:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> toString: \"hello\"</span>\n<span class=\"cm\">reprStr: \"\\\"hello\\\"\" -/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\\"</span><span class=\"s2\">hello</span><span class=\"se\">\\\"</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"toString: {a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"reprStr: {reprStr a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> toString: hello</span>\n<span class=\"cm\">reprStr: \"hello \" -/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"hello \"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"toString: {a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"reprStr: {reprStr a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>I would like to hear your opinion.</p>\n<p>related topic: <a href=\"#narrow/channel/270676-lean4/topic/why.20.60dbg_trace.60.20needs.20.60ToString.60.20instance.3F\">why <code>dbg_trace</code> needs <code>ToString</code> instance?</a></p>",
        "id": 495082575,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737473307
    },
    {
        "content": "<p>Are you suggesting interpolated string literals should work differently inside <code>dbg_trace</code> than in any other context? I don't think that is advisable.</p>",
        "id": 495114235,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737482199
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> </p>\n<p>Thank you for pointing out interpolated string..</p>\n<p>How about having another interpolated string syntax for dbg_trace, like d!””</p>",
        "id": 495161880,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737501134
    },
    {
        "content": "<p>Are you asking for <code>dbg_trace f!\"{a}\"</code> to work?</p>",
        "id": 495161990,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737501189
    },
    {
        "content": "<p><code>f!</code> uses <code>repr</code> by default</p>",
        "id": 495162009,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737501195
    },
    {
        "content": "<p>I have not known f!<br>\nIt seems to be nice.</p>",
        "id": 495162153,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737501244
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/channel/270676-lean4/topic/dbg_trace.20should.20use.20.60Repr.60.20instance/near/495082575\">said</a>:</p>\n<blockquote>\n<p><strong>ToString cannot be derived</strong></p>\n</blockquote>\n<p>That is a strong statement. Is there some reason they cannot be derived that I'm missing, or do you mean that currently no deriving handler for <code>ToString</code>?</p>",
        "id": 495176015,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737508434
    },
    {
        "content": "<p>I mean currently we have no deriving handler. ( and I think we should not have deriving handler for String)</p>",
        "id": 495179364,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737510252
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> </p>\n<p>How about defining a new syntax <code>d!</code> as shown below? I think it would be easier than inserting <code>reprStr</code> every time.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"d!\"</span><span class=\"w\"> </span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"n\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">interpStr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">interpStr.expandInterpolatedStr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reprStr</span><span class=\"o\">))</span>\n\n\n<span class=\"k\">#eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"world!  \"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">reprStr</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">!</span><span class=\"s2\">\"Hello, {x}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 495685650,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737715811
    },
    {
        "content": "<p>I don't understand why you're not just using <code>f!</code></p>",
        "id": 495688606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737716748
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> </p>\n<p>Thank you for telling me about <code>f!</code>. However, when I tried it, the behavior of <code>f!</code> wasn't what I was looking for.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">f!: Hello, hello</span>\n<span class=\"cm\">reprStr: Hello, \"hello \"</span>\n\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"hello \"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">f!</span><span class=\"s2\">\"f!: Hello, {a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"reprStr: Hello, {reprStr a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 495707958,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737723378
    },
    {
        "content": "<p><code>f!\"Hello, {repr a}\"</code> is a little shorter at least</p>",
        "id": 495708531,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737723583
    },
    {
        "content": "<p>By the way, why my <code>d!</code> macro generate too many double quotations?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">\"d!: Hello, \"\"hello \"\"\"</span>\n\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"hello \"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d!</span><span class=\"s2\">\"d!: Hello, {a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 495708986,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737723722
    },
    {
        "content": "<blockquote>\n<p><code>f!\"Hello, {repr a}\"</code> is a little shorter at least</p>\n</blockquote>\n<p>This might be a good idea. However, I am interested in whether or not the “d! macro” can be made and work well...</p>",
        "id": 495709781,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737723985
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/channel/270676-lean4/topic/dbg_trace.20should.20use.20.60Repr.60.20instance/near/495708986\">said</a>:</p>\n<blockquote>\n<p>By the way, why my <code>d!</code> macro generate too many double quotations?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">\"d!: Hello, \"\"hello \"\"\"</span>\n\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"hello \"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d!</span><span class=\"s2\">\"d!: Hello, {a}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This is <code>\"d!: Hello, \"</code> ++ <code>a</code> ++ <code>\"\"</code></p>",
        "id": 495710710,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737724291
    },
    {
        "content": "<p>That is, <code>reprStr \"d!: Hello, \" ++ reprStr a ++ reprStr \"\"</code></p>",
        "id": 495711041,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737724384
    },
    {
        "content": "<blockquote>\n<p>That is, <code>reprStr \"d!: Hello, \" ++ reprStr a ++ reprStr \"\"</code></p>\n</blockquote>\n<p>I see... Thank you <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> !</p>",
        "id": 495711183,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737724428
    },
    {
        "content": "<p>So fundamentally <code>expandInterpolatedStr </code> cannot tell the difference between <code>foo{x}</code> and <code>{\"foo\"}{x}</code>?</p>",
        "id": 495711260,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737724444
    },
    {
        "content": "<p>Which means it cannot implement what Asei is asking for</p>",
        "id": 495711299,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737724458
    },
    {
        "content": "<p>Probably it would be reasonable to modify it such that it takes separate handlers for literal strings vs interpolated variables that happen to be strings, by changing <a href=\"https://github.com/leanprover/lean4/blob/128a1e6b0a82718382f9c39c79be44ff3284547c/src/Init/Meta.lean#L1324\">this line</a></p>",
        "id": 495711487,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737724521
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> </p>\n<p>nice!!! Thank you!!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">expandInterpolatedStrChunks'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAppend</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkElem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">elem</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">elem</span><span class=\"bp\">.</span><span class=\"n\">isInterpolatedStrLit?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">     </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkElem</span><span class=\"w\"> </span><span class=\"n\">elem</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">str</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">elem</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppend</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">elem</span>\n<span class=\"w\">    </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">Compat</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">expandInterpolatedStr'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">interpStr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">interpolatedStrKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toTypeFn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">expandInterpolatedStrChunks'</span><span class=\"w\"> </span><span class=\"n\">interpStr</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">toTypeFn</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">))</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"d!\"</span><span class=\"w\"> </span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">d!</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">interpStr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">interpStr</span><span class=\"bp\">.</span><span class=\"n\">expandInterpolatedStr'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reprStr</span><span class=\"o\">))</span>\n\n<span class=\"kn\">section</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ## test for ambiguous string</span>\n\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  d!: Hello, \"world \"</span>\n<span class=\"cm\">  d!: Hello, \"\\\"world\\\"\"</span>\n\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"world \"</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d!</span><span class=\"s2\">\"d!: Hello, {a}\"</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\\"</span><span class=\"s2\">world</span><span class=\"se\">\\\"</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d!</span><span class=\"s2\">\"d!: Hello, {b}\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">section</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ## deriving test</span>\n\n<span class=\"w\">  </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">d!</span><span class=\"s2\">\"d!: {foo}\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 495713632,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737725136
    },
    {
        "content": "<p>I don't really think that this <code>d!</code> thing has any place in core, but I've opened <a href=\"https://github.com/leanprover/lean4/pull/6763\">lean4#6763</a> so that you don't have to copy <code>expandInterpolatedStr</code></p>",
        "id": 495713943,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737725235
    },
    {
        "content": "<p>Just knowing that it is possible to make a “d! macro” makes me happy. Thanks everyone.</p>",
        "id": 495715401,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1737725652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 495715436,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737725661
    }
]