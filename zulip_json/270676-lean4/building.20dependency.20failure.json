[
    {
        "content": "<p>Hi all, I need some help with a dependency</p>\n<p>I set <a href=\"https://github.com/argumentcomputer/Blake3.lean/tree/ap/use-c\">https://github.com/argumentcomputer/Blake3.lean/tree/ap/use-c</a> to use C bindings for BLAKE3. It works well <em>locally</em>. That is, I can create an executable that uses <code>Blake3.hash</code>, compile it and it runs just fine.</p>\n<p>However, when I try to use that lib as a dependency of another Lean 4 repo, I'm getting some weird errors when I try to compile a file that does <code>import Blake3</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">arthur</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0/bin/clang -o ././.lake/build/bin/Tests-Blake3 ././.lake/build/ir/Tests/Blake3.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/SlimCheck/Control/DefaultRange.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/SlimCheck/Control/Random.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/SlimCheck/Gen.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/SlimCheck/Sampleable.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/SlimCheck/Checkable.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/LSpec.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec/Instances.c.o.export ././.lake/packages/LSpec/.lake/build/ir/LSpec.c.o.export ././.lake/packages/Blake3/.lake/build/ir/Blake3.c.o.export ././.lake/build/ir/Ix/ByteArray.c.o.export ././.lake/packages/Blake3/.lake/build/lib/libffi.a ././.lake/packages/Blake3/.lake/build/lib/libffi.a ././.lake/build/lib/libffi.a --sysroot /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0 -L /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0/lib -L /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc/libc_nonshared.a /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0/lib/glibc/libpthread_nonshared.a -Wl,--as-needed -Wl,-Bstatic -lgmp -lunwind -luv -Wl,-Bdynamic -Wl,--no-as-needed -fuse-ld=lld -L /home/arthur/.elan/toolchains/leanprover--lean4---v4.16.0/lib/lean -Wl,--start-group -lleancpp -lLean -Wl,--end-group -lStd -Wl,--start-group -lInit -lleanrt -Wl,--end-group -Wl,-Bstatic -lc++ -lc++abi -Wl,-Bdynamic -lLake -Wl,--as-needed -lgmp -luv -lpthread -ldl -lrt -Wl,--no-as-needed -lm -ldl -pthread</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean_blake3_version</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_internalVersion___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">initialize_Blake3</span><span class=\"o\">)</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean_blake3_initialize</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_Hasher_init___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">initialize_Blake3</span><span class=\"o\">)</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean_blake3_hasher_update</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_Hasher_update___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_hash</span><span class=\"o\">)</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean_blake3_hasher_finalize</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_Hasher_finalize___boxed</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Blake3</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"kn\">export</span><span class=\"o\">:(</span><span class=\"n\">l_Blake3_hash</span><span class=\"o\">)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">arthur</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0/bin/clang' exited with code 1</span>\n</code></pre></div>\n<p>Help is much appreciated. Thanks in advance!</p>",
        "id": 498342109,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738935329
    },
    {
        "content": "<p>This is presumably happening because the linker flags in the project using blake as a dependency do not include the Blake library properly but my mental model of Lake is not strong enough to figure out what exactly to do here.</p>",
        "id": 498382554,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738946806
    },
    {
        "content": "<p>I didn't set linker flags. Where should those be set and which flags?</p>",
        "id": 498383233,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738947005
    },
    {
        "content": "<p>When I inspect the <code>.lake</code> folder, I see that the static lib from <code>Blake3.lean</code> is being generated</p>",
        "id": 498384106,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738947283
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/channel/270676-lean4/topic/building.20dependency.20failure/near/498383233\">said</a>:</p>\n<blockquote>\n<p>I didn't set linker flags. Where should those be set and which flags?</p>\n</blockquote>\n<p>I assume one of the lake options that ends up in this call to clang but I do not know which option in particular</p>",
        "id": 498385049,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738947584
    },
    {
        "content": "<p>I've already tried several combinations of <code>moreLinkArgs</code>, <code>weakLinkArgs</code> and <code>moreLeancArgs</code> under <code>lean_lib Blake3</code> and <code>package Blake3</code>. Idk what else to try</p>",
        "id": 498386481,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738948001
    },
    {
        "content": "<p>I found the sneaky line:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gu\">@@ -31,7 +31,7 @@ def buildBlake3Obj (pkg : NPackage _package.name) (fileName : String) (addFlags</span>\n<span class=\"w\"> </span>target ffi.o pkg : System.FilePath := do\n<span class=\"w\"> </span>  let blake3Repo ← cloneBlake3.fetch &gt;&gt;= (·.await)\n<span class=\"w\"> </span>  let oFile := pkg.buildDir / \"ffi.o\"\n<span class=\"gd\">-  let srcJob ← inputTextFile \"ffi.c\"</span>\n<span class=\"gi\">+  let srcJob ← inputTextFile $ pkg.dir / \"ffi.c\"</span>\n</code></pre></div>",
        "id": 498443246,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738970755
    },
    {
        "content": "<p>For context: I was extra unlucky because the repo that uses <code>Blake3.lean</code> as a dependency also has an <code>ffi.c</code>, which was being pointed to by this buggy line.</p>\n<p>Maybe this helps if others face this (somewhat unlikely) issue in the future.</p>",
        "id": 498444408,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1738971449
    }
]