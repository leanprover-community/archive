[
    {
        "content": "<p>Is it possible to get some form of <code>Syntax</code> for the <code>import</code>s of a file?</p>\n<p>What I would like is to extract from the current file something like an <code>Array Syntax</code>, where each entry represents a <code>import X</code>, for each module imported by the current file.  Even just the <code>Syntax</code> terms for the names of the files would be good enough!</p>",
        "id": 452719889,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721452383
    },
    {
        "content": "<p>Here is an example of what I would like (not working code):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getImportSyntax</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">magic</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getImportSyntax</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">#[</span>\n<span class=\"cm\">  (Command.import \"import\", (\"A\")),</span>\n<span class=\"cm\">  (Command.import \"import\", (\"B\"))</span>\n<span class=\"cm\">]</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 452720362,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721452671
    },
    {
        "content": "<p>Let me second this request: currently, the <a href=\"https://github.com/leanprover-community/mathlib4/blob/f5989e213edd5d738ddd974de82da2b9cef341b9/Mathlib/Tactic/Linter/TextBased.lean#L318\"><code>broadImports</code> style linter</a> in mathlib does some ad-hoc parsing of the file to determine all imports. I wouldn't mind replacing that by something more principled.</p>",
        "id": 452792762,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721461764
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment#doc\">docs#Lean.Environment</a></p>",
        "id": 452913040,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519432
    },
    {
        "content": "<p>I am specifically interested in getting the ranges of the individual imports: does the environment hold that?</p>",
        "id": 452913087,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721519519
    },
    {
        "content": "<p>The information is contained (in one way or another) in the header as part of the environment</p>",
        "id": 452913128,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519524
    },
    {
        "content": "<p>(Sorry, the I added the link above for my own convenience since I’m on mobile)</p>",
        "id": 452913139,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519559
    },
    {
        "content": "<p>I should have been more specific: I know how to access the \"processed\" imports, direct and transitive from the environment.  I do not know how to get ranges, so that I can, for instance, log a warning on a targeted import.</p>",
        "id": 452913166,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721519612
    },
    {
        "content": "<p>Yeah I understand. For some reason I thought the syntax for the imports was saved, but I guess not</p>",
        "id": 452913225,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519662
    },
    {
        "content": "<p>I guess you could get the source of the current file and use something like <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Parser/Module.html#Lean.Parser.parseHeader\">https://leanprover-community.github.io/mathlib4_docs/Lean/Parser/Module.html#Lean.Parser.parseHeader</a></p>",
        "id": 452913286,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519747
    },
    {
        "content": "<p>I don’t know if that’s the best way :-/</p>",
        "id": 452913349,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721519788
    },
    {
        "content": "<p>I’ll third the request, and specifically propose that <code>Import</code> should have an optional <code>ref?</code> field.</p>",
        "id": 452914267,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1721520691
    },
    {
        "content": "<p>I’m not 100% positive this is the best option, but hopefully proposing something specific will invite criticism (or agreement!), and we can figure out what would be! :)</p>",
        "id": 452914271,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1721520696
    },
    {
        "content": "<p>I personally like the <code>Import.ref?</code> proposal very much!  I'm guessing you were thinking of <code>Option Syntax</code> (or maybe <code>Option (TSyntax `something)</code> as its type?</p>\n<p>Why <code>Option</code>, though?  Could it not be just <code>Import.ref</code>?  (Note the question mark outside the code!)</p>",
        "id": 453040159,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721596347
    },
    {
        "content": "<p>How would <code>withImportModules</code> work in that case?</p>",
        "id": 453052251,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721606060
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/270676-lean4/topic/Syntax.20for.20imports/near/452913349\">said</a>:</p>\n<blockquote>\n<p>I don’t know if that’s the best way :-/</p>\n</blockquote>\n<p>I think that might be the only reliable way to do this at the moment, though it looks like this is packaged up by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.parseImports#doc\">docs#Lean.Elab.parseImports</a>, which is used for getting the <code>lean</code> executable to print imports with the <code>-d</code> flag.</p>",
        "id": 453053219,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721606929
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Syntax.20for.20imports/near/453052251\">said</a>:</p>\n<blockquote>\n<p>How would <code>withImportModules</code> work in that case?</p>\n</blockquote>\n<p>What's the objection? Synthetic <code>Import</code>s? <code>Option Syntax</code> can be collapsed to <code>Syntax</code> using <code>Syntax.missing</code> at least.</p>",
        "id": 453053352,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1721607053
    },
    {
        "content": "<p>Ah, <code>Syntax.missing</code> indeed resolves my concern</p>",
        "id": 453054450,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1721608067
    },
    {
        "content": "<p>Kyle showed me how to actually use this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> -/</span><span class=\"n\">Lean</span>\n<span class=\"c1\">-- then a random comment</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">trying to confuse</span>\n<span class=\"cm\">import Command</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> an actual import -/</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span>\n\n<span class=\"n\">Batteries</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileMap</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHeader</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"bp\">.</span><span class=\"n\">source</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"'{stx}'\"</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">'(Module.header</span>\n<span class=\"cm\"> []</span>\n<span class=\"cm\"> [(Module.import \"import\" [] `Lean [])</span>\n<span class=\"cm\">  (Module.import \"import\" [] `Batteries [])</span>\n<span class=\"cm\">  (Module.import \"import\" [] `Lean [])</span>\n<span class=\"cm\">  (Module.import \"import\" [] `Batteries [])])'</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 453609898,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721803503
    }
]