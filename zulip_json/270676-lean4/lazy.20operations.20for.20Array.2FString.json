[
    {
        "content": "<p>I noticed that functions such as <code>Array.take</code>, <code>String.take</code>,  <code>Array.map</code>, <code>String.map</code>, <code>Array.filter</code> and many more all return a new <code>Array</code>/<code>String</code>. Unless the compiler is somehow able to optimize this, all of these operations need to allocate new space and copy every element. Have there been any discussions about making these operations lazy to avoid the allocation/copy similar to how Rust does it? In Lean terms this would mean that these functions would return new types that would provide instances of <code>Stream</code> and the functions themselves would need to be redefined to work on <code>Stream</code>s in order to allow chaining. Alternatively, functions such as <code>Array.take</code>, <code>String.take</code>, or <code>String.trim</code> could also return a <code>Subarray</code>/<code>Substring</code>.</p>",
        "id": 496724134,
        "sender_full_name": "eyelash",
        "timestamp": 1738227855
    },
    {
        "content": "<p>We do have support in the runtime for mutating structures that have reference count 1 (which they do if you treat them linearly) in place. In particular something like <code>Array.map</code> will remain in place. <code>filter</code> is currently not implemented in a way to facilitate this, though I think there is a path to making this happen in place in theory.</p>\n<p><code>Array.take</code> and <code>String.take</code> are (or, at least after recent internal discussions will not be) optimized to work in place. I do agree that having API that returns <code>Subarray</code> or <code>Substring</code> is potentially useful but currently both of these have painful API gaps on their own so this wouldn't be a joy to use either.</p>\n<p>The more general solution here is likely a general iterator interface that's going to come at some point in the future.</p>",
        "id": 496725392,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738228291
    },
    {
        "content": "<p>Will this general iterator interface be similar to <code>Iterator</code> in Rust? I'm assuming this will be a replacement for <code>Stream</code>?</p>",
        "id": 496726938,
        "sender_full_name": "eyelash",
        "timestamp": 1738228788
    },
    {
        "content": "<p>Are there any plans for unboxed <code>Array</code>s (as a compiler optimization)? In-place <code>Array.map</code> only works if the element size stays the same.</p>",
        "id": 496728464,
        "sender_full_name": "eyelash",
        "timestamp": 1738229236
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"422011\">eyelash</span> <a href=\"#narrow/channel/270676-lean4/topic/lazy.20operations.20for.20Array.2FString/near/496726938\">said</a>:</p>\n<blockquote>\n<p>Will this general iterator interface be similar to <code>Iterator</code> in Rust? I'm assuming this will be a replacement for <code>Stream</code>?</p>\n</blockquote>\n<p>Not clear so far</p>\n<p><span class=\"user-mention silent\" data-user-id=\"422011\">eyelash</span> <a href=\"#narrow/channel/270676-lean4/topic/lazy.20operations.20for.20Array.2FString/near/496728464\">said</a>:</p>\n<blockquote>\n<p>Are there any plans for unboxed <code>Array</code>s (as a compiler optimization)? In-place <code>Array.map</code> only works if the element size stays the same.</p>\n</blockquote>\n<p>These are disjoint questions. Unboxed <code>Array</code>s might happen in the future, note that we have <code>ByteArray</code> and <code>FloatArray</code> for specific purposes already that are unboxed. In place <code>Array.map</code> indeed only works if the lement size stays the same but the elment size of an <code>Array</code> is always <code>sizeof(size_t)</code> so that is not important.</p>",
        "id": 496729532,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738229563
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"422011\">eyelash</span> has marked this topic as resolved.</p>",
        "id": 496741791,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738233301
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> has marked this topic as unresolved.</p>",
        "id": 496843519,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738262335
    },
    {
        "content": "<p>You can use <code>Substring</code> and <code>Subarray</code> for lazier operations. These also have <code>Stream</code> instances.</p>",
        "id": 496843684,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1738262382
    }
]