[
    {
        "content": "<p>I'm adding some basic lean lsp support to the kakoune text editor. The relevant kak-lsp PR is <a href=\"https://github.com/kakoune-lsp/kakoune-lsp/pull/860#issuecomment-3447735815\">here</a>.</p>\n<p>Problem is that <code>lake serve</code> and <code>lean --serve</code> seem to be using their present working directory to find lakefile.{toml,lean} and not the workspace folder transmitted via LSP. Is this intentional? AFAIK other LSP's do not rely on the working directory they are started in.</p>",
        "id": 547533026,
        "sender_full_name": "Christopher Lang",
        "timestamp": 1761667194
    },
    {
        "content": "<p>Yes, this is intentional. Note that we don't set the <code>workspaceFolders</code> server capability, either.</p>",
        "id": 547535799,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1761667809
    },
    {
        "content": "<p>I don't recall having any issue with neovim here. Presumably rootUri is still supported by Lean? I believe that's what we ultimately are setting by setting <code>root_dir</code> in nvim. Does kakoune (or your PR) not set that?</p>",
        "id": 547540704,
        "sender_full_name": "Julian Berman",
        "timestamp": 1761669029
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/channel/270676-lean4/topic/LSP.20lakefile.20discovery.20uses.20PWD.20but.20should.20use.20LSP.20workspace/near/547540704\">said</a>:</p>\n<blockquote>\n<p>Presumably rootUri is still supported by Lean?</p>\n</blockquote>\n<p>It isn't. We just use the cwd.</p>",
        "id": 547541112,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1761669118
    },
    {
        "content": "<p>Huh. Interesing, I don't think we actually set any different working directory in neovim, let's see if nvim execs the process by default in the directory we pass but its docs seem to suggest it doesn't.</p>",
        "id": 547542086,
        "sender_full_name": "Julian Berman",
        "timestamp": 1761669369
    },
    {
        "content": "<p>Is there any reason rootUri isnt supported? Would it not be better to use rootUri over cwd in order to be more consistent with how other LSPs are implemented?</p>\n<p>If there is no plan to use rootUri in the future than can I suggest a comment is added to <code>Data/Lsp/InitShutdown.lean</code> to explain. I feel that the current structure definition implies that rootUri <em>is</em> supported because of the commented out rootPath directly above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">InitializeParams</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">processId?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">clientInfo?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ClientInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> We don't support the deprecated rootPath</span>\n<span class=\"cm\">  (rootPath? : Option String) -/</span>\n<span class=\"w\">  </span><span class=\"n\">rootUri?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">initializationOptions?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">InitializationOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">capabilities</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ClientCapabilities</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- If omitted, we default to off. -/</span>\n<span class=\"w\">  </span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Trace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Trace</span><span class=\"bp\">.</span><span class=\"n\">off</span>\n<span class=\"w\">  </span><span class=\"n\">workspaceFolders?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">WorkspaceFolder</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">ToJson</span>\n</code></pre></div>",
        "id": 553800797,
        "sender_full_name": "Christopher Lang",
        "timestamp": 1762334219
    },
    {
        "content": "<p>Sure, happy to add a comment to that structure and a note to our <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Server/ProtocolOverview.lean\">protocol overview</a> that attempts to document all of our LSP protocol violations and extensions.</p>",
        "id": 553802192,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1762334624
    }
]