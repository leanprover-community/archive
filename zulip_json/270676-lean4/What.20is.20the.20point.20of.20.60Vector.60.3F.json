[
    {
        "content": "<p>Can someone explain to me, or show examples of, what is the benefit of using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Vector#doc\">docs#Vector</a> over <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Array%3F#doc\">docs#Array?</a></p>\n<p>Instead of using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>one could use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo'_size</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>So I guess the first version is shorter and more concise. On the other hand if the proof of <code>foo'_size</code> is non-trivial, then this proof would have to be inlined inside of <code>foo</code>. IMO the second version, where the proof is separated, would make code more readable. Kinda benefit of <code>Vector</code> is that there's no risk of forgetting some missing verification API in the likeness of <code>foo'_size</code>.</p>\n<p>If there's a need for it, one can use <code>{ xs : Array α // xs.size = n }</code> instead of <code>Vector α n</code>. In fact, we could probably even replace whole <code>Vector</code> API with API around <code>{ xs : Array α // xs.size = n }</code>. Afaik, at least in mathlib, we would prefer unbundled/curried version instead. It seems like the only benefit of <code>Vector</code> is that the name is shorter than subtype. Is <code>Vector</code> useful enough to justify its existence? (why is it useful at all remains a mystery to me)<br>\nAs an example we use subtype here <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/List/Sort/Basic.html#List.MergeSort.Internal.splitInTwo\">List.MergeSort.Internal.splitInTwo</a> or here <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Combinatorics/SimpleGraph/Connectivity/WalkCounting.html#SimpleGraph.fintypeSubtypeWalkLength\">SimpleGraph.fintypeSubtypeWalkLength</a>, without defining <code>List.Vector</code> or some kind of <code>SimpleGraph.WalkWithLength</code>.</p>\n<p>I though that maybe <code>Vector</code> has different runtime semantics than <code>Array</code> (e.g. non-dynamic array with linear-time <code>Vector.push</code>), but I checked that it is not the case. Unless there's a plan to potentially change that?</p>\n<p>I could imagine the situation where <code>Vector</code> might be hurtful. Someone starts using <code>Vector</code> in their code and it works well for some time. Until they realize they need to use <code>.filter</code>. Now, they either have to enter DTT hell, or refactor existing code to use <code>Array</code> instead of <code>Vector</code>.</p>\n<p>One argument for <code>Vector</code> is that it makes easier proving some things about length in monadic context. I am unsure about how big currently is this \"easier\" factor, I think it's pretty big? But this arguments becomes obsolete if/when better support for proofs in monadic context lands in core (like mvcgen).</p>\n<p>Maybe the main benefit of <code>Vector</code> is when Lean is used as a programming language and not theorem prover (which would explain why <code>Vector</code> is in core, but <code>List.Vector</code> isn't)? I still can't exactly imagine why, possibly because I never did much programming with dependant types.</p>",
        "id": 568202518,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768481626
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20is.20the.20point.20of.20.60Vector.60.3F/near/568202518\">said</a>:</p>\n<blockquote>\n<p>If there's a need for it, one can use <code>{ xs : Array α // xs.size = n }</code> instead of <code>Vector α n</code>.</p>\n</blockquote>\n<p>So is your question why we are not just using the following?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 568209830,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768483547
    },
    {
        "content": "<p>Because the answer is probably that a designated <code>Structure</code> means we get <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Vector.toArray#doc\">docs#Vector.toArray</a> instead of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.val#doc\">docs#Subtype.val</a> in theorem statements</p>",
        "id": 568209997,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768483579
    },
    {
        "content": "<p>This does explain why we prefer structure over subtype, but doesn't explain why is it useful in the first place. As I mentioned, we usually prefer unbundled/curried version, when a better definition is not available.</p>\n<p>Your argument is only about naming? This sounds pretty minor to me. I would say that ability to use dot-notation would be better argument.</p>\n<p>My question is more about, why someone would want to use bundled version in the first place? And whether it's worthwhile enough to justify maintaining this API.</p>",
        "id": 568213742,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768484373
    },
    {
        "content": "<p>You often need a bundled version when working with <code>m (Vector α n)</code> for some monad <code>m</code></p>",
        "id": 568214880,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768484635
    },
    {
        "content": "<p>mvcgen won't help you if you need the proof to pass into the next step</p>",
        "id": 568215217,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768484710
    },
    {
        "content": "<p>It seems that the question belongs to the broader debate of doing proofs in the intrinsic style with dependent types (e.g. as in <code>foo</code>) or do proofs in the extrinsic style (e.g. with the pair <code>foo'</code> / <code>foo'_size</code>). I think folklore says that doing proofs in the intrinsic style is risky (as you mentioned it may quickly lead to DTT hell, but note that this is not just an issue with <code>Vector</code>, but with <code>Subtype</code>s in general), with for example with the classic issue of <code>Vector a (n+m)</code> vs <code>Vector a (m+n)</code>.</p>\n<p>In your example, the implementation of the function <code>foo</code> doesn't need to know that the array has length <code>n</code>, here using <code>Vector</code> is just a convenience to prove <code>foo</code> preserves the length at the same time we define it. In this case I think using <code>foo'</code> / <code>foo'_size</code> is more advisable. However, there are cases where we do need in the implementation of <code>foo</code> to know the length of the array, in this case using <code>Vector</code> (or <code>Subtype</code> or an additional parameter that contains proof of the length) is useful.</p>",
        "id": 568218816,
        "sender_full_name": "Théophile",
        "timestamp": 1768485493
    },
    {
        "content": "<p>Maybe a way to think about it is that <code>Vector</code> is useful in the same scenarios <code>Fin</code> is useful: note that <code>Fin</code> has all the same issues you mentioned with <code>Vector</code></p>",
        "id": 568219911,
        "sender_full_name": "Théophile",
        "timestamp": 1768485724
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20is.20the.20point.20of.20.60Vector.60.3F/near/568215217\">said</a>:</p>\n<blockquote>\n<p>mvcgen won't help you if you need the proof to pass into the next step</p>\n</blockquote>\n<p>I would imagine that a better support for proofs and proof automation in monadic context would let you write something like this (I completely made-up syntax here):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n\n<span class=\"n\">monadic</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"n\">monadic</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo_size</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"n\">monadic</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">next_step_requiring_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xs'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">  </span><span class=\"n\">next_step_requiring_proof</span><span class=\"w\"> </span><span class=\"n\">xs'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">xs'</span><span class=\"o\">])</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">next_step_requiring_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 568222914,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768486353
    },
    {
        "content": "<p>But, I'm not denying, that with the current state of things, <code>Vector</code> can be useful in monadic context.</p>",
        "id": 568223475,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768486474
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"897795\">Théophile</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20is.20the.20point.20of.20.60Vector.60.3F/near/568219911\">said</a>:</p>\n<blockquote>\n<p>Maybe a way to think about it is that <code>Vector</code> is useful in the same scenarios <code>Fin</code> is useful: note that <code>Fin</code> has all the same issues you mentioned with <code>Vector</code></p>\n</blockquote>\n<p>In fact, even with <code>Fin</code> we prefer curried version: <a href=\"https://github.com/leanprover/lean4/commit/35bbb48916f75ee4abd1ce2d9af899fb11989f34\">https://github.com/leanprover/lean4/commit/35bbb48916f75ee4abd1ce2d9af899fb11989f34</a></p>\n<p><span class=\"user-mention silent\" data-user-id=\"897795\">Théophile</span> <a href=\"#narrow/channel/270676-lean4/topic/What.20is.20the.20point.20of.20.60Vector.60.3F/near/568218816\">said</a>:</p>\n<blockquote>\n<p>However, there are cases where we do need in the implementation of <code>foo</code> to know the length of the array</p>\n</blockquote>\n<p>Can you provide an example? Or rather, why cannot you use curried version in this case?</p>",
        "id": 568224388,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768486665
    },
    {
        "content": "<p>Yes, of course you can always curry it. But like with any code, if your functions keep getting the same set of arguments, it is good practice to factorize and bundle them into a structure, therefore if you always have an hypothesis on the length of your array, it is also good practice to bundle it into a structure, which is <code>Vector</code></p>",
        "id": 568227857,
        "sender_full_name": "Théophile",
        "timestamp": 1768487306
    },
    {
        "content": "<p>In the code I'm writing right now I have something that looks like this (it's a bit more complex but this is a simplified version):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">TupleLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">f_g_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">g_f_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>Here, I believe <code>Vector</code> is useful</p>",
        "id": 568228654,
        "sender_full_name": "Théophile",
        "timestamp": 1768487449
    },
    {
        "content": "<p>Of course I could write it like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">TupleLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">f_g_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">g_f_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>but is this an improvement?</p>",
        "id": 568229087,
        "sender_full_name": "Théophile",
        "timestamp": 1768487539
    },
    {
        "content": "<p>Why not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">TupleLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">f_g_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">g_f_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>?</p>",
        "id": 568231015,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768487943
    },
    {
        "content": "<p>Now I have trouble defining <code>g</code> for the instance <code>TupleLike (a × a × a) a</code></p>",
        "id": 568231258,
        "sender_full_name": "Théophile",
        "timestamp": 1768488003
    },
    {
        "content": "<p>For example, what if the input array is empty and <code>a = Empty</code>? Such a function does not exists</p>",
        "id": 568231559,
        "sender_full_name": "Théophile",
        "timestamp": 1768488075
    },
    {
        "content": "<p>I see, the unbudled version indeed looks less readable</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">TupleLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">f_g_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">  </span><span class=\"n\">g_f_inv</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>I like this example.</p>\n<p>I would still ask for some real-life code sample that uses <code>Vector</code> to get more reference though.</p>",
        "id": 568233274,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768488497
    },
    {
        "content": "<p>Usually I like using Array, but I found that Vector is nicer when writing algorithms that involve only size-preserving primitives. <br>\nA typical example is sorting algorithms. Many sorting algorithms use only swapping, and since it returns <code>Vector α n</code> for the same <code>n</code>, I could reuse in-bounds proofs without reasoning about the size after swapping.<br>\nAnother example is a data structure that uses fixed size arrays and only getElem/set.<br>\n<a href=\"https://github.com/pandaman64/lean-regex/blob/main/regex/Regex/Data/SparseSet/Basic.lean\">https://github.com/pandaman64/lean-regex/blob/main/regex/Regex/Data/SparseSet/Basic.lean</a></p>",
        "id": 568236230,
        "sender_full_name": "pandaman",
        "timestamp": 1768489071
    },
    {
        "content": "<p>(note that this example is real-world, it's stemming from the code I'm writing this week)</p>\n<p>another time I had a use for <code>Vector</code> was when I designed a framework for verified binary format parsers / serializers (<a href=\"https://eprint.iacr.org/2023/1390.pdf\">link to the paper</a>, see <code>message_format_for</code> in section 3.1)</p>\n<p>In here, to construct <code>MessageFormat (Array a)</code>, we do as follows (this is slightly simplified though):</p>\n<ul>\n<li>construct <code>MessageFormat (Vector a 0)</code> from <code>MessageFormat Unit</code></li>\n<li>construct <code>MessageFormat a → MessageFormat (Vector a n) → MessageFormat (Vector a (n+1))</code></li>\n<li>by induction with the two above, construct <code>MessageFormat a → (n: Nat) → MessageFormat (Vector a n)</code></li>\n<li>then construct <code>MessageFormat a → MessageFormat Nat → ((n: Nat) → MessageFormat (Vector a n)) → MessageFormat (Array a)</code></li>\n<li>obtain <code>MessageFormat a → MessageFormat (Array a)</code> this way (we assume <code>MessageFormat Nat</code> exists somewhere)</li>\n</ul>\n<p>This relies on the fact that <code>Array a</code> is isomorphic to the dependent pair <code>n: Nat × Vector a n</code></p>\n<p>It is of course possible to write it using <code>Subtype</code> (here currying doesn't work because we use it inside <code>MessageFormat</code>), but it would be much more ugly.</p>",
        "id": 568238632,
        "sender_full_name": "Théophile",
        "timestamp": 1768489563
    },
    {
        "content": "<p>Thanks, I'm convinced that it's not always possible/preferred to use curried version. I realized that I also had problems with curry/uncurry when programming in Haskell. So basically the reason to have Vector is that it's easier to use and shorter than Subtype, and this specific Subtype is somewhat common?</p>",
        "id": 568242920,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768490532
    },
    {
        "content": "<p>Hm, it would be nice if Lean had some kind of syntax and special support, that would let us write <code>Vector α _</code> to mean something like <code>(n : Nat) × Vector α n</code>. And if we additionally could make this second argument default to <code>_</code>, then we would use <code>Vector α</code> instead of <code>Array α</code> which would result in unified API.</p>",
        "id": 568244169,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768490842
    }
]