[
    {
        "content": "<p>Is anyone working on building a formatter for Lean (i.e. producing \"nice\" <code>Syntax</code> from <code>Syntax</code>)? Maybe one that broadly follows the mathlib style guide?</p>",
        "id": 470962511,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726575554
    },
    {
        "content": "<p>There was a relevant talk during the Lean Together workshop last year.</p>",
        "id": 470962910,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1726575671
    },
    {
        "content": "<p>See <a href=\"#narrow/stream/419231-Lean-Together-2024/topic/A.20Pretty.20Expressive.20Printer.20-.20Sorawee.20Porncharoenwase/near/412181215\">https://leanprover.zulipchat.com/#narrow/stream/419231-Lean-Together-2024/topic/A.20Pretty.20Expressive.20Printer.20-.20Sorawee.20Porncharoenwase/near/412181215</a></p>",
        "id": 470963004,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1726575703
    },
    {
        "content": "<p>I know this doesn’t answer your question, but hopefully it is still relevant.</p>",
        "id": 470963095,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1726575723
    },
    {
        "content": "<p>Thanks, that's at least a start. I think I've actually seen the talk and completely forgot about it <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 470964162,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726576054
    },
    {
        "content": "<p>Would be cool to have such a thing written in Lean though</p>",
        "id": 470965060,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726576306
    },
    {
        "content": "<p>Are you still working on the topic, <span class=\"user-mention\" data-user-id=\"360581\">@Sorawee Porncharoenwase</span> ?</p>",
        "id": 470965090,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726576315
    },
    {
        "content": "<p>It would be extremely useful, but it seems very non-trivial.</p>",
        "id": 470967054,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1726576817
    },
    {
        "content": "<p>It doesn't have to be optimal in order to be useful though, something that works better than an elaboration + pretty printer roundtrip would already be an improvement</p>",
        "id": 470969935,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726577598
    },
    {
        "content": "<p>yeah I don't think that paper is particularly relevant for making a formatter for lean code. All the complexity is elsewhere</p>",
        "id": 470970167,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726577654
    },
    {
        "content": "<p>My motivation for asking is that I have a tool that spits out less than perfect Lean code and it would be very cool if that could be reformatted by a function that already knows about precedences (to remove brackets) and preferences for breaks and indentations</p>",
        "id": 471032313,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726590427
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110789\">Jakob von Raumer</span> <a href=\"#narrow/stream/270676-lean4/topic/formatter/near/470965060\">said</a>:</p>\n<blockquote>\n<p>Would be cool to have such a thing written in Lean though</p>\n</blockquote>\n<p>I have an implementation of the algorithm on my github. Its \"just\" that someone has to write the formatter for each kind of syntax that can exist and then we are ready to go^^</p>",
        "id": 471035426,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1726591236
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110789\">@Jakob von Raumer</span> if that's all you need, lean's pretty printer is probably good enough. It was good enough for mathport</p>",
        "id": 471042431,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726593187
    },
    {
        "content": "<p>The hard part of writing a formatter is making something that doesn't destroy code which has already been manually formatted (in a style approved way), like mathlib</p>",
        "id": 471042773,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726593269
    },
    {
        "content": "<p>The pretty printer also destroys <code>--</code> comments, right?</p>",
        "id": 471043014,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726593334
    },
    {
        "content": "<p>not lean's</p>",
        "id": 471043099,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726593355
    },
    {
        "content": "<p>it's actually already been tuned quite a bit for this use case because it was needed for mathport</p>",
        "id": 471043222,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726593383
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"printme\"</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">ppTerm</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">cmd</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommandTopLevel</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n\n<span class=\"n\">printme</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ohno</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- oops</span>\n<span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ohno</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"c1\">-- oops :</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>which is illegal syntax</p>",
        "id": 471043625,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726593497
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/formatter/near/471042773\">said</a>:</p>\n<blockquote>\n<p>The hard part of writing a formatter is making something that doesn't destroy code which has already been manually formatted (in a style approved way), like mathlib</p>\n</blockquote>\n<p>I'm not sure if thats a relevant criterion. In languages that use a formatter by default like e.g. go everyone just accepts the formatting or at worst turns it off for a specific code piece</p>",
        "id": 471043657,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1726593510
    },
    {
        "content": "<p>(but you're right, the comment _is_ kept)</p>",
        "id": 471043698,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726593522
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> it's true, but in that case the formatting needs to be <em>really</em> good so that people don't complain that the buggy formatting is not correctable because it will be reverted</p>",
        "id": 471045809,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726594221
    },
    {
        "content": "<p>I don't think lean's formatter is at that level, it has trouble even making correct syntax in some cases</p>",
        "id": 471045874,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726594255
    },
    {
        "content": "<p>(as eric shows)</p>",
        "id": 471045891,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726594261
    },
    {
        "content": "<p>although to be fair lean's parser is turing complete so correct formatting is basically undecidable</p>",
        "id": 471045982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726594290
    },
    {
        "content": "<p>Wait what</p>",
        "id": 471087357,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726605255
    },
    {
        "content": "<p>I suppose the fact that the language is extensible (and you get to define your own syntax) does make that likely I guess... I hadn't thought about it like that before</p>",
        "id": 471087766,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726605378
    },
    {
        "content": "<p>Perhaps it would help to make it a bit more concrete as to what a formatter should fix... Indentation? Spacing? Use certain variants of characters (thinking of mapsto)? Remove redundant brackets?</p>",
        "id": 471088179,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1726605522
    },
    {
        "content": "<p>Using certain variants of characters can be done with delaborators, removing redundant brackets is already done by the pretty printer, so I guess indentation and line breaks are the main points?</p>",
        "id": 471205171,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1726649638
    },
    {
        "content": "<p>yes, most of the mistakes in the pretty printer relate to using too many line breaks or getting indentation wrong (sometimes resulting in syntactically incorrect or invalidly parsed output)</p>",
        "id": 471215882,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1726652667
    },
    {
        "content": "<p>Hi I have discovered the script/reformat.lean file in the Lean4 repo. I salvaged it and made it type checking again.</p>\n<p>However there is a runtime exception for any non-trivial piece of input Lean4 source code. </p>\n<p>Is anyone working on this? I could start work on it but I assume someone must already have thought about realising a production ready formatter?</p>",
        "id": 524763348,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750271795
    },
    {
        "content": "<p>do you mean sth like an auto formatter? I also run into the same question today, seems like vscode has no LEAN4 auto formatter right now...</p>",
        "id": 524779810,
        "sender_full_name": "Zixiao Wang",
        "timestamp": 1750278916
    },
    {
        "content": "<p><code>reformat.lean</code> should not be used as an autoformatter. There has been some basic investigation into this matter and there is going to be work done on this as part of the FRO roadmap at some point.</p>",
        "id": 524779993,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1750278995
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/formatter/near/524779993\">zei</a>:</p>\n<blockquote>\n<p><code>reformat.lean</code> should not be used as an autoformatter. There has been some basic investigation into this matter and there is going to be work done on this as part of the FRO roadmap at some point.</p>\n</blockquote>\n<p>Yes, <code>reformat.lean</code> does not really seems functional. </p>\n<p>What do you mean by \"part of the FRO roadmap\"? Can you estimate how many months in the future that would be? </p>\n<p>I could try to start work on a formatter, but I am fairly new to Lean and I assume other people have already tried this. It seems like it would be quite hard because there is a lot of custom syntax and notation.</p>",
        "id": 525178694,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750540217
    },
    {
        "content": "<p>There has been quite some discussion on this matter that you can find on this Zulip and it is indeed a very non trivial task . If you are new to Lean this is not a project I would recommend as it requires quite some understanding of the Lean meta programming facilities. I cannot give a concrete estimation for when exactly the FRO is going to pick up on this right now unfortunately.</p>",
        "id": 525179439,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1750541441
    }
]