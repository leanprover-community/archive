[
    {
        "content": "<p>Hey there,</p>\n<p>I am trying to map a C bitflag construct to Lean.</p>\n<p>What it the recommended way to do so ?</p>\n<p>Let's assume the C side looks like so:</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 480432674,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730723219
    },
    {
        "content": "<p>I have tried making an inductive on the Lean side, a marking constructors as extern:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">C</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"A\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Foo.A</span><span class=\"bp\">;</span>\n</code></pre></div>",
        "id": 480432891,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730723289
    },
    {
        "content": "<p>I would probably write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>\n<p>together with code to convert from and to Foo, <a href=\"https://github.com/tydeu/lean4-alloy\">https://github.com/tydeu/lean4-alloy</a> has some machinery to make this more convenient. If that conversion function is your bottleneck you're going to have solved a lot of other problems already :D</p>",
        "id": 480432976,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1730723321
    },
    {
        "content": "<p>a bitflag does not have the same semantics as a lean inductive</p>",
        "id": 480433079,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730723367
    },
    {
        "content": "<p>for example <code>7</code> is a legal value of <code>enum Foo</code></p>",
        "id": 480433134,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730723388
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/FFI.20bitflags/near/480432976\">said</a>:</p>\n<blockquote>\n<p>I would probably write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>\n<p>together with code to convert from and to Foo, <a href=\"https://github.com/tydeu/lean4-alloy\">https://github.com/tydeu/lean4-alloy</a> has some machinery to make this more convenient. If that conversion function is your bottleneck you're going to have solved a lot of other problems already :D</p>\n</blockquote>\n<p>I'll look into that, i'll be probably easier this way</p>",
        "id": 480433158,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730723397
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/270676-lean4/topic/FFI.20bitflags/near/480433079\">said</a>:</p>\n<blockquote>\n<p>a bitflag does not have the same semantics as a lean inductive</p>\n</blockquote>\n<p>How would you do it then ?</p>",
        "id": 480433282,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730723423
    },
    {
        "content": "<p>Yeah Mario is right, if you decide to <code>|</code> them together you porbably want to use <code>UInt8</code> constants with some additional machinery</p>",
        "id": 480433289,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1730723425
    },
    {
        "content": "<p>so a more accurate lean representation would be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n</code></pre></div>",
        "id": 480433314,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730723431
    },
    {
        "content": "<p>Oh, and have some conversion machinery on the C side ?</p>",
        "id": 480433377,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1730723454
    },
    {
        "content": "<p>Though that would actually need to allocate unlike a <code>UInt8</code> no?</p>",
        "id": 480433403,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1730723460
    },
    {
        "content": "<p>if you want to save space on the lean side you can use UIntN but there will be overhead regardless</p>",
        "id": 480433446,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730723469
    }
]