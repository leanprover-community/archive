[
    {
        "content": "<p>Is it a bug that the optional syntax node in <code>TEST2</code> is resolved to <code>none</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"TEST1\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"t = {t}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"TEST2\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:(</span><span class=\"s2\">\"abc\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"t = {t}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"TEST3\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">optional</span><span class=\"o\">(</span><span class=\"s2\">\"abc\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"t = {t}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">TEST1</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"c1\">-- t = some (10)</span>\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">TEST2</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"c1\">-- t = none</span>\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">TEST3</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"c1\">-- t = failed to pretty print term (use 'set_option pp.rawOnError true' for raw representation)</span>\n</code></pre></div>",
        "id": 571341964,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1770004371
    },
    {
        "content": "<p>The reason why <code>TEST2</code> produces <code>none</code> is that it uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Syntax.getOptional%3F#doc\">docs#Lean.Syntax.getOptional?</a> which returns <code>none</code> if there is more than one node inside (I guess otherwise it'd be ambiguous which node to take). And apparently <code>?</code> is more special than <code>optional</code> since <code>TEST3</code> just takes the raw syntax (<code>[\"abc\" (num \"10\")]</code>) which the pretty-printer has no clue how to print.</p>",
        "id": 571381853,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1770024387
    },
    {
        "content": "<p>I'd say there is at the very least an inconsistency with the docstring on <code>?</code>. It goes \"<code>(p)?</code>Â is shorthand forÂ <code>optional(p)</code>.\", but that's not the case here. It might simply be a missing case in <a href=\"https://github.com/leanprover/lean4/blob/3b0f2862196c6a8af9eb0025ee650252694013dd/src/Lean/Elab/MacroArgUtil.lean#L26\">mkSyntaxAndPat</a>.</p>",
        "id": 571486195,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1770052599
    }
]