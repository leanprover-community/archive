[
    {
        "content": "<p>Hi,</p>\n<p>LeanDojo has been broken starting from Lean v4.12.0. After some debugging, I reduced the problem to the following minimal working example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.Tactic</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"echo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"Hello!\"</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.getStdout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.getStdin</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trim</span>\n<span class=\"w\">    </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"`{line}`\"</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"bye\"</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">echo</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>When running it with <code>leanprover/lean4:v4.11.0</code>, I got the expected behavior (screenshot below): It prints <code>Hello</code>and waits for the user input. It echos the user input until the user enters <code>bye</code>.<br>\n<a href=\"/user_uploads/3121/UMa3z_TSev44RJl6OC9UzjGe/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/UMa3z_TSev44RJl6OC9UzjGe/image.png\" title=\"image.png\"><img data-original-dimensions=\"555x210\" src=\"/user_uploads/thumbnail/3121/UMa3z_TSev44RJl6OC9UzjGe/image.png/840x560.webp\"></a></div><p>However, the program hangs starting from <code>leanprover/lean4:v4.12.0</code>:<br>\n<a href=\"/user_uploads/3121/dYtxNzMauKMaGNyMk9qxBvmV/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/dYtxNzMauKMaGNyMk9qxBvmV/image.png\" title=\"image.png\"><img data-original-dimensions=\"577x106\" src=\"/user_uploads/thumbnail/3121/dYtxNzMauKMaGNyMk9qxBvmV/image.png/840x560.webp\"></a></div><p>I really appreciate any help! Thanks!</p>",
        "id": 476621113,
        "sender_full_name": "Kaiyu Yang",
        "timestamp": 1728838885
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Hello!\"</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdout</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trim</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"`{line}`\"</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"bye\"</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>\n<p>running this one with <code>lean --run</code> works so this is most likely related to the way that stdin and out are setup when you are in an elaboration context. <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> should have the details on this in his cache.</p>",
        "id": 476622105,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728839809
    },
    {
        "content": "<p>I'm afraid this is not a robust approach, it will only be broken further by elaboration parallelism</p>",
        "id": 476623168,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1728840803
    },
    {
        "content": "<p>External interaction must drive elaboration like in the repl, not the other way around</p>",
        "id": 476623254,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1728840902
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>  Thanks! Does that mean I/O in TacticM may lead to undefined behaviors (if so, we probably shouldn't have  instances of <code>MonadLift IO TacticM</code>)? In general, I'm wondering why it is not advisable for elaboration to drive external interactions, and how this is impacted by elaboration parallelism.</p>",
        "id": 476628393,
        "sender_full_name": "Kaiyu Yang",
        "timestamp": 1728845598
    },
    {
        "content": "<p>No, the key issue here is that you are interacting with stdin, it would e.g. be perfectly fine to read a file that contains a proof generated by an external tool from an elaborator</p>",
        "id": 476628503,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728845660
    },
    {
        "content": "<p>In this context, how is reading from stdin different from a file?</p>",
        "id": 476628702,
        "sender_full_name": "Kaiyu Yang",
        "timestamp": 1728845859
    },
    {
        "content": "<p>Things that run in the elaboration context do not actually get to play with the true process stdin anymore.</p>",
        "id": 476628877,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728846006
    },
    {
        "content": "<p>Stdin is shared mutable state while opening a file temporarily for reading is usually a very scoped operation (if you did read from the same file you're writing to in another declaration's elaboration that wouldn't be great either, no)</p>",
        "id": 476628946,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1728846060
    },
    {
        "content": "<p>In my use case, it is guaranteed that only one declaration interacts with stdin during elaboration, so shared mutable state may not be a real problem. Is it possible to guard stdin with something like a mutex?</p>",
        "id": 476630439,
        "sender_full_name": "Kaiyu Yang",
        "timestamp": 1728847461
    }
]