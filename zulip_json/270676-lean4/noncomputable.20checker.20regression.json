[
    {
        "content": "<p>While bumping a project to <code>v4.20.1</code> I encountered that this code does not compile anymore</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>with the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">definition</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">consider</span><span class=\"w\"> </span><span class=\"n\">marking</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">noncomputable</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">depends</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">out'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">noncomputable</span><span class=\"bp\">'</span>\n</code></pre></div>\n<p>It used to work on previous versions e.g. <code>v4.16.0</code>, not exactly when the breaking change happened though.</p>",
        "id": 522899687,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749307238
    },
    {
        "content": "<p>This is known. The new compiler is around the corner though, so don't expect this to be fixed (or rather expect it to be fixed by the arrival of the new compiler)</p>",
        "id": 522899764,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1749307318
    },
    {
        "content": "<p>I see, isn't it exactly because the new compiler is enabled already? (I have no idea if it is or not)</p>",
        "id": 522899799,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749307372
    },
    {
        "content": "<p>(at least I believe not)</p>",
        "id": 522899818,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1749307397
    },
    {
        "content": "<p>I see, I just commented out those parts of the code giving me trouble right now and hopefully I will be able to recover it once this is fixed.</p>",
        "id": 522901293,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1749308973
    },
    {
        "content": "<p>Setting <code>set_option compiler.enableNew true</code>, it looks like it stops at the <code>toMono</code> pass and reports the same \"failed to compile definition\" error.</p>",
        "id": 522902512,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749310558
    },
    {
        "content": "<p>The <code>new_codegen</code> branch has some <code>noncomputable</code> fixes for the new compiler that are not yet on <code>master</code> (and I probably wouldn't recommend trying <code>compiler.enableNew</code> without a <code>stage0</code> update, since lots of things break). With those fixes, the following works as expected:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 522920839,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1749333324
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> If you are looking at <code>Erased</code>, can I just take the opportunity to earnestly ask you to build native support for <code>Erased</code> into the compiler? The above construction doesn't work, not really, at least in the old compiler. I would much prefer <code>Erased</code> was just a structure wrapper which magically had a switched out representation and a noncomputable <code>.out</code> projection. It would also be nice if the construction given works, but that means ensuring that subtypes of erased things are erased and pi types with erased codomain are erased.</p>",
        "id": 522999030,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749414625
    },
    {
        "content": "<p>You should just be able to make things erased as a kind of annotation, rather than hardcoding it to types and proofs. (People want a type system around that but that sounds much farther from reality than an extensible mechanism for erasure via annotation)</p>",
        "id": 522999125,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749414767
    },
    {
        "content": "<p>It's unclear to me if <code>Erased</code> can be an identity function, which would make it even more annotation-like, similar to <code>outParam</code></p>",
        "id": 522999197,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749414899
    },
    {
        "content": "<p>This construction does work with the new compiler (and a version of it is checked in as a test now), giving this IR:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"bp\">◾</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"bp\">._</span><span class=\"n\">boxed</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">◾</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Erased</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">dec</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_3</span>\n<span class=\"o\">[</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">._</span><span class=\"n\">closed_0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_2</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">._</span><span class=\"n\">closed_0</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_1</span>\n</code></pre></div>\n<p>I'm actually not immediately sure why the trivial structure optimization isn't kicking in here for <code>Foo</code>.</p>",
        "id": 525102142,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1750452815
    }
]