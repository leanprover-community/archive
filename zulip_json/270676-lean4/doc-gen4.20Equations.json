[
    {
        "content": "<p>I have a questions for people that consume the auto generated documentation. How important is the <code>Equations</code> feature for you? Would it be acceptable if we just put it aside, given the fact that you can click the source links anyway?</p>\n<p>I just did some benchmarks simply compiling the documentation for the core modules and with equations enabled we have:</p>\n<ul>\n<li>1.6G peak memory consumption</li>\n<li>1min10s build time</li>\n</ul>\n<p>with equations disabled we get:</p>\n<ul>\n<li>900M peak memory consumption</li>\n<li>14s build time</li>\n</ul>\n<p>These improvements are of course not going to translate to mathlib build time 1:1 because in mathlib a lot of stuff is <code>theorem</code> and not <code>def</code> but I expect that as people write more software style projects in Lean the demand for <code>def</code> heavy projects is going to increase.</p>",
        "id": 490676796,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735046854
    },
    {
        "content": "<p>/poll The future of equations in doc-gen<br>\nRemove<br>\nKeep</p>",
        "id": 490676919,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735046932
    },
    {
        "content": "<p>(Keep but only for very simple definitions is a non trivial option because it is difficult to identify what \"simple\" means so we'll still have to do computation for every term)</p>",
        "id": 490678417,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735047892
    },
    {
        "content": "<p>Note that equations of slightly complicated definitions are already not shown in the docs, e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ring.DirectLimit#doc\">docs#Ring.DirectLimit</a>.</p>\n<blockquote>\n<p>One or more equations did not get rendered due to their size.</p>\n</blockquote>",
        "id": 490687778,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735054167
    },
    {
        "content": "<p>Yes we already run a heuristic for that behavior, the choice there is an artefact from someone voting that didn't know this</p>",
        "id": 490688059,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735054375
    },
    {
        "content": "<p>I never use the functionality because the last n times I tried it the answers were useless (\"did not get rendered\") so I basically gave up on it.</p>",
        "id": 490688862,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1735054942
    },
    {
        "content": "<p>Maybe things have improved now? The equation for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=nonZeroDivisors#doc\">docs#nonZeroDivisors</a> was not rendered when I opened <a href=\"https://github.com/leanprover/doc-gen4/pull/160\">doc-gen4#160</a> but it is now shown.</p>",
        "id": 490688960,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735055016
    },
    {
        "content": "<p>How does it generate the equations? using the same machinery that simp etc uses, including proving the equational theorems if they are not proven in the first place, and thus running expensive tactics?</p>",
        "id": 490689034,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1735055055
    },
    {
        "content": "<p>If faster doc-gen compile time means we get more docs updates per day, that may be a worthy tradeoff. I'm not sure how often it's updated currently.</p>",
        "id": 490689150,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735055147
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/490689034\">said</a>:</p>\n<blockquote>\n<p>How does it generate the equations? using the same machinery that simp etc uses, including proving the equational theorems if they are not proven in the first place, and thus running expensive tactics?</p>\n</blockquote>\n<p>The cost is spread two fold, for one we are running the same tactics that simp does, though notably with the kernel disabled so that saves us a bit. We also spend around half of the run time in the pretty printer though.</p>",
        "id": 490689249,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735055211
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/490689150\">said</a>:</p>\n<blockquote>\n<p>If faster doc-gen compile time means we get more docs updates per day, that may be a worthy tradeoff. I'm not sure how often it's updated currently.</p>\n</blockquote>\n<p>Every 8 hours</p>",
        "id": 490689263,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735055221
    },
    {
        "content": "<p>Does it take ~8 hours to build docs for mathlib once?</p>",
        "id": 490689474,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735055396
    },
    {
        "content": "<p>No it takes about 15 minutes on the build machines</p>",
        "id": 490689529,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735055406
    },
    {
        "content": "<p>I just didn't see a point in burning more power than doing an 8 hour cycle when i set it up</p>",
        "id": 490689547,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735055421
    },
    {
        "content": "<p>That's a lot faster than I expected. Building the whole mathlib (on the <code>bench</code> machines) already takes more than 17 minutes. It seems feasible to run doc-gen for each bors batch, as the cost seems negligible compared to CI runs on all mathlib branches. Is there cache for the docs as well?</p>",
        "id": 490690019,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735055716
    },
    {
        "content": "<p>I think the first half is avoidable; you could use the function that calculates the <em>types</em> of the equational theorems without actually proving them.</p>\n<p>Or you could skip even that an just print the value of the definition (or the predefinion for recursive functions). This would then show a single equation with sometimes a <code>match</code> on the RHS. In a way that would even be more relevant. As a user I think I wouldn't mind that.</p>\n<p>So I think this feature, or a similarly useful variant, should be possible with neglectible cost to obtain the equation. Doesn't solve the pretty printing part, though.</p>",
        "id": 490690123,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1735055779
    },
    {
        "content": "<p>The first thing sounds reasonable if we have that function nicely exposed somewhere. The second thing is already the default when we do not manage to obtain an equation in the first place. Agreed on the pretty printing part. I also talked to Kyle about it and he estimates that the pretty printer will get slower before it gets faster due to some features that people are interested in so we can't expect some miracles here most likely.</p>",
        "id": 490690304,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735055908
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/490690019\">said</a>:</p>\n<blockquote>\n<p>That's a lot faster than I expected. Building the whole mathlib (on the <code>bench</code> machines) already takes more than 17 minutes. It seems feasible to run doc-gen for each bors batch, as the cost seems negligible compared to CI runs on all mathlib branches. Is there cache for the docs as well?</p>\n</blockquote>\n<p>There does not currently exist a cache no, I think it might be possible to build one in general though, not quite sure. Either way just because we can do these types of runs I don't really see a need to. We can tune the frequency a little but I've not yet seen people complain about the 8 hour cycle.</p>",
        "id": 490691502,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735056754
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/490678417\">said</a>:</p>\n<blockquote>\n<p>(Keep but only for very simple definitions is a non trivial option because it is difficult to identify what \"simple\" means so we'll still have to do computation for every term)</p>\n</blockquote>\n<p>Would it maybe be possible to use some inaccurate heuristic, like \"length of the source code\"?</p>",
        "id": 490699887,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1735062677
    },
    {
        "content": "<p>The source code is not available from the .olean files</p>",
        "id": 490699906,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735062701
    },
    {
        "content": "<p>Of course it generally lies next to the .olean files somewhere (gets more interesting with e.g. bultin files) but we'd need to write the logic to find that + you need to account for automatically generated declaratuons that don't have real source associated with them.</p>",
        "id": 490700162,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1735062899
    },
    {
        "content": "<blockquote>\n<p>The first thing sounds reasonable if we have that function nicely exposed somewhere.</p>\n</blockquote>\n<p>Not yet nicely exposed (you'd currently have to manually check the env extensions for structural and wf recursion) but certainly doable as an extension of the current  equations API.</p>",
        "id": 490704937,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1735066392
    },
    {
        "content": "<p>I use the feature, but I guess it's not too much effort to click through</p>",
        "id": 490917582,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1735248131
    },
    {
        "content": "<p>Coming back to this, is there an option to turn off the Equations feature in doc-gen running in a project? I'd like to run the same benchmarking experiment</p>",
        "id": 519594717,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1747829116
    },
    {
        "content": "<p>No though you can get this pretty easily by changing this function <a href=\"https://github.com/leanprover/doc-gen4/blob/main/DocGen4/Process/DefinitionInfo.lean#L30C5-L30C21\">https://github.com/leanprover/doc-gen4/blob/main/DocGen4/Process/DefinitionInfo.lean#L30C5-L30C21</a> to <code>return #[]</code></p>",
        "id": 519596390,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1747829640
    },
    {
        "content": "<p>I don't understand the relationship between docgen4 and FLT. Am I able to do this locally in FLT and save me some time in CI? I am not at all convinced that anyone is using the FLT doc-gen output, but if I switch it off I'll break blueprint. I am trying to get my FLT CI faster and I think these equations are costing me 3 minutes:</p>\n<p><a href=\"/user_uploads/3121/Ivu1TwLntrgivnz09mUUDX25/Screenshot-from-2025-05-21-13-22-02.png\">Screenshot from 2025-05-21 13-22-02.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Ivu1TwLntrgivnz09mUUDX25/Screenshot-from-2025-05-21-13-22-02.png\" title=\"Screenshot from 2025-05-21 13-22-02.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1363x524\" src=\"/user_uploads/thumbnail/3121/Ivu1TwLntrgivnz09mUUDX25/Screenshot-from-2025-05-21-13-22-02.png/840x560.webp\"></a></div>",
        "id": 519598039,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747830160
    },
    {
        "content": "<p>Equations are being generated on the fly for all encountered definitions so just because you can't see these prints doesnt mean it is busy for so long. The issue with making this configurable is that it is not quite clear right now how to pipe external config nicely into lake projects. We have abused env variables in the past though, so maybe I can add an env var flag for this as wwll</p>",
        "id": 519599099,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1747830483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/519598039\">said</a>:</p>\n<blockquote>\n<p>if I switch it off I'll break blueprint</p>\n</blockquote>\n<p>Actually I don't think this is true, the blueprint steps in FLT CI happen before the build docs step happens</p>",
        "id": 519648574,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1747842824
    },
    {
        "content": "<p>I mean \"if I switch doc-gen off completely then blueprint will create broken links\" but I would be happy to switch off equations if it saves me 3 minutes.</p>",
        "id": 519651892,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747843687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/270676-lean4/topic/doc-gen4.20Equations/near/519598039\">said</a>:</p>\n<blockquote>\n<p>I am trying to get my FLT CI faster and I think these equations are costing me 3 minutes:</p>\n</blockquote>\n<p>Unfortunately those equations are Lean system's function (probably for metaprogramming), nothing to do with mathematics.</p>",
        "id": 519655917,
        "sender_full_name": "Jz Pan",
        "timestamp": 1747844868
    },
    {
        "content": "<p>In FLT, without caching the docbuild, disabling equations in the way you describe makes it twice as fast. I think it would be nice to have an env var flag for this option (that way it can also work with caching)</p>",
        "id": 519681753,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1747853950
    }
]