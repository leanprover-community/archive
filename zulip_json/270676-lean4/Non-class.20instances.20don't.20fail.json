[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨⟩</span><span class=\"w\"> </span><span class=\"c1\">--doesn't throw any warning or error, despite `Foo` not being a class</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"c1\">--obviously doesn't work</span>\n</code></pre></div>\n<p>Is this the expected behaviour ? Since there already is a check to see whether instance arguments (stuff written in <code>[...]</code> brackets) are actually classes, why not also use that check on the type of instances being declared ?</p>",
        "id": 451131340,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1720851305
    },
    {
        "content": "<p>Seems pretty reasonable. Perhaps this could just be a syntax linter to avoid having to touch <code>instance</code> itself?</p>",
        "id": 451171774,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720877073
    },
    {
        "content": "<p>There is already a linter for this.</p>",
        "id": 451182734,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1720882214
    },
    {
        "content": "<p>I am a bit surprised that this isn't an error by default, in the same way that incorrect binders are (an error which can be turned off using <code>set_option checkBinderAnnotations false</code>, but an error nonetheless). I feel like it would make sense for this to also be treated as an error ? The reason why I found this is because some discord user discussing Lean on a functional programming server was defining what should be <code>def</code>s as <code>instances</code> everywhere, and Lean was not complaining in any way.</p>",
        "id": 451198966,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1720890211
    },
    {
        "content": "<p>I'm afk, but if it is a syntax linter we should move it up to lean (happy to review a PR!). If it's an environment linter it will have to wait for the infrastructure to start moving.</p>",
        "id": 451199444,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720890406
    },
    {
        "content": "<p>It is an environment linter.</p>",
        "id": 451200701,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1720890986
    },
    {
        "content": "<p>Perhaps it could be implemented as a check inside the <code>instance</code>'s elaborator, and would throw an error instead of a linter warning ? For retro-compatibility purposes, such an error could be turned off with an option similar to <code>checkBinderAnnotations</code> ? If such a PR would be welcome, I could find time to work on this.</p>",
        "id": 451201060,
        "sender_full_name": "Arthur Adjedj",
        "timestamp": 1720891184
    },
    {
        "content": "<p>I'm hesitant to greenlight since we're keen to leave everything about typeclass inference alone for a while. </p>\n<p>Hence my suggestion that a syntax linter would be a better approach for now. </p>\n<p>But I'd happily defer to <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> here if they believe an elaboration change could be sufficiently non-invasive.</p>",
        "id": 451201366,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720891305
    },
    {
        "content": "<p>I think this should be an error. The actual issue is in the <code>instance</code> attribute, which has no checks. Here's a PR: <a href=\"https://github.com/leanprover/lean4/pull/4739\">lean4#4739</a></p>",
        "id": 451204415,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720893219
    },
    {
        "content": "<p>This turns out to cause just one mathlib build failure. In <code>Mathlib.SetTheory.Lists</code> there's a mutually recursive instance, and it looks like some intermediate object is given the <code>instance</code> attribute:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">SetTheory</span><span class=\"bp\">/</span><span class=\"n\">Lists</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">382</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">expected</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lists</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">Lists</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">⊕'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lists'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">Lists'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">⊕'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lists</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">Lists'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">        </span><span class=\"n\">PSum</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">          </span><span class=\"n\">PSum</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">⊆</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I'll try to debug this sometime this week, but if I don't figure it out I might turn these into <code>def</code>s and add the <code>instance</code> attributes immediately after...</p>",
        "id": 451371945,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720980463
    }
]