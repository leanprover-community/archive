[
    {
        "content": "<p>I'm currently finishing up Metaprogramming in Lean and I'm thinking about projects to make use of it before I forget it all. One idea I had was for a command elaborator that overrides the default elab for theorem/lemma definitions, and tries to define the given theorem/lemma with more general type class assumptions (e.g. by replacing with a parent class in the hierarchy) and see if it succeeds. This seems like a kind of obvious idea that others may already have implemented, but searching around didn't reveal anything. Is anyone aware of such a thing?</p>",
        "id": 498862988,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1739221620
    },
    {
        "content": "<p>There was this in Lean 3: <a href=\"https://www.youtube.com/watch?v=pudd4F749tE\">https://www.youtube.com/watch?v=pudd4F749tE</a> (Alex Best talk)</p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"pudd4F749tE\" href=\"https://www.youtube.com/watch?v=pudd4F749tE\"><img src=\"https://uploads.zulipusercontent.net/0fe1fd40d7673fd4f243768f1c16863711cbf4a0/68747470733a2f2f692e7974696d672e636f6d2f76692f70756464344637343974452f64656661756c742e6a7067\"></a></div>",
        "id": 498875691,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739225836
    },
    {
        "content": "<p>It would be amazing to have this in Lean4 again!</p>",
        "id": 498904345,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739237542
    },
    {
        "content": "<p>Also having a mode where this can be run at library-scale (e.g. just an option that can be set in the lakefile, that prints info messages on promising declarations) would be nice.</p>",
        "id": 498904440,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739237604
    },
    {
        "content": "<p>Yeah, being able to use it on all of mathlib is my main idea. Iâ€™ll give it a shot and see how it goes</p>",
        "id": 498941876,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1739257762
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"127136\">Alex J. Best</span> Nice talk! I learned things</p>",
        "id": 498955863,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1739263458
    },
    {
        "content": "<p>nice idea!</p>",
        "id": 499995693,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1739698384
    },
    {
        "content": "<p>I've got something hacky working with lots of room for improvement. It already finds many possible generalizations, many seem like they may be nice-to-have, others are maybe not very useful, e.g. generalizing a type class for a single lemma deep in a theory where everything else only targets the more specific type is probably not going to help much. That's for the experts to judge though.</p>\n<p>Here is <a href=\"https://github.com/leanprover-community/mathlib4/commit/2bb1f50759011a058917c9a34cb72a5151cc4d7c\">an example</a> of its results. This change builds, though obviously I do not propose it be reviewed in anything like this form. I am just sharing some early results in case anyone has feedback. I also had a question: is this change too big to put up a draft PR and try to run !bench on it? It requires a rebuild of the entirety of mathlib so I figure it may be a bad idea.</p>\n<p>Some quick stats, the most common type classes generalized from:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"mi\">38</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span>\n<span class=\"w\">  </span><span class=\"mi\">44</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span>\n<span class=\"w\">  </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span>\n<span class=\"w\">  </span><span class=\"mi\">58</span><span class=\"w\"> </span><span class=\"n\">Monoid</span>\n<span class=\"w\">  </span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"n\">CommRing</span>\n<span class=\"w\">  </span><span class=\"mi\">72</span><span class=\"w\"> </span><span class=\"n\">Ring</span>\n<span class=\"w\">  </span><span class=\"mi\">94</span><span class=\"w\"> </span><span class=\"n\">Semiring</span>\n<span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span>\n<span class=\"w\"> </span><span class=\"mi\">116</span><span class=\"w\"> </span><span class=\"n\">Module</span>\n</code></pre></div>\n<p>Most common generalized to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"mi\">28</span><span class=\"w\"> </span><span class=\"n\">LE</span>\n<span class=\"w\">  </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span>\n<span class=\"w\">  </span><span class=\"mi\">38</span><span class=\"w\"> </span><span class=\"n\">IsDedekindRing</span>\n<span class=\"w\">  </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"n\">Ring</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"n\">DistribMulAction</span>\n<span class=\"w\">  </span><span class=\"mi\">46</span><span class=\"w\"> </span><span class=\"n\">Preorder</span>\n<span class=\"w\">  </span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"n\">MulOneClass</span>\n<span class=\"w\">  </span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"n\">AddZeroClass</span>\n<span class=\"w\">  </span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"n\">NonAssocSemiring</span>\n<span class=\"w\">  </span><span class=\"mi\">71</span><span class=\"w\"> </span><span class=\"n\">Semiring</span>\n<span class=\"w\">  </span><span class=\"mi\">82</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span>\n<span class=\"w\">  </span><span class=\"mi\">96</span><span class=\"w\"> </span><span class=\"n\">SMul</span>\n</code></pre></div>\n<p>Most common ordered as pairs specific-&gt;general</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Semiring</span>\n<span class=\"w\">  </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">SMul</span>\n<span class=\"w\">  </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"n\">MonoidHomClass</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MulHomClass</span>\n<span class=\"w\">  </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span>\n<span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"n\">NonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span>\n<span class=\"w\">  </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"n\">TopologicalGroup</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">ContinuousMul</span>\n<span class=\"w\">  </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span>\n<span class=\"w\">  </span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"n\">CommSemigroup</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">CommMagma</span>\n<span class=\"w\">  </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Semiring</span>\n<span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">AddZeroClass</span>\n<span class=\"w\">  </span><span class=\"mi\">23</span><span class=\"w\"> </span><span class=\"n\">Preorder</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">LE</span>\n<span class=\"w\">  </span><span class=\"mi\">24</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span>\n<span class=\"w\">  </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Preorder</span>\n<span class=\"w\">  </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Ring</span>\n<span class=\"w\">  </span><span class=\"mi\">38</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">IsDedekindRing</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">AddZeroClass</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">DistribMulAction</span>\n<span class=\"w\">  </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Semiring</span>\n<span class=\"w\">  </span><span class=\"mi\">48</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MulOneClass</span>\n<span class=\"w\">  </span><span class=\"mi\">62</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">NonAssocSemiring</span>\n<span class=\"w\">  </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">SMul</span>\n<span class=\"w\">  </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span>\n</code></pre></div>\n<p>These are incomplete results as there are probably more generalizations/types of generalizations I could find, but sharing as an overview.</p>",
        "id": 501285773,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1740245356
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/270676-lean4/topic/Elab.20to.20generalize.20type.20classes.20for.20theorems/near/501285773\">said</a>:</p>\n<blockquote>\n<p>I also had a question: is this change too big to put up a draft PR and try to run !bench on it? It requires a rebuild of the entirety of mathlib so I figure it may be a bad idea.</p>\n</blockquote>\n<p>No, this happens all the time, and bench builds from scratch anyway so the size of the PR doesn't affect the cost.</p>",
        "id": 501286785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740246150
    },
    {
        "content": "<p>This is awesome! I would honestly be tempted to just open a PR with this (if you can get it building).</p>",
        "id": 501287906,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740247009
    },
    {
        "content": "<p>12 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Elab.20to.20generalize.20type.20classes.20for.20theorems/with/501288855\">#mathlib4 &gt; Elab to generalize type classes for theorems</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 501293637,
        "sender_full_name": "Notification Bot",
        "timestamp": 1740251713
    },
    {
        "content": "<p>(I moved discussion about contributing to mathlib / mathlib typeclass-specific gotchas to #mathlib4)</p>",
        "id": 501293918,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740251946
    }
]