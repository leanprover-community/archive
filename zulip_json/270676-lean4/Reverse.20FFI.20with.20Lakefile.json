[
    {
        "content": "<p>I am trying to create a <code>lakefile.lean</code> to work with reverse FFI.</p>\n<p>What I would like to do is something along the lines of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span><span class=\"w\"> </span><span class=\"n\">System</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">lakefile_for_exe</span>\n\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">SumOfTwo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"lean\"</span>\n\n<span class=\"n\">input_file</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"main.c\"</span>\n<span class=\"w\">  </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">buildDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"main.o\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">buildO</span><span class=\"w\"> </span><span class=\"n\">oFile</span><span class=\"w\"> </span><span class=\"n\">srcJob</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"cc\"</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mainO</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">exeName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">binDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n<span class=\"w\">  </span><span class=\"n\">buildLeanExe</span><span class=\"w\"> </span><span class=\"n\">exeName</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mainO</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">`@</span><span class=\"n\">SumOfTwo</span><span class=\"o\">:</span><span class=\"n\">static</span><span class=\"o\">]</span>\n<span class=\"c1\">--                                ^^^^^^^^^^^^^^^^^</span>\n</code></pre></div>\n<p>That is, I would like to leverage the build infrastructure given by <code>lean_lib</code>, instead of defining all the targets manually myself. Is this possible or are there other options available that would avoid having to specify targets for all files I would like to generate? (If not an immediate follow-up question would be how to create the relevant static library in such a way that I can create the final executable using a lakefile.)</p>",
        "id": 572184627,
        "sender_full_name": "fiforeach",
        "timestamp": 1770306346
    },
    {
        "content": "<p>After gaining more experience with Lakefiles, I was able to reproduce the flags found in the <a href=\"https://github.com/leanprover/lean4/blob/bc30710c676742af84bad98d25d7b88d2a8f322b/tests/lake/examples/reverse-ffi/Makefile\">Reverse FFI example</a> and came up with the following</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">exeFile</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">binDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mainO</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">shared</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SumOfTwo</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">shared</span><span class=\"bp\">.</span><span class=\"n\">fetch</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-L\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanLibDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-lInit_shared\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-lleanshared_2\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-lleanshared_1\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\"-lleanshared\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">s!</span><span class=\"s2\">\"-Wl,-rpath,{← getLeanLibDir}\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">s!</span><span class=\"s2\">\"-Wl,-rpath,{pkg.buildDir}/lib\"</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">leanArgs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLeanLinkSharedFlags</span>\n<span class=\"w\">  </span><span class=\"n\">buildLeanExe</span><span class=\"w\"> </span><span class=\"n\">exeFile</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mainO</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">shared</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">weakArgs</span><span class=\"w\"> </span><span class=\"n\">leanArgs</span>\n</code></pre></div>\n<p>This produces a functioning binary.</p>",
        "id": 573068558,
        "sender_full_name": "fiforeach",
        "timestamp": 1770736183
    }
]