[
    {
        "content": "<p>I've tried to convert existing unexpanders in my code to conditional unexpanders, ie. unexpanders that can be turned on/off with an option.</p>\n<p>I have the following code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">liftedU</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"n\">register_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">defValue</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"pp\"</span>\n<span class=\"w\">  </span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(pretty printing) display lift from object-level types to Lean types\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delab_lift</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">whenNotPPOption</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"bp\">.</span><span class=\"n\">defValue</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">    </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">isAppOfArity'</span><span class=\"w\"> </span><span class=\"ss\">``lift</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">arg</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This doesn't work though, in the sense that, even if <code>pp.lift</code> is false, the delaboration never happens. If, instead, I fully specify the name of <code>lift</code>, as such <code>@[delab app.Tltt.Hott.lift]</code>, it works. This looks like a bug, but I'm not sure.<br>\n<span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span></p>",
        "id": 455670503,
        "sender_full_name": "jthulhu",
        "timestamp": 1722523899
    },
    {
        "content": "<p>The <code>delab</code> attribute expects what comes after <code>app</code> to be the fully qualified name for the constant</p>",
        "id": 455695921,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722529309
    },
    {
        "content": "<p>One way you can tell whether it's correct is to hover your mouse over the <code>app....</code>, since for convenience if the constant exists then the <code>delab</code> attribute makes it hoverable.</p>",
        "id": 455696577,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722529383
    },
    {
        "content": "<p>Feel free to create a Lean issue with a feature request that <code>@[delab app.lift]</code> should resolve the name <code>lift</code> to <code>Tltt.Hott.lift</code> and then instead add a delaborator with the key <code>app.Tltt.Hott.lift</code>.</p>",
        "id": 455697213,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722529471
    },
    {
        "content": "<p>(You can take a look at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.getExprKind#doc\">docs#Lean.PrettyPrinter.Delaborator.getExprKind</a> to see why it works the way it does.)</p>",
        "id": 455697422,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722529501
    },
    {
        "content": "<p>Here is the corresponding RFC: <a href=\"https://github.com/leanprover/lean4/issues/4899\">#4899</a>.</p>",
        "id": 455873191,
        "sender_full_name": "jthulhu",
        "timestamp": 1722588185
    },
    {
        "content": "<p>(Completed in <a href=\"https://github.com/leanprover/lean4/pull/4976\">lean#4976</a>.)</p>",
        "id": 459958518,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723421529
    }
]