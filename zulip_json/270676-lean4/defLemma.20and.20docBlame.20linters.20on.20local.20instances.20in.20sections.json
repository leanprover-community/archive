[
    {
        "content": "<p>If I put a <code>local instance</code> into a <code>section</code>, then both the <code>defLemma</code> and the <code>docBlame</code> linter complain:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Std.Tactic.Lint.Misc</span>\n<span class=\"kn\">import</span> <span class=\"n\">Std.Tactic.Lint.Frontend</span>\n\n<span class=\"sd\">/-- some class in Prop -/</span>\n<span class=\"kd\">class</span> <span class=\"n\">Foo</span> <span class=\"o\">(</span><span class=\"n\">T</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"n\">T</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"n\">where</span>\n  <span class=\"sd\">/-- some proof -/</span>\n  <span class=\"n\">ht</span> <span class=\"o\">:</span> <span class=\"n\">s</span> <span class=\"bp\">=</span> <span class=\"n\">t</span>\n\n<span class=\"kn\">section</span> <span class=\"n\">foo</span>\n\n<span class=\"kn\">local</span> <span class=\"kd\">instance</span> <span class=\"n\">bar</span> <span class=\"o\">:</span> <span class=\"n\">Foo</span> <span class=\"n\">Nat</span> <span class=\"mi\">0</span> <span class=\"mi\">0</span> <span class=\"o\">:=</span> <span class=\"o\">⟨</span><span class=\"n\">rfl</span><span class=\"o\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">lint</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">-- Found 0 errors in 5 declarations (plus 4 automatically generated ones) in</span>\n<span class=\"cm\">the current file with 8 linters</span>\n\n<span class=\"cm\">-- All linting checks passed!</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">end</span> <span class=\"n\">foo</span>\n\n<span class=\"bp\">#</span><span class=\"n\">lint</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">-- Found 2 errors in 1 declarations (plus 0 automatically generated ones) in</span>\n<span class=\"cm\">the current file with 14 linters</span>\n\n<span class=\"cm\">/- The `defLemma` linter reports:</span>\n<span class=\"cm\">INCORRECT DEF/LEMMA: -/</span>\n<span class=\"cm\">#check bar /- is a def, should be lemma/theorem -/</span>\n\n<span class=\"cm\">/- The `docBlame` linter reports:</span>\n<span class=\"cm\">DEFINITIONS ARE MISSING DOCUMENTATION STRINGS: -/</span>\n<span class=\"cm\">#check bar /- definition missing documentation string -/</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>This occurs only when the <code>#lint</code> is outside the section with the local defs.</p>\n<p>This looks like a bug to me.</p>",
        "id": 433824150,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1713369781
    },
    {
        "content": "<p>Apparently, <code>#lint</code> uses more linters outside the section than within ?</p>",
        "id": 433824555,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1713369847
    },
    {
        "content": "<p>the issue is that some linters ignore instances, so local instances confuse them</p>",
        "id": 433824863,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713369941
    },
    {
        "content": "<p>it's not really possible to tell whether something \"was once\" a local instance</p>",
        "id": 433824923,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713369960
    },
    {
        "content": "<p>So the only way to deal with this is to <code>@[nolint defLemma docBlame]</code> them?</p>",
        "id": 433825074,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1713369998
    },
    {
        "content": "<p>you may be able to at least fix the defLemma linter by making it a <code>@[local instance] theorem</code></p>",
        "id": 433825260,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713370048
    },
    {
        "content": "<p>you can also make it private (not sure if the relevant linters are looking for this)</p>",
        "id": 433825303,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713370057
    },
    {
        "content": "<p>Are private instances visible downstream (not by name, but for <code>inferInstance</code> etc.)?</p>",
        "id": 433825475,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1713370102
    },
    {
        "content": "<p>yes</p>",
        "id": 433827173,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713370625
    },
    {
        "content": "<p>but private local instances are not</p>",
        "id": 433827200,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713370635
    },
    {
        "content": "<p>but making the definition private will at least silence the docBlame linter</p>",
        "id": 433827301,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713370669
    },
    {
        "content": "<p>If I need to silence one of them anyway, I can as well silence both...</p>",
        "id": 433829486,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1713371428
    },
    {
        "content": "<p><code>@[local instance] private theorem</code> and <code>@[local instance] private def</code> seems like the best approach</p>",
        "id": 433829610,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1713371480
    },
    {
        "content": "<p>it would be nice if <code>instance</code> automatically did <code>def</code>/<code>theorem</code> properly though</p>",
        "id": 433829830,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713371559
    },
    {
        "content": "<p>I'm pretty sure the only reason the defTheorem linter looks for instances is because this is a known bug in <code>instance</code></p>",
        "id": 433829921,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713371599
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/270676-lean4/topic/defLemma.20and.20docBlame.20linters.20on.20local.20instances.20in.20sections/near/433829830\">said</a>:</p>\n<blockquote>\n<p>it would be nice if <code>instance</code> automatically did <code>def</code>/<code>theorem</code> properly though</p>\n</blockquote>\n<p>Is there an issue for this? I couldn't find one.</p>",
        "id": 433897335,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713401313
    },
    {
        "content": "<p>no, I think it was just a TODO / HACK in the linter code</p>",
        "id": 433917082,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713415993
    },
    {
        "content": "<p>This still hasn't been fixed <span aria-label=\"confused\" class=\"emoji emoji-1f615\" role=\"img\" title=\"confused\">:confused:</span></p>",
        "id": 480126457,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1730500320
    },
    {
        "content": "<p>So the way forward here is to fix <code>instance</code>, not the linter, right?</p>",
        "id": 480126597,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1730500404
    },
    {
        "content": "<p>I think there is an open PR that fixes <code>instance</code></p>",
        "id": 480126884,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730500616
    }
]