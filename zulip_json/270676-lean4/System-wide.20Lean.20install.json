[
    {
        "content": "<p>I need to prepare distribution of Lean for my teaching. With Lean 3 it was super easy, I was able to make a debian package for my IT people and they would happily install it. The debian package was super simple, it would dump to <code>/usr/lib</code> the content of the lib folder in a Lean release (say <a href=\"https://github.com/leanprover-community/lean/releases/download/v3.51.1/lean-3.51.1-linux.tar.gz\">https://github.com/leanprover-community/lean/releases/download/v3.51.1/lean-3.51.1-linux.tar.gz</a>) and to <code>/usr/bin</code> the content of the <code>bin</code> folder. It was nice and tidy because the <code>lib</code> folder contained exactly one thing: a <code>lean</code> folder. I thought it would be the same with Lean 4, only 50 times bigger. But I see</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"bp\">~/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.15.0/lib</span>\n<span class=\"n\">clang</span><span class=\"w\">         </span><span class=\"n\">libatomic</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\">      </span><span class=\"n\">libclang</span><span class=\"bp\">-</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\">  </span><span class=\"n\">libLLVM</span><span class=\"bp\">-</span><span class=\"mf\">15.</span><span class=\"n\">so</span><span class=\"w\">     </span><span class=\"n\">libz</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"n\">crt1</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\">        </span><span class=\"n\">libatomic</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"n\">libc</span><span class=\"bp\">++.</span><span class=\"n\">so</span><span class=\"w\">           </span><span class=\"n\">libLLVM</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">        </span><span class=\"n\">libz</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">11</span>\n<span class=\"n\">crti</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\">        </span><span class=\"n\">libc</span><span class=\"bp\">++.</span><span class=\"n\">a</span><span class=\"w\">            </span><span class=\"n\">libc</span><span class=\"bp\">++.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\">         </span><span class=\"n\">libunwind</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\">       </span><span class=\"n\">Mcrt1</span><span class=\"bp\">.</span><span class=\"n\">o</span>\n<span class=\"n\">crtn</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\">        </span><span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\">         </span><span class=\"n\">libc</span><span class=\"bp\">++.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\">       </span><span class=\"n\">libunwind</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">      </span><span class=\"n\">Scrt1</span><span class=\"bp\">.</span><span class=\"n\">o</span>\n<span class=\"n\">gcrt1</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\">       </span><span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">        </span><span class=\"n\">libgcc_s</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">         </span><span class=\"n\">libunwind</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"n\">glibc</span><span class=\"w\">         </span><span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\">      </span><span class=\"n\">libgcc_s</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\">       </span><span class=\"n\">libunwind</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"n\">lean</span><span class=\"w\">          </span><span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\">    </span><span class=\"n\">libgmp</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\">            </span><span class=\"n\">libuv</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n<span class=\"n\">libatomic</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">  </span><span class=\"n\">libclang</span><span class=\"bp\">-</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">     </span><span class=\"n\">libLLVM</span><span class=\"bp\">-</span><span class=\"mf\">15.0</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\">   </span><span class=\"n\">libz</span><span class=\"bp\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>so I clearly don’t to put that in <code>/usr/lib/</code>, that would very likely brick the system for everybody. Is there anything I can do <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>?</p>",
        "id": 493896556,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736938155
    },
    {
        "content": "<p>Needless to say, storing a Lean toolchain in students home is completely impossible.</p>",
        "id": 493896746,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736938220
    },
    {
        "content": "<p>Where are you planning to store Mathlib?</p>",
        "id": 493896906,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736938282
    },
    {
        "content": "<p>I don't know much about Debian packaging but the usual solution is to install everything into a separate directory such as /opt/lean4 or /usr/local/lean4. The only additional step is that you then need to get that path's <code>bin/</code> into PATH or into the VS Code settings</p>",
        "id": 493897983,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736938671
    },
    {
        "content": "<p>Ok, I didn’t think about using a /opt folder.</p>",
        "id": 493898757,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736938920
    },
    {
        "content": "<p>I’ll try that.</p>",
        "id": 493898801,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736938923
    },
    {
        "content": "<p>Thanks</p>",
        "id": 493898855,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736938935
    },
    {
        "content": "<p>Hot take: This would be easier if the Lean community wasn't so opposed to distros packaging individual versions of lean. It is an important use case (downloading non-distro-provided binaries from the internet is a risk in general, although it is very convenient for upstream), and it wouldn't be impossible to print out diagnostic error messages in case of toolchain mismatches when the user's not using <code>elan</code>.</p>",
        "id": 493912300,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736943367
    },
    {
        "content": "<p>I do agree that not using <code>elan</code> is a bad idea if you're contributing to mathlib, though.</p>",
        "id": 493913133,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736943653
    },
    {
        "content": "<p>Even just having two different courses that want to use Lean may make a single global installation awkward very quickly</p>",
        "id": 493913308,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736943712
    },
    {
        "content": "<p>That applies to any software, and never preventing people packaging stuff.</p>",
        "id": 493916648,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736944748
    },
    {
        "content": "<p>And to be honest we’re not yet having to face two Lean courses in the same department.</p>",
        "id": 493916716,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736944773
    },
    {
        "content": "<p>I thought the issue of system-wide install of libs was solved last year, but it doesn’t seem true. What is the current workaround?</p>",
        "id": 493919873,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736945646
    },
    {
        "content": "<p>I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">toml</span>\n\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"test\"</span><span class=\"o\">]</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_lib</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Test\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_exe</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span>\n<span class=\"n\">root</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Main\"</span>\n\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/mathlib\"</span>\n\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">manifest</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">creating</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">scratch</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"bp\">-</span><span class=\"n\">to</span><span class=\"bp\">-</span><span class=\"n\">date</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">permission</span><span class=\"w\"> </span><span class=\"n\">denied</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">opt</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">olean</span><span class=\"bp\">.</span><span class=\"n\">lock</span>\n</code></pre></div>",
        "id": 493920089,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736945706
    },
    {
        "content": "<p>Needless to say, the copy of Mathlib in /opt/lean is fully compiled.</p>",
        "id": 493920340,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736945776
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> and <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, almost one year after <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Using.20a.20read-only.20lib.2E\">#lean4 &gt; Using a read-only lib.</a> , what is the current status? I know I should have asked one month ago before investing so much into trying to prepare some teaching using Lean 4, but my memory from last year thread was that there was a solution. The issue is simple. I want to teach using Lean in a computer lab. I cannot have a copy of Lean+mathlib into each student home. It’s not even a size only issue, the home directories are remote and accessing them would kill usability of Lean. I can ask once to put stuff in <code>/opt/</code> on all machines. The Lean toolchain and Mathlib need to live there. Then students will have exercises files and a course specific small lib in their home folder. Currently I have in <code>/opt/lean</code> the content of my <code>.elan/toolchains/leanprover--lean4---v4.15.0</code> and a compiled <code>mathlib</code>. I guess I should also put the dependencies of mathlib somehow. Then what? How do I create a project in user space that will access those resources without have write-access to <code>/opt/lean</code>?</p>",
        "id": 493922587,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736946414
    },
    {
        "content": "<p>As far as I know, it trying to create <code>lakefile.olean.lock</code> means that it believes the <code>lakefile.olean</code> is not up to date, so we would have to debug why it thinks that.</p>\n<blockquote>\n<p>I guess I should also put the dependencies of mathlib somehow</p>\n</blockquote>\n<p>Should they not already be part of the same <code>mathlib/.lake</code> directory?</p>",
        "id": 493924079,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736946867
    },
    {
        "content": "<p>I don’t know. The whole thing is a complete mystery to me.</p>",
        "id": 493924374,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736946964
    },
    {
        "content": "<p>It’s many orders of magnitude more mysterious than the Lean 3 analogue where you had lean files and olean files and nothing else.</p>",
        "id": 493924461,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736946993
    },
    {
        "content": "<p>Since this week office hours were cancelled, maybe we could have some office hours about that?</p>",
        "id": 493924587,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947033
    },
    {
        "content": "<p>But really I hope the spec is pretty clear and reproducible.</p>",
        "id": 493924684,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947064
    },
    {
        "content": "<p>One way to say it is: how can I put stuff in a read-only folder and then modify the lakefile/lake-manifest/lean-toolchain at <a href=\"https://github.com/PatrickMassot/verbose-lean4/\">https://github.com/PatrickMassot/verbose-lean4/</a> so that it sues the read-only folder.</p>",
        "id": 493925050,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947166
    },
    {
        "content": "<p>This is the extent of my knowledge, Mac will have to take over</p>",
        "id": 493925056,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736947168
    },
    {
        "content": "<p>The actual situation is slightly more complex because I have a lib with exercises depending on Verbose-lean, but I could simply put Verbose-lean inside to get back to the previous case.</p>",
        "id": 493925226,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947209
    },
    {
        "content": "<p>And in the mean time I get emails from my colleagues who teach with me but never use Lean otherwise. They ask why we are switching to Lean 4 which has no tada emoji when a proof is complete and where the goal display depends randomly on the cursor position <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span></p>",
        "id": 493925661,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947337
    },
    {
        "content": "<p>The pressure from them to switch back to Lean 3 is pretty strong, but that lake question may settle it anyway.</p>",
        "id": 493926002,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736947452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install/near/493925661\">said</a>:</p>\n<blockquote>\n<p>where the goal display depends randomly on the cursor position <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span></p>\n</blockquote>\n<p>Please file a bug report in the Lean 4 repository.</p>",
        "id": 493926211,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1736947536
    },
    {
        "content": "<p>Maybe I’m making progress. I try to use <code>sudo lake</code> on my machine until I reach a fixed point and then can use <code>lake</code> as a normal user.</p>",
        "id": 493928809,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736948345
    },
    {
        "content": "<p>Now I need to copy back the resulting /opt folder into user space, turn into a deb file again, install the deb file and pray.</p>",
        "id": 493929134,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736948443
    },
    {
        "content": "<p>I really hope next year this will be unneeded and I’ll attend Lean Together instead.</p>",
        "id": 493929977,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736948660
    },
    {
        "content": "<p>It seems to work! Now I need to try in a VM with a fresh Linux Mint install.</p>",
        "id": 493930892,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736948909
    },
    {
        "content": "<p>Was there something specific you had to change? Or fix unclear?</p>",
        "id": 493931011,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736948942
    },
    {
        "content": "<p>From last year thread by Pierre I took the idea of putting all dependencies of mathlib as top-level require in lakefile.toml. So I have a version of Verbose-lean whose lakefile.toml is:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"verbose\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"Verbose\"</span><span class=\"p\">]</span>\n\n<span class=\"k\">[leanOptions]</span>\n<span class=\"n\">pp</span><span class=\"p\">.</span><span class=\"n\">unicode</span><span class=\"p\">.</span><span class=\"n\">fun</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n<span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n<span class=\"n\">relaxedAutoImplicit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n<span class=\"n\">pp</span><span class=\"p\">.</span><span class=\"n\">proofs</span><span class=\"p\">.</span><span class=\"n\">withType</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/mathlib\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.15.0-patch1\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"aesop\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/aesop\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"batteries\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/batteries\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Cli\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/Cli\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"importGraph\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/importGraph/\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClient\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/LeanSearchClient/\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"plausible\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/plausible\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"proofwidgets\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/proofwidgets/\"</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Qq\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/Qq\"</span>\n\n<span class=\"k\">[[lean_lib]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Verbose\"</span>\n</code></pre></div>\n<p>And then there was the trick of using <code>sudo /opt/lean/bin/lake build</code> from user space before being able to do the same without sudo.</p>",
        "id": 493931913,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736949192
    },
    {
        "content": "<p>I did something really stupid: I created a VM with only 25Gb of disk space…</p>",
        "id": 493933733,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736949683
    },
    {
        "content": "<p>While I’m creating a new VM, my colleague sent me an email saying she asked ChatGPT to fix Lean 4 and the answer was we should write</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"c1\">-- Tactique pour afficher un message lorsque tous les buts sont résolus</span>\n<span class=\"kd\">meta</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">show_message_if_done</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">goals</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">tactic.get_goals</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"c1\">-- Récupère la liste des buts actuels</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">goals.empty</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\">         </span><span class=\"c1\">-- Si aucun but n'est restant</span>\n<span class=\"w\">    </span><span class=\"n\">io.println</span><span class=\"w\"> </span><span class=\"s2\">\"Gagné\"</span><span class=\"o\">,</span><span class=\"w\">       </span><span class=\"c1\">-- Affiche \"Gagné\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\">                 </span><span class=\"c1\">-- Sinon, ne rien faire</span>\n<span class=\"c1\">-- Exemple d'utilisation de cette tactique</span>\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n<span class=\"w\">  </span><span class=\"n\">refl</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">show_message_if_done</span><span class=\"o\">,</span><span class=\"w\">  </span><span class=\"c1\">-- Vérifie si tous les buts sont résolus</span>\n<span class=\"kd\">end</span>\n</code></pre></div>",
        "id": 493937650,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736950726
    },
    {
        "content": "<p>I would say this is a nice effort by ChatGPT. And also it’s clear I won’t be able to force my colleague to use Lean 4 if I don’t implement something like this in my exercise macro.</p>",
        "id": 493937891,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736950795
    },
    {
        "content": "<p>I’m not only writing this because I’m waiting on the VM. I think it’s an interesting data point for the core team. I didn’t anticipate the reaction to this issue would be so strong.</p>",
        "id": 493938160,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736950863
    },
    {
        "content": "<p>Luckil it's trivial:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"show_message_if_done\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getGoals</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"Gagné\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">show_message_if_done</span>\n</code></pre></div>",
        "id": 493941883,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736951848
    },
    {
        "content": "<p>I know that detecting the absence of goals trivial, and chatGPT almost got it right. I need a better version because <code>logInfo</code> is not really the right, but I’ll do it.</p>",
        "id": 493955277,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736955341
    },
    {
        "content": "<p>I can play with such things now that the deb file seems to be working. Of course I won’t know for sure until it’s deployed into actual computer labs instead of a VM, but I cannot do anything more at this stage.</p>",
        "id": 493955539,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736955405
    },
    {
        "content": "<p>(This is not relevant for Patrick this week, but for the future.)</p>\n<p>I think we should set up a test case, that is run e.g. by Mathlib CI, that verifies that a project with local links to all dependencies in read-only directories works.</p>\n<p>This would be an analogue of the new <code>DownstreamTest</code> directory we've installed in Mathlib, which verifies that a downstream-of-Mathlib project can successively retrieve and use the Mathlib cache. (Importantly, this is <em>part of Mathlib</em>, so it gets tested on every nightly release of Lean.)</p>\n<p>This might be a variant of the existing <code>DownstreamTest</code>, but we run the test inside bubblewrap to ensure that it works even if the <code>../</code> path is (virtually) read-only.</p>",
        "id": 494035565,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736983756
    },
    {
        "content": "<p>This would indeed be very nice. And documenting the whole thing would be very nice.</p>",
        "id": 494035763,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736983851
    },
    {
        "content": "<p>I think something we need to make system-wide installs sane is the option to tell Lake that when we use <code>path = \"/x/y/z\"</code>, transitive dependencies of that require should live in the <code>.lake</code> folder of that path, not in the local <code>.lake</code> folder. This would remove the need to inline all the <code>[[require]]</code> statements for transitive dependencies as Patrick has done <a href=\"#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install/near/493931913\">above</a>.</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, is this a possibility? I hope it is. :-)</p>",
        "id": 494035904,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736983926
    },
    {
        "content": "<p>Talking about  documentation, let me record here that such “weird” setup require ask forgiveness to the VSCode extension. There is an option (thank Marc!) to switch off setup warnings that needs to be activated in order to avoid having students seeing alarming messages about elan not being found.</p>",
        "id": 494035912,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736983931
    },
    {
        "content": "<p>See also <a href=\"https://github.com/leanprover/vscode-lean4/blob/master/vscode-lean4/manual/manual.md#setup-diagnostics\">this section</a> in the vscode-lean4 manual.</p>",
        "id": 494082418,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1737013160
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install/near/494035904\">said</a>:</p>\n<blockquote>\n<p>I think something we need to make system-wide installs sane is the option to tell Lake that when we use <code>path = \"/x/y/z\"</code>, transitive dependencies of that require should live in the <code>.lake</code> folder of that path, not in the local <code>.lake</code> folder. This would remove the need to inline all the <code>[[require]]</code> statements for transitive dependencies as Patrick has done <a href=\"#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install/near/493931913\">above</a>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span>, is this a possibility? I hope it is. :-)</p>\n</blockquote>\n<p>One way to approximate this with the current behavior is to set <code>packagesDir</code> as Henrik did in the doc-gen4 case. Lake will use said directory to resolve all remote dependencies For example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">packagesDir</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.15.0-patch1\"</span>\n</code></pre></div>\n<p>Will use <code>/opt/lean/lib</code> to store (and retrieve) the cloned copy of Mathlib and all its transitive dependencies.</p>",
        "id": 494174155,
        "sender_full_name": "Mac Malone",
        "timestamp": 1737041249
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>  Would it be difficult to make <code>packagesDir</code> an <code>Array String</code> to search through for a matching package?</p>",
        "id": 494290727,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1737094778
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> Nontrivial. It is oiginally designed to merely be the the place where cloned repositories are stored, so it the code is not really structured around it operating a search path.</p>",
        "id": 494291032,
        "sender_full_name": "Mac Malone",
        "timestamp": 1737094956
    },
    {
        "content": "<p>Thanks. To be clear: that was an honest question and not a request. I entertained the idea for a bit but I don't think I have a current need for this feature.</p>",
        "id": 494293717,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1737096711
    },
    {
        "content": "<p>Thanks Mac. It’s too late for this year but it may help next year (although I hope there will be an easier way to setup things by then). What led me away from this trying this option when reading doc at <a href=\"https://github.com/leanprover/lean4/blob/master/src/lake/README.md#layout\">https://github.com/leanprover/lean4/blob/master/src/lake/README.md#layout</a> was the “These options control the top-level directory layout of the package” which I read as saying “those options are all about stuff that live inside the working copy of your project git repository” whereas you’re saying this can refer to any folder in the system.</p>",
        "id": 494314983,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1737105356
    },
    {
        "content": "<p>Is there any news about the questions from this topic (and the related <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Using.20a.20read-only.20lib.2E/with/426826591\">#lean4 &gt; Using a read-only lib.</a> )? Recall the question is how to use Mathlib (and other dependencies) from a read-only system-wide location without hacks. Is there documentation about it? I’m asking because this time I don’t want to wait until the last minute to solve the issue when I’ll restart teaching using Lean in January.</p>",
        "id": 558913259,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1763922681
    },
    {
        "content": "<p>I wonder if the system wide cache that <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> has been working on could be (ab)used for this?</p>",
        "id": 558915548,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1763924777
    },
    {
        "content": "<p>This is a really basic requirement for teaching, it would be nice to have something more than hacks or abuses.</p>",
        "id": 558924378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1763933736
    },
    {
        "content": "<p>You can have a Docker image available system wide. Students run the image, work by connecting to it using vscode ssh remote plugin, they can mess with it. but when someone else runs it, it's as good as new.</p>",
        "id": 558925578,
        "sender_full_name": "Alfredo Moreira-Rosa",
        "timestamp": 1763935078
    },
    {
        "content": "<p>Thanks, but I really need something simple. This is not even a computer science class.</p>",
        "id": 558927148,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1763936814
    },
    {
        "content": "<p>Patrick, maybe contact <span class=\"user-mention\" data-user-id=\"300245\">@Filippo A. E. Nuccio</span>  because it seems he did something around what i'm proposing and it's not that complex to setup with a dev container. It can be as easy as cloning a github repository.</p>\n<p>Filippo repo :<br>\n<a href=\"https://plmlab.math.cnrs.fr/nuccio/octonions/-/blob/UnivLE_19153/.devcontainer/devcontainer.json?ref_type=heads\">https://plmlab.math.cnrs.fr/nuccio/octonions/-/blob/UnivLE_19153/.devcontainer/devcontainer.json?ref_type=heads</a></p>\n<p>vscode overview :<br>\n<a href=\"https://code.visualstudio.com/docs/devcontainers/containers\">https://code.visualstudio.com/docs/devcontainers/containers</a></p>",
        "id": 559029470,
        "sender_full_name": "Alfredo Moreira-Rosa",
        "timestamp": 1763987134
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/270676-lean4/topic/System-wide.20Lean.20install/near/558913259\">said</a>:</p>\n<blockquote>\n<p>Is there any news about the questions from this topic (and the related <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Using.20a.20read-only.20lib.2E/with/426826591\">#lean4 &gt; Using a read-only lib.</a> )? Recall the question is how to use Mathlib (and other dependencies) from a read-only system-wide location without hacks. Is there documentation about it? I’m asking because this time I don’t want to wait until the last minute to solve the issue when I’ll restart teaching using Lean in January.</p>\n</blockquote>\n<p>Mac is on PTO this week but to me it sounds like the <code>packagesDir</code> option remains the most robust option (modulo someone giving it a try?). If completely frozen, global dependencies is exactly what you need, it should give you just that, nothing more or less and so least likely to change in the future. If people do want to go that way, we will add a corresponding test to our test suite to detect any regressions.</p>",
        "id": 559044839,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763991021
    },
    {
        "content": "<p>FWIW when I run a course then the day before it starts I <code>lake update mathlib</code> and then I would never dream of running it ever again, because historically it was hard enough getting the mathematicians up and running the first time, and bumping mathlib is a recipe for orange bar hell midway through term when project deadlines are due and people are typing in random commands because something broke and the LLM made some \"helpful\" suggestion. </p>\n<p>More recently I've found it much more likely that people are able to get up and running (because the docs are good), but I have still never lost the mentality of \"if it ain't broke, don't touch <code>lake-manifest.json</code>\". In other words, completely frozen, global dependencies is definitely exactly what I (think I) need.</p>",
        "id": 559072831,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763997143
    },
    {
        "content": "<p>That is definitely the correct strategy but as far as I understood Patrick, he means \"global\" more extensively than that in that there should only be one copy of Mathlib as individual students' machines/home directories do not have enough disk space to download the cache themselves.</p>",
        "id": 559075109,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763997618
    },
    {
        "content": "<p>Yes, I understand that Patrick is asking something even more demanding, all I'm saying is \"completely frozen, global dependencies\" is something which is definitely useful for teaching (because I independently came to the same conclusion as Patrick that this is best for mathematicians).</p>",
        "id": 559081289,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763998942
    },
    {
        "content": "<p>Thanks Sebastian, I’ll try that. Is there documentation beyond <a href=\"https://lean-lang.org/doc/reference/latest/Build-Tools-and-Distribution/Lake/#Lake___PackageConfig-packagesDir\">https://lean-lang.org/doc/reference/latest/Build-Tools-and-Distribution/Lake/#Lake___PackageConfig-packagesDir</a>?</p>",
        "id": 560131432,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1764070955
    },
    {
        "content": "<p>I mean a sentence mentioning shared system-wide dependencies. Otherwise it’s really hard to understand without asking here.</p>",
        "id": 560131593,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1764071001
    },
    {
        "content": "<p>Let's sync on that with Mac next week I'd suggest. It is a new use case for this field so that's why there is no documentation for it so far but it is one that I think we want to support in this shape - and then should document it.</p>",
        "id": 560139279,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764073322
    },
    {
        "content": "<p>Thanks Sebastian. Maybe I should clarify: last year I managed to get this to work, and I have no doubt I’ll manage again, but I think it’s important to document this.</p>",
        "id": 560147378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1764075545
    },
    {
        "content": "<p>(presumably this is \"no doubt\")</p>",
        "id": 560147627,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764075608
    },
    {
        "content": "<p>Oh I see, that was not clear from reading this topic. Let's enshrine it in the docs and test suite then!</p>",
        "id": 560147798,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764075649
    },
    {
        "content": "<p>Sorry about the unclear messages. I’m running constantly and type everything in a hurry.</p>",
        "id": 560187068,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1764084863
    }
]