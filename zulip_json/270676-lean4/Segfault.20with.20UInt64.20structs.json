[
    {
        "content": "<p>Anyone know why this <code>UInt64</code> computation segfaults? It has no imports, but seems fragile when I try to minimise it further. I'm on <code>leanprover/lean4:v4.22.0-rc4</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">  </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨~~~</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">lo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">hi</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">of_lo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">of_lo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">of_lo</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775748</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">lo</span><span class=\"w\">  </span><span class=\"c1\">-- Segfault</span>\n</code></pre></div>\n<p>It seems to be segfaulting trying to unbox something:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">julia</span><span class=\"o\">:</span><span class=\"n\">interval</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">lldb</span><span class=\"w\"> </span><span class=\"c1\">-- $(/usr/bin/which lean) test/segfault.lean</span>\n<span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/homebrew/bin/lean\"</span>\n<span class=\"n\">Current</span><span class=\"w\"> </span><span class=\"n\">executable</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">opt</span><span class=\"bp\">/</span><span class=\"n\">homebrew</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arm64</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">settings</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"c1\">-- target.run-args  \"test/segfault.lean\"</span>\n<span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">run</span>\n<span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"mi\">22301</span><span class=\"w\"> </span><span class=\"n\">launched</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">opt</span><span class=\"bp\">/</span><span class=\"n\">homebrew</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arm64</span><span class=\"o\">)</span>\n<span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"mi\">22301</span><span class=\"w\"> </span><span class=\"n\">stopped</span>\n<span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">exec</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001000149c0</span><span class=\"w\"> </span><span class=\"n\">dyld</span><span class=\"ss\">`_dyld_start</span>\n<span class=\"n\">dyld</span><span class=\"ss\">`_dyld_start</span><span class=\"o\">:</span>\n<span class=\"bp\">-&gt;</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x1000149c0</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">0</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sp</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x1000149c4</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">4</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">and</span><span class=\"w\">    </span><span class=\"n\">sp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">xfffffffffffffff0</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x1000149c8</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">8</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"n\">x29</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x1000149cc</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">12</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mov</span><span class=\"w\">    </span><span class=\"n\">x30</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"mi\">0</span>\n<span class=\"n\">Target</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">stopped</span><span class=\"bp\">.</span>\n<span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"mi\">22301</span><span class=\"w\"> </span><span class=\"n\">resuming</span>\n<span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"mi\">22301</span><span class=\"w\"> </span><span class=\"n\">stopped</span>\n<span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">EXC_BAD_ACCESS</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x9</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c459860</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">unbox_t</span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">48</span>\n<span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">unbox_t</span><span class=\"o\">:</span>\n<span class=\"bp\">-&gt;</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x10c459860</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">48</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ldr</span><span class=\"w\">    </span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">x8</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x10c459864</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">52</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ldp</span><span class=\"w\">    </span><span class=\"n\">x29</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x30</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">x10</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x10c459868</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">56</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ldp</span><span class=\"w\">    </span><span class=\"n\">x20</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x19</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sp</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"n\">x20</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">x10c45986c</span><span class=\"w\"> </span><span class=\"bp\">&lt;+</span><span class=\"mi\">60</span><span class=\"bp\">&gt;</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ret</span>\n<span class=\"n\">Target</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">stopped</span><span class=\"bp\">.</span>\n<span class=\"o\">(</span><span class=\"n\">lldb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">bt</span>\n<span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">EXC_BAD_ACCESS</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x9</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c459860</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">unbox_t</span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">48</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c45f948</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">eval_body</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">object_ref</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3160</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c45be94</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">load</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">488</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c45f948</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">eval_body</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">object_ref</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3160</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c45be94</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">load</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">488</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c45f948</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">eval_body</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">object_ref</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3160</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">6</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010c46185c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">ir</span><span class=\"bp\">::</span><span class=\"n\">interpreter</span><span class=\"bp\">::</span><span class=\"n\">call</span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">array_ref</span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">object_ref</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">&amp;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1224</span>\n</code></pre></div>",
        "id": 532598039,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754254207
    },
    {
        "content": "<p>This also fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">  </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">~~~</span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">hi</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">exp</span>\n</code></pre></div>",
        "id": 532599044,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754254864
    },
    {
        "content": "<p>Replacing <code>Neg</code> with a plain function fixes it, but I don't know why type classes would matter.</p>",
        "id": 532599169,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754254934
    },
    {
        "content": "<p>typeclasses are inlined maybe?</p>",
        "id": 532599235,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754254970
    },
    {
        "content": "<p>what happens when you make <code>Neg</code> a plain function but also <code>@[inline]</code>?</p>",
        "id": 532599277,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754254987
    },
    {
        "content": "<p>Edited above, fails without any typeclasses</p>",
        "id": 532599329,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754255016
    },
    {
        "content": "<p>I think the issue is that <code>0</code> fits in a tagged pointer but <code>~~~0</code> does not</p>",
        "id": 532599376,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754255049
    },
    {
        "content": "<p>Oh, wild! Seems dangerous if the compiler is trying to unbox fully 64-bit values.</p>",
        "id": 532599435,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754255088
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span></p>",
        "id": 532599507,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754255136
    },
    {
        "content": "<p>Oh this is bad:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"bp\">._</span><span class=\"n\">closed_0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">complement</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_2</span>\n</code></pre></div>\n<p>It should take <code>(0 : UInt64)</code> but is provided with <code>(0 : Nat)</code></p>",
        "id": 532599795,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754255321
    },
    {
        "content": "<p>It should also be constant folded but that's more of a missing feature</p>",
        "id": 532600336,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754255664
    },
    {
        "content": "<p>^ Though that would have made it harder to minimise! :)</p>",
        "id": 532600492,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754255774
    },
    {
        "content": "<p>How do you know it isn't constant folded? <code>exp</code> and <code>zero</code> here are constants themselves, and I'd think at runtime they would be evaluated at most once.</p>",
        "id": 532600702,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1754255931
    },
    {
        "content": "<p>This is probably too imprecise: <a href=\"https://github.com/leanprover/lean4/blob/8f575bf9868a11f7d74bbcf2e1b26c30a5b8a85e/src/Lean/Compiler/LCNF/ElimDeadBranches.lean#L177-L184\">https://github.com/leanprover/lean4/blob/8f575bf9868a11f7d74bbcf2e1b26c30a5b8a85e/src/Lean/Compiler/LCNF/ElimDeadBranches.lean#L177-L184</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofLCNFLit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LCNF</span><span class=\"bp\">.</span><span class=\"n\">LitValue</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Value</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"c1\">-- TODO: We could make this much more precise but the payoff is questionable</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">top</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint8</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt8</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint16</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt16</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint32</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint64</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">usize</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 532600800,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754255998
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/270676-lean4/topic/Segfault.20with.20UInt64.20structs/near/532600702\">said</a>:</p>\n<blockquote>\n<p>How do you know it isn't constant folded? <code>exp</code> and <code>zero</code> here are constants themselves, and I'd think at runtime they would be evaluated at most once.</p>\n</blockquote>\n<p>That closed term can obviously be evaluated to a constant right away instead of doing a function call.</p>",
        "id": 532601012,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754256134
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/270676-lean4/topic/Segfault.20with.20UInt64.20structs/near/532600800\">said</a>:</p>\n<blockquote>\n<p>This is probably too imprecise: <a href=\"https://github.com/leanprover/lean4/blob/8f575bf9868a11f7d74bbcf2e1b26c30a5b8a85e/src/Lean/Compiler/LCNF/ElimDeadBranches.lean#L177-L184\">https://github.com/leanprover/lean4/blob/8f575bf9868a11f7d74bbcf2e1b26c30a5b8a85e/src/Lean/Compiler/LCNF/ElimDeadBranches.lean#L177-L184</a></p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofLCNFLit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LCNF</span><span class=\"bp\">.</span><span class=\"n\">LitValue</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Value</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"c1\">-- TODO: We could make this much more precise but the payoff is questionable</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">top</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint8</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt8</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint16</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt16</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint32</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">uint64</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">usize</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This pass is not at all related to constant folding, it's an abstract interpreter for eliminating branches that can never be hit. Constant folding happens in the simplifier and doesn't trigger because UInt.complement didn't exist when I wrote it.</p>",
        "id": 532601193,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754256248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/Segfault.20with.20UInt64.20structs/near/532601012\">said</a>:</p>\n<blockquote>\n<p>That closed term can obviously be evaluated to a constant right away instead of doing a function call.</p>\n</blockquote>\n<p>Hmm, it was my understanding that that is what the compiler does: evaluate it to a constant, instead of doing the function call. This runtime behaviour just isn't reflected very clearly in the trace.</p>",
        "id": 532601467,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1754256422
    },
    {
        "content": "<p>It is the job of the compiler to do that but it doesn't</p>",
        "id": 532601667,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754256550
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/270676-lean4/topic/Segfault.20with.20UInt64.20structs/near/532601193\">schrieb</a>:</p>\n<blockquote>\n<p>This pass is not at all related to constant folding, it's an abstract interpreter for eliminating branches that can never be hit.</p>\n</blockquote>\n<p>You'd think but</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">floatLetIn</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">complement</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mono</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">elimDeadBranches</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">elimDeadBranches</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">complement</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span>\n</code></pre></div>\n<p>I can't really look at the types of these but I'd guess <code>_x.2</code> is typed <code>Nat</code> here</p>",
        "id": 532601731,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754256603
    },
    {
        "content": "<p>Oh I thought you meant to implement the constant folding, it's totally plausible that elim dead branches is at fault yeah, I wrote it blindly back when we had no means to execute LCNF so it's certainly not as well tested as it could be by now.</p>",
        "id": 532601910,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754256710
    },
    {
        "content": "<p>Actually yeah I can (<code>pp.letVarTypes</code>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">floatLetIn</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">complement</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mono</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">elimDeadBranches</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">elimDeadBranches</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">UInt128</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"bp\">.</span><span class=\"n\">complement</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span>\n</code></pre></div>",
        "id": 532601963,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754256753
    },
    {
        "content": "<p>Yeah it's elimDeadBranches</p>",
        "id": 532601982,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754256766
    },
    {
        "content": "<p>Thanks for tracking it down, <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>. This code is making an assumption that all boxed integer values are represented uniformly, but this is not actually the case: a boxed <code>Nat</code> <code>0</code> will be represented as <code>0x1</code>, whereas a boxed <code>UInt64</code> <code>0</code> will be represented as an allocation containing a single <code>0</code> field. If we switched boxed <code>UInt64</code> to use the same representation as <code>Nat</code>, this problem would go away.</p>",
        "id": 532603212,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1754257649
    },
    {
        "content": "<p>Even if we're in mono, it should still not change the type though? <code>UInt64</code> is an unboxed <code>u64</code> and <code>Nat</code> is an <code>obj</code>.</p>",
        "id": 532604277,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754258454
    },
    {
        "content": "<p>While <code>LCNF</code> tries to preserve types (more in <code>base</code> than in <code>mono</code>), it is more for optimization hints. In <code>mono</code>, we would be okay if the two types had the same runtime representation. Another example where we do this is with constructors of inductives; we sometimes erase their parameters and can no longer distinguish between values that originated with those distinct parameters. This is acceptable because we use a uniform representation that never actually depends on the parameters.</p>",
        "id": 532605300,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1754259059
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/9703\">lean4#9703</a></p>",
        "id": 532607953,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1754260942
    },
    {
        "content": "<p>I'm excited this is merged! What's the ETA for it showing up in a Lean release? I'd be curious to see if there are any other compiler bugs uncovered by all of my UInt64 code.</p>\n<p>Alternatively, is there an easy way for me to test prior to it showing up in a release?</p>",
        "id": 532986767,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754426281
    },
    {
        "content": "<p>Just selected \"Lean Nightly\" on <a href=\"https://live.lean-lang.org\">https://live.lean-lang.org</a>. For that you'll just need to wait one day.</p>",
        "id": 532989277,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754427609
    },
    {
        "content": "<p>Will Mathlib usually compile against nightly? (My code is dependently typed with types that depend on big chunks of Mathlib to get to the parts I want to run.)</p>",
        "id": 532991666,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754428955
    },
    {
        "content": "<p>No, it certainly won't</p>",
        "id": 532992557,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754429461
    },
    {
        "content": "<p>Perhaps <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> has plans to backport to a 4.22.0-rc5?</p>",
        "id": 532992651,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754429510
    },
    {
        "content": "<p>I merged it to the 4.22.0 branch, but I don’t think there’s a need to spin another RC for this, since the fix I picked just disables the optimization for these literal types.</p>",
        "id": 532993195,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1754429834
    },
    {
        "content": "<p>There is <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/\">https://github.com/leanprover-community/mathlib4-nightly-testing/</a> but there is no \"easy\" way of getting it to run such as through <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a></p>",
        "id": 532993265,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754429879
    },
    {
        "content": "<p>By which you mean \"this will land in the 4.22.0 release at the end of the release cycle, but there's no need to do an additional test release because it's not going to break anything\"?</p>",
        "id": 532993350,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754429939
    },
    {
        "content": "<p>Turns out adding <code>mathlib4-nightly-testing</code> as a dependency works well enough (just tested):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4-nightly-testing.git\"</span>\n</code></pre></div>\n<p>Note though that this revision does not fully build so you can't actually <code>import Mathlib</code></p>",
        "id": 532996994,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754432189
    },
    {
        "content": "<p>If you want that then you can specify the revision 2938a33f27851461e335c0d0be408d976dddb0e3 which is the last one that built but then you're not going to get the fix</p>",
        "id": 532997077,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754432250
    },
    {
        "content": "<p>The last option would just be to wait</p>",
        "id": 532997096,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754432264
    },
    {
        "content": "<p>Yep, I may wait then. Might resurrect my attempt at the Koebe quarter theorem in the mean time.</p>",
        "id": 532998321,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754433178
    },
    {
        "content": "<p>Regarding using Mathlib on nightly releases: please look for the <code>nightly-testing-YYYY-MM-DD</code> tags that appear on the <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing\">https://github.com/leanprover-community/mathlib4-nightly-testing</a> fork. These don't necessarily get generated every day, but when they are generated they are guaranteed to work (and use the relevant Lean4 nightly toolchain).</p>",
        "id": 533006685,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754440634
    },
    {
        "content": "<p>Updating <a href=\"https://github.com/girving/interval\">https://github.com/girving/interval</a> to to <code>leanprover/lean4:v4.23.0-rc2</code> fixes the problem, so that compiler bug was the only issue. <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 534616643,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1755246150
    }
]