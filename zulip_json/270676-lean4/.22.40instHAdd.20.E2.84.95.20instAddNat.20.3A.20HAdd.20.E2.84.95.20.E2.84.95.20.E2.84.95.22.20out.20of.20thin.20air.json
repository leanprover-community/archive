[
    {
        "content": "<p>I'm posting this here even though the example below is not Mathlib-free because I think that the underlying problem is not Mathlib-specific.</p>\n<p>Consider the following.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ZZZ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">xyz</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZZZ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZZZ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>and go to the last trace block but one (<code>Test.lean:15.53</code>), whose first line unfolds as follows</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.isDefEq] ✅️ baz (ZZZ (Polynomial.X + Polynomial.C 1)) =?= baz (ZZZ (?m.286 + ?m.289)) ▼\n  [] ✅️ ZZZ (Polynomial.X + Polynomial.C 1) =?= ZZZ (?m.286 + ?m.289) ▼\n    [] ❌️ Polynomial.X + Polynomial.C 1 =?= ?m.286 + ?m.289 ▼\n      [] ❌️ instHAdd =?= instHAdd ▼\n        [] ❌️ Polynomial F =?= ℕ ▼\n          [onFailure] ❌️ Polynomial F =?= ℕ\n        [] ❌️ { hAdd := fun a b ↦ Add.add a b } =?= { hAdd := fun a b ↦ Add.add a b } ▶\n      [] ❌️ Polynomial.X =?= ?m.286 ▶\n      [] ❌️ instHAdd.1 Polynomial.X (Polynomial.C 1) =?= instHAdd.1 ?m.286 ?m.289 ▶\n    [] ✅️ sorry =?= sorry\n</code></pre></div>\n<p>If I hover over the left-hand <code>+</code> in the line</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>    [] ❌️ Polynomial.X + Polynomial.C 1 =?= ?m.286 + ?m.289 ▼\n</code></pre></div>\n<p>I see</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@HAdd.hAdd (Polynomial F) (Polynomial F) (Polynomial F) instHAdd Polynomial.X (Polynomial.C 1) : Polynomial F\n</code></pre></div>\n<p>and a secondary hover on <code>instHAdd</code> shows</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@instHAdd (Polynomial F) Polynomial.add' : HAdd (Polynomial F) (Polynomial F) (Polynomial F)\n</code></pre></div>\n<p>Similarly, hovering on the right hand <code>+</code> and then on <code>instHAdd</code> shows</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@HAdd.hAdd (Polynomial F) (Polynomial F) (Polynomial F) instHAdd ?m.286 ?m.289 : Polynomial F\n@instHAdd (Polynomial F) Polynomial.add' : HAdd (Polynomial F) (Polynomial F) (Polynomial F)\n</code></pre></div>\n<p>Now consider the next line,</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>      [] ❌️ instHAdd =?= instHAdd ▼\n</code></pre></div>\n<p>The left <code>instHAdd</code> shows (unsuprisingly)</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@instHAdd (Polynomial F) Polynomial.add' : HAdd (Polynomial F) (Polynomial F) (Polynomial F)\n</code></pre></div>\n<p>but on the one on the right, I get</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@instHAdd ℕ instAddNat : HAdd ℕ ℕ ℕ\n</code></pre></div>\n<p><span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span> <span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span> <span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span> Where did that come from <span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span> <span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span> <span aria-label=\"question\" class=\"emoji emoji-2753\" role=\"img\" title=\"question\">:question:</span></p>\n<p>This leads to failure of unification at this point (it later succeeds because it unifies the <code>sorry</code>s, but this is not the point here).</p>\n<p>In more realistic scenarios, this can cause a timeout by a thousand unfoldings (in my concrete case, <code>ZZZ</code> is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AdjoinRoot#doc\">docs#AdjoinRoot</a>, <code>bar</code> is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Field#doc\">docs#Field</a> and <code>baz.of</code> is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AdjoinRoot.instField#doc\">docs#AdjoinRoot.instField</a> . This gave me a timeout, which I found a work-around for. I later noticed that <code>seal AdjoinRoot in</code> also prevents the timeout: this cuts the unfolding short and makes unification succeed in a later attempt.)</p>\n<p>Can the unification specialists shed some light on this?</p>",
        "id": 523628000,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749671392
    },
    {
        "content": "<p>Multiplication behaves slightly differently: replacing <code>+</code> by <code>*</code> results in</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.isDefEq] ✅️ baz (ZZZ (Polynomial.X * Polynomial.C 1)) =?= baz (ZZZ (?m.291 * ?m.294)) ▼\n  [] ✅️ ZZZ (Polynomial.X * Polynomial.C 1) =?= ZZZ (?m.291 * ?m.294) ▼\n    [] ❌️ Polynomial.X * Polynomial.C 1 =?= ?m.291 * ?m.294 ▼\n      [] ❌️ Polynomial.X =?= ?m.291 ▼\n        [] Polynomial.X [nonassignable] =?= ?m.291 [nonassignable]\n</code></pre></div>\n<p>so here unification fails because the metavariable is nonassignable (which looks like there might be a similar problem as in <a href=\"https://github.com/leanprover/lean4/pull/8364\">lean4#8364</a>).</p>",
        "id": 523632592,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749673106
    },
    {
        "content": "<p>oh boy, nonassignable again</p>",
        "id": 523632684,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749673153
    },
    {
        "content": "<p>I wonder whether unification problems involving nonassignable metavariables should not better be deferred as far as possible. I imagine they can only succeed by unfolding until the metavariable gets eliminated, which in most real-world scenarios is unlikely to happen.</p>",
        "id": 523633024,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749673309
    }
]