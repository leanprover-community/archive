[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>  I'm making some progress towards finishing iProp, but I'm a little stuck on one part and wondering what you think. Your definition of <code>OFunctor</code> is a typeclass on top of functions <code>(Type _ -&gt; Type _ -&gt; Type _)</code> rather than the bundled Iris version <code>(COFE -&gt; COFE -&gt; OFE)</code>.  I'm not sure how to write an OFunctor in the case that the result type is only defined when the input types are COFE's.   </p>\n<p>The particular difficulty here comes when defining <code>uPred</code>, which in Rocq is parameterized by a <code>UCMRA</code>. If I define a bundled version of <code>uPred</code> (like how it is in my branch right now), then the <code>OFunctor</code> is only defined when the input types are COFE's. On the other hand, when I define an unbundled version (ie. moving the <code>uPred_mono</code> field to a separate typeclass so I can remove the <code>UCMRA</code> requirement from <code>uPred</code>) the type is no longer complete, and I cannot prove that <code>uPred</code> is a <code>COFE</code>. </p>\n<p>Have you (or anyone) seen an issue like this before? I couldn't figure this issue out when I was working in Eileen either. The code at the bottom of <a href=\"https://github.com/markusdemedeiros/iris-lean/blob/upred/src/Iris/Algebra/uPred.lean\">my branch</a> illustrates the issue concretely.</p>",
        "id": 510398106,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743877258
    },
    {
        "content": "<p>hm, I was rather hoping that such functions would not come up</p>",
        "id": 510401788,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743879833
    },
    {
        "content": "<p>Yeah. FWIW the unbundled version seems to work fine with the other oFunctors I've tried (though I'm not finished with those yet either).</p>",
        "id": 510402564,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743880349
    },
    {
        "content": "<p>I pushed a fix, allowing the functor to depend on OFE structure</p>",
        "id": 510407822,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884141
    },
    {
        "content": "<p>I can add COFE structure too if needed, but I prefer to keep it as loose as reasonably possible</p>",
        "id": 510407933,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884223
    },
    {
        "content": "<p>Nice! Thanks for doing that, I'm a little surprised it was fixable!! </p>\n<p>I believe that dependence on COFE is necessary. The reason why is because the <code>uPred</code> <code>OFunctor</code> looks like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">uPredOF</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">URFunctor</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">uPred</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">URFunctor</span><span class=\"bp\">.</span><span class=\"n\">cmra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>so we need <code>F B A</code> to be a <code>UCMRA</code>. We get that from the <code>URFunctor</code> field</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">URFunctor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">cmra</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">COFE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">COFE</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UCMRA</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span>\n<span class=\"w\">   </span><span class=\"c1\">-- ...</span>\n</code></pre></div>\n<p>which requires the arguments to be <code>COFE</code>s.</p>",
        "id": 510408397,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743884548
    },
    {
        "content": "<p>why is that there though?</p>",
        "id": 510408485,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884636
    },
    {
        "content": "<p>Are you asking why <code>URFunctors</code> require <code>COFE</code>s rather than <code>OFE</code>'s?</p>",
        "id": 510408583,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743884708
    },
    {
        "content": "<p>yes</p>",
        "id": 510408586,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884714
    },
    {
        "content": "<p>Every <code>URFunctor</code> is an <code>OFunctor</code> which has the same restriction. I do not know why <code>OFunctors</code> have this requirement off the top of my head.</p>",
        "id": 510408696,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743884792
    },
    {
        "content": "<p>indeed, one can just replace COFE by OFE everywhere in OFunctor and it still works</p>",
        "id": 510408858,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884890
    },
    {
        "content": "<p>I suspect we just don't have enough examples to see the rationale</p>",
        "id": 510408898,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884920
    },
    {
        "content": "<p>maybe we should just downgrade everything to OFE now and that way we'll notice when something gets stuck later</p>",
        "id": 510408985,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743884979
    },
    {
        "content": "<p>intuitively, COFE \"shouldn't\" matter since it's just a proposition and not data</p>",
        "id": 510409057,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743885013
    },
    {
        "content": "<p>I agree that we should try with just OFE. If you're confident that it's easy to change after the fact then yeah, we might as well do some destructive testing on Iris (lol)</p>",
        "id": 510409297,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743885172
    },
    {
        "content": "<p>yeah, upgrading/downgrading these typeclasses has very little impact on most proofs</p>",
        "id": 510409338,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743885216
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/490604-iris-lean/topic/OFunctor.20definition/near/510409057\">said</a>:</p>\n<blockquote>\n<p>intuitively, COFE \"shouldn't\" matter since it's just a proposition and not data</p>\n</blockquote>\n<p>oh wait, that's a lie. COFE's have a <code>compl</code> field which is data (although I suspect it won't be computable in most cases)</p>",
        "id": 510409748,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743885497
    },
    {
        "content": "<p>A relevant snippet from Iris From the Ground Up: <a href=\"/user_uploads/3121/lOY8aKkCKZw4QCvVqFjqjjAO/Screenshot-2025-04-05-at-5.02.57PM.png\">Screenshot 2025-04-05 at 5.02.57 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/lOY8aKkCKZw4QCvVqFjqjjAO/Screenshot-2025-04-05-at-5.02.57PM.png\" title=\"Screenshot 2025-04-05 at 5.02.57 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1392x1572\" src=\"/user_uploads/thumbnail/3121/lOY8aKkCKZw4QCvVqFjqjjAO/Screenshot-2025-04-05-at-5.02.57PM.png/840x560.webp\"></a></div>",
        "id": 510412044,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1743887009
    },
    {
        "content": "<p>sounds like it is the right idea to start with OFEs and upgrade as needed then</p>",
        "id": 510413283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743887872
    }
]