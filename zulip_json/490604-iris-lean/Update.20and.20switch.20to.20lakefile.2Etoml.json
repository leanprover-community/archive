[
    {
        "content": "<p>As the topic says, I'd like to try bringing iris-lean upto toolchain v4.17.0 and switch the lakefile.lean with lakefile.toml. Seems easier to do it earlier in a project</p>",
        "id": 506163807,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742220753
    },
    {
        "content": "<p>Here's a PR : <a href=\"https://github.com/leanprover-community/iris-lean/pull/16\">https://github.com/leanprover-community/iris-lean/pull/16</a></p>",
        "id": 506165672,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742221135
    },
    {
        "content": "<p>As a general policy matter: Iris-lean works on the latest stable release, so updates to bump the lean version are usually rubber stamped. If someone could figure out how to set it up to use lean-action to do automatic version bumps I would be grateful</p>",
        "id": 506173676,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742222791
    },
    {
        "content": "<p>There was just one array API change this time</p>",
        "id": 506173794,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742222820
    },
    {
        "content": "<p>I think one source of confusion for me is that I am usually updating math repositories where pinning mathlib’s branch to stable is sufficient</p>",
        "id": 506174006,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742222864
    },
    {
        "content": "<p>Then running lake update always jumps to the latest stable toolchain</p>",
        "id": 506174078,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742222876
    },
    {
        "content": "<p>I am not sure how to get that behaviour in non math projects</p>",
        "id": 506174164,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742222889
    },
    {
        "content": "<p>lean-action has something for regular updates. We used it in equational. But that’s a math project</p>",
        "id": 506174479,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742222959
    },
    {
        "content": "<p>Here, I had to explicitly change lean-toolchain before running <code>lake update</code> to make it work</p>",
        "id": 506175111,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223098
    },
    {
        "content": "<p>I wonder if putting <code>leanprover/lean4:stable</code> in lean-toolchain will do the trick.</p>",
        "id": 506175545,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223190
    },
    {
        "content": "<p>no, changing the lean-toolchain file is exactly what you want</p>",
        "id": 506176842,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742223471
    },
    {
        "content": "<p>but I thought there was a lean action bot that would do it for you</p>",
        "id": 506176959,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742223491
    },
    {
        "content": "<p>There is a lean-action bot for checking a math project's toolchain and updating the project according to that</p>",
        "id": 506177085,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223525
    },
    {
        "content": "<p>but lake update behaves differently for math and other projects</p>",
        "id": 506177242,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223559
    },
    {
        "content": "<p>It won't, for example, fix the Qq dependency in iris which I had to manually update</p>",
        "id": 506177467,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223604
    },
    {
        "content": "<p>Also, the following lakefile.toml won't work because lake will complain that it is getting two different version of lake, so I can't keep the Qq dependency automatically up to date</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iris\"</span>\n<span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"./src/\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"Iris\"</span><span class=\"o\">]</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Qq\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"git#stable\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_lib</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Iris\"</span>\n</code></pre></div>",
        "id": 506178606,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223815
    },
    {
        "content": "<p>That's ofc because the stable in the dependency is the name of a github branch and the lean-toolchain inside reads <code>leanprover/lean4:v4.17.0</code></p>",
        "id": 506178846,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223856
    },
    {
        "content": "<p>Same error if I leave the Qq dependency version at <code>git#v4.17.0</code></p>",
        "id": 506179035,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223901
    },
    {
        "content": "<p>stable doesn't resolve to anything before lake checks for <code>multiple toolchains</code></p>",
        "id": 506179156,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223934
    },
    {
        "content": "<p>which ... sounds like a bug to me</p>",
        "id": 506179218,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223949
    },
    {
        "content": "<p>It just performs a text comparison and throws</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">multiple</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">stable</span>\n<span class=\"w\">    </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">iris</span>\n<span class=\"w\">  </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">    </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n</code></pre></div>",
        "id": 506179410,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742223985
    },
    {
        "content": "<p>why is anything asking for <code>lean4:stable</code>?</p>",
        "id": 506179509,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224007
    },
    {
        "content": "<p>you should never use that toolchain</p>",
        "id": 506179540,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224015
    },
    {
        "content": "<p>I experimented locally with changing the lean-toolchain to stable</p>",
        "id": 506179927,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224097
    },
    {
        "content": "<p>so that <code>lake update</code> automatically updates to the latest stable toolchain</p>",
        "id": 506180013,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224114
    },
    {
        "content": "<p>without tinkering with <code>lean-toolchain</code></p>",
        "id": 506180037,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224120
    },
    {
        "content": "<p>based on a separate experiment below:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">stable</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">installed</span>\n</code></pre></div>\n<p>I conclude that <code>lean4:stable</code> is treated by elan as the latest stable toolchain</p>",
        "id": 506180277,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224177
    },
    {
        "content": "<p>yes which makes it a bad choice for usage in the project</p>",
        "id": 506181841,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224519
    },
    {
        "content": "<p>it's a reproducibility hazard, as it will not resolve to the same thing next month</p>",
        "id": 506182000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224558
    },
    {
        "content": "<p>this is general advice for any library - if you put it on github it should not be using <code>lean4:stable</code></p>",
        "id": 506182157,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224585
    },
    {
        "content": "<p>the <em>update script</em> should be aware that we want to update to the latest stable, but regular builds should use the lean version in the lean-toolchain file and that should be a stable identifier over time</p>",
        "id": 506182683,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742224700
    },
    {
        "content": "<p>So the update action is not in lean-action<br>\nIt is here   :<a href=\"https://github.com/Seasawher/lean-update/\">https://github.com/Seasawher/lean-update/</a></p>",
        "id": 506183642,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224886
    },
    {
        "content": "<p>Under the hood it uses the following js : <a href=\"https://github.com/Seasawher/lean-update/blob/main/scripts/getLatest.js\">https://github.com/Seasawher/lean-update/blob/main/scripts/getLatest.js</a></p>",
        "id": 506183787,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742224920
    },
    {
        "content": "<p>This is mathlib independent. But it will almost certainly break because after replacing the toolchain, the action tries to <a href=\"https://github.com/Seasawher/lean-update/blob/e0993796b7f0848aca031b59bf7704995b3b0501/action.yml#L101\">simply run</a> <code>lake update</code>.</p>",
        "id": 506184274,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742225029
    },
    {
        "content": "<p>We also need to update all our dependencies</p>",
        "id": 506184336,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742225042
    },
    {
        "content": "<p>This should work : <a href=\"https://github.com/leanprover-community/iris-lean/pull/19\">https://github.com/leanprover-community/iris-lean/pull/19</a><br>\nOnly admins and maintainers can test this CI action stuff afaik. So I can't test this directly. But the scripts are borrowed from equational_theories and simply call the lean-update action linked above. I changed the <code>Qq</code> dependency to point to <code>stable</code> so that we don't have to manually update its branch inside lakefile.toml</p>",
        "id": 506189495,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742226052
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> :  The update CI PR is ready to be merged. We can similarly borrow other parts of the CI. Maybe even setup docs.</p>",
        "id": 506470310,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742301930
    }
]