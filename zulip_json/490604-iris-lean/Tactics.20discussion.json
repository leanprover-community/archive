[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> yesterday you mentioned that you had some ideas for how we should implement the <code>iApply</code> and <code>iMod</code> tactics. Could you expand on what you had in mind?</p>",
        "id": 526982943,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751545002
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"769610\">@Oliver Soeser</span> who has started working on tactics</p>",
        "id": 526982978,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751545015
    },
    {
        "content": "<p>I would like to know more about how all these tactics work, since I'd like to make a term style syntax (maybe in style of Î±Î»-calculus?).</p>",
        "id": 526983671,
        "sender_full_name": "suhr",
        "timestamp": 1751545249
    },
    {
        "content": "<p>I think <code>iApply</code> and <code>iMod</code> are really gonna be key to making iris-lean useful in practice, so we need to have a solid foundation for implementing them</p>",
        "id": 526984273,
        "sender_full_name": "Oliver Soeser",
        "timestamp": 1751545443
    },
    {
        "content": "<p>Do we have a list of tactics we need? There are lots of ltac scripts in Rocq developments that:</p>\n<ol>\n<li>Are essentially just macros</li>\n<li>Not how I have seen lean developments work.</li>\n</ol>",
        "id": 526984924,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751545633
    },
    {
        "content": "<p>Also <span class=\"user-mention\" data-user-id=\"769610\">@Oliver Soeser</span> : I am trying to understand these tactics better, so are you already working on both of these tactics and if not, can I pitch in for one of them?</p>",
        "id": 526985070,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751545681
    },
    {
        "content": "<p>I've not started on either of these yet, I'm still working on <code>iRevert</code></p>",
        "id": 526985271,
        "sender_full_name": "Oliver Soeser",
        "timestamp": 1751545753
    },
    {
        "content": "<p>(re. Shreyas) The tactics in Iris are a little more involved. I would strongly recommend reading the MoSeL paper to get acquainted with the design (it is a very good paper!) and Lars KÃ¶nig's thesis to get acquainted with the differences to Rocq.</p>",
        "id": 526985370,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751545787
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/490604-iris-lean/topic/Tactics.20discussion/near/526984924\">said</a>:</p>\n<blockquote>\n<p>Do we have a list of tactics we need? There are lots of ltac scripts in Rocq developments that:</p>\n<ol>\n<li>Are essentially just macros</li>\n<li>Not how I have seen lean developments work.</li>\n</ol>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"574718\">@Michael Sammler</span> and I were talking about this and our list of needed tactics is: <code>iRevert</code>, <code>iAssert</code>, <code>iAccu</code>, <code>iFrame</code>, <code>iApply</code>, <code>iInduction</code>, <code>iMod</code></p>",
        "id": 526985796,
        "sender_full_name": "Oliver Soeser",
        "timestamp": 1751545905
    },
    {
        "content": "<p>(Roughly in order of estimated implementation complexity)</p>",
        "id": 526985970,
        "sender_full_name": "Oliver Soeser",
        "timestamp": 1751545959
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"721721\">Markus de Medeiros</span> <a href=\"#narrow/channel/490604-iris-lean/topic/Tactics.20discussion/near/526985370\">said</a>:</p>\n<blockquote>\n<p>(re. Shreyvas) </p>\n</blockquote>\n<p>It's \"Shreyas\" <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> </p>\n<blockquote>\n<p>The tactics in Iris are a little more involved. I would strongly recommend reading the MoSeL paper to get acquainted with the design (it is a very good paper!) and Lars KÃ¶nig's thesis to get acquainted with the differences to Rocq.</p>\n</blockquote>\n<p>I have read the former an aeon ago. I will revisit that. I still need to read Lars' thesis</p>",
        "id": 526986150,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751546020
    },
    {
        "content": "<p>Oops, sorry!</p>",
        "id": 526986241,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751546050
    },
    {
        "content": "<p>I guess I should read MoSeL paper too. Thanks for suggestion.</p>",
        "id": 526986695,
        "sender_full_name": "suhr",
        "timestamp": 1751546199
    },
    {
        "content": "<p>At a high level, the tactics use three components:</p>\n<ul>\n<li>Theorems about the proof state</li>\n<li>Typeclasses that encapsulate these theorems</li>\n<li>(Relatively small) Ltac tactics to apply theorems from those typeclasses </li>\n</ul>\n<p>So for example, the LTac script to do <code>iApply H</code> where <code>H : X</code> in the Iris context would loosely do something like:</p>\n<ul>\n<li>Look for an <code>IntoWand X A B</code> typeclass instance to turn <code>X</code> into a wand <code>A -* B</code></li>\n<li>Check to see if the goal has Iris type <code>B</code></li>\n<li>Apply a theorem which lets you update a proof state whose goal is <code>B</code> and a wand <code>A -* B</code> into a proof state whose goal is <code>A</code>.</li>\n</ul>",
        "id": 526987175,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751546384
    },
    {
        "content": "<p>In Rocq, typeclass synthesis is done in a backtracking loop. So if it synthesizes the wrong <code>IntoWand X A B</code> in the first step, the tactic will fail, backtrack, and try to find another instance. </p>\n<p>This is not something that can be easily done in Lean from my understanding, but it's also not something that necessarily has to. If there is, for example, some way to do \"all of the typeclass synthesis at once\", then we could implement a version of this which is extensible and hopefully pretty fast given Lean's optimized typeclass system.</p>",
        "id": 526987567,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751546512
    },
    {
        "content": "<p>Can we <code>CoeFun</code> a proof of <code>A -* B</code> into a proof of <code>X</code>? Or there's something special about <code>IntoWand</code> which does not allow that?</p>",
        "id": 526987763,
        "sender_full_name": "suhr",
        "timestamp": 1751546582
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"721721\">Markus de Medeiros</span> <a href=\"#narrow/channel/490604-iris-lean/topic/Tactics.20discussion/near/526987567\">said</a>:</p>\n<blockquote>\n<p>This is not something that can be easily done in Lean from my understanding, but it's also not something that necessarily has to. If there is, for example, some way to do \"all of the typeclass synthesis at once\", then we could implement a version of this which is extensible and hopefully pretty fast given Lean's optimized typeclass system.</p>\n</blockquote>\n<p>I've linked it before, but this is what I did in my <code>iApply</code> <a href=\"https://github.com/leanprover-community/iris-lean/pull/43\">prototype</a>. I added another typeclass <code>InferIntoWand</code> which is like <code>intoWand</code> but has different outParams. Idk if it works in all situations but it works for the simple ones. Someone needs to think harder about if this strategy will work for all of the tactics Oliver listed.</p>",
        "id": 526988040,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751546674
    },
    {
        "content": "<p>Or wait, that was a silly question, since it should be <code>CoeWand</code>.</p>",
        "id": 526988204,
        "sender_full_name": "suhr",
        "timestamp": 1751546721
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"394485\">suhr</span> <a href=\"#narrow/channel/490604-iris-lean/topic/Tactics.20discussion/near/526987763\">said</a>:</p>\n<blockquote>\n<p>Can we <code>CoeFun</code> a proof of <code>A -* B</code> into a proof of <code>X</code>? Or there's something special about <code>IntoWand</code> which does not allow that?</p>\n</blockquote>\n<p>It's a little different but not much more complex</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IntoWand</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BI</span><span class=\"w\"> </span><span class=\"n\">PROP</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PROP</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">PROP</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">into_wand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">â–¡?</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">âŠ¢</span><span class=\"w\"> </span><span class=\"bp\">â–¡?</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">-âˆ—</span><span class=\"w\"> </span><span class=\"n\">Q</span>\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">IntoWand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">into_wand</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 526988205,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751546722
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"721721\">Markus de Medeiros</span> <a href=\"#narrow/channel/490604-iris-lean/topic/Tactics.20discussion/near/526987567\">said</a>:</p>\n<blockquote>\n<p>So if it synthesizes the wrong <code>IntoWand X A B</code> in the first step, the tactic will fail, backtrack, and try to find another instance.</p>\n</blockquote>\n<p>So there's many ways to convert something into a wand.</p>",
        "id": 526989370,
        "sender_full_name": "suhr",
        "timestamp": 1751547080
    },
    {
        "content": "<p>Yeah</p>",
        "id": 526990329,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751547371
    },
    {
        "content": "<p>I'd like to have some examples to build a bit of intuition.</p>",
        "id": 526990533,
        "sender_full_name": "suhr",
        "timestamp": 1751547429
    },
    {
        "content": "<p>You can peruse the instances in the Rocq Iris repo: <a href=\"https://gitlab.mpi-sws.org/search?search=IntoWand&amp;nav_source=navbar&amp;project_id=118&amp;group_id=1795&amp;search_code=true&amp;repository_ref=master\">link</a></p>",
        "id": 526990624,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751547455
    },
    {
        "content": "<p>The real party line here is that supporting multiple instances also makes the tactics easily extensible. It's common in Iris developments to add more instances to extend the behavior of the proofmode. Example: <a href=\"https://github.com/logsem/clutch/blob/96f047e06256173caee4beebed54d81f943841cd/theories/foxtrot/pupd.v#L226\">here</a> defines a new modality, and then gives an <code>IntoWand</code> instance to tweak how it works with the proofmode.</p>",
        "id": 526991125,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751547597
    },
    {
        "content": "<p>Couldn't we just write our own backtracking instance search?</p>",
        "id": 526991241,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547621
    },
    {
        "content": "<p>That's one option, but I imagine it isn't the best.</p>",
        "id": 526991572,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751547725
    },
    {
        "content": "<p>It's not the fastest, but at some point we might want to control how we do instance search</p>",
        "id": 526991672,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547763
    },
    {
        "content": "<p>Also, a lesson from mathlib recently was that lean's existing instance search works better with mixins than typeclass hierarchies</p>",
        "id": 526991797,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547803
    },
    {
        "content": "<p>Oh? Do you have a link to that thread somewhere</p>",
        "id": 526991892,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751547836
    },
    {
        "content": "<p>I think they discovered this in the algebra hierarchy and it shaved some build time off mathlib</p>",
        "id": 526991905,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547842
    },
    {
        "content": "<p>Let me check. I am going on my memory here</p>",
        "id": 526991937,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547852
    },
    {
        "content": "<p>Found a PR : <a href=\"https://github.com/leanprover-community/mathlib4/pull/20676\">https://github.com/leanprover-community/mathlib4/pull/20676</a></p>",
        "id": 526992109,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751547915
    },
    {
        "content": "<p>linked thread : <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Ways.20to.20speed.20up.20Mathlib/near/493174120\">#mathlib4 &gt; Ways to speed up Mathlib @ ðŸ’¬</a></p>",
        "id": 526992421,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751548013
    },
    {
        "content": "<p>I understand I am dropping you in the middle of a long thread, but I gather that the gist of it is that it is better to split typeclasses and mix them in than build long hierarchies of typeclasses.</p>",
        "id": 526993167,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1751548237
    },
    {
        "content": "<p>Fascinating!</p>",
        "id": 526993646,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751548378
    },
    {
        "content": "<p>Our proofmode typeclasses don't really have a hierarchy, but yeah that's an interesting read</p>",
        "id": 526993971,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751548492
    },
    {
        "content": "<p>From what I understood when I talked to my advisor about Iris speedups, he said that data representation (duplicating proof contexts) was a big time spend. I'm optimistic that Iris-Lean can be quicker, especially since we're using a more succinct representation of the proof context, but only time will tell :)</p>",
        "id": 526994477,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1751548644
    }
]