[
    {
        "content": "<p>Hi, I am currently looking into extending some tactics to support <a href=\"https://github.com/leanprover-community/iris-lean/blob/master/src/Iris/ProofMode/Patterns/ProofModeTerm.lean\">proof mode terms</a>. So far, this is working quite well, but there is an issue with <code>icases</code>: Currently <code>icases H with pat</code> destructs <code>H</code> with the pattern <code>pat</code>, but with proof mode terms <code>icases H with HL</code> would instantiate <code>H</code> with the hypothesis <code>HL</code> before destructing it. So the problem is that there are two different meanings of <code>with</code> for <code>icases</code>. In Rocq, this is not a problem since <code>(i)Destruct</code> uses  <code>as</code> instead of <code>with</code>. I see multiple options to resolve this conflict:</p>\n<ul>\n<li>use something else than <code>with</code> for proof mode terms (what exactly? Something like <code>$$</code> to mirror <code>$!</code>? Something else?) </li>\n<li>use something else than <code>with</code> for <code>icases</code> (making it inconsistent with <code>cases</code>)</li>\n<li>something else? </li>\n</ul>\n<p>What do you think about this? Any other ideas?</p>",
        "id": 563828757,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1765806848
    },
    {
        "content": "<p>So in regular lean, we use <code>rcases</code> or <code>obtain</code> to destruct into a pattern</p>",
        "id": 563831472,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765807471
    },
    {
        "content": "<p>And there is some editor support for generation of case arms with the current usage if <code>with</code></p>",
        "id": 563831605,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765807500
    },
    {
        "content": "<p>One idea would be to extend <code>icases</code> with <code>as</code> but keep the <code>with</code> part. It would feel like more  idiomatic lean</p>",
        "id": 563831921,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765807565
    },
    {
        "content": "<p>You could also borrow the <code>cases h : HL</code> pattern into icases for naming the hypothesis</p>",
        "id": 563832438,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765807644
    },
    {
        "content": "<p>This is how the latter syntax works in a trivial demo:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- hypothesis hn</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- hypothesis hn</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 563833130,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765807794
    },
    {
        "content": "<p>Here is one more example of regular style lean usage  with named hypothesis:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"n\">hz₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₁</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hz₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₂</span><span class=\"bp\">⟩⟩</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 563834599,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765808119
    },
    {
        "content": "<p>All these options come with code action support which could be extended to <code>icases</code> if <code>Batteries</code> is imported</p>",
        "id": 563835114,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765808238
    },
    {
        "content": "<p>This style of naming hypothesis is also available for <code>match</code> statements in lean. So it's one of  the canonical ways of naming hypothesis (not pattern destruction).</p>",
        "id": 563835756,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765808381
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"574718\">@Michael Sammler</span> : On second thoughts, I must mention that the above makes sense if the preference is to align iris-lean tactic syntax with regular lean syntax as opposed to matching that of Rocq-iris, which seems to take inspiration from regular Rocq tactic syntax. I am not sure the latter makes much sense, but that's just an aesthetic preference.</p>",
        "id": 563838445,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765808980
    },
    {
        "content": "<p>Is it possible to handle proof mode terms in Lean without using <code>$!</code> and <code>with</code> as separators?  I feel like all subsequent terms and patterns in a proof mode term simply specify how to specialise the hypothesis. So it is also intuitive without them. Related: <a href=\"https://github.com/leanprover-community/iris-lean/issues/99\">#99</a></p>",
        "id": 563839302,
        "sender_full_name": "Zongyuan Liu",
        "timestamp": 1765809192
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563831472\">said</a>:</p>\n<blockquote>\n<p>So in regular lean, we use <code>rcases</code> or <code>obtain</code> to destruct into a pattern</p>\n</blockquote>\n<p>Good point, I guess <code>icases</code> is more like <code>rcases</code> instead of <code>cases</code>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"883069\">Zongyuan Liu</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563839302\">said</a>:</p>\n<blockquote>\n<p>Is it possible to handle proof mode terms in Lean without using <code>$!</code> and <code>with</code> as separators? I feel like all subsequent terms and patterns in a proof mode term simply specify how to specialise the hypothesis. So it is also intuitive without them</p>\n</blockquote>\n<p>That is also an interesting option to investigate.</p>",
        "id": 563852379,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1765811937
    },
    {
        "content": "<p><code>with</code> is not necessarily for pattern destruction. As I pointed about, in the wider lean world, <code>with</code> is the standard separator for <code>match</code>, <code>cases</code>, and even <code>induction</code>.</p>",
        "id": 563856554,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765812839
    },
    {
        "content": "<p>It’s not necessary to define it that way, but it’s something a lot of lean users might have muscle memory for.</p>",
        "id": 563857080,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765812959
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563856554\">said</a>:</p>\n<blockquote>\n<p><code>with</code> is not necessarily for pattern destruction. As I pointed about, in the wider lean world, <code>with</code> is the standard separator for <code>match</code>, <code>cases</code>, and even <code>induction</code>.</p>\n</blockquote>\n<p>I see, thanks for pointing this out! So the usage of <code>with</code> in the Iris sense would probably be unfamiliar to Lean users since it means something quite different.</p>",
        "id": 563877077,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1765818046
    },
    {
        "content": "<p>As the <code>rcases</code> example shows, it is a bit complicated. <code>rcases</code> began it's life in mathlib IIRC</p>",
        "id": 563877243,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765818090
    },
    {
        "content": "<p>But yes, the lean4 style is closer to the <code>cases</code> example I described above</p>",
        "id": 563877310,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765818108
    },
    {
        "content": "<p>Here's the <code>obtain</code> style:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"n\">hz₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₁</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hz₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₂</span><span class=\"bp\">⟩⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 563877623,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765818184
    },
    {
        "content": "<p>or one with a Sum type :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">hz₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₁</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hz₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hsucc₂</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 563877951,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765818279
    },
    {
        "content": "<p>The advantage of the <code>cases</code> style approach is all the relevant variables are introduced in the arm they are needed and the recursive structure of the proof is obvious</p>",
        "id": 563878858,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765818515
    },
    {
        "content": "<p>On a side note, I think there are some duplicate code for specialisation and/or instantiation of universally quantified variables in tactics taking proof mode terms like <code>ispecialize</code>, <code>ipose</code>, and <code>iapply</code>. We should refactor these tactics to use a unified logic like how it's done in the Rocq implementation.</p>",
        "id": 563900397,
        "sender_full_name": "Zongyuan Liu",
        "timestamp": 1765825394
    },
    {
        "content": "<p>Indeed. I hope to have a PR open in the next days to clean this up.</p>",
        "id": 563905431,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1765826120
    },
    {
        "content": "<p>Speaking of, you should probably have merge access Micahel. You can definitely review the metaprogramming stuff better than I can and I'm going to be very short on time until the LICS deadline anyways. </p>\n<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span></p>",
        "id": 563906718,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1765826636
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"883069\">Zongyuan Liu</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563900397\">said</a>:</p>\n<blockquote>\n<p>On a side note, I think there are some duplicate code for specialisation and/or instantiation of universally quantified variables in tactics taking proof mode terms like <code>ispecialize</code>, <code>ipose</code>, and <code>iapply</code>. We should refactor these tactics to use a unified logic like how it's done in the Rocq implementation.</p>\n</blockquote>\n<p>Slightly disagree there. I am personally biased towards keeping Iris-lean tactics nominally and functionally similar to their regular lean counterparts as opposed to matching Rocq-Iris one-one.</p>",
        "id": 563913359,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765828712
    },
    {
        "content": "<p>Users of Iris-lean will need to learn some amount of regular lean to use it and integrate it with mathlib for instance.</p>",
        "id": 563913732,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765828828
    },
    {
        "content": "<p>It will be very confusing to context switch between regular lean tactic behaviour and Rocq-like behaviour for Iris tactics.</p>",
        "id": 563913820,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765828858
    },
    {
        "content": "<p><code>ispecialize</code> maps to lean’s <code>specialize</code> to specialise  a hypothesis given its assumption. Mathlib has a backwards reasoning style <code>apply … at …</code> which applies an implication to an assumption and changes the assumption. The regular lean <code>apply</code> is only applicable in goals. Some of the internal implementation could  definitely be harmonised.</p>",
        "id": 563914225,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765828990
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563914225\">said</a>:</p>\n<blockquote>\n<p><code>ispecialize</code> maps to lean’s <code>specialize</code> to specialise  a hypothesis given its assumption. Mathlib has a backwards reasoning style <code>apply … at …</code> which applies an implication to an assumption and changes the assumption. The regular lean <code>apply</code> is only applicable in goals. Some of the internal implementation could  definitely be harmonised.</p>\n</blockquote>\n<p>I only meant to harmonise the internal implementation.  I get your point, but <code>iApply</code> in Iris-Rocq is also only applicable in goals; one needs to use <code>iSpecialize</code> (and <code>iDestruct</code> etc) to specialise a hypothesis. So I think we are good.</p>",
        "id": 563935565,
        "sender_full_name": "Zongyuan Liu",
        "timestamp": 1765836902
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"574718\">Michael Sammler</span> <a href=\"#narrow/channel/490604-iris-lean/topic/proof.20mode.20terms.20for.20icases/near/563905431\">said</a>:</p>\n<blockquote>\n<p>Indeed. I hope to have a PR open in the next days to clean this up.</p>\n</blockquote>\n<p>The PR is here: <a href=\"https://github.com/leanprover-community/iris-lean/pull/107\">https://github.com/leanprover-community/iris-lean/pull/107</a><br>\nFeedback is welcome!</p>",
        "id": 564082589,
        "sender_full_name": "Michael Sammler",
        "timestamp": 1765901965
    },
    {
        "content": "<p>you probably want to translate <code>Ident</code>s to <code>Name</code>s</p>",
        "id": 564083598,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765902241
    },
    {
        "content": "<p>since the metaprogramming API makes use of those</p>",
        "id": 564083642,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765902251
    },
    {
        "content": "<p>But definitely worth checking with someone who knows better</p>",
        "id": 564083674,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765902263
    },
    {
        "content": "<p><code>Ident</code> carries position information, you need to make sure to hold on to it long enough to give the ident the right hover info</p>",
        "id": 564085277,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1765902689
    },
    {
        "content": "<p>Oh right. sorry, I have gotten used to Lean.Name from #mpil . It lets you use only names available in context very conveniently</p>",
        "id": 564086868,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1765903097
    },
    {
        "content": "<p>The PR looks impressive! I can look through on Saturday but like I mentioned above, I think Michael is probably the right person to review these anyhow. </p>\n<p>Re. the syntax, maybe we could be consistent by using the syntax from intros? We already have one syntax for determining which context something lives in, so maybe we could use <code>ispecialize HPQ %y %Hy HP2</code> instead of <code>ispecialize HPQ $! y Hy with HP2</code></p>",
        "id": 564254927,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1765979073
    },
    {
        "content": "<p>I really hate the <code>$!</code> in Iris-Rocq, for some reason I get it confused with <code>!$</code> or <code>$?</code> or <code>?$</code> haha.</p>",
        "id": 564255452,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1765979175
    }
]