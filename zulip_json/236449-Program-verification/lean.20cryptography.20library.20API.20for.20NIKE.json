[
    {
        "content": "<p>Hey I want to help fix the Lean cryptography situation. There's a lot of old bitrot code that looks brilliant and I wish we could use it. I just now made an X25519 FFI for Lean. And I wrote three type classes for the NIKE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">key</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">privkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">privkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pubkey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Key</span><span class=\"w\"> </span><span class=\"n\">pubkey</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">NIKE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"w\">  </span><span class=\"n\">generatePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">generateKeyPair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">Ã—</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">derivePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">groupAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">encodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PrivateKeyType</span>\n<span class=\"w\">  </span><span class=\"n\">encodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n<span class=\"w\">  </span><span class=\"n\">decodePublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">PublicKeyType</span>\n</code></pre></div>\n<p>These are the bare minimum which any cryptographic construction that uses a NIKE would need.<br>\nAnd I wrote instances of these for the X25519 FFI API:</p>\n<p><a href=\"https://github.com/katzenpost/crypt_walker/blob/main/Lean/CryptWalker/nike/x25519.lean\">https://github.com/katzenpost/crypt_walker/blob/main/Lean/CryptWalker/nike/x25519.lean</a></p>\n<p>I'm new to Lean but not new to maintaining cryptography libraries. The simple idea here is to be able to write cryptographic constructions that use the NIKE scheme and the public and private keys in a generic way so that it's polymorphic over the specific NIKE scheme.</p>\n<p>lol what i did here is definitely not good enough. eventually I want to implement X25519 in pure Lean. But having faster FFI options for pure Lean cryptographic primitives is actually what I want. Multi-use cryptography library for proving protocol properties and for writing implementations in Lean that are fast.</p>",
        "id": 459987717,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723435391
    },
    {
        "content": "<p>i'd also eventually like to be able to write a spec for the opaque ffi call to curve25519... could a pure implementation of that function also serve as a spec for the FFI opaque function?</p>",
        "id": 459987973,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723435503
    },
    {
        "content": "<p>I'm the maintainer of this post quantum cryptography library for golang <a href=\"https://github.com/katzenpost/hpqc\">https://github.com/katzenpost/hpqc</a><br>\nand so I will make this lean library in a similar design which allows for lots of flexible composition.</p>\n<p>What composition is there to be had in a cryptography library? lots! Firstly, a NIKE to KEM \"adapter\" is really just a hashed ElGamal construction. Also I want to make a generic \"hybrid NIKE\" that combines any two NIKEs together into one. likewise for KEMs, a security preserving KEM combiner using the Split PRF design from the KEM Combiners paper might actually produce the KEMs you are looking for.... where Xwing is a well studied hybrid KEM but not easily modified.</p>\n<p>With all of that in place, we can combine any number of NIKEs and KEMs together in hybrid constructions, mixing classic and post quantum primitives together.</p>",
        "id": 459989018,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723435826
    },
    {
        "content": "<p>I actually kind of hate using ProVerif to produce symbolic proof of cryptographic protocol correctness. Instead with about the same amount of effort, eventually, it will be possible to simply use Lean to write a prototype of cryptographic protocols. if running and testing isn't enough assurance of correctness then write theorems and prove them... which seems to be very easy for you all to prove things with Lean. So maybe in the future it will be easy for me too.</p>\n<p>Perhaps I need to learn a lot more Lean to do this right. Feedback welcome.</p>",
        "id": 459989975,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723436242
    },
    {
        "content": "<p>proving this seems hard</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">255</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">19</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">p_is_prime</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">fact_p_is_prime</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"n\">p_is_prime</span><span class=\"bp\">âŸ©</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">instField</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519</span>\n</code></pre></div>",
        "id": 460014201,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723446757
    },
    {
        "content": "<p>If you want to prove that 2^255 - 19 is prime, I would suggest to look at how this was proved in coq using <a href=\"https://github.com/thery/CoqPrime\">CoqPrime</a>, and in action here: <a href=\"https://github.com/mit-plv/fiat-crypto/blob/master/src/Spec/Curve25519.v#L16-L34\">https://github.com/mit-plv/fiat-crypto/blob/master/src/Spec/Curve25519.v#L16-L34</a></p>",
        "id": 460022781,
        "sender_full_name": "Alix Trieu",
        "timestamp": 1723449435
    },
    {
        "content": "<p>Also, you can see some discussion of Pratt certificates <a href=\"#narrow/stream/113488-general/topic/Correct.20phrasing.20for.20recursive.20data.20structure/near/430548937\">here</a></p>",
        "id": 462210763,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1723582298
    },
    {
        "content": "<p>Cool to hear someone talk about cryptography in lean, I guess I am guilty of making old bitrotting lean cryptography code as much as anyone. I wonder what you visualize as being in scope for this library: Code-based cryptography? Linear PCP SNARKs? Category-theoretical presentations of the UC framework? Will it include proofs of security? In what model? Game based? Simulation Based? Plain? ROM?</p>",
        "id": 462214579,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1723584174
    },
    {
        "content": "<p>I'd like to write a cryptography library that is useful for prototyping (or implementing) cryptographic protocols that i use in the katzenpost mixnet development. Things like KEM double ratchet, Sphinx cryptographic packet format, PAKE protoocols, etc.</p>\n<p>Currently Katzenpost has no use for zero knowledge proof systems and I personally have no experience with such things. The kinds of cryptographic primitives that I want to exist in a Lean library include:</p>\n<p>NIKE<br>\nKEM<br>\nPRF<br>\nHMAC<br>\nKDF<br>\nPRP<br>\nstream cipher/PRG<br>\nAEAD<br>\nsignature schemes like ed25519 and Sphincs+</p>",
        "id": 462215272,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723584520
    },
    {
        "content": "<p>also there ought to be a Noise protocol framework library for Lean. Currently also Katzenpost is the only project in the world that uses the PQ Noise Protocol framework which is essentially algebraic transformations from the Noise patterns to PQ Noise patterns where ECDH is replaced by KEM encap/decap usage.</p>",
        "id": 462215503,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723584645
    },
    {
        "content": "<p>I am not a proof engineer. I cannot prove things but maybe I will learn. I am concerned with writing working Lean code but less concerned with proving say... that 2^255-19 is prime. But I can help keep track of such goals and maybe we can give that task to a student.</p>",
        "id": 462215744,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723584758
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"742398\">Alix Trieu</span> <a href=\"#narrow/stream/236449-Program-verification/topic/lean.20cryptography.20library.20API.20for.20NIKE/near/460022781\">said</a>:</p>\n<blockquote>\n<p>If you want to prove that 2^255 - 19 is prime, I would suggest to look at how this was proved in coq using <a href=\"https://github.com/thery/CoqPrime\">CoqPrime</a>, and in action here: <a href=\"https://github.com/mit-plv/fiat-crypto/blob/master/src/Spec/Curve25519.v#L16-L34\">https://github.com/mit-plv/fiat-crypto/blob/master/src/Spec/Curve25519.v#L16-L34</a></p>\n</blockquote>\n<p><a href=\"https://github.com/thery/coqprime/issues/46\">This thread</a> is pretty amusing</p>",
        "id": 462216062,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723584957
    },
    {
        "content": "<p>Are the Lean core devs planning on making the ByteArray .... polymorphic over the size in bytes.... like in Rust?</p>",
        "id": 462219899,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723586980
    },
    {
        "content": "<p>I just realized that my type class above for the NIKE needs to have two more functions to return the private and public key sizes in bytes</p>",
        "id": 462219989,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723587034
    },
    {
        "content": "<p>Currently with the way ByteArray is, I don't specify the size of byte blobs in the function signature, so the safe sane thing to do is to check the size of such blobs where appropriate.</p>",
        "id": 462220099,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723587084
    },
    {
        "content": "<p>Or... there's probably several nice ways to carry along that size information.</p>",
        "id": 462220226,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723587141
    },
    {
        "content": "<p>OMG finally! i got my pure Lean X25519 to work!</p>",
        "id": 462254220,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723608471
    },
    {
        "content": "<p>that was so hard!... or easy now that i have hindsight ;-)</p>",
        "id": 462254289,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723608493
    },
    {
        "content": "<p>Is there a benchmarking library for lean?</p>",
        "id": 462266092,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723613328
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ByteArray</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">util</span><span class=\"bp\">.</span><span class=\"n\">newnat</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">util</span><span class=\"bp\">.</span><span class=\"n\">newhex</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519pure</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">255</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">19</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">p_is_prime</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">fact_p_is_prime</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"n\">p_is_prime</span><span class=\"bp\">âŸ©</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">instField</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">clampScalarBytes</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalarBytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">clamped1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">scalarBytes</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalarBytes</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xf8</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">clamped2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clamped1</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">clamped1</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|||</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x40</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">clamped2</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">zmodToByteArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">natToBytes</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">reverse</span>\n<span class=\"w\">  </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">byteArrayToZmod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ba</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">ba</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">clampScalar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zmodToByteArray</span><span class=\"w\"> </span><span class=\"n\">scalar</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">clampScalarBytes</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">byteArrayToZmod</span><span class=\"w\"> </span><span class=\"n\">newB</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">LadderState</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">montgomery_step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LadderState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LadderState</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">z3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">z2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">z2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">z3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tmp0</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">tmp1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"bp\">^</span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"bp\">^</span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">z2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">tmp0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">tmp0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"bp\">^</span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">121666</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"bp\">^</span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tmp0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z2</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tmp1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">tmp0</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">montgomery_ladder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">point</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LadderState</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zmodToByteArray</span><span class=\"w\"> </span><span class=\"n\">scalar</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">initState</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LadderState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">point</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">point</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">255</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">swap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">byteIndex</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">bitIndex</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"n\">byteIndex</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">bitIndex</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newSwap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"bp\">^^^</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">newSwap</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">newSwap</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">z3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">z2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">z3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">montgomery_step</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">newState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">initState</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finalSwap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">finalSwap</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">x3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">finalSwap</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">z3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">z2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">z3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z3</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">scalarmult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalarBytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">point</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">clampedScalar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">byteArrayToZmod</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">clampScalarBytes</span><span class=\"w\"> </span><span class=\"n\">scalarBytes</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">montgomery_ladder</span><span class=\"w\"> </span><span class=\"n\">clampedScalar</span><span class=\"w\"> </span><span class=\"n\">point</span>\n<span class=\"w\">  </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">x2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">finalState</span><span class=\"bp\">.</span><span class=\"n\">z2</span><span class=\"bp\">â»Â¹</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">curve25519</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scalarBytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">point</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">zmodToByteArray</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">scalarmult</span><span class=\"w\"> </span><span class=\"n\">scalarBytes</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">byteArrayToZmod</span><span class=\"w\"> </span><span class=\"n\">point</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">nike</span><span class=\"bp\">.</span><span class=\"n\">x25519pure</span>\n</code></pre></div>",
        "id": 462403001,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723662476
    },
    {
        "content": "<p>my manual benchmarking shows this x25519 to be about 80,000 ns per group operation. whereas in golang with an optimized implementation of x25519 i get about 40,000 ns per group op.</p>\n<p>I see that timeit will be in a future release of the standard lean library so then i'll be able to use it for benchmarking. until then, my manual benchmarking process sucks so i probably won't do it that much.</p>",
        "id": 462478228,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723701601
    },
    {
        "content": "<p>Are you compiling to a binary or timing in the editor?</p>",
        "id": 462506778,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723712212
    },
    {
        "content": "<p>compile to binary. program runs group action 10,000 times. run program on commandline with \"time\" command to measure time. use calculator to divide elapsed time by 10,000. duh manual benchmark for real huuugaaa boogaa caveman like myself.</p>",
        "id": 462508801,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713153
    },
    {
        "content": "<p>the fact that Lean doesn't have a benchmark library is extremely frustrating.</p>",
        "id": 462508881,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713207
    },
    {
        "content": "<p>the fact that everyone so far cannot even admit this shortcoming is also frustrating.</p>",
        "id": 462508923,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713236
    },
    {
        "content": "<p>dudes... general purpose programming languages all have benchmark libraries. Lean doesn't only because it's new... and not for a another reason other than that.</p>",
        "id": 462509010,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713267
    },
    {
        "content": "<p>perhaps there are some technical reasons wrapped up in this situation. like... if you compile a C object file then maybe benchmarking that is more accurate. sure but way less convenient to use C tooling.</p>",
        "id": 462509367,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713448
    },
    {
        "content": "<p>benchmarking from a text editor is a hilarious suggestion that must've been meant as a joke</p>",
        "id": 462509737,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713615
    },
    {
        "content": "<p>um oh also i'm rocking Lean stable so i don't get to use timeit until that function is landed in stable... so it would not even be possible for me to benchmark from my text editor.</p>",
        "id": 462509894,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723713688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"736493\">David Stainton</span> <a href=\"#narrow/stream/236449-Program-verification/topic/lean.20cryptography.20library.20API.20for.20NIKE/near/462509737\">said</a>:</p>\n<blockquote>\n<p>benchmarking from a text editor is a hilarious suggestion that must've been meant as a joke</p>\n</blockquote>\n<p>I'm referring to <code>set_option trace.profiler true in</code>, which profiles rather than benchmarks. Since much of lean is used in-editor, the performance of the interpreter in the editor is something that the community cares about a lot.</p>",
        "id": 462514378,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723715605
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"736493\">David Stainton</span> <a href=\"#narrow/stream/236449-Program-verification/topic/lean.20cryptography.20library.20API.20for.20NIKE/near/462509894\">said</a>:</p>\n<blockquote>\n<p>um oh also i'm rocking Lean stable so i don't get to use timeit until that function is landed in stable... so it would not even be possible for me to benchmark from my text editor.</p>\n</blockquote>\n<p>I don't know what you mean by \"stable\", but <code>timeit</code> is in 4.10.0 which is the latest stable release</p>",
        "id": 462514640,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723715718
    },
    {
        "content": "<p>okay i think i might have a local tooling problem that i need to fix. it prevents me from using timeint although i'm using 4.10.0</p>",
        "id": 462579915,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723736715
    },
    {
        "content": "<p>whenever i build my lean project with lake it downloads the latest lean leanprover/lean4:v4.11.0-rc2</p>",
        "id": 462628677,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1723751968
    },
    {
        "content": "<p>recently got more ECDH curves working: X448 and X41417</p>",
        "id": 463932417,
        "sender_full_name": "David Stainton ðŸ¦¡",
        "timestamp": 1724213144
    }
]