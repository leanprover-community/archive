[
    {
        "content": "<p>What is the current state of Lean 4's rust integration?</p>\n<p>I want to be able to use Lean to implement/model cryptographic protocols where ALL the cryptographic primitives are implemented in Rust... and Lean \"knows the properties\" they are supposed to have. I want to be able to use the interactive theorem prover for making proofs about the protocol construction itself and completely disregard the correctness of the cryptographic primitive functions.</p>",
        "id": 451615698,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721073259
    },
    {
        "content": "<p>There have been projects that use Rust and Lean such as Cedar and Niko Matsakis is looking into doing Rust and Lean things as well, so it's certainly underway/doable but not very heavily present in the eco system yet.</p>",
        "id": 451618169,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1721073682
    },
    {
        "content": "<p>I also use Lean and Rust in <a href=\"https://reservoir.lean-lang.org/@marcusrossel/egg\">https://reservoir.lean-lang.org/@marcusrossel/egg</a>. So I'd be happy to try to help if you have specific questions.</p>",
        "id": 451620566,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1721074107
    },
    {
        "content": "<p>wow cool thanks! I'll look at these and try to figure it out.</p>",
        "id": 451623560,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721074944
    },
    {
        "content": "<p>See also <span class=\"user-mention\" data-user-id=\"371938\">@Son Ho</span>'s <a href=\"https://github.com/AeneasVerif/aeneas/\">Aeneas</a>.</p>",
        "id": 451624325,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1721075194
    },
    {
        "content": "<p>I did manage to find Aeneas... but that going in another direction and is about model extraction. Where I want to program my own lean models... but have those models rely on rust code.</p>",
        "id": 451624481,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721075254
    },
    {
        "content": "<p>looks like <a href=\"https://github.com/lurk-lab/RustFFI.lean\">https://github.com/lurk-lab/RustFFI.lean</a> is what i need</p>",
        "id": 451624520,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721075273
    },
    {
        "content": "<p>okay... finally, i have another question about Lean FFI and program verification; is there a way to fix this proof?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"add_one\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"c1\">--variable (h2 : b = c + 1)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">    </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">    </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">h3</span>\n<span class=\"w\">    </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">h4</span>\n</code></pre></div>",
        "id": 452480961,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721362196
    },
    {
        "content": "<p>you see, the proof works if we remove the h2 line and replace it with the commented out h2 line.</p>",
        "id": 452481087,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721362238
    },
    {
        "content": "<p>how to coerce the theorem prover into accepting the mathematical properties of our FFI function implemented in Rust?</p>",
        "id": 452482563,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721363075
    },
    {
        "content": "<p>Aha, I can write an axiom for the FFI function and then include the axiom in the proof like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"add_one\"</span><span class=\"kd\">]</span>\n<span class=\"n\">opaque</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32.ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">specialAddOne_eq_add_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"c1\">--variable (h2 : b = c + 1)</span>\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n\n<span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">    </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">    </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne_eq_add_one</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">    </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">Nat.succ</span><span class=\"w\"> </span><span class=\"n\">h3</span>\n<span class=\"w\">    </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat.add_comm</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq.symm</span><span class=\"w\"> </span><span class=\"n\">h4</span>\n</code></pre></div>",
        "id": 452484555,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721364290
    },
    {
        "content": "<p>your axiom is provably false:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"add_one\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">specialAddOne_eq_add_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ne_of_lt</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">  </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">specialAddOne_eq_add_one</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 452688508,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434675
    },
    {
        "content": "<p>oh sure... because of the limits of using a UInt32</p>",
        "id": 452688647,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721434746
    },
    {
        "content": "<p>What you can do instead is to put the <code>@[extern]</code> attribute on a <code>def</code> instead of an <code>opaque</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"add_one\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 452688677,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434769
    },
    {
        "content": "<p>This isn't about the limits of using a UInt32, note that I never actually had to call the function</p>",
        "id": 452688762,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434812
    },
    {
        "content": "<p>i don't understand you example</p>",
        "id": 452688807,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721434838
    },
    {
        "content": "<p>false axioms are bad, you can use them to break things</p>",
        "id": 452688829,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434858
    },
    {
        "content": "<p>a simple fix to the axiom is <code>‚àÄ x : Nat, x + 1 &lt; UInt32.size -&gt; specialAddOne x = x + 1</code></p>",
        "id": 452688882,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434904
    },
    {
        "content": "<p>but you don't need to use an axiom here since with the <code>def</code> example this axiom becomes a provable theorem</p>",
        "id": 452688951,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434932
    },
    {
        "content": "<p>it's much easier to see that I didn't break logical consistency with the second example because I never used <code>axiom</code></p>",
        "id": 452688987,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721434964
    },
    {
        "content": "<p>it is not recommended to use <code>axiom</code> to add facts post facto to <code>opaque</code> because of the dangers of introducing inconsistency like this</p>",
        "id": 452689032,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435001
    },
    {
        "content": "<p>okay... this is just a toy example that i used to essentially ask a question about lean, which is: can i use an FFI function in a proof?</p>",
        "id": 452689037,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435006
    },
    {
        "content": "<p>yes, that's what the second example is doing</p>",
        "id": 452689072,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435034
    },
    {
        "content": "<p>you could also just take/return <code>Nat</code> from the FFI function</p>",
        "id": 452689145,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435062
    },
    {
        "content": "<p>i'm interested in proving correctness of cryptographic protocols without implementing the primitive functions in lean</p>",
        "id": 452689154,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435068
    },
    {
        "content": "<p>and my first challenge now is to prove the KEM correctness</p>",
        "id": 452689196,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435091
    },
    {
        "content": "<p>in that case you should use a <code>def</code> where the body of the def is the \"model\" of the function</p>",
        "id": 452689199,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435094
    },
    {
        "content": "<p>and the <code>@[extern]</code> attribute points to the actual implementation in C</p>",
        "id": 452689230,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435117
    },
    {
        "content": "<p>For all (pk, sk) ‚àà [K.gen] and (k, c) ‚àà [K.enc(pk)] we have K.dec(sk, c) = k.</p>",
        "id": 452689231,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435119
    },
    {
        "content": "<p>to do that you will certainly need an implementation, unless you just want to assume it?</p>",
        "id": 452689266,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435143
    },
    {
        "content": "<p>and so... i'm not clear on what i'd put for the \"body\" in the case of a KEM encapsulation function.</p>",
        "id": 452689286,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435159
    },
    {
        "content": "<p>you would implement the function in lean</p>",
        "id": 452689341,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435176
    },
    {
        "content": "<p>yeah already have implementation in rust, libcrux</p>",
        "id": 452689344,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435178
    },
    {
        "content": "<p>i.e. something that performs the same operations, but maybe inefficiently</p>",
        "id": 452689365,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435192
    },
    {
        "content": "<p>no... too complicated to implement in lean</p>",
        "id": 452689374,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435197
    },
    {
        "content": "<p>then how are you going to prove it has properties?</p>",
        "id": 452689385,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435214
    },
    {
        "content": "<p>what are you taking as given?</p>",
        "id": 452689393,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435222
    },
    {
        "content": "<p>i mean... wouldn't it be possible to instead assert some axioms?</p>",
        "id": 452689402,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435225
    },
    {
        "content": "<p>i want to take the KEM as a given</p>",
        "id": 452689416,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435231
    },
    {
        "content": "<p>i want to assume the KEM works perfectly</p>",
        "id": 452689427,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435240
    },
    {
        "content": "<p>yes you can do that too, as long as you can prove that a function with the desired properties exists</p>",
        "id": 452689449,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435264
    },
    {
        "content": "<p>the goal is to build cryptographic protocols using KEMs and other primitives</p>",
        "id": 452689451,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435266
    },
    {
        "content": "<p>what are the properties? Do you have a spec?</p>",
        "id": 452689518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435296
    },
    {
        "content": "<p>is it just enc/dec cancellation?</p>",
        "id": 452689537,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435309
    },
    {
        "content": "<p>yeah... super simple encrypt/decrypt cancellation. All KEMs are the same. I don't want to specify the specifics of a KEM but keep it KEM agnostic.</p>",
        "id": 452689590,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435357
    },
    {
        "content": "<p>s/agnostic/generic/</p>",
        "id": 452689614,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435374
    },
    {
        "content": "<p>can you write that in lean?</p>",
        "id": 452689714,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435417
    },
    {
        "content": "<p>the properties that is</p>",
        "id": 452689725,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435424
    },
    {
        "content": "<p>yes i think so... although i haven't tried yet because honestly i'm stuck on some stupid pointer fuckery in the rust FFI. but once i've exposed all the rust FFI functions properly then i should be able to define some variable and write some propositions that are essentially expressing the KEM correctness proof which is a very well known proof in cryptographic. which is essentially this: A KEM must satisfy the following standard correctness property: P[(pk, sk) ‚ÜêGen,(c,k)‚Üê Enc(pk), k‚Ä≤ ‚Üê Dec(sk, c) : k = k‚Ä≤] = 1 .</p>",
        "id": 452690021,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435626
    },
    {
        "content": "<p>i open source all my work, made some progress today but not finished yet <a href=\"https://github.com/katzenpost/crypt_walker\">https://github.com/katzenpost/crypt_walker</a></p>",
        "id": 452690141,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435693
    },
    {
        "content": "<p>does Enc return both the ciphertext and the message?</p>",
        "id": 452690292,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435770
    },
    {
        "content": "<p>for this FFI stuff... i made a bunch of opaque types such as Ciphertext, Plaintext and so any propositions i write would necessarily involve those types.</p>",
        "id": 452690297,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435775
    },
    {
        "content": "<p>how do you decide what to send?</p>",
        "id": 452690303,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721435780
    },
    {
        "content": "<p><a href=\"https://github.com/katzenpost/crypt_walker/blob/main/Main.lean\">https://github.com/katzenpost/crypt_walker/blob/main/Main.lean</a></p>",
        "id": 452690348,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435810
    },
    {
        "content": "<p>returns an \"Encapsulation\" type which contains both the shared secret and the ciphertext</p>",
        "id": 452690370,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435828
    },
    {
        "content": "<p>anyway... even after i fix the rust ffi... it's not clear to me if this is going to work because perhaps Lean prover doesn't work with opaque types... or perhaps it'll work as long as i've specified the correct series of propositions about the types. very unclear right now.</p>",
        "id": 452690518,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721435927
    },
    {
        "content": "<p>the <code>free_*</code> functions look wrong</p>",
        "id": 452690769,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721436077
    },
    {
        "content": "<p>okay so here's the corrected toy proof:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"add_one\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">UInt32</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">addOne_eq_add_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">    </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">    </span><span class=\"n\">specialAddOne</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">addOne_eq_add_one</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">h5</span>\n<span class=\"w\">    </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">h3</span>\n<span class=\"w\">    </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">h4</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">addOne</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 452692348,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721437152
    },
    {
        "content": "<p>Here's a version of your definition with provable properties:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Classes</span><span class=\"bp\">.</span><span class=\"n\">SatisfiesM</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">EncDecSpec</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span>\n<span class=\"w\">  </span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span>\n<span class=\"w\">  </span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Œ£'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"bp\">//</span>\n<span class=\"w\">    </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">plaintextEq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">EncDecSpec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"o\">())</span>\n<span class=\"w\">  </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(),</span><span class=\"w\"> </span><span class=\"o\">(),</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"n\">plaintextEq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"o\">}</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EncDecSpec</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">init</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">EncDecM</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">State</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">PublicKey</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">PrivateKey</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">Ciphertext</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">Plaintext</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"generate_key_pair\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EncDecM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®</span><span class=\"n\">pk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_‚ü©</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"n\">pk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"encapsulate\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">EncDecM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">encap</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"decapsulate\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Ciphertext</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">EncDecM</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">decap</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"is_plaintext_equal\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">plaintextEq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IsEncapsulation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ciphertext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Plaintext</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">KeyPair</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PublicKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">IsEncapsulation</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">generate_ok</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">KeyPair</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">generate</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">_;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">encap_ok</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KeyPair</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IsEncapsulation</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">encap</span><span class=\"w\"> </span><span class=\"n\">pk</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">decap_ok</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsEncapsulation</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decap</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 452695059,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721438974
    },
    {
        "content": "<p>wow very interesting!</p>",
        "id": 452696662,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721440108
    },
    {
        "content": "<p>hmm how do i get my lean to use the Batteries module? </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">human</span><span class=\"bp\">@</span><span class=\"n\">computer</span><span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">code</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">main</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">update</span>\n<span class=\"n\">batteries</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">URL</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">deleting</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">again</span>\n<span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">9</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanOptions'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">PackageConfig'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">18</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">srcDir'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">LeanExeConfig'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">21</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">test_driver</span><span class=\"o\">]</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">23</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">srcDir'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">LeanExeConfig'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">configuration</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">errors</span>\n<span class=\"n\">human</span><span class=\"bp\">@</span><span class=\"n\">computer</span><span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">code</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">main</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n</code></pre></div>",
        "id": 452698546,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721441356
    },
    {
        "content": "<p>oh i see my lean-toolchain was specifying a two year old lean version</p>",
        "id": 452702052,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721443567
    },
    {
        "content": "<p>Does this here imply my C/Rust must return a lean object tuple?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"generate_key_pair\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EncDecM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PublicKey</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">PrivateKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®</span><span class=\"n\">pk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_‚ü©</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encDecSpec</span><span class=\"bp\">.</span><span class=\"n\">generate</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"n\">pk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sk</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>currently i have </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">no_mangle</span><span class=\"o\">]</span>\n<span class=\"n\">pub</span><span class=\"w\"> </span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"n\">generate_key_pair</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">KeyPair</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">randomness</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">random_array</span><span class=\"o\">()</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">key_pair</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mlkem768</span><span class=\"bp\">::</span><span class=\"n\">generate_key_pair</span><span class=\"o\">(</span><span class=\"n\">randomness</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">privkey</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pubkey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">key_pair</span><span class=\"bp\">.</span><span class=\"n\">into_parts</span><span class=\"o\">()</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ffi_pubkey</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MlKemPublicKey</span><span class=\"bp\">&lt;</span><span class=\"mi\">1184</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pubkey</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ffi_privkey</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MlKemPrivateKey</span><span class=\"bp\">&lt;</span><span class=\"mi\">2400</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">privkey</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Box</span><span class=\"bp\">::</span><span class=\"n\">into_raw</span><span class=\"o\">(</span><span class=\"n\">Box</span><span class=\"bp\">::</span><span class=\"n\">new</span><span class=\"o\">(</span><span class=\"n\">KeyPair</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pubkey</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ffi_pubkey</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">privkey</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ffi_privkey</span><span class=\"w\"> </span><span class=\"o\">}))</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>which was meant to be passed around as an opaque type and not a tuple... but yeah it would be so much<br>\nbetter if the rust function could actually return a tuple of opaque types pub/private keys.</p>",
        "id": 452713155,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721449044
    },
    {
        "content": "<p>tomorrow i'll take another look at lean-egg which has a lot of this FFI stuff figured out</p>",
        "id": 452721149,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721453246
    },
    {
        "content": "<p>yes it seemed easier for lean code if you just returned a tuple directly. You can do so using the functions in lean.h</p>",
        "id": 452862212,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721493489
    },
    {
        "content": "<p>or better yet, i use your rust crate lean_sys</p>",
        "id": 452942305,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721538421
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> so if i can just arbitrarily define opaque types and write axioms or theorems for them... i could in theory do that for the whole suite of cryptographic functions that i would need to construct protocols. but then is there even any point in having those functions actually use FFI? i mean... if i care only about proving properties of cryptographic protocols then couldn't i construct \"protocol models\" from the opaque functions?</p>",
        "id": 453046919,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721601347
    },
    {
        "content": "<p>also as a side note, my intention was to write a lean cryptography library that only exposes one implementation per primitive... and would have the following primitives: PRP, AEAD, NIKE, KEM, HKDF, HMAC, PRF, stream cipher, signature scheme</p>",
        "id": 453047086,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721601434
    },
    {
        "content": "<p>also... another side note, from my perspective having used formal verification tools like ProVerif where we must write a series of equations to define our primitive functions before building up protocols... if i was to do the same exact thing in Lean there would probably be much more benefit to doing so in Lean because the prover is interactive.</p>",
        "id": 453067125,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721617613
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"736493\">David Stainton</span> <a href=\"#narrow/stream/236449-Program-verification/topic/Lean.20library.20rust.20integration.3F/near/453046919\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> so if i can just arbitrarily define opaque types and write axioms or theorems for them... i could in theory do that for the whole suite of cryptographic functions that i would need to construct protocols. but then is there even any point in having those functions actually use FFI? i mean... if i care only about proving properties of cryptographic protocols then couldn't i construct \"protocol models\" from the opaque functions?</p>\n</blockquote>\n<p>Presumably the reason you are using FFI here is for performance reasons. Lean has an okay compiler but it's clearly not going to be able to compete with a cryptographic primitive hand coded in assembly. Nevertheless, it is useful to have some slow and simple code as a point of comparison to the fast code since you can do differential fuzzing and such to detect errors, in addition to being able to prove properties of the code</p>",
        "id": 453092288,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721629357
    },
    {
        "content": "<p>No not all. I care not one bit about performance. I also do not care at all to fuzz or to otherwise detect faults in the cryptographic primtives... this is in fact a completely different concern from the concern of proving protocol properties which are composed of many many cryptographic primtiives.</p>",
        "id": 453092822,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721629657
    },
    {
        "content": "<p>just a minute... i'll show your some of my ProVerif specs... which prove nothing about cryptographci primitives</p>",
        "id": 453093016,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721629706
    },
    {
        "content": "<p>for example <a href=\"https://github.com/katzenpost/formal_specifications/blob/main/sphinx/kem_sphinx.passive.pv\">https://github.com/katzenpost/formal_specifications/blob/main/sphinx/kem_sphinx.passive.pv</a></p>",
        "id": 453093065,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721629742
    },
    {
        "content": "<p>The reason I don't want to implement cryptographic primitives in Lean is because that isn't what I do in any language so why start now?</p>",
        "id": 453093202,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721629782
    },
    {
        "content": "<p>I compose protocols not primitives</p>",
        "id": 453093221,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721629793
    },
    {
        "content": "<p>I'm confused then as well, what are you hoping to get out of this library?</p>",
        "id": 453093515,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721629929
    },
    {
        "content": "<p>if you just want to write a theorem about functions with inverses you certainly don't need FFI to do that</p>",
        "id": 453093846,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630096
    },
    {
        "content": "<p>I'm hoping to use it to build prototypes of cryptographic protocols which I can test and demonstrate that they work and I can also prove various properties of the protocol with the propositions and theorems and proofs. All that having been said, the observation that I made earlier still stands: I can do all the proving with just opaque types without any need for FFI... just write pure algebra like i normally do when i'm modeling a protocol in ProVerif. that in of itself would be useful to all kinds of cryptographers... if there was a small library of equations that represent the cryptographic primitives that they use to compose protocols.</p>",
        "id": 453093870,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630108
    },
    {
        "content": "<p>yes! that's what I was thinking.</p>",
        "id": 453093900,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630121
    },
    {
        "content": "<p>I'm not sure I'd call it an \"implementation\" of the protocol though in that case, more of a specification</p>",
        "id": 453094085,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630168
    },
    {
        "content": "<p>because since you aren't writing any implementation code in lean and aren't hooking up an implementation from rust you won't be able to run them at all</p>",
        "id": 453094170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630207
    },
    {
        "content": "<p>indeed. anyway... if i did all the FFI work to bring in all the cryptographic primitives then i could write protocol prototypes and that might have some advantages... like being testable with unit tests.</p>",
        "id": 453094199,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630224
    },
    {
        "content": "<p>at which point I don't even really see the point of calling it KEM, HKDF etc, these are just the bare structure of the functions and not even enough to differentiate them</p>",
        "id": 453094283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630267
    },
    {
        "content": "<p>normally when I think of what would qualify as a \"spec for AES\" that means writing down all the cipher tables such that you can prove what the output is given any input and you can compare differing implementations to see if they agree with the spec</p>",
        "id": 453094502,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630389
    },
    {
        "content": "<p>you lost me on that last point. all the cryptographic primitive categories are quite different. they have different return values, different arguments etc. and their relationships are different.</p>",
        "id": 453094544,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630403
    },
    {
        "content": "<p>If all you say is that dec(enc(k)) = k then I imagine quite a few of them will have basically that shape</p>",
        "id": 453094635,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630446
    },
    {
        "content": "<p>okay, that's true if we compare say an AEAD to a stream cipher... if they have the same number of arguments.... because the algebraic relationship doesn't express what's going on and their properties</p>",
        "id": 453094877,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630561
    },
    {
        "content": "<p>this is often referred to as the symbolic model of cryptography</p>",
        "id": 453094928,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630597
    },
    {
        "content": "<p>right</p>",
        "id": 453094938,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630603
    },
    {
        "content": "<p>but i can see some advantages to actually implementing the primitives in lean... lean would then be able to test for the bitwise properties... like the avalanche effect if a single bit is flipped on a PRP ciphertext versus no such effect on a stream ciphertext</p>",
        "id": 453095067,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630673
    },
    {
        "content": "<p>I could imagine having a typeclass <code>StreamCipher</code> which collects these basic properties, and maybe add some more and have symbolic models for all of the types you are interested in</p>",
        "id": 453095099,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630689
    },
    {
        "content": "<p>that would cover the high level properties, and wouldn't commit to being an \"implementation\" in the same way as an opaque</p>",
        "id": 453095175,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721630749
    },
    {
        "content": "<p>yeah... i'd have to make such typeclasses for all the primitives. and in order to compose protocols they would have to share some of the types. probably easy to just coerce them. i have no experience with interactive theorem proving... so mostly i've been learning the functional programming parts of lean so far.</p>",
        "id": 453095718,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721630948
    },
    {
        "content": "<p>would the symbolic models for the types use opaque types? it sounds like they could just be some kind of inductive types or something.</p>",
        "id": 453097474,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721631580
    },
    {
        "content": "<p>no, the typeclasses are not opaque types, they are record types</p>",
        "id": 453099319,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721632338
    },
    {
        "content": "<p>okay i guess i don't have enough experience with lean typeclasses... i thought they were similar to rust traits in that they specify some functions... ah that operate on the type of the typeclass i guess.</p>",
        "id": 453099460,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721632404
    },
    {
        "content": "<p>In fact, I wrote one earlier as the specification for the EncDec functions, see <code>EncDecSpec</code></p>",
        "id": 453099464,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721632407
    },
    {
        "content": "<p>right</p>",
        "id": 453099485,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721632419
    },
    {
        "content": "<p>you can prove things about <code>EncDecSpec</code>s without ever actually having one</p>",
        "id": 453099632,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721632484
    },
    {
        "content": "<p>the opaque was just to create a particular one (to which some FFI code is attached)</p>",
        "id": 453099715,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1721632512
    },
    {
        "content": "<p>okay... so Lean used in this way can be used for symbolic cryptographic models. that's pretty interesting to me.</p>",
        "id": 453100333,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721632745
    },
    {
        "content": "<p>I have zero experience using cryptoverif and the like that use the computational model. lean can obviously do that and the advantages would be that i could test the more complicated protocol properties which the symbolic model just skips over.</p>",
        "id": 453100957,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721632975
    },
    {
        "content": "<p>perhaps if a bunch of cryptography professors adopts Lean then their students will implement a bunch of primitives in lean.</p>",
        "id": 453101229,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1721633091
    },
    {
        "content": "<p>trying to use the <code>lean-sys</code> rust crate so i can return Lean objects to Lean via the FFI... FFI works fine but I'm unable to actually use the <code>lean-sys</code>crate because of this build error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">human</span><span class=\"bp\">@</span><span class=\"n\">computer</span><span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">code</span><span class=\"bp\">/</span><span class=\"n\">leanprojects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">ffi</span><span class=\"bp\">-</span><span class=\"n\">tuple2</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">14</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"n\">s</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"bp\">/</span><span class=\"mi\">14</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0/bin/leanc -shared -o ././.lake/build/lib/libcrypt_walker_for_lean.so -Wl,--whole-archive ././.lake/build/lib/libcrypt_walker_for_lean.a -Wl,--no-whole-archive</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 454531372,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722117467
    },
    {
        "content": "<p>I noticed that lean-egg doesn't actually use the <code>lean-sys</code> rust crate. it just has the C and Rust code directly in it's Lean package</p>",
        "id": 454531542,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722117522
    },
    {
        "content": "<p>it looks like <code>lean-egg</code> doesn't need <code>lean-sys</code> because rust code is not handling lean objects in any way</p>",
        "id": 454531920,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722117666
    },
    {
        "content": "<p>A quick google search suggests that you need to compile your C code or other libraries with <code>-fPIC</code></p>",
        "id": 454532526,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722117888
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">srcDir</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Lean\"</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">precompileModules</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">extern_lib</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cargo\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"rustc\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--release\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"-C\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"relocation-model=pic\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nameToStaticLib</span><span class=\"w\"> </span><span class=\"s2\">\"crypt_walker_for_lean\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">dir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"Rust\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"target\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"release\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDirAll</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">nativeLibDir</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"bp\">.</span><span class=\"n\">nativeLibDir</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">writeBinFile</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">readBinFile</span><span class=\"w\"> </span><span class=\"n\">srcPath</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">tgtPath</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">human</span><span class=\"bp\">@</span><span class=\"n\">computer</span><span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">code</span><span class=\"bp\">/</span><span class=\"n\">leanprojects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">ffi</span><span class=\"bp\">-</span><span class=\"n\">tuple2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">main</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">autocfg</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">libc</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">155</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">parking_lot_core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">10</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">smallvec</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cfg</span><span class=\"bp\">-</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">scopeguard</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"m\">7</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">static_assertions</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">lock_api</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">.</span><span class=\"m\">12</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">memoffset</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">parking_lot</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/</span><span class=\"n\">code</span><span class=\"bp\">/</span><span class=\"n\">leanprojects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">ffi</span><span class=\"bp\">-</span><span class=\"n\">tuple2</span><span class=\"bp\">/</span><span class=\"n\">Rust</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">1.11</span><span class=\"n\">s</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0/bin/leanc -shared -o ././.lake/build/lib/libcrypt_walker_for_lean.so -Wl,--whole-archive ././.lake/build/lib/libcrypt_walker_for_lean.a -Wl,--no-whole-archive</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 454533907,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118358
    },
    {
        "content": "<p>Your project is not using a fixed lean version, this is not recommended</p>",
        "id": 454534024,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118389
    },
    {
        "content": "<p>what lean version are you compiling against?</p>",
        "id": 454534052,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118400
    },
    {
        "content": "<p>oh good question... let me check</p>",
        "id": 454534084,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118418
    },
    {
        "content": "<p>leanprover/lean4:v4.8.0</p>",
        "id": 454534104,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118428
    },
    {
        "content": "<p>i specifically matched it with the version the lean-sys uses</p>",
        "id": 454534149,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118443
    },
    {
        "content": "<p>you have things that don't make sense on 4.8.0, like <code>@[test_driver]</code></p>",
        "id": 454534176,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118447
    },
    {
        "content": "<p>I've managed to replicate your error message on v4.9.0</p>",
        "id": 454534374,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118493
    },
    {
        "content": "<p>and so far I haven't found anything in lean-sys that would need to change on 4.9.0</p>",
        "id": 454534424,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118520
    },
    {
        "content": "<p>i just pushed my ffi experiment to <a href=\"https://github.com/katzenpost/lean-ffi\">https://github.com/katzenpost/lean-ffi</a> ... i'm not using any test_driver in that particular lakefile that i just pushed and posted.</p>",
        "id": 454534601,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118562
    },
    {
        "content": "<p>if you replicated the error using v4.9.0... then it sounds like i have a elan or lake tooling problem locally</p>",
        "id": 454534691,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118598
    },
    {
        "content": "<p>why?</p>",
        "id": 454534701,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118616
    },
    {
        "content": "<p>you just told me that you replicated the error. using v4.9.0</p>",
        "id": 454534793,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118691
    },
    {
        "content": "<p>yes, that means the report is valid, no?</p>",
        "id": 454534808,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118714
    },
    {
        "content": "<p>the lakefile i posted has no \"test\" string in it</p>",
        "id": 454534831,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118772
    },
    {
        "content": "<p>I needed to use 4.9.0 because 4.8.0 had some issues with missing attributes, but I suspect that lean-sys also works in the same way on 4.9.0 even though it has not had a release for that version</p>",
        "id": 454534832,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118772
    },
    {
        "content": "<p>i'm curious if i'm using lean-sys incorrectly.</p>",
        "id": 454534843,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118797
    },
    {
        "content": "<p>I pulled the master branch of crypt_walker for the first replication</p>",
        "id": 454534894,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118816
    },
    {
        "content": "<p>but the lean-ffi project also produces the same issue on 4.8.0 as you say</p>",
        "id": 454534917,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118834
    },
    {
        "content": "<p>I am sure you are \"using it incorrectly\" but I also don't know how to use it, this linking stuff takes years off my life</p>",
        "id": 454534941,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118878
    },
    {
        "content": "<p>I would really like lean-sys to just be plug and play but somehow there is always one more issue</p>",
        "id": 454535010,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118936
    },
    {
        "content": "<p>the <code>cargo</code> invocation line  in your lakefile is also unexpectedly complex, did you get that from <code>lean-egg</code>?</p>",
        "id": 454535024,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722118963
    },
    {
        "content": "<p>hmm  yeah i think i copied that from lean-egg</p>",
        "id": 454535045,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722118988
    },
    {
        "content": "<p>yeah this linking stuff is tricky. i suppose it's a matter of messing with the Cargo.toml and the lakefile.lean</p>",
        "id": 454535129,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119063
    },
    {
        "content": "<p>the other free variable is the build script in lean-sys</p>",
        "id": 454535140,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119091
    },
    {
        "content": "<p>oh it's <a href=\"http://build.rs\">build.rs</a></p>",
        "id": 454535163,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119124
    },
    {
        "content": "<p>aha feature=\"static\"</p>",
        "id": 454535511,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119466
    },
    {
        "content": "<p>yeah that was my next suggestion, I'm not sure if you want to statically link or not</p>",
        "id": 454535532,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119511
    },
    {
        "content": "<p>lake usually statically links, but I think something is still missing from the script</p>",
        "id": 454535594,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119542
    },
    {
        "content": "<p>it kind of seems like i'm supposed to use static linking... i'll try it.</p>",
        "id": 454535597,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119546
    },
    {
        "content": "<p>feature=\"static\" is on by default</p>",
        "id": 454535613,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119572
    },
    {
        "content": "<p>if you set <code>default-features=false</code> you can turn it off</p>",
        "id": 454535627,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119591
    },
    {
        "content": "<p>yes but it looks like lean-sys's <a href=\"http://build.rs\">build.rs</a> has some logic for choosing how to link with lean... and if not static then it picks the .so to link with. the error messages i'm getting make me think it's linking with a .so when it should not</p>",
        "id": 454535741,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119724
    },
    {
        "content": "<p>I have noticed the strange behavior that if you disable the <code>static</code> feature then the build works, and if you re-enable the feature then the build still works, including if you delete the <code>Rust/target</code> folder but not if you delete <code>.lake</code></p>",
        "id": 454535831,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722119805
    },
    {
        "content": "<p>interesting. sounds like a lake tooling bug of some sort</p>",
        "id": 454535929,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722119886
    },
    {
        "content": "<p>I'm starting to suspect lake... <code>lake build crypt_walker_for_lean:static</code> works but <code>lake build crypt_walker_for_lean:shared</code> fails, and somehow the default build is calling the <code>crypt_walker_for_lean:shared</code> facet even though there is nothing in the lakefile which says anything about whether to build this lib as static or shared</p>",
        "id": 454537577,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722120969
    },
    {
        "content": "<p>cc: <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span></p>",
        "id": 454537642,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722120994
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <code>crypt_walker_for_lean</code> is an <code>extern_lib</code> and <code>CryptWalker</code> has <code>precompileModules := true</code>. Lake will build the shared library of <code>crypt_walker_for_lean</code>, so it can be passed as a precompiled <code>--load-dynlib</code> for <code>CryptWalker</code> modules.</p>",
        "id": 454538007,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722121277
    },
    {
        "content": "<p>is there a way the <code>extern_lib</code> can know that it is being built as a shared lib so it can tell rust about this?</p>",
        "id": 454538079,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722121329
    },
    {
        "content": "<p>also, <code>precompileModules := false</code> doesn't seem to make a difference</p>",
        "id": 454538176,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722121444
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <code>extern_lib</code> targets should assume they are being built for both static and shared linking. Enabling different build scripts for each is on the to-do list, but we have not been able to dedicate time to improving the FFI experience yet.</p>",
        "id": 454538184,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722121456
    },
    {
        "content": "<p>I don't know what that means. As far as I can tell you only return one path from the target, is it supposed to build it twice?</p>",
        "id": 454538279,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722121509
    },
    {
        "content": "<p>also it would be good to have a way to say that an extern lib is static only and does not support whatever features <code>precompileModules</code> needs a shared lib for</p>",
        "id": 454538528,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722121594
    },
    {
        "content": "<p>yeah building with <code>lake build crypt_walker_for_lean:static</code> works but i guess that just causes the rust to be built and then it's not linked with the lean stuff.</p>",
        "id": 454538896,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722121794
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/236449-Program-verification/topic/Lean.20library.20rust.20integration.3F/near/454538279\">said</a>:</p>\n<blockquote>\n<p>I don't know what that means. As far as I can tell you only return one path from the target, is it supposed to build it twice?</p>\n</blockquote>\n<p>It returns a static library and that static library is then used to link its corresponding shared library.</p>",
        "id": 454539365,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722121970
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/236449-Program-verification/topic/Lean.20library.20rust.20integration.3F/near/454538528\">said</a>:</p>\n<blockquote>\n<p>also it would be good to have a way to say that an extern lib is static only and does not support whatever features <code>precompileModules</code> needs a shared lib for</p>\n</blockquote>\n<p>While good for terminal packages, packages meant to be used as libraries should support both options as failure to provide this has as cascading effect on dependent packages (i.e., they are all now static-only).</p>",
        "id": 454540019,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722122237
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/236449-Program-verification/topic/Lean.20library.20rust.20integration.3F/near/454538176\">said</a>:</p>\n<blockquote>\n<p>also, <code>precompileModules := false</code> doesn't seem to make a difference</p>\n</blockquote>\n<p>This is odd. It is still building <code>shared</code> without <code>precompileModules</code>?</p>",
        "id": 454540245,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722122326
    },
    {
        "content": "<p>yes</p>",
        "id": 454540585,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722122464
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Do you have some error output you can share (preferably with <code>-v</code>)?</p>",
        "id": 454541141,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722122718
    },
    {
        "content": "<p>The input is exactly the <code>lean-ffi</code> project with the <code>precompileModules := true</code> line removed.</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>lake<span class=\"w\"> </span>build\n<span class=\"go\">‚Ñπ [1/7] Ran crypt_walker/crypt_walker_for_lean.static</span>\n<span class=\"go\">info: stderr:</span>\n<span class=\"go\">   Compiling autocfg v1.3.0</span>\n<span class=\"go\">   Compiling libc v0.2.155</span>\n<span class=\"go\">   Compiling parking_lot_core v0.9.10</span>\n<span class=\"go\">   Compiling smallvec v1.13.2</span>\n<span class=\"go\">   Compiling scopeguard v1.2.0</span>\n<span class=\"go\">   Compiling cfg-if v1.0.0</span>\n<span class=\"go\">   Compiling lean-sys v0.0.7</span>\n<span class=\"go\">   Compiling static_assertions v1.1.0</span>\n<span class=\"go\">   Compiling lock_api v0.4.12</span>\n<span class=\"go\">   Compiling memoffset v0.9.1</span>\n<span class=\"go\">   Compiling parking_lot v0.12.3</span>\n<span class=\"go\">   Compiling crypt_walker_for_lean v0.1.0 (/home/mario/Documents/lean/lean-ffi/Rust)</span>\n<span class=\"go\">    Finished `release` profile [optimized] target(s) in 7.08s</span>\n<span class=\"go\">‚úñ [3/7] Building crypt_walker_for_lean.static:shared</span>\n<span class=\"go\">trace: .&gt; /home/mario/.elan/toolchains/leanprover--lean4---v4.8.0/bin/leanc -shared -o ././.lake/build/lib/libcrypt_walker_for_lean.so -Wl,--whole-archive ././.lake/build/lib/libcrypt_walker_for_lean.a -Wl,--no-whole-archive</span>\n<span class=\"go\">info: stderr:</span>\n<span class=\"go\">ld.lld: error: relocation R_X86_64_TPOFF32 against lean::g_finalizing cannot be used with -shared</span>\n<span class=\"go\">&gt;&gt;&gt; defined in ././.lake/build/lib/libcrypt_walker_for_lean.a(thread.cpp.o)</span>\n<span class=\"go\">&gt;&gt;&gt; referenced by thread.cpp</span>\n<span class=\"go\">&gt;&gt;&gt;               thread.cpp.o:(lean_finalize_thread) in archive ././.lake/build/lib/libcrypt_walker_for_lean.a</span>\n<span class=\"go\">...</span>\n\n<span class=\"go\">ld.lld: error: too many errors emitted, stopping now (use --error-limit=0 to see all errors)</span>\n<span class=\"go\">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span>\n<span class=\"go\">error: external command '/home/mario/.elan/toolchains/leanprover--lean4---v4.8.0/bin/leanc' exited with code 1</span>\n<span class=\"go\">Some builds logged failures:</span>\n<span class=\"go\">- crypt_walker_for_lean.static:shared</span>\n<span class=\"go\">error: build failed</span>\n</code></pre></div>",
        "id": 454541257,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722122826
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Could you run with <code>-v</code>?  I would try myself, but I am not sure I have a properly configured Rust.</p>",
        "id": 454541384,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722122954
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">Rust</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"c1\">--release -- -C relocation-model=pic</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`release</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.01</span><span class=\"n\">s</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0/bin/leanc -shared -o ././.lake/build/lib/libcrypt_walker_for_lean.so -Wl,--whole-archive ././.lake/build/lib/libcrypt_walker_for_lean.a -Wl,--no-whole-archive</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 454541401,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722122985
    },
    {
        "content": "<p><a href=\"https://justpaste.it/9w7oe\">https://justpaste.it/9w7oe</a></p>",
        "id": 454541508,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722123017
    },
    {
        "content": "<p>Oh, I forgot the build ANSI progress  counter hides the other jobs. Could you also try <code>-v --no-ansi</code>?</p>",
        "id": 454542160,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722123281
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"c1\">--no-ansi</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">Rust</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"c1\">--release -- -C relocation-model=pic</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`release</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.01</span><span class=\"n\">s</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0/bin/leanc -shared -o ././.lake/build/lib/libcrypt_walker_for_lean.so -Wl,--whole-archive ././.lake/build/lib/libcrypt_walker_for_lean.a -Wl,--no-whole-archive</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">relocation</span><span class=\"w\"> </span><span class=\"n\">R_X86_64_TPOFF32</span><span class=\"w\"> </span><span class=\"n\">against</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">g_finalizing</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">shared</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">(</span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">)</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"n\">thread</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_finalize_thread</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">too</span><span class=\"w\"> </span><span class=\"n\">many</span><span class=\"w\"> </span><span class=\"n\">errors</span><span class=\"w\"> </span><span class=\"n\">emitted</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stopping</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"c1\">--error-limit=0 to see all errors)</span>\n<span class=\"n\">clang</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.8.0/bin/leanc' exited with code 1</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">dynlib</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"bp\">/</span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">CryptWalker</span><span class=\"o\">:</span><span class=\"n\">leanArts</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">shared</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 454542226,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722123329
    },
    {
        "content": "<p>Ah, this is the bug I fixed last month (<a href=\"https://github.com/leanprover/lean4/pull/4566\">lean4#4566</a>) where Lake would always precompile the package of a module. If it is possible to bump the project up to <code>v4.10.0-rc2</code>, the shared library should not be built.</p>",
        "id": 454542635,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722123455
    },
    {
        "content": "<p>it does seem to work now (without <code>precompileModules := true</code>)</p>",
        "id": 454542756,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722123588
    },
    {
        "content": "<p>I'm not clear on whether there is any way to make this work with shared and static simultaneously</p>",
        "id": 454542844,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722123645
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> It suprises me that Rust cannot build a static library that can be linked  into a shared object.</p>",
        "id": 454543073,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722123930
    },
    {
        "content": "<p>I don't know, does that error message make sense to you?</p>",
        "id": 454543143,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722123991
    },
    {
        "content": "<p>I can pass whatever arguments I need to to the linker but I have no idea what the right voodoo is</p>",
        "id": 454543170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722124030
    },
    {
        "content": "<p>cool. it works.</p>",
        "id": 454543296,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722124191
    },
    {
        "content": "<p>now i'm trying to get my test target to work... because ideally i'd be able to run a series of tests via lake in the same project directory</p>",
        "id": 454543373,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722124233
    },
    {
        "content": "<p>Adding this to the lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">test_driver</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`tests.Main</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>lake test -v --no-ansi</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"c1\">--no-ansi</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/lean ././Lean/./CryptWalker/Basic.lean -R ././Lean/. -o ././.lake/build/lib/CryptWalker/Basic.olean -i ././.lake/build/lib/CryptWalker/Basic.ilean -c ././.lake/build/ir/CryptWalker/Basic.c --json</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/lean ././Lean/./CryptWalker.lean -R ././Lean/. -o ././.lake/build/lib/CryptWalker.olean -i ././.lake/build/lib/CryptWalker.ilean -c ././.lake/build/ir/CryptWalker.c --json</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"bp\">.</span><span class=\"n\">Main</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/lean ././Lean/./tests/Main.lean -R ././Lean/. -o ././.lake/build/lib/tests/Main.olean -i ././.lake/build/lib/tests/Main.ilean -c ././.lake/build/ir/tests/Main.c --json</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"bp\">.</span><span class=\"n\">Main</span><span class=\"o\">:</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"o\">)</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -c -o ././.lake/build/ir/tests/Main.c.o.export ././.lake/build/ir/tests/Main.c -O3 -DNDEBUG -DLEAN_EXPORTING</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"o\">:</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"o\">)</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -c -o ././.lake/build/ir/CryptWalker/Basic.c.o.export ././.lake/build/ir/CryptWalker/Basic.c -O3 -DNDEBUG -DLEAN_EXPORTING</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">CryptWalker</span><span class=\"o\">:</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"o\">)</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -c -o ././.lake/build/ir/CryptWalker.c.o.export ././.lake/build/ir/CryptWalker.c -O3 -DNDEBUG -DLEAN_EXPORTING</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">Rust</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"c1\">--release -- -C relocation-model=pic</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"n\">s</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">9</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">tests</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -o ././.lake/build/bin/tests ././.lake/build/ir/tests/Main.c.o.export ././.lake/build/ir/CryptWalker/Basic.c.o.export ././.lake/build/ir/CryptWalker.c.o.export ././.lake/build/lib/libcrypt_walker_for_lean.a</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">ld</span><span class=\"bp\">.</span><span class=\"n\">lld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean_internal_panic</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">            </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"n\">lean_internal_panic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span>\n<span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\">            </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"o\">:(</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">archive</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">human</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/lib/lean/libleanrt.a</span>\n</code></pre></div>",
        "id": 454543482,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722124345
    },
    {
        "content": "<p>That error makes it seem like <code>lean-sys</code> is including duplicate symbols from the core Lean runtime when building a shared libaray. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>?</p>",
        "id": 454544139,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722124970
    },
    {
        "content": "<p>lean-sys doesn't define those symbols, it references them</p>",
        "id": 454544168,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722125001
    },
    {
        "content": "<p>The linker doesn't appear to agree?</p>",
        "id": 454544265,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722125046
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"736493\">@David Stainton</span> try setting the <code>extern</code> feature in lean-sys</p>",
        "id": 454544532,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722125284
    },
    {
        "content": "<p>I tried adding a test runner via David's directions (and also adding an empty file in <code>Lean/tests/Main.lean</code>) and I get a funny result:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"c1\">--no-ansi</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"bp\">.</span><span class=\"n\">Main</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/lean ././Lean/./tests/Main.lean -R ././Lean/. -o ././.lake/build/lib/tests/Main.olean -i ././.lake/build/lib/tests/Main.ilean -c ././.lake/build/ir/tests/Main.c --json</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"bp\">.</span><span class=\"n\">Main</span><span class=\"o\">:</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"o\">)</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -c -o ././.lake/build/ir/tests/Main.c.o.export ././.lake/build/ir/tests/Main.c -O3 -DNDEBUG -DLEAN_EXPORTING</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker</span><span class=\"bp\">/</span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">Rust</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"c1\">--release -- -C relocation-model=pic</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">autocfg</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">libc</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">155</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">parking_lot_core</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">10</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">cfg</span><span class=\"bp\">-</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">scopeguard</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">smallvec</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"m\">7</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">static_assertions</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">lock_api</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">.</span><span class=\"m\">12</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">memoffset</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">parking_lot</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/</span><span class=\"n\">Documents</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">ffi</span><span class=\"bp\">/</span><span class=\"n\">Rust</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`release</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">1.31</span><span class=\"n\">s</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"bp\">/</span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">cargo</span>\n<span class=\"n\">ran</span><span class=\"w\"> </span><span class=\"n\">cargo</span>\n<span class=\"n\">ran</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libcrypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">a</span>\n<span class=\"bp\">‚úî</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"n\">crypt_walker_for_lean</span><span class=\"bp\">.</span><span class=\"n\">static</span><span class=\"o\">:</span><span class=\"n\">static</span>\n<span class=\"n\">‚Ñπ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">tests</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/leanc -o ././.lake/build/bin/tests ././.lake/build/ir/tests/Main.c.o.export ././.lake/build/lib/libcrypt_walker_for_lean.a</span>\n<span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">5.0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"mi\">702</span><span class=\"n\">c31b</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">)</span>\n\n<span class=\"n\">USAGE</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OPTIONS</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">COMMAND</span><span class=\"bp\">&gt;</span>\n\n<span class=\"n\">COMMANDS</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">name</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">temp</span><span class=\"bp\">&gt;</span><span class=\"w\">     </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"w\">  </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">name</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">temp</span><span class=\"bp\">&gt;</span><span class=\"w\">    </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"w\">  </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">targets</span><span class=\"bp\">&gt;...</span><span class=\"w\">    </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">targets</span>\n<span class=\"w\">  </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">exe</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">args</span><span class=\"bp\">&gt;...</span><span class=\"w\">   </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Lake's</span><span class=\"w\"> </span><span class=\"n\">environment</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\">                  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">configured</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">driver</span>\n<span class=\"w\">  </span><span class=\"n\">check</span><span class=\"bp\">-</span><span class=\"n\">test</span><span class=\"w\">            </span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">there</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">properly</span><span class=\"w\"> </span><span class=\"n\">configured</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">driver</span>\n<span class=\"w\">  </span><span class=\"n\">lint</span><span class=\"w\">                  </span><span class=\"n\">lint</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">configured</span><span class=\"w\"> </span><span class=\"n\">lint</span><span class=\"w\"> </span><span class=\"n\">driver</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>for some reason it prints a usage note at runtime</p>",
        "id": 454544589,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722125371
    },
    {
        "content": "<p>I'm not getting the duplicate definition error</p>",
        "id": 454544676,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722125434
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> yes that was exactly what was needed to make the test target work; setting the extern feature. okay cool.</p>",
        "id": 454550846,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1722129772
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> and <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Thanks for helping me with the FFI stuff. Since then I've decided to take a different tack in my work using Lean where I write protocols in Lean without any FFI. However.. I'm hoping that my colleague will soon start integrating a benchmarking library into Lean using the FFI.</p>",
        "id": 464521685,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724380050
    },
    {
        "content": "<p>I'm going to document the things you've taught me so that my colleague can use Lean FFI for projects.</p>",
        "id": 464521869,
        "sender_full_name": "David Stainton ü¶°",
        "timestamp": 1724380168
    },
    {
        "content": "<p>You're welcome.  That all sounds great! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 464521967,
        "sender_full_name": "Mac Malone",
        "timestamp": 1724380222
    }
]