[
    {
        "content": "<p>Hi all, I'm getting a fiddly error in my reverse-ffi test example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libControl</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">reference</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"ss\">`initialize_Mathlib_Data_Complex_Trigonometric'</span>\n<span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libControl</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">undefined</span><span class=\"w\"> </span><span class=\"n\">reference</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"ss\">`initialize_Mathlib_Analysis_SpecialFunctions_Trigonometric_Basic'</span>\n</code></pre></div>\n<p>For info, here's my messy makefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">LAKE</span><span class=\"w\"> </span><span class=\"bp\">?=</span><span class=\"w\"> </span><span class=\"n\">lake</span>\n\n<span class=\"n\">lake</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LAKE</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">--dir=lean build</span>\n\n<span class=\"n\">OUT_DIR</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">out</span>\n<span class=\"n\">LEAN_SYSROOT</span><span class=\"w\"> </span><span class=\"bp\">?=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">shell</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--print-prefix)</span>\n<span class=\"n\">LEAN_LIBDIR</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LEAN_SYSROOT</span><span class=\"o\">)</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span>\n<span class=\"n\">LINK_FLAGS</span><span class=\"bp\">=-</span><span class=\"n\">Wl</span><span class=\"o\">,</span><span class=\"bp\">-</span><span class=\"n\">rpath</span><span class=\"o\">,</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LEAN_LIBDIR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Wl</span><span class=\"o\">,</span><span class=\"bp\">-</span><span class=\"n\">rpath</span><span class=\"o\">,</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">PWD</span><span class=\"o\">)</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n\n<span class=\"n\">all</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pendulum</span>\n<span class=\"n\">pendulum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">pendulum</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">lake</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">$@</span><span class=\"w\"> </span><span class=\"bp\">$&lt;</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Os</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lncursesw</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lm</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lpthread</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LEAN_SYSROOT</span><span class=\"o\">)</span><span class=\"bp\">/</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LEAN_LIBDIR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lControl</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lInit_shared</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lleanshared_1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lleanshared</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">LINK_FLAGS</span><span class=\"o\">)</span>\n\n<span class=\"n\">run</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@./</span><span class=\"n\">pendulum</span>\n\n<span class=\"n\">clean</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">pendulum</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Cleaned\"</span>\n</code></pre></div>\n<p>It's a bit cargo-culty so please forgive me. I'm sure the headers are _somewhere_ since I compiled all of Mathlib for an hour or so while calling <code>lake update</code>.</p>",
        "id": 534964585,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755527527
    },
    {
        "content": "<p>How did you build <code>libControl.so</code>? I <em>think</em> there should be a <code>libMathlib.so</code> somewhere in your build directory that you'll need to throw into <code>gcc</code> as well - perhaps iteratively with further dependencies</p>",
        "id": 534993260,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1755538031
    },
    {
        "content": "<p>I think just the <code>lake --dir=lean build</code> takes care of that? There's definitely a <code>libControl.so</code> in the build directory coming from the <code>Control.lean</code> in my <code>/lean</code> directory, but not much else, I think (I'll check again when I get home).</p>\n<p>Are they perhaps somewhere else?</p>",
        "id": 535178039,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755625950
    },
    {
        "content": "<p>So I assume you are using the <code>shared</code> facet in your lakefile to generate it? If there is \"not much else\" in your build directory, where is mathlib stored?</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Is it correct that building <code>Control:shared</code> should also trigger <code>Mathlib:shared</code> if there is any dependency? Is it the case right now that <code>shared</code> outputs on Unix do not automatically link (in the <code>ldd</code> sense) against their dependencies and if so do we have/should we open an issue about it?</p>",
        "id": 535259899,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1755677222
    },
    {
        "content": "<p>Ok well now I'm getting errors like </p>\n<blockquote>\n<p>error: Batteries/Data/Nat/Gcd.lean:21:17: 'Nat.Coprime' has already been declared</p>\n</blockquote>\n<p>So I'm clearly doing something wrong <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span> </p>\n<p>FWIW, here's the lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">control</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">Control</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">defaultFacets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">LeanLib</span><span class=\"bp\">.</span><span class=\"n\">sharedFacet</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Which I just stole from <a href=\"https://github.com/leanprover/lean4/blob/master/src/lake/examples/reverse-ffi/lib/lakefile.lean\">https://github.com/leanprover/lean4/blob/master/src/lake/examples/reverse-ffi/lib/lakefile.lean</a></p>",
        "id": 535308923,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755694840
    },
    {
        "content": "<p>It looks like you are using a different version of Lean from batteries/mathlib. Make sure the lean-toolchains coincide.</p>",
        "id": 535313886,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1755696390
    },
    {
        "content": "<p>How do I do that? Sorry my questions are so elementary; I really am not grokking the build system yet.</p>",
        "id": 535322706,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755698943
    },
    {
        "content": "<p>Usually <code>lake new math</code> would do this for you but in this context I think you can run <code>lake update</code> to trigger an automatic toolchain sync</p>",
        "id": 535344581,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1755704976
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/236449-Program-verification/topic/reverse.20ffi.20errors/near/535259899\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> Is it correct that building <code>Control:shared</code> should also trigger <code>Mathlib:shared</code> if there is any dependency?</p>\n</blockquote>\n<p>Yes.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/236449-Program-verification/topic/reverse.20ffi.20errors/near/535259899\">said</a>:</p>\n<blockquote>\n<p>Is it the case right now that <code>shared</code> outputs on Unix do not automatically link (in the <code>ldd</code> sense) against their dependencies and if so do we have/should we open an issue about it?</p>\n</blockquote>\n<p>Shared ouptuts do not link against their dependencies (on non-Windows). I do not believe there is an issue about it. It is also not clear to me whether this would be a good thing to do.</p>",
        "id": 535358957,
        "sender_full_name": "Mac Malone",
        "timestamp": 1755710033
    },
    {
        "content": "<p>I'll try <code>lake update</code> as soon as I get back home (but I thought I'd done this).</p>",
        "id": 535366150,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755713214
    },
    {
        "content": "<p>Ah it works from within the directory, but not above, which makes sense. I'm back to the <code>undefined reference</code> error.</p>\n<p>And I now find the <code>libMathlib.so</code> files! I guess I just need to add something like <code>lean/.lake/packages/**/.lake/build/lib</code> to the <code>LINK_FLAGS</code>?</p>",
        "id": 535513378,
        "sender_full_name": "Cody Roux",
        "timestamp": 1755785487
    },
    {
        "content": "<p>I think you can just pass all the <code>.so</code>s directly to gcc</p>",
        "id": 535524923,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1755788820
    }
]