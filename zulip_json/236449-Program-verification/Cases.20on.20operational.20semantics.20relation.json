[
    {
        "content": "<p>Apologies for the long listing.<br>\nI have two __equivalent__ definitions <code>Eval</code> and <code>Eval2</code> of a small step operational semantics for a control flow graph based programming language. <code>Eval</code> uses a structure and<code>Eval2</code> uses two <code>Words</code> for <code>bb,stmt</code> directly rather than a structure.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bb</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Word</span>\n<span class=\"w\">  </span><span class=\"n\">stmt</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Word</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Eval</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">ProgCount</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">AssgnRel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newpc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Word</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MemValue</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TyVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newEnv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prog</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Assgn</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">RExprToValFn</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">RhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">newplace</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">typeSize</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"w\"> </span><span class=\"n\">newAddr</span><span class=\"w\"> </span><span class=\"n\">values</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tag</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">freshTag</span><span class=\"w\"> </span><span class=\"n\">newAp</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">newplace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">getPlaceAddr</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Err</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"lhs Place {lplace} not found in environment.\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"n\">values</span>\n<span class=\"w\">        </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">newEnv</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">        </span><span class=\"n\">newpc</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">Eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newpc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newEnv</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">HaltRel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prog</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Halt</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">Eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>When I want to prove the following theorem, then on the reverse implication, LEAN is not happy using <code>case</code> only with <code>HaltRel</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">step_pc_stays_same_iff_halt</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">prog</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_bb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_stmt</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">):</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h_stmt</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Halt</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span>\n<span class=\"w\">    </span><span class=\"n\">Eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">h_stmt_eq</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Eval</span><span class=\"bp\">.</span><span class=\"n\">HaltRel</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_bb</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_stmt_eq</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">h_eval</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h_eval</span>\n<span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">HaltRel</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"w\"> </span><span class=\"n\">s4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">     </span><span class=\"c1\">-- Unify stmt_list and s1</span>\n<span class=\"w\">      </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">s4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h_bb</span>\n<span class=\"w\">        </span><span class=\"n\">injection</span><span class=\"w\"> </span><span class=\"n\">h_bb</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">h_eq</span>\n<span class=\"w\">        </span><span class=\"n\">symm</span>\n<span class=\"w\">        </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_eq</span>\n<span class=\"w\">      </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">s3</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>It says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unsolved</span><span class=\"w\"> </span><span class=\"n\">goals</span>\n<span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">mpr</span><span class=\"bp\">.</span><span class=\"n\">AssgnRel</span>\n<span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span>\n<span class=\"n\">prog</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span>\n<span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span>\n<span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span>\n<span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span>\n<span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span>\n<span class=\"n\">h_bb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span>\n<span class=\"n\">h_stmt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"n\">lplace</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Word</span>\n<span class=\"n\">rexpr</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RExpr</span>\n<span class=\"n\">values</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MemValue</span>\n<span class=\"n\">ty</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TyVal</span>\n<span class=\"n\">stmt_list</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span>\n<span class=\"n\">h</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">✝.</span><span class=\"n\">length</span>\n<span class=\"n\">a</span><span class=\"bp\">✝⁴</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">✝.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">✝⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Assgn</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"bp\">✝</span>\n<span class=\"n\">a</span><span class=\"bp\">✝³</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">✝</span>\n<span class=\"n\">a</span><span class=\"bp\">✝²</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"n\">a</span><span class=\"bp\">✝¹</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RExprToValFn</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">RhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"n\">mem</span>\n<span class=\"n\">a</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">newplace</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">typeSize</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"bp\">✝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"w\"> </span><span class=\"n\">newAddr</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"bp\">✝;</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">freshTag</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tag</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">newplace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"bp\">✝</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">          </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">getPlaceAddr</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Err</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">ToString</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"s2\">\"lhs Place \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">ToString</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">ToString</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"s2\">\" not found in environment.\"</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"bp\">✝;</span>\n<span class=\"w\">        </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"n\">mem</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"bp\">.</span><span class=\"n\">stmt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h_stmt</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Halt</span>\n</code></pre></div>\n<p>However if I tweak the relation such that the Program Counter is not a structure but individual Words (<code>Nat</code>), then LEAN is convinced that only one <code>case</code> (<code>HaltRel</code>) is enough on the reverse implication. Why?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Word</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">BB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Word</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Eval2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BB</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"w\">  </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">BB</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">AssgnRel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BB</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newpc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProgCount</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Word</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MemValue</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TyVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newEnv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prog</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Assgn</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">RExprToValFn</span><span class=\"w\"> </span><span class=\"n\">rexpr</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">RhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">newplace</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">typeSize</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">allocatedMem</span><span class=\"w\"> </span><span class=\"n\">newAddr</span><span class=\"w\"> </span><span class=\"n\">values</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tag</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">freshTag</span><span class=\"w\"> </span><span class=\"n\">newAp</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">newplace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newAddr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">updatedEnv</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">getPlaceAddr</span><span class=\"w\"> </span><span class=\"n\">lplace</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Err</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"lhs Place {lplace} not found in environment.\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WriteWordSeq</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"n\">values</span>\n<span class=\"w\">        </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">updatedMem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">LhsResult</span><span class=\"bp\">.</span><span class=\"n\">Ok</span><span class=\"w\"> </span><span class=\"n\">newEnv</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">Eval2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newEnv</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newMem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newAp</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">HaltRel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BB</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prog</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Halt</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">Eval2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">step_pc_stays_same_iff_halt2</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">bb</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BB</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PC</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">prog</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prog</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mem</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccessPerms</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_bb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_stmt</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">):</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">stmt_list</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h_stmt</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Stmt</span><span class=\"bp\">.</span><span class=\"n\">Halt</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span>\n<span class=\"w\">    </span><span class=\"n\">Eval2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prog</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">h_stmt_eq</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Eval2</span><span class=\"bp\">.</span><span class=\"n\">HaltRel</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_bb</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_stmt_eq</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">HaltRel</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"w\"> </span><span class=\"n\">s4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">     </span><span class=\"c1\">-- Unify stmt_list and s1</span>\n<span class=\"w\">      </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stmt_list</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">s4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h_bb</span>\n<span class=\"w\">        </span><span class=\"n\">injection</span><span class=\"w\"> </span><span class=\"n\">h_bb</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">h_eq</span>\n<span class=\"w\">        </span><span class=\"n\">symm</span>\n<span class=\"w\">        </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h_eq</span>\n<span class=\"w\">      </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">s3</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 495539851,
        "sender_full_name": "Siddharth Priya",
        "timestamp": 1737649780
    }
]