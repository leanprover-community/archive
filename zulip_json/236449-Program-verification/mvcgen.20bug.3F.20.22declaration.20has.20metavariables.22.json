[
    {
        "content": "<p>Hello, I ran into the following issue with <code>mvcgen</code>. Is this a bug, <span class=\"user-mention\" data-user-id=\"130195\">@Sebastian Graf</span>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Do</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Do</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">spec</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myfun_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span>\n<span class=\"w\">  </span><span class=\"n\">myfun</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">spec</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">anotherfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">anotherfun</span>\n<span class=\"w\">  </span><span class=\"n\">myfun</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">spec</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span>\n<span class=\"w\">  </span><span class=\"n\">program</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">mvcgen</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">program</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>On <a href=\"https://live.lean-lang.org/\">https://live.lean-lang.org/</a> (Lean Nightly), I get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">metavariables</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">spec'</span>\n</code></pre></div>",
        "id": 568823209,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1768835084
    },
    {
        "content": "<p>Thanks, I think I hit this bug on and off in the last couple of months but could never quite pin it down. Fixed in <a href=\"https://github.com/leanprover/lean4/pull/12048\">https://github.com/leanprover/lean4/pull/12048</a>.</p>",
        "id": 568843719,
        "sender_full_name": "Sebastian Graf",
        "timestamp": 1768841233
    },
    {
        "content": "<p>Is there a good workaround for released Lean versions?</p>",
        "id": 568844916,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1768841645
    },
    {
        "content": "<p>Hmm. Unfortunately, I don't think it's a good workaround, but writing <code>h : True</code> in terms of an <code>SPred []</code> could help: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myfun_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">⊢ₛ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SPred</span><span class=\"w\"> </span><span class=\"o\">[]))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>There may be less noisy ways like defining an abbreviation for <code>(h : ⊢ₛ (⌜.⌝ : SPred []))</code>. The point of this workaround is that SPred metavars are properly turned into synthetic opaque metavariables, which currently does not happen for metavariables of most other types. If a metavar is not opaque, then abstracting the proof will also abstract the (natural or synthetic) metavar and in doing so assign it. The bug above is that mvcgen does not track that assignment. Maybe that helps you to come up with a better fix?</p>",
        "id": 568846221,
        "sender_full_name": "Sebastian Graf",
        "timestamp": 1768842070
    },
    {
        "content": "<p>Similar, cleaner workaround: Embed <code>h : True</code> in the precondition of the hoare triple instead of having a parameter. That goes against my recommendation in the tutorial but is effectively equivalent and works around the bug for now. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">spec</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myfun_spec</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span>\n<span class=\"w\">  </span><span class=\"n\">myfun</span>\n<span class=\"w\">  </span><span class=\"o\">⦃</span><span class=\"w\"> </span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 568846511,
        "sender_full_name": "Sebastian Graf",
        "timestamp": 1768842165
    },
    {
        "content": "<p>Thanks, those workarounds are good enough for me, I think!</p>",
        "id": 568951001,
        "sender_full_name": "Alexander Bentkamp",
        "timestamp": 1768891288
    }
]