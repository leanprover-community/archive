[
    {
        "content": "<p>If we start using AI, we must be careful and add leanchecker in the CI</p>",
        "id": 474963733,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728120350
    },
    {
        "content": "<p>I'm not familiar with this tool.  What does it do?</p>\n<p>By the way, I was informed that there was a run by a major AI company performed on the implications in this project, which achieved a completion rate slightly better than our current state of 99.9%; but the proofs were very lengthy and not suitable for uploading directly in the project.  They are hoping to make some more targeted contributions in the near future.</p>",
        "id": 474998696,
        "sender_full_name": "Terence Tao",
        "timestamp": 1728148576
    },
    {
        "content": "<p>I hope I don't botch up this explanation because it is a bit subtle. Hopefully <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> can correct me about it. Here is a link to the tool: <a href=\"https://github.com/leanprover/lean4checker\">https://github.com/leanprover/lean4checker</a></p>\n<p>While Lean remains perfectly sound, Lean's metaprogramming system is very powerful and allows some flexibility in adding declarations to the \"environment\". Here, the environment is the ambient context of assumptions, hypotheses, etc. It is possible for a malicious actor to sneak in a proof of <code>False</code> while doing this and evade <code>#print_axioms</code>. This will seemingly allow exfalso quodlibet proofs.</p>\n<p>Lean4checker replays the environment from scratch, this time checking each insertion of a hypothesis into the environment, thus ensuring that no False hypothesis has been inserted into the environment.</p>",
        "id": 475006679,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728153669
    },
    {
        "content": "<p>The reason I didn't insist on this until now is that we have been using good old fashioned AI in the form of z3, Vampire etc.</p>",
        "id": 475006924,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728153810
    },
    {
        "content": "<p>And these have produced proof certificates. We have essentially been reconstructing their proofs. The room for human error in this has been small.</p>",
        "id": 475007027,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728153854
    },
    {
        "content": "<p>With modern AI being unpredictable as it is, we need to add this final layer of certainty since it might discover these metaprogramming sorceries</p>",
        "id": 475007111,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728153906
    },
    {
        "content": "<p>I see.  Would you expect implementing LeanChecker to noticeably increase the CI time?  If not then it seems like a no-brainer to implement it, AI or no AI</p>",
        "id": 475007118,
        "sender_full_name": "Terence Tao",
        "timestamp": 1728153909
    },
    {
        "content": "<p>It is definitely going to increase the CI time a bit. We should be able to use mathlib's CI action for lean4checker more or less as it is. One thing that needs checking is how it interacts with cached mathlib build files.</p>",
        "id": 475007288,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728153999
    },
    {
        "content": "<p>Because there are some underlying  C libraries that lean uses that need to matches exactly with the machine that produces mathlib's binary files.</p>",
        "id": 475007407,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728154052
    },
    {
        "content": "<p>I can check it out now in a PR.</p>",
        "id": 475007541,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728154108
    },
    {
        "content": "<p>As long as the CI time is still on the order of minutes instead of hours, I'd say it's worth it to have the extra guarantee. (Note to future self reading this thread: when writing the final paper, make a note of the extra layers of checking we have beyond the core Lean compiler, for instance we also have a separate check that no extra axioms are being inserted (<a href=\"https://github.com/teorth/equational_theories/pull/242\">equational#242</a>).)</p>\n<p>It might be good to \"red team\" and brainstorm for any other potential ways in which this project could be compromised, either by a glitchy AI or by some mischevious human.</p>",
        "id": 475007840,
        "sender_full_name": "Terence Tao",
        "timestamp": 1728154274
    },
    {
        "content": "<p>This is already part of the standard mathlib check</p>",
        "id": 475008354,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728154567
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>  : sorry for tagging you here, but I want to make sure I understand lean4checker correctly</p>",
        "id": 475009554,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155243
    },
    {
        "content": "<p>Do we need to delete the entire mathlib cache and rebuild it to run lean4checker on this repo?</p>",
        "id": 475009596,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155271
    },
    {
        "content": "<p>I should first caution that lean4checker is not an \"external checker\", it's actually just reusing the original lean checker but from a separate process. If there is a bug in the kernel then both lean and lean4checker will be compromised</p>",
        "id": 475009972,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155413
    },
    {
        "content": "<p>Another thing is how frequently would you advice we run lean4checker? We have gigantic PRs with 70-80k lines of code coming in, largely of lemmas and proofs from automatic provers. There is a chance of modern AI provers soon joining the fray</p>",
        "id": 475010012,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155433
    },
    {
        "content": "<p>The time taken by lean4checker is usually negligible, for mathlib it's around 5-10% of build time</p>",
        "id": 475010053,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155453
    },
    {
        "content": "<p>But mathlib's cache builds come from the same machine on which lean4checker runs correct?</p>",
        "id": 475010099,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155477
    },
    {
        "content": "<p>here we are using lake exe cache to get mathlib oleans</p>",
        "id": 475010118,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155488
    },
    {
        "content": "<p>I don't think it is in anyone's benefit to reduce the rate of running a trusted kernel</p>",
        "id": 475010121,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155490
    },
    {
        "content": "<p>Mathlib runs it once in 24 hours</p>",
        "id": 475010146,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155504
    },
    {
        "content": "<p>We might have to build mathlib in our CI from scratch to make sure that the machine bignum libraries match</p>",
        "id": 475010269,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155555
    },
    {
        "content": "<p>I'm aware, but mathlib also runs a lot of side runs and things. I don't think it was a good decision even then</p>",
        "id": 475010276,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155558
    },
    {
        "content": "<p>if you want high assurance the first thing you should be doing is actually running the piece of software that promises the high assurance</p>",
        "id": 475010375,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155616
    },
    {
        "content": "<p>lean4checker will check what you configure it to check. It can check everything including the parts of mathlib you depend on if you want it to</p>",
        "id": 475010605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155701
    },
    {
        "content": "<p>If we configure it to only check the code we write, is that safe? and does that help us avoiding rebuilding mathlib from scratch locally?</p>",
        "id": 475010791,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155764
    },
    {
        "content": "<p>While we're on the subject, I'll also mention <a href=\"https://github.com/digama0/lean4lean/\">lean4lean</a>, which is actually an external checker, and has the same interface as lean4checker</p>",
        "id": 475010848,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155792
    },
    {
        "content": "<p>Neither of these tools requires that you rebuild mathlib</p>",
        "id": 475010897,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155810
    },
    {
        "content": "<p>they work based on the produced .olean files</p>",
        "id": 475010931,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155817
    },
    {
        "content": "<p>The lean4checker explicitly advises against using cached oleans</p>",
        "id": 475010998,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728155841
    },
    {
        "content": "<p>oleans that cause lean4checker to have problems also cause lean to have problems</p>",
        "id": 475011127,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155895
    },
    {
        "content": "<p>so as long as the cache is working for you there is not much to worry about</p>",
        "id": 475011163,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155916
    },
    {
        "content": "<p>the text there actually says that it will fail if you give it oleans for the wrong OS</p>",
        "id": 475011197,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155931
    },
    {
        "content": "<p>which is fine, that's failing in the right direction</p>",
        "id": 475011214,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728155939
    },
    {
        "content": "<p>34 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"458659\" href=\"/#narrow/stream/458659-Equational/topic/Thoughts.20and.20impressions.20thread\">#Equational &gt; Thoughts and impressions thread</a> by <span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span>.</p>",
        "id": 475011262,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728155960
    },
    {
        "content": "<p>in any case, when you use <code>lake exe cache get</code> you aren't downloading <code>.olean</code>s directly, you are downloading a cross platform format <code>.lgz</code> which is unpacked into <code>.olean</code>s suitable for your OS</p>",
        "id": 475011381,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728156005
    },
    {
        "content": "<p>I am now considering setting up lean4lean</p>",
        "id": 475011485,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728156051
    },
    {
        "content": "<p>If we want high assurance, we might as well go for the highest assurance</p>",
        "id": 475011521,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728156069
    },
    {
        "content": "<p>Is there like a general instruction file on how to use lean4lean on other projects?</p>",
        "id": 475012572,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728156579
    },
    {
        "content": "<p>the instructions are in the readme, LMK if they need improvement</p>",
        "id": 475012655,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728156606
    },
    {
        "content": "<p>okay, I will get on with it and if I succeed, we should have lean4lean checking each PR</p>",
        "id": 475026726,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728166127
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> : I tested lean4lean locally</p>",
        "id": 475036144,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176439
    },
    {
        "content": "<p>Initially it failed on the equations project</p>",
        "id": 475036164,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176463
    },
    {
        "content": "<p>Then I tried it on a fresh batteries clone and it reported failures</p>",
        "id": 475036177,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176478
    },
    {
        "content": "<p>Turns out the toolchains need to match</p>",
        "id": 475036180,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176485
    },
    {
        "content": "<p>I got it working for batteries toolchain v4.12.0-rc1</p>",
        "id": 475036203,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176519
    },
    {
        "content": "<p>This is the latest toolchain on lean4lean</p>",
        "id": 475036248,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176539
    },
    {
        "content": "<p>yes, you need to rebuild it with the same toolchain as the project</p>",
        "id": 475036253,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728176546
    },
    {
        "content": "<p>same for lean4checker btw</p>",
        "id": 475036254,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728176559
    },
    {
        "content": "<p>yeah but Kim keeps lean4checker up to date</p>",
        "id": 475036262,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176574
    },
    {
        "content": "<p>Can I push an update and a regular CI script to keep the toolchain up to date?</p>",
        "id": 475036278,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176592
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/CI.20Lean.20Environment.20Check/near/475036262\">said</a>:</p>\n<blockquote>\n<p>yeah but Kim keeps lean4checker up to date</p>\n</blockquote>\n<p>I don't think so? The script to run lean4checker on your project just rebuilds it, and it doesn't break often</p>",
        "id": 475036313,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728176629
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/CI.20Lean.20Environment.20Check/near/475036278\">said</a>:</p>\n<blockquote>\n<p>Can I push an update and a regular CI script to keep the toolchain up to date?</p>\n</blockquote>\n<p>Sure. Is lean-action able to do this?</p>",
        "id": 475036366,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728176660
    },
    {
        "content": "<p>I tried building lean4lean on 4.13.0-rc3</p>",
        "id": 475036459,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176771
    },
    {
        "content": "<p>It fails on batteries dependencies</p>",
        "id": 475036462,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176777
    },
    {
        "content": "<p>I'll try deleting the manifest</p>",
        "id": 475036476,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176800
    },
    {
        "content": "<p>It still errors, this time on Verify</p>",
        "id": 475036537,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176869
    },
    {
        "content": "<p>First error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Lean4Lean</span><span class=\"bp\">/</span><span class=\"n\">Verify</span><span class=\"bp\">/</span><span class=\"n\">Axioms</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"mi\">36</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">data'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">contain</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">data'</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"bp\">✝</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>",
        "id": 475036577,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176891
    },
    {
        "content": "<p>I got the lean4lean cli to build, but I did not have to do this on 4.12.0-rc1</p>",
        "id": 475036653,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728176985
    },
    {
        "content": "<p>wow, apparently lean core is still struggling with backward compatibility</p>",
        "id": 475036720,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177073
    },
    {
        "content": "<p>I'll deal with this, not right now</p>",
        "id": 475036728,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177087
    },
    {
        "content": "<p>Oh and lean4lean managed to crash my system</p>",
        "id": 475036732,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177099
    },
    {
        "content": "<p>To be fair equational_theories has some huge files</p>",
        "id": 475036793,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177160
    },
    {
        "content": "<p>you have to be careful, the multithreaded mode tends to use up all your memory if you don't limit the number of threads because it has to build a bunch of mathlibs in memory</p>",
        "id": 475036891,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177281
    },
    {
        "content": "<p>I can usually only run it in single threaded mode</p>",
        "id": 475036909,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177309
    },
    {
        "content": "<p>Yes. 28 GB out of 32GB ram</p>",
        "id": 475036920,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177337
    },
    {
        "content": "<p>It went upto 35 and started using swap</p>",
        "id": 475036975,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177370
    },
    {
        "content": "<p>I have never been in that territory with this machine</p>",
        "id": 475036981,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177381
    },
    {
        "content": "<p>It did find a problem in <code>ProofWidgets.Component.Recharts</code></p>",
        "id": 475037027,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177420
    },
    {
        "content": "<p>README doesn't suggest an option to limit threads.</p>",
        "id": 475037146,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177515
    },
    {
        "content": "<p><code>env LEAN_NUM_THREADS=n lean4lean ...</code></p>",
        "id": 475037282,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177683
    },
    {
        "content": "<p>Okay. I started it with taskset</p>",
        "id": 475037292,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177702
    },
    {
        "content": "<p>(BTW IIRC lean4checker has exactly the same behavior in terms of memory usage)</p>",
        "id": 475037357,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177759
    },
    {
        "content": "<p>maybe there is something more that can be done about it</p>",
        "id": 475037390,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728177805
    },
    {
        "content": "<p>The taskset solution worked for a while, but memory started filling up very quickly</p>",
        "id": 475037483,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177892
    },
    {
        "content": "<p>Now trying  the env method you suggested</p>",
        "id": 475037502,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728177914
    },
    {
        "content": "<p>A few observations about lean4lean run on the project. </p>\n<ol>\n<li>I ran it with 2 threads starting at roughly 3:25 am. As of 3:48 am lean4lean is still running. This means CI runs are going to be very very long.</li>\n<li>It takes upto 10 GB of RAM on an 9th gen i9 processor with 32 GB RAM. While not exactly brand new, this processor is rather powerful. I am guessing github doesn't run its CI allocating such resources. </li>\n<li>The threads seem to be unevenly used at times. I can't explain why. This is especially close to files for which lean4lean posts large numbers inside  the occasional \"lean4lean took xxxx\" updates</li>\n<li>About the updates. On the one hand it serves as a nice progress counter. On the other hand if lean4lean finds a problem, it simply logs them in the same stream of outputs.</li>\n<li>The units of <code>lean4lean took xxxx</code> are unclear and I would guess milliseconds. I would also venture a guess that it reports whenever a file takes more than 1000 milliseconds or so</li>\n<li>Could we have an option to get only the summary of problematic files in the end?</li>\n</ol>",
        "id": 475038925,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179536
    },
    {
        "content": "<p>there shouldn't be any problematic files, unless by problematic you mean taking a long time</p>",
        "id": 475039023,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728179656
    },
    {
        "content": "<p><code>lean4lean found a problem in ProofWidgets.Component.Recharts</code></p>",
        "id": 475039038,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179676
    },
    {
        "content": "<p>The only one so far</p>",
        "id": 475039039,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179681
    },
    {
        "content": "<p>there should be an error after that?</p>",
        "id": 475039081,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728179751
    },
    {
        "content": "<p>actually it should immediately exit after printing that</p>",
        "id": 475039128,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728179792
    },
    {
        "content": "<p>None. lean4lean continues running and posting updates for files and <code>lean4lean took xxxx</code> where <code>xxxx &gt; 1000</code> always</p>",
        "id": 475039130,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179802
    },
    {
        "content": "<p>This one has the largest <code>xxxx</code> : <code>Mathlib.Analysis.Complex.UpperHalfPlane.Metric:thmDecl UpperHalfPlane.isometry_vertical_line: lean4lean took 25603</code></p>",
        "id": 475039172,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179830
    },
    {
        "content": "<p>the times are in ms as you predicted</p>",
        "id": 475039194,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728179878
    },
    {
        "content": "<p>Here's a screenshot:<br>\n<a href=\"/user_uploads/3121/RiaI7FkhNHUFSPvpUuL0Rf3a/Screenshot-from-2024-10-06-03-58-02.png\">Screenshot from 2024-10-06 03-58-02.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/RiaI7FkhNHUFSPvpUuL0Rf3a/Screenshot-from-2024-10-06-03-58-02.png\" title=\"Screenshot from 2024-10-06 03-58-02.png\"><img data-original-dimensions=\"3801x1881\" src=\"/user_uploads/thumbnail/3121/RiaI7FkhNHUFSPvpUuL0Rf3a/Screenshot-from-2024-10-06-03-58-02.png/840x560.webp\"></a></div>",
        "id": 475039243,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179904
    },
    {
        "content": "<p>should have cropped that</p>",
        "id": 475039252,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728179939
    },
    {
        "content": "<p>oh note that the error is printed to stderr, while the rest goes to stdout, so there could be some races between the prints</p>",
        "id": 475039271,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728179964
    },
    {
        "content": "<p>It's still running so it didn't quit after the error</p>",
        "id": 475039369,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180029
    },
    {
        "content": "<p>try changing Main.lean:288 to <code>IO.eprintln s!\"lean4lean found a problem in {m}: {e.toString}\"</code> and see if you get any more information</p>",
        "id": 475039370,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180029
    },
    {
        "content": "<p>I still want to find out how many minutes it takes to finish the run</p>",
        "id": 475039425,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180067
    },
    {
        "content": "<p>I'll try after this run</p>",
        "id": 475039431,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180074
    },
    {
        "content": "<p>I don't think I've ever tried to build mathlib in that configuration</p>",
        "id": 475039510,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180135
    },
    {
        "content": "<p>the paper claims it can do mathlib in 58 minutes</p>",
        "id": 475039530,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180171
    },
    {
        "content": "<p>Two more 10k+ champions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">RamificationInertia</span><span class=\"o\">:</span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">powQuotSuccInclusion_injective</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean4lean</span><span class=\"w\"> </span><span class=\"n\">took</span><span class=\"w\"> </span><span class=\"mi\">11703</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">FactorisationProperties</span><span class=\"o\">:</span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">weird_seventy</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lean4lean</span><span class=\"w\"> </span><span class=\"n\">took</span><span class=\"w\"> </span><span class=\"mi\">14217</span>\n</code></pre></div>",
        "id": 475039533,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180177
    },
    {
        "content": "<p>(in case it wasn't clear, this is not the configuration you want for CI. It's spending all its time checking mathlib instead of your project)</p>",
        "id": 475039676,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180346
    },
    {
        "content": "<p>I think you want <code>lean4lean Equational</code> where <code>Equational</code> is replaced by the name of the root module</p>",
        "id": 475039781,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180424
    },
    {
        "content": "<p>Oh I see</p>",
        "id": 475039802,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180456
    },
    {
        "content": "<p>also with <code>LEAN_NUM_THREADS</code> set to something low</p>",
        "id": 475039804,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180459
    },
    {
        "content": "<p>the default behavior is to check every .olean file in <code>.lake</code></p>",
        "id": 475039868,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728180533
    },
    {
        "content": "<p>I terminated the older run at 4:10 am</p>\n<p>This new run on the project was instantaneous</p>",
        "id": 475039986,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180704
    },
    {
        "content": "<p>but gave no success message</p>",
        "id": 475039988,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/458659-Equational/topic/CI.20Lean.20Environment.20Check/near/475039370\">said</a>:</p>\n<blockquote>\n<p>try changing Main.lean:288 to <code>IO.eprintln s!\"lean4lean found a problem in {m}: {e.toString}\"</code> and see if you get any more information</p>\n</blockquote>\n<p>Tried this suggestion on the older run (equivalent to --fresh I guess)</p>",
        "id": 475040179,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180929
    },
    {
        "content": "<p>Got a longer error message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean4lean</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">problem</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"bp\">.</span><span class=\"n\">Component</span><span class=\"bp\">.</span><span class=\"n\">Recharts</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">ProofWidgets</span><span class=\"bp\">/</span><span class=\"n\">Component</span><span class=\"bp\">/</span><span class=\"n\">Recharts</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">header</span>\n</code></pre></div>",
        "id": 475040205,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180954
    },
    {
        "content": "<p>But lean4lean hasn't quit</p>",
        "id": 475040209,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180961
    },
    {
        "content": "<p>The good news in all this is that the project is sound so far</p>",
        "id": 475040260,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728180993
    },
    {
        "content": "<p>ah right, I remember this issue. ProofWidgets has a flag saying to download a release, even though it contains out of date olean files. <code>lake exe cache</code> replaces them with correct olean files, but some files are left over and not overwritten, for lean files that have since been deleted</p>",
        "id": 475040370,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728181095
    },
    {
        "content": "<p>these files are basically dead and unused, but lean4lean just checks everything in the folder because it doesn't do dependency analysis in the default mode because it doesn't know what the target is</p>",
        "id": 475040588,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728181195
    },
    {
        "content": "<p>when you do <code>lean4lean Equational</code> it will check only the dependencies of <code>Equational</code> module, so make sure all the results you want checked are transitively reachable from it</p>",
        "id": 475040777,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728181241
    },
    {
        "content": "<p>will do. I need to catch some sleep. I will put the CI up tomorrow</p>",
        "id": 475040917,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728181284
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/CI.20Lean.20Environment.20Check/near/475036278\">said</a>:</p>\n<blockquote>\n<p>Can I push an update and a regular CI script to keep the toolchain up to date?</p>\n</blockquote>\n<p>I pushed an update, but you are welcome to add the CI script</p>",
        "id": 475059614,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728193677
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> : Is it okay if I add tags to lean4lean? From the equational_theories side, it makes a lot of sense to clone the repository at the matching tag and if one is not found then complain about it.</p>",
        "id": 475411988,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728339709
    },
    {
        "content": "<p>The alternative is to read the lean4lean file's lean-toolchain</p>",
        "id": 475412400,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728339938
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"657719\">@Terence Tao</span> : I am sorry it took me a couple of days, since I have been chasing other deadlines in my day job (PhD). I'll get this CI integrated now</p>",
        "id": 475412524,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728339999
    },
    {
        "content": "<p>At the very least there will be a script to check the project with lean4lean soon.</p>",
        "id": 475412540,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728340014
    },
    {
        "content": "<p>The CI PR is up already. Currently it only applies lean4lean if the toolchains match and if a freshly cloned lean4lean builds.</p>",
        "id": 475528124,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728382753
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> : in <a href=\"https://github.com/teorth/equational_theories/pull/421\">equational#421</a> we have CI action which invokes a python script that runs lean4lean on the project.</p>",
        "id": 475972198,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728514556
    },
    {
        "content": "<p>One thing that bothers me is that lean4lean seems to run nearly instantaneously</p>",
        "id": 475972272,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728514585
    },
    {
        "content": "<p>how did you invoke it?</p>",
        "id": 475972296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728514600
    },
    {
        "content": "<p>I want to make sure the script is doing the right thing.</p>",
        "id": 475972305,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728514604
    },
    {
        "content": "<p><code>env LEAN_NUM_THREADS=2 lake env &lt;lean4lean_bin_path&gt; --verbose equational_theories</code></p>",
        "id": 475972646,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728514774
    },
    {
        "content": "<p>Important point : The script is called as a step in the blueprint.yml CI where the project has already been built</p>",
        "id": 475973989,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728515308
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> : quick reminder about this.</p>",
        "id": 476179909,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728579425
    },
    {
        "content": "<p>I was reading that script and realised it would be pointless to run lake update when trying to match toolchains</p>",
        "id": 476185626,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728581552
    }
]