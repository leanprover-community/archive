[
    {
        "content": "<p>Hello I'm quite busy so probably won't be able to try things you suggest immediately but when I try to open the project up in gitpod I get errors like below is there anything we can do to make this a nicer onboarding experience? I just forked then opened it up in gitpod and it wasn't working</p>\n<p><code>/home/gitpod/.elan/toolchains/leanprover--lean4---v4.12.0-rc1/bin/lake setup-file /workspace/equational_theories/equational_theories/Basic.lean Init Mathlib.Data.Nat.Defs Mathlib.Tactic</code> failed:</p>\n<p>stderr:<br>\nâš  [50/2301] Replayed Mathlib.Lean.Meta<br>\nwarning: ././.lake/packages/mathlib/././Mathlib/Lean/Meta.lean:75:22: <code>Lean.Elab.Tactic.TacticM.runCore'</code> is missing a doc-string, please add one.<br>\nDeclarations whose name ends with a <code>'</code> are expected to contain an explanation for the presence of a <code>'</code> in their doc-string. This may consist of discussion of the difference relative to the unprimed version, or an explanation as to why no better naming scheme is possible.</p>",
        "id": 473078835,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727434679
    },
    {
        "content": "<p>\"error: external command 'npm' exited with code 255\" seems to be lower down in this file so presumably thats just not installed somehow?</p>",
        "id": 473079807,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727435039
    },
    {
        "content": "<p>Or can it be turned off?</p>",
        "id": 473080541,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727435288
    },
    {
        "content": "<p>Can you give the gitpod link?  The docPrime linter should be off by default in the project, so I would have to see why it is kicking off here.</p>",
        "id": 473082979,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727435906
    },
    {
        "content": "<p>Did you open a file before cache and build ran?</p>",
        "id": 473086656,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727436810
    },
    {
        "content": "<p>I bet I did that I'll try again being more patient later.</p>",
        "id": 473089475,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727437854
    },
    {
        "content": "<p>Thank you</p>",
        "id": 473089626,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727437919
    },
    {
        "content": "<p>Do let us know if that works</p>",
        "id": 473090498,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727438218
    },
    {
        "content": "<p>The reason this wait is needed is that the docker image is setup to load a project as a volume (external folder) and cache needs to be run inside the project directory.</p>",
        "id": 473095134,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727439530
    },
    {
        "content": "<p>Yes working great now thank you</p>",
        "id": 473110601,
        "sender_full_name": "Leo Shine",
        "timestamp": 1727443655
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/Issue.20running.20this.20in.20gitpod/near/473086656\">said</a>:</p>\n<blockquote>\n<p>Did you open a file before cache and build ran?</p>\n</blockquote>\n<p>This is a real gotcha for beginners who have not used Lean before. I was caught out by it a couple of times in the past before I realised what I was doing wrong. Is there a way we can somehow make this impossible?</p>",
        "id": 473216503,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1727472883
    },
    {
        "content": "<p>An ideal long term solution is to have a mathlib + cache installed with the toolchain</p>",
        "id": 473217194,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473225
    },
    {
        "content": "<p>Or in a central repository/directory</p>",
        "id": 473217200,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473231
    },
    {
        "content": "<p>And just linked into the project</p>",
        "id": 473217212,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473239
    },
    {
        "content": "<p>Short term, we have to create a container file for each project that packages the whole thing, and I think gitpod doesn't really work well with that. Someone who knows better can correct me on that point</p>",
        "id": 473217302,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473301
    },
    {
        "content": "<p>In fact I am quite certain on that point because docker containers don't persist any workspace edits by default</p>",
        "id": 473218240,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473754
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 473218296,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473769
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 473218323,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473781
    },
    {
        "content": "<p>So they almost certainly use volumes or equivalent solutions</p>",
        "id": 473218324,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473781
    },
    {
        "content": "<p>And unfortunately we store mathlib and its build cache inside this workspace</p>",
        "id": 473218486,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473843
    },
    {
        "content": "<p>I'll check this point again. Maybe gitpod offers a workaround.</p>",
        "id": 473218963,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727473958
    },
    {
        "content": "<p>Checked. We are already running the cache in their prebuild feature</p>",
        "id": 473219483,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727474095
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> : your question and my response is probably of broader interest to lean4 devs and others. I request that we these messages to a suitable topic of the <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4\">#lean4</a> channel.</p>",
        "id": 473219974,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1727474200
    },
    {
        "content": "<p>I want to bring this up again. It has become an irritant while I review PRs here because I have to wait 5 minutes, <strong>after</strong> the gitpod vscode has  opened, before I can touch any lean files.</p>\n<p>I believe if we had central mathlib installs rather than in-project installs, we could not only save space on our machines but also not wait for gitpod to run cache after the editor has opened. We could read the lean-toolchain file and have elan handle mathlib and get its cache downloaded before opening up the editor. I am really beginning to appreciate the opam + dune model now, where opam manages packages, not dune.</p>\n<p>CC : <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> whom should I bring this up to?</p>",
        "id": 476165067,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728575155
    },
    {
        "content": "<p>No idea, I don't know much about gitpod.</p>",
        "id": 476168110,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728576061
    },
    {
        "content": "<p>This is more about the way lake manages packages. I believe if elan could manage packages, then we would be able to centrally install mathlib.</p>",
        "id": 476169852,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728576477
    },
    {
        "content": "<p>If lean/mathlib could offer standard \"switches\" per toolchain, then all we would need it setup this \"switch\" (I am borrowing opam terminology) by reading the lean-toolchain file, and have elan install it. Then lake would just have to find and link it.</p>",
        "id": 476170143,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728576548
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/Issue.20running.20this.20in.20gitpod/near/476170143\">said</a>:</p>\n<blockquote>\n<p>If lean/mathlib could offer standard \"switches\" per toolchain, then all we would need it setup this \"switch\" (I am borrowing opam terminology) by reading the lean-toolchain file, and have elan install it. Then lake would just have to find and link it.</p>\n</blockquote>\n<p>Mathlib has version tags (e.g. <a href=\"https://github.com/leanprover-community/mathlib4/tree/v4.12.0\">https://github.com/leanprover-community/mathlib4/tree/v4.12.0</a>), is that a \"switch\"?</p>",
        "id": 476171597,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1728576877
    },
    {
        "content": "<p>Not quite. The closest thing we have to a switch in lean are the version tags we use in lakefile.lean.</p>",
        "id": 476172369,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728577084
    },
    {
        "content": "<p>The idea I am borrowing from switches is to isolate  toolchain + dependencies for one or more projects and store them centrally. Potentially also garbage collecting the unused ones.</p>",
        "id": 476173735,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728577385
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/Issue.20running.20this.20in.20gitpod/near/476165067\">schrieb</a>:</p>\n<blockquote>\n<p>I want to bring this up again. It has become an irritant while I review PRs here because I have to wait 5 minutes, <strong>after</strong> the gitpod vscode has opened, before I can touch any lean files.</p>\n<p>I believe if we had central mathlib installs rather than in-project installs, we could not only save space on our machines but also not wait for gitpod to run cache after the editor has opened. We could read the lean-toolchain file and have elan handle mathlib and get its cache downloaded before opening up the editor. I am really beginning to appreciate the opam + dune model now, where opam manages packages, not dune.</p>\n</blockquote>\n<p>I guess it'd be possible to  pre-fetch and build dependencies before the editor starts (.gitpod.yml). Something like this (lake would just fetch the cached stuff). Would that help?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tasks</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">      </span><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">      </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"w\">    </span><span class=\"n\">command</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 476855841,
        "sender_full_name": "Michael Bucko",
        "timestamp": 1728942558
    },
    {
        "content": "<p>We already do that</p>",
        "id": 476856491,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943024
    },
    {
        "content": "<p>Minus the lake build</p>",
        "id": 476856495,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943029
    },
    {
        "content": "<p>The issue is that these init tasks run after the editor has opened up. They need to be run inside the project folder that I think is mounted as a volume (or the other persistent option on gitpod).</p>",
        "id": 476856542,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943075
    },
    {
        "content": "<p>The elan install is part of the dockerfile</p>",
        "id": 476856641,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943121
    },
    {
        "content": "<p>Ideally we would like to do mathlib cache inside the dockerfile as well.</p>",
        "id": 476856667,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943140
    },
    {
        "content": "<p>But this is not possible since lake has to fetch Mathlib + cache and it can only learn the project's toolchain inside the folder and do the above setup after opening the project folder</p>",
        "id": 476856860,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943251
    },
    {
        "content": "<p>In my idea we have docker files specific to a toolchain / switch(hypothetical) and elan can install Mathlib + cache as part of this switch. This step would be accomplished when the docker image is compiled, which happens before the editor launch .The project can then picks its \"switch\" and dependency subset and can get linked to it by talking to elan or searching the include directories provided by elan</p>",
        "id": 476857195,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943453
    },
    {
        "content": "<p>For local purposes since people try to stick to the latest toolchain, the unused ones can be garbage collected like nix does</p>",
        "id": 476857240,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728943496
    }
]