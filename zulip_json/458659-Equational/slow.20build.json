[
    {
        "content": "<p>A local <code>lake build</code> is now very slow for me on this project. Yesterday a clean build took less than 2 minutes. Now it takes more than 10 minutes.</p>\n<p>I tried <code>git bisect</code> and the first bad commit is <a href=\"https://github.com/teorth/equational_theories/pull/427\">equational#427</a></p>",
        "id": 475869383,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728482017
    },
    {
        "content": "<p>Seconded, my laptop is really struggling with building the project now :(</p>",
        "id": 475870371,
        "sender_full_name": "Zoltan A. Kocsis (Z.A.K.)",
        "timestamp": 1728482289
    },
    {
        "content": "<p>Was mathlib or lean bumped in the mean time?</p>",
        "id": 475873080,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728482736
    },
    {
        "content": "<p>same here (and same on CI)</p>",
        "id": 475873269,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728482765
    },
    {
        "content": "<p>In other words, do we expect that this is a problem of the project itself, or the tooling and libraries below it?</p>",
        "id": 475873336,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728482775
    },
    {
        "content": "<p>Yes, it takes more than 50 minutes for the project to build in CI. <a href=\"#narrow/stream/458659-Equational/topic/.E2.9C.94.20Do.20we.20need.20to.20build.20EquationalSearch.20files.3F\">https://leanprover.zulipchat.com/#narrow/stream/458659-Equational/topic/.E2.9C.94.20Do.20we.20need.20to.20build.20EquationalSearch.20files.3F</a></p>",
        "id": 475873348,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1728482777
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475873080\">said</a>:</p>\n<blockquote>\n<p>Was mathlib or lean bumped in the mean time?</p>\n</blockquote>\n<p>no</p>",
        "id": 475873642,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728482835
    },
    {
        "content": "<blockquote>\n<p>Now it takes more than 10 minutes.</p>\n</blockquote>\n<p>This was a lower bound. I still haven't actually let it run to completion.</p>",
        "id": 475873837,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728482877
    },
    {
        "content": "<p>notably, these issues seem to be before <a href=\"https://github.com/teorth/equational_theories/pull/427\">equational#427</a> from the other thread? (probably compounding effects)</p>",
        "id": 475873959,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728482895
    },
    {
        "content": "<p>When I did <code>git bisect</code>, I tried a clean build at <code>adc92cbf5229250038e8a6591180e959eedb357d</code>, and killed it after 10 minutes.</p>",
        "id": 475874140,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728482956
    },
    {
        "content": "<p>commits before that take less than 2 minutes (on my local machine)</p>",
        "id": 475874173,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728482965
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/commit/adc92cbf5229250038e8a6591180e959eedb357d\">https://github.com/teorth/equational_theories/commit/adc92cbf5229250038e8a6591180e959eedb357d</a></p>",
        "id": 475874602,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728483087
    },
    {
        "content": "<p>It is modifying the <code>equation</code> command. Maybe something went wrong there, and now it takes 0.5s per equation? With ~5000 equation commands, that would take ~50m?</p>",
        "id": 475875170,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728483234
    },
    {
        "content": "<p>the weird thing is that from a clean build, <code>Equations.lean</code> seems to build relatively reasonably, which seems odd if the elaboration seems to be the culprit (e.g. following a <a href=\"https://github.com/teorth/equational_theories/pull/427#discussion_r1793586843\">comment by <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>  in the PR</a>)</p>",
        "id": 475875188,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483236
    },
    {
        "content": "<p>Did the modification of the equation command have something to do with it?</p>",
        "id": 475875629,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483322
    },
    {
        "content": "<p>it's building new theorems for every equation, and doing so by re-elaborating a bunch of stuff</p>",
        "id": 475875855,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483364
    },
    {
        "content": "<p>oh sorry, zulip just decided to reconnect to the network. I see this is being discussed already</p>",
        "id": 475875882,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483371
    },
    {
        "content": "<p>I suggest reverting <a href=\"https://github.com/teorth/equational_theories/pull/427\">equational#427</a> and the dependent <a href=\"https://github.com/teorth/equational_theories/pull/429\">equational#429</a> if someone can confirm this</p>",
        "id": 475876414,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483493
    },
    {
        "content": "<p>If it is agreed, I can do this right away</p>",
        "id": 475876492,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483511
    },
    {
        "content": "<p>Shouldn't we be fixing instead of reverting?</p>",
        "id": 475876735,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483562
    },
    {
        "content": "<p>A new PR could do it yes.</p>",
        "id": 475876895,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483595
    },
    {
        "content": "<p>Let's do it the right way</p>",
        "id": 475876996,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483609
    },
    {
        "content": "<p>I'll setup a task</p>",
        "id": 475877036,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483616
    },
    {
        "content": "<p>e.g. like <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <a href=\"https://github.com/teorth/equational_theories/pull/427#discussion_r1793586843\">suggested</a>:</p>\n<blockquote>\n<p>It might be better to do this in a more low-level way, rather than re-elaborating the law repeatedly. A hybrid approach would be to elaborate the law once and use <code>Expr.toSyntax</code> to repeat it.</p>\n</blockquote>",
        "id": 475877117,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483629
    },
    {
        "content": "<p>I don't think that's just it though:</p>\n<div class=\"codehilite\" data-code-language=\"Text output\"><pre><span></span><code><span class=\"go\">lake lean equational_theories/AllEquations.lean  141,60s user 2,40s system 97% cpu 2:27,18 total</span>\n</code></pre></div>",
        "id": 475877910,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483778
    },
    {
        "content": "<p>it takes about 2 mins and a bit to build through <code>AllEquations.lean</code> on my laptop (not a particularly good one tbh), so where are the other 46 coming from?</p>",
        "id": 475878149,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483833
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/issues/464\">https://github.com/teorth/equational_theories/issues/464</a> is up for claiming and discussions</p>",
        "id": 475878258,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483854
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475875170\">said</a>:</p>\n<blockquote>\n<p>It is modifying the <code>equation</code> command. Maybe something went wrong there, and now it takes 0.5s per equation? With ~5000 equation commands, that would take ~50m?</p>\n</blockquote>\n<p>how did you measure that? on my machine it takes about 2 mins for all 5000</p>",
        "id": 475878294,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728483866
    },
    {
        "content": "<p>Is the command being used outside All Equations?</p>",
        "id": 475878423,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728483912
    },
    {
        "content": "<p>seems just <code>Equations.lean</code> and <code>AllEquations.lean</code> (<code>Confluence</code> has some commented out)</p>",
        "id": 475880044,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728484256
    },
    {
        "content": "<p>Running <code>equational_theories.Generated.All4x4Tables</code> seems to take a lot of time.</p>",
        "id": 475880547,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1728484360
    },
    {
        "content": "<p>That's a lot of runs of decideFin</p>",
        "id": 475882297,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728484691
    },
    {
        "content": "<p>I don't have an explanation, but commenting out two lines brings the build time back down to the reasonable range for me (under 3 minutes): <a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a></p>",
        "id": 475883362,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728484918
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"556875\">@Pietro Monticone</span> <br>\nThere have only been 4 new contributions to All4x4Tables in the last 4 days. We're only proving like 5 equations about the new magmas, and only <a href=\"https://github.com/teorth/equational_theories/blob/main/equational_theories/Generated/All4x4Tables/Refutation743.lean\">one</a> of them is large. Unless this file takes an extreme amount of time, I doubt that recent regressions come from there.</p>",
        "id": 475883870,
        "sender_full_name": "Zoltan A. Kocsis (Z.A.K.)",
        "timestamp": 1728485017
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243791\">@David Renshaw</span> : Please claim <a href=\"https://github.com/teorth/equational_theories/pull/464\">equational#464</a> and propose the PR. The CI automation will handle the process and close the issue when  <a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a> is merged automatically</p>",
        "id": 475886368,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728485572
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 475886474,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728485594
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"556875\">Pietro Monticone</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475873348\">said</a>:</p>\n<blockquote>\n<p>Yes, it takes more than 50 minutes for the project to build in CI. <a href=\"#narrow/stream/458659-Equational/topic/.E2.9C.94.20Do.20we.20need.20to.20build.20EquationalSearch.20files.3F\">https://leanprover.zulipchat.com/#narrow/stream/458659-Equational/topic/.E2.9C.94.20Do.20we.20need.20to.20build.20EquationalSearch.20files.3F</a></p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"315434\">@Andrés Goens</span> I didn't measure anything, I was just conjecturing, based on <span aria-label=\"this\" class=\"emoji emoji-1f446\" role=\"img\" title=\"this\">:this:</span><br>\nI should have been more clear, sorry</p>",
        "id": 475887049,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728485732
    },
    {
        "content": "<p>By claim I mean commenting <code>claim</code> and after that commenting <code>propose PR #465</code></p>",
        "id": 475887099,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728485746
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243791\">David Renshaw</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475883362\">said</a>:</p>\n<blockquote>\n<p>I don't have an explanation, but commenting out two lines brings the build time back down to the reasonable range for me (under 3 minutes): <a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a></p>\n</blockquote>\n<p>This sounds like it's the environment extension that's gathering the equations. Maybe having them in the enivroment slows everything else down beacuse this enviroment has to be pouplated into memory even though it's not being used?</p>",
        "id": 475887513,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728485847
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475887099\">said</a>:</p>\n<blockquote>\n<p>By claim I mean commenting <code>claim</code> and after that commenting <code>propose PR #465</code></p>\n</blockquote>\n<p><code>propose #PR_NUMBER</code> is also allowed now btw.</p>",
        "id": 475888162,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1728486005
    },
    {
        "content": "<p>I did get a lot of trouble with my computer running out of memory lately with this project, so that would also fit with this hypothesis <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 475888959,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728486158
    },
    {
        "content": "<p>If it is the environment extension, I could try to remove it and find another way of gathering the laws, for example by traversing the environment.</p>",
        "id": 475894328,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1728487051
    },
    {
        "content": "<p>An environment extension with ~5000 entries <em>shouldn't</em> cause this kind of slowdown, unless the entries are somehow huge.</p>",
        "id": 475895219,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728487219
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a> did see a ~20 min reduction of the CI time, if I'm seeing it correctly</p>",
        "id": 475899178,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728488066
    },
    {
        "content": "<p>and that's just removing the enviroment extension</p>",
        "id": 475899209,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728488077
    },
    {
        "content": "<p>Given how this issue is impacting the entire project, I'm going to go ahead and approve <a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a> for now and hopefully we can find a more permanent solution later.</p>",
        "id": 475913816,
        "sender_full_name": "Terence Tao",
        "timestamp": 1728491744
    },
    {
        "content": "<p>The environment extension is using an <code>Array</code> instead of a <code>List</code>, this is very bad as it is used persistently</p>",
        "id": 475921807,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728494909
    },
    {
        "content": "<p>I'm not able to reproduce a slowness caused by the two lines in <a href=\"https://github.com/teorth/equational_theories/pull/465\">equational#465</a>. (On my branch <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a> which splits up <code>AllEquations</code> into less monolithic pieces,) the first 1000 equations elaborate in 28.5s with the two lines in question commented out, and 27.7s with them included, so basically within the noise margin</p>",
        "id": 475923340,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728495515
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475921807\">said</a>:</p>\n<blockquote>\n<p>The environment extension is using an <code>Array</code> instead of a <code>List</code>, this is very bad as it is used persistently</p>\n</blockquote>\n<p>can you please elaborate on this?</p>",
        "id": 475926744,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728496886
    },
    {
        "content": "<p>In this declaration</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">magmaLawExt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PersistentEnvExtension</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">NatMagmaLaw</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">NatMagmaLaw</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerPersistentEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkInitial</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">    </span><span class=\"n\">addImportedFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">concatMapM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkNatMagmaLaw</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">addEntryFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">push</span>\n<span class=\"w\">    </span><span class=\"n\">exportEntriesFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>you can see that <code>Array.push</code> is used as the <code>addEntryFn</code>. This function will almost always be called when the input value is shared (because the whole list of all intermediate environments is collected), so this will involve a deep copy of the array every time, resulting in quadratic time and space. If you compare with other <code>PersistentEnvExtension</code> implementations you will see that the running state for values in the current file is always a <code>List</code> or other persistent data structure</p>",
        "id": 475927220,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728497053
    },
    {
        "content": "<p>that said, as I mentioned I have not been able to confirm that this is the source of the performance issue because I can't measure the issue to begin with</p>",
        "id": 475927353,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728497105
    },
    {
        "content": "<p>presumably, using something like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.SimplePersistentEnvExtension#doc\">docs#Lean.SimplePersistentEnvExtension</a> might be idiomatic use?</p>",
        "id": 475927536,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1728497168
    },
    {
        "content": "<p>and perhaps look at how <a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Util/LibraryNote.html#Batteries.Util.LibraryNote.libraryNoteExt\">Batteries.Util.LibraryNote.libraryNoteExt</a> is implemented? it does a semi-similar thing...</p>",
        "id": 475927740,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1728497267
    },
    {
        "content": "<p>hm. I'll try switching to <code>List</code> and see if I can observe any difference</p>",
        "id": 475927819,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728497289
    },
    {
        "content": "<p>If I switch to <code>SimplePersistentEnv</code> then I can uncomment the <code>updateEnv</code> lines and it still builds in a reasonable amount of time.</p>",
        "id": 475930954,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728498552
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243791\">David Renshaw</span> <a href=\"#narrow/stream/458659-Equational/topic/slow.20build/near/475930954\">said</a>:</p>\n<blockquote>\n<p>If I switch to <code>SimplePersistentEnv</code> then I can uncomment the <code>updateEnv</code> lines and it still builds in a reasonable amount of time.</p>\n</blockquote>\n<p>is this with <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a>?</p>",
        "id": 475931019,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728498579
    },
    {
        "content": "<p>or even before?</p>",
        "id": 475931034,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1728498586
    },
    {
        "content": "<p>I did not pull that in.</p>",
        "id": 475931051,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728498595
    },
    {
        "content": "<p>This is on <code>main</code>.</p>",
        "id": 475931108,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728498604
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/476\">equational#476</a></p>",
        "id": 475932879,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728499323
    },
    {
        "content": "<p>though note my comment about not understanding the purpose of the existing logic in <code>addImportedFn</code></p>",
        "id": 475932932,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728499362
    },
    {
        "content": "<p>I updated the PR summary. The main lesson, I think, is that <code>PersistentEnvExtension</code> has a complex interface that is easy to use suboptimally, and that we were using it suboptimally.</p>",
        "id": 475936836,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728500946
    },
    {
        "content": "<p>If a file has two imports which in turn import <code>AllEquations.lean</code>, then maybe the extension gets computed twice, contributing to a slowdown.</p>",
        "id": 475937248,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1728501125
    },
    {
        "content": "<p>Thank you for your help in diagnosing and fixing the issue, and I'm sorry for the slowdown that this PR has caused.</p>",
        "id": 475937289,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1728501149
    },
    {
        "content": "<blockquote>\n<p>If a file has two imports which in turn import AllEquations.lean, then maybe the extension gets computed twice, contributing to a slowdown.</p>\n</blockquote>\n<p>I believe that Lean is smarter than that about transitive imports.</p>",
        "id": 475938790,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728501561
    },
    {
        "content": "<p>(or at least i hope so!)</p>",
        "id": 475938875,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728501580
    },
    {
        "content": "<p>Your hope may be too optimistic:</p>\n<blockquote>\n<p>The <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Environment.html#Lean.PersistentEnvExtension.addImportedFn\"><code>addImportedFn</code></a> runs at the beginning of elaboration for every module</p>\n</blockquote>\n<p>Did you see the docs at <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Environment.html#Lean.PersistentEnvExtension\">https://leanprover-community.github.io/mathlib4_docs/Lean/Environment.html#Lean.PersistentEnvExtension</a>?</p>",
        "id": 475953064,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728506346
    },
    {
        "content": "<p>So yes, it seems prudent for <code>addImportedFn</code> to simply store the array of arrays as it is, so that import is quick, and then only in <code>getMagmaLaws</code> do actual work.</p>",
        "id": 475953415,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728506430
    },
    {
        "content": "<p>It depends on the relative costs, right?<br>\nSuch as:</p>\n<ol>\n<li>How much work is it to serialize/deserialize <code>NatMagmaLaw</code> data?</li>\n<li>How much space does <code>NatMagmaLaw</code> data take on disk and in memory?</li>\n<li>How much work does <code>mkNatMagmaLaw</code> take?</li>\n<li>How often will we be calling <code>getMagmaLaws</code>?</li>\n</ol>\n<p>If (1) and (2) are sufficiently large and (3) and (4) are sufficiently small, then I agree with your assessment.</p>",
        "id": 475960165,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728509117
    },
    {
        "content": "<p>But unless we have evidence that we are in that regime,  I feel like we should stick to the simpler setup (<code>SimplePersistentEnvExtension</code>).</p>",
        "id": 475960943,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728509484
    },
    {
        "content": "<p>I have a new version of the <code>equation</code> command (<a href=\"https://github.com/teorth/equational_theories/pull/478\">equational#478</a>), which only takes 6s instead of 28s to elaborate the first 1000 equations. Regarding the env extension, I replaced it with a tag extension because we can recover the MagmaLaw object on the fly by interpreting the stored Expr for it.</p>",
        "id": 475975435,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728516144
    },
    {
        "content": "<p>The CI is definitely going to fail on the AllEquations split PR unless every script relying on that file is altered. The diagram generating scripts are run separately on the CI, so lake build will still pass unless something in the lean code is broken.</p>",
        "id": 475976608,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728516899
    },
    {
        "content": "<p>It seems there is breakage in lean files too (not related to the above) : <a href=\"https://github.com/teorth/equational_theories/actions/runs/11264558737/job/31324777398?pr=478\">https://github.com/teorth/equational_theories/actions/runs/11264558737/job/31324777398?pr=478</a></p>",
        "id": 475976763,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728516964
    },
    {
        "content": "<p>I already changed every script relying on that file in the PR</p>",
        "id": 475977464,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728517410
    },
    {
        "content": "<p>unless there are more scripts not in the repo</p>",
        "id": 475977478,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728517419
    },
    {
        "content": "<p>The CI in <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a> is breaking on one of these scripts</p>",
        "id": 475977805,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728517579
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/472/checks#step:15:18\">Here</a></p>",
        "id": 475977851,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728517620
    },
    {
        "content": "<p>There are three unusual steps in the blueprint action file of this project which use non-lean scripts:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generate</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">implications</span><span class=\"bp\">/</span><span class=\"n\">implications</span><span class=\"bp\">.</span><span class=\"n\">js</span>\n<span class=\"w\">        </span><span class=\"n\">run</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">          </span><span class=\"bp\">~/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">extract_implications</span><span class=\"w\"> </span><span class=\"n\">outcomes</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"w\">          </span><span class=\"n\">pip</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"n\">markdown</span>\n<span class=\"w\">          </span><span class=\"n\">python</span><span class=\"w\"> </span><span class=\"n\">scripts</span><span class=\"bp\">/</span><span class=\"n\">generate_equation_implication_js</span><span class=\"bp\">.</span><span class=\"n\">py</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n\n<span class=\"w\">      </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generate</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"n\">Explorer</span><span class=\"w\"> </span><span class=\"n\">website</span>\n<span class=\"w\">        </span><span class=\"n\">run</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">          </span><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">fme</span>\n<span class=\"w\">          </span><span class=\"n\">cp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">tools</span><span class=\"bp\">/</span><span class=\"n\">fme</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/*</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">fme</span>\n<span class=\"w\">          </span><span class=\"bp\">~/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">extract_implications</span><span class=\"w\"> </span><span class=\"n\">unknowns</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">fme</span><span class=\"bp\">/</span><span class=\"n\">unknowns</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"w\">          </span><span class=\"n\">COMMIT_HASH</span><span class=\"bp\">=$</span><span class=\"o\">(</span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"bp\">-</span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"c1\">--short HEAD)</span>\n<span class=\"w\">          </span><span class=\"n\">sed</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"s2\">\"s/VERSION_UNKNOWN/$COMMIT_HASH/g\"</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">fme</span><span class=\"bp\">/</span><span class=\"n\">index</span><span class=\"bp\">.</span><span class=\"n\">html</span>\n\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generate</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">graphiti</span><span class=\"bp\">/</span><span class=\"n\">graph</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"w\">        </span><span class=\"n\">run</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">          </span><span class=\"bp\">~/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">extract_implications</span><span class=\"w\"> </span><span class=\"c1\">--json &gt; /tmp/implications.json</span>\n<span class=\"w\">          </span><span class=\"bp\">~/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">extract_implications</span><span class=\"w\"> </span><span class=\"n\">unknowns</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">unknowns</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"w\">          </span><span class=\"n\">ruby</span><span class=\"w\"> </span><span class=\"n\">scripts</span><span class=\"bp\">/</span><span class=\"n\">generate_graphiti_data</span><span class=\"bp\">.</span><span class=\"n\">rb</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">implications</span><span class=\"bp\">.</span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">unknowns</span><span class=\"bp\">.</span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">home_page</span><span class=\"bp\">/</span><span class=\"n\">graphiti</span><span class=\"bp\">/</span><span class=\"n\">graph</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n</code></pre></div>",
        "id": 475978091,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728517754
    },
    {
        "content": "<p>it looks like I just forgot to save that file</p>",
        "id": 475978476,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728517979
    },
    {
        "content": "<p>In <a href=\"https://github.com/teorth/equational_theories/pull/478\">equational#478</a>, the docs build has a number of warnings like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">WARNING</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">calculate</span><span class=\"w\"> </span><span class=\"n\">equational</span><span class=\"w\"> </span><span class=\"n\">lemmata</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">mkDelabAttribute</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">mkDelabAttribute'</span>\n</code></pre></div>",
        "id": 475979905,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728518656
    },
    {
        "content": "<p>Is this expected?</p>",
        "id": 475980068,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728518720
    },
    {
        "content": "<p>no, I have not seen that error message before</p>",
        "id": 475980460,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728518865
    },
    {
        "content": "<p>I think this might be normal, it also occurs on master</p>",
        "id": 475980715,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728518961
    },
    {
        "content": "<p>it seems like docgen is just pretty chatty and/or doesn't know not to generate equational lemmas for unsafe declarations</p>",
        "id": 475980880,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728519007
    },
    {
        "content": "<p>Yeah it is also present in past runs of the CI</p>",
        "id": 475981219,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728519132
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/478\">equational#478</a> builds in 26 minutes. If it can be merged independent of <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a> , I would like to do it right away</p>",
        "id": 475981790,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728519334
    },
    {
        "content": "<p>could also keep the monolithic AllEquations.lean file but not actually include it in the build</p>",
        "id": 475982309,
        "sender_full_name": "lyphyser",
        "timestamp": 1728519490
    },
    {
        "content": "<p>Then it is an unbuilt file that passes CI not matter what</p>",
        "id": 475982989,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728519720
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a> fails CI</p>",
        "id": 475983457,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728519872
    },
    {
        "content": "<p>This was one of those scripts. Additionally merging <a href=\"https://github.com/teorth/equational_theories/pull/478\">equational#478</a> creates a merge conflict</p>",
        "id": 475983769,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728519974
    },
    {
        "content": "<p>We can switch these scripts to use the output of \"export_equations\"</p>",
        "id": 476013233,
        "sender_full_name": "Amir Livne Bar-on",
        "timestamp": 1728529927
    },
    {
        "content": "<p>I would prefer not to have two copies of <code>AllEquations</code> as it greatly increases the chance that any subsequent update (eg., transferring an equation from <code>AllEquations</code> to <code>Equations</code>) will be done incorrectly.</p>\n<p>There was at some point a tool added that could export <code>AllEquations</code> to JSON format in <a href=\"https://github.com/teorth/equational_theories/pull/429\">https://github.com/teorth/equational_theories/pull/429</a> .  I was thinking that it might better in the long term to have all other tooling based on such a JSON file, so that any future refactoring of <code>AllEquations</code> only needs to update the export to JSON, but perhaps the current ad hoc fix of manually adjusting all tools that import from <code>AllEquations</code> is sufficient.</p>",
        "id": 476016294,
        "sender_full_name": "Terence Tao",
        "timestamp": 1728530797
    },
    {
        "content": "<p>I would like to request the authors of the scripts for please check <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a> which makes changes to them and confirm that the changes are fine.</p>\n<ol>\n<li>The implications script</li>\n<li>The finite magma explorer</li>\n<li>The graphiti feature</li>\n</ol>",
        "id": 476098492,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728556253
    },
    {
        "content": "<p>Graphiti script update looks fine</p>",
        "id": 476148846,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1728570604
    },
    {
        "content": "<p>I merged <a href=\"https://github.com/teorth/equational_theories/pull/472\">equational#472</a>, because fixing issues arising from these scripts will be easier with a faster CI (also CI passes for now). But please do check for 1 and 2.</p>",
        "id": 476149051,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1728570665
    },
    {
        "content": "<p>Every time I build (had to do it multiple times) on a Macbook <code>lake build</code>takes at least 3 hours (testing now again - Oct 19th).</p>\n<p>Is it maybe common for Lean projects to have their docker releases? Or are we expecting that <code>lake build</code> should always take max 20 minutes or so?</p>",
        "id": 477830318,
        "sender_full_name": "Michael Bucko",
        "timestamp": 1729364512
    },
    {
        "content": "<p>Did you first run <code>lake exe cache get</code>?</p>",
        "id": 477833054,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729367043
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"672170\">@Michael Bucko</span> consider running <code>scripts/run_before_push</code>.</p>",
        "id": 477833095,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1729367095
    },
    {
        "content": "<p>Without running the cache command, lake build will also be building all of Mathlib and its dependencies</p>",
        "id": 477833138,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729367150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/458659-Equational/topic/slow.20build/near/477833054\">schrieb</a>:</p>\n<blockquote>\n<p>Did you first run <code>lake exe cache get</code>?</p>\n</blockquote>\n<p>I did it earlier, but not this time. I'll make sure to always run this one, too.</p>",
        "id": 477835016,
        "sender_full_name": "Michael Bucko",
        "timestamp": 1729368892
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"556875\">Pietro Monticone</span> <a href=\"#narrow/channel/458659-Equational/topic/slow.20build/near/477833095\">schrieb</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"672170\">Michael Bucko</span> consider running <code>scripts/run_before_push</code>.</p>\n</blockquote>\n<p>Thank you. Gonna check it out, too!</p>",
        "id": 477835039,
        "sender_full_name": "Michael Bucko",
        "timestamp": 1729368908
    }
]