[
    {
        "content": "<p>I'm confused about the following code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Rep</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">myInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rep</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulActionHomClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Action</span><span class=\"bp\">.</span><span class=\"n\">HomSubtype</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">map_smulₛₗ</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">map_smul</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rep</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulActionHomClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Action</span><span class=\"bp\">.</span><span class=\"n\">HomSubtype</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">leftRegular</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">leftRegular</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">myInstance</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>why is the second instance needed, since it seems to be just a special case of the first ?</p>",
        "id": 515536253,
        "sender_full_name": "Richard Hill",
        "timestamp": 1746116077
    },
    {
        "content": "<p>Where is this code coming from?</p>",
        "id": 515537651,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746116584
    },
    {
        "content": "<p>it's my code. I just don't know why I need the second instance which looks like a hack.<br>\nThe same thing happens with AddMonoidHomClass.</p>",
        "id": 515537960,
        "sender_full_name": "Richard Hill",
        "timestamp": 1746116696
    },
    {
        "content": "<p><code>#discr_tree_key</code> for <code>myInstance</code> reveals</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">MulActionSemiHomClass</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">LinearMap</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">other</span><span class=\"bp\">&gt;</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>and for the other instance it is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">MulActionSemiHomClass</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">LinearMap</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finsupp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">other</span><span class=\"bp\">&gt;</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">_.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Finsupp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 515542849,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746118649
    },
    {
        "content": "<p>So presumably <code>_.1.1</code> didn't match <code>Finsupp _ _ _</code></p>",
        "id": 515542913,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746118678
    },
    {
        "content": "<p>Thanks. So I guess I'll get the same problem with any representation made in the same way as <code>leftRegular R G</code>.<br>\nThis would include things constructed as <code>ofMulAction R G H</code>.</p>\n<p>Is there any way I can make the first instance more general to cover these cases?</p>",
        "id": 515543825,
        "sender_full_name": "Richard Hill",
        "timestamp": 1746119004
    },
    {
        "content": "<p>Abstraction boundaries seem to have completely collapsed here…</p>",
        "id": 515546875,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746120131
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/116395-maths/topic/instances.20for.20.60Rep.20R.20G.60/near/515546875\">said</a>:</p>\n<blockquote>\n<p>Abstraction boundaries seem to have completely collapsed here…</p>\n</blockquote>\n<p>I don't understand. The type of <code>leftRegular</code> is <code>Rep k G</code> as it should be. Where is the actual problem?</p>",
        "id": 515886412,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746272559
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/116395-maths/topic/instances.20for.20.60Rep.20R.20G.60/near/515886412\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/116395-maths/topic/instances.20for.20.60Rep.20R.20G.60/near/515546875\">said</a>:</p>\n<blockquote>\n<p>Abstraction boundaries seem to have completely collapsed here…</p>\n</blockquote>\n<p>I don't understand. The type of <code>leftRegular</code> is <code>Rep k G</code> as it should be. Where is the actual problem?</p>\n</blockquote>\n<p>Everything's reducible all the way down to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ModuleCat.of#doc\">docs#ModuleCat.of</a>, so they all get unfolded by typeclass</p>",
        "id": 515898861,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746277946
    },
    {
        "content": "<p>Maybe it's time to bite the bullet and make something irreducible and then just add more API?</p>",
        "id": 515899414,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746278154
    },
    {
        "content": "<p>Talking to Amelia and she has already done all of this (made several things irreducible, including <code>leftRegular</code>) and they're in a big chain of PRs which we might want to consider working on.</p>",
        "id": 516895863,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746710883
    },
    {
        "content": "<p>can you remember which PR this is?</p>",
        "id": 516928578,
        "sender_full_name": "Richard Hill",
        "timestamp": 1746719383
    },
    {
        "content": "<p>I've just checked that <a href=\"https://github.com/leanprover-community/mathlib4/pull/24696\">#24696</a> has fixed the other issue which you DMed me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rep</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">groupCohomology</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">groupCohomology</span><span class=\"bp\">.</span><span class=\"n\">H2</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works on #24696, fails on master</span>\n</code></pre></div>",
        "id": 517292288,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746908162
    },
    {
        "content": "<p>Thanks, that's great news!</p>",
        "id": 517378969,
        "sender_full_name": "Richard Hill",
        "timestamp": 1746983256
    }
]