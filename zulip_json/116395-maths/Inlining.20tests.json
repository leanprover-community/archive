[
    {
        "content": "<p>I have repeatedly been asked to move tactic/general metaprogramming tests to standalone files under <code>MathlibTest</code>, most recently <a href=\"https://github.com/leanprover-community/mathlib4/pull/22039#discussion_r1975689570\">here</a>.</p>",
        "id": 503232042,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1741084451
    },
    {
        "content": "<p>However I still don't understand the point of making standalone test files for meta things that already function the way they're intended to work by the end of their file:</p>\n<ol>\n<li>Tests can already be made at the end of the file</li>\n<li>One gets instantaneous feedback when modifying/fixing breakage of the meta thing</li>\n<li>The tests demonstrate to the wandering user how to use the meta thing</li>\n<li>The tests don't weigh in the oleans + they are usually instantaneous</li>\n</ol>",
        "id": 503232202,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1741084502
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/116395-maths/topic/Inlining.20tests/near/503232202\">said</a>:</p>\n<blockquote>\n<p>The tests don't weigh in the oleans + they are usually instantaneous</p>\n</blockquote>\n<p>Perhaps we should have <code>fast_example</code> defined as <code>example</code> with a lower heartbeat count, to enforce this?</p>",
        "id": 503236711,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741085925
    },
    {
        "content": "<p>In some cases, the slightly different environment setup that the test files have may be useful for actual testing.  E.g. what options are on, which linters are running, whether declarations are defined in the same module or not,...</p>",
        "id": 503251097,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741090353
    },
    {
        "content": "<p>In some cases, yes, but often not, especially for particularly simple tactics.</p>\n<p>At any rate, I would heartily support that at the very least, test files should always be linked from their implementation files, because test files are kind of hard to find (<code>example</code>s don't leave searchable theorems behind) while implementations can be easily found with go-to-definition. I quite often end up having to reverse engineer how obscure/undocumented tactics work from their code, and having examples and tests to work from is very helpful when they exist.</p>",
        "id": 504435379,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1741557048
    },
    {
        "content": "<p>Devils advocate:</p>\n<ol>\n<li>Inline tests are going to have an effect on the UX in the editor when viewing/modifying the source file, both in time and space. They can also make search more difficult if a given string appears often in a test/example relative to its substantive occurrences.</li>\n<li>Now someone looking for tests has two places to look instead of one (is it in the file or is it in a test file)</li>\n<li>Similarly, there will probably be debates about whether a given thing should be an inline test or go in a test file, or when some inline tests should be be extracted into their own file.</li>\n</ol>",
        "id": 504459231,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1741574594
    },
    {
        "content": "<p>Inline tests increase the \"mandatory build time\" of a given file. Sure, mathlib is usually not built by users, but it should be possible to build mathlib only up to some file manually and not have to build tests along the way. In fact, even CI does this - the test step is separate from the build step, so you can see the relative overall performance of the two stages and get separate feedback from them.</p>",
        "id": 505409921,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741869614
    },
    {
        "content": "<p>Sure, but the tests I have been told to move out are syntax or domain tests, not performance.</p>",
        "id": 505410227,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1741869691
    },
    {
        "content": "<p>For the same reason that we minimize dependency bloat and try to ensure that only the actual requirements of a given piece of mathlib are in its dependency tree, we don't want things that don't contribute to the build to be in the build</p>",
        "id": 505410317,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741869715
    },
    {
        "content": "<p>testing is a separate activity from building</p>",
        "id": 505410453,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741869746
    },
    {
        "content": "<p>But at the same time, we do refrain from over splitting files, as this makes development more painful. In the same way, having the tests elsewhere for notation and tactics does increase the development time when working on them.</p>",
        "id": 505427551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741873985
    },
    {
        "content": "<blockquote>\n<p>I would heartily support that at the very least, test files should always be linked from their implementation files,</p>\n</blockquote>\n<p>I agree that if we have test files, we at least should have a 1:1 mapping where possible (which we could then document centrally). Very frequently the tests are lumped together into one big file, and so if I tweak one norm_num extension I have to rebuild all the others before I can test my change.</p>",
        "id": 505427847,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741874059
    },
    {
        "content": "<p>I also find that having the cache of the <code>MathlibTest</code> files would be useful.</p>",
        "id": 505430243,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741874594
    },
    {
        "content": "<p>Why would that be useful?</p>",
        "id": 505431680,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741874891
    },
    {
        "content": "<p>If the test fails there's no cache, and if it passes you don't need the cache</p>",
        "id": 505431771,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741874912
    },
    {
        "content": "<p>When a lot of them fail, I like to open them all at once to fix/understand the errors, so I would build them and extract that info from there.</p>",
        "id": 505431996,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741874959
    },
    {
        "content": "<p>There would be no cache even if the tests are just noisy, but not erroring?</p>",
        "id": 505432063,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741874975
    },
    {
        "content": "<p>Does that ever happen?</p>",
        "id": 505532883,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741902727
    },
    {
        "content": "<p>Also, even if you did have a cache, I don't think it is used for the file you are currently looking at.</p>",
        "id": 505532953,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741902758
    },
    {
        "content": "<p>No, but say that 10 test files are broken, then I would like to build all the test files and catch the errors from the commandline instead of copy-pasting the ones that are broken from the CI workflow.</p>",
        "id": 505533083,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741902826
    },
    {
        "content": "<p>As is, I either have to rebuild all of them, also the ones that are ok, or do some copy-pasting.</p>",
        "id": 505533201,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741902860
    },
    {
        "content": "<p>It is not the end of the world, but I would have found it convenient to have the cache for the tests, even if only for the non-broken ones.</p>",
        "id": 505533277,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741902900
    },
    {
        "content": "<p>In my situation, I would write a new linter and half of the test files do not comply, but they are not \"broken\", since the linter message may not be caught by a <code>#guard_msg</code>.</p>",
        "id": 505533469,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741902977
    }
]