[
    {
        "content": "<p>Anyone interested in sharpening his teeth on polynomials is encouraged to look here: <a href=\"https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19\" target=\"_blank\" title=\"https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19\">https://gist.github.com/jcommelin/77240367c2815ca0c45da188ba78be19</a></p>",
        "id": 130216141,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532443926
    },
    {
        "content": "<p>A bunch of stuff from the preamble will be obsolete as soon as Mario pushes his latest mathlib edits.</p>",
        "id": 130216160,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532443953
    },
    {
        "content": "<p>In the final lemma there are a bunch of <code>sorry</code>s. The proof is extremely slow, and I am continuously struggling with deterministic timeouts.</p>",
        "id": 130216186,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532443997
    },
    {
        "content": "<p>I have no idea why. It didn't feel to me like I was pushing limits.</p>",
        "id": 130216194,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532444011
    },
    {
        "content": "<p>So there is about 180 lines of preamble. And then about 50 lines of interesting stuff <span class=\"emoji emoji-1f609\" title=\"wink\">:wink:</span></p>",
        "id": 130216304,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532444102
    },
    {
        "content": "<p>(A bit of motivation for these crazy polynomials: They are useful for defining rings of Witt vectors, and those show up all over the place in number theory. For example, the ring of p-adic integers turns out to be the ring of Witt vectors of the finite field with p elements.)</p>",
        "id": 130216538,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532444326
    },
    {
        "content": "<blockquote>\n<p>In the final lemma there are a bunch of <code>sorry</code>s. The proof is extremely slow, and I am continuously struggling with deterministic timeouts.</p>\n</blockquote>\n<p>There is sometimes a reason for this (\"your code is crappy for a reason which you didn't realise\") but typically you have to get lucky with an expert looking at it and spotting what you did wrong. My valuation stuff got slow recently and I don't know why, but I didn't even bother posting 200 lines of Lean code and saying \"why does this take three seconds to compile and I had to put some type class thing up to 100 to make it work?\" because it's such a boring question; if I really cared I would try and minimise; currently I just grit my teeth and work around it.</p>",
        "id": 130220198,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1532448431
    },
    {
        "content": "<p>So how do you work around deterministic timeouts? What determines such a timeout? Can I set some option to let Lean work harder?</p>",
        "id": 130221163,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1532449581
    },
    {
        "content": "<p>Did you see the <code>1 &lt;= k &lt;= n</code> example? That one seemed to debate some discussion from the experts</p>",
        "id": 130221200,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1532449659
    },
    {
        "content": "<p>Here's a conjecture: these things are almost always caused by the type class inference system. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> what do you think about my conjecture?</p>",
        "id": 130221240,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1532449684
    },
    {
        "content": "<p>that's a bit of a general claim. Another way to make lean take a long time is to use lots of definitional equality or kernel computation, possibly on accident; and elaboration can often take a suspiciously long time to complete (not crazy but like 10-15 seconds for a term proof) for reasons I don't well understand</p>",
        "id": 130259324,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1532502799
    },
    {
        "content": "<p>There's a file in the perfectoid repo which takes 10 seconds to compile and I was half-thinking about trying to work out why so really I was looking for clues here.</p>",
        "id": 130263224,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1532508786
    },
    {
        "content": "<p>Anyone care to take a look at <a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L107</a> ? That file is self-contained, but depends on the latest mathlib.</p>",
        "id": 131034587,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533636466
    },
    {
        "content": "<p>I don't know what the type of anything is, but the lemma you're applying needs that the things you're applying it to are in a multiplicative group and the elements you're talking about look suspicious to me</p>",
        "id": 131036884,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533639625
    },
    {
        "content": "<p>A field is not a group under multiplication. Are you using the right lemma?</p>",
        "id": 131036897,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533639661
    },
    {
        "content": "<p>oh, good call</p>",
        "id": 131037022,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533639805
    },
    {
        "content": "<p>there are mirror versions of all the group lemmas for fields with namespace <code>division_ring</code> or <code>field</code></p>",
        "id": 131037035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533639833
    },
    {
        "content": "<p>This has happened to me so many times :-)</p>",
        "id": 131037136,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533639961
    },
    {
        "content": "<p>\"I can't find an instance of exactly what it says in the goal\" usually for me means \"the thing you want me to match with doesn't match because of something in square brackets\"</p>",
        "id": 131037218,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533640046
    },
    {
        "content": "<p>heh, I remember so many questions from you like that</p>",
        "id": 131037272,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533640089
    },
    {
        "content": "<p>I'm slowly making progress... <code>conv</code> is still confusing me.</p>",
        "id": 131038606,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533641793
    },
    {
        "content": "<p><code>conv in (λ _, _)</code> gives an error:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">invalid</span> <span class=\"n\">mk_pattern</span><span class=\"o\">,</span> <span class=\"bp\">#</span><span class=\"mi\">1</span> <span class=\"n\">expr</span> <span class=\"kn\">parameter</span> <span class=\"n\">does</span> <span class=\"n\">not</span> <span class=\"n\">occur</span> <span class=\"k\">in</span> <span class=\"n\">the</span> <span class=\"n\">target</span> <span class=\"n\">or</span> <span class=\"o\">(</span><span class=\"n\">other</span><span class=\"o\">)</span> <span class=\"n\">expr</span> <span class=\"kn\">parameter</span> <span class=\"n\">types</span>\n<span class=\"n\">state</span><span class=\"o\">:</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_1</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">m</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span> <span class=\"bp\">→</span> <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"n\">witt_polynomial</span> <span class=\"o\">(</span><span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">m</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">X</span> <span class=\"n\">m</span>\n<span class=\"err\">⊢</span> <span class=\"n\">witt_polynomial</span> <span class=\"n\">n</span> <span class=\"bp\">=</span>\n      <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"bp\">*</span> <span class=\"n\">X</span> <span class=\"n\">n</span> <span class=\"bp\">+</span>\n        <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span>\n          <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"n\">n</span><span class=\"o\">),</span>\n             <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"n\">witt_polynomial</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span> <span class=\"bp\">*</span>\n               <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"n\">witt_polynomial</span> <span class=\"o\">(</span><span class=\"n\">X_in_terms_of_W</span> <span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">-</span> <span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)))</span> <span class=\"bp\">=</span>\n    <span class=\"err\">?</span><span class=\"n\">m_1</span>\n</pre></div>",
        "id": 131038649,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533641876
    },
    {
        "content": "<p>But there is clearly a lambda in there...</p>",
        "id": 131038700,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533641899
    },
    {
        "content": "<p>Ok, I navigated to the lambda by hand.</p>",
        "id": 131039097,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533642412
    },
    {
        "content": "<p>Then I did some rewrites using ring homomorphisms, but Lean couldn't find an instance for them, nor for some rings.</p>",
        "id": 131039113,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533642439
    },
    {
        "content": "<p>Outside the <code>conv</code>, Lean found those instances without any trouble.</p>",
        "id": 131039123,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533642455
    },
    {
        "content": "<p>Is this a known issue?</p>",
        "id": 131039128,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533642460
    },
    {
        "content": "<p>I have this gut feeling that I've gone from never using <code>conv</code> (because I had no idea how it worked or what it did, before Patrick and I pushed the experts to explain it and then Patrick wrote <code>conv.md</code>) to over-using it. I tend to use it to do rewrites under a lambda -- but remember that <code>simp</code> does this too, so perhaps <code>simp only</code> will do what you're trying to do without having to use <code>conv</code>. One problem with <code>conv</code> is that if you're trying to find <code>f x = g x</code> in some <code>lam x, f x = g x</code> then <code>conv</code> won't match <code>f x</code> because it complains it doesn't know what <code>x</code> is. I don't know what your problem is but I look at pretty much every Lean function and it's some sort of lambda, so trying to match a lambda with so many holes sounds a bit scary to me, and trying to fill in the holes also looks hard for the reason I just mentioned above. Will <code>simp</code> not work for you?</p>",
        "id": 131041397,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533645298
    },
    {
        "content": "<p>\"I worked my way around it...\"</p>",
        "id": 131041784,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533645763
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I have the feeling that I can not extract sublemmas for this proof. Yet I'm constantly plagued with deterministic timeouts. <a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L108</a></p>",
        "id": 131042169,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533646230
    },
    {
        "content": "<p>I fought the mess (and the mess won)</p>",
        "id": 131042206,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533646281
    },
    {
        "content": "<p>I wanted to ask: why are you using a <code>finset.univ.sum</code> over <code>fin n</code> when the function to sum over does not depend on the assumption <code>x.2</code>?</p>",
        "id": 131042285,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533646379
    },
    {
        "content": "<p>It would be much easier to use <code>(finset.range n).sum (\\lam x, ...)</code></p>",
        "id": 131042296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533646403
    },
    {
        "content": "<p>Ok. The answer is: I've never used <code>finset.range</code> before, and didn't know about it.</p>",
        "id": 131042395,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533646527
    },
    {
        "content": "<p>deterministic time-outs usually mean that you've made a mistake in your code and Lean, instead of saying \"look an error\", is trying to coerce an int into a nat or something else that it can't do but is unfortunately bad at spotting that it can't do.</p>",
        "id": 131042772,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533646978
    },
    {
        "content": "<p>bad coercions, and trying to prove things which aren't refl by refl, are sometimes the cause</p>",
        "id": 131042792,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533647003
    },
    {
        "content": "<p>(even if they look refl)</p>",
        "id": 131042797,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533647009
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Ok, in the definition after the <code>witt_polynomial</code> I am using <code>i.2</code>.</p>",
        "id": 131042913,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533647156
    },
    {
        "content": "<p>So now I need some hackery to make that recursive definition work.</p>",
        "id": 131042956,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533647171
    },
    {
        "content": "<p>I see that... I'm working on the hackery</p>",
        "id": 131042975,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533647184
    },
    {
        "content": "<p>This should get you started:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">theorem</span> <span class=\"n\">range_sum_eq_fin_univ_sum</span> <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">add_comm_monoid</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">f</span> <span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">show</span> <span class=\"bp\">_</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">multiset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">α</span> <span class=\"bp\">_</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">map</span> <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">),</span>\n<span class=\"k\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">map_pmap</span><span class=\"o\">,</span> <span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">pmap_eq_map</span><span class=\"o\">]</span><span class=\"bp\">;</span> <span class=\"n\">refl</span>\n\n<span class=\"n\">def</span> <span class=\"n\">witt_polynomial</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">R</span> <span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">i</span> <span class=\"bp\">*</span> <span class=\"n\">X</span> <span class=\"n\">i</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">-</span><span class=\"n\">i</span><span class=\"o\">))))</span>\n\n<span class=\"n\">def</span> <span class=\"n\">X_in_terms_of_W</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"n\">n</span> <span class=\"bp\">-</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"n\">fin</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n  <span class=\"k\">have</span> <span class=\"bp\">_</span> <span class=\"o\">:=</span> <span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">-</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">))))))</span> <span class=\"bp\">*</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">X_in_terms_of_W_eq</span> <span class=\"o\">{</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">n</span> <span class=\"bp\">=</span>\n    <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"n\">n</span> <span class=\"bp\">-</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">i</span><span class=\"o\">,</span> <span class=\"n\">C</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">i</span> <span class=\"bp\">*</span> <span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">i</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">-</span> <span class=\"n\">i</span><span class=\"o\">)))</span> <span class=\"bp\">*</span>\n      <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"mi\">1</span> <span class=\"bp\">/</span> <span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">X_in_terms_of_W</span><span class=\"o\">,</span> <span class=\"n\">range_sum_eq_fin_univ_sum</span><span class=\"o\">]</span>\n</pre></div>",
        "id": 131043298,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533647528
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Hey look, a nontrivial equation lemma</p>",
        "id": 131043305,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533647548
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 131043423,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533647654
    },
    {
        "content": "<p>That's a really sweet example of equation lemma hackery!</p>",
        "id": 131043492,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533647733
    },
    {
        "content": "<p><code>finset.sum finset.univ (λ i : fin (n+1), (C p^i.val * (X i.val)^(p^(n-i.val))))</code></p>\n<p>Is this really still the best way to sum from 0 to n? It's the constant mentioning of <code>.val</code> which is a bit irritating. Is there some big operator or something which makes this better-looking?</p>",
        "id": 131046126,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533650520
    },
    {
        "content": "<p>No, the best way is <code>(range (n+1)).sum ...</code></p>",
        "id": 131046219,
        "sender_full_name": "Chris Hughes",
        "timestamp": 1533650608
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Mario suggested a better way. I'll push my current file.</p>",
        "id": 131046245,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533650641
    },
    {
        "content": "<p>Oh yes I see the post now. I ignored it initially because I'd not even begun to look at the file, but I have WiFi for the next 10 minutes so I downloaded the version on GH and am now looking through it.</p>",
        "id": 131046341,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533650706
    },
    {
        "content": "<p><a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L114</a></p>",
        "id": 131046344,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533650711
    },
    {
        "content": "<p>Ok, make sure you download again (-;</p>",
        "id": 131046356,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533650729
    },
    {
        "content": "<p>I've all sorts of rewrites that are failing, and it is beyond me why they fail...</p>",
        "id": 131046430,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533650768
    },
    {
        "content": "<p>I see! Range is nice to look at, but summing over <code>fin n</code> is cool because <code>i.2</code> is exactly what you need to make the equation compiler swallow it. Then you switch back to get the equation lemma you really want.</p>",
        "id": 131046616,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533650991
    },
    {
        "content": "<p>Yes. Pretty cool stuff, right? Kudos to Mario.</p>",
        "id": 131046705,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651054
    },
    {
        "content": "<p>I feel I've made progress today.</p>",
        "id": 131046716,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651066
    },
    {
        "content": "<p>But the proof is still extremely slow. And it is fragile beyond imagination.</p>",
        "id": 131046727,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651090
    },
    {
        "content": "<p>on line 135 or so you have two different <code>n</code>'s.</p>",
        "id": 131046820,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651177
    },
    {
        "content": "<p>that's from the first two lines. You can ignore the first <code>n</code> after the first line</p>",
        "id": 131046849,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533651221
    },
    {
        "content": "<p>Yes, I don't know why <code>strong_induction</code> introduces a new <code>n</code></p>",
        "id": 131046851,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651225
    },
    {
        "content": "<p>I'll clear the first one</p>",
        "id": 131046859,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651238
    },
    {
        "content": "<p>Inserting <code>repeat {sorry},end #exit</code> on line 124 and the proof still takes forever to compile (a second or two). I can't work with Lean when it's like this. Something you're doing is taking far longer than it should, and rather than biting the bullet nowadays I try to fix it.</p>",
        "id": 131047007,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651400
    },
    {
        "content": "<p>It's line 119</p>",
        "id": 131047028,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651439
    },
    {
        "content": "<p><code>  simp only [eval₂_mul, eval₂_add, eval₂_sub, eval₂_neg, eval₂_C, eval₂_X],</code></p>",
        "id": 131047040,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651453
    },
    {
        "content": "<p>How do you figure out which line it is?</p>",
        "id": 131047098,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651497
    },
    {
        "content": "<p><code>elaboration: tactic execution took 3.44s</code>.</p>",
        "id": 131047100,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651500
    },
    {
        "content": "<p>I just keep cutting and pasting <code>repeat {sorry}, end #exit</code> higher and higher up the file until I find it</p>",
        "id": 131047112,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651521
    },
    {
        "content": "<p>Nowadays when I write Lean code I notice it straight away and deal with the problem when it appears.</p>",
        "id": 131047125,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533651538
    },
    {
        "content": "<p>Ok... so somehow I need to speed up that line...</p>",
        "id": 131047143,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651573
    },
    {
        "content": "<p>In mathspeak it says that the <code>eval2</code> is a ring homomorphism, and that it therefore commutes with mul and add.</p>",
        "id": 131047196,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651609
    },
    {
        "content": "<p>And thus the ring hom can be moved \"inside\".</p>",
        "id": 131047210,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651632
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">eval₂_mul</span><span class=\"o\">,</span> <span class=\"n\">eval₂_C</span><span class=\"o\">],</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">eval₂_sub</span><span class=\"o\">],</span>\n  <span class=\"n\">rw</span> <span class=\"n\">eval₂_X</span><span class=\"o\">,</span>\n</pre></div>",
        "id": 131047369,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651823
    },
    {
        "content": "<p>Somehow <code>simp only</code> succeeds, while <code>rw</code> doesn't...</p>",
        "id": 131047376,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533651838
    },
    {
        "content": "<p>Ok, it is still really ugly... but progress: <a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L115</a></p>",
        "id": 131050069,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533654669
    },
    {
        "content": "<p>Now I need <code>i.property</code> but I no longer have access to it <span class=\"emoji emoji-2639\" title=\"sad\">:sad:</span></p>",
        "id": 131050137,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533654736
    },
    {
        "content": "<p>And the proof is still relatively slow.</p>",
        "id": 131050148,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533654749
    },
    {
        "content": "<p>Anyway, I need to go home now. See you later!</p>",
        "id": 131050156,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533654758
    },
    {
        "content": "<p>After lots of testing, I think I know the problem: <code>eval₂_*</code> is a bad simp lemma, not because it is written incorrectly, but because it is too expensive to instantiate. It takes a second or so to figure out if one of these rules even applies, and simp has to go through tons of them at all parts of the expression</p>",
        "id": 131050849,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533655447
    },
    {
        "content": "<p>I've just been dropping these <code>sorry,end #exit</code> lines in near the beginning and even the rewrites are taking time. <code>simp only [eval₂_sub]</code> seems to take about 200ms but <code>rw @eval₂_sub _ _ _ _ _ _ (X n) (finset.sum (finset.range n) (λ (i : ℕ), C ↑p ^ i * X_in_terms_of_W i ^ p ^ (n - i))) _ _ C _ witt_polynomial</code> also takes about 200ms</p>",
        "id": 131051808,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533656354
    },
    {
        "content": "<p>and then <code>rw eval₂_X</code> takes about 600ms</p>",
        "id": 131051831,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533656390
    },
    {
        "content": "<p>For me the <code>eval2_sub</code> proof works provided I have the <code>foobar</code> instance:</p>\n<div class=\"codehilite\"><pre><span></span>instance foobar : comm_ring (mv_polynomial ℕ ℚ) := by apply_instance\n</pre></div>",
        "id": 131053242,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533657682
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"kn\">definition</span> <span class=\"n\">inst_1</span> <span class=\"o\">:</span> <span class=\"n\">decidable_eq</span> <span class=\"bp\">ℕ</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_2</span> <span class=\"o\">:</span> <span class=\"n\">decidable_eq</span> <span class=\"n\">ℚ</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"n\">ℚ</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_4</span> <span class=\"o\">:</span> <span class=\"n\">decidable_eq</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_5</span> <span class=\"o\">:</span> <span class=\"n\">comm_ring</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_6</span> <span class=\"o\">:</span> <span class=\"n\">is_ring_hom</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"o\">:</span> <span class=\"n\">ℚ</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">X_in_terms_of_W_prop</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"n\">witt_polynomial</span> <span class=\"bp\">=</span> <span class=\"n\">X</span> <span class=\"n\">n</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">apply</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">strong_induction_on</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n  <span class=\"n\">clear</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n  <span class=\"n\">intros</span> <span class=\"n\">n</span> <span class=\"n\">H</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">X_in_terms_of_W_eq</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">eval₂_mul</span><span class=\"o\">,</span> <span class=\"n\">eval₂_C</span><span class=\"o\">],</span>\n  <span class=\"n\">rw</span> <span class=\"bp\">@</span><span class=\"n\">eval₂_sub</span> <span class=\"n\">ℚ</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">)</span> <span class=\"bp\">ℕ</span> <span class=\"n\">inst_1</span> <span class=\"n\">inst_2</span> <span class=\"n\">inst_3</span>\n    <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n    <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">i</span> <span class=\"bp\">*</span> <span class=\"n\">X_in_terms_of_W</span> <span class=\"n\">i</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">-</span> <span class=\"n\">i</span><span class=\"o\">)))</span>\n    <span class=\"n\">inst_4</span> <span class=\"n\">inst_5</span> <span class=\"n\">C</span> <span class=\"n\">inst_6</span> <span class=\"n\">witt_polynomial</span><span class=\"o\">,</span>\n  <span class=\"n\">sorry</span><span class=\"o\">,</span><span class=\"kn\">end</span> <span class=\"bp\">#</span><span class=\"kn\">exit</span>\n</pre></div>\n\n\n<p>That last rw is taking 150ms. Is that a long time for a rewrite?</p>",
        "id": 131054040,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533658532
    },
    {
        "content": "<p>I filled in every field.</p>",
        "id": 131054089,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533658566
    },
    {
        "content": "<p>and <code>rw @eval₂_X ℚ (mv_polynomial ℕ ℚ) ℕ inst_1 inst_2 inst_3' inst_4' C inst_5' witt_polynomial n</code> (the line after) is taking over 300ms.</p>",
        "id": 131054347,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533659016
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"kn\">definition</span> <span class=\"n\">inst_3&#39;</span> <span class=\"o\">:</span> <span class=\"n\">comm_semiring</span> <span class=\"n\">ℚ</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_4&#39;</span> <span class=\"o\">:</span> <span class=\"n\">comm_semiring</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n<span class=\"kn\">definition</span> <span class=\"n\">inst_5&#39;</span> <span class=\"o\">:</span> <span class=\"n\">is_semiring_hom</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"o\">:</span> <span class=\"n\">ℚ</span> <span class=\"bp\">→</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">apply_instance</span>\n</pre></div>\n\n\n<p>I thought that <code>rw</code> looked at the head of the expression, and it's not hard to find <code>eval_2</code>, there's only two possibilities, and one of them fits perfectly. I don't understand why these rewrites are taking so long.</p>",
        "id": 131054427,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533659147
    },
    {
        "content": "<p>That's exactly what I was thinking.</p>",
        "id": 131054652,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533659431
    },
    {
        "content": "<p>By the way, in the expression <code>(X_in_terms_of_W n).eval₂ C witt_polynomial = X n</code> are you aware that the <code>R</code> variable of <code>witt_polynomial</code> is instantiated as <code>Q</code>?</p>",
        "id": 131054696,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533659515
    },
    {
        "content": "<p>if you try to assert that it has type <code>mv_polynomial ℕ R</code> it doesn't typecheck</p>",
        "id": 131054768,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533659584
    },
    {
        "content": "<p>Oh wow, this has a 1000% improvement in speed:</p>\n<div class=\"codehilite\"><pre><span></span>generalize e : eval₂ C witt_polynomial = f,\nhaveI : is_ring_hom f := by subst f; apply eval₂.is_ring_hom,\n</pre></div>\n\n\n<p>Most of the proof only uses that <code>f</code> is a ring hom. For the rest, you can use the equality to recover the eval</p>",
        "id": 131055665,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533660881
    },
    {
        "content": "<p>Mario, yes, I was aware of that. In the end, we want some identity over <code>\\Z</code>. I only wrote the general definition of <code>witt_polynomial</code> so that I didn't constantly have to <code>map</code> them to other rings.</p>",
        "id": 131056663,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533662010
    },
    {
        "content": "<p>Ok, so I put that bit of code somewhere in the beginning of my proof? And then I get massive speedups, and afterwards it is recovered/unfolded towards the end?</p>",
        "id": 131056734,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533662083
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Does your suggestion classify as best practice or is it a fragile hack? Is this a sign that we need to improve <code>eval2</code>, or is there nothing to worry about?</p>",
        "id": 131058032,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533663407
    },
    {
        "content": "<p>It is a hack, although not that fragile, it's just a weird workaround for inexplicable slowdown</p>",
        "id": 131082758,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533695548
    },
    {
        "content": "<p>I found another weird way to speed things up:</p>\n<div class=\"codehilite\"><pre><span></span>set_option profiler true\n\ninstance eval_witt_hom : is_ring_hom (eval₂ C (witt_polynomial R)) :=\n@mv_polynomial.eval₂.is_ring_hom _ _ _ _ _ _ _ _ _\n  (@C.is_ring_hom R ℕ _ (λ a b, _inst_2 a b) _) _\n\nlemma X_in_terms_of_W_prop (n : ℕ) : (X_in_terms_of_W n).eval₂ C (witt_polynomial ℚ) = X n :=\nbegin\n  apply nat.strong_induction_on n,\n  intros n H,\n  rw [X_in_terms_of_W_eq],\n  simp,\nend\n</pre></div>\n\n\n<p>the <code>simp</code> application runs fine as long as you have that instance. The elaboration of <code>eval_witt_hom</code> takes about 500 ms written like this, but if I write <code>_inst_2</code> instead of eta expanded, elaboration jumps to 8.3 s. If I use <code>by apply_instance</code> it takes about 1 s</p>",
        "id": 131082897,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533695773
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> This stuff is closer to your area of expertise than mine, although I am not sure how easy it is to separate mathlib from this issue</p>",
        "id": 131082996,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533695984
    },
    {
        "content": "<p>Okay, here's a complete proof with no unreasonable slowdowns:</p>\n<div class=\"codehilite\"><pre><span></span>instance eval_witt_hom : is_ring_hom (eval₂ C (witt_polynomial R)) :=\n@mv_polynomial.eval₂.is_ring_hom _ _ _ _ _ _ _ _ _\n  (@C.is_ring_hom R ℕ _ (λ a b, _inst_2 a b) _) _\n\nlemma X_in_terms_of_W_prop&#39;\n  (f : mv_polynomial ℕ ℚ → mv_polynomial ℕ ℚ) [is_ring_hom f]\n  (fC : ∀ (a : ℚ), f (C a) = C a)\n  (fX : ∀ (n : ℕ), f (X n) = witt_polynomial ℚ n)\n  (n : ℕ) : f (X_in_terms_of_W n) = X n :=\nbegin\n  apply nat.strong_induction_on n,\n  clear n, intros n H,\n  rw [X_in_terms_of_W_eq],\n  simp only [is_ring_hom.map_mul f, is_ring_hom.map_sub f, fC, fX, ring_hom_sum.finset f],\n  rw [finset.sum_congr rfl, (_ : witt_polynomial ℚ n -\n    (finset.range n).sum (λ i, C p ^ i * X i ^ p ^ (n - i)) = C (p ^ n) * X n)],\n  { rw [mul_right_comm, ← C_mul, mul_one_div_cancel, C_1, one_mul],\n    exact pow_ne_zero _ (nat.cast_ne_zero.2 $ ne_of_gt pp.pos) },\n  { simp [witt_polynomial, nat.sub_self],\n    rw ring_hom_powers (@C ℚ ℕ _ _ _) },\n  { intros i h,\n    simp [is_ring_hom.map_mul f, ring_hom_powers f, fC] at h ⊢,\n    rw H _ h }\nend\n\nlemma X_in_terms_of_W_prop (n : ℕ) : (X_in_terms_of_W n).eval₂ C (witt_polynomial ℚ) = X n :=\nbegin\n  letI : is_ring_hom (@C ℚ ℕ _ _ _) := by apply_instance,\n  haveI H := @eval_witt_hom _ ℚ _ _,\n  have fC := eval₂_C C (witt_polynomial ℚ),\n  have fX := eval₂_X C (witt_polynomial ℚ),\n  revert H fC fX, generalize : eval₂ C (witt_polynomial ℚ) = f,\n  introsI, exact X_in_terms_of_W_prop&#39; f fC fX n\nend\n</pre></div>",
        "id": 131087058,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533702164
    },
    {
        "content": "<p>Wow! Thanks for your help Mario! I wouldn't have been able to come up with this myself.</p>",
        "id": 131088141,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533704406
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Is it ok that your proof explicitly mentions <code>_inst_2</code>? I always assumed that was \"forbidden\".</p>",
        "id": 131088204,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533704634
    },
    {
        "content": "<p>You should see if <code>λ a b, by apply_instance</code> also works without slowdown. If not, you can just name the instance and refer to it</p>",
        "id": 131088256,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533704741
    },
    {
        "content": "<p>Ok, I'll merge this into my file as soon as I'm back at work.</p>",
        "id": 131088298,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533704765
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> You also changed the definition of <code>witt_polynomial</code> to make the ring <code>R</code> explicit, didn't you?</p>",
        "id": 131091024,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533709923
    },
    {
        "content": "<p>I did, it was making things a bit confusing. You don't have to</p>",
        "id": 131091040,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533709969
    },
    {
        "content": "<p>Is there a way to tease more information out of Lean when it gives the error <code>command expected</code>?</p>",
        "id": 131092231,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533712226
    },
    {
        "content": "<p>that means that the parser was reset, you are between definitions or something, and you give a non-keyword</p>",
        "id": 131092296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533712386
    },
    {
        "content": "<p>Or it means you have <code>checking visible lines</code> mode enabled and you should scroll down to refresh the parser</p>",
        "id": 131092301,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1533712420
    },
    {
        "content": "<p>I see... a very descriptive error message <span class=\"emoji emoji-1f923\" title=\"rolling on the floor laughing\">:rolling_on_the_floor_laughing:</span></p>",
        "id": 131092457,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533712756
    },
    {
        "content": "<blockquote>\n<p>Or it means you have <code>checking visible lines</code> mode enabled and you should scroll down to refresh the parser</p>\n</blockquote>\n<p>Johan -- we're talking about the little message in the blue bar at the bottom of the VS Code window which says something like \"checking visible lines and above\". I constantly refer to this as \"evil mode\" and it used to be the case that whenever I see a student whose blue bar said this, I would tell them to click on the blue bar and change it to \"checking visible files\". There is a place for the \"visible lines and above\" choice, but for my users it causes more trouble than it solves, because it means that sometimes the answer to \"there's a red line -- what is wrong with my code?\" is \"nothing is wrong with your code, it's just that Lean isn't reading all of it\". Nowadays I just show my students how to make it say \"checking visible files\" by selecting File-&gt;Preferences-&gt;Settings (ctrl-, on linux), then searching for <code>linesandabove</code> in the default user settings, hovering over <code>\"lean.roiModeDefault\": \"linesAndAbove\"</code> (if it says that -- you want it to say <code>visible</code>, clicking the little pencil just to the left of it [thus moving the variable into the part of the settings which you can edit], and then making sure it says <code>\"lean.roiModeDefault\": \"visible\"</code> in user settings.</p>",
        "id": 131095998,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533718825
    },
    {
        "content": "<blockquote>\n<p>Nowadays I just show my students how to make it say \"checking visible files\"</p>\n</blockquote>\n<p>BTW, this is the default now.</p>",
        "id": 131096086,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1533719016
    },
    {
        "content": "<p>Thanks for switching it back Gabriel. It's fine if you know what you're doing, but experience indicated that it was confusing for new users. I love the way that you just sit there in the background occasionally making things better for me.</p>",
        "id": 131096702,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533719979
    },
    {
        "content": "<p>Thanks for the explanation Kevin!</p>",
        "id": 131097020,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533720354
    },
    {
        "content": "<p>Aaaaahrg. I'm completely stuck again!</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">lemma</span> <span class=\"n\">quux</span> <span class=\"o\">{</span><span class=\"n\">A</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">add_comm_group</span> <span class=\"n\">A</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">A</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">f</span> <span class=\"bp\">=</span> <span class=\"n\">f</span> <span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"o\">(</span><span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">range</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span> <span class=\"n\">f</span> <span class=\"o\">:=</span> <span class=\"k\">by</span> <span class=\"n\">simp</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">X_in_terms_of_W_prop₂</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"kn\">eval</span> <span class=\"n\">X_in_terms_of_W</span> <span class=\"bp\">=</span> <span class=\"n\">X</span> <span class=\"n\">k</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">apply</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">strong_induction_on</span> <span class=\"n\">k</span><span class=\"o\">,</span>\n  <span class=\"n\">clear</span> <span class=\"n\">k</span><span class=\"o\">,</span> <span class=\"n\">intros</span> <span class=\"n\">k</span> <span class=\"n\">H</span><span class=\"o\">,</span>\n  <span class=\"n\">dsimp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">witt_polynomial</span><span class=\"o\">],</span>\n  <span class=\"n\">conv</span>\n  <span class=\"k\">begin</span>\n    <span class=\"n\">to_lhs</span><span class=\"o\">,</span>\n    <span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">skip</span><span class=\"o\">,</span>\n    <span class=\"n\">rw</span> <span class=\"n\">quux</span> <span class=\"n\">k</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">i</span> <span class=\"bp\">*</span> <span class=\"n\">X</span> <span class=\"n\">i</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"bp\">-</span> <span class=\"n\">i</span><span class=\"o\">)),</span>\n  <span class=\"kn\">end</span><span class=\"o\">,</span>\n  <span class=\"c1\">-- generalize e : eval X_in_terms_of_W = f,</span>\n  <span class=\"c1\">-- haveI : is_ring_hom f := by subst f; apply eval.is_ring_hom,</span>\n  <span class=\"c1\">-- simp only [ring_hom_sum.finset f],</span>\n  <span class=\"c1\">-- repeat {sorry}, end #exit</span>\n  <span class=\"n\">sorry</span>\n<span class=\"kn\">end</span>\n</pre></div>",
        "id": 131101387,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533726850
    },
    {
        "content": "<p>Yesterday's trick isn't working.</p>",
        "id": 131101390,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533726863
    },
    {
        "content": "<p><del>After this sorry is removed, I think we are mostly good to go for the definition of witt vectors.</del> Meh... I forgot that I still need to convince Lean that I actually get a polynomial over <code>\\Z</code> instead of <code>\\Q</code>.</p>",
        "id": 131101554,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533727106
    },
    {
        "content": "<p>But maybe we first need to figure out why Lean is misbehaving like a toddler...</p>",
        "id": 131101563,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533727140
    },
    {
        "content": "<p>I pushed the stuff that I have right now: <a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L135</a></p>",
        "id": 131101710,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533727351
    },
    {
        "content": "<p>Ok, so I have polynomials over <code>\\Q</code>, but actually all their coefficients lie in <code>\\Z</code>. What is the best way to extract this polynomial over <code>\\Z</code>? I currently have the following:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">def</span> <span class=\"n\">witt_structure_int</span> <span class=\"o\">(</span><span class=\"err\">Φ</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">bool</span> <span class=\"bp\">ℤ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"o\">(</span><span class=\"n\">bool</span> <span class=\"bp\">×</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"bp\">ℤ</span> <span class=\"o\">:=</span>\n<span class=\"n\">finsupp</span><span class=\"bp\">.</span><span class=\"n\">map_range</span> <span class=\"n\">rat</span><span class=\"bp\">.</span><span class=\"n\">num</span> <span class=\"o\">(</span><span class=\"n\">rat</span><span class=\"bp\">.</span><span class=\"n\">coe_int_num</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_rat</span> <span class=\"o\">(</span><span class=\"n\">map</span> <span class=\"n\">int</span><span class=\"bp\">.</span><span class=\"n\">cast</span> <span class=\"err\">Φ</span><span class=\"o\">)</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n</pre></div>",
        "id": 131102445,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533728419
    },
    {
        "content": "<p>Your rewrite on line 144 is, for me, trying to rewrite when the goal is <code>| X_in_terms_of_W</code>. But if I add another <code>skip</code> then I see Lean trying to do this:</p>\n<div class=\"codehilite\"><pre><span></span>_inst_1 : nat.Prime,\nk : ℕ,\nH : ∀ (m : ℕ), m &lt; k → eval₂ C X_in_terms_of_W (witt_polynomial m) = X m\n| finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i))\nscratch6.lean:145:4: error\n\nrewrite tactic failed, did not find instance of the pattern in the target expression\n  finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i))\nstate:\n10 goals\n_inst_1 : nat.Prime,\nk : ℕ,\nH : ∀ (m : ℕ), m &lt; k → eval₂ C X_in_terms_of_W (witt_polynomial m) = X m\n⊢ finset.sum (finset.range (k + 1)) (λ (i : ℕ), C ↑p ^ i * X i ^ p ^ (k - i)) = ?m_1\n</pre></div>\n\n\n<p>But when you <code>set_option pp.all true</code> I see a whole bunch of typeclass inference stuff which doesn't look like it matches up. The thing you're trying to rewrite has a whole bunch of unsolved metavariables. Your goal looks like this: </p>\n<div class=\"codehilite\"><pre><span></span> (@finset.sum.{0 0} nat\n       (@mv_polynomial.{0 0} nat rat\n...\n</pre></div>\n\n\n<p>and the thing you're trying to rewrite looks like this:</p>\n<div class=\"codehilite\"><pre><span></span>  @finset.sum.{0 ?l_1} nat (@mv_polynomial.{0 ?l_1} nat ?m_2 ?m_3) ...\n</pre></div>\n\n\n<p>Maybe if you are more precise with your rewrite it might help, i.e. throw in some <code>@</code>s and say exactly what the type of some more things are. I am kind of wondering whether the type class inference system doesn't know enough about what your types are, and is making some bad guesses about what instances it should use.</p>",
        "id": 131103604,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533729735
    },
    {
        "content": "<p><a href=\"https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9\" target=\"_blank\" title=\"https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9\">https://gist.github.com/kbuzzard/5254103e5f33b022636a9491fb6719e9</a></p>\n<p>That's the beginning of the <code>set_option pp.all true</code> output. The <code>quux</code> thing is the thing at the top. The goal is the much longer thing at the bottom, most of which I've truncated. The much longer thing at the bottom corresponds to just the first three lines of the top. Lines 3 and 50 match perfectly. Lines 1 and 2 are supposed to match with lines 16 to 49. We have a universe metavariable <code>?l_1</code> which can be zero, then a term metavariable <code>?m_2</code> which can be <code>rat</code>. What I'm worried about is line 2, which says that type class inference wants to prove something is an add_comm_monoid, and it's going to do this by showing it's an add_comm_group and then it will use an instance called <code>add_comm_group.to_add_comm_monoid</code>. But lines 25 to 42 seem to be showing that the rationals are an add_comm_monoid by showing that they're a field, and then a comm_ring, and then a comm_semiring (note that we have now diverged from the plan, because a comm_semiring isn't an add_comm_group) and then an add_comm_monoid.</p>\n<p>Now this might not be the problem, but somehow it looks to me like it <em>might</em> be an obstruction to the rewrite succeeding. Can you somehow tell Lean that you're not working with <code>?m_2</code> but with <code>rat</code>?</p>",
        "id": 131105049,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533731393
    },
    {
        "content": "<p>Like so?</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">rw</span> <span class=\"n\">quux</span> <span class=\"n\">k</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"o\">((</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"n\">i</span> <span class=\"bp\">*</span> <span class=\"n\">X</span> <span class=\"n\">i</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"bp\">-</span> <span class=\"n\">i</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"bp\">ℕ</span> <span class=\"n\">ℚ</span><span class=\"o\">)),</span>\n</pre></div>\n\n\n<p>Alas, that still fails.</p>",
        "id": 131105249,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533731579
    },
    {
        "content": "<p>Hmm, now the output of <code>pp.all</code> shows an insane amount of similarities between the goal and what the rewrite offers.</p>",
        "id": 131105757,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533732104
    },
    {
        "content": "<p>But it is not enough. The <code>rw</code> is using modules <span class=\"emoji emoji-1f631\" title=\"scream\">:scream:</span> whereas the goal is sane, and just works with rings.</p>",
        "id": 131105807,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533732134
    },
    {
        "content": "<p>What you're trying to rewrite: <a href=\"https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503\" target=\"_blank\" title=\"https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503\">https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503</a></p>\n<p>Goal: <a href=\"https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3\" target=\"_blank\" title=\"https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3\">https://gist.github.com/kbuzzard/f515877383946b5eb84f03e31cb988c3</a></p>\n<p>They're not the same. The question perhaps is which differences are superficial and which ones are stopping the rewrite</p>",
        "id": 131105895,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533732246
    },
    {
        "content": "<p>I'm scared by <a href=\"https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21\" target=\"_blank\" title=\"https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21\">https://gist.github.com/kbuzzard/8b4048c89309808fe829c5e59caaa503#file-pattern-lean-L21</a></p>",
        "id": 131106029,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533732385
    },
    {
        "content": "<p>Sorry!!! I messed up. I did not have enough <code>skip</code>s in the <code>conv</code>. <span class=\"emoji emoji-1f62d\" title=\"sob\">:sob:</span></p>",
        "id": 131106164,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533732559
    },
    {
        "content": "<p>Didn't I mention that? ;-)</p>",
        "id": 131106990,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1533733397
    },
    {
        "content": "<p>Hmmm, it seems to me that whenever I make any progress using <code>simp</code> or <code>dsimp</code>, afterwards everything breaks, because it cleans up to much.</p>",
        "id": 131108053,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533734499
    },
    {
        "content": "<p>So I find my self doing long chains of <code>rw</code>s</p>",
        "id": 131108058,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533734509
    },
    {
        "content": "<p>And now I have <code>(\\lam i, f i) i</code>. And I need <code>f i</code>. How do I do that without <code>dsimp</code>?</p>",
        "id": 131108116,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533734539
    },
    {
        "content": "<p>Ok, so I think this is called beta-reduction. Is there a tactic that will do beta-reduction, and nothing else?</p>",
        "id": 131108302,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533734751
    },
    {
        "content": "<p>Ok! \"I worked my way around it.\"</p>",
        "id": 131108886,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533735286
    },
    {
        "content": "<p>All sorries are gone in this part! <span class=\"emoji emoji-1f419\" title=\"octopus\">:octopus:</span></p>",
        "id": 131108907,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533735325
    },
    {
        "content": "<p>Now I need to figure out how to get some polynomials that are defined over Q to believe that they actually live over Z.</p>",
        "id": 131108917,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533735349
    },
    {
        "content": "<p><a href=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218\" target=\"_blank\" title=\"https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218\">https://github.com/jcommelin/mathlib/blob/witt/algebra/witt_vector.lean#L218</a></p>",
        "id": 131108918,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1533735352
    },
    {
        "content": "<p>You can have a look at <a href=\"https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71\" target=\"_blank\" title=\"https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71\">https://github.com/leanprover/lean/blob/28f4143be31b7aa3c63a907be5443ca100025ef1/library/init/meta/simp_tactic.lean#L71</a></p>",
        "id": 131109022,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1533735461
    },
    {
        "content": "<p>turning off everything but beta</p>",
        "id": 131109042,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1533735473
    },
    {
        "content": "<p>I think you only need to specify that beta is turned on</p>",
        "id": 131109241,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1533735608
    },
    {
        "content": "<p>but I'm not sure</p>",
        "id": 131109276,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1533735667
    },
    {
        "content": "<p>I think we could have a tactic doing only this and unfolding composition (ie <code>rw comp_app</code>)</p>",
        "id": 131109373,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1533735765
    },
    {
        "content": "<p>After almost a year I took another look at this code. I've almost proven the fundamental theorem about witt polynomials: <a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean</a></p>",
        "id": 168051078,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436769
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"kn\">theorem</span> <span class=\"n\">witt_structure_int_exists_unique</span> <span class=\"o\">(</span><span class=\"err\">Φ</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">bool</span> <span class=\"bp\">ℤ</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"bp\">∃!</span> <span class=\"o\">(</span><span class=\"n\">φ</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"o\">(</span><span class=\"n\">bool</span> <span class=\"bp\">×</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"bp\">ℤ</span><span class=\"o\">),</span>\n  <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"n\">φ</span> <span class=\"bp\">=</span>\n<span class=\"err\">Φ</span><span class=\"bp\">.</span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">bool</span><span class=\"o\">,</span> <span class=\"o\">((</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">rename</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">i</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"n\">i</span><span class=\"o\">))))</span> <span class=\"o\">:=</span>\n</pre></div>",
        "id": 168051161,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436804
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1199</a></p>",
        "id": 168051182,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436815
    },
    {
        "content": "<p><a href=\"https://arxiv.org/abs/1906.03583\" target=\"_blank\" title=\"https://arxiv.org/abs/1906.03583\">https://arxiv.org/abs/1906.03583</a></p>\n<p>If you want a goal which looks accessible ;-)</p>",
        "id": 168051204,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560436842
    },
    {
        "content": "<p>The only sorry on which that proof depends is on <a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L921</a> and it says:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">ι</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u_1</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_6</span> <span class=\"o\">:</span> <span class=\"n\">decidable_eq</span> <span class=\"n\">ι</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℤ</span>\n<span class=\"err\">⊢</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"n\">n</span> <span class=\"n\">modₑ</span> <span class=\"err\">↑</span><span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"o\">(</span><span class=\"n\">C</span> <span class=\"n\">n</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"n\">modₑ</span> <span class=\"err\">↑</span><span class=\"n\">p</span><span class=\"o\">)</span>\n</pre></div>",
        "id": 168051264,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436886
    },
    {
        "content": "<p>In other words, I need little Fermat for integers that are viewed as constant polynomials in an arbitrary multi-variate polynomial ring over the integers.</p>",
        "id": 168051353,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436925
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> I think it makes more sense to first show that Witt vectors form a ring (-;</p>",
        "id": 168051408,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436963
    },
    {
        "content": "<p>(And to clean up the file.)</p>",
        "id": 168051423,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560436978
    },
    {
        "content": "<p>There are some extremely crazy things going on, where type class search completely messes up.</p>",
        "id": 168051468,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560437006
    },
    {
        "content": "<p>And what is annoying is that you can't even easily switch it off using <code>@</code>s. I wish I could tell Lean:<br>\n\"Hey, I want to apply this lemma. Try to do that without caring about the type class instances. Just give them to me as goals.\"<br>\nBut I'm not sure if it is easy to say that to Lean.</p>",
        "id": 168051570,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560437072
    },
    {
        "content": "<p>If you want Lean to say that then does this mean that some things are classes which shouldn't be classes?</p>",
        "id": 168053571,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560438265
    },
    {
        "content": "<p>Things like <code>add_comm_monoid</code> <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span></p>",
        "id": 168054494,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560438892
    },
    {
        "content": "<p>It can't figure out that quotient rings are <code>add_comm_monoid</code>, or that <code>quotient.mk</code> is a semiring hom, etc.. etc...</p>",
        "id": 168054563,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560438932
    },
    {
        "content": "<p>Probably these issues go away with proper proof engineering... But I'm not a proof engineer.</p>",
        "id": 168054588,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560438956
    },
    {
        "content": "<p>I use <code>by apply</code> when I get the pesky issue with inferred != unified</p>",
        "id": 168056875,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560440417
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> With underscores? As in, do you then manually have to fill in the typeclasses? Or does it usually figure out all the type classes itself?</p>",
        "id": 168067220,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560447500
    },
    {
        "content": "<p>no underscores</p>",
        "id": 168072838,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560450957
    },
    {
        "content": "<p>just <code>by apply foo</code> instead of <code>foo _ _</code> or <code>@foo _ _ _ _</code> or whatever</p>",
        "id": 168072910,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560450981
    },
    {
        "content": "<p>I'll test this</p>",
        "id": 168073697,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451494
    },
    {
        "content": "<p>In the course of this file, I prove:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">variables</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"kn\">variables</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">dvd_sub_pow_of_dvd_sub</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"err\">∣</span> <span class=\"n\">a</span> <span class=\"bp\">-</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n<span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"err\">∣</span> <span class=\"n\">a</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">k</span><span class=\"o\">)</span> <span class=\"bp\">-</span> <span class=\"n\">b</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">k</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n</pre></div>\n\n\n<p><a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L261</a></p>",
        "id": 168073959,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451680
    },
    {
        "content": "<p>This proof is currently quite long and slow.</p>",
        "id": 168074014,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451690
    },
    {
        "content": "<p>But it is completely elementary maths...</p>",
        "id": 168074029,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451703
    },
    {
        "content": "<p>Here is what I currently have:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">local</span> <span class=\"n\">attribute</span> <span class=\"o\">[</span><span class=\"n\">class</span><span class=\"o\">]</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span>\n<span class=\"kn\">variables</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">decidable_eq</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"kn\">variables</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">dvd_sub_pow_of_dvd_sub</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"err\">∣</span> <span class=\"n\">a</span> <span class=\"bp\">-</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">:</span>\n  <span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"err\">∣</span> <span class=\"n\">a</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">k</span><span class=\"o\">)</span> <span class=\"bp\">-</span> <span class=\"n\">b</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"n\">k</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"k\">begin</span>\n  <span class=\"n\">induction</span> <span class=\"n\">k</span> <span class=\"k\">with</span> <span class=\"n\">k</span> <span class=\"n\">ih</span><span class=\"o\">,</span> <span class=\"o\">{</span> <span class=\"n\">simpa</span> <span class=\"kn\">using</span> <span class=\"n\">h</span> <span class=\"o\">},</span> <span class=\"n\">clear</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">succ_eq_add_one</span><span class=\"o\">],</span>\n  <span class=\"n\">rcases</span> <span class=\"n\">ih</span> <span class=\"k\">with</span> <span class=\"bp\">⟨</span><span class=\"n\">c</span><span class=\"o\">,</span> <span class=\"n\">hc</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">sub_eq_iff_eq_add&#39;</span> <span class=\"n\">at</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">replace</span> <span class=\"n\">hc</span> <span class=\"o\">:=</span> <span class=\"n\">congr_arg</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"n\">x</span><span class=\"o\">,</span> <span class=\"n\">x</span><span class=\"err\">^</span><span class=\"n\">p</span><span class=\"o\">)</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">dsimp</span> <span class=\"n\">only</span> <span class=\"n\">at</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"err\">←</span> <span class=\"n\">pow_mul</span><span class=\"o\">,</span> <span class=\"n\">add_pow</span><span class=\"o\">,</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">sum_range_succ</span><span class=\"o\">,</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">choose_self</span><span class=\"o\">,</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">cast_one</span><span class=\"o\">,</span> <span class=\"n\">mul_one</span><span class=\"o\">,</span>\n    <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">sub_self</span><span class=\"o\">,</span> <span class=\"n\">pow_zero</span><span class=\"o\">,</span> <span class=\"n\">mul_one</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">conv</span> <span class=\"o\">{</span> <span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">skip</span><span class=\"o\">,</span> <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_succ</span><span class=\"o\">]</span> <span class=\"o\">},</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_eq_pow</span><span class=\"o\">]</span> <span class=\"n\">at</span> <span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"o\">[</span><span class=\"n\">hc</span><span class=\"o\">,</span> <span class=\"n\">pow_mul</span><span class=\"o\">,</span> <span class=\"n\">add_sub_cancel&#39;</span><span class=\"o\">],</span> <span class=\"n\">clear</span> <span class=\"n\">hc</span> <span class=\"n\">a</span><span class=\"o\">,</span>\n  <span class=\"n\">apply</span> <span class=\"n\">dvd_sum</span><span class=\"o\">,</span>\n  <span class=\"n\">intros</span> <span class=\"n\">i</span> <span class=\"n\">hi</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">finset</span><span class=\"bp\">.</span><span class=\"n\">mem_range</span> <span class=\"n\">at</span> <span class=\"n\">hi</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">mul_pow</span><span class=\"o\">,</span>\n  <span class=\"n\">conv</span> <span class=\"o\">{</span> <span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">skip</span><span class=\"o\">,</span> <span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">skip</span><span class=\"o\">,</span> <span class=\"n\">rw</span> <span class=\"n\">mul_comm</span> <span class=\"o\">},</span>\n  <span class=\"n\">repeat</span> <span class=\"o\">{</span> <span class=\"n\">rw</span> <span class=\"n\">mul_assoc</span><span class=\"o\">,</span> <span class=\"n\">apply</span> <span class=\"n\">dvd_mul_of_dvd_right</span> <span class=\"o\">},</span> <span class=\"n\">clear</span> <span class=\"n\">c</span> <span class=\"n\">b</span><span class=\"o\">,</span>\n  <span class=\"n\">norm_cast</span><span class=\"o\">,</span>\n  <span class=\"n\">apply</span> <span class=\"n\">coe_nat_dvd</span><span class=\"o\">,</span>\n  <span class=\"n\">by_cases</span> <span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"n\">i</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">subst</span> <span class=\"n\">H</span><span class=\"o\">,</span>\n    <span class=\"n\">suffices</span> <span class=\"o\">:</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"err\">∣</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"err\">^</span> <span class=\"n\">p</span><span class=\"o\">,</span> <span class=\"k\">by</span> <span class=\"n\">simpa</span><span class=\"o\">,</span>\n    <span class=\"n\">rw</span> <span class=\"err\">←</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_mul</span><span class=\"o\">,</span>\n    <span class=\"n\">apply</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_dvd_pow</span><span class=\"o\">,</span>\n    <span class=\"n\">refine</span> <span class=\"n\">le_trans</span> <span class=\"o\">(</span><span class=\"n\">add_le_add_left&#39;</span> <span class=\"err\">$</span> <span class=\"n\">le_add_left</span> <span class=\"err\">$</span> <span class=\"n\">le_refl</span> <span class=\"bp\">_</span> <span class=\"o\">:</span> <span class=\"n\">k</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">≤</span> <span class=\"n\">k</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">+</span> <span class=\"o\">(</span><span class=\"n\">k</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n    <span class=\"n\">refine</span> <span class=\"n\">le_trans</span> <span class=\"o\">(</span><span class=\"n\">le_of_eq</span> <span class=\"bp\">_</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">mul_le_mul_left</span> <span class=\"o\">(</span><span class=\"n\">k</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"err\">$</span> <span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span><span class=\"bp\">.</span><span class=\"n\">ge_two</span> <span class=\"err\">‹</span><span class=\"bp\">_</span><span class=\"err\">›</span> <span class=\"o\">:</span> <span class=\"mi\">2</span> <span class=\"bp\">≤</span> <span class=\"n\">p</span><span class=\"o\">)),</span>\n    <span class=\"n\">rw</span> <span class=\"n\">mul_two</span> <span class=\"o\">},</span>\n  <span class=\"k\">have</span> <span class=\"n\">i_pos</span> <span class=\"o\">:=</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pos_of_ne_zero</span> <span class=\"n\">H</span><span class=\"o\">,</span> <span class=\"n\">clear</span> <span class=\"n\">H</span><span class=\"o\">,</span>\n  <span class=\"n\">rw</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_succ</span><span class=\"o\">,</span>\n  <span class=\"n\">apply</span> <span class=\"n\">mul_dvd_mul</span><span class=\"o\">,</span>\n  <span class=\"o\">{</span> <span class=\"n\">generalize</span> <span class=\"n\">H</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">p</span><span class=\"err\">^</span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"bp\">=</span> <span class=\"n\">b</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">sub_pos_of_lt</span> <span class=\"n\">hi</span><span class=\"o\">,</span>\n    <span class=\"n\">conv</span> <span class=\"o\">{</span><span class=\"n\">congr</span><span class=\"o\">,</span> <span class=\"n\">rw</span> <span class=\"err\">←</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_one</span> <span class=\"n\">b</span><span class=\"o\">},</span>\n    <span class=\"n\">apply</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pow_dvd_pow</span><span class=\"o\">,</span>\n    <span class=\"n\">exact</span> <span class=\"n\">this</span> <span class=\"o\">},</span>\n  <span class=\"n\">exact</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span><span class=\"bp\">.</span><span class=\"n\">dvd_choose</span> <span class=\"n\">i_pos</span> <span class=\"n\">hi</span> <span class=\"err\">‹</span><span class=\"bp\">_</span><span class=\"err\">›</span>\n<span class=\"kn\">end</span>\n</pre></div>",
        "id": 168074096,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451753
    },
    {
        "content": "<p>If someone is looking for a golfing challenge... voila <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span></p>",
        "id": 168074136,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560451776
    },
    {
        "content": "<blockquote>\n<p>It can't figure out that quotient rings are <code>add_comm_monoid</code></p>\n</blockquote>\n<p>This one in particular seems alarming</p>",
        "id": 168080734,
        "sender_full_name": "Reid Barton",
        "timestamp": 1560456623
    },
    {
        "content": "<p>I've done some refactoring, and removed a bunch of sorries.</p>",
        "id": 168218364,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560623535
    },
    {
        "content": "<p>Witt vectors are now a <code>comm_ring</code>:<br>\n<a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L1339</a></p>",
        "id": 168218367,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560623544
    },
    {
        "content": "<blockquote>\n<p>I use <code>by apply</code> when I get the pesky issue with inferred != unified</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I've been trying this but is doesn't seem to work.</p>\n<p>I've cleaned up the code quite a bit. In the course of this, those sorries returned. I have no idea what is wrong, but for some weird reason I'm pushing Leans limits.<br>\nIf you could take a look at <a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577\">https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L577</a> that would be great.</p>",
        "id": 168376810,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560843613
    },
    {
        "content": "<p>This branch only changes <code>mv_polynomial.lean</code> and the new file <code>witt_vector.lean</code>.</p>\n<div class=\"codehilite\"><pre><span></span>git pull\ngit checkout 38d5c12022e001a221e279f035e3cc0734c4a189 <span class=\"c1\"># the lean-3.4.2 of yesterday</span>\ncache-olean --fetch\ngit checkout witt-vectors\n</pre></div>\n\n\n<p>That should give one a working version of the branch pretty quickly.</p>",
        "id": 168376951,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560843819
    },
    {
        "content": "<p>To give an idea of how weird the situation is:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"mi\">4</span> <span class=\"n\">goals</span>\n<span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span>\n<span class=\"err\">⊢</span> <span class=\"n\">distrib</span><span class=\"bp\">.</span><span class=\"n\">to_has_add</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">quotient</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span> <span class=\"o\">{</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))}))</span> <span class=\"bp\">=</span>\n    <span class=\"n\">add_semigroup</span><span class=\"bp\">.</span><span class=\"n\">to_has_add</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">quotient</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span> <span class=\"o\">{</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))}))</span>\n\n<span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span>\n<span class=\"err\">⊢</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"err\">^</span> <span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">-</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"n\">modₑ</span> <span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">)))</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span>\n\n<span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span>\n<span class=\"err\">⊢</span> <span class=\"n\">is_add_monoid_hom</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">quotient</span><span class=\"bp\">.</span><span class=\"n\">mk</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span> <span class=\"o\">{</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))}))</span>\n\n<span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span>\n<span class=\"err\">⊢</span> <span class=\"n\">is_add_monoid_hom</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">quotient</span><span class=\"bp\">.</span><span class=\"n\">mk</span> <span class=\"o\">(</span><span class=\"n\">ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span> <span class=\"o\">{</span><span class=\"n\">C</span> <span class=\"err\">↑</span><span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"err\">^</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span><span class=\"o\">))}))</span>\n</pre></div>\n\n\n<p>For none of these goals the \"obvious\" proof works. I.e. no <code>apply_instance</code> or <code>zero_mul</code> etc...</p>",
        "id": 168378405,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560845144
    },
    {
        "content": "<p>does rfl work for the first?</p>",
        "id": 168378474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560845181
    },
    {
        "content": "<p>It does. But Johan you can see something is funny about this code. The 20 or so lines of proof of <code>witt_polynomial_mod_pow_p</code> are taking forever to compile on my machine. There is perhaps some gigantic monster term somewhere in there which needs to be tamed, or something is timing out somewhere...</p>",
        "id": 168379641,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846294
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>1 goal\np : nat,\nn : nat\n⊢ @eq.{1}\n    (@ideal.quotient.{0}\n       (@mv_polynomial.{0 0} nat int\n          (@comm_ring.to_comm_semiring.{0} int\n             (@nonzero_comm_ring.to_comm_ring.{0} int\n                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n       (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n          (λ (a b : int), int.decidable_eq a b)\n          (@nonzero_comm_ring.to_comm_ring.{0} int\n             (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n       (@ideal.span.{0}\n          (@mv_polynomial.{0 0} nat int\n             (@comm_ring.to_comm_semiring.{0} int\n                (@nonzero_comm_ring.to_comm_ring.{0} int\n                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n          (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n             (λ (a b : int), int.decidable_eq a b)\n             (@nonzero_comm_ring.to_comm_ring.{0} int\n                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n          (@singleton.{0 0}\n             (@mv_polynomial.{0 0} nat int\n                (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                   (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n             (set.{0}\n                (@mv_polynomial.{0 0} nat int\n                   (@comm_ring.to_comm_semiring.{0} int\n                      (@nonzero_comm_ring.to_comm_ring.{0} int\n                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n             (@set.has_emptyc.{0}\n                (@mv_polynomial.{0 0} nat int\n                   (@comm_ring.to_comm_semiring.{0} int\n                      (@nonzero_comm_ring.to_comm_ring.{0} int\n                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n             (@set.has_insert.{0}\n                (@mv_polynomial.{0 0} nat int\n                   (@comm_ring.to_comm_semiring.{0} int\n                      (@nonzero_comm_ring.to_comm_ring.{0} int\n                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n             (@mv_polynomial.C.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n                (λ (a b : int), int.decidable_eq a b)\n                (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                   (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n                (@coe.{1 1} nat int\n                   (@coe_to_lift.{1 1} nat int\n                      (@coe_base.{1 1} nat int\n                         (@nat.cast_coe.{0} int\n                            (@mul_zero_class.to_has_zero.{0} int\n                               (@semiring.to_mul_zero_class.{0} int\n                                  (@comm_semiring.to_semiring.{0} int\n                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))\n                            (@monoid.to_has_one.{0} int\n                               (@semiring.to_monoid.{0} int\n                                  (@comm_semiring.to_semiring.{0} int\n                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))\n                            (@distrib.to_has_add.{0} int\n                               (@semiring.to_distrib.{0} int\n                                  (@comm_semiring.to_semiring.{0} int\n                                     (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                        (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                           (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))))))\n                   (@has_pow.pow.{0 0} nat nat nat.has_pow p\n                      (@has_add.add.{0} nat nat.has_add n (@has_one.one.{0} nat nat.has_one))))))))\n    (@has_mul.mul.{0}\n       (@ideal.quotient.{0}\n          (@mv_polynomial.{0 0} nat int\n             (@comm_ring.to_comm_semiring.{0} int\n                (@nonzero_comm_ring.to_comm_ring.{0} int\n                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n          (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n             (λ (a b : int), int.decidable_eq a b)\n             (@nonzero_comm_ring.to_comm_ring.{0} int\n                (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n          (@ideal.span.{0}\n             (@mv_polynomial.{0 0} nat int\n                (@comm_ring.to_comm_semiring.{0} int\n                   (@nonzero_comm_ring.to_comm_ring.{0} int\n                      (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n             (@mv_polynomial.comm_ring.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n                (λ (a b : int), int.decidable_eq a b)\n                (@nonzero_comm_ring.to_comm_ring.{0} int\n                   (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n             (@singleton.{0 0}\n                (@mv_polynomial.{0 0} nat int\n                   (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                      (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))\n                (set.{0}\n                   (@mv_polynomial.{0 0} nat int\n                      (@comm_ring.to_comm_semiring.{0} int\n                         (@nonzero_comm_ring.to_comm_ring.{0} int\n                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n                (@set.has_emptyc.{0}\n                   (@mv_polynomial.{0 0} nat int\n                      (@comm_ring.to_comm_semiring.{0} int\n                         (@nonzero_comm_ring.to_comm_ring.{0} int\n                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n                (@set.has_insert.{0}\n                   (@mv_polynomial.{0 0} nat int\n                      (@comm_ring.to_comm_semiring.{0} int\n                         (@nonzero_comm_ring.to_comm_ring.{0} int\n                            (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))))\n                (@mv_polynomial.C.{0 0} int nat (λ (a b : nat), nat.decidable_eq a b)\n                   (λ (a b : int), int.decidable_eq a b)\n                   (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                      (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                         (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain)))\n                   (@coe.{1 1} nat int\n                      (@coe_to_lift.{1 1} nat int\n                         (@coe_base.{1 1} nat int\n                            (@nat.cast_coe.{0} int\n                               (@mul_zero_class.to_has_zero.{0} int\n                                  (@semiring.to_mul_zero_class.{0} int\n                                     (@comm_semiring.to_semiring.{0} int\n                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))\n[many more lines cut]\n</pre></div>",
        "id": 168379816,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846460
    },
    {
        "content": "<p><a href=\"https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865\" target=\"_blank\" title=\"https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865\">https://gist.github.com/kbuzzard/33fe4da55bcc83199306c133f6c4d865</a> The goal is nearly 1000 lines long. Is this inevitable when dealing with complex algebraic types or is this an indication that something is wrong?</p>",
        "id": 168379924,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846550
    },
    {
        "content": "<p>omg we need deduplicating pretty printer so much</p>",
        "id": 168379932,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846572
    },
    {
        "content": "<p>this definitely isn't inevitable in the abstract</p>",
        "id": 168379996,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846621
    },
    {
        "content": "<p>not sure how inevitable it is in lean, with the existing typeclass inference mechanism</p>",
        "id": 168380009,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846647
    },
    {
        "content": "<p>This subterm</p>\n<div class=\"codehilite\"><pre><span></span>                            (@coe.{1 1} nat int\n                               (@coe_to_lift.{1 1} nat int\n                                  (@coe_base.{1 1} nat int\n                                     (@nat.cast_coe.{0} int\n                                        (@mul_zero_class.to_has_zero.{0} int\n                                           (@semiring.to_mul_zero_class.{0} int\n                                              (@comm_semiring.to_semiring.{0} int\n                                                 (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                                    (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                                       (@euclidean_domain.to_nonzero_comm_ring.{0} int\nint.euclidean_domain))))))\n</pre></div>\n\n\n<p>comes up around 10 times.</p>",
        "id": 168380015,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846651
    },
    {
        "content": "<p>that's just <code>int.of_nat</code></p>",
        "id": 168380041,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846686
    },
    {
        "content": "<p>It's about 10% of the term in terms of lines of output</p>",
        "id": 168380050,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846706
    },
    {
        "content": "<p>I don't know why it's fixated on <code>int.euclidean_domain</code> for deriving everything</p>",
        "id": 168380105,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846731
    },
    {
        "content": "<p>I thought the whole point of <code>int.of_nat</code> was that it was some primitive which was supposed to be fast</p>",
        "id": 168380143,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846760
    },
    {
        "content": "<p>it is</p>",
        "id": 168380152,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846773
    },
    {
        "content": "<p>but that doesn't stop lean from taking a gratuitous path to get there</p>",
        "id": 168380170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846790
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>                  (@coe.{1 1} nat int\n                      (@coe_to_lift.{1 1} nat int\n                         (@coe_base.{1 1} nat int\n                            (@nat.cast_coe.{0} int\n                               (@mul_zero_class.to_has_zero.{0} int\n                                  (@semiring.to_mul_zero_class.{0} int\n                                     (@comm_semiring.to_semiring.{0} int\n                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))\n                               (@monoid.to_has_one.{0} int\n                                  (@semiring.to_monoid.{0} int\n                                     (@comm_semiring.to_semiring.{0} int\n                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int int.euclidean_domain))))))\n                               (@distrib.to_has_add.{0} int\n                                  (@semiring.to_distrib.{0} int\n                                     (@comm_semiring.to_semiring.{0} int\n                                        (@nonzero_comm_semiring.to_comm_semiring.{0} int\n                                           (@nonzero_comm_ring.to_nonzero_comm_semiring.{0} int\n                                              (@euclidean_domain.to_nonzero_comm_ring.{0} int\nint.euclidean_domain)))))))))\n</pre></div>\n\n\n<p>In fact there's something even bigger which is coming up a lot.</p>",
        "id": 168380189,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846807
    },
    {
        "content": "<p>oh wait, actually this isn't <code>int.of_nat</code></p>",
        "id": 168380247,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846848
    },
    {
        "content": "<p>this is the \"wrong\" coe from nat to int</p>",
        "id": 168380254,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846858
    },
    {
        "content": "<p><code>nat.cast</code></p>",
        "id": 168380255,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846863
    },
    {
        "content": "<p>both of them are <code>nat.cast</code></p>",
        "id": 168380263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846873
    },
    {
        "content": "<p>try simp?</p>",
        "id": 168380272,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560846884
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>                                  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">int</span>\n                                     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe_to_lift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">int</span>\n                                        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe_base</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">int</span>\n                                           <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">cast_coe</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mul_zero_class</span><span class=\"bp\">.</span><span class=\"n\">to_has_zero</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                 <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">to_mul_zero_class</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                       <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                          <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                             <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                                <span class=\"n\">int</span><span class=\"bp\">.</span><span class=\"n\">euclidean_domain</span><span class=\"o\">))))))</span>\n                                              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">monoid</span><span class=\"bp\">.</span><span class=\"n\">to_has_one</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                 <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">to_monoid</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                       <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                          <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                             <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                                <span class=\"n\">int</span><span class=\"bp\">.</span><span class=\"n\">euclidean_domain</span><span class=\"o\">))))))</span>\n                                              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">distrib</span><span class=\"bp\">.</span><span class=\"n\">to_has_add</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                 <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">to_distrib</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                       <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                          <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_semiring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                             <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">euclidean_domain</span><span class=\"bp\">.</span><span class=\"n\">to_nonzero_comm_ring</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">int</span>\n                                                                <span class=\"n\">int</span><span class=\"bp\">.</span><span class=\"n\">euclidean_domain</span><span class=\"o\">)))))))))</span>\n                                     <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_pow</span><span class=\"bp\">.</span><span class=\"n\">pow</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span> <span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">nat</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">has_pow</span> <span class=\"n\">p</span>\n                                        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_add</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">has_add</span> <span class=\"n\">n</span>\n                                           <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">has_one</span><span class=\"bp\">.</span><span class=\"n\">one</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span> <span class=\"n\">nat</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">has_one</span><span class=\"o\">)))))))))))))</span>\n</pre></div>\n\n\n<p>There's something slightly bigger. This shows up again and again in the term.</p>",
        "id": 168380273,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846887
    },
    {
        "content": "<blockquote>\n<p>try simp?</p>\n</blockquote>\n<p>[waits 10 seconds] fails to simplify.</p>",
        "id": 168380297,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560846930
    },
    {
        "content": "<p>are there dependencies? What is the pp form of the goal?</p>",
        "id": 168380496,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560847134
    },
    {
        "content": "<p>The gist I posted above is the pp form of the goal.</p>",
        "id": 168380538,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1560847180
    },
    {
        "content": "<p>I mean with regular printing</p>",
        "id": 168381467,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560848151
    },
    {
        "content": "<p>Sorry, I got distracted by teaching duties... I've tried <code>dsimp</code>, <code>simp</code>, <code>erw</code>, <code>congr</code>, etc... everything times out.</p>",
        "id": 168381482,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560848162
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"mi\">1</span> <span class=\"n\">goal</span>\n<span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_3</span> <span class=\"o\">:</span> <span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">prime</span> <span class=\"n\">p</span><span class=\"o\">,</span>\n<span class=\"n\">idx</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u_4</span><span class=\"o\">,</span>\n<span class=\"bp\">_</span><span class=\"n\">inst_10</span> <span class=\"o\">:</span> <span class=\"n\">decidable_eq</span> <span class=\"n\">idx</span><span class=\"o\">,</span>\n<span class=\"err\">Φ</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">idx</span> <span class=\"bp\">ℤ</span><span class=\"o\">,</span>\n<span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">,</span>\n<span class=\"n\">IH</span> <span class=\"o\">:</span> <span class=\"bp\">∀</span> <span class=\"o\">(</span><span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">m</span> <span class=\"bp\">&lt;</span> <span class=\"n\">n</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span> <span class=\"bp\">→</span> <span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_int</span> <span class=\"n\">p</span> <span class=\"err\">Φ</span> <span class=\"n\">m</span><span class=\"o\">)</span> <span class=\"bp\">=</span> <span class=\"n\">witt_structure_rat</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"err\">Φ</span><span class=\"o\">)</span> <span class=\"n\">m</span><span class=\"o\">,</span>\n<span class=\"n\">this</span> <span class=\"o\">:</span>\n  <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_rat</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"err\">Φ</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">)</span> <span class=\"bp\">=</span>\n    <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_int</span> <span class=\"n\">p</span> <span class=\"err\">Φ</span> <span class=\"n\">t</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"err\">⊢</span> <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">idx</span> <span class=\"bp\">×</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"n\">x</span> <span class=\"err\">^</span> <span class=\"n\">p</span><span class=\"o\">))</span>\n      <span class=\"o\">(</span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_rat</span> <span class=\"n\">p</span> <span class=\"o\">(</span><span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"err\">Φ</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">))</span> <span class=\"bp\">=</span>\n    <span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">idx</span> <span class=\"bp\">×</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"o\">(</span><span class=\"n\">X</span> <span class=\"n\">x</span> <span class=\"err\">^</span> <span class=\"n\">p</span><span class=\"o\">))</span>\n      <span class=\"o\">(</span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">(</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">),</span> <span class=\"n\">map</span> <span class=\"n\">coe</span> <span class=\"o\">(</span><span class=\"n\">witt_structure_int</span> <span class=\"n\">p</span> <span class=\"err\">Φ</span> <span class=\"n\">t</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">witt_polynomial</span> <span class=\"n\">p</span> <span class=\"n\">n</span><span class=\"o\">))</span>\n</pre></div>",
        "id": 168381537,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560848182
    },
    {
        "content": "<p>I posted the other 4 goals somewhere upstairs.</p>",
        "id": 168381546,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560848194
    },
    {
        "content": "<p>You are right that the first one could be closed by <code>refl</code>. Which is weird, because it was produced by <code>congr</code>, I think.</p>",
        "id": 168381567,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560848218
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I feel like I'm bitten by having to work explicitly with integers. But that cannot be avoided. It's crucial to show that these polynomials are defined over <code>int</code>, because <code>int</code> is the initial object in <code>CommRing</code>. And one cannot simply write down these polynomials over an arbitrary ring. Their coefficients are rational numbers that after a lot of work turn out to actually be integers.</p>",
        "id": 168382302,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849048
    },
    {
        "content": "<p>I have no idea how to make the code faster, more well-behaved.</p>",
        "id": 168382313,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849062
    },
    {
        "content": "<p><code>mod_e</code> should be a definition</p>",
        "id": 168382803,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849590
    },
    {
        "content": "<p>Can you explain why?</p>",
        "id": 168382881,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849632
    },
    {
        "content": "<p>you should not make a notation for a very complex term. This increases the difference between what you see and what lean sees</p>",
        "id": 168382923,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849686
    },
    {
        "content": "<p>Do you think it is a reasonable \"concept\" or is there a better way to do \"calculations modulo [ideal/element]\"</p>",
        "id": 168382925,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849687
    },
    {
        "content": "<p>You could use an equivalence relation</p>",
        "id": 168382944,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849707
    },
    {
        "content": "<p>but I don't know if I should tweak the mathematics aspects too heavily</p>",
        "id": 168383010,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849734
    },
    {
        "content": "<p>if you need ideals, so be it</p>",
        "id": 168383022,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849743
    },
    {
        "content": "<p>I think it should be a general definition though; <code>a = b [MOD n]</code> should be generalized</p>",
        "id": 168383069,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849802
    },
    {
        "content": "<blockquote>\n<p>I think it should be a general definition though; <code>a = b [MOD n]</code> should be generalized</p>\n</blockquote>\n<p>You mean from <code>ℤ</code> to an arbitrary ring?</p>",
        "id": 168383147,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849864
    },
    {
        "content": "<p>yes</p>",
        "id": 168383169,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849881
    },
    {
        "content": "<p>and possibly to ideals</p>",
        "id": 168383175,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849888
    },
    {
        "content": "<p>I see you needed a few variations on this</p>",
        "id": 168383189,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849903
    },
    {
        "content": "<p>Do you think that <code>mod_e</code> is one of the reasons that the file is slow?</p>",
        "id": 168383270,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560849963
    },
    {
        "content": "<p>it's a factor in the huge pp.all terms</p>",
        "id": 168383303,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560849984
    },
    {
        "content": "<p>because <code>mod_e</code> hides an <code>ideal.span</code> and <code>quotient.mk</code> and each of these takes a bunch of typeclass args</p>",
        "id": 168383320,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560850011
    },
    {
        "content": "<p>But <code>blur</code> doesn't even use it. And there the <code>rw this</code> still fails... <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 168383329,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850023
    },
    {
        "content": "<p>where do you start sensing problems?</p>",
        "id": 168383351,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560850048
    },
    {
        "content": "<p>Should we also build <code>eval_c</code> which is <code>eval₂ C</code>? I'm using <code>eval₂ C</code> a lot.</p>",
        "id": 168383373,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850076
    },
    {
        "content": "<p>I noticed</p>",
        "id": 168383435,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560850100
    },
    {
        "content": "<p><code>witt_structure_rat_rec_aux</code> is slow</p>",
        "id": 168383440,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850109
    },
    {
        "content": "<p>I thought that this was one of the eval functions</p>",
        "id": 168383444,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560850112
    },
    {
        "content": "<p>And <code>dvd_sub_pow_of_dvd_sub</code> is also incredibly slow, but I think that's completely orthogonal to the others.</p>",
        "id": 168383476,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850157
    },
    {
        "content": "<p>Lines 554–735 are very slow. And that's exactly the part that is hard for mathematicians. The rest is all \"math-trivial\".</p>",
        "id": 168383572,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850225
    },
    {
        "content": "<p>It is the part where we show that the polynomials have integral coefficients. It takes most textbooks half a page <span aria-label=\"shock\" class=\"emoji emoji-1f628\" role=\"img\" title=\"shock\">:shock:</span></p>",
        "id": 168383596,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850256
    },
    {
        "content": "<blockquote>\n<p>I thought that this was one of the eval functions</p>\n</blockquote>\n<p>No, we don't have a wrapper for <code>eval₂ C</code>.</p>",
        "id": 168383698,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560850329
    },
    {
        "content": "<p>Is it the bind operation for mv_polynomial as a monad that you're using?</p>",
        "id": 168383940,
        "sender_full_name": "Chris Hughes",
        "timestamp": 1560850535
    },
    {
        "content": "<p>I think it is, yes.</p>",
        "id": 168385933,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560852088
    },
    {
        "content": "<p>Well, it's not exactly <code>bind</code>. Because I think:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">bind</span> <span class=\"o\">:</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"o\">(</span><span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"n\">R</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"n\">R</span>\n</pre></div>\n\n\n<p>whereas</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">eval₂</span> <span class=\"n\">C</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">σ</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"n\">R</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"n\">R</span> <span class=\"bp\">→</span> <span class=\"n\">mv_polynomial</span> <span class=\"n\">σ</span> <span class=\"n\">R</span>\n</pre></div>",
        "id": 168396534,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560861959
    },
    {
        "content": "<p>It is exactly <code>bind</code>. You're thinking of <code>join</code></p>",
        "id": 168396855,
        "sender_full_name": "Reid Barton",
        "timestamp": 1560862176
    },
    {
        "content": "<p>Aah...</p>",
        "id": 168396858,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862181
    },
    {
        "content": "<p>Crazy names</p>",
        "id": 168396867,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862186
    },
    {
        "content": "<p>(Or actually it's <code>bind</code> with the arguments flipped)</p>",
        "id": 168396875,
        "sender_full_name": "Reid Barton",
        "timestamp": 1560862191
    },
    {
        "content": "<p>The idea is you are binding the result of the non-function argument to the input variable of the function argument</p>",
        "id": 168397001,
        "sender_full_name": "Reid Barton",
        "timestamp": 1560862268
    },
    {
        "content": "<p><code>join</code> joins two layers of the monad</p>",
        "id": 168397011,
        "sender_full_name": "Reid Barton",
        "timestamp": 1560862274
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Does this mean we should define <code>bind</code> and <code>join</code> and prove a whole bunch of API about them?</p>",
        "id": 168397204,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862426
    },
    {
        "content": "<p>sure</p>",
        "id": 168397278,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560862470
    },
    {
        "content": "<p>Are there other ways in which I can make my code workable?</p>",
        "id": 168397308,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862499
    },
    {
        "content": "<p><code>bind</code> or <code>join</code> - they are interdefinable</p>",
        "id": 168397309,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560862499
    },
    {
        "content": "<p>They are all special cases of <code>eval₂</code></p>",
        "id": 168397325,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862517
    },
    {
        "content": "<p>I don't think this will do that much to solve the problem, but it seems like a nice definition</p>",
        "id": 168397448,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560862579
    },
    {
        "content": "<p>But I also don't think <code>mod_e</code> is the main culprit. The code is also slow in parts where I don't use that.</p>",
        "id": 168397524,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560862638
    },
    {
        "content": "<p>Okay, so here's a minimized version of the first suspiciously slow tactic, on <a href=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L301\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/witt-vectors/src/ring_theory/witt_vector.lean#L301\">L301</a>:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">import</span> <span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span> <span class=\"n\">algebra</span><span class=\"bp\">.</span><span class=\"n\">group_power</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"o\">:</span> <span class=\"bp\">ℕ</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">P</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span>\n  <span class=\"o\">(</span><span class=\"n\">hc</span> <span class=\"o\">:</span> <span class=\"n\">P</span> <span class=\"o\">(</span><span class=\"n\">p</span> <span class=\"bp\">*</span>\n    <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe</span> <span class=\"n\">nat</span> <span class=\"n\">α</span>\n      <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe_to_lift</span> <span class=\"n\">nat</span> <span class=\"n\">α</span>\n        <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">coe_base</span> <span class=\"n\">nat</span> <span class=\"n\">α</span>\n          <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">cast_coe</span> <span class=\"n\">α</span>\n            <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">mul_zero_class</span><span class=\"bp\">.</span><span class=\"n\">to_has_zero</span> <span class=\"n\">α</span>\n              <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">to_mul_zero_class</span> <span class=\"n\">α</span>\n                  <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_semiring</span> <span class=\"n\">α</span> <span class=\"bp\">_</span><span class=\"o\">)))</span>\n            <span class=\"bp\">_</span> <span class=\"bp\">_</span><span class=\"o\">)))</span>\n      <span class=\"n\">p</span><span class=\"o\">)))</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">try_for</span> <span class=\"mi\">10000</span> <span class=\"o\">{</span><span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"n\">at</span> <span class=\"n\">hc</span><span class=\"o\">}</span><span class=\"bp\">;</span> <span class=\"n\">sorry</span>\n</pre></div>",
        "id": 168401087,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560864971
    },
    {
        "content": "<p>The profiler says all the time (about 22s) is spent in <code>mk_eq_mp</code>. Here's a minimized tactic from the core of <code>simp</code> that triggers the long running <code>mk_eq_mp</code>:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">by</span> <span class=\"n\">do</span>\n  <span class=\"n\">h</span> <span class=\"err\">←</span> <span class=\"n\">get_local</span> <span class=\"bp\">`</span><span class=\"n\">hc</span><span class=\"o\">,</span>\n  <span class=\"n\">h_type</span> <span class=\"err\">←</span> <span class=\"n\">infer_type</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"n\">pr&#39;</span> <span class=\"err\">←</span> <span class=\"n\">mk_app</span> <span class=\"bp\">`</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">[</span><span class=\"n\">h_type</span><span class=\"o\">],</span>\n  <span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span> <span class=\"n\">pr</span><span class=\"o\">)</span> <span class=\"err\">←</span> <span class=\"n\">simplify</span> <span class=\"n\">simp_lemmas</span><span class=\"bp\">.</span><span class=\"n\">mk</span> <span class=\"o\">[]</span> <span class=\"n\">h_type</span> <span class=\"o\">{}</span> <span class=\"bp\">`</span><span class=\"n\">eq</span> <span class=\"n\">failed</span><span class=\"o\">,</span>\n  <span class=\"n\">trace</span> <span class=\"n\">pr&#39;</span><span class=\"o\">,</span> <span class=\"n\">trace</span> <span class=\"n\">pr</span><span class=\"o\">,</span> <span class=\"n\">trace</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"n\">mk_eq_mp</span> <span class=\"n\">pr</span> <span class=\"n\">h</span>\n</pre></div>\n\n\n<p>Replacing <code>pr</code> with the identical hand-rolled proof <code>pr'</code> takes no time at all. Perhaps metavariable instantiations are involved?</p>",
        "id": 168403526,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560866435
    },
    {
        "content": "<p>I am totally lost at how you debug these things. The particular lemma that contains L301 seems very innocent. No weird universes or whatever.</p>",
        "id": 168404475,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867053
    },
    {
        "content": "<p><code>mk_eq_mp</code> is defined in terms of <code>mk_app</code>, which is also slow along with <code>mk_mapp</code>. Even this is long running:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">mk_mapp</span> <span class=\"bp\">`</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mp</span> <span class=\"o\">[</span><span class=\"n\">h_type</span><span class=\"o\">,</span> <span class=\"n\">h_type</span><span class=\"o\">,</span> <span class=\"n\">pr</span><span class=\"o\">,</span> <span class=\"n\">h</span><span class=\"o\">]</span>\n</pre></div>\n\n\n<p>It's not doing any inference! It's just typechecking</p>",
        "id": 168404522,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867098
    },
    {
        "content": "<p>I debug this by finding the part that is slow and then delete everything that doesn't matter until almost nothing is left</p>",
        "id": 168404605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867140
    },
    {
        "content": "<p>Is there an obvious code smell, if you look at that proof?</p>",
        "id": 168404676,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867198
    },
    {
        "content": "<p>I'm still at the stage where I figure out why lean is stupid. Once I have that I can probably derive an appropriate code smell</p>",
        "id": 168404731,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867243
    },
    {
        "content": "<p>I'm sure I've hit this bug before but I haven't investigated it in depth</p>",
        "id": 168404814,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867286
    },
    {
        "content": "<p>the operative aspect here seems to be a slightly noncanonical typeclass path</p>",
        "id": 168404851,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867320
    },
    {
        "content": "<p>Thanks a lot for taking a look. I'm completely handicapped when it comes to debugging things like this. And I'm glad your thinking that Lean is stupid, instead of me being stupid <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span></p>",
        "id": 168404870,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867332
    },
    {
        "content": "<p>Feel free to push speed-ups upstream by the way.</p>",
        "id": 168404984,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867385
    },
    {
        "content": "<p>I don't know how useful adding workarounds on every line will be. I suspect that this issue comes up many many times in the file and that's the major problem</p>",
        "id": 168405056,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560867434
    },
    {
        "content": "<p>Ok</p>",
        "id": 168405090,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867473
    },
    {
        "content": "<p>Feel free to push structural speed-ups upstream <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 168405144,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560867491
    },
    {
        "content": "<p>Okay, it's completely barebones now. The problem arises when <code>mk_app</code> and friends are passed a non-canonical instance and asked to unify the results. <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Do you know what's happening here?</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"kn\">set_option</span> <span class=\"n\">profiler</span> <span class=\"n\">true</span>\n<span class=\"kn\">open</span> <span class=\"n\">tactic</span>\n\n<span class=\"n\">def</span> <span class=\"n\">bar</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">semiring</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">sorry</span>\n\n<span class=\"kn\">lemma</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">comm_ring</span> <span class=\"n\">α</span><span class=\"o\">]</span>\n  <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">bar</span> <span class=\"n\">α</span> <span class=\"bp\">=</span> <span class=\"bp\">@</span><span class=\"n\">bar</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">to_semiring</span> <span class=\"n\">α</span> <span class=\"bp\">_</span><span class=\"o\">))</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span>\n<span class=\"k\">by</span> <span class=\"n\">do</span>\n  <span class=\"n\">h</span> <span class=\"err\">←</span> <span class=\"n\">get_local</span> <span class=\"bp\">`</span><span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"n\">ht</span> <span class=\"err\">←</span> <span class=\"n\">infer_type</span> <span class=\"n\">h</span><span class=\"o\">,</span>\n  <span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"err\">%%</span><span class=\"n\">h1</span> <span class=\"bp\">=</span> <span class=\"err\">%%</span><span class=\"n\">h2</span><span class=\"o\">)</span> <span class=\"err\">←</span> <span class=\"n\">return</span> <span class=\"n\">ht</span><span class=\"o\">,</span>\n  <span class=\"n\">ht&#39;</span> <span class=\"err\">←</span> <span class=\"n\">to_expr</span> <span class=\"bp\">``</span><span class=\"o\">(</span><span class=\"err\">%%</span><span class=\"n\">h2</span> <span class=\"bp\">=</span> <span class=\"err\">%%</span><span class=\"n\">h2</span><span class=\"o\">),</span>\n  <span class=\"n\">pr</span> <span class=\"err\">←</span> <span class=\"n\">mk_app</span> <span class=\"bp\">`</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">],</span>\n  <span class=\"n\">pr&#39;</span> <span class=\"err\">←</span> <span class=\"n\">mk_app</span> <span class=\"bp\">`</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">[</span><span class=\"n\">ht&#39;</span><span class=\"o\">],</span>\n  <span class=\"n\">trace</span> <span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">,</span> <span class=\"n\">ht</span><span class=\"o\">,</span> <span class=\"n\">pr&#39;</span><span class=\"o\">,</span> <span class=\"n\">h</span><span class=\"o\">],</span>\n  <span class=\"n\">mk_mapp</span> <span class=\"bp\">`</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mp</span> <span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">,</span> <span class=\"n\">ht</span><span class=\"o\">,</span> <span class=\"n\">pr&#39;</span><span class=\"o\">,</span> <span class=\"n\">h</span><span class=\"o\">]</span> <span class=\"c1\">-- takes 23s</span>\n</pre></div>",
        "id": 168407094,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560868744
    },
    {
        "content": "<p>What is <code>P</code> doing in your example?</p>",
        "id": 168407212,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560868813
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Thanks a lot for stripping this down to a MWE. I would have never managed to do that.</p>",
        "id": 168407501,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560869001
    },
    {
        "content": "<p>oops, don't need P</p>",
        "id": 168407546,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560869030
    },
    {
        "content": "<p>Mario, if you're in a debugging mood, chasing stupid Lean behavior, you might have fun looking at <a href=\"https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211\" target=\"_blank\" title=\"https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211\">https://github.com/leanprover-community/mathlib/blob/d8d25e9adb01c87c355ae1358bba431c1237e2eb/src/analysis/normed_space/operator_norm.lean#L211</a> (that I already mentioned some time ago, but it was in a private branch then): it looks really strange to me that Lean is not able to infer the instance.</p>",
        "id": 168408145,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1560869401
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> No idea. Does the defeq trace show something interesting, or does that blow up Lean?</p>",
        "id": 168415168,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1560873612
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Do I understand correctly that it's not actually type class inference that is creating the problem? Lean should check that certain things are defeq, but it doesn't try hard enough. Is that right?</p>",
        "id": 168449670,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560887832
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Aha, it does show something interesting:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">]:</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">add</span> <span class=\"o\">(</span><span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_ring</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n <span class=\"n\">add_assoc</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero</span> <span class=\"o\">:=</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">zero</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_ring</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n <span class=\"n\">zero_add</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_zero</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_comm</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">mul</span> <span class=\"o\">(</span><span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_ring</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">one</span> <span class=\"n\">α</span> <span class=\"o\">(</span><span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_ring</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">left_distrib</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">right_distrib</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero_mul</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_zero</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">}</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"o\">{</span><span class=\"n\">add</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">add</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">add_assoc</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">zero</span> <span class=\"n\">α</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">zero_add</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_zero</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">add_comm</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">mul</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">mul_assoc</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">one</span> <span class=\"o\">:=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">one</span> <span class=\"n\">α</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"o\">,</span>\n <span class=\"n\">one_mul</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_one</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">left_distrib</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">right_distrib</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">zero_mul</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">,</span>\n <span class=\"n\">mul_zero</span> <span class=\"o\">:=</span> <span class=\"bp\">_</span><span class=\"o\">}</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">add</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">add_assoc</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">add_assoc</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">zero</span> <span class=\"n\">α</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">zero</span> <span class=\"n\">α</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">mul</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">mul</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">mul_assoc</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">mul_assoc</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">one</span> <span class=\"n\">α</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">one</span> <span class=\"n\">α</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">one_mul</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">one_mul</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">mul_one</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">mul_one</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">left_distrib</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">left_distrib</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">right_distrib</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">right_distrib</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">]:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">zero_mul</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">zero_mul</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">left</span><span class=\"o\">:</span> <span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">zero_mul</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">]:</span> <span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n  <span class=\"k\">have</span> <span class=\"n\">this</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"k\">from</span>\n    <span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n      <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mpr</span>\n         <span class=\"o\">(</span><span class=\"n\">id</span>\n            <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n               <span class=\"o\">((</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">a_1</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_1</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">a_1</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">a_2</span> <span class=\"n\">a_3</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_2</span> <span class=\"o\">:</span> <span class=\"n\">a_2</span> <span class=\"bp\">=</span> <span class=\"n\">a_3</span><span class=\"o\">),</span> <span class=\"n\">congr</span> <span class=\"o\">(</span><span class=\"n\">congr_arg</span> <span class=\"n\">eq</span> <span class=\"n\">e_1</span><span class=\"o\">)</span> <span class=\"n\">e_2</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"n\">add_zero</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))</span>\n                  <span class=\"o\">((</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">((</span><span class=\"bp\">λ</span> <span class=\"o\">[</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">has_mul</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">a_1</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_2</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">a_1</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">a_2</span> <span class=\"n\">a_3</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_3</span> <span class=\"o\">:</span> <span class=\"n\">a_2</span> <span class=\"bp\">=</span> <span class=\"n\">a_3</span><span class=\"o\">),</span>\n                      <span class=\"n\">congr</span> <span class=\"o\">(</span><span class=\"n\">congr_arg</span> <span class=\"n\">has_mul</span><span class=\"bp\">.</span><span class=\"n\">mul</span> <span class=\"n\">e_2</span><span class=\"o\">)</span> <span class=\"n\">e_3</span><span class=\"o\">)</span>\n                     <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                     <span class=\"mi\">0</span>\n                     <span class=\"o\">(</span><span class=\"n\">add_zero</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                     <span class=\"n\">a</span>\n                     <span class=\"n\">a</span>\n                     <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"n\">a</span><span class=\"o\">)))</span>\n               <span class=\"o\">(</span><span class=\"n\">propext</span> <span class=\"o\">(</span><span class=\"n\">eq_self_iff_true</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)))))</span>\n         <span class=\"n\">trivial</span><span class=\"o\">)</span>\n      <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mpr</span> <span class=\"o\">(</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">rec</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">((</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">right_distrib</span> <span class=\"mi\">0</span> <span class=\"mi\">0</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))),</span>\n  <span class=\"k\">show</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"k\">from</span> <span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span> <span class=\"o\">(</span><span class=\"n\">add_left_cancel</span> <span class=\"n\">this</span><span class=\"o\">)</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_semiring</span><span class=\"bp\">.</span><span class=\"n\">zero_mul</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"o\">[</span><span class=\"mi\">8</span><span class=\"o\">]:</span> <span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">),</span>\n  <span class=\"k\">have</span> <span class=\"n\">this</span> <span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"k\">from</span>\n    <span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n      <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mpr</span>\n         <span class=\"o\">(</span><span class=\"n\">id</span>\n            <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n               <span class=\"o\">((</span><span class=\"bp\">λ</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">a_1</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_1</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">a_1</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">a_2</span> <span class=\"n\">a_3</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_2</span> <span class=\"o\">:</span> <span class=\"n\">a_2</span> <span class=\"bp\">=</span> <span class=\"n\">a_3</span><span class=\"o\">),</span> <span class=\"n\">congr</span> <span class=\"o\">(</span><span class=\"n\">congr_arg</span> <span class=\"n\">eq</span> <span class=\"n\">e_1</span><span class=\"o\">)</span> <span class=\"n\">e_2</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"n\">add_zero</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))</span>\n                  <span class=\"o\">((</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n                  <span class=\"o\">((</span><span class=\"bp\">λ</span> <span class=\"o\">[</span><span class=\"n\">c</span> <span class=\"o\">:</span> <span class=\"n\">has_mul</span> <span class=\"n\">α</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">a_1</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_2</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">a_1</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">a_2</span> <span class=\"n\">a_3</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">e_3</span> <span class=\"o\">:</span> <span class=\"n\">a_2</span> <span class=\"bp\">=</span> <span class=\"n\">a_3</span><span class=\"o\">),</span>\n                      <span class=\"n\">congr</span> <span class=\"o\">(</span><span class=\"n\">congr_arg</span> <span class=\"n\">has_mul</span><span class=\"bp\">.</span><span class=\"n\">mul</span> <span class=\"n\">e_2</span><span class=\"o\">)</span> <span class=\"n\">e_3</span><span class=\"o\">)</span>\n                     <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                     <span class=\"mi\">0</span>\n                     <span class=\"o\">(</span><span class=\"n\">add_zero</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n                     <span class=\"n\">a</span>\n                     <span class=\"n\">a</span>\n                     <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"n\">a</span><span class=\"o\">)))</span>\n               <span class=\"o\">(</span><span class=\"n\">propext</span> <span class=\"o\">(</span><span class=\"n\">eq_self_iff_true</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">)))))</span>\n         <span class=\"n\">trivial</span><span class=\"o\">)</span>\n      <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">mpr</span> <span class=\"o\">(</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">rec</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">((</span><span class=\"mi\">0</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span><span class=\"o\">)</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">right_distrib</span> <span class=\"mi\">0</span> <span class=\"mi\">0</span> <span class=\"n\">a</span><span class=\"o\">)))</span> <span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span> <span class=\"o\">(</span><span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">+</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span><span class=\"o\">))),</span>\n  <span class=\"k\">show</span> <span class=\"mi\">0</span> <span class=\"bp\">*</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"k\">from</span> <span class=\"n\">eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span> <span class=\"o\">(</span><span class=\"n\">add_left_cancel</span> <span class=\"n\">this</span><span class=\"o\">)</span> <span class=\"bp\">=</span><span class=\"err\">?</span><span class=\"bp\">=</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"bp\">._</span><span class=\"n\">proof_1</span>\n<span class=\"o\">[</span><span class=\"n\">type_context</span><span class=\"bp\">.</span><span class=\"n\">is_def_eq_detail</span><span class=\"o\">]</span> <span class=\"n\">unfold</span> <span class=\"n\">right</span><span class=\"o\">:</span> <span class=\"n\">comm_ring</span><span class=\"bp\">.</span><span class=\"n\">to_comm_semiring</span><span class=\"bp\">._</span><span class=\"n\">proof_1</span>\n<span class=\"bp\">...</span>\n</pre></div>\n\n\n<p>The trace goes for a very long time, but I think this is the important part. It needs to solve <code>@ring.to_semiring α (@comm_ring.to_ring α _inst_1) =?= @comm_semiring.to_semiring α (@comm_ring.to_comm_semiring α _inst_1)</code>, so it unfolds both structures, so far so good. It starts confirming each of the fields is equal, until it hits <code>ring.zero_mul =?= comm_semiring.zero_mul</code>, whereupon it decides to unfold both proofs and the subproofs and so on with no end in sight.</p>",
        "id": 168451494,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560889052
    },
    {
        "content": "<p>Can anyone explain to me how this can happen? I thought that proofs were discarded right away, and that in any case they are irrelevant so that Lean should never have to check that two proofs are the same. Does it mean that there is a bug in Lean where in some exotic situations proof irrelevance is not used while it should?</p>",
        "id": 168483774,
        "sender_full_name": "Sebastien Gouezel",
        "timestamp": 1560929710
    },
    {
        "content": "<p>proofs are not discarded, but under almost all circumstances defeq problems involving them are trivial</p>",
        "id": 168484215,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560930151
    },
    {
        "content": "<p>I think there is a bug in lean somewhere here</p>",
        "id": 168484243,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560930169
    },
    {
        "content": "<p>Can this be debugged further inside Lean, or is the next step to run lean in some debugger like <code>gdb</code>?</p>",
        "id": 168485596,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1560931479
    },
    {
        "content": "<p>it goes to C++ from here</p>",
        "id": 168485769,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560931567
    },
    {
        "content": "<p>we have to find out why the defeq trace is going into proof terms</p>",
        "id": 168485785,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1560931584
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Do you think the issues in this file can be reasonable fixed with some version of Lean 3? Or will we not have Witt vectors before Lean 4? (That is certainly an acceptable answer to me.)</p>",
        "id": 168764526,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1561236065
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Just to get expectations right. Is there any hope/reason to investigate these issues in Lean 3? Or should we just wait till Lean 4?</p>",
        "id": 168958570,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1561483799
    },
    {
        "content": "<p>More specifically, will Lean 3 have Witt vectors, or should I give up?</p>",
        "id": 168958645,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1561483816
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Okay, I took a look at this issue and found the following nice comment: <a href=\"https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978\" target=\"_blank\" title=\"https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978\">https://github.com/leanprover/lean/blob/e6764047a14ce4383d29b2858fa9e2e246d4f13b/src/library/type_context.cpp#L1978</a><br>\nIt looks like Leo independently found a performance issue with this code and fixed it for Lean 4: <a href=\"https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798\" target=\"_blank\" title=\"https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798\">https://github.com/kha/lean4/commit/d85c30fde186b75dd00e04242fb8b05450a8daf8#diff-f56a907e917690c6815e55e0fe8540e9R798</a><br>\nYou could try porting it to Lean 3 (using this version: <a href=\"https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6\" target=\"_blank\" title=\"https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6\">https://github.com/kha/lean4/commit/f8cedb33e70c9d90c9d81a542340bba0b504f8e6</a>), would be interesting to see if anything breaks. But I don't think it can be worked around without changing Lean.</p>",
        "id": 169124238,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1561633544
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Thanks for looking into this!</p>",
        "id": 169124744,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1561634060
    },
    {
        "content": "<p>Yes, many thanks Sebastian.</p>",
        "id": 169128149,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1561637292
    }
]