[
    {
        "content": "<p>This thread is dedicated to the Quadratic Integers project:</p>\n<ul>\n<li>Repository: <a href=\"https://github.com/pitmonticone/QuadraticIntegers\">https://github.com/pitmonticone/QuadraticIntegers</a></li>\n<li>Informal &amp; Formal Manager: <span class=\"user-mention\" data-user-id=\"130384\">@Riccardo Brasca</span></li>\n</ul>",
        "id": 562735084,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1765297863
    },
    {
        "content": "<p>There is a typo in both main theorems (sorry...)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">d_2_or_3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>should be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">d_2_or_3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>and similarly for the other one.</p>",
        "id": 562814679,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765319880
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"556875\">@Pietro Monticone</span> for spotting this (using aristotle, that was actually able to prove that previous version is false)</p>",
        "id": 562819572,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765321874
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/541885-ItaLean-2025/topic/Projects.3A.20Quadratic.20Integers/near/562814679\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">d_2_or_3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≡</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMOD</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Fixed in <code>main</code>.</p>",
        "id": 563426028,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1765530593
    },
    {
        "content": "<p>The issue we discovered with <code>QuadraticAlgebra</code> has been fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/32797\">#32797</a>, which is now included in the latest version of mathlib. In my opinion, this is already a success for our project!</p>\n<p>For those interested, here is a brief explanation of the problem. Given any field <code>K</code> of characteristic zero, there are canonical maps <code>ℕ → K</code>, <code>ℤ → K</code>, and <code>ℚ → K</code>, which, for example, send <code>3</code> to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mn>1</mn><mi>K</mi></msub><mo>+</mo><msub><mn>1</mn><mi>K</mi></msub><mo>+</mo><msub><mn>1</mn><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">1_K + 1_K + 1_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7944em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7944em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7944em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\">1</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>. On paper, we simply write <code>3</code>, and if we need it to be an element of <code>K</code> we apply this map implicitly (for instance, we write <code>3 + x</code>, where <code>x : K</code>).</p>\n<p>In Lean, these maps exist and are called <em>coercions</em>. Lean inserts them automatically, allowing us to do mathematics as usual. You can still see them in the infoview: if <code>x : K</code> and you write <code>3 + x</code>, what actually appears is <code>3 + ↑x</code>. The upward arrow indicates that a map has been applied, but this is usually something you can ignore—Lean has found it for you, and you can move on.</p>\n<p>When <code>QuadraticAlgebra</code> was introduced, the authors decided to define the canonical map <code>R → QuadraticAlgebra R a b</code> as a coercion. Thus, if <code>r : R</code> and Lean expects a term of type <code>QuadraticAlgebra R a b</code>, one can simply write <code>r</code> rather than <code>somemap r</code>. Mathematically, this is just the canonical inclusion of <code>R</code> into the extension, so this choice seems reasonable.</p>\n<p>The problem arises in the (very common) situation where <code>R</code> is <code>ℚ</code> and <code>a</code> and <code>b</code> are such that <code>QuadraticAlgebra ℚ a b</code> is a field (of characteristic zero). In this case, there are <em>two</em> maps <code>ℚ → QuadraticAlgebra ℚ a b</code>: one coming from the general coercion <code>ℚ → K</code> for fields of characteristic zero, and one coming from the algebra structure. Of course, these two maps are equal mathematically, but they are not equal <em>by definition</em>, and Lean cannot recognize this on its own.</p>\n<p>In practice, this led to goals such as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">↑</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">x</span>\n</code></pre></div>\n<p>with <code>x : ℚ</code>, where <code>rfl</code> does not close the goal, because the two arrows actually correspond to different maps. While it is not difficult to prove that the two maps are equal, Lean repeatedly asks you to supply this proof, and the situation only worsens as the theory becomes more complicated.</p>\n<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/32797\">#32797</a>, I removed the coercion <code>R → QuadraticAlgebra R a b</code>, and as a result this problem completely disappeared. The drawback is that one now has to write the map explicitly, but it is simply <code>algebraMap</code>—the standard map from <code>R</code> to an <code>R</code>-algebra <code>A</code>, and nothing specific to <code>QuadraticAlgebra</code>. Moreover, mathlib provides many lemmas and good automation to work with it effectively.</p>",
        "id": 564005434,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765879931
    },
    {
        "content": "<p>What made things even more confusing is that there was also <em>another</em> issue, and at first I did not realize that one group was encountering one problem while the other group was facing the other.</p>\n<p>This second issue comes from the fact that <code>QuadraticAlgebra R a b</code> is, of course, always an <code>R</code>-algebra. In the situation discussed above, this means it is a <code>ℚ</code>-algebra. On the other hand, it is also a field of characteristic zero, and therefore again a <code>ℚ</code>-algebra. The problem is the same as above: these two structures are mathematically equal, but Lean fails to recognize this fact. This situation is what is known as a <em>diamond</em>.</p>\n<p>There are general techniques to resolve such situations, but for various reasons it is very difficult to fix this particular diamond. As a result, I ended up adding a warning advising users of <code>QuadraticAlgebra</code> that, when working over <code>ℚ</code>, they will probably want to deactivate the instance stating that a field of characteristic zero is a <code>ℚ</code>-algebra. This way, Lean can find only a single <code>ℚ</code>-algebra structure on <code>QuadraticAlgebra ℚ a b</code>, and the ambiguity disappears.</p>\n<p>Concretely, this is achieved by the line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"bp\">.</span><span class=\"n\">toRatAlgebra</span>\n</code></pre></div>\n<p>at the beginning of our file.</p>",
        "id": 564006620,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765880346
    },
    {
        "content": "<p>I've cleaned a bit the proofs (but the ideas are still the same) and erased the lemmas that are not needed at the end. You can see the final <a href=\"https://github.com/sacerdot/QuadraticIntegers/blob/main/QuadraticIntegers/RingOfIntegers.lean\">result</a> in the <code>main</code> branch.</p>",
        "id": 566940475,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1767878588
    }
]