[
    {
        "content": "<p>I wrote the following <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> which I think illustrates the kind of paper cuts I get stuck at for a while which I would think lean-auto could solve.</p>",
        "id": 547978999,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761840716
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Auto</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Loom</span><span class=\"bp\">.</span><span class=\"n\">MonadAlgebras</span><span class=\"bp\">.</span><span class=\"n\">NonDetT</span><span class=\"bp\">.</span><span class=\"n\">Extract</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Loom</span><span class=\"bp\">.</span><span class=\"n\">MonadAlgebras</span><span class=\"bp\">.</span><span class=\"n\">WP</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Loom</span><span class=\"bp\">.</span><span class=\"n\">MonadAlgebras</span><span class=\"bp\">.</span><span class=\"n\">WP</span><span class=\"bp\">.</span><span class=\"n\">DoNames'</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">CaseStudies</span><span class=\"bp\">.</span><span class=\"n\">Velvet</span><span class=\"bp\">.</span><span class=\"n\">Std</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">CaseStudies</span><span class=\"bp\">.</span><span class=\"n\">TestingUtil</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PartialCorrectness</span><span class=\"w\"> </span><span class=\"n\">DemonicChoice</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">DoNames</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">trust</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"bp\">.</span><span class=\"n\">solver</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"s2\">\"cvc5\"</span>\n\n<span class=\"n\">method</span><span class=\"w\"> </span><span class=\"n\">swapIndex</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a_swapped</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\">  </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">temp</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"n\">prove_correct</span><span class=\"w\"> </span><span class=\"n\">swapIndex</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">loom_solve</span><span class=\"w\"> </span><span class=\"c1\">-- nothing done</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 547979033,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761840723
    },
    {
        "content": "<p>CC : <span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span></p>",
        "id": 547979085,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761840733
    },
    {
        "content": "<p>why is <code>loom_solve</code> failing here?</p>",
        "id": 547979244,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761840783
    },
    {
        "content": "<p>Further, there doesn't seem to be a way to name  the <code>require</code>s so that I can use them for correct indexing (within the def)</p>",
        "id": 547980641,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761841197
    },
    {
        "content": "<p>I did manage to solve this manually btw:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">prove_correct</span><span class=\"w\"> </span><span class=\"n\">swapIndex</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">loom_solve</span>\n<span class=\"w\">    </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TArray</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">setIfInBounds</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">require_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">require_2</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 547984379,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761842143
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466334\">@Shreyas Srinivas</span> hey! Did you try running it with a new version of Loom? If not please run <code>lake update</code>. Now the default automation for Loom is <code>grind</code>. <br>\nAlso, of you want to use SMT solver tactics , such as <code>auto</code>, please make sure that you have cvc5 installed on your PATH</p>",
        "id": 554347148,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762528723
    },
    {
        "content": "<p>Hey I already have cvc5 on my path. I'll update now and try</p>",
        "id": 554347306,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762528766
    },
    {
        "content": "<p>One thing I am missing is the ability to name and use the <code>require</code>s and <code>ensures</code> of a procedure call (inside another procedure). I understand that you are generating Anonymous names for these</p>",
        "id": 554347539,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762528824
    },
    {
        "content": "<p>Example : if I call <code>swapIndex</code> from inside a (quicksort) partition function, I am not sure how I can get the  postcondition for size out of the call</p>",
        "id": 554348188,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762528995
    },
    {
        "content": "<p>Also it seems like you have a problem with your post-condition<br>\nwhen you write <br>\n<code>ensures a_swapped[i]! = a[j]!</code><br>\n<code>a_swapped </code> refers to a modified array <code>a</code>. But in the same time, because you pass <code>a</code> as a <em>mutable</em> argument <code>(mut a : Array Int)</code>, <code>a</code> in the post condition will be referring to a mutated version of <code>a</code></p>",
        "id": 554348795,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529154
    },
    {
        "content": "<p>Initially I didn't have <code>mut</code></p>",
        "id": 554348872,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762529173
    },
    {
        "content": "<p>you can try the following spec </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">method</span><span class=\"w\"> </span><span class=\"n\">swapIndex</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a_swapped</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\">  </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">aOld</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">ensures</span><span class=\"w\"> </span><span class=\"n\">a_swapped</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">aOld</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">temp</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 554348949,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529197
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/537981-Loom/topic/Paper.20cuts/near/554348872\">said</a>:</p>\n<blockquote>\n<p>Initially I didn't have <code>mut</code></p>\n</blockquote>\n<p>If you don't have <code>mut</code> then you cannot modify <code>a</code>. So you either need to use <code>mut</code> and then refer to the old variable as <code>aOld</code> or remove <code>mut</code> and create a local mutable variable inside the <code>method</code></p>",
        "id": 554349500,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529333
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/537981-Loom/topic/Paper.20cuts/near/554347539\">said</a>:</p>\n<blockquote>\n<p>One thing I am missing is the ability to name and use the <code>require</code>s and <code>ensures</code> of a procedure call (inside another procedure). I understand that you are generating Anonymous names for these</p>\n</blockquote>\n<p>That's right, we indeed do not support this feature. If you could create a GitHub issue for it, we will add it in a course of the week.</p>",
        "id": 554349900,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529425
    },
    {
        "content": "<p>I noticed that TArray is gone with this update and we now just use normal Lean Arrays. This is a nice change</p>",
        "id": 554350000,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762529449
    },
    {
        "content": "<p>Ah I didn't know one could access the old name as <code>aOld</code>. This helps</p>",
        "id": 554350169,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762529494
    },
    {
        "content": "<p>Yes, I am planning to do a bunch of other cosmetics changes soon!</p>",
        "id": 554350226,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529511
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/537981-Loom/topic/Paper.20cuts/near/554350169\">said</a>:</p>\n<blockquote>\n<p>Ah I didn't know one could access the old name as <code>aOld</code>. This helps</p>\n</blockquote>\n<p>You can refer to this documentation <a href=\"https://github.com/verse-lab/loom/blob/master/CaseStudies/Velvet/velvet_documentation.md\">https://github.com/verse-lab/loom/blob/master/CaseStudies/Velvet/velvet_documentation.md</a></p>",
        "id": 554350713,
        "sender_full_name": "Vladimir Gladstein",
        "timestamp": 1762529646
    }
]