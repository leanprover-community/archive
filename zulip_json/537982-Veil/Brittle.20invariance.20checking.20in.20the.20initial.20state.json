[
    {
        "content": "<p>I'm struggling to prove that invariants are true in the initial state.</p>\n<p>The attached file <a href=\"/user_uploads/3121/hpmIrWYqYSDN6wFGIt3-t6UV/Basic.lean\">Basic.lean</a> my current best minimization of the problem.  All six invariants fail to prove in the initial state.  In the initial state, p2c_tail=0 and c2p_tail=0, so the conjuncts N &lt; p2c_tail and N &lt; c2p_tail in the antecedents should be false, so the implications should be true.</p>\n<ul>\n<li>If I delete the unused <code>type value</code>, they prove.</li>\n<li>If I delete the last of the six invariants, they prove.</li>\n<li>If I add the invariant <code>p2c_tail = 0</code>, they prove.</li>\n</ul>\n<p>Any advice?</p>\n<p>My lakefile.toml includes </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"veil\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/verse-lab/veil.git\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"veil-2.0-preview\"</span>\n</code></pre></div>\n<p>My lean-toolchain is </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">27</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n</code></pre></div>\n<p>PS: When I insert to prove iteratively and delete the sorrys, they all prove immediately, but I can't see yet how to use those successful proofs with #check_invariants.</p>",
        "id": 573373343,
        "sender_full_name": "Mark R. Tuttle",
        "timestamp": 1770839057
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"717546\">@Mark R. Tuttle</span> This is unfortunately a bug, and it appears to be a bug in one of our dependencies, <a href=\"https://github.com/ufmg-smite/lean-smt\"><code>lean-smt</code></a>.</p>\n<p>Behind the scenes, when Veil solves a goal, it uses one of two tactics (that we defined), <code>veil_solve_wp</code> (for the kind of goals you get when you Cmd + Click) or <code>veil_solve_tr</code> (Cmd + Shift + Click).</p>\n<p>You can use <code>set_option veil.desugarTactic true</code> to see what those 'mean', in terms of lower- level tactics. It looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">veil</span><span class=\"bp\">.</span><span class=\"n\">desugarTactic</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">initializer_inv_0</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> parameters elided -/</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Veil</span><span class=\"bp\">.</span><span class=\"n\">VeilM</span><span class=\"bp\">.</span><span class=\"n\">meetsSpecificationIfSuccessfulAssuming</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">initializer</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">value_dec_eq</span><span class=\"w\"> </span><span class=\"n\">value_inhabited</span><span class=\"w\"> </span><span class=\"n\">χ</span><span class=\"w\"> </span><span class=\"n\">χ_rep</span><span class=\"w\"> </span><span class=\"n\">χ_rep_lawful</span><span class=\"w\"> </span><span class=\"n\">σ_sub</span><span class=\"w\"> </span><span class=\"n\">ρ_sub</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Assumptions</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">value_dec_eq</span><span class=\"w\"> </span><span class=\"n\">value_inhabited</span><span class=\"w\"> </span><span class=\"n\">ρ_sub</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Invariants</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">value_dec_eq</span><span class=\"w\"> </span><span class=\"n\">value_inhabited</span><span class=\"w\"> </span><span class=\"n\">χ</span><span class=\"w\"> </span><span class=\"n\">χ_rep</span><span class=\"w\"> </span><span class=\"n\">χ_rep_lawful</span><span class=\"w\"> </span><span class=\"n\">σ_sub</span><span class=\"w\"> </span><span class=\"n\">ρ_sub</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">inv_0</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">value_dec_eq</span><span class=\"w\"> </span><span class=\"n\">value_inhabited</span><span class=\"w\"> </span><span class=\"n\">χ</span><span class=\"w\"> </span><span class=\"n\">χ_rep</span><span class=\"w\"> </span><span class=\"n\">χ_rep_lawful</span><span class=\"w\"> </span><span class=\"n\">σ_sub</span><span class=\"w\"> </span><span class=\"n\">ρ_sub</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">veil_intros</span>\n<span class=\"w\">  </span><span class=\"n\">veil_wp</span>\n<span class=\"w\">  </span><span class=\"n\">veil_concretize_wp</span>\n<span class=\"w\">  </span><span class=\"n\">veil_fol</span>\n<span class=\"w\">  </span><span class=\"n\">veil_smt</span><span class=\"w\"> </span><span class=\"c1\">-- `simp` failed: maximum number of steps exceeded</span>\n</code></pre></div>\n<p>This is the error message displayed in the InfoView: <a href=\"/user_uploads/3121/fVNw1ELtUVQcIVlmVOVR4C_g/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/fVNw1ELtUVQcIVlmVOVR4C_g/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"922x248\" src=\"/user_uploads/thumbnail/3121/fVNw1ELtUVQcIVlmVOVR4C_g/image.png/840x560.webp\"></a></div><p>The problem is in the <code>smt</code>'s tactic <a href=\"https://github.com/ufmg-smite/lean-smt/tree/main/Smt/Preprocess/Embedding\">embedding</a> step (which performs simplifications to rewrite <code>Bool</code> into <code>Prop</code> and <code>Nat</code> into <code>Int</code>, such that proofs returned by cvc5 can be reconstructed). In this case, these simplifications go into a loop.</p>\n<p>All these goals are true and can be solved by <code>grind</code>.</p>\n<blockquote>\n<p>PS: When I insert to prove iteratively and delete the sorrys, they all prove immediately, but I can't see yet how to use those successful proofs with #check_invariants.</p>\n</blockquote>\n<p>We haven't yet implemented a way to hook back theorems proven interactively into the InfoView UI. The plan is you'll tag the relevant theorems with the <code>@[veil]</code> tag and the results will automatically update in the InfoView.</p>\n<p>Let me take a deeper look later today (Singapore time) and see if I can push a quick fix for this.</p>",
        "id": 573425123,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770864081
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"717546\">@Mark R. Tuttle</span> I've pushed a workaround  (<a href=\"https://github.com/verse-lab/veil-dev/commit/06552a51fbbb34aa01eb7f023a1ee0e502800eae\">commit <code>06552a5</code></a>) for now, that does more simplification on our side before we send the goals to Lean SMT.</p>\n<p>If you're running in a repository based on the <code>veil-usage-example</code> template, run <code>lake update &amp;&amp; lake build</code>. If you're operating in a clone of the Veil repo on the <code>veil-2.0-preview</code> branch,  run <code>git pull</code> first.</p>\n<p>Please let me know if this doesn't work for you or if you run into another issues!</p>\n<p>We'll be working with the upstream maintainers of Lean SMT to get this properly fixed before the Veil 2.0 release.  (There are also big performance issues with the embedding step which we hope to ameliorate.)</p>",
        "id": 573439032,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770874909
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span> Thanks.  I learned a lot from your answer.  The bug fix does work on the minimized example I sent you, but still fails in the same way on the full model.   I'll go ahead and append the full model.  <a href=\"/user_uploads/3121/fVom-ml2f5Zsa7G1DEPLODbs/Basic.lean\">Basic.lean</a></p>\n<p>This version has most actions commented out.  If you uncomment them you can see I\"m not done.  I'm going to ignore the initial state proofs and continue work on the other actions.</p>",
        "id": 573500595,
        "sender_full_name": "Mark R. Tuttle",
        "timestamp": 1770897195
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"717546\">@Mark R. Tuttle</span> I've reported the issue upstream: <a href=\"https://github.com/ufmg-smite/lean-smt/issues/215\">https://github.com/ufmg-smite/lean-smt/issues/215</a></p>\n<p>I'm writing my dissertation now, so unfortunately I don't have much time to go debugging. Sorry for the trouble!</p>",
        "id": 573513037,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770900809
    },
    {
        "content": "<p>I suspect the issue is particularly with the Lean SMT's embedding of <code>Nat</code>.</p>",
        "id": 573514035,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770901065
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"717546\">@Mark R. Tuttle</span> Please try <code>lake update &amp;&amp; lake build</code> again. </p>\n<p>It seems there's no actual loop in the simp rules for Lean SMT's embedding — it just has to do more rewrites than <code>simp</code> allows by default. I've pushed a <a href=\"https://github.com/verse-lab/lean-smt/commit/eea63e5ca4ba8c356d8cf751d5e286469a9bd616\">fix</a> on our fork of <code>lean-smt</code>.</p>\n<p>This makes the proofs go through for me on your full model.</p>",
        "id": 573553446,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770910542
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span> Thanks.  The invariants do pass with that fix.  In the mean time, I had rewritten the model to be relational as we discussed in a different thread and I'm getting simp errors on that model, but I may have done something stupid.</p>",
        "id": 573560805,
        "sender_full_name": "Mark R. Tuttle",
        "timestamp": 1770912205
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"717546\">@Mark R. Tuttle</span> I would have to see the model to figure out exactly what's going on, but it's probably another bug.</p>",
        "id": 573570686,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1770914434
    }
]