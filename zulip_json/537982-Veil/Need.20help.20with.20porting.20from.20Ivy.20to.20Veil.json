[
    {
        "content": "<p>Hi I'm trying to port the Apple open-source ord_live.ivy ordering model to Veil and I'm running into some issues</p>\n<p>I'm attaching a distilled test case (Main.lean in attachment) that reproduces the problem, and I modified the code to produce an artificial failure (negative testing). The model checkin part produces the correct behavior, but something goes wrong on the proof side. I only get a WP, but no TR CTI is produced</p>\n<p>The header in the following file gives some references to the model and has the distilled test case, and it mentions some CTI RFE (which are not crucial at this point)</p>\n<p><a href=\"/user_uploads/3121/U6dUipK0rWOlBXXO5d-9jyHF/Main.lean\">Main.lean</a></p>\n<p>Thanks</p>",
        "id": 576128380,
        "sender_full_name": "Asgeir Eiriksson",
        "timestamp": 1772142138
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1005258\">@Asgeir Eiriksson</span> I'm taking a look now and will get back to you as soon possible.</p>",
        "id": 576161863,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772156889
    },
    {
        "content": "<p>I've identified the root cause and am working on a fix.</p>",
        "id": 576168222,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772161721
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1005258\">@Asgeir Eiriksson</span> I've pushed a <a href=\"https://github.com/verse-lab/veil/commit/1902577063f0d9094ca097ad9fa9982931ef8791\">fix</a>.</p>\n<p>If you're running in a repository based on the <code>veil-usage-example</code> template, run <code>lake update &amp;&amp; lake build</code>. If you're operating in a clone of the Veil repo on the <code>veil-2.0-preview</code> branch, run <code>git pull</code> first.</p>",
        "id": 576182110,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772169792
    },
    {
        "content": "<p>The comment in the file also mentions:</p>\n<blockquote>\n<p>in other cases seen wrong TR CTI</p>\n</blockquote>\n<p>Could you please expand on that? What is the issue?</p>",
        "id": 576182184,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772169864
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1005258\">@Asgeir Eiriksson</span> Hi, do you plan to port the liveness proofs?</p>\n<p>Previously we've verified some of the proof rules from <a href=\"https://link.springer.com/chapter/10.1007/978-3-031-65627-9_13\">that paper</a> using <a href=\"https://github.com/verse-lab/Lentil\">our LTL library</a>. Their proofs are currently in a private GitHub repo, but we'd be happy to give you access if that would be useful.</p>\n<p>Since we're planning to add liveness support to Veil, it could be a good opportunity to work together on porting the liveness proofs if you're interested.</p>",
        "id": 576183053,
        "sender_full_name": "Qiyuan Zhao",
        "timestamp": 1772170522
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1005258\">@Asgeir Eiriksson</span> </p>\n<blockquote>\n<p><code>CTI print numeric values of enum e.g. 0 instead of symbolic name e.g. write</code></p>\n</blockquote>\n<p>I've made it such that CTIs <a href=\"https://github.com/verse-lab/veil/commit/5068ba55c0cc7da9152ce56c4cf812183a9467a3\">now</a> show the symbolic name for enums, rather than a numeric value.</p>\n<blockquote>\n<p><code>CTI don't trace the execution with line numbers</code></p>\n</blockquote>\n<p>Getting line-by-line execution traces would be a lot more involved, unfortunately. We're not currently planning to add that.</p>\n<blockquote>\n<p><code>CTI don't print T0, T1</code></p>\n</blockquote>\n<p>I think this should already work. It's perhaps a bit confusing because the \"Extra values\" panel is collapsed by default. (Please let me know if that's indeed what's going on.) </p>\n<p><a href=\"/user_uploads/3121/qTtew8131v74qm0CnsqSVsGu/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/qTtew8131v74qm0CnsqSVsGu/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"990x250\" src=\"/user_uploads/thumbnail/3121/qTtew8131v74qm0CnsqSVsGu/image.png/840x560.webp\"></a></div>",
        "id": 576192455,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772176207
    },
    {
        "content": "<p>I also noticed the Lean server crashes due to the <code>#model_check</code> InfoView widget, apparently when the widget unloads, with errors like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Watchdog</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Got</span><span class=\"w\"> </span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"s2\">\"refs\"</span><span class=\"o\">:[{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"s2\">\"0\"</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"s2\">\"0\"</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"s2\">\"0\"</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"s2\">\"0\"</span><span class=\"o\">},{</span><span class=\"s2\">\"p\"</span><span class=\"o\">:</span><span class=\"s2\">\"0\"</span><span class=\"o\">}],</span><span class=\"s2\">\"sessionId\"</span><span class=\"o\">:</span><span class=\"s2\">\"15898261356649562253\"</span><span class=\"o\">,</span><span class=\"s2\">\"uri\"</span><span class=\"o\">:</span><span class=\"s2\">\"file:///src/veil/Examples/Main.lean\"</span><span class=\"o\">}</span>\n<span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">RpcReleaseParams</span><span class=\"bp\">.</span><span class=\"n\">refs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">RpcRef</span><span class=\"bp\">.</span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">expected</span>\n</code></pre></div>\n<p><del>I'll have to look more deeply into what's going on there, but probably won't have time for it very soon. We're still waiting for the upstream <a href=\"https://github.com/leanprover-community/ProofWidgets4/pull/141\">refreshable widget component</a>  to get merged (we have a custom version of that vendored inside the Veil repo for now).</del></p>\n<p><strong>Later edit:</strong> Codex identified the issue. It's a bug in the Lean InfoView. It <a href=\"https://github.com/leanprover/vscode-lean4/blob/master/lean4-infoview-api/src/rpcSessions.ts#L130-L146\">treats</a>  any subobject <code>{'p': v}</code> as an RPC reference. Since this spec has actions with a parameter named <code>p</code>, the JSON traces we send to the InfoView get treated as RPC objects <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>\n<p>I've submitted the issue upstream: <a href=\"https://github.com/leanprover/vscode-lean4/issues/712\">https://github.com/leanprover/vscode-lean4/issues/712</a></p>",
        "id": 576194688,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772177460
    },
    {
        "content": "<p>As a workaround for now, you can rename the parameter <code>p</code> of <code>step_north</code>... <span aria-label=\"dizzy\" class=\"emoji emoji-1f635\" role=\"img\" title=\"dizzy\">:dizzy:</span></p>",
        "id": 576209576,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772183105
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"542918\">@George Pîrlea</span> <br>\nThanks for the quick response!</p>\n<p>There is one issue remaining having to do with the \"assert! ¬ prevents min_arr\" that I've commented out in the test file. When I comment out the \"if prevents min_arr\" instead and remove the comment on the assert, then bad things happen</p>\n<p>The bad TR CTI I mentioned probably had something to do with the issue that you fixed</p>\n<p>I now plan to continue the port of the ord_live.ivy safety properties to lean</p>",
        "id": 576369127,
        "sender_full_name": "Asgeir Eiriksson",
        "timestamp": 1772237730
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"689027\">@Qiyuan Zhao</span> </p>\n<p>Yes, I'm hoping to port the liveness proofs too, and it's great you already have some of the proof rules working, and I'd be happy to try to port them once you think they're stable</p>\n<p>The ord_live2.ivy (same directory in ivy repository as ord_live.ivy) has the ranking tactic that I find very useful, and at this point we primarily use that tactic and l2s_auto4 when the ranking tactic is not a fit</p>",
        "id": 576369806,
        "sender_full_name": "Asgeir Eiriksson",
        "timestamp": 1772238308
    },
    {
        "content": "<blockquote>\n<p>Thanks for the quick response!</p>\n</blockquote>\n<p>You're very welcome!</p>\n<p>Please do keep getting back to us with issues you encounter. We're happy to fix them.</p>\n<blockquote>\n<p>When I comment out the \"if prevents min_arr\" instead and remove the comment on the assert, then bad things happen</p>\n</blockquote>\n<p>Ah, I see what you mean. This is a bug.  As a workaround for now, you can inline the definition of the ghost relation, e.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"n\">LClock</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">min_arr</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">ltime</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">evs_loc</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dramc_l</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"n\">min_arr</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)))</span>\n</code></pre></div>",
        "id": 576370109,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1772238550
    },
    {
        "content": "<p>I just pushed a fix and hopefully it resolves the error <code>could not synthesize default value for parameter 'st' using tactics</code>, if that's the bad thing you are referring to. </p>\n<blockquote>\n<p>I'm hoping to port the liveness proofs too, and it's great you already have some of the proof rules working, and I'd be happy to try to port them once you think they're stable</p>\n</blockquote>\n<p>That sounds great! At the moment, since Veil doesn't yet have built-in support for liveness reasoning, using those rules still requires manual setup, so I wouldn't quite call the development \"stable\" in that sense. I'll get back to you once things are in a better shape.</p>",
        "id": 576393879,
        "sender_full_name": "Qiyuan Zhao",
        "timestamp": 1772258467
    }
]