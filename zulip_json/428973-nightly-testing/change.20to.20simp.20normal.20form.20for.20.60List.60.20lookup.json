[
    {
        "content": "<p>This is giving everyone a heads-up that I'd like to implement a significant change to simp normal forms, and that this will include changes to Lean / Batteries / Mathlib.</p>\n<p>We want <code>L[i]</code> (which is implicitly <code>L[i]'h</code>, where <code>h : i &lt; L.length</code>) to be the simp normal form for List lookup, rather than <code>L.get ⟨i, h⟩</code>. We think this is a much better experience for new users, and aligns better with the <code>Array</code> normal forms.</p>\n<p>I've implemented this as <a href=\"https://github.com/leanprover/lean4/pull/4400\">lean#4400</a>, and the corresponding patches to Batteries and Mathlib are at </p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/batteries/pull/843\">batteries#843</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/13815\">#13815</a></li>\n</ul>\n<p>You'll notice upon looking at these diffs that I have replaced many functions involving <code>get?</code>/<code>get</code> with functions involving <code>L[i]?</code>/<code>L[i]</code>, and in nearly all cases I have deprecated the old functions. I am willing to remove some (or even many) of these deprecations if there is a case for it --- they were useful to me to help make more thorough changes. I will note that (perhaps with one or two exceptions, I'll have to double check) all of these deprecations are actually respected (i.e. no longer used at all), and so in the interests in minimising the explosion of the API surface area I do prefer that we keep as many of these deprecations as possible.</p>",
        "id": 444583753,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1718322862
    },
    {
        "content": "<p>I haven't looked through all of it yet but this feels like a breath of fresh air! <span aria-label=\"fresh air\" class=\"emoji emoji-1fa9f\" role=\"img\" title=\"fresh air\">:fresh_air:</span></p>",
        "id": 444585063,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1718323810
    },
    {
        "content": "<p>I'm hoping that the fact that all the downstream consequences work out okay means we can proceed on this pretty soon. Obviously once <a href=\"https://github.com/leanprover-community/mathlib4/pull/4400\">#4400</a> is merged we're setting a big train in motion.</p>",
        "id": 444585178,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1718323947
    },
    {
        "content": "<p>I'm in favor of keeping all the deprecations. That will help me and others update their code to the new normal.</p>",
        "id": 444585595,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1718324295
    },
    {
        "content": "<p>Are you looking for optimizations or just a checkmark?</p>",
        "id": 444588383,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1718326329
    },
    {
        "content": "<p>Very happy to have suggested changes to any of the 3 PRs. But mostly just giving notice before we actually set things in motion. :-)</p>",
        "id": 444588552,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1718326492
    },
    {
        "content": "<p>Integrated CI has now succeeded, so I'll plan to start merging over the weekend.</p>",
        "id": 444603437,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1718335636
    },
    {
        "content": "<p>What's the performance cost?</p>",
        "id": 444613511,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1718340288
    },
    {
        "content": "<p>I was updating LeanColls to a new version today and ran into a deprecation -- <code>List.get_append_left</code>.  I rely pretty heavily on <code>List.get</code> because I want Lean to infer <code>Fin L.length</code> often.</p>\n<p>If that is no longer going to be a supported simp normal form then I'd maybe prefer <code>List.get</code> be deprecated too, since otherwise we will be left with a function with no API... (I was surprised that <code>List.get_append_left</code> was deprecated and went on a search to figure out why!)</p>",
        "id": 449420251,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1720227925
    },
    {
        "content": "<p>I'm actually pretty happy to roll back some (many!) of these deprecations on theorems.</p>\n<p>We're not going to deprecate <code>List.get</code> itself, certainly. It's not too hard to find places in Mathlib where we're trying to do some <code>Fin</code> indexed combinatorics and <code>get</code> is the right tool. However generally I've been finding that while it's useful in the definitions, in proofs the new simp normal form means we rarely need the theorems directly about <code>get</code>.</p>",
        "id": 449564303,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720302507
    },
    {
        "content": "<p>It's usually fine to have \"a function with no API\" as long as there's a simp lemma that immediately rewrites it to a function that does have API.</p>",
        "id": 449564358,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720302588
    },
    {
        "content": "<p>I'd love to see a more concrete description of what goes wrong for your use case if you switch to using <code>GetElem</code>.</p>",
        "id": 449564491,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720302697
    },
    {
        "content": "<p>Makes sense. I was able to rewrite my proofs without too much headache (the <a href=\"https://github.com/JamesGallicchio/LeanColls/commit/6baefbe0cd95584f57b8ec0a9f7dc5e50c8d5d00#diff-e50360ae8388a3173aeeae7d792872c8960553840f7a9e1375f2fe925825a244\">diff</a> isn't too helpful)</p>",
        "id": 449566439,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1720304055
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/428973-nightly-testing/topic/change.20to.20simp.20normal.20form.20for.20.60List.60.20lookup/near/449564303\">said</a>:</p>\n<blockquote>\n<p>I've been finding that while it's useful in the definitions, in proofs the new simp normal form means we rarely need the theorems directly about <code>get</code>.</p>\n</blockquote>\n<p>I don't think this is sufficient reason for deprecation, this just means it shouldn't be a simp lemma</p>",
        "id": 449570587,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720306137
    },
    {
        "content": "<p>it's also not cool to upstream lemmas from batteries and then deprecate/remove them; just put them back where they came from if you are going to do that</p>",
        "id": 449570892,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720306219
    },
    {
        "content": "<p>It is certainly useful to at least temporarily have the <code>@[deprecated]</code> on all these lemmas: it's really helpful when switching over downstream libraries to use the new preferred API to have warnings on all the places where proofs are detouring back via the old API.</p>\n<p>But I agree that in the long run the lemmas should not actually be deleted while <code>List.get</code> still exists (which I think should be forever!).</p>\n<p>How about I leave these as <code>@[deprecated]</code> for now, in the hope that helps people switch, but when it is \"time to delete\" them in core I will instead drop them back into Batteries?</p>",
        "id": 449664896,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720362267
    }
]