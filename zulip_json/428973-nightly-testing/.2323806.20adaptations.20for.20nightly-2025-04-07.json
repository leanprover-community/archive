[
    {
        "content": "<blockquote>\n<p>chore: adaptations for nightly-2025-04-07 <a href=\"https://github.com/leanprover-community/mathlib4/pull/23806\">#23806</a> Please review this PR. At the end of the month this diff will land in 'master'.</p>\n</blockquote>",
        "id": 510833106,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744085457
    },
    {
        "content": "<p>Wowzems! This one is massive!</p>",
        "id": 510833268,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744085553
    },
    {
        "content": "<p>We were unsync'd all weekend. :-(</p>",
        "id": 510836443,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744087456
    },
    {
        "content": "<p>A big chunk of it is <a href=\"https://github.com/leanprover/lean4/pull/7824\">lean#7824</a>, which requires many new <code>noncomputable</code> modifiers. There will be more churn here as the new compiler comes online, so I'm not too concerned about the individual movements.</p>",
        "id": 510836584,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744087559
    },
    {
        "content": "<p>There's quite a lot of regression of dot notation, also. <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, do you know the origin of this?</p>",
        "id": 510836677,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744087601
    },
    {
        "content": "<p>Otherwise, some minor changes resulting from upstreamed material on <code>Int.gcd</code>, some <code>Option</code> API changes, and Mario's fix for the path issue in <code>cache</code>.</p>",
        "id": 510836941,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744087789
    },
    {
        "content": "<p>One annoying fallout of the new <code>noncomputable</code> modifiers was that I removed <code>deriving Inhabited</code> for <code>Hyperreal</code>, because it can't cope with putting on <code>noncomputable</code> itself. If anyone wants to fix this up (e.g. just trying out <code>noncomputable section</code>?), please go ahead, but the instance isn't urgently missed, I think.</p>",
        "id": 510837116,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744087885
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/510836677\">said</a>:</p>\n<blockquote>\n<p>There's quite a lot of regression of dot notation, also. <span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span>, do you know the origin of this?</p>\n</blockquote>\n<p>That's dot notation that should never have worked. It's all taking advantage of a bug where if you write nested dot notation <code>x.f.g</code> where <code>x.f</code> resolves as generalized field notation to a function <code>X.f</code>, then it passed <code>x</code> as the first explicit argument of <code>X.f</code>, rather than following the type-directed algorithm.</p>\n<p>For example, <code>f.hom.range.mkQ</code> was resolving to <code>(LinearMap.range f.hom).mkQ</code>, even though <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearMap.range#doc\">docs#LinearMap.range</a> doesn't have a <code>LinearMap</code> argument. This bug only applied to nested dot notation, and only for everything but the last one (so <code>hom</code>, <code>range</code>, but not <code>mkQ</code>)</p>\n<p>This is something we can get to work in many of the cases using an unmerged new feature (<a href=\"https://github.com/leanprover/lean4/pull/6267\">lean4#6267</a>), but in the meantime I don't think we need to annotate these dot notation fixes. It might be a regression with respect to what we'd like to write, but given the current rules of dot notation, the adaptations are correcting a mistake in mathlib.</p>",
        "id": 510990020,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744133413
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/510837116\">said</a>:</p>\n<blockquote>\n<p>I removed <code>deriving Inhabited</code> for <code>Hyperreal</code></p>\n</blockquote>\n<p>I think it makes sense not to have global noncomputable <code>Inhabited</code> instances, and we should prefer a <code>Nonempty</code> instance to prevent \"poisoning\" computability of the set of <code>Inhabited</code> instances. It's like how we prefer a global <code>Finite</code> over <code>Fintype</code> if the instance can't be computable.</p>",
        "id": 510990505,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744133589
    },
    {
        "content": "<p>In this case I think we could also just <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0ARFJHAJQFMl0cAJATzFKinPQCgXgA7AZxiQ4GNScAFxwAkh1RIswGKQAmcWvUbMRAXjiAL8mUMmFHBABmZCnAAUABhFxAuIQBKQJfkQA\">make a computable inhabited instance from <code>Hyperreal.ofReal 0</code></a></p>",
        "id": 511004770,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744138217
    },
    {
        "content": "<p>So lemme get this straight: when reviewing the PR we should (a) ignore all the \"regressions\" in dot notation because they shouldn't have worked anyway so they're not regressions and (b) ignore all the \"regressions\" with noncomputable modifiers because chaos is to be expected as we switch to the new compiler so there's no need to mark them as regressions? I can see Kyle's argument for dot notation but should we be writing <code>-- note: noncomputable regression caused by lean#7824</code> by all the new noncomputable modifiers?</p>",
        "id": 511029299,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744147928
    },
    {
        "content": "<p>No notes for the noncomputables, please. I'm pretty confident they are not going to disturb anyone.</p>",
        "id": 511041923,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744154339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/510990020\">said</a>:</p>\n<blockquote>\n<p>For example, <code>f.hom.range.mkQ</code> was resolving to <code>(LinearMap.range f.hom).mkQ</code>, even though <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearMap.range#doc\">docs#LinearMap.range</a> doesn't have a <code>LinearMap</code> argument. This bug only applied to nested dot notation, and only for everything but the last one (so <code>hom</code>, <code>range</code>, but not <code>mkQ</code>)</p>\n</blockquote>\n<p>This is pretty worrisome. This function has the look of one that used to take a <code>LinearMap</code> argument and later got generalized to some typeclasses, and I'm pretty sure we would not have wanted to generalize it (or we would have done it differently) if we knew it would break dot notation.</p>",
        "id": 511086692,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744180121
    },
    {
        "content": "<p>I personally think this should be reverted back to taking a plain linear map. This would eg make <a href=\"https://github.com/leanprover-community/mathlib4/pull/21031\">#21031</a> much easier to achieve</p>",
        "id": 511087529,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744180468
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> This is only affecting <code>f.range.blah</code>, not <code>f.range</code> without further dot notation. Are you suggesting that when <code>LinearMap.range</code> was generalized, it was only ever used with chained dot notation so nobody noticed? That seems very unlikely.</p>\n<p>When adapting, I frequently saw theorems that used such functions both with and without dot notation in the same statement. It was always <code>LinearMap.range f</code> rather than <code>f.range</code> where dot notation doesn't work.</p>",
        "id": 511100663,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744185091
    },
    {
        "content": "<p>I mean more that it could be that this bug artificially reduced the regression during such generalization, and this seems like a way to get around our regression tolerances in review</p>",
        "id": 511101075,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744185215
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/511086692\">said</a>:</p>\n<blockquote>\n<p>I'm pretty sure we would not have wanted to generalize it [...] if we knew it would break dot notation.</p>\n</blockquote>\n<p>From <a href=\"https://github.com/leanprover-community/mathlib3/pull/16105\">mathlib3#16105</a> three years ago, it's clear from the diff that Frédéric Dupuis knew it broke dot notation. Your new point about missing regressions due to Lean bugs is valid on its own, but I don't see how that's relevant to this particular case.</p>\n<p>It's interesting how this bug goes so far back. I tried to fix this in Lean 3 with <a href=\"https://github.com/leanprover/lean3/pull/757\">lean3#757</a>, but it turns out I left in a version of it to preserve the <code>has_coe_to_fun</code> feature/oversight (which has officially made it into Lean 4 with <a href=\"https://github.com/leanprover/lean4/pull/5692\">lean4#5692</a>). That Lean 3 PR was done a few days after <a href=\"https://github.com/leanprover-community/mathlib3/pull/16105\">mathlib3#16105</a> was merged, so at least I'm not the initial cause!</p>\n<p>From the Lean 3 PR description, this is why the dot notations survived in mathlib 3:</p>\n<blockquote>\n<p>To preserve reverse compatibility, we (temporarily?) add a feature that if the elaborator fails to find an explicit argument corresponding to the structure, it will insert the structure as the first explicit argument.</p>\n</blockquote>\n<p>I also said \"It is not currently compatible with Lean 4.\" I had no idea at the time that nested dot notation could trigger a similar bug in Lean 4. That surprise compatibility would let such terms persist for another two years! (Port PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/1979\">mathlib4#1979</a>)</p>",
        "id": 511109241,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744187373
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/511087529\">said</a>:</p>\n<blockquote>\n<p>I personally think this should be reverted back to taking a plain linear map. This would eg make <a href=\"https://github.com/leanprover-community/mathlib4/pull/21031\">#21031</a> much easier to achieve</p>\n</blockquote>\n<p>Do you think this even given the fact that the <code>dotParam</code> widget (<a href=\"https://github.com/leanprover/lean4/pull/6267\">lean4#6267</a>) would make these uses of dot notation work? Remember that dot notation also takes advantage of <code>export</code>ed names now.</p>\n<p>(If the widget does get merged, one could later use the commits in <code>lean-pr-testing-7816</code> to revert the changes after the next release — I don't think it's appropriate to add <code>dotParam</code> to mathlib from within adaptation PRs at this point.)</p>",
        "id": 511127588,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744192301
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/510836584\">said</a>:</p>\n<blockquote>\n<p>A big chunk of it is <a href=\"https://github.com/leanprover/lean4/pull/7824\">lean#7824</a>, which requires many new <code>noncomputable</code> modifiers. There will be more churn here as the new compiler comes online, so I'm not too concerned about the individual movements.</p>\n</blockquote>\n<p>I've added adaptation notes to the two <code>noncomputable</code>s that were flagged by <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> and <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>  in review.</p>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, would you be able to investigate if this can be worked around? If you find something, just push to <code>nightly-testing</code> and we'll review in the next adaptation PR.</p>\n<p>If you're convinced it <em>can't</em> be worked around, we can escalate it to Cameron, but if we can avoid that I'd prefer to let him continue getting us the new compiler. :-)</p>",
        "id": 511150192,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744199484
    },
    {
        "content": "<p>I think otherwise we're <code>will-merge-soon</code> here?</p>",
        "id": 511150247,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744199504
    },
    {
        "content": "<p>No time today. Maybe tomorrow</p>",
        "id": 511151102,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744199730
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/511150192\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/.2323806.20adaptations.20for.20nightly-2025-04-07/near/510836584\">said</a>:</p>\n<blockquote>\n<p>A big chunk of it is <a href=\"https://github.com/leanprover/lean4/pull/7824\">lean#7824</a>, which requires many new <code>noncomputable</code> modifiers. There will be more churn here as the new compiler comes online, so I'm not too concerned about the individual movements.</p>\n</blockquote>\n<p>I've added adaptation notes to the two <code>noncomputable</code>s that were flagged by <span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> and <span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span>  in review.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span>, would you be able to investigate if this can be worked around? If you find something, just push to <code>nightly-testing</code> and we'll review in the next adaptation PR.</p>\n<p>If you're convinced it <em>can't</em> be worked around, we can escalate it to Cameron, but if we can avoid that I'd prefer to let him continue getting us the new compiler. :-)</p>\n</blockquote>\n<p>The argument you made about Set.monoid is fairly convincing, and makes me reframe this as revealing a problem already present in mathlib rather than creating a new problem, so I'm content with this as it stands.</p>",
        "id": 511181705,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744207157
    }
]