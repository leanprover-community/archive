[
    {
        "content": "<p>I've got started this morning on moving our <code>nightly-testing</code> infrastructure to a fork. (So that we can give out write access to people involved in keeping it alive!)</p>\n<p>So far:</p>\n<ul>\n<li>I've created a fork <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing\">https://github.com/leanprover-community/mathlib4-nightly-testing</a>, and copied across <code>nightly-testing</code> (which is set as the default branch -- there is no <code>master</code> on this fork, to avoid confusion), all the <code>lean-pr-testing-NNNN</code> branches, and all the <code>batteries-pr-testing-NNNN</code> branches.</li>\n<li><a href=\"https://github.com/leanprover/lean4/pull/8933\">lean#8933</a> changes the Lean4 side of CI, so that future <code>lean-pr-testing-NNNN</code> branches will be created on this fork.</li>\n</ul>\n<p>Ongoing:</p>\n<ul>\n<li>change everything on the mathlib4 and batteries side of things</li>\n<li>see what is broken, fix it</li>\n<li>give write access on this fork</li>\n<li>eventually, remove the migrated branches from the main repository.</li>\n</ul>\n<p>Note that I intend that the <code>bump/v4.X.0</code> branches will continue to live on the main repository: no one needs write access to these except a few maintainers.</p>",
        "id": 525242440,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750639618
    },
    {
        "content": "<p>(I'm recording progress on updating repository secrets and bot access in the CI admins private channel.)</p>",
        "id": 525244205,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750642098
    },
    {
        "content": "<p>Slight update to the plan --- the reviewed <code>bump/v4.X.0</code> branches, as well as the unreviewed PR branches <code>bump/nightly-YYYY-MM-DD</code> will <em>also</em> live on the new fork, rather than the main repo.</p>",
        "id": 525244637,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750642610
    },
    {
        "content": "<p>Okay, <a href=\"https://github.com/leanprover-community/mathlib4/pull/26286\">#26286</a> is my attempt at reconfiguring all the CI infrastructure to work from the new fork.</p>",
        "id": 525246492,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750645061
    },
    {
        "content": "<p>I have tested <em>nothing</em>, this is all speculative. Review appreciated, but I'd also like to start trying it out in production asap.</p>",
        "id": 525246511,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750645086
    },
    {
        "content": "<p>I have created an team <a href=\"https://github.com/orgs/leanprover-community/teams/nightly-testing\">https://github.com/orgs/leanprover-community/teams/nightly-testing</a>, to which we should add trusted people who need write access to the new fork.</p>",
        "id": 525246858,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750645637
    },
    {
        "content": "<p>I'm also transitively giving members of lean-fro write access, as they often need to be able to update lean-pr-testing-NNNN branches.</p>",
        "id": 525246926,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750645739
    },
    {
        "content": "<p>I am now pausing on this job, awaiting someone to give a +1 for merging the two PRs above, so we can start testing for real.</p>",
        "id": 525246948,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750645774
    },
    {
        "content": "<p>Oh, one more: <a href=\"https://github.com/leanprover-community/batteries/pull/1287\">batteries#1287</a></p>",
        "id": 525247150,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750646005
    },
    {
        "content": "<p>Does <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing\">https://github.com/leanprover-community/mathlib4-nightly-testing</a> have a cache yet? If it does, how do I configure things to use it?</p>\n<p>All I've done is create a new remote for this repo and then make my <code>nightly-testing</code> branch track it.</p>",
        "id": 525434698,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750734730
    },
    {
        "content": "<p>That should suffice. (But presumably things are still broken.) What are you seeing?</p>",
        "id": 525436443,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750736501
    },
    {
        "content": "<p>To avoid confusion, I am about to delete the nightly-testing branch on our main repo, so everything has to work with the nightly-testing fork or fail.</p>",
        "id": 525436627,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750736648
    },
    {
        "content": "<p>Yeah, for me it is only looking for the oleans on leanprover-community/mathlib4 and kim-em/mathlib4</p>",
        "id": 525436840,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750736783
    },
    {
        "content": "<p>I think there is a hardcoded place in <code>Cache</code> where we tell it how to deal with nightly-testing, and this is now wrong.</p>",
        "id": 525436864,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750736803
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/moving.20to.20a.20fork/near/525436443\">said</a>:</p>\n<blockquote>\n<p>What are you seeing?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Mathlib repository: leanprover-community/mathlib4\nAttempting to download 6876 file(s) from leanprover-community/mathlib4 cache\nDownloaded: 0 file(s) [attempted 6876/6876 = 100%] (0% success)\nWarning: some files were not found in the cache.\nThis usually means [...]\n</code></pre></div>",
        "id": 525438317,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750737923
    },
    {
        "content": "<p>Fixing now.</p>",
        "id": 525438647,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750738212
    },
    {
        "content": "<p>At least, the download logic. I think the oleans aren't being pushed at all anyway. :-(</p>",
        "id": 525438660,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750738227
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26334\">#26334</a> feat: cache uses the nightly-testing cache when relevant</p>",
        "id": 525439054,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750738583
    },
    {
        "content": "<p>This at least causes <code>cache</code> to <em>look</em> for oleans in the right place. Why they are not there remains to be seen. :-)</p>",
        "id": 525439081,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750738611
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/15853386008/job/44692443836\">https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/15853386008/job/44692443836</a> I fixed <code>nighty-testing</code>. The build step does</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">upload</span><span class=\"w\"> </span><span class=\"mi\">6876</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"n\">nightly</span><span class=\"bp\">-</span><span class=\"n\">testing</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>\n<p>but the Post-build-step tries</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">6876</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>\n<p>and then</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">6876</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"n\">nightly</span><span class=\"bp\">-</span><span class=\"n\">testing</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>\n<p>but both with <code>(0% success)</code>.</p>\n<hr>\n<p>Hmm, I thought I had something to add, but that wasn’t worth adding.</p>\n<p>I wonder if it’s maybe a difference in trace keys. But the existing logs don’t seem to convey which key the cache is looking for.</p>",
        "id": 525545375,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750779232
    },
    {
        "content": "<p>We'll need to update <a href=\"https://leanprover-community.github.io/contribute/tags_and_branches.html\">https://leanprover-community.github.io/contribute/tags_and_branches.html</a> once this stabilizes.</p>",
        "id": 525668236,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750842776
    },
    {
        "content": "<p>Wow that's outdated (Std4?)</p>",
        "id": 525682560,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750847768
    },
    {
        "content": "<p>How do we do mathlib benchmarks for Lean 4 PRs now? I (accidentally) created a PR for <code>mathlib4-nightly-testing</code> (<a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/1\">https://github.com/leanprover-community/mathlib4-nightly-testing/pull/1</a>) but the speed center appears not to be listening to <code>!bench</code> there.</p>\n<p>If I created a similar PR for <code>mathlib4</code>, what do I need to do to be sure that the speed center will compare the effects of just the change in Lean? I worry that it will give me a comparison between some random old version of mathlib and my changes.</p>",
        "id": 525962898,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750963369
    },
    {
        "content": "<p>If in doubt, create PRs in mathlib4 for both commits you want to compare, and run <code>!bench</code> on both, and then select the runs for comparison. A bit tedious, I agree.</p>",
        "id": 525967228,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750965367
    }
]