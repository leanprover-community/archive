[
    {
        "content": "<p>Can someone explain to me what happened in the history of <code>nightly-testing</code>?</p>\n<p>Specifically, look at <a href=\"https://github.com/leanprover-community/mathlib4/commits/nightly-testing/Mathlib/Data/BitVec.lean\">https://github.com/leanprover-community/mathlib4/commits/nightly-testing/Mathlib/Data/BitVec.lean</a></p>\n<p>In the past two days, we have had some changes to <code>Mathlib/Data/BitVec.lean</code> on master. But somehow those didn't faithfully end up in <code>nightly-testing</code>, leaving the file in a broken state.</p>\n<p>I think the following merge commit just dropped a lemma: <a href=\"https://github.com/leanprover-community/mathlib4/commit/b57c9b7f461c042a5bf8c4d33f7bc6d396a166ff#diff-6775cfd199bc623efa28ab83f50cb425439c6b8e61620229a231e9f8f17a280c\">https://github.com/leanprover-community/mathlib4/commit/b57c9b7f461c042a5bf8c4d33f7bc6d396a166ff#diff-6775cfd199bc623efa28ab83f50cb425439c6b8e61620229a231e9f8f17a280c</a></p>\n<p>But I don't see that in the github web view. However, when I look at that commit in gitk, I see</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gu\">@@@ -63,10 -68,17 +68,10 @@@ instance : CommSemiring (BitVec w) :</span>\n<span class=\"w\"> </span>     (fun _ =&gt; rfl) /- toFin_natCast -/\n<span class=\"w\"> </span> -- The statement in the new API would be: `n#(k.succ) = ((n / 2)#k).concat (n % 2 != 0)`\n\n<span class=\"w\"> </span>--- Variant of `Fin.intCast_def` for when we are using the `Fin.CommRing` instance.\n<span class=\"w\"> </span>-open Fin.CommRing in\n<span class=\"w\"> </span>-theorem _root_.Fin.intCast_def' {n : Nat} [NeZero n] (x : Int) :\n<span class=\"w\"> </span>-    (x : Fin n) = if 0 ≤ x then Fin.ofNat n x.natAbs else -Fin.ofNat n x.natAbs := by\n<span class=\"w\"> </span>-  unfold Fin.instCommRing\n<span class=\"w\"> </span>-  dsimp [Int.cast, IntCast.intCast, Int.castDef]\n<span class=\"w\"> </span>-  split &lt;;&gt; (simp [Fin.intCast]; omega)\n<span class=\"w\"> </span>-\n<span class=\"w\"> </span>+-- TODO: move to the Lean4 repository.\n<span class=\"w\"> </span> @[simp] theorem _root_.Fin.val_intCast {n : Nat} [NeZero n] (x : Int) :\n<span class=\"w\"> </span>     (x : Fin n).val = (x % n).toNat := by\n<span class=\"gd\">-   rw [Fin.intCast_def]</span>\n<span class=\"gi\">+   rw [Fin.intCast_def']</span>\n<span class=\"w\"> </span>   split &lt;;&gt; rename_i h\n<span class=\"w\"> </span>   · simp [Int.emod_natAbs_of_nonneg h]\n<span class=\"w\"> </span>   · simp only [Fin.ofNat_eq_cast, Fin.val_neg, Fin.natCast_eq_zero, Fin.val_natCast]\n</code></pre></div>\n<p>which shows <code>_root_.Fin.intCast_def'</code> being dropped.</p>\n<p>The command line git client also shows me</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>git<span class=\"w\"> </span>show<span class=\"w\"> </span>b57c9b7f461c042a5bf8c4d33f7bc6d396a166ff\n<span class=\"go\">commit b57c9b7f461c042a5bf8c4d33f7bc6d396a166ff</span>\n<span class=\"go\">Merge: 66d7396a6dd 4d464b72a4f</span>\n<span class=\"go\">Author: leanprover-community-mathlib4-bot &lt;leanprover-community-mathlib4-bot@users.noreply.github.com&gt;</span>\n<span class=\"go\">Date:   Fri Jun 6 06:41:05 2025 +0000</span>\n\n<span class=\"go\">    Merge master into nightly-testing</span>\n\n<span class=\"go\">diff --cc Mathlib/Data/BitVec.lean</span>\n<span class=\"go\">index b2b8c989a2e,3990ce5c0a8..8a79b51af8c</span>\n<span class=\"go\">--- a/Mathlib/Data/BitVec.lean</span>\n<span class=\"go\">+++ b/Mathlib/Data/BitVec.lean</span>\n<span class=\"go\">@@@ -63,10 -68,17 +68,10 @@@ instance : CommSemiring (BitVec w) :</span>\n<span class=\"go\">      (fun _ =&gt; rfl) /- toFin_natCast -/</span>\n<span class=\"go\">  -- The statement in the new API would be: `n#(k.succ) = ((n / 2)#k).concat (n % 2 != 0)`</span>\n\n<span class=\"go\"> --- Variant of `Fin.intCast_def` for when we are using the `Fin.CommRing` instance.</span>\n<span class=\"go\"> -open Fin.CommRing in</span>\n<span class=\"go\"> -theorem _root_.Fin.intCast_def' {n : Nat} [NeZero n] (x : Int) :</span>\n<span class=\"go\"> -    (x : Fin n) = if 0 ≤ x then Fin.ofNat n x.natAbs else -Fin.ofNat n x.natAbs := by</span>\n<span class=\"go\"> -  unfold Fin.instCommRing</span>\n<span class=\"go\"> -  dsimp [Int.cast, IntCast.intCast, Int.castDef]</span>\n<span class=\"go\"> -  split &lt;;&gt; (simp [Fin.intCast]; omega)</span>\n<span class=\"go\"> -</span>\n<span class=\"go\"> +-- TODO: move to the Lean4 repository.</span>\n<span class=\"go\">  @[simp] theorem _root_.Fin.val_intCast {n : Nat} [NeZero n] (x : Int) :</span>\n<span class=\"go\">      (x : Fin n).val = (x % n).toNat := by</span>\n<span class=\"go\">-   rw [Fin.intCast_def]</span>\n<span class=\"go\">+   rw [Fin.intCast_def']</span>\n<span class=\"go\">    split &lt;;&gt; rename_i h</span>\n<span class=\"go\">    · simp [Int.emod_natAbs_of_nonneg h]</span>\n<span class=\"go\">    · simp only [Fin.ofNat_eq_cast, Fin.val_neg, Fin.natCast_eq_zero, Fin.val_natCast]</span>\n</code></pre></div>\n<p>which is much more concise (AND much more revealing!!) then the github webview.</p>\n<p>I'm very confused, and suddenly don't really trust what github is showing me <span aria-label=\"explode\" class=\"emoji emoji-1f92f\" role=\"img\" title=\"explode\">:explode:</span></p>",
        "id": 522883594,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749287230
    },
    {
        "content": "<p>So really, there are two questions:</p>\n<ol>\n<li>Why did this bad merge happen in the first place?</li>\n<li>Why couldn't we spot it on github in the second place?</li>\n</ol>",
        "id": 522883639,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749287277
    },
    {
        "content": "<p>Regarding 2.: Since each commit describes a full snapshot of the repo, there isn't an obvious answer as to what the diff of a merge commit should be - what should it be diffed against? Github seems to show the diff between the first parent and the merge commit itself (though it may actually be some sort of combined diff, I'm not sure), while <code>git show</code> seems to be smarter. According to the man page, \"It also presents the merge commit in a special format as produced by git diff-tree --cc\", which (as far as I understand) combines the diffs against each parent and also tries to only show the places where merge conflicts had to be resolved.</p>",
        "id": 522885506,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749289811
    },
    {
        "content": "<p>After some more testing, GitHub seems to show exactly the diff against the first parent, no special sauce.</p>",
        "id": 522885603,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749289935
    },
    {
        "content": "<p>Thanks for explaining! It's sad that github is not using the smarter <code>git show</code>.</p>",
        "id": 522885631,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749289967
    },
    {
        "content": "<p>Regarding 1.: The lemma was added in commit <code>fc52fd8bbdcc3675a7344743f7a46a3f59ad2be6</code> as part of PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/25476\">#25476</a>. The bot seems to use the <a href=\"https://git-scm.com/docs/merge-strategies#Documentation/merge-strategies.txt-ours\"><code>ours</code> option to the <code>ort</code> merge strategy</a> to resolve conflicts. When the bot created its merge commit, there was probably a merge conflict involving the newly added lemma and some change on the nightly branch, and since the bot prefers the nightly changes in case of conflict, it threw away the lemma.</p>\n<p>Automatic merge conflict resolution will get things wrong from time to time. While git's heuristics are (mostly) correct for simple changes, when they fail to decide on a solution, semantic information tends to be required. Merge conflicts occur when Git's heuristics can't find an obvious solution, which is usually when two changes touch or overlap (the diff algorithm's heuristics decide where the change actually occurs in the first place).</p>",
        "id": 522886466,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749291177
    },
    {
        "content": "<p>You can reproduce it by:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>git<span class=\"w\"> </span>switch<span class=\"w\"> </span>66d7396a6dd<span class=\"w\"> </span>--detach\n$<span class=\"w\"> </span>git<span class=\"w\"> </span>merge<span class=\"w\"> </span>4d464b72a4f\nAuto-merging<span class=\"w\"> </span>Mathlib/Data/BitVec.lean\nCONFLICT<span class=\"w\"> </span><span class=\"o\">(</span>content<span class=\"o\">)</span>:<span class=\"w\"> </span>Merge<span class=\"w\"> </span>conflict<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>Mathlib/Data/BitVec.lean\nAutomatic<span class=\"w\"> </span>merge<span class=\"w\"> </span>failed<span class=\"p\">;</span><span class=\"w\"> </span>fix<span class=\"w\"> </span>conflicts<span class=\"w\"> </span>and<span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span>commit<span class=\"w\"> </span>the<span class=\"w\"> </span>result.\n</code></pre></div>\n<p>The merge conflict looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">HEAD</span>\n<span class=\"c1\">-- TODO: move to the Lean4 repository.</span>\n<span class=\"bp\">|||||||</span><span class=\"w\"> </span><span class=\"n\">e32a1c5b1f1</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">IntCast</span>\n\n<span class=\"c1\">-- TODO: move to the Lean4 repository.</span>\n<span class=\"bp\">=======</span>\n<span class=\"c1\">-- Variant of `Fin.intCast_def` for when we are using the `Fin.CommRing` instance.</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">intCast_def'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">natAbs</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">natAbs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instCommRing</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IntCast</span><span class=\"bp\">.</span><span class=\"n\">intCast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castDef</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">intCast</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span>\n\n<span class=\"bp\">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"n\">d464b72a4f</span>\n</code></pre></div>",
        "id": 522886921,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749291808
    },
    {
        "content": "<p><em>ours</em> (nightly) is the section between <code>&lt;&lt;&lt;</code> and <code>|||</code>, the <a href=\"https://git-scm.com/docs/git-merge-base\">merge base</a> is the section between <code>|||</code> and <code>===</code>, and <em>theirs</em> (master) is the section between <code>===</code> and <code>&gt;&gt;&gt;</code>.</p>\n<p>In other words, on nightly the <code>open Fin.IntCast</code> was removed while on master <code>open Fin.IntCast</code> as well as the <code>-- TODO: ...</code> were replaced by the lemma.</p>",
        "id": 522887017,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749291934
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"421885\">@Joscha Mennicken</span> Thanks a lot for all the details!</p>",
        "id": 522898767,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749306271
    },
    {
        "content": "<p>The only way to reliably prevent this I can think of is to abort on merge conflicts and merge manually in those cases</p>",
        "id": 522898854,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1749306356
    },
    {
        "content": "<p>Yeah, but before <code>nightly-testing</code> ends up in master, it goes through a PR review anyways. So I think the current opportunistic approach is probably the best overall</p>",
        "id": 522899155,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749306702
    }
]