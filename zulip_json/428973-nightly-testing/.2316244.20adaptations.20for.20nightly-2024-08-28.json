[
    {
        "content": "<blockquote>\n<p>chore: adaptations for nightly-2024-08-28 <a href=\"https://github.com/leanprover-community/mathlib4/pull/16244\">#16244</a></p>\n</blockquote>\n<p>massive diff!</p>",
        "id": 465941733,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724919777
    },
    {
        "content": "<p>You're not kidding</p>",
        "id": 465942199,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724919918
    },
    {
        "content": "<p>This is adaptations for <a href=\"https://github.com/leanprover/lean4/pull/5020\">lean#5020</a> (mostly done by <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span>, minor contributions from Markus and me), and adaptations for <a href=\"https://github.com/leanprover/lean4/pull/5129\">lean#5129</a>, which we initially didn't realise had broken Mathlib because the effect waited for a stage0 update...</p>",
        "id": 465947747,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921265
    },
    {
        "content": "<p>There's probably also some amount of upstreaming mixed in there.</p>",
        "id": 465947797,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921276
    },
    {
        "content": "<p>Note that for now (i.e. this nightly) <code>attribute [eqns comp_def] comp</code> is no longer supported. We <em>may</em> revisit this, but no promises. Hence a lot of the diff is replacing <code>simp [Function.comp]</code> or <code>simp [(· ∘ ·)]</code> with <code>simp [Function.comp_def]</code>.</p>",
        "id": 465948137,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921399
    },
    {
        "content": "<p>Oh, maybe I'm wrong about <a href=\"https://github.com/leanprover/lean4/pull/5020\">lean#5020</a> and that was in a previous one.</p>",
        "id": 465948220,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921416
    },
    {
        "content": "<p>I'm pretty sure the <a href=\"https://github.com/leanprover/lean4/pull/5020\">lean#5020</a> adaptations are in the diff.</p>",
        "id": 465948384,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1724921471
    },
    {
        "content": "<p>More changes here are from <a href=\"https://github.com/leanprover/lean4/pull/5187\">lean4#5187</a>, which takes the <code>reduceCtorEq</code> simproc out of the default simp set (so you have the choice of not using it!) but this has meant that <em>many</em> <code>simp only</code> statements needed a <code>reduceCtorEq</code> added back in.</p>",
        "id": 465948400,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921477
    },
    {
        "content": "<p>Okay --- so it's three big changes all landing at once.</p>",
        "id": 465948445,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921492
    },
    {
        "content": "<p>Because of some fallout from the <code>reduceCtorEq</code> change I wasn't able to get Mathlib working on nightly-2025-08-27, until <a href=\"https://github.com/leanprover/lean4/pull/5817\">lean#5817</a> fixed a problem in <code>norm_cast</code>.</p>",
        "id": 465948833,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921595
    },
    {
        "content": "<p>So everything snowballed. :-)</p>",
        "id": 465948888,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724921612
    },
    {
        "content": "<p>There is an adaptation note that we need to do much more handholding for TC synth in the Lie/manifold libraries.<br>\nShould we have this adaptation note everywhere we now need a <code>letI</code>?</p>\n<p>I added GH suggestions at all places I could find.</p>",
        "id": 466170616,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724998834
    },
    {
        "content": "<p>I think it would be good to track all these locations. Because it is a regression that should be fixed.</p>",
        "id": 466170706,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724998857
    },
    {
        "content": "<p>I circled back to this: take <a href=\"mailto:docs@LieSubmodule.coe_bracket\">docs@LieSubmodule.coe_bracket</a> as an example. Lean is looking for a <br>\n<code>Bracket L {x // x \\in N}</code> where <code>N : LieSubmodule R L M</code> but <code>Bracket L N</code>, which can be found via <code>inferInstance</code>, is <code>Bracket L { x // x ∈ ↑N }</code> where <code>↑N :  Submodule R M</code>. </p>\n<p>Without the <code>letI</code>, Lean tosses any <code>Bracket L N</code> because of the <code>Submodule</code> key when looking for <code>Bracket K {x // x \\in N}</code>. </p>\n<p>The simplest fix is </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">Bracket</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bracket</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Though one might also add a higher priority <code>CoeSort</code></p>",
        "id": 466216212,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725011156
    },
    {
        "content": "<p>Thanks for debugging!<br>\n<span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> do you also understand why this used to work fine a few days ago?</p>",
        "id": 466217388,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725011321
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5020\">lean#5020</a> -- previously the keys just junked anything anything inside the <code>\\in</code> including all type info for the subobject. Now it doesn't.</p>",
        "id": 466217686,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725011383
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> do you suggest leaving ~30 adaptation notes, and adding a bunch of instances of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">Bracket</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bracket</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>in the future, and removing the <code>letI</code>s again?</p>",
        "id": 466218714,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725011557
    },
    {
        "content": "<p>Or should we add all those instances now, before merging this nightly-adaptation PR?</p>",
        "id": 466218894,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725011583
    },
    {
        "content": "<p>Let me see if </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeSort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LieSubmodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>fixes things completely</p>",
        "id": 466219124,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725011621
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeSort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LieSubmodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">low</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">coeSubmodule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeOut</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LieSubmodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"n\">toSubmodule</span><span class=\"o\">⟩</span>\n</code></pre></div>\n<p>seems to work on a spot check.</p>",
        "id": 466220984,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725011985
    },
    {
        "content": "<p>Could also do <code>priority := mid</code></p>",
        "id": 466221290,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725012043
    },
    {
        "content": "<p>But many of the <code>simp</code> steps rely on <code>coeSubmodule</code> being present in the synthesized <code>CoeSort</code>. </p>\n<p>I guess the quickest fix right now is redeclaring the instances with the correct keys and deleting the <code>letI</code>'s. Then things will work locally and <code>simp</code> shouldn't break.</p>",
        "id": 466223298,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725012434
    },
    {
        "content": "<p>I would do it but I have to run now for a bit. Sorry.</p>",
        "id": 466223786,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725012536
    },
    {
        "content": "<p>I've merged; but there are many adaptation notes in place, that hopefully can still be replaced by adding the appropriate instances. <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> and <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span>, can I leave you two to coordinate that?</p>",
        "id": 466836706,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725257863
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16509\">#16509</a></p>",
        "id": 467879454,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725546700
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span></p>",
        "id": 467879564,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725546716
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> Awesome! Does a similar approach work for the other half of the files that had this adaptation note?</p>",
        "id": 467880571,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725546848
    },
    {
        "content": "<p>Yes I think so, but it is a far more localized problem there outside Lie algebras</p>",
        "id": 467885176,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725547609
    },
    {
        "content": "<p>The manifold failures can be fixed by making a wrapper <code>Opens.inclusion</code> for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.inclusion#doc\">docs#Set.inclusion</a> that is type-safe for <code>Opens</code>.</p>",
        "id": 467916740,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725554289
    },
    {
        "content": "<p>Unfortunately there is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TopologicalSpace.Opens.inclusion#doc\">docs#TopologicalSpace.Opens.inclusion</a> squatting</p>",
        "id": 467916950,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725554339
    },
    {
        "content": "<p>Any inspiration for what that existing one should be called? Note: it is a morphism in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TopCat#doc\">docs#TopCat</a></p>",
        "id": 467917824,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725554540
    },
    {
        "content": "<p>Otherwise, it is getting primed</p>",
        "id": 467918284,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725554638
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16513\">#16513</a> does this</p>",
        "id": 467929692,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725557453
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16528\">#16528</a> touches the remainder with one really strange failure</p>",
        "id": 468129028,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725614356
    }
]