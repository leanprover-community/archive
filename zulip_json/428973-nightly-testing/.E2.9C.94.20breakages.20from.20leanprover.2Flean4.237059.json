[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover/lean4/pull/7059\">lean4#7059</a>, in an effort to avoid multiple ways to say the same thing, I have deprecated <code>List.get?</code> and <code>List.get!</code> in favour of <code>GetElem</code> notation, and similarly <code>Array.get?</code> (it isn't possible to deprecate <code>Array.get!</code>, as it needs to be used under the hood, but I may try to add a linter for it).</p>\n<p>Mostly Mathlib is straightforward to clean up, and these fixes are on <a href=\"https://github.com/leanprover-community/mathlib4/tree/lean-pr-testing-7059\">branch#lean-pr-testing-7059</a>. However there are some remaining breakages in </p>\n<ul>\n<li>Mathlib.Computability.Tape (downstream <a href=\"/user_uploads/3121/ZmpR67RfXvs8k5TWqcePpxj8/tape.pdf\">files</a>)</li>\n<li>Mathlib.Computability.PartrecCode (downstream <a href=\"/user_uploads/3121/1am53etOnJOB8uIxBIXXC-1K/partreccode.pdf\">files</a>)</li>\n</ul>\n<p>Could I request that the authors of the affected files, <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, <span class=\"user-mention\" data-user-id=\"110187\">@Minchao Wu</span>, <span class=\"user-mention\" data-user-id=\"319356\">@Pim Spelier</span>, <span class=\"user-mention\" data-user-id=\"320867\">@Daan van Gent</span> take a look at these? If any of you have a chance to look in the next 6 hours, you can push directly to the <code>lean-pr-testing-7059</code> branch, otherwise at that point it will be merged into <code>nightly-testing</code> and you can push changes there!</p>",
        "id": 500063130,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739755360
    },
    {
        "content": "<p>I have 2 quesions:</p>\n<ul>\n<li>Should we deprecate <code>List.get</code> too?</li>\n<li>Should we drop the <code>Fin</code> instance for <code>GetElem</code> and cast <code>i</code> to <code>Nat</code> in <code>l[i]</code> instead?</li>\n</ul>",
        "id": 500083292,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1739768769
    },
    {
        "content": "<p>No, we shouldn't deprecate <code>List.get</code>, it's sometimes useful to have the function direct from <code>Fin n → α</code>. I plan to rename it <code>getFin</code>, however.</p>",
        "id": 500083399,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739768833
    },
    {
        "content": "<p>I'm not yet certain about the <code>GetElem</code> / <code>Fin</code> instance.</p>",
        "id": 500083423,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739768852
    },
    {
        "content": "<p>The reason for the 2nd suggestion is that it's too easy to write a lemma that uses <code>l[(i : Fin _)]</code>, then get stuck with <code>l[i][j]</code>.</p>",
        "id": 500083429,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1739768856
    },
    {
        "content": "<p>In one of the PRs I'm working on, I had to manually add <code>Fin.val</code> (or <code>.1</code>) in list indexes to avoid this issue.</p>",
        "id": 500083756,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1739769007
    },
    {
        "content": "<p>Okay, I will try out removing that instance. (But not in this PR.)</p>",
        "id": 500083860,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739769068
    },
    {
        "content": "<p>I've identified one source of the regression: <code>(a :: l)[0]? = some a</code> is no longer a dsimp lemma</p>",
        "id": 500287608,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739833655
    },
    {
        "content": "<p>actually scratch that, it's no longer even defeq</p>",
        "id": 500287694,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739833712
    },
    {
        "content": "<p>that's not a good tradeoff at all</p>",
        "id": 500287708,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739833719
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/breakages.20from.20leanprover.2Flean4.237059/near/500063130\">said</a>:</p>\n<blockquote>\n<p>it isn't possible to deprecate <code>Array.get!</code>, as it needs to be used under the hood, but I may try to add a linter for it</p>\n</blockquote>\n<p>I guess you could rename it to <code>getUnsafe</code>, and leave <code>get!</code> around with a deprecation?</p>",
        "id": 500287746,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739833745
    },
    {
        "content": "<p>We have <code>GetElem</code> and <code>GetElem?</code> classes, so there is no reason there should be bad defeqs here. I think the <code>GetElem?</code> implementation should be using <code>List.get?</code>, rather than inheriting one from <code>GetElem</code> plus some if statement to produce an option</p>",
        "id": 500288382,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739834179
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/GetElem.html#instGetElem?OfGetElemOfDecidable\">https://leanprover-community.github.io/mathlib4_docs/Init/GetElem.html#instGetElem?OfGetElemOfDecidable</a> is to blame here</p>",
        "id": 500288628,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739834378
    },
    {
        "content": "<p>It's at least low priority, so simply adding the missing <code>GetElem?</code> instance (and keeping <code>List.get?</code> as an implementation detail, perhaps inlined into the instance) will do the trick</p>",
        "id": 500289076,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739834647
    },
    {
        "content": "<p>Thanks, I'll add that instance shortly, hopefully it can land in tonight's nightly.</p>\n<p>It's interesting how little this broke elsewhere. I did replace a few rfls by simps. But I agree that this isn't a case where blocking defeq is helpful. :-)</p>",
        "id": 500293247,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739837381
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/7121\">lean#7121</a></p>",
        "id": 500302992,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739843791
    },
    {
        "content": "<p>This has now landed, and I've restored all the affected files.</p>",
        "id": 500377924,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739878185
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> has marked this topic as resolved.</p>",
        "id": 500377933,
        "sender_full_name": "Notification Bot",
        "timestamp": 1739878187
    }
]