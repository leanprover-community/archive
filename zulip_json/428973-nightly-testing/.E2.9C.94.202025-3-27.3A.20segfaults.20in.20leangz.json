[
    {
        "content": "<p>Uhoh, segfaults all over the place!</p>",
        "id": 508394468,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743030783
    },
    {
        "content": "<p>I just tried getting nightly testing's cache. Did some core format change? Or is this just a bad cache from segfaults during building?</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>info: downloading https://github.com/leanprover/lean4-nightly/releases/download/nightly-2025-03-26/lean-4.19.0-nightly-2025-03-26-darwin_aarch64.tar.zst\nTotal: 385.7 MiB Speed:  26.3 MiB/s\ninfo: installing /Users/kmill/.elan/toolchains/leanprover--lean4-nightly---nightly-2025-03-26\ninfo: aesop: checking out revision 'b5859784513c2c040a800ff9148deacbc52a2cf0'\ninfo: batteries: checking out revision '8cd9c9bba28bd6bd4785bb136a183e3b55740539'\nAttempting to download 6443 file(s)\nDownloaded: 757 file(s) [attempted 6443/6443 = 100%] (11% success)\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nAlternatively, if you already have pushed your commits to a branch, this may mean the CI build has failed part-way through building.\nDecompressing 757 file(s)\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 130 but the index is 209\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 116 but the index is 209\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 136 but the index is 209\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 80 but the index is 208\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 162 but the index is 209\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 74 but the index is 209\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 171 but the index is 208\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 200 but the index is 208\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 149 but the index is 208\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 178 but the index is 208\nthread '&lt;unnamed&gt;' panicked at /Users/runner/work/leangz/leangz/src/lgz.rs:1854:28:\nindex out of bounds: the len is 181 but the index is 208\nuncaught exception: leantar failed with error code 101\n</code></pre></div>",
        "id": 508396483,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743031891
    },
    {
        "content": "<p>I'm not reproducing the build failures on macOS m3.</p>",
        "id": 508397307,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743032360
    },
    {
        "content": "<p>Same -- a local build after <code>lake clean</code> seems to be going smoothly.</p>",
        "id": 508397341,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743032385
    },
    {
        "content": "<p>I just touched some whitespace in Mathlib.Init, to see if merely invalidating the cache helps here.</p>",
        "id": 508399149,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743033328
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20status.20updates/near/508399149\">said</a>:</p>\n<blockquote>\n<p>I just touched some whitespace in Mathlib.Init, to see if merely invalidating the cache helps here.</p>\n</blockquote>\n<p>This seems to have worked.</p>",
        "id": 508401714,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743034675
    },
    {
        "content": "<p>Hmm, but then the next commit I pushed broke again. :-(</p>",
        "id": 508403248,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743035580
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, if you're available to help work out the cause of the leangz errors happening on nightly-testing, that would be great. I don't see any commits in the <a href=\"https://github.com/leanprover/lean4-nightly/releases/tag/nightly-2025-03-26\">nightly-2025-03-26</a> that look suspicious so far. :-(</p>",
        "id": 508411234,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743040507
    },
    {
        "content": "<p>Might this be the first <code>Task</code> we ever put in a .olean file...?</p>",
        "id": 508441938,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743059096
    },
    {
        "content": "<p>confirmed that there has been an olean format change in <code>lean_task</code></p>",
        "id": 508502207,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743078488
    },
    {
        "content": "<p>But that's an interesting theory <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> , although I tested leangz on task objects back when it was written, if there have been no task objects in oleans this whole time then the format change could have happened any time in the past 1.5 years or so</p>",
        "id": 508519193,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743082244
    },
    {
        "content": "<p>concretely, there is a debug assertion failing on a task object, which is expecting to see </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">rc</span><span class=\"o\">:</span><span class=\"n\">u32</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cs_sz</span><span class=\"o\">:</span><span class=\"n\">u16</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num_fields</span><span class=\"o\">:</span><span class=\"n\">u8</span><span class=\"bp\">=_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">:</span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xFC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TAG_TASK</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">lean_obj</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"o\">:</span><span class=\"n\">u64</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and instead sees</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">rc</span><span class=\"o\">:</span><span class=\"n\">u32</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cs_sz</span><span class=\"o\">:</span><span class=\"n\">u16</span><span class=\"bp\">=</span><span class=\"mi\">24</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num_fields</span><span class=\"o\">:</span><span class=\"n\">u8</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"o\">:</span><span class=\"n\">u8</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xFC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TAG_TASK</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">lean_obj</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">imp</span><span class=\"o\">:</span><span class=\"n\">u64</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 508520648,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743082678
    },
    {
        "content": "<p>Also looking at this code I see <code>LeanPromise</code> is new...</p>",
        "id": 508521916,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743082995
    },
    {
        "content": "<p>I don't know why it would expect <code>cs_sz=1</code>, afaik it has always been the object size in bytes. 24 sounds right for <code>lean_task</code>.</p>",
        "id": 508522897,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743083243
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/2025-3-27.3A.20segfaults.20in.20leangz/near/508521916\">said</a>:</p>\n<blockquote>\n<p>Also looking at this code I see <code>LeanPromise</code> is new...</p>\n</blockquote>\n<p>I think <a href=\"https://github.com/leanprover/lean4/pull/6958#discussion_r1946475315\">https://github.com/leanprover/lean4/pull/6958#discussion_r1946475315</a> still holds, no promises involved here</p>",
        "id": 508523318,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743083351
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/428973-nightly-testing/topic/2025-3-27.3A.20segfaults.20in.20leangz/near/508522897\">said</a>:</p>\n<blockquote>\n<p>I don't know why it would expect <code>cs_sz=1</code>, afaik it has always been the object size in bytes. 24 sounds right for <code>lean_task</code>.</p>\n</blockquote>\n<p>It seems to have multiple meanings, some variants do seem to set cs_sz=1</p>",
        "id": 508523438,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083385
    },
    {
        "content": "<p>Ah, <code>lean_set_non_heap_header_for_big</code> does. No big here though.</p>",
        "id": 508523579,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743083414
    },
    {
        "content": "<p>I can't seem to find where it is set to something nonzero for tasks though</p>",
        "id": 508523716,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083449
    },
    {
        "content": "<p><code>copy_object</code> in compact.cpp I believe</p>",
        "id": 508523781,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743083467
    },
    {
        "content": "<p>that doesn't even touch <code>cs_sz</code></p>",
        "id": 508523885,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083496
    },
    {
        "content": "<p>it just copies whatever it was set to into the olean</p>",
        "id": 508523937,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083509
    },
    {
        "content": "<p>oh I see it's in <code>lean_set_non_heap_header</code></p>",
        "id": 508524152,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083561
    },
    {
        "content": "<p>it's super confusing to be using this function on heap objects BTW</p>",
        "id": 508524306,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083600
    },
    {
        "content": "<p>Ok, that's one problem sorted. Unfortunately that can't be the cause of the actual failure, that was a failed debug assertion and the cs_sz value is ignored in any case</p>",
        "id": 508525260,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743083827
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> can you confirm that this is also the case for lean_thunk and lean_ref objects? The code for all three is the same in leangz so perhaps these have also never been in olean files</p>",
        "id": 508560495,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743091690
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Looks like it from the code? I didn't write it</p>",
        "id": 508568443,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743093473
    },
    {
        "content": "<p>Can you say what a lean_promise looks like / what I would expect it to be in an olean file?</p>",
        "id": 508568750,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743093545
    },
    {
        "content": "<p>I'm guessing promises and tasks will always be resolved</p>",
        "id": 508568820,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743093559
    },
    {
        "content": "<p>a promise points to a task, is that task object shared with other things?</p>",
        "id": 508569073,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743093614
    },
    {
        "content": "<p>You mean if there are other references to it? Potentially</p>",
        "id": 508569211,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743093648
    },
    {
        "content": "<p>Okay I have a fix for leangz which includes everything discussed so far. In theory it supports refs and promises too but I'm contemplating panicking in that case since it seems my initial testing on tasks was insufficient because oleans in the wild did not use tasks, and so there may be more bugs uncovered the first time a promise, thunk or ref is put in an olean file.</p>\n<p>I will make a new point release of leangz and PR it to mathlib, and I guess it should also be pulled in to nightly-testing.</p>",
        "id": 508573581,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743094741
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23379\">#23379</a></p>",
        "id": 508576487,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743095535
    },
    {
        "content": "<p>cherry picked to nightly-testing (cc: <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> )</p>",
        "id": 508576822,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743095633
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 508577039,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743095691
    },
    {
        "content": "<p>oh, this is also going to require a cache flush, the cache files currently stored on the server for the latest nightly-testing are bad</p>",
        "id": 508577728,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743095878
    },
    {
        "content": "<p>Probably negligible on nightly-testing?</p>",
        "id": 508577951,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743095932
    },
    {
        "content": "<p>yeah I think it suffices to run <code>lake exe cache put!</code> once on nightly-testing</p>",
        "id": 508578069,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743095966
    },
    {
        "content": "<p>or just do something to invalidate the cache like changing whitespace in the lockfile</p>",
        "id": 508578489,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743096071
    },
    {
        "content": "<p>I did the latter just now</p>",
        "id": 508578951,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743096219
    },
    {
        "content": "<p>Problem still remains. Investigating...</p>",
        "id": 508624188,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743112082
    },
    {
        "content": "<p>seems the issue is not with leantar 0.1.15, I think it might still be a cache flushing issue</p>",
        "id": 508626921,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743113184
    },
    {
        "content": "<p>the last <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/14117103810\">failure</a> seems to have downloaded a file produced in <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/14106871272/job/39515330131\">this run</a>, on the old leantar, so my cache flush must not have stuck. My whitespace change was <a href=\"https://github.com/leanprover-community/mathlib4/commit/65c5e5062\">reverted by the bot</a> without any other changes to the lakefile, so the hash got reverted. I guess I'll need to come up with a new trick to invalidate the root hash without permanent damage...</p>",
        "id": 508627747,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743113600
    },
    {
        "content": "<p><span aria-label=\"rolling eyes\" class=\"emoji emoji-1f644\" role=\"img\" title=\"rolling eyes\">:rolling_eyes:</span> I used the <code>Mathlib.Init</code> trick this time like <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> did, but there are still bad oleans coming from the same bad commit - and naturally this is because they are files not in mathlib this time, e.g. <code>Batteries/Data/Fin/OfBits.lean</code>. I think we should just add an additional manual input to the root hash which is a number we can bump for this kind of thing</p>",
        "id": 508646032,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743123808
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23387\">#23387</a> implements an additional root hash input, but someone stop me if you think there is a better way (I'm not fully convinced myself)</p>",
        "id": 508647341,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743124618
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> has marked this topic as resolved.</p>",
        "id": 508653408,
        "sender_full_name": "Notification Bot",
        "timestamp": 1743128235
    },
    {
        "content": "<p>This will solve itself with the next nightly, no?</p>",
        "id": 508681006,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743145248
    },
    {
        "content": "<p>Yes, but in general it would be nice to have a place to do this kind of thing with a quicker turnaround, and also I have done this on master in the past (I'm not sure whether this is guaranteed never to need to happen on master again)</p>",
        "id": 508709724,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743155118
    },
    {
        "content": "<p>I think this can still happen on master, e.g. if we discover a bug in lean and/or leantar which is affecting master and needs immediate action</p>",
        "id": 508710034,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743155209
    }
]