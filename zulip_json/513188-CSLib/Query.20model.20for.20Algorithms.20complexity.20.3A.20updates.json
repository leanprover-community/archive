[
    {
        "content": "<p>I thought it might be easier to use a single thread to post updates about our query model for systematically formalising algorithmic complexity in a lightweight, yet very structured way. </p>\n<p>Currently it is WIP in PR <a href=\"https://github.com/leanprover/cslib/pull/275\">cslib#275</a> . This is essentially a continuation of <a href=\"https://github.com/leanprover/cslib/pull/201\">cslib#201</a> in a fresh PR for github permissions reasons</p>\n<ol>\n<li>It already supports creating custom query types whose costs depend on input size of each query.</li>\n<li>I just added support for custom cost structures. There are some examples in the QueryModel.lean file. </li>\n<li>Currently, please ignore the Mergesort.lean file</li>\n</ol>",
        "id": 569606456,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769124122
    },
    {
        "content": "<p>What remains to be done :</p>\n<ol>\n<li>Implement a notion of reduction.</li>\n<li>Implement some non-trivial examples such as sorting algorithms</li>\n</ol>",
        "id": 569606621,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769124214
    },
    {
        "content": "<p>CC : <span class=\"user-mention\" data-user-id=\"677310\">@Tanner Duve</span> started the basic idea by implementing mergesort in a specific query model.</p>",
        "id": 569606733,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769124273
    },
    {
        "content": "<p>One limitation, that I expect any shallow DSL to have is the ability to sneak in pure computations cost free. But it improves on the TimeM model in several ways:</p>\n<ol>\n<li>No explicit ticks needed, so the chances of making mistakes like forgetting to count specific calls is removed.</li>\n<li>The operations which are counted are made explicit as an inductive type and a model of this type.</li>\n<li>The model of a query type accepts custom cost structures so long as you can define addition and a 0 operation on them (basically monoids).</li>\n</ol>",
        "id": 569606941,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769124397
    },
    {
        "content": "<p>Next : I am getting a very strange error on running CI. The editor shows no error, only CI. Not even<code>lake build</code>. See the error message here :</p>\n<p><a href=\"https://github.com/leanprover/cslib/actions/runs/21269168918/job/61215304680?pr=275\">https://github.com/leanprover/cslib/actions/runs/21269168918/job/61215304680?pr=275</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cslib</span><span class=\"bp\">/</span><span class=\"n\">Algorithms</span><span class=\"bp\">/</span><span class=\"n\">QueryModel</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">284</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Cslib</span><span class=\"bp\">.</span><span class=\"n\">FreeM</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"bp\">._</span><span class=\"n\">redArg'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg___boxed'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg'</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Std</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">relevant</span><span class=\"w\"> </span><span class=\"ss\">`lean_exe</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"ss\">`lakefile.lean</span><span class=\"bp\">`.</span>\n<span class=\"w\">  </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cslib</span><span class=\"bp\">/</span><span class=\"n\">Algorithms</span><span class=\"bp\">/</span><span class=\"n\">QueryModel</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">285</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Cslib</span><span class=\"bp\">.</span><span class=\"n\">FreeM</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"bp\">._</span><span class=\"n\">redArg'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg___boxed'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg'</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Std</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">relevant</span><span class=\"w\"> </span><span class=\"ss\">`lean_exe</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"ss\">`lakefile.lean</span><span class=\"bp\">`.</span>\n<span class=\"w\">  </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cslib</span><span class=\"bp\">/</span><span class=\"n\">Algorithms</span><span class=\"bp\">/</span><span class=\"n\">QueryModel</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">286</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Cslib</span><span class=\"bp\">.</span><span class=\"n\">FreeM</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"bp\">._</span><span class=\"n\">redArg'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg___boxed'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_cslib_Cslib_FreeM_lift___redArg'</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"w\">  </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Std</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">relevant</span><span class=\"w\"> </span><span class=\"ss\">`lean_exe</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"ss\">`lakefile.lean</span><span class=\"bp\">`</span>\n</code></pre></div>",
        "id": 569610371,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769126265
    },
    {
        "content": "<p>Never mind. Removing #evals fixed it</p>",
        "id": 569612648,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769127322
    },
    {
        "content": "<p>I left a few comments; I think you should be making much more use of <code>FreeM.liftM</code>, which is ultimately the <code>eval</code> function you are defining there</p>",
        "id": 569612855,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769127444
    },
    {
        "content": "<p>Copied from DM : Likewise the evalQuery is defined that way because I expect that there will be proofs likeÂ <code>evalQuery Model_1</code>Â andÂ <code>reduce Model_1 Model_2</code>Â gives an equivalent evaluation in model 2</p>",
        "id": 569612957,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769127514
    },
    {
        "content": "<p>and the proof will be an induction on Prog</p>",
        "id": 569612985,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769127537
    },
    {
        "content": "<p>Anyway, my point is if TimeM is just CostM, then there is no reason to not just call it a <code>Model</code></p>",
        "id": 569615543,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769129237
    },
    {
        "content": "<p>If <code>TimeM</code> is just <code>WriterT id (Multiplicative Nat)</code>, then there is no point in using it either</p>",
        "id": 569615573,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769129258
    },
    {
        "content": "<p>I changed <code>Model</code> into a <code>structure</code> btw</p>",
        "id": 569615602,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769129278
    },
    {
        "content": "<p>Sorry these messages were in drafts before my DMs with Eric. But basically <code>TimeM</code> is an entirely extraneous definition, It is just <code>WriterT Id (Multiplicative Nat)</code> and we can extend it to <code>Write Id Cost</code> for a suitable cost type</p>",
        "id": 569615842,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769129372
    },
    {
        "content": "<p>EDIT : Eric says the default monoid instance on <code>Nat </code> is multiplication and <code>Multiplicative Nat</code> makes the multiplication operation behave as addition.</p>",
        "id": 569616770,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769129941
    },
    {
        "content": "<p>I think <code>WriterT Id (Multiplicative Nat)</code> probably ends up being pretty unergonomic; I'd perhaps suggest we should have a separate <code>CostT</code> which is a <code>to_additive</code>ized version of <code>WriterT</code>.</p>",
        "id": 569617330,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130333
    },
    {
        "content": "<p>(or we should change <code>WriterT</code> to accumulate with <code>+</code> instead of <code>*</code>, since so far I think this is the only use of WriterT, and the symbol is inconvenient)</p>",
        "id": 569617417,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130402
    },
    {
        "content": "<p>It's valid, but if <code>TimeM</code> is redundant, I don't see the value of introducing two layers of monads for running <code>Prog</code> monad</p>",
        "id": 569617663,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130582
    },
    {
        "content": "<p>If they're <code>abbrev</code>s then they don't really count as layers</p>",
        "id": 569617762,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130656
    },
    {
        "content": "<p>Also I vote for WriterT using <code>AddMonoid</code> by default. This is the natural interpretation of writer monads in haskell. Consider a list of log strings. One doesn't construct a new list of tupled log strings in the writer monad. One appends new entries into the log (that's addition operation for lists)</p>",
        "id": 569617765,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130656
    },
    {
        "content": "<p>But <code>String</code>s aren't <code>AddMonoid</code>s or <code>Monoid</code>s anyway, so that's not a great argument</p>",
        "id": 569617798,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130680
    },
    {
        "content": "<p>Logs are lists of strings. not strings</p>",
        "id": 569617817,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130695
    },
    {
        "content": "<p>and strings are monoids.</p>",
        "id": 569617825,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130700
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569617825\">said</a>:</p>\n<blockquote>\n<p>and strings are monoids.</p>\n</blockquote>\n<p>but</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569617798\">said</a>:</p>\n<blockquote>\n<p><code>String</code>s aren't <code>AddMonoid</code>s or <code>Monoid</code>s</p>\n</blockquote>\n<p>according to Mathlib</p>\n<p>Does haskell allow <code>\"foo\" + \"bar\"</code>? Remember, Lean doesn't</p>",
        "id": 569617828,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130703
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569617765\">said</a>:</p>\n<blockquote>\n<p>Also I vote for WriterT using <code>AddMonoid</code> by default.</p>\n</blockquote>\n<p>This is a topic for <a class=\"stream\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4\">#mathlib4</a></p>",
        "id": 569617865,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130730
    },
    {
        "content": "<p>Let's make a new thread with a summary, rather than dumping the entire argument in mathlib4</p>",
        "id": 569617933,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130796
    },
    {
        "content": "<p>Okay but I want to leave this thread for <code>Prog</code>. The writer monad's monoid issue is independent</p>",
        "id": 569617979,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130842
    },
    {
        "content": "<p>Ah apologies, I missed that you didn't move it to mathlib4</p>",
        "id": 569618018,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769130871
    },
    {
        "content": "<p>I can't</p>",
        "id": 569618029,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130882
    },
    {
        "content": "<p>No permissions</p>",
        "id": 569618033,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769130885
    },
    {
        "content": "<p>Anyway, to return to Prog. If TimeM is redundant, I don't see any point in interpreting Query models and Prog to TimeM either. QueryModel.lean can just use <code>WriterT</code>. I am not too comfortable unfolding these monad transformers and <code>do_lift</code>s. Induction proofs are simpler. which is why I have written the current definitions. Once I am comfortable with the reduction business between models, I'll see how far I can use <code>liftM</code></p>",
        "id": 569618302,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769131070
    },
    {
        "content": "<p>As it exists currently (with only <code>Nat</code> time complexity), it makes no sense to lift <code>Prog</code> to <code>TimeM</code>. <code>Prog</code> in this PR handles more general cost structures. Ideally that should be a separate PR. (see how I use two different cost structures for the same program here : <a href=\"https://github.com/leanprover/cslib/pull/275/changes#diff-c53c80c7c59623eecc9954c581f434662ffdfcf9278f48f637934332728fe29fR270\">https://github.com/leanprover/cslib/pull/275/changes#diff-c53c80c7c59623eecc9954c581f434662ffdfcf9278f48f637934332728fe29fR270</a>)</p>",
        "id": 569618765,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769131422
    },
    {
        "content": "<p>Another update : I set up a monadic version of linear search and ran into a <code>forIn</code> proof. <code>mvcgen</code> won't work on this monad yet (cc : <span class=\"user-mention\" data-user-id=\"130195\">@Sebastian Graf</span> could we get it to?). I'd be grateful for any help in teaching me how to handle these kinds of proofs. The theorem statements are at the end. of the file <code>QueryModel.lean</code>. Examples help</p>",
        "id": 569621188,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769133157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569606941\">said</a>:</p>\n<blockquote>\n<p>One limitation, that I expect any shallow DSL to have is the ability to sneak in pure computations cost free.</p>\n</blockquote>\n<p>Right, you have to be very careful to expose no information exception the ones captured by the query; so for instance, for a sorting algorithm you must not provide the algorithm with a <del>decidable</del> comparison operator, so it has no choice but to act through the queries</p>",
        "id": 569623390,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769134514
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569623390\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569606941\">said</a>:</p>\n<blockquote>\n<p>One limitation, that I expect any shallow DSL to have is the ability to sneak in pure computations cost free.</p>\n</blockquote>\n<p>Right, you have to be very careful to expose no information exception the ones captured by the query; so for instance, for a sorting algorithm you must not provide the algorithm with a <del>decidable</del> comparison operator, so it has no choice but to act through the queries</p>\n</blockquote>\n<p>We only need to add typeclass instances that could potentially provide the comparison operator in the model.  In the program itself, we donâ€™t need to and we shouldnâ€™t provide any instances. Then the only way to get comparisons will be through queries.</p>",
        "id": 569626470,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769136826
    },
    {
        "content": "<p>But this is not a fool proof method if someone decides to write an algorithm for a specific type like Nat.</p>",
        "id": 569626538,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769136867
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/513188-CSLib/topic/Query.20model.20for.20Algorithms.20complexity.20.3A.20updates/near/569621188\">said</a>:</p>\n<blockquote>\n<p>Another update : I set up a monadic version of linear search and ran into a <code>forIn</code> proof. <code>mvcgen</code> won't work on this monad yet (cc : <span class=\"user-mention silent\" data-user-id=\"130195\">Sebastian Graf</span> could we get it to?). I'd be grateful for any help in teaching me how to handle these kinds of proofs. The theorem statements are at the end. of the file <code>QueryModel.lean</code>. Examples help</p>\n</blockquote>\n<p>In order to use <code>mvgen</code>, you need to define a <code>WP</code> instance for your use of <code>Prog</code>. I would try and focus on a particular instantiation first before doing the parameterized free monad (if that is even possible). You can read up in the <a href=\"https://lean-lang.org/doc/reference/latest/The--mvcgen--tactic/Enabling--mvcgen--For-Monads/#The-Lean-Language-Reference--The--mvcgen--tactic--Enabling--mvcgen--For-Monads\">reference manual</a> how to define such as instance. The logging example is instructive; it's basically <code>Writer String</code> and thus more or less the same as <code>TimeM</code>. </p>\n<p>I hypothesize that you need two kinds of lemmas: One for <code>.eval</code> (e.g., <code>(read c i).eval</code>does something to <code>c</code>) and one for <code>.cost</code> (e.g., <code>(read c i).cost</code> increases cost by x). Do that for all the operations, define an adequacy lemma and you should be able to use <code>mvcgen</code> to prove </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">linearSearch_correct_true</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">linearSearch</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">VecSearch_Nat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">linearSearch_time_complexity</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">linearSearch</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">VecSearch_Nat</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 569664623,
        "sender_full_name": "Sebastian Graf",
        "timestamp": 1769158833
    },
    {
        "content": "<p>I just tried to write a tail recursive version of linear search to avoid using for loops. But ofc we are still programming in a monad. I need to learn how to fill the kind of goals I have in the the lines with <code>done</code></p>",
        "id": 569709219,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769173240
    },
    {
        "content": "<p>Another update :</p>\n<p>I was thinking about the issue that any lightweight monadic DSL must necessarily suffer: sneaking in computations inside <code>pure</code>.  Circumventing it with another layer of translation from queries which need the model to acess important data structures makes things too complex. It will also make it impossible to specify invariants in-situ with the mvcgen framework later, because the program spec cannot depend on the model which might contain the relevant data structures. </p>\n<p>So I added a <code>PureCosts</code> typeclass, which any cost type must have an instance of. In principle this allows us to track (maybe, depending on the instance, even log) each pure operation. As a reviewer that's a good sanity check to have. See lines 222 and 401 for examples</p>",
        "id": 569858006,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769253751
    },
    {
        "content": "<p>Another design thought : compiling Prog to Time allows the following : the compiled version of Prog can be composed with plain TimeM programs. So an AI that is tasked with discovering an efficient algorithm can use incorrectly marked purely TimeM sub procedures to save on time complexity. Checking for this involves extra steps. Without TimeM we only need to check for sneaky pure operations, which, as I show in the PR, can be logged or counted</p>",
        "id": 569877248,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769269247
    },
    {
        "content": "<p>I don't understand what you think you are protecting against there, if you are required to produce a term or type <code>Prog</code> then you can't cheat by embedding a TimeM, because the conversion only goes in the other direction.</p>",
        "id": 569878247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769270026
    },
    {
        "content": "<p>Okay fair. I guess we only need to check the top level theorem statement and Prog procedure</p>",
        "id": 569884635,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769271699
    },
    {
        "content": "<p>Uploaded a linear search example on lists. The proofs were much simpler.</p>",
        "id": 569918895,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769308141
    },
    {
        "content": "<p>Another update, but in another thread this time, we can elegantly express circuits and prove stuff about circuit complexity within this framework. I am still working out how to hide the IDs from prog spec and have them generated for every monadic call to a new circuit combinator, but this is already looking good. See more : <a class=\"message-link\" href=\"/#narrow/channel/513188-CSLib/topic/Parity.20is.20not.20in.20AC0/near/569997421\">#CSLib &gt; Parity is not in AC0 @ ðŸ’¬</a></p>",
        "id": 569997521,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769391568
    },
    {
        "content": "<p>I think at this point I am going to try writing <code>WP</code> instances, and see if I can't knock out the sorries in some of the monadic search procedures.</p>",
        "id": 569997896,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769391919
    },
    {
        "content": "<p>Another thing I would like to do is to add attributes which tag an algorithm (<code>Prog</code>) and its correctness and complexity theorems with an algorithm_ID and labels like <code>correctness</code> and <code>complexity</code> for the theorems, and then write some metaprogs to query all relevant declarations of an by the algorithm_id</p>",
        "id": 569998080,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769392116
    },
    {
        "content": "<p>Another update to the query model : By way of reduction from another query model called <code>CircuitQuery</code>, I have eliminated the need to manually annotate circuit IDs. Cross-posted for relevance from here : <a class=\"message-link\" href=\"/#narrow/channel/513188-CSLib/topic/Parity.20is.20not.20in.20AC0/near/570588502\">#CSLib &gt; Parity is not in AC0 @ ðŸ’¬</a></p>",
        "id": 570589481,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614070
    },
    {
        "content": "<p>If someone is up for it, I would like to recommend creating a Query model for Turing machines. The input type of each query is the alphabet of the TM (both tape and input) and whose output is a TMConfig.</p>",
        "id": 570590324,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614260
    },
    {
        "content": "<p>the resultant Prog acts as the transition function of a Turing machine, so eval query must be implemented accordingly. Each query trivially costs (1 : Nat).</p>",
        "id": 570590798,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614354
    },
    {
        "content": "<p>I don't understand what would the query cost represent with approach you described? Wouldn't it just be some measure of the size of the outputed Turing Machine? I though, that we want to somehow measure the time complexity of the resulting Turing Machine?</p>",
        "id": 570593292,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769614836
    },
    {
        "content": "<p>cost is a generic word for complexity</p>",
        "id": 570593352,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614851
    },
    {
        "content": "<p>In the examples, you can see how I have multiple ways of accounting costs, sometimes for the same model. In circuits, I count the size and depth. In some examples, I only count a subset of the queries. In some examples, I count some queries separately. I can also optionally keep track of uses of <code>pure</code> operations, trivially by counting them (but more advanced options are possible).</p>",
        "id": 570593429,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614871
    },
    {
        "content": "<p>I understand that. But the notion of complexity defined by the cost you just described doesn't seem particulary interesting to be honest. At least it is not related in any way to standard notions of time or size complexity for turing machines (or do you claim it is?).</p>",
        "id": 570593751,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769614951
    },
    {
        "content": "<p>I don't see how it doesn't?</p>",
        "id": 570593854,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614969
    },
    {
        "content": "<p>You could count </p>\n<ol>\n<li>The number of calls to queries that read or write</li>\n</ol>",
        "id": 570593950,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614990
    },
    {
        "content": "<p>That's time complexity</p>",
        "id": 570593979,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769614994
    },
    {
        "content": "<ol start=\"2\">\n<li>The number of empty cells you write to.</li>\n</ol>\n<p>That's space complexity</p>",
        "id": 570594039,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615008
    },
    {
        "content": "<p>Ah, sorry, than I misunderstood the approach you described.</p>",
        "id": 570594105,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769615026
    },
    {
        "content": "<p>When writing a <code>Model</code> you describe the costs of queries.</p>",
        "id": 570594242,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615054
    },
    {
        "content": "<p>Although, in that case, I don't know how to implement it I think.</p>",
        "id": 570594247,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769615054
    },
    {
        "content": "<p>The monad extends that to the entire program</p>",
        "id": 570594314,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615067
    },
    {
        "content": "<p>It is not clear to me, how to you want to \"compile\" monad to TMConfig.</p>",
        "id": 570594913,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769615190
    },
    {
        "content": "<p><code>Model.eval</code></p>",
        "id": 570594947,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615199
    },
    {
        "content": "<p>I recommend checking out the examples</p>",
        "id": 570595166,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615253
    },
    {
        "content": "<p>I think I completed the linearSearch example on lists</p>",
        "id": 570595233,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769615267
    },
    {
        "content": "<p>I am also not sure what is being asked here, but I would like to see TMs and query model based models of computation linked if possible. I have a PR that defines a kind of TM at <a href=\"https://github.com/leanprover/cslib/pull/269\">cslib#269</a>, but I treat the tape alphabet as being slightly different from the input alphabet. Is it possible to integrate this with the query model you are describing?</p>",
        "id": 570608450,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1769618395
    },
    {
        "content": "<p>Yes definitely.</p>",
        "id": 570608668,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618440
    },
    {
        "content": "<p>In terms of the decls you define in <a href=\"https://github.com/leanprover/cslib/pull/275\">cslib#275</a> and the decls I define in <a href=\"https://github.com/leanprover/cslib/pull/269\">cslib#269</a>, what is the type of the term you are looking to see defined?</p>",
        "id": 570608756,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1769618467
    },
    {
        "content": "<p>Iâ€™ll have to do some trial and error on that. If 269 gets merged I will work on that</p>",
        "id": 570608976,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618516
    },
    {
        "content": "<p>I think the first parameter to the query type would be the TM itself. The index type will be the configuration type of the TM</p>",
        "id": 570609458,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618618
    },
    {
        "content": "<p>Each query will produce a configuration of the TM</p>",
        "id": 570609563,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618641
    },
    {
        "content": "<p>evalQuery will be roughly identical to step</p>",
        "id": 570609858,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618713
    },
    {
        "content": "<p>there will be queries for initialisation, stepping, and termination.</p>",
        "id": 570610078,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618767
    },
    {
        "content": "<p>For non deterministic TMs, we use Classical.choice to pick the next step, the next state set is Nonempty.</p>",
        "id": 570610200,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1769618802
    },
    {
        "content": "<p>I will do my best to wrap this PR up asap. Only the merge sort example remains. I will however be tied with work until the middle of next week. I already have a linear search and a sorted insertion  example in there. I will move the circuit examples to a separate PR with more results for later. </p>\n<p>In the meantime <span class=\"user-mention\" data-user-id=\"687698\">@Chris Henson</span> mentioned that he would prefer to have one model for lightweight algorithms verification. Since this model subsumes TimeM and TimeM is already just  <code>WriterT (Multiplicative Nat)</code>, should I delete TimeM within this PR? </p>\n<p>Whatever this discussion throws up, I will implement it next week.  <br>\nCC <span class=\"user-mention\" data-user-id=\"929508\">@Fabrizio Montesi</span>.</p>",
        "id": 571951180,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770221080
    }
]