[
    {
        "content": "<p>I'm working on a PR to include branching bisimulation and ran into the need to introduce a closure relation on tau steps that is more basic that the already defined LTS.STr. I propose to call it LTS.τTr and would look something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Saturated τ-transition. relation. -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HasTau</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"n\">HasTau</span><span class=\"bp\">.</span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s3</span>\n</code></pre></div>\n<p>But if we have this, it makes sense to also update the other definitions that are intended to support weak bisimulation. I think LTS.STr could look something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Saturated transition relation. -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">STr</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HasTau</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">  </span><span class=\"n\">s</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">τTr</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"w\"> </span><span class=\"n\">s4</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">STr</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"n\">s4</span>\n</code></pre></div>\n<p>and a number of downstream 'induction helpers' would change into more τ-focused ones. </p>\n<p>I'm willing to make the changes, but I would like to know if `everyone agrees' before embarking on such a refactoring. I hope there is not too much outside the LTS.basic file that needs updating as a result, but I don't know how to check this.</p>",
        "id": 544881053,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760507262
    },
    {
        "content": "<p>The former sounds like 'tau transition', so it should probably be defined as lts.toRelation HasTau.tau; then we could define a tauSTr by applying the Refl/Trans Gen stuff in mathlib (which iirc comes with theorems/utilities) to it.<br>\nI haven't thought much about reformulating STr yet, but it sounds like it might make sense since it'd use simpler components (albeit multiple ones vs only one right now)?</p>",
        "id": 544987555,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760539263
    },
    {
        "content": "<p>I've taken a stab at implementing my own definition and succeeded with minimal damage to the remainder of the library. But your suggestion to make it a lts.toRelation sounds interesting. Do you have a more precise definition for me? (I'm not familiar with that part of the mathlib library yet.)</p>\n<p>And is there a way to share my progress on the refactoring without doing a PR? (I think I've made too many changes at once for a proper PR...)</p>",
        "id": 545120005,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760559233
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"929508\">@Fabrizio Montesi</span> I am tempted to first make a PR in which I split the basic file and the bisimulation file into smaller files. Have a \"HasTau\" file with basic definitions for the relation above, and a \"WeakLTS\" with the definition of the STr. How would you feel about that? I think it would give me a better overview of what it is that we are working on, and it would also allows a bit more precise explanation of what is going on in the doc-string.</p>",
        "id": 545380079,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760629919
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span> <a href=\"#narrow/channel/513188-CSLib/topic/LTS.3A.20.CF.84-transitions/near/545120005\">said</a>:</p>\n<blockquote>\n<p>I've taken a stab at implementing my own definition and succeeded with minimal damage to the remainder of the library. But your suggestion to make it a lts.toRelation sounds interesting. Do you have a more precise definition for me? (I'm not familiar with that part of the mathlib library yet.)</p>\n<p>And is there a way to share my progress on the refactoring without doing a PR? (I think I've made too many changes at once for a proper PR...)</p>\n</blockquote>\n<p>Sure. You can use this to define tauTr: <a href=\"https://cs-lean.github.io/Cslib/Foundations/Semantics/LTS/Basic.html#LTS.Tr.toRelation\">https://cs-lean.github.io/Cslib/Foundations/Semantics/LTS/Basic.html#LTS.Tr.toRelation</a></p>\n<p>And then this to define its reflexive and transitive closure: <a href=\"https://cs-lean.github.io/Mathlib/Logic/Relation.html#Relation.ReflTransGen\">https://cs-lean.github.io/Mathlib/Logic/Relation.html#Relation.ReflTransGen</a></p>",
        "id": 545409163,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760635499
    },
    {
        "content": "<p>Re sharing progress: create a branch in your fork and share a link to that here?</p>",
        "id": 545409257,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760635524
    },
    {
        "content": "<p>As to restructuring: we probably should, files are getting a bit big. As a first step, I'd still keep all things about tau and saturated transitions in LTS Basic, but we should at least split the different kinds of bisimilations out.</p>",
        "id": 545409928,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760635719
    },
    {
        "content": "<p>I'm planning to do some splits like this next week, so probably good to discuss them here first. This shouldn't block the work on tauTr &amp; co.</p>",
        "id": 545410121,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760635779
    },
    {
        "content": "<p>That looks useful indeed :-) I'll give it a shot.</p>",
        "id": 545506291,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760688023
    },
    {
        "content": "<p>First attempt can be found here: <a href=\"https://github.com/PieterCuijpers/cslib/blob/tauTr/Cslib/Foundations/Semantics/LTS/Basic.lean\">https://github.com/PieterCuijpers/cslib/blob/tauTr/Cslib/Foundations/Semantics/LTS/Basic.lean</a></p>\n<p>I've for the time being removed the definitions of STrN. I have a sense of why they would be useful if you are formalizing textbook proofs, but it's not really clear to me why we need them here already. I have not looked into whether \"Relation\" also has \"RelationN\" support in this way. If it has, fixing STrN is easy of course.</p>\n<p>Not having STrN also breaks some things in SWBisimulation.</p>",
        "id": 545572253,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760708670
    },
    {
        "content": "<p>STrN is used in proofs about weak/SW bisimulation iirc.</p>",
        "id": 545573352,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760709007
    },
    {
        "content": "<p>that <code>(fun s1 s2 =&gt; lts.Tr s1 HasTau.τ s2)</code> can just be <code>lts.Tr.toRelation HasTau.τ</code>, as I pointed out before. (or have you tried and it didn't work?)</p>",
        "id": 545573518,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760709050
    },
    {
        "content": "<p>and what you call <code>τTr</code>, I'd call <code>τSTr</code>, because it's reflexive and transitive (like STr).</p>",
        "id": 545573722,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760709105
    },
    {
        "content": "<p>although that's not a great name either, I admit, just a bit better, because it might be confused with <code>STr</code> itself... :-\\</p>",
        "id": 545573821,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1760709136
    },
    {
        "content": "<p>It didn't, but that was my bad, the following does work:</p>\n<p><code>def LTS.τTr [HasTau Label] (lts : LTS State Label) : State → State → Prop :=\n  Relation.ReflTransGen (Tr.toRelation lts HasTau.τ)</code></p>",
        "id": 545577304,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760710108
    },
    {
        "content": "<p>Not sure about naming either, I'm guessing both will be fine ultimately.</p>",
        "id": 545577467,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1760710157
    },
    {
        "content": "<p>sorry for the delay, been a bit swamped lately.<br>\nWhat I meant to say is that while I admit <code>τSTr</code> isn't a great name, it's at least acceptable for now.<br>\n<code>τTr</code> I'm too afraid it'll confuse concurrency theorists used to think of a 'tau-transition' as just a <code>lts.Tr s1 HasTau.τ s2</code>.</p>",
        "id": 546840960,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1761294839
    },
    {
        "content": "<p>Same swamp here ;-) Had a chance to update and look into it again a bit today.<br>\nI agree with your concern about the naming, so I've updated.<br>\nAlso finished some of the small proofs.<br>\nIn the meantime, I've lost the overview of what proofs are needed, but the ones that are in there now work.<br>\nStarted a separate PR for this.</p>",
        "id": 563789119,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1765795691
    },
    {
        "content": "<p>I was wondering if the \"labeling by number of tau steps\" is - in the end - really helpful?<br>\n(I mean the STrN definition and proofs).<br>\nI appreciate that in literature people will like to think of the induction to go over the number of tau steps,<br>\nso if you want to mimick a proof from literature it may be helpful to have theorems like this.<br>\nBut I imagine that there is always a \"simpler\" or \"shorter\" proof without in Lean, since the actual induction<br>\ntakes place over the definition of STr anyway.</p>\n<p>Why did you originally decide to include them?</p>",
        "id": 563789598,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1765795798
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span> <a href=\"#narrow/channel/513188-CSLib/topic/LTS.3A.20.CF.84-transitions/near/563789598\">said</a>:</p>\n<blockquote>\n<p>I was wondering if the \"labeling by number of tau steps\" is - in the end - really helpful?<br>\n(I mean the STrN definition and proofs).<br>\nI appreciate that in literature people will like to think of the induction to go over the number of tau steps,<br>\nso if you want to mimick a proof from literature it may be helpful to have theorems like this.<br>\nBut I imagine that there is always a \"simpler\" or \"shorter\" proof without in Lean, since the actual induction<br>\ntakes place over the definition of STr anyway.</p>\n<p>Why did you originally decide to include them?</p>\n</blockquote>\n<p>I remember Lean giving me trouble with things about SWBisimulation, so at the time I just went for the 'standard' technique of counting tau-steps. Also because that enables comparing the 'efficiency' of saturated transitions in the future, which is sometimes used in asymmetric relations like expansion (IIRC) -- however, arguably even there we could just do with an inductive, I guess.. to be checked in the future.</p>",
        "id": 563806559,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1765800827
    },
    {
        "content": "<p>Thanks for <a href=\"https://github.com/leanprover/cslib/pull/220\">cslib#220</a>, <span class=\"user-mention\" data-user-id=\"563058\">@Pieter Cuijpers</span>. I struggle a bit to get what's new and what's old, probably because you had to move some stuff around, there's some spacing change(s), and you reverted some 'scoped grind' to 'grind' (this is probably because you have to merge main).</p>\n<p>Since the PR doesn't touch on many defs for now, would you be ok with this plan: (a) I move the Relation and Trans sections where you need them in the <code>main</code> branch; and then (b) you pull/merge from 'main' and modify things a bit more in place?</p>",
        "id": 564654271,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1766137264
    },
    {
        "content": "<p>Ah, and this is making me realise that the Relation- and Trans-related definitions should be spread out: each relation should define its own stuff. WIP...</p>",
        "id": 564654850,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1766137459
    },
    {
        "content": "<p>There, something like this: <a href=\"https://github.com/leanprover/cslib/pull/231\">cslib#231</a></p>",
        "id": 564656117,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1766137892
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"929508\">Fabrizio Montesi</span> <a href=\"#narrow/channel/513188-CSLib/topic/LTS.3A.20.CF.84-transitions/near/564654271\">said</a>:</p>\n<blockquote>\n<p>Thanks for <a href=\"https://github.com/leanprover/cslib/pull/220\">cslib#220</a>, <span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span>. I struggle a bit to get what's new and what's old, probably because you had to move some stuff around, there's some spacing change(s), and you reverted some 'scoped grind' to 'grind' (this is probably because you have to merge main).</p>\n</blockquote>\n<p>I had a better look to see if I could make the difference between old and new clearer.<br>\nUnfortunately, the changes are a bit intertwined.</p>\n<p>As I commented before, the use of STrN is no longer needed, because I run the necessary inductions straight on the definitions. But the change in structure also has caused the equivalence of saturated_Tr and STr to become dependent on the proof of STr.comp, this was not the case before - which changes the order of the original proofs as well. In other words... maybe this is more of a refactor than a feature after all...</p>\n<p>All changes are compactly made within the \"Weak\" section of the file. That's something.<br>\nAnd if you like, I could remove all the theorems regarding STrN, since I think they are not necessary at all.<br>\nThey are not being used anymore in the bisimulation proofs.<br>\nThat would make the section a lot shorter and easier to review/compare to the old one?</p>",
        "id": 566375440,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1767625786
    },
    {
        "content": "<p>If the weighted versions are not needed anymore, you're welcome to remove them. :)</p>",
        "id": 566731406,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1767791760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"929508\">Fabrizio Montesi</span> <a href=\"#narrow/channel/513188-CSLib/topic/LTS.3A.20.CF.84-transitions/near/566731406\">said</a>:</p>\n<blockquote>\n<p>If the weighted versions are not needed anymore, you're welcome to remove them. :)</p>\n</blockquote>\n<p>Done, now :-)</p>",
        "id": 573103978,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1770744126
    }
]