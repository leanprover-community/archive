[
    {
        "content": "<p>After the recent toolchain bump to v4.27.0, a theorem name used in my PR <a href=\"https://github.com/leanprover/cslib/pull/278\">cslib#278</a>, <code>IsRegular.mul</code>, becomes in conflict with a mathlib theorem:<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Regular/Basic.html#IsRegular.mul\">https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Regular/Basic.html#IsRegular.mul</a><br>\nBut <code>git blame</code> on the above mathlib file tells me that that theorem has been in existence since 2024.  So what change in v4.27.0 has caused this name conflict?</p>",
        "id": 570180238,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1769458463
    },
    {
        "content": "<p>I'm speaking without any knowledge here, but if I were guessing: it's that the Mathlib declaration was not previously imported in CSLib, but now is.</p>",
        "id": 570180520,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1769458566
    },
    {
        "content": "<p>I doubt it.  I did <code>git grep -I Mathlib.Algebra</code> in cslib commits before and after the toolchain bump and didn't see any difference.</p>",
        "id": 570181637,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1769458995
    },
    {
        "content": "<p>I would guess you have a namespace issue in your PR, and intended to write <code>Language.IsRegular.mul</code> but wrote <code>IsRegular.mul</code> instead</p>",
        "id": 570187025,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769460605
    },
    {
        "content": "<p>Perhaps you dropped a <code>namespace Language</code> by accident when resolving a merge conflict</p>",
        "id": 570187062,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769460622
    },
    {
        "content": "<p>To help more we need to know more about what you mean by \"becomes in conflict\"; what was the actual error message?</p>",
        "id": 570187130,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769460650
    },
    {
        "content": "<p>In the file <code>Cslib/Computability/Automata/NA/Pair.lean</code> in <a href=\"https://github.com/leanprover/cslib/pull/278\">cslib#278</a>, there is a <code>grind</code> call on line 56:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsRegular</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">pairLang_regular</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which stopped working after I merged in the v4.27.0 bump in cslib's <code>main</code> branch, because <code>IsRegular.mul</code> now refers to the theorem in <code>Mathlib.Algebra.Regular.Basic</code> rather than the the theorem in <code>Cslib/Computability/Languages/RegularLanguage.lean</code>.  Adding the <code>Language.</code> prefix fixes the problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">IsRegular</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">pairLang_regular</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>But the question is why <code>IsRegular.mul</code> worked before but doesn't now.  The theorem <code>Language.IsRegular.mul</code> was not introduced in this PR or <a href=\"https://github.com/leanprover/cslib/pull/249\">cslib#249</a> (on which this PR depends) but has been in cslib's main for a while.  I did not encounter any merge conflicts when I merged the toolchain bump into <a href=\"https://github.com/leanprover/cslib/pull/249\">cslib#249</a> or <a href=\"https://github.com/leanprover/cslib/pull/278\">cslib#278</a>.</p>",
        "id": 570194411,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1769463948
    },
    {
        "content": "<p>My assessment is the same as Jireh's, probably a change in what is transitively imported based on changes upstream in Mathlib.</p>",
        "id": 570194765,
        "sender_full_name": "Chris Henson",
        "timestamp": 1769464115
    },
    {
        "content": "<p>Any way to find out for sure?  I still have a repo which has not been bumped.</p>",
        "id": 570195529,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1769464476
    },
    {
        "content": "<p>Sure, you can do <code>#check _root_.IsRegular.mul</code> in the unbumped repo and verify that it doesn't resolve</p>",
        "id": 570195666,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769464541
    },
    {
        "content": "<p>Or you could explicitly add the import to the old version of the file and verify that it breaks</p>",
        "id": 570195743,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769464573
    },
    {
        "content": "<p>I'm not sure I'd recommend it, but if you want to be immune to mathlib import restructuring, you can just <code>import Mathlib</code> everywhere</p>",
        "id": 570195802,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769464600
    },
    {
        "content": "<p>That way you always get everything and won't be surprised by things appearing and disappearing</p>",
        "id": 570195818,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769464611
    },
    {
        "content": "<p>We've avoided this intentionally so far. For anything that's in <code>main</code> already, you'll get a failure in <code>nightly-testing</code>, so it won't be a complete surprise.</p>",
        "id": 570196116,
        "sender_full_name": "Chris Henson",
        "timestamp": 1769464759
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110637\">Ching-Tsun Chou</span> <a href=\"#narrow/channel/513188-CSLib/topic/New.20name.20conflict.20with.20mathlib/near/570195529\">said</a>:</p>\n<blockquote>\n<p>Any way to find out for sure?  I still have a repo which has not been bumped.</p>\n</blockquote>\n<p>But to answer this, I have done everything but track down the Mathlib PR. The only thing that changed was the dependencies, and I can check out commits before and after and see that the resolution changes.</p>",
        "id": 570196416,
        "sender_full_name": "Chris Henson",
        "timestamp": 1769464878
    },
    {
        "content": "<p>I just verified that <code>#check _root_.IsRegular.mul</code> doesn't resolve in the un-bumped repo.  However, <code>#check _root_.IsRegular</code> does and points to the <code>IsRegular</code> defined in <code>Mathlib.Algebra.Regular.Defs</code>.  So something happened in the version bump that put <code>IsRegular.mul</code> in the top level.</p>",
        "id": 570196735,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1769465005
    },
    {
        "content": "<p>Right, what happened is that <code>Mathlib.Algebra.Regular.Defs</code> became transitively imported, as was discussed above</p>",
        "id": 570197190,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769465193
    },
    {
        "content": "<p>I'm not sure this is worth digging into further.</p>",
        "id": 570197213,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769465201
    },
    {
        "content": "<p>Yes, seems resolved to me. Also note that this release is perhaps expected to be noisy as this included running the new module-aware <code>shake</code> in Mathlib. We are also planning (as soon as I make the PR) to unpin the Mathlib revision and move to more frequently running <code>lake update</code>, so in the future these kinds of changes will land in the <code>main</code> branch more frequently. (Not that this completely helps the case when a PR is open across these changes)</p>",
        "id": 570197879,
        "sender_full_name": "Chris Henson",
        "timestamp": 1769465473
    },
    {
        "content": "<p>In addition, <span class=\"user-mention\" data-user-id=\"687698\">@Chris Henson</span>, I think it's reasonable to alert the Mathlib maintainers if churn in Mathlib is becoming burdensome in CSLib. I think probably this instance doesn't rise to that occaision, but it's worth noting for future reference. Of course, the response might be \"we're cleaning up the import hierarchy\", but alternatively it may force us to keep a closer eye on things like this.</p>",
        "id": 570199012,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1769465978
    },
    {
        "content": "<p>I think this is naturally something that <code>module</code>-izing mathlib will help address; removing <code>public import</code>s reduces the potential for leaked transitive results like this</p>",
        "id": 570200698,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769466781
    }
]