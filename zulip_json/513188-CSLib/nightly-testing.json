[
    {
        "content": "<p>This is getting a bit ahead of the game, but once the repo launches the Lean FRO would like to include it both in the list of repositories that we support updating to new Lean versions, and the list of repositories that we do testing against for individual Lean pull requests.</p>\n<p>For the former, this will mean creating a <code>nightly-testing</code> branch, which I'll then install some CI for, on which we will accumulate adaptations to Lean nightly releases. Most likely you'll also want to set up some infrastructure so that these adaptations can be progressively reviewed during the month, rather than waiting until the end of the month (or delegating that review to the FRO release manager, usually me) --- I'll explain how all that works when the time comes! Keeping the <code>nightly-testing</code> branch up to date with Lean nightly releases is <em>mostly</em> then handled by automation, and when it's not it's helpful to know what's going wrong early!</p>",
        "id": 527102919,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1751601674
    },
    {
        "content": "<p>&lt;Moved to better subchannel.&gt;</p>",
        "id": 527193718,
        "sender_full_name": "Kevin Sullivan",
        "timestamp": 1751640218
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, we have a repo now! I've created a <code>nightly-testing</code> branch. What now? :)</p>",
        "id": 535179941,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1755626713
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> !</p>",
        "id": 535214273,
        "sender_full_name": "Swarat Chaudhuri",
        "timestamp": 1755644845
    },
    {
        "content": "<p>The first step is <a href=\"https://github.com/leanprover/cslib/pull/38\">https://github.com/leanprover/cslib/pull/38</a>, which adds a regularly scheduled job that will merge <code>main</code> into <code>nightly-testing</code>, automatically resolving conflicts in favour of <code>nightly-testing</code>.</p>\n<p>(Note this is a bit dangerous: whoever is fixing <code>nightly-testing</code> needs to realise that sometimes there will be bad merge artifacts. The solution is usually to revert that file to the version from <code>main</code> and reapply any adaptations required for the latest Lean nightly.)</p>\n<p>Before we can merge this, we will need to create a token with <code>repo</code> privileges, in whichever Github account will push these changes (I recommend <code>leanprover-community-mathlib4-bot</code> for now, and Cslib can acquire its own bots later), and install this token as a Github secret on this repository, under the name <code>NIGHTLY_TESTING</code>.</p>\n<p>Now, I have an admin bit on <code>leanprover/cslib</code>, so I can actually do this step myself, but I'll wait for confirmation. :-)</p>",
        "id": 535215926,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755646313
    },
    {
        "content": "<p>The second step is <a href=\"https://github.com/leanprover/cslib/pull/39\">https://github.com/leanprover/cslib/pull/39</a>, which will regularly update the Lean toolchain used on the nightly-testing branch.</p>\n<p>This relies on the same token the previous workflow uses.</p>",
        "id": 535216199,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755646580
    },
    {
        "content": "<p>Note that this second job checks that Mathlib has a <code>nightly-testing-YYYY-MM-DD</code> tag for the current nightly (these tags are only created once Mathlib's nightly-testing branch is working), and only bumps the toolchain if this exists. It then simultaneously bumps the toolchain <em>and</em> changes the Mathlib <code>require</code> statement (which on <code>main</code> is pinned to a fixed revision of Mathlib) to point to that tag.</p>\n<p>This should have the effect that you'll only see errors which are actually about Cslib, once Mathlib has its shop in order!</p>",
        "id": 535216904,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755647187
    },
    {
        "content": "<p>However you <em>will</em> see failures here from changes in Mathlib itself between release cycles which break Cslib. I think it's best to be aware of these as these happen, rather than landing all at once at the end of each month.</p>",
        "id": 535217016,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755647295
    },
    {
        "content": "<p>The third step is <a href=\"https://github.com/leanprover/cslib/pull/40\">https://github.com/leanprover/cslib/pull/40</a>, which will:</p>\n<ul>\n<li>report successes or failures on the nightly-testing branch to Zulip in <a class=\"stream-topic\" data-stream-id=\"428973\" href=\"/#narrow/channel/428973-nightly-testing/topic/Cslib.20status.20updates/with/535218111\">#nightly-testing &gt; Cslib status updates</a> </li>\n<li>when nightly-testing succeeds<ul>\n<li>tag it as <code>nightly-testing-YYYY-MM-DD</code></li>\n<li>attempt to automatically create a PR from <code>nightly-testing</code> to the current <code>bump/v4.X.0</code> branch, which will need to be reviewed (i.e. changes which accumulate on <code>bump/v4.X.0</code> are considered \"good to go\", and in particular I have permission to merge them back to <code>main</code> when a new release comes out). If this succeeds, a bot will post a link to the PR to zulip. If this fails, a bot will post instructions for preparing this PR manually.</li>\n</ul>\n</li>\n</ul>",
        "id": 535218301,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648374
    },
    {
        "content": "<p>This step relies on an additional secret being installed, so give access to the Zulip bot. As above, I recommend that for now you just reuse the existing bot managed by Mathlib, and replace it as needed down the track.</p>",
        "id": 535218399,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648445
    },
    {
        "content": "<p>I can install this secret, but again I'll wait for confirmation.</p>",
        "id": 535218400,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648445
    },
    {
        "content": "<p>I <em>think</em> this is everything for now.</p>",
        "id": 535218473,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648516
    },
    {
        "content": "<p>One thing that is not done here is allowing contributors to the Lean repository to test their PRs against Cslib before merging (this is possible for mathlib and for the reference manual). I propose leaving that unimplemented for now.</p>",
        "id": 535218474,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648517
    },
    {
        "content": "<p>(Maybe one thing I should have said earlier: we also have the option of going with a more lightweight process! This setup adds some overhead, and is all predicated on the assumption that Cslib is going to take off and see significant growth. If that happens, and we're including Cslib in the batch of repositories that the FRO assists in keeping in sync with Lean releases, then I think this infrastructure is appropriate. If Cslib grows more slowly, or doesn't want to be included in the release process, we can certainly simplify.)</p>",
        "id": 535218637,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755648668
    },
    {
        "content": "<p>Thanks for the great summary, <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>!<br>\nI agree with all your suggestions, please go ahead and use your admin powers. Better realise breakage sooner rather than later.</p>\n<p>While you're at it, could I ask you to add <code>lean-release-tag</code> as well with the same bot? :⁠-⁠)</p>",
        "id": 535232134,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1755660420
    },
    {
        "content": "<p>Thanks for the help, <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>! I think this could be helpful. One point to mention is that we currently have a pinned Mathlib version in our lakefile. Previously I had updated this manually when I knew there was a release. Is the recommendation to remove this pin? (Otherwise the <code>lake update</code> will do nothing for nightly testing). I somewhat liked the certainty of having the pinned dependency, and have seen other projects do the same. Is there a way to  make this compatible with this tooling? Or is the idea that with so much automated feedback and a human in the loop on merging the accumulated <code>bump/v4.X.0</code> PRs that it's unnecessary to pin?</p>",
        "id": 535235801,
        "sender_full_name": "Chris Henson",
        "timestamp": 1755663952
    },
    {
        "content": "<p>No -- I was only suggesting removing the pin <strong>on the nightly-testing branch</strong>.</p>",
        "id": 535484343,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755775956
    },
    {
        "content": "<p>I see that <span class=\"user-mention\" data-user-id=\"929508\">@Fabrizio Montesi</span> has approved <a href=\"https://github.com/leanprover/cslib/pull/38\">cslib#38</a>, <a href=\"https://github.com/leanprover/cslib/pull/39\">cslib#39</a>, and <a href=\"https://github.com/leanprover/cslib/pull/40\">cslib#40</a> a few weeks ago. Anything holding us back from merging?</p>",
        "id": 539452099,
        "sender_full_name": "Chris Henson",
        "timestamp": 1757900305
    },
    {
        "content": "<p>I think Kim is just busy with the Lean release. :)</p>",
        "id": 539558745,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1757943001
    },
    {
        "content": "<p>Sorry about the delay here. I need to install some secrets for these PRs to work which I'm doing now as part of completing the <code>v4.24.0-rc1</code> checklist.</p>",
        "id": 539662737,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757980135
    },
    {
        "content": "<p>I have added a NIGHTLY_TESTING token in the cslib repository, which allows CI to use the leanprover-community-mathlib4-bot github account. I've also give that bot account write access, and accepted the invitation.</p>\n<p>I've also added the ZULIP_API_KEY secret, using the same account that mathlib4 uses to post to Zulip.</p>\n<p>(For now I'll record this information where we keep similar information for leanprover-community repositories, but if there's somewhere cslib specific you'd like it recorded, let me know. Similarly if/when we'd like to use separate accounts for these functions from the Mathlib ones, I can help with that.)</p>\n<p>I think these are the remaining requirements for merging these PRs, so I'll do that now.</p>",
        "id": 539663804,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757981058
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/513188-CSLib/topic/nightly-testing/near/539662737\">said</a>:</p>\n<blockquote>\n<p>Sorry about the delay here. I need to install some secrets for these PRs to work which I'm doing now as part of completing the <code>v4.24.0-rc1</code> checklist.</p>\n</blockquote>\n<p>No worries, I was just making sure it wasn't action required on our part. Thanks again!</p>",
        "id": 539665214,
        "sender_full_name": "Chris Henson",
        "timestamp": 1757982395
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, the update broke our doc toolchain because I forgot to mention that upgrades to the toolchain should be reflected here as well: <a href=\"https://github.com/leanprover/cslib/tree/main/docs\">https://github.com/leanprover/cslib/tree/main/docs</a></p>\n<p>Is it possible to automate that bit as well?</p>",
        "id": 540024504,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1758117916
    },
    {
        "content": "<p>The problem is in lakefile.toml, the rev of doc-gen4 needs to be bumped.</p>",
        "id": 540024699,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1758117965
    },
    {
        "content": "<p>Hopefully this is addressed by </p>\n<ul>\n<li><a href=\"https://github.com/leanprover/cslib/pull/62\">https://github.com/leanprover/cslib/pull/62</a></li>\n<li><a href=\"https://github.com/leanprover/lean4/pull/10433\">https://github.com/leanprover/lean4/pull/10433</a></li>\n</ul>",
        "id": 540126464,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758157589
    },
    {
        "content": "<p>There are some grind failures in nightly-testing --- if anyone is available to take a look at these that would be much appreciated. I would like to verify that Cslib works against the \"modulized\" Mathlib that we're about to merge, but these failures get in the way of testing.</p>\n<p>I can take a look later this afternoon.</p>",
        "id": 558098184,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763515830
    },
    {
        "content": "<p>I pushed a fix to the one of the two errors, having more trouble with the other. </p>\n<p>I am confused by a behavior of <code>grind?</code> here. I usually take a <code>grind</code> that fails on nightly, change it to <code>grind?</code> on main, and see how I can minimize the resulting <code>grind only</code> to help debug. But for this failure (<a href=\"https://github.com/leanprover/cslib/blob/e19cd0a17e3664845e68cae6e7648a2650f57c68/Cslib/Languages/LambdaCalculus/LocallyNameless/Fsub/Subtype.lean#L88\">this line</a>) I seem to get a <code>grind only</code> that fails.</p>",
        "id": 558107517,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763522348
    },
    {
        "content": "<p>I think this is fallout from me removing some problematic annotations in <a href=\"https://github.com/leanprover-community/mathlib4/pull/11206\">#11206</a>.</p>",
        "id": 558108050,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763522694
    },
    {
        "content": "<p>or .... seems not. Adding them back locally doesn't help.</p>",
        "id": 558108203,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763522818
    },
    {
        "content": "<p>Can you reproduce the <code>grind?</code> behavior I describe above on main? Seems like a bug, yes?</p>",
        "id": 558108505,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763523024
    },
    {
        "content": "<p>This theorem has been a problem previously, considering the adaptation note in a separate branch of the proof. I can look again in the morning and maybe try to make it more explicit. I think I have the original proof I wrote in a branch somewhere.</p>",
        "id": 558108870,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763523275
    },
    {
        "content": "<p>Indeed the suggestion from <code>grind?</code> doesn't work, however:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">append_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_cons_ne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_some</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_eq_none_iff</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Pairwise</span><span class=\"bp\">.</span><span class=\"n\">of_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">var</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">mem_toFinset</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">NodupKeys</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">weaken</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_cons_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">wf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">none_or</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nodup_iff_count</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_none</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">singleton_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">append_nil</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nodup_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nodup</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_nil</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nodup_iff_pairwise_ne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_self</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nodup_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">some_or</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">to_ok</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">cons_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pairwise_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">haswellformed_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">NodupKeys</span><span class=\"bp\">.</span><span class=\"n\">nodup</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">perm_nodupKeys</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">lc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">keys_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">nodup_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nil_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">cons_append</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LC</span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">haswellformed_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mem_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_eq_some_iff</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">mem_some</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Pairwise</span><span class=\"bp\">.</span><span class=\"n\">isChain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">append_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nodupKeys_middle</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">mem_def</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pairwise_middle</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">eq_or_mem_of_mem_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">keys_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">trans_tvar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">append_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">Or</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>does (and I knew to add <code>(instances := 10000)</code> by looking at the \"thresholds\" section of the grind failure output.</p>",
        "id": 558109096,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763523421
    },
    {
        "content": "<p>Ideally that wouldn't happen, but I don't think we can guarantee that there won't be edge cases where the <code>grind only</code> suggestion requires higher thresholds than <code>grind?</code>. We could of course re-run the <code>grind only</code> suggestion, detect hit thresholds, and raise them and try again...</p>",
        "id": 558109267,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763523556
    },
    {
        "content": "<p>Thanks, that makes sense. I think I need to look more carefully at what is happening, my guess is there are some annotations corresponding to weakening that get called continually.</p>\n<p>If still outstanding by the time I wake up, I'll know where to start :)</p>",
        "id": 558109662,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763523901
    },
    {
        "content": "<p>That can be manually minimized to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">X'</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">append_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_some</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">weaken</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dlookup_cons_eq</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">wf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">singleton_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">cons_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mem_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or_eq_some_iff</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">mem_some</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">=_</span><span class=\"w\"> </span><span class=\"n\">append_assoc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">trans_tvar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">Or</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"bp\">.</span><span class=\"n\">weaken</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sublist_append_of_sublist_right</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 558109673,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763523908
    },
    {
        "content": "<p>Ah okay, that works for nightly then. I'll still look into making this less fragile.</p>",
        "id": 558110009,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763524044
    }
]