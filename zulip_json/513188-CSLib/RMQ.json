[
    {
        "content": "<p>Hello, I've <a href=\"https://github.com/ldct/lean-monorepo/blob/main/cslib-v29-rc1/Playground/RMQ.lean\">formalized</a> a data structure (commonly called a \"sparse table\") that solves the RMQ problem, which is to find the minimum value in a sub-array of an array. I wonder if this is suitable for CSLib.</p>\n<p>Generally, preprocessing is needed on the input data; a data structure solves RMQ in &lt;p, q&gt; if the preprocessing time is p and the query time is q. Wikipedia has a summary of the different approaches.</p>\n<ul>\n<li>Naive approach (no preprocessing): &lt;O(1), O(n)&gt;</li>\n<li>Naively precompute all answers: &lt;O(n^3), O(1)&gt;</li>\n<li>Precompute all answers using dynamic programming: &lt;O(n^2), O(1)&gt;</li>\n<li>Sparse table (this formalization): &lt;O(n log n), O(1)&gt;</li>\n<li>Optimal solution: &lt;O(n), O(1)&gt;, e.g. <a href=\"https://link.springer.com/chapter/10.1007/978-3-540-74450-4_41\">Fischer and Heun</a></li>\n</ul>\n<p>There also exist easier solutions in &lt;O(n log log n), O(1)&gt; and &lt;O(1), O(log n)&gt; (both mentioned in the Wikipedia article), which could be intermediate targets to formalize before the optimal ones.</p>\n<p>My choice for stating that a data structure solves RMQ was to package the data structure, functions, and proofs into a structure, and use TimeM annotations for the time complexity:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">A structure for stating that `α` and some associated (TimeM-annotated) functions is a solution to the RMQ problem.</span>\n<span class=\"cm\">- `make` : preprocess an array of values `a`, returning an `α`</span>\n<span class=\"cm\">- `query` : query `α` for the minimum value in a subarray of `a`</span>\n<span class=\"cm\">- `correct` : the result is the same as the naive implementation</span>\n<span class=\"cm\">- `make_time`, `query_time` : the time complexity of `make` and `query`, as a function of `|a|`</span>\n<span class=\"cm\">- `make_time_bound`, `query_time_bound` : proofs of the time complexity bounds</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">RMQSolution</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TimeM</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TimeM</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">correct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">⟪</span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"bp\">⟪</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⟫</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">⟫</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">rmqNaive</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span>\n<span class=\"w\">  </span><span class=\"n\">make_time</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">make_time_bound</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">make_time</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">query_time</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">query_time_bound</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"bp\">⟪</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⟫</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">query_time</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RMQSolution</span><span class=\"w\"> </span><span class=\"n\">SparseTable</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SparseTable</span><span class=\"bp\">.</span><span class=\"n\">make</span>\n<span class=\"w\">  </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SparseTable</span><span class=\"bp\">.</span><span class=\"n\">query</span>\n<span class=\"w\">  </span><span class=\"n\">correct</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">correct</span>\n<span class=\"w\">  </span><span class=\"n\">make_time</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">make_time_bound</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SparseTable</span><span class=\"bp\">.</span><span class=\"n\">make_time</span>\n<span class=\"w\">  </span><span class=\"n\">query_time</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">query_time_bound</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SparseTable</span><span class=\"bp\">.</span><span class=\"n\">query_time</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 575226766,
        "sender_full_name": "Li Xuanji",
        "timestamp": 1771823933
    },
    {
        "content": "<p>This is the kind of formalisation I would prefer to see in Prog instead of TimeM, because it starts to reach the threshold where review complexity goes up since you are using custom tick sizes</p>",
        "id": 575269942,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771843316
    },
    {
        "content": "<p>And this is just the beginning.</p>",
        "id": 575269979,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771843328
    }
]