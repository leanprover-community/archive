[
    {
        "content": "<p>I am making a DSL, and have numeric literals which may be of different type, so I thought I'd use what Lean does and try to synthesize <code>OfNat</code>. My first attempt was:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabDsl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">A</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">ofNat</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>However, since the expected type <code>A</code> can be unknown, we fail to synthesize the <code>OfNat</code> instance. (It could be <code>Int</code>, <code>BitVec _</code>, etc.). I need to postpone synthesizing <code>OfNat</code>, <code>HAdd</code>, etc until after expected type is known. For this, I found <code>mkInstMVar</code> and used that in place of <code>synthInstance</code>. However, now my instance mvars are never instantiated.</p>\n<p>There is probably an idiomatic way of doing this, I just can't find it.</p>",
        "id": 489358054,
        "sender_full_name": "Max Nowak 游낼",
        "timestamp": 1734388234
    },
    {
        "content": "<p>Sounds like a good use of <code>tryPostponeIfNoneOrMVar</code> on your expected type to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">typ?</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">tryPostponeIfNoneOrMVar</span><span class=\"w\"> </span><span class=\"n\">typ?</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">typ?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"some informative message\"</span>\n</code></pre></div>",
        "id": 489358522,
        "sender_full_name": "Henrik B칬ving",
        "timestamp": 1734388405
    },
    {
        "content": "<p>I'm not sure how to use this. That looks like it just aborts my elaboration altogether if my inst is an mvar? I want my instance to be an mvar, because sometimes I legit don't know the expected type <code>A</code>. I am not sure how to make Lean finish TC synthesis once those mvars are known.</p>",
        "id": 489359227,
        "sender_full_name": "Max Nowak 游낼",
        "timestamp": 1734388686
    },
    {
        "content": "<p><code>mkInstMVar</code> sounds like what I want, but it has no documentation and I wasn't able to find much about it here on Zulip.</p>",
        "id": 489359586,
        "sender_full_name": "Max Nowak 游낼",
        "timestamp": 1734388789
    },
    {
        "content": "<p><code>mkInstMVar</code> is right (and in fact <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.elabNumLit#doc\">docs#Lean.Elab.Term.elabNumLit</a> uses it for constructing the OfNat instance)</p>",
        "id": 489360661,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734389205
    },
    {
        "content": "<p>To finish elaboration, you have to either wrap your elaboration routine in <code>withSynthesize</code> or have a <code>synthesizeSyntheticMVarsNoPostponing</code> checkpoint</p>",
        "id": 489360771,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734389250
    },
    {
        "content": "<p>Oh wow that did it. Perfect. Awesome. Thanks a ton!</p>",
        "id": 489361256,
        "sender_full_name": "Max Nowak 游낼",
        "timestamp": 1734389423
    },
    {
        "content": "<p>For a mini case study, here's part of the <code>change</code> tactic: <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/Tactic/Change.lean#L21\">https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/Tactic/Change.lean#L21</a></p>\n<p>The <code>runTermElab</code> itself is responsible for doing <code>synthesizeSyntheticMVarsNoPostponing</code> before returns. On line 30, there's a partial checkpoint that allows typeclass problems to be postponed, allowing the isDefEq to try to solve for pending instances.</p>\n<p>Then, elaboration is complete, so it's safe to use the next method, which does <code>isDefEq</code> inside a context where synthetic opaque metavariables become assignable. (That let's <code>change</code> assign <code>?m</code> metavariables for example.)</p>",
        "id": 489361704,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734389613
    }
]