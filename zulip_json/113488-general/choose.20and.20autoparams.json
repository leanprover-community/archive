[
    {
        "content": "<p>What is the cleanest way to use autoparams where you would normally use <code>choose</code>? E.g. if I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"c1\">-- foo : (k : ℕ) → k &lt; 0 → ℕ</span>\n<span class=\"w\">  </span><span class=\"c1\">-- foo_spec : ∀ (k : ℕ) (h : k &lt; 0), foo k h = k</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>what is the easiest way I can have <code>(h : k &lt; 0 := by grind)</code> in the signature(s)?</p>",
        "id": 564183427,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765955015
    },
    {
        "content": "<p>I don't understand. Could you provide an example of what you want to happen?</p>",
        "id": 564183891,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765955281
    },
    {
        "content": "<p>Hmm, I'm not sure how to restate more clearly. I'd like to know the best way for instance in the above example to  end up with <code>foo : (k : ℕ) → (h : k &lt; 0 := by grind) → ℕ</code> and/or <code>foo_spec : ∀ (k : ℕ) (h : k &lt; 0 := by grind), foo k h = k</code>, does that make sense?</p>",
        "id": 564185980,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765956392
    },
    {
        "content": "<p>Thanks, now I understand.</p>",
        "id": 564186193,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765956490
    },
    {
        "content": "<p>I haven't added autoparams inside a proof before, but presumably this would do it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h'</span>\n</code></pre></div>",
        "id": 564192160,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1765959143
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/113488-general/topic/choose.20and.20autoparams/near/564192160\">said</a>:</p>\n<blockquote>\n<p>I haven't added autoparams inside a proof before, but presumably this would do it:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h'</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Nope, this doesn't work, <code>choose</code> evaluates autoParam too eagerly.</p>",
        "id": 564192625,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765959320
    },
    {
        "content": "<p>But I suspect, it's possible to make <code>choose</code> handle <code>autoParam</code> so that this works.</p>",
        "id": 564192843,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765959397
    },
    {
        "content": "<p>Wait what? What are you saying <code>choose</code> does here? Surely it isn't able to synthesize a proof of <code>k &lt; 0</code>?</p>",
        "id": 564193415,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1765959622
    },
    {
        "content": "<p>(I'm typing from mobile)</p>",
        "id": 564193463,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1765959639
    },
    {
        "content": "<p>Yes, it fails, because it couldn't synthesize the proof of <code>k &lt; 0</code>.</p>",
        "id": 564193518,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765959661
    },
    {
        "content": "<p>Right, it can't synthesize a proof, but will eagerly fail to do so.</p>",
        "id": 564193547,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765959670
    },
    {
        "content": "<p>This does what you want, but the syntax is far from perfect.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NatWrap</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">prop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">NatWrap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NatWrap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hx</span>\n</code></pre></div>",
        "id": 564193648,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765959699
    },
    {
        "content": "<p>The above isn't working in the web editor or locally for me. Did you mean to have <code>prop : 0 &lt; val := by grind</code> for this example?</p>",
        "id": 564198268,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765961377
    },
    {
        "content": "<p>Oh, wait, you just need to write <code>using @h</code>, not <code>using h</code> and it works.</p>",
        "id": 564208059,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765964544
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"687698\">Chris Henson</span> <a href=\"#narrow/channel/113488-general/topic/choose.20and.20autoparams/near/564198268\">said</a>:</p>\n<blockquote>\n<p>The above isn't working in the web editor or locally for me. Did you mean to have <code>prop : 0 &lt; val := by grind</code> for this example?</p>\n</blockquote>\n<p>It works, in the sense, that I tried to prove <code>3 &lt; 0</code> using <code>by grind</code>. It failed to prove it of course.</p>",
        "id": 564208272,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765964608
    },
    {
        "content": "<p>Ah, no, sorry, it should be <code>val &lt; 0</code>, not <code>k &lt; 0</code>. But you can also use <code>0 &lt; val</code>, if you want to see what happens when<code>by grind</code> succeeds.</p>",
        "id": 564208512,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765964678
    },
    {
        "content": "<p>Anyway, that is obsolete now. This does exactly what you wanted:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Choose</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">foo_spec</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 564209618,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765964985
    },
    {
        "content": "<p>What happens, is that it wasn't <code>choose</code> fault, that <code>autoProp</code> was eagerly expanded. The term <code>h</code>, when elaborated, already expands <code>autoProp</code>, that's why you need <code>@h</code>.</p>",
        "id": 564211018,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765965391
    },
    {
        "content": "<p>This is perfect, thanks!</p>",
        "id": 564211078,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765965408
    },
    {
        "content": "<p>(your explanation is good too!)</p>",
        "id": 564211379,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765965500
    }
]