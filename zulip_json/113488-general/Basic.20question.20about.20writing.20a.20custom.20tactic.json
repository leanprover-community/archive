[
    {
        "content": "<p>I am trying to write a custom tactic that runs the rw tactic on a list of equalities generated by this custom tactic. But I am struggling to make `(tactic|rw ARRAY_OF_GENERATED_FACTS), where ARRAY_OF_GENERATED_FACTS refer to a list of lemmas that my custom tactic proved already and added to the hypothesis of the current goal state. Would some of you help me how to fix this? A baby version of this problem can be seen in the Lean code below:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"my_custom_rewrite_h0\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rwRule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic.rwRule</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`h0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacticSyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">rwRule</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tacticSyntax</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">example_with_hyps</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_final</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">my_custom_rewrite_h0</span>\n</code></pre></div>\n<p>Although the assumption h0 is in the hypothesis, the my_custom_rewrite_h0 tactic fails to use it. Lean complains and says that the argument of rw in the implementation of my_custom_rewrite_h0 does not refer to the proof of some equality or iff statement. How should I change the argument part of rw in the above code?  </p>\n<p>Thank you very much for your help.<br>\nHongseok</p>",
        "id": 521429885,
        "sender_full_name": "Hongseok Yang",
        "timestamp": 1748686907
    },
    {
        "content": "<p>I'm on my mobile right now so I can't investigate deeper, but I think Lean's macro hygiene ensures that identifiers built in a macro won't refer to variables in the caller's environment. The <code>h0</code> in your macro probably refers to a different name than your lemma hypothesis.</p>\n<p>I don't know how to circumvent macro hygiene. I'm sure there is a way, but I wonder whether there's a more idiomatic solution to your problem. What are you trying to achieve with your tactic?</p>",
        "id": 521451940,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1748705294
    },
    {
        "content": "<p>I also think you are being hit by hygiene. I do not understand why not to pass <code>h0</code> as an argument to your tactic but I`m guessing that is not what you want. Can you show a more complicated example of the tactic you want to write?</p>",
        "id": 521454563,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1748707335
    },
    {
        "content": "<p>This is not type-correct: <code>let rwRule : TSyntax `Lean.Parser.Tactic.rwRule := TSyntax.mk (mkIdent `h0)</code><br>\n<code>rwRule</code> is its own node, so you'd really need to do <code>mkNode ``rwRule #[mkNullNode #[], mkIdent `h0, mkNullNode #[]]</code><br>\nBut don't do that because you can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacticSyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`h0</span><span class=\"o\">):</span><span class=\"n\">ident</span><span class=\"o\">])</span>\n</code></pre></div>\n<p>(in general avoid using <code>TSyntax.mk</code>)<br>\nI'm assuming the original problem was that it didn't infer <code>ident</code> correctly as the type and instead assumed <code>rwRule</code>. Because parsing happens first it can't know what the type you want at that point and it's often better to just specify using the colon.</p>",
        "id": 521463634,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748714331
    },
    {
        "content": "<p>Thank you very much, Robin, Tomas, and Paul. Robin, your suggestion works, but what I need is actually a slightly more complex. I have an array of identifiers hs = #[mkIdent<code>h0, mkIdent </code>h1, ..., mkIdent<code>hn], and want to convert this as an argument to rw, and have something like  </code>(tactic| rw hs).  What I should do? Here is a modified version of my first example that illustrates this challenge.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"my_custom_rewrite_h0\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let rwRule : TSyntax `Lean.Parser.Tactic.rwRule := TSyntax.mk (mkIdent `h0)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let tacticSyntax ← `(tactic| rw [$rwRule])</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`h0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`h1</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacticSyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tacticSyntax</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">example_with_hyps</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h_final</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">my_custom_rewrite_h0</span>\n</code></pre></div>\n<p>What follows  explains the background of my question. Feel free to ignore it. I also tried to attach the current implementation of my tactic, but it is too long and Zulip refuses me to add the implementation at the end of this message.</p>\n<p>Regarding what I want to do ultimately, I would like to implement a tactic that proves the equality between the products of combinations (i.e., e1.choose e2), using a simple proof strategy of expanding combinations to factorials and cancelling the same factors on both sides. I am doing this in multiple stages. First, I go through all the combinations (e1.choose e2) of both sides of the equality, and creates the product of the denominators of their factorial representations (e2.factorial * (e1 - e2).factorial). This product gets multiplied to both sides of the equality. Next, I rearrange the factors in both sides and group them such that each group has the form (e1.choose e2 * e2.factorial * (e1-e2).factorial). Third, I rewrite each such group to e1.factorial, using the generated equalities (e1.choose e2 * e2.factorial * (e1-e2).factorial = e1.factorial) that I generate using some lemma in Mathlib. Finally, I call an existing tactic (such as ring or ring_nf) to prove that the rewritten equalities hold. </p>\n<p>The issue in my post comes from my failed attempt to implement the third step.</p>",
        "id": 521478967,
        "sender_full_name": "Hongseok Yang",
        "timestamp": 1748727788
    },
    {
        "content": "<p>The correct syntax is <code>let tacticSyntax ← `(tactic| rw [$[$h:ident],*])</code></p>",
        "id": 521479864,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748728693
    },
    {
        "content": "<p>If you want to read about some of the details of quotations, Metaprogramming in Lean 4 has <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/06_macros.html#syntax-quotations\">a section</a> about them.</p>",
        "id": 521479893,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748728747
    }
]