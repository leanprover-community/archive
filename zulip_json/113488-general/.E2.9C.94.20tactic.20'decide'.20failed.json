[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>\n<p>In this example above, I found that the first evaluation successfully computed the cycleType as {2}, but trying to solve the second example by tactic 'decide' fails and pops up the notification<br>\n\"tactic 'decide' failed for proposition<br>\n  (Equiv.swap 0 1).cycleType = {2}<br>\nsince its 'Decidable' instance reduced to<br>\n  Decidable.rec (fun h =&gt; (fun hp =&gt; isFalse ⋯) h) (fun h =&gt; (fun hp =&gt; isTrue ⋯) h)<br>\n    (Multiset.instDecidableEquivListOfDecidableEq<br>\n      (<a href=\"http://List.map\">List.map</a> (Finset.card ∘ <a href=\"http://Equiv.Perm.support\">Equiv.Perm.support</a>)<br>\n        (↑(Equiv.Perm.cycleFactorsAux (List.finRange 2) (Equiv.swap 0 1) ⋯)).dedup)<br>\n      [2])<br>\nrather than to the 'isTrue' constructor.\"<br>\nWhy would this happen? I'd really appreciate your help!</p>",
        "id": 465929904,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1724916599
    },
    {
        "content": "<p><code>#eval</code> and <code>decide</code> use different code paths altogether; you should not assume that one works because the other does</p>",
        "id": 465938067,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724918720
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> Thanks! But how can I circumvent this when proving the example, like evaluating the left hand side?</p>",
        "id": 465938350,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1724918815
    },
    {
        "content": "<p>In this case, I used <a href=\"https://loogle.lean-lang.org/?q=Equiv.Perm.cycleType\">https://loogle.lean-lang.org/?q=Equiv.Perm.cycleType</a> to find theorems that seemed plausible and got lucky:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">cycleType_finRotate_of_le</span><span class=\"w\"> </span><span class=\"n\">le_rfl</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 465939389,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724919127
    },
    {
        "content": "<p>Generally, though, this sort of error indicates someone has written a bad <code>Decidable</code> instance. I'm not immediately sure what it is here, but hopefully someone can help you. :-)</p>",
        "id": 465939884,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724919258
    },
    {
        "content": "<p>Certainly that's a way to prove that, but I'm still confused on why 'decide' wouldn't work in this case. It would be really helpful if you could elaborate a bit on this. Thanks!</p>",
        "id": 465940001,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1724919302
    },
    {
        "content": "<p>If you move to a newer mathlib, the <code>decide</code> tactic now has a feature to try to help you debug what is the problem. Here's the whole error in this case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">decide'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">proposition</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">2</span><span class=\"o\">}</span>\n<span class=\"n\">since</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Decidable'</span><span class=\"w\"> </span><span class=\"kn\">instance</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cycleType</span><span class=\"bp\">.</span><span class=\"n\">decidableEq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">2</span><span class=\"o\">}</span>\n<span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">isTrue'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">isFalse'</span><span class=\"bp\">.</span>\n<span class=\"n\">After</span><span class=\"w\"> </span><span class=\"n\">unfolding</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">decEq'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">decidable_of_decidable_of_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">decidable_of_iff'</span><span class=\"o\">,</span>\n<span class=\"bp\">'</span><span class=\"n\">decidable_of_iff''</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">instDecidableEqBool'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">instDecidableEqFin'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">instDecidableEqNat'</span><span class=\"o\">,</span>\n<span class=\"bp\">'</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">decEq'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">decidableBEx'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">decidablePerm'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">decidableEq'</span><span class=\"o\">,</span>\n<span class=\"bp\">'</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">instDecidableEquivListOfDecidableEq'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">decEq'</span><span class=\"w\"> </span><span class=\"n\">and</span>\n<span class=\"bp\">'</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">instDecidableRelSameCycleOfFintypeOfDecidableEq'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">reduction</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">stuck</span>\n<span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Decidable'</span><span class=\"w\"> </span><span class=\"kn\">instance</span>\n<span class=\"w\">  </span><span class=\"k\">match</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">support</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">dedup</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isPerm</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n</code></pre></div>\n<p>What you are supposed to get from this is that <code>decide</code> wasn't able to reduce this <code>match</code> expression, and in particular it wasn't able to reduce one of the discriminants (that's what's required to make progress here).</p>\n<p>In particular, for whatever reason it can't reduce</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">support</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">dedup</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isPerm</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(You can use <code>set_option pp.proofs true</code> to see the omitted proofs.)</p>",
        "id": 467311524,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725382130
    },
    {
        "content": "<p>It seems possible that an issue is that <code>Equiv.Perm.cycleFactorsAux</code> is defined using tactics that create terms that obstruct reduction, but it would take more investigation.</p>",
        "id": 467312112,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725382264
    },
    {
        "content": "<p>I changed <code>cycleFactorsAux</code> so it is not using <code>by</code> (<a href=\"https://github.com/leanprover-community/mathlib4/pull/16465\">#16465</a>), but that doesn't help.</p>",
        "id": 467402199,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420289
    },
    {
        "content": "<p>I suspect the culprit is something to do with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">truncCycleFactors</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Trunc</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsCycle</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">Pairwise</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">recOnSubsingleton</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Trunc</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mem_univ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 467402290,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420318
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">truncCycleFactors</span><span class=\"bp\">.</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">--- evaluates to `true`</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">truncCycleFactors</span><span class=\"bp\">.</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"c1\">--- fails</span>\n</code></pre></div>",
        "id": 467402428,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420363
    },
    {
        "content": "<p>hmm, maybe not, as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 467402865,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420493
    },
    {
        "content": "<p>exhibits the same behaviour.</p>",
        "id": 467402872,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420498
    },
    {
        "content": "<p>I guess the fact that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">cycleFactorsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>produces a giant term beginning with <code>And.rec</code> is a bad sign. But it's so big that I don't really know where to look next.</p>",
        "id": 467403539,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420871
    },
    {
        "content": "<p>It would be great if we had a tool for identifying the subexpressions that plausibly should be reducing further!</p>",
        "id": 467403544,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725420888
    },
    {
        "content": "<p>It seems like it could be the <code>let ⟨m, hm₁, hm₂, hm₃⟩</code> in <code>cycleFactorsAux</code>? That's causing a proof to be split on. The proof splitting should be pushed down into the proofs that use <code>hm₁, hm₂, hm₃</code>.</p>",
        "id": 467404238,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725421423
    },
    {
        "content": "<p>One hint supporting this is that the last argument to the giant <code>And.rec</code> has a type that's three propositions anded together.</p>",
        "id": 467404349,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725421480
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"750070\">@Wang Jingting</span>, is this something you would like to look into?</p>",
        "id": 467407922,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725423196
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16482\">#16482</a> makes your <code>decide</code> proof go through, <span class=\"user-mention\" data-user-id=\"750070\">@Wang Jingting</span></p>",
        "id": 467587455,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725465720
    },
    {
        "content": "<p>How did the let lead to an issue? Does that mean we can't use let deconstruction on Prop in term constructions?</p>",
        "id": 467613254,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1725470688
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"308899\">@Yakov Pechersky</span> The <code>let</code> was destructuring an <code>And</code>, which is syntax sugar for a <code>match</code>, and whnf reduces matches by reducing discriminants to their constructors — this means reducing the proof to an <code>And.intro</code>. This was blocking reduction of the value that we actually wanted.</p>\n<p>A fix is to move such destructuring into proofs, since that way it can't block reduction of the value you care about. In <a href=\"https://github.com/leanprover-community/mathlib4/pull/16482\">#16482</a>, it was more convenient using projections.</p>\n<p>It's similar to how you can use <code>noncomputable</code> values all you want in a computable definition, so long as you use the noncomputable values inside of proofs or types, which are computationally irrelevant and so are erased. I know I've needed to take <code>let</code>s with noncomputable instances and push them into the proofs before.</p>",
        "id": 467675041,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725490359
    },
    {
        "content": "<p>Thank you all so much for your support! I initially encountered this problem while proving alternating groups are simple, I tried to reduce calculations in $S_n$ to calculations in $S_6$ and hoped that tactics like 'decide' would help me automatically close the goal. But a similar weird thing happened, so I tried in a slightly smaller example, found the problem to occur again and decided to post this thread. Thanks again for your kind help!</p>",
        "id": 467690248,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1725498832
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"750070\">Wang Jingting</span> has marked this topic as resolved.</p>",
        "id": 467690273,
        "sender_full_name": "Notification Bot",
        "timestamp": 1725498841
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> might have a proof that alternating groups are simple?</p>",
        "id": 467691801,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725499769
    },
    {
        "content": "<p>Indeed,I have two proofs, one elementary (in Lean3)  and one more sophisticated (that I am slowly pushing to mathlib4)</p>",
        "id": 467739821,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1725520031
    }
]