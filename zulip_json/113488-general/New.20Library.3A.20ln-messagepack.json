[
    {
        "content": "<hr>\n<p>Hi everyone! I'm excited to share a new library I've been working on: <strong><code>ln-messagepack</code></strong>, a pure Lean 4 serialization library for MessagePack.</p>\n<p>It provides a fast, type-safe API for encoding and decoding Lean data structures with no external dependencies (just <code>batteries</code>). It's also tested and benchmarked!</p>\n<p>Key features include:</p>\n<ul>\n<li>\n<p>Support for all major types (nil, bool, int, string, etc.).</p>\n</li>\n<li>\n<p>Out-of-the-box support for <code>Array</code> and <code>List</code>.</p>\n</li>\n<li>\n<p>A full implementation of the <code>ext</code> type family, with <code>Timestamp</code> included.</p>\n</li>\n</ul>\n<p><del>The only feature not yet supported is the decoding of <code>float</code>/<code>double</code> types, due to the lack of a bitwise <code>Float.ofUInt64</code> primitive in Lean 4. I decided it was better to release a robust library with this known limitation than to add a fragile, custom implementation.</del><br>\nEDIT: I was using an old documentation as reference. The latest versions of Lean4 do indeed have such primitives. Floats will be added by Monday.</p>\n<p><strong>GitHub:</strong> <a href=\"https://github.com/ItsMeForLua/ln-messagepack\">https://github.com/ItsMeForLua/ln-messagepack</a></p>\n<p>It's easy to use. Just add it to your <code>lakefile.lean</code>:</p>\n<p>Lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">ln</span><span class=\"bp\">-</span><span class=\"n\">messagepack</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/itsmeforlua/ln-messagepack\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n</code></pre></div>\n<p>And then import the main module in your file:</p>\n<p>Lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">LnMessagepack</span><span class=\"bp\">.</span><span class=\"n\">MessagePack</span>\n</code></pre></div>\n<p><strong>Basic Example:</strong></p>\n<p>Lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encodeToMsgPackBytes</span><span class=\"w\"> </span><span class=\"s2\">\"hello from Lean!\"</span>\n<span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">decodeFromMsgPackBytes</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Decoded: {s}\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Failed!\"</span>\n</code></pre></div>\n<p>I'd love to get any feedback or suggestions you might have.</p>\n<p>Have fun not using JSON :)</p>\n<hr>",
        "id": 526220102,
        "sender_full_name": "io.shift",
        "timestamp": 1751134153
    },
    {
        "content": "<p>Here's some thoughts:</p>\n<ul>\n<li>In Rust, you can do <code>#[derive(Serialize, Deserialize)]</code> instead of adding ad-hoc classes for each format. There should be a way to do something similar in Lean</li>\n<li>Since it's Lean, one should consider not only implementing things, but also proving them against a spec</li>\n<li>Any plans for <a href=\"https://cbor.io/\">CBOR</a>?</li>\n</ul>",
        "id": 526222583,
        "sender_full_name": "suhr",
        "timestamp": 1751136694
    },
    {
        "content": "<p>Not sure what lean version you're using but there should be <code>Float</code> and <code>Float32</code> with <code>Float.toBits</code>, <code>Float.ofBits</code>, <code>Float32.toBits</code> and <code>Float32.ofBits</code></p>",
        "id": 526224864,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751139734
    },
    {
        "content": "<p>--<em>deleted message</em>--</p>",
        "id": 526225236,
        "sender_full_name": "io.shift",
        "timestamp": 1751140282
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394485\">@suhr</span> <br>\nHi suhr, thanks so much for the thoughtful feedback! Those are all fantastic points.</p>\n<p>On deriving: That's a great idea for a future version! I agree that a deriving MsgPackEncode handler would be a huge usability win. I'll add it to the long-term roadmap. It would definitely be a great idea to dive into Lean's metaprogramming. :)</p>\n<p>On proofs: I think formally proving correctness against the spec is a great long-term vision and would be a perfect way to leverage Lean's strengths. It's a huge project, but something I would surely LOVE to see happen.(probably within the month because coding is my obsession)</p>\n<p>In regards to CBOR: That's an interesting thought! For now, my focus is on making the MessagePack implementation as complete and robust as possible. Once it's fully mature, expanding to other formats like CBOR could be a cool direction for the future. Although, knowing how I am, I'll probably start working on that next week lol</p>\n<p>Thanks again for the great suggestions!</p>",
        "id": 526225372,
        "sender_full_name": "io.shift",
        "timestamp": 1751140444
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>  Hello Robin, you're right lol I just checked the official latest documentation and it's definitely there. I was clearly using an old documentation for reference. I'll add floats by Monday, once I finish my final exams this weekend.</p>",
        "id": 526225424,
        "sender_full_name": "io.shift",
        "timestamp": 1751140526
    },
    {
        "content": "<p>For encoding, I'd use an accumulator byte array instead of allocating one every time. That means update the signature of <code>encodeToBytes</code> to <code>def encodeToBytes (v : MsgPackValue) (acc : ByteArray := .empty) : ByteArray :=</code> and using <code>push</code> to encode bytes.</p>",
        "id": 526228710,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751145194
    },
    {
        "content": "<p>If you want proofs, newer versions should also allow you to get rid of the <code>partial</code> in <code>encodeToBytes</code>.</p>",
        "id": 526228825,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751145357
    },
    {
        "content": "<p>Also you probably want the <code>EStateM</code> monad for all parsing stuff, so <code>def parse (bytes : ByteArray) : EStateM String Nat MsgPackValue := do</code> and using <code>get</code>, <code>set</code> and <code>modify</code> for accessing the offset.</p>",
        "id": 526228960,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751145550
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>  In regards to partial's, I had tried to do it without partial, but I was getting type errors pretty consistently. I have the latest stable release, but, aren't recursions in lean that aren't descending (and/or can't be proven as such), needed to be specified as partial?</p>\n<p>If not, then I would definitely prefer to get rid of partial haha</p>\n<p>If there's a way to prove to lean(4) the termination of the (and other def's) recursion, let me know ! <br>\nI'm still fairly new to lean4, so any \"work around\"  would be very much appreciated by me</p>",
        "id": 526236096,
        "sender_full_name": "io.shift",
        "timestamp": 1751156827
    },
    {
        "content": "<p><a href=\"https://lean-lang.org/doc/reference/latest///Definitions/Recursive-Definitions/#well-founded-recursion\">https://lean-lang.org/doc/reference/latest///Definitions/Recursive-Definitions/#well-founded-recursion</a></p>",
        "id": 526236303,
        "sender_full_name": "suhr",
        "timestamp": 1751157149
    },
    {
        "content": "<p>Parsing consumes input, so length of remaining input could be used as a measure.</p>",
        "id": 526236434,
        "sender_full_name": "suhr",
        "timestamp": 1751157345
    },
    {
        "content": "<p>wow I feel stupid for not thinking of that <br>\nI'll have to update those def's today so they're a bit more reliable than how they are rn<br>\nThank you,</p>",
        "id": 526236559,
        "sender_full_name": "io.shift",
        "timestamp": 1751157524
    },
    {
        "content": "<p>Project is missing a <code>lean-toolchain</code> file, so can't be opened in VSCode.</p>",
        "id": 526255817,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1751186654
    },
    {
        "content": "<p><code>lake build</code> fails with errors in <code>Tests.lean</code>. You should move these to be compiled only by <code>lake test</code>.</p>",
        "id": 526255842,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1751186678
    },
    {
        "content": "<p>You can remove the Batteries dependency by writing <code>deriving instance BEq for ByteArray</code> somewhere. We'll make sure that's available out of the box soon.</p>",
        "id": 526256643,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1751187675
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> You're right, thank you bringing those to my attention!<br>\nIf you have anymore critical suggestions, PLEASE, let me know</p>",
        "id": 526274276,
        "sender_full_name": "io.shift",
        "timestamp": 1751208326
    },
    {
        "content": "<p>lean4 project structure, and how the parser handles paths, is something that's a bit new to me<br>\nMost of the issues I end up getting during development are in regards to structure and accidently confusing the parser. Which is not the fault of lean4 necesarrily, just the fact I'm used to other languages and how they expect your project's structure to be underthehood</p>",
        "id": 526274418,
        "sender_full_name": "io.shift",
        "timestamp": 1751208477
    },
    {
        "content": "<blockquote>\n<p>soon</p>\n</blockquote>\n<p><em>commits <code>deriving instance BEq for ByteArray</code> 2 hours later</em></p>",
        "id": 526278193,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751212329
    },
    {
        "content": "<p>Well regardless, fyi, I have a draft <a href=\"https://github.com/leanprover/lean4/pull/8165\">lean4#8165</a> which has some ideas for <code>ByteArray</code> functions that might be useful for a project like this one.</p>",
        "id": 526278459,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751212637
    },
    {
        "content": "<p>For the past few hours I've been updating the code, aswel as modulating a bit more for seperation of concerns (Encoding, Decoding, etc). For some recursions, due to their complexity, I've resorted to fuel patterns, however, for lean4 specifically, I'm wondering if this could mask particular recursion errors (?) My intuition is telling me the answer is yes, but I don't have anything tangible in the front of my head yet to approach this</p>",
        "id": 526288983,
        "sender_full_name": "io.shift",
        "timestamp": 1751224473
    },
    {
        "content": "<p>For context, here’s a simplified version of my mutual recursion with the fuel pattern:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">mutual</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">encodeValue_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">    </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">encodeList_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\">    </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">encodePairs_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\">    </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">encodeList_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">vs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">vs</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">vs'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">encodeValue_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">encodeList_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">vs'</span>\n\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">encodePairs_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Value</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ps'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kStr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encodeValue_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">vStr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">encodeValue_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">      </span><span class=\"n\">kStr</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">vStr</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">encodePairs_go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ps'</span>\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 526289293,
        "sender_full_name": "io.shift",
        "timestamp": 1751224817
    },
    {
        "content": "<p>Ah, nevermind, I found the issues that I felt intuitively <br>\nI was double-decrementing fuel, and I additionally need to add caching, and ahead of time fuel caps if I go through with using fuel patterns</p>",
        "id": 526297330,
        "sender_full_name": "io.shift",
        "timestamp": 1751234165
    },
    {
        "content": "<p>I'm scratching the Fuel method.....I can't apply D.R.Y, and flattening is just impractical for this method.</p>\n<p>K.I.S.S must be central</p>",
        "id": 526299426,
        "sender_full_name": "io.shift",
        "timestamp": 1751237008
    },
    {
        "content": "<p>Approach will now be:<br>\nStructural Recursion for most<br>\nTail recursion for some<br>\nAnd for optimization:<br>\nAutomatic tail recursion optimization and type-class-based instance resolution for well-founded relations.</p>\n<p>Additionally:<br>\nIm creating a (roswell) common lisp module(s) for debugging and error handling of ln-messagepack , but this will be in a seperate github repository, and neither userfacing nor a dependency. <br>\nLisp, including the Roswell REPL, saves me SO much time in development.<br>\nEnd users will not need to install or interact with Lisp or Roswell; this is purely for my own ( and hopefully other's) development workflow.</p>\n<p>I'm burning up energy trying to manage errors from complex recursions...Lisp will fix that.</p>",
        "id": 526311194,
        "sender_full_name": "io.shift",
        "timestamp": 1751251136
    }
]