[
    {
        "content": "<p>I'm writing a program called sand (<a href=\"https://github.com/sullyj3/sand\">https://github.com/sullyj3/sand</a>), a systemd service for countdown timers. <br>\nThe executable is colossal, it weighs 89mb. At first I thought this was just the current state of lean 4, but I just noticed that lake is only 13mb. What could cause such a blow-up? How should I go about diagnosing it?</p>",
        "id": 456137248,
        "sender_full_name": "James Sully",
        "timestamp": 1722682221
    },
    {
        "content": "<p>The first thing that you can always do is to just call <code>strip</code> on the binary which will get rid of a whole bunch of stuff. Apart from that you'll mostly have to analyze what exactly is going on in your binary</p>\n<p>Note that <code>lake</code> is of course not 13 MB. you most likely just found the wrappers around the binaries int he elan folder:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"mi\">88396</span>\n<span class=\"n\">drwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\">       </span><span class=\"mi\">86</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"bp\">.</span>\n<span class=\"n\">drwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\">       </span><span class=\"mi\">90</span><span class=\"w\"> </span><span class=\"n\">Jan</span><span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\">  </span><span class=\"mi\">2024</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">elan</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">lake</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">lean</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">leanc</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">leanchecker</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">leanmake</span>\n<span class=\"bp\">-</span><span class=\"n\">rwxr</span><span class=\"bp\">-</span><span class=\"n\">xr</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"mi\">12927160</span><span class=\"w\"> </span><span class=\"n\">Apr</span><span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"n\">leanpkg</span>\n</code></pre></div>\n<p>note that they all have the same size.</p>\n<p>The real lake binary that you'll find is much smaller:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">sh</span><span class=\"w\"> </span><span class=\"n\">lake</span>\n<span class=\"mf\">8.1</span><span class=\"n\">M</span><span class=\"w\">    </span><span class=\"n\">lake</span>\n</code></pre></div>\n<p>but also links against Lean through shared objects:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">ldd</span><span class=\"w\"> </span><span class=\"n\">lake</span>\n<span class=\"w\">    </span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">vdso</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fe26000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libstdc</span><span class=\"bp\">++.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">libstdc</span><span class=\"bp\">++.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fa00000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libInit_shared</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">Desktop</span><span class=\"bp\">/</span><span class=\"n\">formal_verification</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/./../</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">libInit_shared</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fdff000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">Desktop</span><span class=\"bp\">/</span><span class=\"n\">formal_verification</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/./../</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932a000000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libgmp</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">libgmp</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fd5b000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libm</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">libm</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fc77000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f9329e0f000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">x86</span><span class=\"bp\">-</span><span class=\"mf\">64.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932fe28000</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">libgcc_s</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">libgcc_s</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x00007f932f9d2000</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>so a static variant would be much chonkier as well.</p>",
        "id": 456165733,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722695024
    },
    {
        "content": "<p>Yeah, the 89mb is actually after stripping, before is 91</p>",
        "id": 456179843,
        "sender_full_name": "James Sully",
        "timestamp": 1722700097
    },
    {
        "content": "<p>It looks like my exe doesn't dynamically link to lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">▷</span><span class=\"w\"> </span><span class=\"n\">ldd</span><span class=\"w\"> </span><span class=\"bp\">./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">sand</span>\n<span class=\"w\">        </span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">vdso</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f269caa000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">libm</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libm</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f265315000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">libdl</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libdl</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f269c66000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">libpthread</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libpthread</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f269c61000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f265129000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">librt</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">librt</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f269c5c000</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">x86</span><span class=\"bp\">-</span><span class=\"mf\">64.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">lib64</span><span class=\"bp\">/</span><span class=\"n\">ld</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">-</span><span class=\"n\">x86</span><span class=\"bp\">-</span><span class=\"mf\">64.</span><span class=\"n\">so</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x000072f269cac000</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Could that make up the difference?</p>",
        "id": 456180487,
        "sender_full_name": "James Sully",
        "timestamp": 1722700367
    },
    {
        "content": "<p>Oh I think batteries is the culprit</p>",
        "id": 456181482,
        "sender_full_name": "James Sully",
        "timestamp": 1722700787
    },
    {
        "content": "<p>I might have to ditch it, I'm only using hashmap</p>",
        "id": 456181562,
        "sender_full_name": "James Sully",
        "timestamp": 1722700805
    },
    {
        "content": "<p>This seems very suspicious to me, batteries is very small compared to lean core</p>",
        "id": 456181997,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722700996
    },
    {
        "content": "<p>I'm basing that on the fact that when I build <a href=\"https://github.com/sullyj3/sand/commit/ada272f06125d971feb9cf012b8ee44f4b24bec5\">this commit</a>, the executable is 84mb, but when  I remove <code>import Batteries</code> from <code>Main.lean</code> it drops to 5.8mb</p>",
        "id": 456182926,
        "sender_full_name": "James Sully",
        "timestamp": 1722701281
    },
    {
        "content": "<p>it does seem surprising that batteries could be that big. I assume something must be going wrong</p>",
        "id": 456183290,
        "sender_full_name": "James Sully",
        "timestamp": 1722701425
    },
    {
        "content": "<p>You're probably including a big chunk of the <code>Lean</code> library</p>",
        "id": 456185016,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722702161
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/113488-general/topic/Reducing.20executable.20size/near/456185016\">said</a>:</p>\n<blockquote>\n<p>You're probably including a big chunk of the <code>Lean</code> library</p>\n</blockquote>\n<p>Do you mean transitively via batteries?</p>",
        "id": 456185532,
        "sender_full_name": "James Sully",
        "timestamp": 1722702365
    },
    {
        "content": "<p>batteries uses minimal imports (of lean), but perhaps you should be as well instead of doing <code>import Batteries</code></p>",
        "id": 456185672,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722702431
    },
    {
        "content": "<p>Ah, ok, I guess I should just <code>import Batteries.Data.HashMap.Basic</code></p>",
        "id": 456185908,
        "sender_full_name": "James Sully",
        "timestamp": 1722702563
    },
    {
        "content": "<p>I guess I just blithely assumed I'd only end up with the symbols I used from batteries in the executable</p>",
        "id": 456186017,
        "sender_full_name": "James Sully",
        "timestamp": 1722702605
    },
    {
        "content": "<p>hm, that doesn't seem to fix it.</p>",
        "id": 456186723,
        "sender_full_name": "James Sully",
        "timestamp": 1722702898
    },
    {
        "content": "<p>If you are on a nightly or wait a couple of days you'll also be able to use Lean's built-in <code>Std.HashMap</code> and drop your batteries dependency (if that's all you need from batteries)</p>",
        "id": 456186755,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722702918
    },
    {
        "content": "<p>It is, yeah.</p>",
        "id": 456186847,
        "sender_full_name": "James Sully",
        "timestamp": 1722702977
    },
    {
        "content": "<p>I look forward to that, thanks for the heads up</p>",
        "id": 456186868,
        "sender_full_name": "James Sully",
        "timestamp": 1722703011
    },
    {
        "content": "<p>I made a minimal repo illustrating the blow up if that's helpful. I'm still not totally clear on whether this is expected (even y'know, for now)<br>\n<a href=\"https://github.com/sullyj3/big_bin_repro_repo\">https://github.com/sullyj3/big_bin_repro_repo</a></p>",
        "id": 456187078,
        "sender_full_name": "James Sully",
        "timestamp": 1722703175
    },
    {
        "content": "<p>I've been on a quest to eliminate <code>import Lean</code> from my transitive dependencies, but I've just realised </p>\n<p><code>Socket.lean</code> -&gt; <code>Alloy.C</code> -&gt; <code>Lean</code></p>\n<p>The binaries from socket and alloy exhibit this large file size.</p>\n<p>I assume I'm out of luck on this front until module importing works more parsimoniously, so I'm going to put this project on hold for now</p>",
        "id": 456321544,
        "sender_full_name": "James Sully",
        "timestamp": 1722779141
    },
    {
        "content": "<p>Isn't this fixable by reducing the imports in Alloy.C?</p>",
        "id": 456330796,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722781346
    },
    {
        "content": "<p>I'm not sure. I would assume it's already importing only what's needed. <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> ?</p>",
        "id": 456332933,
        "sender_full_name": "James Sully",
        "timestamp": 1722782568
    },
    {
        "content": "<p>Looking at the most recent source, <code>Alloy.C</code> does not <code>import Lean</code></p>",
        "id": 456340364,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722785619
    },
    {
        "content": "<p>Right, I'm not talking about the entirety of <code>Lean</code></p>\n<p>If you <code>lake build</code> in <code>lean4-alloy/examples/my_add</code>, the binary is 83mb. I can't see how that can be anything other than the imports of <code>Alloy.C</code>, namely various submodules of <code>Lean</code></p>\n<p>As far as I can tell most imports of Lean.&lt;Anything&gt; pull in just a whole bunch of stuff</p>",
        "id": 456341962,
        "sender_full_name": "James Sully",
        "timestamp": 1722786109
    },
    {
        "content": "<p>perhaps I should have said something like \"I've been on a quest to eliminate <code>import Lean.*</code>\" to be clearer</p>",
        "id": 456343081,
        "sender_full_name": "James Sully",
        "timestamp": 1722786404
    },
    {
        "content": "<p>The vague hazy impression I have in my head right now is:</p>\n<ul>\n<li>currently when importing a module, lean includes everything in the module, regardless of whether it's used, as well as the full contents of all modules it transitively imports. not much in the way of dead code elimination is done.</li>\n<li>because of this, importing can quickly balloon executable sizes, even when doing few imports from your perspective.</li>\n<li>this is due to the early state of lean4</li>\n<li>this will presumably be addressed at some point in the future, but it's not a priority right now</li>\n</ul>\n<p>do I have this right? please correct me if I'm wrong</p>",
        "id": 456346408,
        "sender_full_name": "James Sully",
        "timestamp": 1722787267
    },
    {
        "content": "<p>Does your binary need to invoke the interpreter? If not, then you could probably use some form of link-time optimization to removed all the unused part of the binary</p>",
        "id": 456347102,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722787445
    },
    {
        "content": "<p>If you do need the interpreter, then you're in trouble because the code you execute could ask for arbitrary symbols from within the Lean shared library</p>",
        "id": 456347283,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722787494
    },
    {
        "content": "<p>I don't, no. Has anyone ever done link time optimisation with lake, or is this more of a spitball idea? I don't really have the sophistication to be blazing trails here</p>",
        "id": 456347916,
        "sender_full_name": "James Sully",
        "timestamp": 1722787665
    },
    {
        "content": "<p>I mean, unless alloy invokes the interpreter. I don't know what the interpreter is to be honest</p>",
        "id": 456348563,
        "sender_full_name": "James Sully",
        "timestamp": 1722787818
    },
    {
        "content": "<p>Because of technical limitations, I believe it actually is the case right now that if you depend on any module in <code>Lean</code>, all <code>Lean</code> code will be linked into your binary. This isn't something you can avoid by setting link flags.</p>",
        "id": 456350477,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722788339
    },
    {
        "content": "<p>I'm pretty sure lean does do basic trimming of unused things, this comes for free when using a C linker. However, the <code>initialize_Module</code> functions are always called if you import a module, even if you don't call anything in it, and the initializers themselves can pull in large parts of lean</p>",
        "id": 456351732,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722788663
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/113488-general/topic/Reducing.20executable.20size/near/456350477\">said</a>:</p>\n<blockquote>\n<p>Because of technical limitations, I believe it actually is the case right now that if you depend on any module in <code>Lean</code>, all <code>Lean</code> code will be linked into your binary. This isn't something you can avoid by setting link flags.</p>\n</blockquote>\n<p>Thanks, I'm glad to have that confirmed</p>",
        "id": 456353330,
        "sender_full_name": "James Sully",
        "timestamp": 1722789322
    },
    {
        "content": "<p>I'm using <code>ToJson</code>/<code>FromJson</code> from <code>Lean</code> as well</p>",
        "id": 456353776,
        "sender_full_name": "James Sully",
        "timestamp": 1722789711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> <a href=\"#narrow/stream/113488-general/topic/Reducing.20executable.20size/near/456341962\">said</a>:</p>\n<blockquote>\n<p>If you <code>lake build</code> in <code>lean4-alloy/examples/my_add</code>, the binary is 83mb. I can't see how that can be anything other than the imports of <code>Alloy.C</code>, namely various submodules of <code>Lean</code></p>\n</blockquote>\n<p>Unfortunately, Alloy defines a custom DSL with custom elaborators and interfaces with the Lean compiler and server. Thus, anything depending on Alloy will transitively depend on most of Lean. For current Lean, binary bloat is a problem for anything that does metaprogramming. This is planned to be resolved in the future with the module systesm, but that is still in the planning stage (as far as I understand).</p>",
        "id": 456362187,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722792753
    },
    {
        "content": "<p>Gotcha, thanks</p>",
        "id": 456417064,
        "sender_full_name": "James Sully",
        "timestamp": 1722823155
    }
]