[
    {
        "content": "<p>I'm having trouble implementing a tactic where a proof is being created in a different mvar context than that of the main proof goal. So the situation is basically the following:</p>\n<ul>\n<li><code>m : MVarId</code> is the main proof goal</li>\n<li><code>o : MVarId</code> is some other mvar</li>\n<li><code>h : Expr</code> is a proof for <code>m.getType</code> which was created in the context of <code>o</code></li>\n</ul>\n<p>When I just assign <code>h</code> to <code>m</code>, I run into problems where <code>h</code> can contain references to fvars which <code>m</code> doesn't know about. What is the correct way to transfer the proof <code>h</code> from <code>o</code> to <code>m</code>?</p>\n<p><a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>: the proof term is being extracted from <code>grind</code> by <code>mkEqHeqProof</code>. So <code>o</code> in this case is the mvar (with type <code>False</code>) which <code>grind</code> uses for its work internally.</p>",
        "id": 544323199,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760190677
    },
    {
        "content": "<p>We'll, if <code>h</code> uses assumptions available in <code>o</code> but not in <code>m</code>, then it seems reasonable that this doesn't work. Is there anything about <code>m</code> and <code>o</code> that makes you hope that types can be moved from one to the other?</p>",
        "id": 544325267,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1760192622
    },
    {
        "content": "<p>Are you in some sense asking for a way to take the union of two mvar contexts?</p>",
        "id": 544325393,
        "sender_full_name": "Jason Reed",
        "timestamp": 1760192757
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span>  Considering the <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>, I feel like it must work somehow, seeing as <code>grind</code> manages to produce proofs just fine. I guess I‘ll have to continue searching for where/how it does that.</p>",
        "id": 544325492,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760192864
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"662452\">Jason Reed</span> <a href=\"#narrow/channel/113488-general/topic/Transfer.20exprs.20between.20mvar.20contexts/near/544325393\">said</a>:</p>\n<blockquote>\n<p>Are you in some sense asking for a way to take the union of two mvar contexts?</p>\n</blockquote>\n<p>Probably not, because in my concrete project I think there‘s some parity between the fvars in <code>o</code> and <code>m</code>‘s contexts which I want to carry over.</p>",
        "id": 544325600,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760192982
    },
    {
        "content": "<p>If some proof step is done in an altered context, there must be something in the final proof term justifying that context change</p>",
        "id": 544325774,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1760193117
    },
    {
        "content": "<p>I've looked into <code>grind</code> some more. It obtains goal <code>o</code> by (approximately) calling <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.revertAll#doc\">docs#Lean.MVarId.revertAll</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.intros#doc\">docs#Lean.MVarId.intros</a> on the original proof goal <code>m</code>. Hence, if I know that <code>h</code> was valid in the context of <code>m</code>, there should be a way to transfer that to <code>o</code>. </p>\n<p>Here's a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> demonstrating the setup. I feel like what I want to do is also revert all the variables in <code>e</code> and then reinstantiate them with the <code>fvars</code> of <code>i</code>. But I don't know how.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"expr e:</span><span class=\"se\">\\n</span><span class=\"s2\">{e}\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"goal m:</span><span class=\"se\">\\n</span><span class=\"s2\">{m}\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">revertAll</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"goal r:</span><span class=\"se\">\\n</span><span class=\"s2\">{r}\"</span>\n<span class=\"w\">  </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"expr e in goal r:</span><span class=\"se\">\\n</span><span class=\"s2\">{e}\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fvars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"goal i:</span><span class=\"se\">\\n</span><span class=\"s2\">{i}\"</span>\n<span class=\"w\">  </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"expr e in goal i:</span><span class=\"se\">\\n</span><span class=\"s2\">{e}\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">expr e:</span>\n<span class=\"cm\">n + m</span>\n\n<span class=\"cm\">goal m:</span>\n<span class=\"cm\">n m : Nat</span>\n<span class=\"cm\">h : n &gt; 0</span>\n<span class=\"cm\">⊢ True → 5 = 6</span>\n\n<span class=\"cm\">goal r:</span>\n<span class=\"cm\">⊢ ∀ (n m : Nat), n &gt; 0 → True → 5 = 6</span>\n\n<span class=\"cm\">expr e in goal r:</span>\n<span class=\"cm\">_fvar.2391 + _fvar.2392</span>\n\n<span class=\"cm\">goal i:</span>\n<span class=\"cm\">n✝ m✝ : Nat</span>\n<span class=\"cm\">h✝ : n✝ &gt; 0</span>\n<span class=\"cm\">a✝ : True</span>\n<span class=\"cm\">⊢ 5 = 6</span>\n\n<span class=\"cm\">expr e in goal i:</span>\n<span class=\"cm\">_fvar.2391 + _fvar.2392</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 544523954,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760354395
    },
    {
        "content": "<p>This seems like quite a dangerous path to walk on to me. You're planning to rely on particular implementation details of grind that could break at any moment.</p>",
        "id": 544524286,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1760354504
    },
    {
        "content": "<p>I think I don't really have a choice at the moment, as there currently does not exist an API for how I'm trying to interact with <code>grind</code>. I talked to <span class=\"user-mention\" data-user-id=\"112857\">@Leonardo de Moura</span> about this, and I think we agreed that it would be most realistic for use cases such as mine to take this dangerous path first, and then suggest API extensions/improvements for <code>grind</code>  based on the experience.</p>",
        "id": 544524796,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760354665
    },
    {
        "content": "<p>In fact, the implementation of <code>grind</code> is probably going to have to address a similar problem to allow for parameters which are not just identifiers but whole terms. <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> mentioned this is a planned feature in <a href=\"#narrow/channel/270676-lean4/topic/grind.20with.20expressions/near/537573063\">https://leanprover.zulipchat.com/#narrow/channel/270676-lean4/topic/grind.20with.20expressions/near/537573063</a>.</p>",
        "id": 544531827,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760356643
    },
    {
        "content": "<p>This does it. I just can't really do this in the context of <code>grind</code>, as it does not retain the fvars.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">revertAll'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">FVarId</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">checkNotAssigned</span><span class=\"w\"> </span><span class=\"ss\">`revertAll</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">toRevert</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">fvarId</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getFVarIds</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">fvarId</span><span class=\"bp\">.</span><span class=\"n\">getDecl</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isAuxDecl</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">toRevert</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toRevert</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">fvarId</span>\n<span class=\"w\">  </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">setKind</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">natural</span>\n<span class=\"w\">  </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"n\">toRevert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">preserveOrder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">clearAuxDeclsInsteadOfRevert</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">oldFVars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">revertAll'</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newFVars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">replaceFVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">oldFVars</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">newFVars</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"n\">oldFVars</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"expr e' in goal i:</span><span class=\"se\">\\n</span><span class=\"s2\">{e'}\"</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: expr e' in goal i:</span>\n<span class=\"sd\">n✝ + m✝</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"o\">(</span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 544719331,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1760440279
    }
]