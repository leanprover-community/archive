[
    {
        "content": "<p>I'm trying to export a Lean model to an executable function using the FFI. My target function is <code>def hasPermission (user: UserInfo) (resource: Resource) (perm_type: PermissionType): Bool</code>, where UserInfo, Resource, and PermissionType are Lean structures.</p>\n<p>I looked into the C IR generated when exporting the shared library and found that the prototype is <code>LEAN_EXPORT uint8_t has_permission(lean_object*, lean_object*, uint8_t);</code>. That is expected because PermissionType is an enum type. However, I do not know how to build the other two arguments, namely user and resource.</p>\n<p>The most relevant resource I found is the <a href=\"\">reverse-ffi</a> example, where a Lean string represented by <code>lean_object *</code> is built using <code>lean_mk_string</code>. However, it does not show how to build complex inductive types. The document mentions the memory layout here and there, but I'm still a little confused.</p>\n<p>Is there a more detailed \"reverse-ffi\" example that shows how to build <code>lean_object</code> with complex inductive type in C?</p>",
        "id": 510828274,
        "sender_full_name": "Qiuye Wang",
        "timestamp": 1744083654
    },
    {
        "content": "<p>You could take a look at <code>md4lean</code>, which uses the FFI to construct ASTs. The type in question is not hugely complex, but it at least shows examples of using <code>lean_alloc_ctor</code>, <code>lean_ctor_set</code>, <code>lean_box</code>, and <code>lean_box_*</code> to allocate and populate constructors of an inductive type.</p>\n<p>The C in question is <a href=\"https://github.com/acmepjz/md4lean/blob/main/wrapper/wrapper.c\">here</a>.</p>",
        "id": 511014660,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1744142104
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"354934\">David Thrane Christiansen</span> <a href=\"#narrow/channel/113488-general/topic/Constructing.20.60lean_object.20*.60.20when.20calling.20Lean.20code.20from.20C/near/511014660\">发言道</a>：</p>\n<blockquote>\n<p>You could take a look at <code>md4lean</code>, which uses the FFI to construct ASTs. The type in question is not hugely complex, but it at least shows examples of using <code>lean_alloc_ctor</code>, <code>lean_ctor_set</code>, <code>lean_box</code>, and <code>lean_box_*</code> to allocate and populate constructors of an inductive type.</p>\n<p>The C in question is <a href=\"https://github.com/acmepjz/md4lean/blob/main/wrapper/wrapper.c\">here</a>.</p>\n</blockquote>\n<p>Thanks! The reference helped a lot.</p>\n<p>I noticed that in this project only Lean <strong>Array</strong> is built. Should I build arrays first, then convert to lists using <code>lean_array_to_list</code>, or is there someway I can directly build Lean <strong>List</strong>?</p>",
        "id": 511153401,
        "sender_full_name": "Qiuye Wang",
        "timestamp": 1744200337
    },
    {
        "content": "<p>Unlike arrays, lists aren't a primitive. <code>lean_alloc_ctor</code> and <code>lean_box</code> should get you <code>List.cons</code> and <code>List.nil</code>.</p>",
        "id": 511197550,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1744210842
    },
    {
        "content": "<p>It'll look a lot like <a href=\"https://github.com/acmepjz/md4lean/blob/8ba0ef10d178ab95a5d6fe3cfbd586c6ecef2717/wrapper/wrapper.c#L25-L35\">this code</a> that returns an <code>Option</code>.</p>",
        "id": 511200785,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1744211727
    }
]