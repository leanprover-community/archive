[
    {
        "content": "<p>Ok, so here is the question:<br>\nI am using LeanInteract (which is a REPL wrapper). I'm using ProofStep to search possible solution of a given sorry. However, it seems that ProofStep cannot do garbage collection (I mean after I try some possible solution  and find I try too much and take too much memory, I want to remove some previously tried ProofStep, but I cannot find this feature) [method 1] [issues: <a href=\"\">clear memory</a>, <a href=\"https://github.com/leanprover-community/repl/pull/83\">gc</a>, <a href=\"https://github.com/augustepoiroux/LeanInteract/issues/6\">LeanInteract</a>)]. Another method is to restart the REPL instance and pickle load the sorry state, but it seems that pickle load need to reload Mathlib because of it's design, so the unpickle is slow (3s, which I expect 0.01s) [method 2] [issues: <a href=\"https://github.com/leanprover-community/repl/issues/84\">fast pickle</a>, <a href=\"https://github.com/leanprover-community/repl/issues/87\">fork sorry state</a>]. The implementation of AutoLeanServer add_to_session_cache in LeanInteract also relies on pickling, so it doesn't solve the issue.<br>\nWhat's the best way to do this?</p>",
        "id": 525058405,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1750431631
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"899153\">@Jiaming Shan</span>!<br>\nIf you are interested in the garbage collection feature, you can try out <span class=\"user-mention\" data-user-id=\"572535\">@RexWang</span> <a href=\"https://github.com/leanprover-community/repl/pull/83\">PR</a>. Since you are using LeanInteract, with &gt;=0.6.0, you can:</p>\n<ol>\n<li>Switch the REPL backend to his fork:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">(</span>\n    <span class=\"n\">project</span><span class=\"o\">=</span><span class=\"n\">TempRequireProject</span><span class=\"p\">(</span><span class=\"s2\">\"mathlib\"</span><span class=\"p\">),</span>\n    <span class=\"n\">repl_git</span><span class=\"o\">=</span><span class=\"s2\">\"https://github.com/Lean-zh/repl\"</span><span class=\"p\">,</span>\n    <span class=\"n\">repl_rev</span><span class=\"o\">=</span><span class=\"s2\">\"gc-option\"</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>Use <code>run_dict</code> method instead of the <code>run</code> method to use the newly introduced <code>record</code> parameter:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">run_dict</span><span class=\"p\">({</span><span class=\"s2\">\"tactic\"</span><span class=\"p\">:</span> <span class=\"s2\">\"linarith\"</span><span class=\"p\">,</span> <span class=\"s2\">\"proofState\"</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s2\">\"record\"</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">})</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Full example</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"c1\"># /// script</span>\n<span class=\"c1\"># dependencies = [</span>\n<span class=\"c1\">#     \"lean-interact==0.6.0\",</span>\n<span class=\"c1\"># ]</span>\n<span class=\"c1\"># ///</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">time</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">psutil</span>\n\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">lean_interact</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Command</span><span class=\"p\">,</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">,</span> <span class=\"n\">LeanServer</span><span class=\"p\">,</span> <span class=\"n\">TempRequireProject</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">lean_interact.utils</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">get_total_memory_usage</span>\n\n<span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">(</span>\n    <span class=\"n\">project</span><span class=\"o\">=</span><span class=\"n\">TempRequireProject</span><span class=\"p\">(</span><span class=\"s2\">\"mathlib\"</span><span class=\"p\">),</span>\n    <span class=\"n\">repl_git</span><span class=\"o\">=</span><span class=\"s2\">\"https://github.com/Lean-zh/repl\"</span><span class=\"p\">,</span>\n    <span class=\"n\">repl_rev</span><span class=\"o\">=</span><span class=\"s2\">\"gc-option\"</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"n\">server</span> <span class=\"o\">=</span> <span class=\"n\">LeanServer</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n<span class=\"n\">init_command</span> <span class=\"o\">=</span> <span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">(</span><span class=\"n\">Command</span><span class=\"p\">(</span><span class=\"n\">cmd</span><span class=\"o\">=</span><span class=\"s2\">\"import Mathlib</span><span class=\"se\">\\n\\n</span><span class=\"s2\">example (a b c : Nat) : (a + b) + c = c + a + b := by sorry\"</span><span class=\"p\">))</span>\n\n<span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">started</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">())</span>\n<span class=\"n\">last_update</span> <span class=\"o\">=</span> <span class=\"n\">started</span>\n\n<span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n    <span class=\"n\">n</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n    <span class=\"k\">if</span> <span class=\"n\">last_update</span> <span class=\"o\">!=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()):</span>\n        <span class=\"n\">elapsed</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">())</span> <span class=\"o\">-</span> <span class=\"n\">started</span>\n        <span class=\"n\">current_memory</span> <span class=\"o\">=</span> <span class=\"n\">get_total_memory_usage</span><span class=\"p\">(</span><span class=\"n\">psutil</span><span class=\"o\">.</span><span class=\"n\">Process</span><span class=\"p\">(</span><span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">pid</span><span class=\"p\">))</span> <span class=\"o\">/</span> <span class=\"mi\">1024</span> <span class=\"o\">/</span> <span class=\"mi\">1024</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">\"</span><span class=\"si\">{</span><span class=\"n\">elapsed</span><span class=\"si\">}</span><span class=\"s2\"> seconds elapsed</span><span class=\"se\">\\t</span><span class=\"si\">{</span><span class=\"n\">n</span><span class=\"si\">}</span><span class=\"s2\"> issued commands</span><span class=\"se\">\\t</span><span class=\"si\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">//</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"si\">}</span><span class=\"s2\"> commands/second</span><span class=\"se\">\\t</span><span class=\"s2\">Memory usage: </span><span class=\"si\">{</span><span class=\"n\">current_memory</span><span class=\"si\">:</span><span class=\"s2\">.2f</span><span class=\"si\">}</span><span class=\"s2\"> MB\"</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">last_update</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">())</span>\n    <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">run_dict</span><span class=\"p\">({</span><span class=\"s2\">\"tactic\"</span><span class=\"p\">:</span> <span class=\"s2\">\"linarith\"</span><span class=\"p\">,</span> <span class=\"s2\">\"proofState\"</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s2\">\"record\"</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">})</span>\n</code></pre></div>\n</div></div>",
        "id": 525339571,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1750687248
    },
    {
        "content": "<p>Thank you! It's good, however my need is to remove previous ProofState, so something like \"remove state\" is more preferred. This idea is already mentioned in that issue, but I think it is not implemented right?</p>",
        "id": 525350880,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1750690424
    },
    {
        "content": "<p>Oh, I see, sorry for the misunderstanding. Indeed, it would be an interesting feature to add. Regarding the behavior of the \"delete proofstate\" command, since we have a proof state tree, there is the question of the default behavior.<br>\nFor example, let's say we have proof states 0 and 1, with 1 instantiated from 0. If we wish to delete 0, would you expect it to delete the whole associated subtree (i.e. 0 and 1 here)? or just 0?<br>\nI guess deleting only the specific proof state would be the default since proof states are independent once created.</p>",
        "id": 525352835,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1750690932
    },
    {
        "content": "<p>As you said, I would like to only delete 0 and keep 1 in the memory.</p>",
        "id": 525353300,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1750691066
    },
    {
        "content": "<p>I guess it should be doable by replacing this <a href=\"https://github.com/leanprover-community/repl/blob/ab9da2b867c54d709fa3720790ea7406606be28a/REPL/Main.lean#L74\">line</a>: <code>proofStates : Array ProofSnapshot := #[]</code> to <code>proofStates : Array (Option ProofSnapshot) := #[]</code>, adding a new \"remove\" command which basically replaces the proof snapshot by <code>None</code>, and updating all the methods to handle this option change gracefully.<br>\nI don't have the bandwidth to implement that at the moment though, but maybe you can try to do it?</p>",
        "id": 525355533,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1750691735
    },
    {
        "content": "<p>Oh I see, that is useful! Thanks!</p>",
        "id": 525355767,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1750691810
    },
    {
        "content": "<p>So I do it myself and made a PR <a href=\"https://github.com/leanprover-community/repl/pull/111\">https://github.com/leanprover-community/repl/pull/111</a></p>",
        "id": 526299262,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1751236724
    },
    {
        "content": "<p>Nice! Did you run tests to check if it is indeed releasing the memory associated to the removed proof states?</p>",
        "id": 526337929,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1751269486
    },
    {
        "content": "<p>I connect repl with state removing with LeanInteract, and test on LeanInteract to see the memory usage. It works! Although the memory that has been applied for will not be released, but if I release some proof states while continuously increasing the proof state, the program will not apply for new memory, thereby effectively curbing the growth of total memory.</p>",
        "id": 527039638,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1751561541
    }
]