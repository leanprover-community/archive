[
    {
        "content": "<p>This is the simplest possible example for what I'm trying to do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">aaaa</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">][</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>α : Type\nx : α\n⊢ x = #[x][0]\n</code></pre></div>\n<p>if I try to <code>simp [Array.instGetElemNatLtSize]</code> it goes into a stackoverflow</p>\n<p>And perhaps more importantly, is there a better way I could've figured this out without asking here? Lean state search <a href=\"https://premise-search.com/?query=%CE%B1+%3A+Type%0Ax+%3A+%CE%B1%0A%E2%8A%A2+x+%3D+%23%5Bx%5D%5B0%5D&amp;results=100&amp;rev=v4.17.0-rc1\">wasnt helpful</a> and neither was <a href=\"https://leansearch.net/?q=accessing%20the%20first%20element%20in%20a%20singleton%20array%20is%20equal%20to%20that%20element\">leansearch</a>. I feel like this is a really simple/basic proof, is there some list somewhere of \"when your proof looks like this, you probably want this tactic\"?</p>",
        "id": 512219494,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744690240
    },
    {
        "content": "<p>Here you might guess that indexing an array ought to be equal by definition, and it turns out to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">aaaa</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">][</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 512219804,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744690432
    },
    {
        "content": "<p>wait what? Why does <code>simp</code> not work when <code>rfl</code> does?</p>",
        "id": 512219883,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744690467
    },
    {
        "content": "<p>Or you might guess that there's a simp lemma out there that would work, and indeed there is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">aaaa</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">][</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simp? produces</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_toArray</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_cons_zero</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 512219905,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744690485
    },
    {
        "content": "<p>(<code>simp</code> on its own works with just Lean imported, and I used <code>simp?</code> to see what it did)</p>",
        "id": 512219977,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744690548
    },
    {
        "content": "<p>How did you come across using <code>Array.instGetElemNatLtSize</code> as something to unfold?</p>",
        "id": 512220088,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744690607
    },
    {
        "content": "<p>okay something weird is going on here, when I recreate the exact proof state using a <code>theorem</code> it works just fine, but doesn't work in the actual proof</p>",
        "id": 512220353,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744690768
    },
    {
        "content": "<p>You could try setting <code>pp.explicit</code> (or <code>pp.all</code>) to true to see if there are some small differences.</p>\n<p>Or you could try <code>by congr!</code> from within your actual proof to see what the differences are, if they're not otherwise resolvable.</p>",
        "id": 512220525,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744690884
    },
    {
        "content": "<p>Okay I was able to fix it, and from that extract what I think is an actual reproduction of the issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">theSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"n\">theSize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">singleton</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"n\">theSize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cccc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">access</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- look at this proof state</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">theSize</span><span class=\"o\">]</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>x : UInt8\n⊢ x = { toArray := #[x], size_toArray := ⋯ }[0]\n</code></pre></div>\n<p>there's no mention of <code>theSize</code>, but it's secretly still there wreaking havok. <code>pp.explicit</code> was able to show it, thank you.</p>",
        "id": 512222826,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744692229
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/How.20do.20I.20unwrap.20array.20access.20in.20a.20proof.3F/near/512220088\">said</a>:</p>\n<blockquote>\n<p>How did you come across using <code>Array.instGetElemNatLtSize</code> as something to unfold?</p>\n</blockquote>\n<p>roughly: I know the <code>var[idx]</code> desugars to a function call, and I probably want to unfold that function call (because nothing else was working), and then from there I was able to dig through the docs and find the right instance</p>",
        "id": 512223005,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744692354
    },
    {
        "content": "<p>At a more general level, I come from a programming background, not a math background, and I've definitely been kinda throwing stuff at the wall and seeing what sticks when it comes to proofs.</p>",
        "id": 512223238,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744692498
    },
    {
        "content": "<p><code>congr</code> also works, though I don't understand why</p>",
        "id": 512223454,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744692654
    },
    {
        "content": "<p>Fun fact: <code>rfl</code> still works there.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cccc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 512224098,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744693055
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"898940\">Shelvacu</span> <a href=\"#narrow/channel/113488-general/topic/How.20do.20I.20unwrap.20array.20access.20in.20a.20proof.3F/near/512223005\">said</a>:</p>\n<blockquote>\n<p>and then from there I was able to dig through the docs and find the right instance</p>\n</blockquote>\n<p>Ok, I was curious if some AI system was leading you astray.</p>\n<p>In the future, unfolding instances alone is usually not helpful. Mathlib has <code>unfold_projs</code> that sometimes illuminates some things. It unfolds projections of instances, which can bring you towards understanding definitions.</p>",
        "id": 512224437,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744693236
    },
    {
        "content": "<p>Did you do <code>congr</code> and not <code>congr!</code>? These are different tactics. (One day I hope <code>congr!</code> will be upstreamed into <code>congr</code>.)</p>\n<p>I think it works here because <code>rfl</code> works, so it's not doing anything special.</p>",
        "id": 512224565,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744693313
    },
    {
        "content": "<p>I tried both, they both solve it.</p>",
        "id": 512224677,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744693384
    },
    {
        "content": "<p>There's a debugging flag here, and \"no passes succeeded\" followed by \"Dispatched goal by post-processing step.\" pretty much means we can assume that <code>congr!</code> succeeds because it tries <code>rfl</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">congr!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cccc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">congr!</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">[congr!] Default smartHCongr? failed, trying LHS/RHS method</span>\n<span class=\"cm\">[congr!] trying to apply congr lemma ∀ (data data' : Vector UInt8 theSize), data = data' → HEq (access data) (access data')</span>\n<span class=\"cm\">[congr!] failed to apply congr lemma ▶</span>\n<span class=\"cm\">[congr!] no passes succeeded</span>\n<span class=\"cm\">[congr!] Dispatched goal by post-processing step.</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 512224884,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744693510
    },
    {
        "content": "<p>(My suggestion of <code>congr!</code> makes more sense when there are things that look like they should be equal but aren't for some hidden reason. It's not useful here.)</p>",
        "id": 512225767,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744693960
    }
]