[
    {
        "content": "<p>Hi! This is more of a question to the Lean FRO but I thought others might have the same question, so posting as a zulip topic instead:</p>\n<p>I'd like to understand how the Lean FRO manages the cache builds for mathlib and how I can transfer them to my own S3 bucket.</p>\n<p>To give some context, I have a scenario under which I need to do lots of lake cache get for arbitrary commits of mathlib. I tried to look for more info about how the current caches are stored but only got so far as that they are hosted on Azure from the terminal message. If I could get some more info about the current cache storage, that would be super helpful for the migration to my own S3 bucket. Many thanks in advance!</p>",
        "id": 565702131,
        "sender_full_name": "Albert Jiang",
        "timestamp": 1767029195
    },
    {
        "content": "<p>Hi Albert! Sorry for the slow response, some people are on vacation and so on.</p>\n<p>Is this about the mathlib cache (<code>lake exec cache</code>) or the new lake built in cache? In either case, maybe <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>  has the right pointers?</p>",
        "id": 565995269,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1767294494
    },
    {
        "content": "<p>I can certainly provide some pointers on both fronts (Mathlib's cache and Lale's) once I am back from vacation. Along the lines of Joachim's question, Is the goal to just switch the storage location of Mahtlib's cache or move data from it over to a custom cache setup?</p>",
        "id": 565995476,
        "sender_full_name": "Mac Malone",
        "timestamp": 1767294798
    },
    {
        "content": "<p>Thanks Joachim and Mac! Both the mathlib cache and the new lake built in cache will be super useful for me and I'd definitely appreciate some pointers!</p>",
        "id": 566312997,
        "sender_full_name": "Albert Jiang",
        "timestamp": 1767606887
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/Systematically.20transferring.20cache.20builds.20to.20S3.20bucket/near/565995476\">said</a>:</p>\n<blockquote>\n<p>I can certainly provide some pointers on both fronts (Mathlib's cache and Lale's) once I am back from vacation. Along the lines of Joachim's question, Is the goal to just switch the storage location of Mahtlib's cache or move data from it over to a custom cache setup?</p>\n</blockquote>\n<p>Sorry for the stupidity here, but is there a distinction between <code>switch the storage location of Mahtlib's cache</code> and <code>move data from it over to a custom cache setup</code>? I'd still like to use lake cache get, but from a custom S3 bucket.</p>",
        "id": 566313308,
        "sender_full_name": "Albert Jiang",
        "timestamp": 1767606982
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"258175\">Albert Jiang</span> <a href=\"#narrow/channel/113488-general/topic/Systematically.20transferring.20cache.20builds.20to.20S3.20bucket/near/566313308\">said</a>:</p>\n<blockquote>\n<p>I'd still like to use lake cache get, but from a custom S3 bucket.</p>\n</blockquote>\n<p>Did you mean <code>lake exe cahe get</code> (i.e., Mathlib's cache) and not <code>lake cache get</code> (i.e., Lake's cache)? Assuming you meant Mathlib's cache, then just switching the storage location is what you want. A custom cache setup would be using something other than Mathlib's cache code to manage the cache.</p>",
        "id": 566367706,
        "sender_full_name": "Mac Malone",
        "timestamp": 1767623888
    },
    {
        "content": "<p>Pointer-wise, Mathlib's cache already supports S3 endpoints. This has been found to be flaky in the past, hence why it still uses Azure by default, but hopefully the flakiness should not be a problem for your use case.  This support can be toggled via the <code>USE_FRO_CACHE</code> environment variable. The only thing that needs to be changed code-wise is the URL cache uses for the S3 bucket, which is set <a href=\"https://github.com/leanprover-community/mathlib4/blob/959c85291ad2a288da37a83d54b7b2266a1c59e2/Cache/Requests.lean#L513\">here</a>. With that corrected, the process should be as simple as the following:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\n$<span class=\"w\"> </span><span class=\"nv\">USE_FRO_CACHE</span><span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"nv\">MATHLIB_CACHE_S3_TOKEN</span><span class=\"o\">=</span>&lt;s3-token&gt;<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>put\n</code></pre></div>\n<p>Were <code>s3-token</code> is the string <code>&lt;S3_ACCESS_KEY&gt;:&lt;S3_SECRET_KEY&gt;</code> (using the respective authentication keys for your bucket).</p>\n<p>I can also look into making the URL the cache uses configurable via a PR. That would enable addressing this use case without any future code changes.</p>",
        "id": 566370562,
        "sender_full_name": "Mac Malone",
        "timestamp": 1767624620
    },
    {
        "content": "<p>Mathlib PR is up for review at <a href=\"https://github.com/leanprover-community/mathlib4/pull/33605\">#33605</a>.</p>",
        "id": 566388839,
        "sender_full_name": "Mac Malone",
        "timestamp": 1767629222
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/33647\">#33647</a> (stacked on top) renames USE_FRO_CACHE to MATHLIB_CACHE_USE_CLOUDFLARE for consistency, and also adds a hopefully useful README.</p>",
        "id": 566468757,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767666451
    }
]