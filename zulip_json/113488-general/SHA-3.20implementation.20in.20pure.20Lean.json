[
    {
        "content": "<p>I experimented with implementing SHA-3 in pure Lean. This is my first exposure to pure functional programming, and dependent types. The library provides one-shot, and streaming APIs for hash and XOF functions, and uses dependent typing, type classes, and macros.  </p>\n<p><a href=\"https://github.com/gdncc/Cryptography/tree/main\">https://github.com/gdncc/Cryptography/tree/main</a> </p>\n<p>I had a blast. I will probably try to validate a few more properties, and to improve performance. I am hoping it will be useful educational resource for how to implement low(-ish) level primitives in Lean. This was certainly a rewarding exercise for me.</p>",
        "id": 478166457,
        "sender_full_name": "Carbon",
        "timestamp": 1729551845
    },
    {
        "content": "<p><a href=\"https://github.com/gdncc/Cryptography/blob/main/Cryptography%2FHashes%2FSHA3%2FBasic.lean#L50\">https://github.com/gdncc/Cryptography/blob/main/Cryptography%2FHashes%2FSHA3%2FBasic.lean#L50</a></p>\n<p>Here you can use the vector implementation of <code>Batteries.Vector</code> instead of creating your own statically sized array</p>",
        "id": 478166685,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729551956
    },
    {
        "content": "<p>Yep!  <span class=\"user-mention\" data-user-id=\"228466\">@Chris Bailey</span>  mentioned this to me last Thursday at our San Francisco Lean Meetup. I will consider using this in the next iteration of the implementation.</p>",
        "id": 478167532,
        "sender_full_name": "Carbon",
        "timestamp": 1729552317
    },
    {
        "content": "<p>I'm puzzled by the <code>stable</code> in the lean-toolchain file. What version of lean does this mean?</p>",
        "id": 478168057,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729552595
    },
    {
        "content": "<p>Either this is some old version of lean, which is fine but you may as well update; or more worryingly it tracks some \"latest\" version of lean, in which case your project may stop building at random points in future.</p>",
        "id": 478168150,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729552649
    },
    {
        "content": "<p>I assume this means the latest release e.g. 4.12. I did have to fix a few things  for the past 2 releases. Breaking changes included changes to <code>Parsec</code>, and affected the NIST test cases.</p>",
        "id": 478169512,
        "sender_full_name": "Carbon",
        "timestamp": 1729553347
    },
    {
        "content": "<p>If you write <code>leanprover/lean4:v4.12.0</code> in that file, then the code will work forever, and you can manually change it to the most recent release each time you are ready to fix things</p>",
        "id": 478170241,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729553659
    },
    {
        "content": "<p>Perhaps <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>  can comment on whether putting <code>stable</code> in the <code>lean-toolchain</code> is supposed to be legal in the first place.</p>",
        "id": 478170476,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729553769
    },
    {
        "content": "<p>It is not really meant to be legal. Future versions of <code>elan</code> will try to prevent such occurrences.</p>",
        "id": 478170819,
        "sender_full_name": "Mac Malone",
        "timestamp": 1729553934
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/478168057\">said</a>:</p>\n<blockquote>\n<p>I'm puzzled by the <code>stable</code> in the lean-toolchain file. What version of lean does this mean?</p>\n</blockquote>\n<p>stable is the default toolchain when lake generates a non-math project</p>",
        "id": 478172965,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729554939
    },
    {
        "content": "<p>And I tested this very recently, so this is not an issue with only old lean versions.</p>",
        "id": 478173147,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729555018
    },
    {
        "content": "<p>for non-math projects, lake is very barebones at the moment</p>",
        "id": 478173175,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729555034
    },
    {
        "content": "<p>Actually it isn't a bad idea to maintain the stable tag. I use it whenever I want to jump from stable toolchain to stable toolchain. I recall explicitly asking for this last year and Mac suggested this idea.</p>",
        "id": 478173672,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729555267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"695316\">@Carbon</span>  there were some breaking changes in the Array and List API from 4.12 to 4.13-rc versions. So when updating to 4.13, there will definitely be build breakages</p>",
        "id": 478173861,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1729555349
    },
    {
        "content": "<p>This is exciting work! I'm eager to see more of this.</p>",
        "id": 478173959,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1729555410
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/478173861\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"695316\">Carbon</span>  there were some breaking changes in the Array and List API from 4.12 to 4.13-rc versions. So when updating to 4.13, there will definitely be build breakages</p>\n</blockquote>\n<p>I updated to 4.13, and I did not experience any issues. Were these breaking Array changes implemented, or should we expect them to materialize later?</p>",
        "id": 481152990,
        "sender_full_name": "Carbon",
        "timestamp": 1730995748
    },
    {
        "content": "<p>99% of changes in List and Array come with deprecation warnings, so should be pretty easy to adapt to. Please ping me if you encounter places where the upgrade path for List/Array is painful!</p>",
        "id": 481201729,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731014349
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"466334\">@Shreyas Srinivas</span> out of interested, why are all your definitions marked \"private\"?</p>",
        "id": 482174444,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1731505166
    },
    {
        "content": "<p>What definitions? I am not the author of this project</p>",
        "id": 482174799,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1731505264
    },
    {
        "content": "<p>Oh sorry!</p>",
        "id": 482174832,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1731505274
    },
    {
        "content": "<p>Misread the above :)</p>",
        "id": 482174846,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1731505277
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"695316\">@Carbon</span>, sorry</p>",
        "id": 482174863,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1731505283
    },
    {
        "content": "<p>To ensure library users do not call the wrong functions.</p>",
        "id": 482210360,
        "sender_full_name": "Carbon",
        "timestamp": 1731514579
    },
    {
        "content": "<p>As far as I can tell, the result is that your public function has a private type</p>",
        "id": 482228603,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731520259
    },
    {
        "content": "<p>Not all functions are actually <code>private</code>. I have ~private~ functions but also public (no <code>private</code> modifier) functions (the public functions are actually implemented via macros). Upon import, I can only call the public functions, which is the desired effect.  Am I missing something?</p>",
        "id": 482229872,
        "sender_full_name": "Carbon",
        "timestamp": 1731520692
    },
    {
        "content": "<p>My claim is that you provide a public <code>SHA3_224.k</code> definition, but the type of this definition is private</p>",
        "id": 482231898,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731521339
    },
    {
        "content": "<p>Separately, the definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Sponge function, defined by its capacity, padding, and output bit length -/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">paddingDelimiter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">outputBitsLen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">                 </span><span class=\"o\">(</span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">                 </span><span class=\"bp\">∧</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">paddingDelimiter</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">                 </span><span class=\"bp\">∧</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">outputBitsLen</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">)):</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">o</span>\n</code></pre></div>\n<p>seems quite strange to me; as far as I can tell, this is isomorphic to <code>Unit</code>!</p>",
        "id": 482232116,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731521413
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482231898\">said</a>:</p>\n<blockquote>\n<p>My claim is that you provide a public <code>SHA3_224.k</code> definition, but the type of this definition is private</p>\n</blockquote>\n<p>this should be a linter warning</p>",
        "id": 482335854,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731573756
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482231898\">said</a>:</p>\n<blockquote>\n<p>My claim is that you provide a public <code>SHA3_224.k</code> definition, but the type of this definition is private</p>\n</blockquote>\n<p>Are you referring to <code>SHA3_224.mk</code>? Do you mean that one can call the public <code>SHA3_224.mk</code>, and access components of the returned value that are meant to be private? Is there a way around that?</p>",
        "id": 482347906,
        "sender_full_name": "Carbon",
        "timestamp": 1731577458
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482232116\">said</a>:</p>\n<blockquote>\n<p>Separately, the definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Sponge function, defined by its capacity, padding, and output bit length -/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">paddingDelimiter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">outputBitsLen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">                 </span><span class=\"o\">(</span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">                 </span><span class=\"bp\">∧</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">paddingDelimiter</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">                 </span><span class=\"bp\">∧</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">outputBitsLen</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">)):</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">o</span>\n</code></pre></div>\n<p>seems quite strange to me; as far as I can tell, this is isomorphic to <code>Unit</code>!</p>\n</blockquote>\n<p>What's the significance of this? The idea was to be able to create distinct types such that <code>HashFunction 1 2 3</code> is different than <code>HashFunction 1 1 1</code> for instance.  This problem and  solution was suggested in <a href=\"#narrow/channel/270676-lean4/topic/Deriving.20dependent.20type.20from.20inductive.20type.20constructor/near/439302814\">https://leanprover.zulipchat.com/#narrow/channel/270676-lean4/topic/Deriving.20dependent.20type.20from.20inductive.20type.20constructor/near/439302814</a></p>\n<p>And this is how it is instantiated in the code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkHashFunction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">HashFunction</span><span class=\"bp\">.</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">by</span>\n<span class=\"w\">       </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">And</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">       </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">       </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">         </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">And</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">         </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">         </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">     </span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- (...)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\">  </span><span class=\"n\">mkHashFunction</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x06</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"w\"> </span><span class=\"c1\">-- mkHashFunction 56 6 28 : HashFunction 56 6 28</span>\n</code></pre></div>",
        "id": 482350286,
        "sender_full_name": "Carbon",
        "timestamp": 1731578120
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"695316\">Carbon</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482347906\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482231898\">said</a>:</p>\n<blockquote>\n<p>My claim is that you provide a public <code>SHA3_224.k</code> definition, but the type of this definition is private</p>\n</blockquote>\n<p>Are you referring to <code>SHA3_224.mk</code>? Do you mean that one can call the public <code>SHA3_224.mk</code>, and access components of the returned value that are meant to be private? Is there a way around that?</p>\n</blockquote>\n<p>No, the problem is that you can't even call the function without producing a value whose type you are not allowed to refer to</p>",
        "id": 482356661,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731580082
    },
    {
        "content": "<p>Is this function supposed to be called outside the module?</p>",
        "id": 482357196,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731580237
    },
    {
        "content": "<p>if not, you should just make <code>SHA3_224.mk</code> private</p>",
        "id": 482357259,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731580260
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"695316\">Carbon</span> <a href=\"#narrow/stream/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482350286\">said</a>:</p>\n<blockquote>\n<p>What's the significance of this? The idea was to be able to create distinct types such that <code>HashFunction 1 2 3</code> is different than <code>HashFunction 1 1 1</code> for instance.  This problem and  solution was suggested in <a href=\"#narrow/channel/270676-lean4/topic/Deriving.20dependent.20type.20from.20inductive.20type.20constructor/near/439302814\">https://leanprover.zulipchat.com/#narrow/channel/270676-lean4/topic/Deriving.20dependent.20type.20from.20inductive.20type.20constructor/near/439302814</a></p>\n</blockquote>\n<p>I think my claim is that this is an <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> problem, and actually you would be fine with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 482369498,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731584150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482357196\">said</a>:</p>\n<blockquote>\n<p>Is this function supposed to be called outside the module?</p>\n</blockquote>\n<p>Yes. In file <a href=\"https://github.com/gdncc/Cryptography/blob/main/Cryptography/Hashes/SHA3/example.lean#L29\">example.lean</a>, I show examples how to use the lean API. I imported <code>import «Cryptography».Hashes.SHA3.Basic</code> to that effect. it does call <code>mk()</code> successfully, but you make me wonder if I can call <code>mk()</code> from completely outside <code>Cryptography</code>.  I might have misunderstood scoping .</p>",
        "id": 482428906,
        "sender_full_name": "Carbon",
        "timestamp": 1731600586
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482369498\">said</a>:</p>\n<blockquote>\n<p>I think my claim is that this is an <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> problem, and actually you would be fine with</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">capacity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I see. I had an issue in my initial implementation where one could do something that I wanted to avoid - see <a href=\"https://github.com/gdncc/Cryptography/blob/main/Cryptography/Hashes/SHA3/example.lean#L44-L45\">example.lean</a>.  Basically the returned hash function state was generic enough that I could pass it between different hash functions, which is not ideal.</p>\n<p>If I used a structure as above (which was more or less what I was doing), I assumed would have add to check the values at runtime? Whereas now, each state is completely dependent on c, p, o, which is different for each hash functions. Maybe there is a better way to do it.</p>",
        "id": 482431108,
        "sender_full_name": "Carbon",
        "timestamp": 1731601135
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"695316\">Carbon</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482431108\">said</a>:</p>\n<blockquote>\n<p>Basically the returned hash function state was generic enough that I could pass it between different hash functions, which is not ideal.</p>\n</blockquote>\n<p>What type is the returned hash function state?</p>",
        "id": 482431705,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731601298
    },
    {
        "content": "<p>Your existing code had this very strange property where your functions accepted <code>c</code>, <code>p</code>, <code>o</code>, and an <code>f : HashFunction c p o</code> that contained no new information.</p>",
        "id": 482432174,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731601416
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482431705\">said</a>:</p>\n<blockquote>\n<p>What type is the returned hash function state?</p>\n</blockquote>\n<p>So the state can be either <code>AbsorbingKeccakC α n</code>, or <code>SqueezingKeccakC α n</code> (this models the two phases of SHA-3 hash and XOF functions. For example function <code>absorb()</code> takes an absorbing state, and return sonly an absorbing state:</p>\n<p><code>def absorb {α : Type} {n : Capacity} (k : AbsorbingKeccakC α n) (inputBytes : ByteArray) : AbsorbingKeccakC α n</code></p>\n<p>Above, α is the type for <code>HashFunction</code>, and for instance <code>HashFunction 56 6 28</code>. The macros then ensure that each hash function can only accept the correct parameter and for instance, for SHA3_224 it will only work with a state (<code>AbsorbingKeccakC</code> or<code> SqueezingKeccakC</code>) with  <code>HashFunction 56 6 28</code>. I hope this makes sense.</p>",
        "id": 482435341,
        "sender_full_name": "Carbon",
        "timestamp": 1731602321
    },
    {
        "content": "<p>Then I recommend changing the signature to be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">absorb</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsorbingKeccakC</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inputBytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsorbingKeccakC</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 482436384,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731602618
    },
    {
        "content": "<p>And changing to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">KeccakC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span>\n<span class=\"w\">  </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SpongeState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SpongeState</span><span class=\"bp\">.</span><span class=\"n\">absorbing</span>\n<span class=\"w\">  </span><span class=\"n\">rate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RateValue</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"w\"> </span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">buffer</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FixedBuffer</span>\n<span class=\"w\">  </span><span class=\"n\">bufPos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RateIndex</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">KeccakPPermutationSize</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"w\"> </span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">outputBytesLen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 482436772,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731602716
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482436384\">said</a>:</p>\n<blockquote>\n<p>Then I recommend changing the signature to be</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">absorb</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashFunction</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Capacity</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsorbingKeccakC</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inputBytes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsorbingKeccakC</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>In both changes, <code>HashFunction</code> is a structure? Or did you mean something like <code>HashFunction c p o</code>? If the latter, is this for clarity? If the former,  users (well nobody really, this is just an API experiment for now <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> ) could call the wrong function on a state?</p>",
        "id": 482440246,
        "sender_full_name": "Carbon",
        "timestamp": 1731603629
    },
    {
        "content": "<p>Yes, <code>HashFunction</code> is now the structure</p>",
        "id": 482441378,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731603934
    },
    {
        "content": "<blockquote>\n<p>If the former, users (well nobody really, this is just an API experiment for now <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> ) could call the wrong function on a state?</p>\n</blockquote>\n<p>no, they can't :)</p>",
        "id": 482441410,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731603943
    },
    {
        "content": "<p>Try playing around with <a href=\"https://github.com/gdncc/Cryptography/pull/1\">https://github.com/gdncc/Cryptography/pull/1</a></p>",
        "id": 482441674,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731604025
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482441674\">said</a>:</p>\n<blockquote>\n<p>Try playing around with <a href=\"https://github.com/gdncc/Cryptography/pull/1\">https://github.com/gdncc/Cryptography/pull/1</a></p>\n</blockquote>\n<p>Wow, amazing. Thanks so much! This makes the code much simpler. I somehow lost sight of the obvious in my struggles. That is, my state can depend on a single struct value with 3 fields. Well I learnt a few things today, that, and the XY problem.</p>",
        "id": 482447192,
        "sender_full_name": "Carbon",
        "timestamp": 1731605766
    },
    {
        "content": "<p>I think you can probably also eliminate your macros by using dot notation too, but that's a much more minor point, and it depends whether your <code>private</code> experiment is intended to forbid users making their own hash functions</p>",
        "id": 482447801,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731605988
    },
    {
        "content": "<p>Yeah the idea was to attempt implementing an API without footguns, so users should not be able to create their own hash function parameters (although I suspect the implementation could ensure parameters are safe somehow). But I am interested at a high-level how you would dispense of them? I wanted to experiment with Lean macros, and removing (admittedly light) code duplication was an obvious target.</p>",
        "id": 482453242,
        "sender_full_name": "Carbon",
        "timestamp": 1731607736
    },
    {
        "content": "<p>I can make a follow-up PR after you merge / adapt <a href=\"https://github.com/gdncc/Cryptography/pull/1\">https://github.com/gdncc/Cryptography/pull/1</a></p>",
        "id": 482455751,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731608655
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482455751\">said</a>:</p>\n<blockquote>\n<p>I can make a follow-up PR after you merge / adapt <a href=\"https://github.com/gdncc/Cryptography/pull/1\">https://github.com/gdncc/Cryptography/pull/1</a></p>\n</blockquote>\n<p>Done!</p>",
        "id": 482455932,
        "sender_full_name": "Carbon",
        "timestamp": 1731608741
    },
    {
        "content": "<p><a href=\"https://github.com/gdncc/Cryptography/pull/2\">https://github.com/gdncc/Cryptography/pull/2</a> has an outline</p>",
        "id": 482498050,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731625302
    },
    {
        "content": "<p>The trick is that you don't need to define <code>SHA1.mk</code> etc, you can just define <code>SHA1 : HashFunction</code> and <code>HashFunction.mk</code>, and lean resolves the method notation for you.</p>",
        "id": 482498138,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731625334
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/482498138\">said</a>:</p>\n<blockquote>\n<p>The trick is that you don't need to define <code>SHA1.mk</code> etc, you can just define <code>SHA1 : HashFunction</code> and <code>HashFunction.mk</code>, and lean resolves the method notation for you.</p>\n</blockquote>\n<p>This is pretty cool. Shorter than the macro code, and it seems to provide the same functionality. I don't think I came across usage of a private constructor before e.g. <code>structure HashFunction where private ofParams ::</code></p>\n<p>I will merge this after a bit of work. Thank you!</p>",
        "id": 482500755,
        "sender_full_name": "Carbon",
        "timestamp": 1731626682
    },
    {
        "content": "<p>Yes, the private constructor is really orthogonal to the rest of the patch, but allows you to say \"this type is a public interface, but only I get to construct it\"</p>",
        "id": 482502722,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731627808
    },
    {
        "content": "<p>(the <code>ofParam ::</code> part is because I neeed to reclaim <code>mk</code> to use elsewhere!)</p>",
        "id": 482502744,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731627825
    },
    {
        "content": "<p>Feel free to discard my PR and use it for inspiration, rather than merging it, if you'd prefer</p>",
        "id": 482502768,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731627841
    },
    {
        "content": "<p>I am porting my SHA-3 implementation from Lean v4.14.0 to v4.15.0, and I had to re-write function <a href=\"https://github.com/gdncc/Cryptography/blob/5c5532cbd965de6977f7c3eae8414088e1e9f646/Cryptography/Hashes/SHA3/Basic.lean#L247-L258\"><code>storeUInt64()</code></a>. Below is my latest working attempt. I can't find a way to remove the repetition in the <code>rw</code> tactic. I've tried <code>simp</code> and <code>repeat rw</code> without success. Any ideas on how I can resolve this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">size_set</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span>\n\n<span class=\"c1\">-- Store little-endian `UInt64` in `ByteArray`. All Lean supported platforms are little-endian.</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x08</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x10</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x18</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x20</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x28</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x30</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bs</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x38</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">,</span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">size_set</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">bs</span>\n</code></pre></div>",
        "id": 496850794,
        "sender_full_name": "Carbon",
        "timestamp": 1738264715
    },
    {
        "content": "<p>There's probably a better overall solution, but you should just be able to do <code>by (repeat rw [ByteArray.size_set]); decide </code>, which will stop doing the rewrite step the first time it fails.</p>",
        "id": 496853994,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1738265765
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"228466\">@Chris Bailey</span> ! Surrounding repeat rw with parenthesis did the trick!</p>",
        "id": 496857237,
        "sender_full_name": "Carbon",
        "timestamp": 1738266792
    },
    {
        "content": "<p>I am not an expert here, but this may be more ergonomic to what you're trying to perform, so you don't need to provide intermediate proofs:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x08</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x10</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"c1\">-- rest here</span>\n</code></pre></div>",
        "id": 496862669,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738268960
    },
    {
        "content": "<p>Can you use <code>Vector UInt8</code>? The <code>set</code> operation on Vector knows that the size is constant. There will be much better support for Vector in v4.16 and even more in v4.17.0-rc1, both expected on Monday.</p>",
        "id": 496867414,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738270779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/496862669\">said</a>:</p>\n<blockquote>\n<p>I am not an expert here, but this may be more ergonomic to what you're trying to perform, so you don't need to provide intermediate proofs:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x08</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x10</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"c1\">-- rest here</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Still more ergonomic:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ByteArray</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n</code></pre></div>\n<p>The <code>&amp;&amp;&amp; 0xff</code> is redundant.</p>",
        "id": 496874193,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1738273424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/496862669\">said</a>:</p>\n<blockquote>\n<p>I am not an expert here, but this may be more ergonomic to what you're trying to perform, so you don't need to provide intermediate proofs:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x08</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"bp\">|&gt;.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x10</span><span class=\"w\">  </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xff</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n<span class=\"w\">      </span><span class=\"c1\">-- rest here</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Wow, this works well indeed!</p>",
        "id": 496875206,
        "sender_full_name": "Carbon",
        "timestamp": 1738273839
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/496867414\">said</a>:</p>\n<blockquote>\n<p>Can you use <code>Vector UInt8</code>? The <code>set</code> operation on Vector knows that the size is constant. There will be much better support for Vector in v4.16 and even more in v4.17.0-rc1, both expected on Monday.</p>\n</blockquote>\n<p>Vectors are boxed right?</p>",
        "id": 496875294,
        "sender_full_name": "Carbon",
        "timestamp": 1738273884
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> <a href=\"#narrow/channel/113488-general/topic/SHA-3.20implementation.20in.20pure.20Lean/near/496874193\">said</a>:</p>\n<blockquote>\n<p>Still more ergonomic:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ByteArray</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">storeUInt64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt8</span>\n</code></pre></div>\n<p>The <code>&amp;&amp;&amp; 0xff</code> is redundant.</p>\n</blockquote>\n<p>Very nice! I want something self-contained for now so I won't use Batteries. Nice catch on <code>&amp;&amp;&amp; 0xff</code> , I will remove it, thank you.</p>",
        "id": 496876279,
        "sender_full_name": "Carbon",
        "timestamp": 1738274307
    },
    {
        "content": "<p>I'm happy to upstream <code>ByteArray.ofFn</code>, is someone tells me what they need / that it is ready.</p>",
        "id": 496889513,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738280691
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I just PR a more efficient implementation of <code>ByteArray.ofFn</code> if you wish to upstream.</p>",
        "id": 497071947,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1738350912
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span>, I missed while reviewing that there is still a</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ofFn_eq_ofFnAux</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">ofFnAux</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>further down the file. Should we still have that?</p>",
        "id": 497102040,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738363668
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Good catch! Thanks! That's probably a remnant from before we had optimized Fin.folds. The new def is better since it reuses a sturdy wheel rather than inventing one. I'll fix that.</p>",
        "id": 497105644,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1738365879
    }
]