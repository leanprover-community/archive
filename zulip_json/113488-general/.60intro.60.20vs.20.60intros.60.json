[
    {
        "content": "<p>Dear All,</p>\n<p>as far as I can tell, <code>intros &lt;at least one variable&gt;</code> is equivalent to <code>intro &lt;same variables&gt;</code>.  Would it be desired to unify the common parts and only allow <code>intros</code> to not have any variables following it?</p>\n<p>The motivation for me comes from large scale refactors: having non-overlapping tactics makes it easier to automatically modify code.  In this specific case, I have been talking with Johan about \"collapsing\" <code>∀</code>/<code>intro(s)</code> pairs.</p>",
        "id": 454231747,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721979775
    },
    {
        "content": "<p>Maybe we could replace intros entirely by <code>intro ..</code></p>",
        "id": 454250190,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721984466
    },
    {
        "content": "<p>What about <code>introv</code>? How is it different from <code>intros</code>?</p>",
        "id": 454252257,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721985138
    },
    {
        "content": "<p><code>introv</code> only introduces \"non-dependent\" variables:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">introv</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `(h : a = 0)` is still not extracted</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 454254757,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721985976
    },
    {
        "content": "<p>Ruben, I like the <code>..</code> suggestion a lot, but that would require modifying/extending the current syntax.  What I was initially proposing was simply \"deprecating\" some redundant use, not actually removing <code>intros</code> and re-implementing it in in <code>intro ..</code>.</p>",
        "id": 454255033,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721986097
    },
    {
        "content": "<p>What would be the benefit to mathlib contributors to require them to write <code>intro x</code> rather than <code>intros x</code>? I feel like this might be more cognitive overhead having to continue to remember to remove the <code>s</code> (or to spend time clicking on code actions) than learning how <code>intro</code> and <code>intros</code> work.</p>\n<p>I tend to be more in the \"don't force people to write in a particular way\" camp, so long as the idioms don't take too much effort to understand, rather than \"there must be only one way to do it\". I find the latter to sap a bit of fun out of it.</p>",
        "id": 454362108,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722024144
    },
    {
        "content": "<p>Regarding <code>intro ..</code>, I would imagine that this would be like <code>repeat intro</code>, which is different from <code>intros</code> since <code>intro</code> can unfold.</p>",
        "id": 454362286,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722024209
    },
    {
        "content": "<p>Fair enough and I agree with Kyle's reasons.</p>\n<p>In any case, the automatic modification of code can still output only either <code>intros [no variables]</code> or <code>intro ...</code> and continue with doing whatever else is needed.</p>",
        "id": 454383537,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722032738
    },
    {
        "content": "<p>I consider <code>intros</code> a strictly weaker version of <code>intro</code> and almost never use it. One other difference is that <code>intros</code> only accepts identifiers but <code>intro</code> takes patterns. I proposed <code>intro a ..</code> and <code>fun a .. =&gt;</code> a while ago but I never implemented it, I think it completely subsumes <code>intros</code></p>",
        "id": 454514544,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722107190
    },
    {
        "content": "<p>I would much rather <code>intros</code>, if it exists at all, is just a synonym of <code>intro</code>. Having two almost-the-same tactics (with a completely unrelated plurality difference) is very hard to teach</p>",
        "id": 454514695,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722107270
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <code>intros</code> only introduces obvious foralls. If I were to see <code>intro ..</code> or <code>fun .. =&gt; </code> I might expect them to reduce</p>",
        "id": 454516059,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722107881
    },
    {
        "content": "<p>I don't think it does, normally</p>",
        "id": 454516163,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722107901
    },
    {
        "content": "<p><code>..</code> in applications doesn't reduce IIRC</p>",
        "id": 454516236,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722107919
    },
    {
        "content": "<p>I thought it did:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"c1\">-- f ?m.1809 ?m.1810 : Nat</span>\n</code></pre></div>",
        "id": 454516399,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722107973
    },
    {
        "content": "<p>I've been surprised by it not always doing so in the past, I don't have examples on hand</p>",
        "id": 454516503,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722108016
    },
    {
        "content": "<p>also <code>apply</code> has similar caveats</p>",
        "id": 454516518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722108028
    },
    {
        "content": "<p>Something that I think would be good is to change <code>intros</code> so that <code>intros x y z</code> is the same as <code>intro x y z; intros</code>, and maybe give <code>intros</code> the ability to have patterns. Having all obvious foralls be introduced is the only value to <code>intros</code>, and so it seems silly having it turn off immediately at the first supplied binder name.</p>",
        "id": 454516717,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722108134
    },
    {
        "content": "<p>In any case I still think that this is what <code>intro x y z ..</code> should do</p>",
        "id": 454518591,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722108667
    },
    {
        "content": "<p>I think <code>intro ..</code> should not do reduction, while <code>intro _ _ _</code> will do reduction sufficient to expose 3 foralls</p>",
        "id": 454518675,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722108716
    },
    {
        "content": "<p>It would be a shame if <code>fun ..</code> were introduced and <code>intro x y z ..</code> weren't the same as <code>refine fun x y z .. =&gt; ?_</code></p>\n<p>Implementation note about <code>f x y z ..</code>: it's not that <code>..</code> does reduction per se, it's that argument processing in the app elaborator does reduction.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">)</span>\n<span class=\"c1\">-- fun a =&gt; f a : Nat → Nat</span>\n</code></pre></div>",
        "id": 454520106,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722109329
    },
    {
        "content": "<p>to be clear, I also want <code>refine fun x y z .. =&gt; ?_</code> to do the same thing</p>",
        "id": 454520209,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109366
    },
    {
        "content": "<p>“How aggressive <code>..</code> should be” seems like it’s relevant question in a few places—app syntax, intro (and potentially <code>fun .. =&gt;</code>) and also structure instances (<code>{ .. }</code>) in <code>refine'</code> (in the form “should it replace default values with metavariables or try to synthesize them”).</p>\n<p>I don’t know what it would be, but it might be worth having some uniform way to spell “<code>..</code> but it tries hard to insert underscores” (or vice versa, if aggressiveness were the default)</p>",
        "id": 454520210,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722109366
    },
    {
        "content": "<p>I don't think we need <code>..!</code> to be a thing, just use lots of underscores if you want that</p>",
        "id": 454520421,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109441
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/.60intro.60.20vs.20.60intros.60/near/454520209\">said</a>:</p>\n<blockquote>\n<p>to be clear, I also want <code>refine fun x y z .. =&gt; ?_</code> to do the same thing</p>\n</blockquote>\n<p>I get that, and what I'm saying is that I would expect <code>..</code> for binders to be dual to <code>..</code> for arguments. (Though <code>..</code> for binders without reduction seems more obviously useful to me.)</p>",
        "id": 454520537,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722109468
    },
    {
        "content": "<p>“Use lots of underscores” is generally a bad time</p>",
        "id": 454520540,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722109469
    },
    {
        "content": "<p>maybe <code>with_unfolding_all</code> and then <code>intro ..</code> will do that as well</p>",
        "id": 454520582,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109481
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> I put the blame here on the application syntax, I think it's a bit broken here although the edge cases are rare</p>",
        "id": 454520660,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109513
    },
    {
        "content": "<p>I'm pretty sure that as you said it's not actually trying to unfold at more than reducible level, but something else is causing the unfolding</p>",
        "id": 454520898,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109581
    },
    {
        "content": "<p>which means the end result is that stuff sometimes gets unfolded and sometimes not</p>",
        "id": 454520929,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722109595
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/stream/113488-general/topic/.60intro.60.20vs.20.60intros.60/near/454520540\">said</a>:</p>\n<blockquote>\n<p>“Use lots of underscores” is generally a bad time</p>\n</blockquote>\n<p>To explain what I mean here, I think anything which makes me manually count tokens (sometimes way more than 3) in source code to figure out what’s going on (or makes me look at adjacent info like the infoview, and infer) is always going to be less legible than weird-but-suggestive syntax I can hover over which has a straightforward interpretable meaning.</p>\n<p>(And in the other direction too: I think most people’s reaction to “<code>..</code> isn’t doing what I want it to” would be to check the hover for variations—and finding one is preferable to counting all the binders, then counting all the underscores you type!)</p>\n<p>I kind of assumed <code>..!</code> was a no-go because of ASCII soup concerns, but I think having <em>something</em> is better than the alternative of sometimes typing or reading many undifferentiated tokens.</p>",
        "id": 454526303,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722112807
    },
    {
        "content": "<p>well as I said <code>with_unfolding_all intro ..</code> seems about 70% likely to do the right thing anyway</p>",
        "id": 454526378,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722112917
    },
    {
        "content": "<p>Are you proposing <code>with_unfolding_all</code> for <code>fun</code> and structure instances too, though? I feel like these are related problems and should have related solutions</p>",
        "id": 454526545,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722113098
    },
    {
        "content": "<p>I think it already has effect on everything, including <code>fun</code></p>",
        "id": 454527544,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722114061
    },
    {
        "content": "<p>I’m not sure that’s desirable, e.g. <code>with_unfolding_all fun x y .. =&gt; foo</code> would also unfold in <code>foo</code>, right?</p>",
        "id": 454528536,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722115028
    },
    {
        "content": "<p>what do you mean by that?</p>",
        "id": 454528572,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722115049
    },
    {
        "content": "<p><code>with_unfolding_all</code> affects the reducibility level used whenever lean wants to unfold something, <code>foo</code> doesn't need unfolding there</p>",
        "id": 454528632,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722115089
    },
    {
        "content": "<p>In this example <code>foo</code> is a stand-in for a more complex expression</p>",
        "id": 454528654,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722115120
    },
    {
        "content": "<p>oh sure, you would need to use refine or reassert the unfolding level inside a subterm if you want something else</p>",
        "id": 454528687,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722115164
    },
    {
        "content": "<p>but AFAIK this is the existing behavior</p>",
        "id": 454528695,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722115173
    },
    {
        "content": "<p>Right; I suppose it seems a bit “hacky”(?) to me to be managing this nonlocally, i.e. this feels to me like a thing <code>..</code> should be doing, not the result of an ambient setting to turn on and off. (And I suppose this sense is already partially adopted in the fact that lots of tactic syntax builds in a <code>!</code> sigil when reducibility settings need to be adjusted, instead of saying “use <code>with_unfolding_all</code>”.)</p>\n<p>I guess it comes down to aesthetic preferences if these are the two choices (but I kind of hope there’s a third option): which weird sigil do you want, lengthy <code>with_unfolding_all</code> and manage the reducibility setting bluntly and manually, but in a standard way that doesn’t ask for any new features, or ASCII soup ingredient <code>!</code> and increase the knob count, but do exactly what you want in at least a suggestive/stylistically consistent way.</p>",
        "id": 454530025,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722116461
    },
    {
        "content": "<p>You originally asked for a way to make it possible, and I'm saying that such a way already exists. Making it easy can be done in user space via a macro, but I would want to see more evidence that this is actually a problem that needs solving before making it any easier than that</p>",
        "id": 454530119,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722116562
    },
    {
        "content": "<p>I wasn’t asking merely how to make it possible; I hoped it was clear I’m asking a design question, given what I’m bringing up!</p>\n<p>But, fair enough. (The initiating discussion implicitly does pose it as a problem, though: one solution to “what behavior should this be designed to have” is “design a way to select it”)</p>",
        "id": 454534070,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1722118406
    },
    {
        "content": "<p>Could we have <code>..</code> and <code>...</code> or is that too exotic?</p>",
        "id": 454727309,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1722231302
    },
    {
        "content": "<p>Rust used to have <code>..</code> and <code>...</code> (for exclusive and inclusive ranges) but they moved away from that</p>",
        "id": 454739595,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722236416
    }
]