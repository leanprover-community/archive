[
    {
        "content": "<p>Or in other words: how long does a proof need to get before you decide to slice it up in multiple different theorems?</p>\n<p>I was thinking about the parallels between proof engineering and software development, and became curious about the question in the title. Of course, not all proofs are equal, and while I haven't found many proofs in the standard library which are longer than 10 lines (maybe I haven't been looking in the right places), I have seen other users talking about proofs over a thousand lines long (maybe they didn't mean in a single statement). In any case, I am curious about people's answers!</p>",
        "id": 527361199,
        "sender_full_name": "Ayhon",
        "timestamp": 1751823418
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"690100\">@Ayhon</span> it's hard to have a hard number, but ideally 1 line long, but that's a very ideal case, most of the time it can take 5 lines, 10 lines, or even 20 lines; but the point is, it's considered (at least by me) a better thing to have 100 lemmas with short proofs, than to have 1 lemma that is 100 line long.</p>\n<p>I always advocate for factoring out lemmas whenever possible.</p>",
        "id": 527362090,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751824429
    },
    {
        "content": "<p>a proof needs to be very hard and specific to take more than 40 lines IME</p>",
        "id": 527362148,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751824502
    },
    {
        "content": "<p>the average size of lemmas in mathlib tends to be smaller than in your big project depending on mathlib, because the nature of the formalization is slightly different</p>",
        "id": 527362193,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751824568
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/What's.20the.20average.20length.20of.20a.20Lean.20proof.3F/near/527362090\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"690100\">Ayhon</span> it's hard to have a hard number, but ideally 1 line long, but that's a very ideal case, most of the time it can take 5 lines, 10 lines, or even 20 lines; but the point is, it's considered (at least by me) a better thing to have 100 lemmas with short proofs, than to have 1 lemma that is 100 line long.</p>\n<p>I always advocate for factoring out lemmas whenever possible.</p>\n</blockquote>\n<p>I agree, and I feel this stems a bit from the discipline of sofware engineering. I was just wondering how widespread it was among actual Lean users.</p>",
        "id": 527362206,
        "sender_full_name": "Ayhon",
        "timestamp": 1751824577
    },
    {
        "content": "<p>in mathlib I would say 10 lines is more typical for hard proofs and 1 line for easy proofs</p>",
        "id": 527362225,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751824600
    },
    {
        "content": "<p>Lemmas get longer than that not because they are very hard, but because they are very specific and there is no benefit to splitting out pieces of them without having the statements overwhelm the proof</p>",
        "id": 527362346,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751824756
    },
    {
        "content": "<p>this is frequently a sign of bad or missing abstractions, so after refactoring the lemma length tends to go back down</p>",
        "id": 527362374,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751824802
    },
    {
        "content": "<p>For more concrete data, I used a Python script to look at my most recent file (<a href=\"https://github.com/leanprover-community/mathlib4/pull/26804\">#26804</a> Mathlib/SetTheory/ZFC/Model.lean), and here is the result:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>1 : 71\n2 : 2\n3 : 6\n4 : 1\n5 : 1\n6 : 5\n7 : 1\n8 : 4\n9 : 1\n11 : 1\n13 : 1\n19 : 1\n20 : 1\n</code></pre></div>",
        "id": 527362680,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751825031
    },
    {
        "content": "<p>i.e. most (71) of the proofs/definitions are 1 line long, but there are also a few that go up to 19 and 20 lines long</p>",
        "id": 527362712,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751825062
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/MYKJWLa8vZ975KDL0lR0D6Ig/pie.png\">pie.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/MYKJWLa8vZ975KDL0lR0D6Ig/pie.png\" title=\"pie.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1088x393\" src=\"/user_uploads/thumbnail/3121/MYKJWLa8vZ975KDL0lR0D6Ig/pie.png/840x560.webp\"></a></div>",
        "id": 527362958,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751825299
    },
    {
        "content": "<p>Most of my proofs are under 10 lines but some outliers are enormous (as a matter of fact, yesterday I finished a proof that has 1200 lines — that is the longest atomic proof I have ever written).</p>",
        "id": 527372088,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751834710
    },
    {
        "content": "<p>1200 lines is a ridiculous size for a theorem, at that point you will have serious problems getting lean to be responsive on it</p>",
        "id": 527373741,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751836767
    },
    {
        "content": "<p>The length doesn't make me happy, but splitting the lemma intro sublemmas would not make me happy either.</p>",
        "id": 527373905,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751836962
    },
    {
        "content": "<p>it might make lean and your readers happy though</p>",
        "id": 527373990,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751837066
    },
    {
        "content": "<p>Speaking of readers, I focus on minimizing the trusted code length, not on minimizing the total code length.</p>",
        "id": 527374035,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751837119
    },
    {
        "content": "<p>By trusted code, I mean the statement of the final theorem and all definitions that are transitively reachable for the theorem statement. Currently we are at circa 300 lines of trusted code<br>\n<a href=\"https://github.com/Ivan-Sergeyev/seymour/blob/main/Seymour.lean\">https://github.com/Ivan-Sergeyev/seymour/blob/main/Seymour.lean</a><br>\nmodulo some basic Mathlib definitions that hopefully nobody will be worried about.</p>\n<p>If I were to invest my time into shortening something, it would definitely be shortening the trusted code, not the long proofs.</p>",
        "id": 527374182,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751837270
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/What's.20the.20average.20length.20of.20a.20Lean.20proof.3F/near/527362090\">said</a>:</p>\n<blockquote>\n<p>have 100 lemmas with short proof</p>\n</blockquote>\n<p>Having 100 lemmas with short proofs sounds great until you realize you have to name all of them.</p>",
        "id": 527375305,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751838517
    },
    {
        "content": "<p>naming is hard but it's not that hard</p>",
        "id": 527375357,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751838577
    },
    {
        "content": "<p>usually you can just start listing the constants used in the theorem statement until you get bored</p>",
        "id": 527375377,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751838606
    },
    {
        "content": "<p>For things which make up a long proof, you always have the good old <code>private lemma aux47</code></p>",
        "id": 527375493,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1751838764
    },
    {
        "content": "<p>Yeah, I also do that (ok, not exactly <em>that</em>).</p>\n<p>The real reason why I sometimes fail to break a lemma into smaller lemmas is that I would have to repeat too much context all over again. In the end, I usually isolate things that depend on something like 3 things in the local context into a separate lemma, but if it needed like 30 things, I keep it in place (some people would say <em>inlined</em> but this word really doesn't sound right in this context).</p>",
        "id": 527375625,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751838939
    },
    {
        "content": "<p>I've heard some people use <code>ProofData</code> terms or something like that.</p>",
        "id": 527375816,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751839204
    },
    {
        "content": "<p>I was about to say: that sounds exactly like you're looking for the <code>ProofData</code> pattern.</p>",
        "id": 527375939,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1751839298
    },
    {
        "content": "<p>Hmmm, <code>ReaderT ProofData &lt;actual-proposition-here&gt;</code>?</p>",
        "id": 527375947,
        "sender_full_name": "Ayhon",
        "timestamp": 1751839316
    },
    {
        "content": "<p>The best written explanation I know is <a href=\"https://zenn.dev/pandaman64/articles/lean-proof-data-en\">https://zenn.dev/pandaman64/articles/lean-proof-data-en</a>, but I believe some of Floris van Doorn's slides about the Carleson project also mention it.</p>",
        "id": 527375965,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1751839344
    },
    {
        "content": "<p>Thanks for the link!</p>",
        "id": 527376031,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751839430
    },
    {
        "content": "<p>ProofData looks very similar to certain pattern in regular programming</p>",
        "id": 527382724,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1751847737
    },
    {
        "content": "<p>The length of a proof seems to be a misguided line of thinking here. What we optimise for should be (1) reusability (opposite of code duplication) and (2) readability, both of which are only somewhat anti-correlated with length.</p>\n<p>In analysis proofs, where one sometimes constructs long and complicated proof terms (such as particular functions), I only split out lemmas or definitions for these terms if I think they have a good chance of being reused in other similar proofs. This way, it is clear in the context of the current proof why this term is constructed in this form. On the other hand, if an argument seems to go on and on, or if the proof is multiply nested, then I will pick an intermediate step to split out as an auxiliary lemma, so that its goal state can be explicitly stated in the code, even if the lemma may never be reused.</p>\n<p>I find it less readable to unnecessarily split out lots of smaller lemmas, as the logical flow of the main proof is disrupted as you reference these lemma statements. My 2¢.</p>",
        "id": 527392547,
        "sender_full_name": "Winston Yin (尹維晨)",
        "timestamp": 1751857705
    },
    {
        "content": "<p>This is exactly my approach! Split proofs into multiple proofs and split files into multiple files based on their logic, not based on the number of lines.</p>",
        "id": 527424173,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751876431
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/113488-general/topic/What's.20the.20average.20length.20of.20a.20Lean.20proof.3F/near/527375965\">said</a>:</p>\n<blockquote>\n<p>The best written explanation I know is <a href=\"https://zenn.dev/pandaman64/articles/lean-proof-data-en\">https://zenn.dev/pandaman64/articles/lean-proof-data-en</a>, but I believe some of Floris van Doorn's slides about the Carleson project also mention it.</p>\n</blockquote>\n<p>It is also mentioned in the sphere eversion project paper.</p>",
        "id": 527432817,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1751879194
    },
    {
        "content": "<p>Paper link: <a href=\"https://dl.acm.org/doi/10.1145/3573105.3575688\">https://dl.acm.org/doi/10.1145/3573105.3575688</a>, arXiv version: <a href=\"https://arxiv.org/abs/2210.07746\">https://arxiv.org/abs/2210.07746</a></p>",
        "id": 527440324,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1751881623
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"417654\">Martin Dvořák</span> <a href=\"#narrow/channel/113488-general/topic/What's.20the.20average.20length.20of.20a.20Lean.20proof.3F/near/527424173\">said</a>:</p>\n<blockquote>\n<p>This is exactly my approach! Split proofs into multiple proofs and split files into multiple files based on their logic, not based on the number of lines.</p>\n</blockquote>\n<p>Yes, of course the \"number of lines\" is not the real objective, but rather an indicator; but 1200 lines signifies to me that there might be some inefficiencies here</p>",
        "id": 527440557,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751881702
    },
    {
        "content": "<p>I don't know, sometimes constructions are just fugly and splitting them into multiple lemmas makes it so that you have very useless one off lemmas. At that point you just make searching for lemmas harder, as every specialised one off lemma clutters the code base. I'd then advocate to just make those lemmas private.</p>",
        "id": 527443872,
        "sender_full_name": "metakuntyyy",
        "timestamp": 1751882648
    },
    {
        "content": "<p>Of course. The majority of lemmas in my code are private.</p>",
        "id": 527446584,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751883599
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/What's.20the.20average.20length.20of.20a.20Lean.20proof.3F/near/527440557\">said</a>:</p>\n<blockquote>\n<p>1200 lines signifies to me that there might be some inefficiencies here</p>\n</blockquote>\n<p>I am absolutely sure there must be an inefficiency somewhere in my proof.</p>",
        "id": 527447105,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1751883788
    },
    {
        "content": "<p>One advantage to having short proofs is not readability, but rather, reproducibility. When definitions in mathlib change, proofs break, and sometimes the best solution is to just rewrite the broken proofs from scratch. Keeping proofs short makes this possible.</p>",
        "id": 527494948,
        "sender_full_name": "Niels Voss",
        "timestamp": 1751899159
    }
]