[
    {
        "content": "<p>For <span class=\"user-mention\" data-user-id=\"243791\">@David Renshaw</span>'s great chess implementation, I added a widget to render the chess position a little bit more pretty: <a href=\"https://github.com/dwrensha/animate-lean-proofs/pull/4\">https://github.com/dwrensha/animate-lean-proofs/pull/4</a> </p>\n<p>Now we are wondering: is it possible to use that widget directly in the proof state? Are there good examples of widgets that do that somehow?<br>\nI can only find lean3 examples and no good lean4 examples of the usage of widgets.</p>",
        "id": 465708367,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1724837694
    },
    {
        "content": "<p>Have you already looked into <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Widget.savePanelWidgetInfo#doc\">docs#Lean.Widget.savePanelWidgetInfo</a> or <code>with_panel_widgets</code>? <a href=\"https://github.com/leanprover-community/ProofWidgets4/blob/main/ProofWidgets/Demos/Venn.lean\">This demo</a> in the <code>ProofWidgets</code> repository gives a nice example of displaying an additional visualisation of the proof state.</p>",
        "id": 465723001,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1724840654
    },
    {
        "content": "<p>Now I was looking into this a bit more, and I thought I would mimic what the StringDiagram widget does and also what you linked to above. So I wrote this <code>@[server_rpc_method] myrpc</code> method which is supposed to return some html for the <code>Position</code> if we are our result prop comes from  <code>ForcedWin (Side â†’ Position â†’ Prop)</code> evaluated at a <code>Side</code> and <code>Position</code>, <br>\n<a href=\"https://github.com/mo271/animate-lean-proofs/blob/4b84bb0a955a55c8127d0cb0033d34b66bdff7b1/ChessWidgetExample.lean#L53C20-L78\">https://github.com/mo271/animate-lean-proofs/blob/4b84bb0a955a55c8127d0cb0033d34b66bdff7b1/ChessWidgetExample.lean#L53C20-L78</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Jsx</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/-- The RPC method for displaying FEN for ForcedWin (Side â†’ Position â†’ Prop). -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">server_rpc_method</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myrpc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">props</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PanelWidgetProps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RequestTask</span><span class=\"w\"> </span><span class=\"n\">Html</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">RequestM</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Html</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">props</span><span class=\"bp\">.</span><span class=\"n\">goals</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"c1\">-- No goals, return none</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">props</span><span class=\"bp\">.</span><span class=\"n\">goals</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">unreachable!</span>\n<span class=\"w\">        </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">            </span><span class=\"c1\">-- Get the goal's type</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">            </span><span class=\"c1\">-- Extract the function name and arguments using `getAppFnArgs`</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fn</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">getAppFnArgs</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">``ForcedWin</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">              </span><span class=\"c1\">-- Extract the `Position` argument</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">posExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\">  </span><span class=\"c1\">-- The second argument should be the Position</span>\n<span class=\"w\">              </span><span class=\"c1\">-- Try to manually interpret `posExpr` as a `Position` somehow</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">posVal</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``_root_.Position</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">posExpr</span>\n\n<span class=\"w\">              </span><span class=\"c1\">-- Convert the interpreted position to FEN</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fenStr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fenFromPosition</span><span class=\"w\"> </span><span class=\"n\">posVal</span>\n<span class=\"w\">              </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">span</span><span class=\"bp\">&gt;</span><span class=\"n\">FEN</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Html</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">fenStr</span><span class=\"o\">}</span><span class=\"bp\">&lt;/</span><span class=\"n\">span</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">html</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">span</span><span class=\"bp\">&gt;</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">ForcedWin</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"bp\">.&lt;/</span><span class=\"n\">span</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">inner</span>\n</code></pre></div>\n<p>I think it is all more or less correct, but I get <code>(kernel) invalid declaration, it uses unsafe declaration 'Lean.Meta.evalExpr'\n</code> and when I use <code>unsafe</code> for the def myrpc, I get just get a similar error down the road:<br>\n<code>(kernel) invalid declaration, it uses unsafe declaration 'Chess.myrpc'</code><br>\nSo therefore my question is: </p>\n<p>Is there a safe alternative to <code>Lean.Meta.evalExpr</code>?</p>",
        "id": 472560156,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1727206094
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"313038\">@Moritz Firsching</span> at first glance I think the issue is that <code>evalExpr</code> can only evaluate _closed_ (variable-free) expressions, whereas you are trying to evaluate part of the goal state which might contain free variables. I think the only solution is to pattern-match on the position <code>Expr</code> and get out what you need from it, otherwise fail.</p>",
        "id": 472571575,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1727211038
    },
    {
        "content": "<p>If you are sure that the <code>Position</code> you see there is closed, so that <code>evalExpr</code> can run, the standard solution is to write a safe wrapper around <code>evalExpr</code> at a specific type.</p>",
        "id": 472571715,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1727211110
    },
    {
        "content": "<p>Like <a href=\"https://github.com/leanprover/lean4/blob/a6f0112fc5c394af7ad4325199ccf6d44aa04aed/src/Lean/Widget/UserWidget.lean#L45\">this</a>.</p>",
        "id": 472571815,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1727211141
    },
    {
        "content": "<p>Or just use the <code>unsafe</code> term syntax?</p>",
        "id": 472592748,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727224305
    },
    {
        "content": "<p>Thank you both! the <code>unsafe</code> term syntax worked, so I didn't try the other approach. <br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Term.unsafe#doc\">docs#Lean.Parser.Term.unsafe</a></p>",
        "id": 472612622,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1727239625
    },
    {
        "content": "<p>Now it works great for displaying the FEN. For also displaying the nicely rendered board, I turned my <code>ChessPositionWidget</code> into a component like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ChessPositionWidgetProps</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pos?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Position</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Server</span><span class=\"bp\">.</span><span class=\"n\">RpcEncodable</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">widget</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ChessPositionWidget</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"n\">ChessPositionWidgetProps</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">javascript</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"[all the javascript that renders the board, using stuff from `pos`]\"</span>\n</code></pre></div>\n<p>and while it displays the board fine in calls like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">widget</span><span class=\"w\"> </span><span class=\"n\">ChessPositionWidget</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">get_pos</span><span class=\"w\"> </span><span class=\"n\">Chess</span><span class=\"bp\">.</span><span class=\"n\">morphy_mates_in_two</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ChessPositionWidgetProps</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>when I use it as a component in the ForcedWinWidget, it only displays the empty board.<br>\n<a href=\"https://github.com/mo271/animate-lean-proofs/blob/5aa3cd3820c9779164be39dee491fc6bb18d718f/ChessWidgetExample.lean#L79\">https://github.com/mo271/animate-lean-proofs/blob/5aa3cd3820c9779164be39dee491fc6bb18d718f/ChessWidgetExample.lean#L79</a><br>\nwhile the FEN for the same <code>Position</code> gets extracted and displayed correctly.<br>\n(full working code in that commit)<br>\nWhat am I doing wrong?</p>",
        "id": 472626235,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1727247682
    },
    {
        "content": "<p>Hah, I was worried this would happen to somebody eventually. Widgets have a builtin prop called <code>pos</code>, and it is overwriting the one you are providing. If you just change it to <code>boardPos</code> or something, it should work. We should have a warning shown in this edge case, though.</p>",
        "id": 472722837,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1727277818
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span>, it works now: <a href=\"https://github.com/dwrensha/animate-lean-proofs/blob/e5e8a4a7c30e4a9e17910aed4c843a17ad226b67/Chess/Widgets.lean\">https://github.com/dwrensha/animate-lean-proofs/blob/e5e8a4a7c30e4a9e17910aed4c843a17ad226b67/Chess/Widgets.lean</a>,<br>\nreview/comments welcome at <a href=\"https://github.com/dwrensha/animate-lean-proofs/pull/7\">https://github.com/dwrensha/animate-lean-proofs/pull/7</a></p>\n<p>So I suppose the other forbidden prop names are <code>goals</code>, <code>termGoal</code> and <code>selectedLocations</code> (from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ProofWidgets.PanelWidgetProps#doc\">docs#ProofWidgets.PanelWidgetProps</a> ) ?</p>\n<p>Where would we best show a warning, just in the documentation somewhere (where?) or in the code when you try to define such a prop name?</p>",
        "id": 472755334,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1727289790
    }
]