[
    {
        "content": "<p>Can someone please tell me what <a href=\"https://github.com/leanprover/lean4/blob/master/doc/make/emscripten.md\">https://github.com/leanprover/lean4/blob/master/doc/make/emscripten.md</a> is meant for ?</p>\n<ol>\n<li>I have followed the (regular) build instructions via</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">nix</span><span class=\"w\"> </span><span class=\"n\">develop</span>\n<span class=\"mi\">21613</span><span class=\"w\">  </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"c1\">--preset release</span>\n<span class=\"mi\">21614</span><span class=\"w\">  </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">j56</span>\n<span class=\"mi\">21615</span><span class=\"w\">  </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">j200</span>\n</code></pre></div>\n<p>and everything went fine</p>\n<ol start=\"2\">\n<li>I am under the impression that lean4 does <strong>not</strong> compile to wasm32 yet (i.e. this is why the lean4web / lean game server uses a x86_64 server instead of running all in Chrome/wasm32)</li>\n</ol>\n<p>question: what is this lean.js, and what are the emscriptsen build instrs for?</p>\n<p>Thanks!</p>",
        "id": 560678739,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764282540
    },
    {
        "content": "<p>Lean had a wasm32 build until v4.15.0 (see for example the list of assets at <a href=\"https://github.com/leanprover/lean4/releases/tag/v4.15.0\">https://github.com/leanprover/lean4/releases/tag/v4.15.0</a>), but we ran into an Emscripten limitation which would have taken a lot of engineering effort to overcome, and we decided to drop the WebAssembly target for the time being. So the current status is that the WebAssembly target is still in the code, but in a broken state. Whether it will come back depends on whether there is a use case for a WebAssembly target that is important enough to justify the significant investment to bring it back and keep it running (this is a very high bar).</p>",
        "id": 560708315,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764306787
    },
    {
        "content": "<p>Thank you for the informative historical insight. Could you expand a bit more on</p>\n<blockquote>\n<p>but we ran into an Emscripten limitation which would have taken a lot of engineering effort to overcome, and we decided to drop the WebAssembly target for the time being</p>\n</blockquote>\n<p>My background is: (1) I just recently got the lean4 github code to build locally (on x86_64), (2) I I have some familiar with wasm32, not via emscriptsen, but Rust.</p>\n<p>I'm curious is the issue: 4GB memory limit ? This appears to be resolved in <a href=\"https://spidermonkey.dev/blog/2025/01/15/is-memory64-actually-worth-using.html\">https://spidermonkey.dev/blog/2025/01/15/is-memory64-actually-worth-using.html</a> (never tested this myself).</p>\n<p>Digging around github issues, I found <a href=\"https://github.com/leanprover/lean4/pull/2599\">https://github.com/leanprover/lean4/pull/2599</a> , where the claim seems to be \"wasm32 makes CI tests really slow\"</p>\n<p>I'm curious if you could share what the Emscriptsen limitation is (or point me to the github issue). Thanks!</p>",
        "id": 560710077,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764308310
    },
    {
        "content": "<p>The problem was that the build used <code>EXPORT_ALL</code> and we exceeded the limit of 10000 exported symbols (not sure whether this is an emscripten or wasm-ld limitation)</p>",
        "id": 560717884,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764313646
    },
    {
        "content": "<ol>\n<li>I currently reproduce the \"10,000 export limit error yet\"</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">doc</span><span class=\"bp\">/</span><span class=\"n\">make</span><span class=\"bp\">/</span><span class=\"n\">emscripten</span><span class=\"bp\">.</span><span class=\"n\">md</span><span class=\"w\"> </span><span class=\"n\">says</span><span class=\"o\">:</span>\n<span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">emscripten</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">emscripten</span>\n<span class=\"n\">emconfigure</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../../</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"bp\">=</span><span class=\"n\">Emscripten</span>\n<span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">lean_js_js</span><span class=\"w\"> </span><span class=\"n\">lean_js_wasm</span>\n</code></pre></div>\n<p>however, running the <code> emconfigure cmake</code>line, I get </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">emconfigure</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../../</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"bp\">=</span><span class=\"n\">Emscripten</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`emcmake</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">rather</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"ss\">`emconfigure</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"n\">projects</span>\n</code></pre></div>\n<p>changing to emcmake, I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">emcmake</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../../</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"bp\">=</span><span class=\"n\">Emscripten</span>\n<span class=\"n\">configure</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../../</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"bp\">=</span><span class=\"n\">Emscripten</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_TOOLCHAIN_FILE</span><span class=\"bp\">=/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"mi\">202</span><span class=\"n\">rpslcjhwax183ahrf54xf46kvp1li</span><span class=\"bp\">-</span><span class=\"n\">emscripten</span><span class=\"bp\">-</span><span class=\"mf\">4.0</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">/</span><span class=\"n\">share</span><span class=\"bp\">/</span><span class=\"n\">emscripten</span><span class=\"bp\">/</span><span class=\"n\">cmake</span><span class=\"bp\">/</span><span class=\"n\">Modules</span><span class=\"bp\">/</span><span class=\"n\">Platform</span><span class=\"bp\">/</span><span class=\"n\">Emscripten</span><span class=\"bp\">.</span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_CROSSCOMPILING_EMULATOR</span><span class=\"bp\">=/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">ijsy113yzy0mpcr1sf0773nz9v0r7hff</span><span class=\"bp\">-</span><span class=\"n\">nodejs</span><span class=\"bp\">-</span><span class=\"mf\">22.17</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">node</span>\n<span class=\"n\">CMake</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">CMakeLists</span><span class=\"bp\">.</span><span class=\"n\">txt</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">message</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">STAGE</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">CMakeLists</span><span class=\"bp\">.</span><span class=\"n\">txt</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">folder</span>\n</code></pre></div>\n<p>changing to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">emcmake</span><span class=\"w\"> </span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"bp\">../../</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"bp\">=</span><span class=\"n\">Emscripten</span><span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"n\">DSTAGE</span><span class=\"bp\">=</span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>I get an error about not finding mimalloc.h (still sorting this out)</p>\n<p>Setting aside those issues: do we actually need export_all ? Intuitively, I feel there is a very small number of lean4 wasm fns we need to expose to js. The exported fns need to be able to call non-exported fns, but it is not clear to me at all why we need to export all fns.</p>\n<p>This shows my lack of understanding of lean4 internals: could you enlighten me on why we need to export all lean4 fns? Intuitively, it seems we only need to export a few for repl, type checker, lsp, ...</p>\n<p>Thanks!</p>",
        "id": 560725799,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764317436
    },
    {
        "content": "<p>Well, a Lean program can do <code>import Lean</code> and then it has access to literally the entire Lean codebase, so all of that needs to be available.</p>\n<p>But like I said, this problem isn't insurmountable. It's just not that high on the priority list.</p>",
        "id": 560727060,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764317967
    },
    {
        "content": "<p>A naive solution would be to only export the necessary symbols, right? Do you have links at hand to prior discussion on those limitations? If not, I'll find it myself. I might spend a weekend playing around with this.</p>",
        "id": 560727522,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1764318164
    },
    {
        "content": "<p>Again, this is due to my lack of understanding of Lean internals/fundamentals:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"260921\">Markus Himmel</span> <a href=\"#narrow/channel/113488-general/topic/what.20is.20lean.2Ejs/near/560727060\">said</a>:</p>\n<blockquote>\n<p>Well, a Lean program can do <code>import Lean</code> and then it has access to literally the entire Lean codebase, so all of that needs to be available.</p>\n<p>But like I said, this problem isn't insurmountable. It's just not that high on the priority list.</p>\n</blockquote>\n<p>My understanding is that <code>import Lean</code> needs to expose those symbols to the <strong>Lean REPL/Editor</strong>. It is not clear to me why this implies the same symbols need to be exposed to the Wasm/JS FFI Boundary.</p>\n<p>My current mental model (which is probably wrong -- and I would appreciate knowing where I'm wrong) would be this analogy: Suppose we wanted to get Emacs + ELisp to run in Chrome/wasm32:</p>\n<ol>\n<li>We need to export a few emacs/elisp fns to Wasm/JS boundary.</li>\n<li>We do <strong>not</strong> need to expose every elisp fn to to the Wasm/JS boundary.</li>\n<li>And being able to call a elisp fn inside a scratch buffer does <strong>NOT</strong> imply we can also call the elisp fn directly from js.</li>\n</ol>\n<p>My (current) mental model is that this argument would also apply to the <code>import Lean</code> case above: being able to refer to a theorem / fun / def in the Lean editor/repl does <strong>NOT</strong> imply that we need to expose it to the wasm/js FFI boundary.</p>\n<p>Could you let me know where I'm wrong (or point me at the docs I can read up on this) -- it's clear I'm misunderstanding something about the way Lean Editor/Repl &lt;-&gt; wasm32 interaction works, but it's not clear to me where my understanding is.</p>\n<p>Thanks!</p>",
        "id": 560728578,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764318550
    },
    {
        "content": "<p>I guess I was thinking about what would happen if you <code>#eval</code> something, i.e., how the interpreter finds the native implementation of a function defined in core. But the truth is that I don't know the details of how this works, both on the \"traditional\" platforms and on WebAssembly, so it's very possible that there isn't any problem.</p>\n<p>It would definitely be great to see a working build of a recent Lean that doesn't need the export_all.</p>",
        "id": 560731735,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764319512
    },
    {
        "content": "<p>The interpreter will use exported symbols to jump into native code. It doesn't <em>need</em> an exported symbol for every single Lean function if you don't call it or can live with the interpretation overhead, but now you're in the business of designing a new heuristic for what to export to it and what not.</p>",
        "id": 560731953,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764319584
    },
    {
        "content": "<blockquote>\n<p>The interpreter will use exported symbols to jump into native code.</p>\n</blockquote>\n<p>I'm clearly misunderstanding something here. Let's see what I'm doing wrong. So my background is that I have a Rust/wasm32 app running in Chrome. It's about 100k loc of Rust, and I think I expose a total of 2 functions. func1 = after wasm is loaded, it calls an init fn; func2 = sometimes from the JS dev console, I want to send the Rust code a msg. Literally 2 functions exposed from wasm to JS. (No exposed fns for keyboard/mouse/postmessage callbacks; Rust creates an anon closure on the fly and registers it with JS land).</p>\n<p>So now let's talk about something like <a href=\"https://live.lean-lang.org/\">https://live.lean-lang.org/</a> . Right now, it has a websocket to some x86_64 server running \"lake serve <em>bunch of options</em>\" from <a href=\"https://github.com/leanprover-community/lean4web/blob/main/server/bubblewrap.sh#L45\">https://github.com/leanprover-community/lean4web/blob/main/server/bubblewrap.sh#L45</a></p>\n<p>Now, let's imagine an alternative world, where instead of</p>\n<ol>\n<li>\"lean4web client\" &lt;-&gt; websocket &lt;-&gt; \"x86_64 server: lake serve\", we did</li>\n<li>\"lean4web client\" &lt;-&gt; postmessage &lt;-&gt; \"chrome webweworker: lean4/wasm\" ; post msg here referring to <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\">https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage</a></li>\n</ol>\n<p>Intuitively to me, it seems the \"lean4/wasm in Chrome webworker\" needs to expose the same number of fns as the \"x86_64 server: lake serve\" -- i.e. a single fn for processing window.postMessage instead of websocket msgs.</p>\n<p>Now, clearly, I'm misunderstanding something. What am I getting wrong? :-)</p>",
        "id": 560735379,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764320551
    },
    {
        "content": "<p>In short, ignoring lots of low level details:</p>\n<p>Naively, if we tried</p>\n<ol>\n<li>started with \"lake serve --\"</li>\n<li>replaced websocket w/ handling window.postmessage</li>\n<li>only exposed the fn for handling window.postmessage</li>\n<li>what breaks down?</li>\n</ol>\n<p>Context: I just realized. I never stated my XY problem. I'm trying to build something in Rust + <a href=\"http://egui.rs\">http://egui.rs</a> (running in Chrome) that talks to lean4 (running in a Chrome webworker), as a potential alternative to the standard lean4web client UI.</p>",
        "id": 560736094,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764320753
    },
    {
        "content": "<p>My guess is that we need to export the functions via webassembly, because this happens to export them in a way that emscripten's implementation of <code>dlsym</code> (which the Lean interpreter uses) can load</p>",
        "id": 561554389,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1764730128
    },
    {
        "content": "<p>As far as I can tell 10000 symbols was an old chrome limitation, but perhaps the bottleneck is somewhere else, or <span class=\"user-mention silent\" data-user-id=\"260921\">Markus Himmel</span> elided a zero</p>",
        "id": 561554462,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1764730206
    },
    {
        "content": "<p>I repeated \"10k\" somewhere up there. Turns out, the limit appears to be 100k: (unless bottleneck elsewhere).</p>\n<p><a href=\"https://www.w3.org/TR/wasm-js-api-1/#:~:text=The%20maximum%20number%20of%20exports%20declared%20in%20a%20module%20is%20100000\">https://www.w3.org/TR/wasm-js-api-1/#:~:text=The%20maximum%20number%20of%20exports%20declared%20in%20a%20module%20is%20100000</a>.</p>",
        "id": 561557673,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764733204
    },
    {
        "content": "<p>AFAICT Chrome's limit is 1M exports, and it was never 10k<br>\n<a href=\"https://chromium.googlesource.com/v8/v8/+/fd3b8616dbc6115c8e0536d5adbeb2c8863c8bca/src/wasm/wasm-limits.h#33\">https://chromium.googlesource.com/v8/v8/+/fd3b8616dbc6115c8e0536d5adbeb2c8863c8bca/src/wasm/wasm-limits.h#33</a></p>",
        "id": 561560762,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764735763
    },
    {
        "content": "<p>Sorry, that was a typo on my end. It's 100k. Here is an excerpt from one of the error messages we observed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1070</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanruntest_ac_rfl</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">..........***</span><span class=\"n\">Failed</span><span class=\"w\">    </span><span class=\"mf\">1.95</span><span class=\"w\"> </span><span class=\"n\">sec</span>\n<span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">asynchronously</span><span class=\"w\"> </span><span class=\"n\">prepare</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CompileError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"bp\">.</span><span class=\"n\">instantiate</span><span class=\"o\">():</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100019</span><span class=\"w\"> </span><span class=\"n\">exceeds</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"bp\">@+</span><span class=\"mi\">279585</span>\n<span class=\"n\">Aborted</span><span class=\"o\">(</span><span class=\"n\">CompileError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"bp\">.</span><span class=\"n\">instantiate</span><span class=\"o\">():</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100019</span><span class=\"w\"> </span><span class=\"n\">exceeds</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"bp\">@+</span><span class=\"mi\">279585</span><span class=\"o\">)</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/</span><span class=\"n\">work</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">stage1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 561574916,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764745681
    },
    {
        "content": "<p>This shows my utter lack of emscriptsen knowledge (though I've done quite a bit of Rust + wasm32; involving webworkers + postmessage).</p>\n<p>Why can't we stuff <code>lake serve --</code> in a webworker, have it use window.postMessage instead of tcp/websockets, and thus on the wasm side, only have to \"expose 1 function\" ?</p>\n<p>I apologize for my ignorance here -- why do we need to expose 100k fns? (I think the previous argument was \"so the repl can make fn calls\"); but if we just stuff all of <code>lake serve --</code> as a single binary blob, it seems if we change the tcp/websocket to use postmessage (and run in a separate webworker), JS would not need to have access to all 100k exported fns.</p>",
        "id": 561579505,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764747811
    },
    {
        "content": "<p>PS: I'm not in anyway suggesting the above is easy. I'm trying to debug my ignorance of why we need to export 100k fns, instead of just the fn <code>lake serve --</code> needs to support its tcp/websocket. Naively, this <code>lake serve --</code> network protocol seems like the perfect place to draw the wasm/js ffi boundary (for the sake of having a web lean4 repl).</p>",
        "id": 561580029,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764748045
    },
    {
        "content": "<p>A lean server process can be coerced to call any of those 100k+ functions through <code>#eval</code> so they need to be exposed</p>",
        "id": 561584926,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1764749976
    },
    {
        "content": "<p>To spell it out a bit more: the problem isn't at the boundary between <code>lake serve</code> and the repl, the problem is what <code>lake serve</code> needs to do to answer the requests it receives from the repl. <code>lake serve</code> needs to be able to execute arbitrary Lean programs, which may call arbitrary library functions.</p>",
        "id": 561585434,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764750177
    },
    {
        "content": "<p>Clearly I am misunderstanding something very fundamental/basic, but I still don't understand this.</p>\n<ol>\n<li>\n<p>I have Rust projects that are 100,000+ loc, running wasm32. I only need to expose &lt; 10 Rust fns to js. Rust fns calling rust fns do not require them to be exposed to js.</p>\n</li>\n<li>\n<p>I can embed Python (<a href=\"https://crates.io/crates/rustpython\">https://crates.io/crates/rustpython</a>) or lua (<a href=\"https://crates.io/crates/piccolo\">https://crates.io/crates/piccolo</a>) interpreter in them -- and again, I only need to expose a websocket/postMessage</p>\n</li>\n<li>\n<p>I feel like I'm missing something very very basic here. Why is it, for a Lean4 repl, it does not suffice to just expose a bidirectional json msg port of sorts? Why is it that these Lean4 fns must be exposed from wasm to JS ?</p>\n</li>\n</ol>\n<p>Again, I'm sorry for such a stupid question. I feel like I'm misunderstanding something very very basic here. I don't understand why \"lean repl needs to be able to call X\" implies \"X has to be exposed from wasm to js\".</p>",
        "id": 561587576,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764750965
    },
    {
        "content": "<p>The special thing about Lean is that is has this slightly unique model where it is both a compiled and an interpreted language. When you send <code>#eval someFunction</code> to the Lean server it calls the interpreter on <code>someFunction</code>. The interpreter will check if it finds a compiled version of <code>someFunction</code>. If it finds it, it will jump into that native code. Otherwise, it will interpret <code>someFunction</code>, which in turn might call more functions, for which it will then again do the same thing of first looking for a compiled version and otherwise interpreting.</p>\n<p>The \"using the native version if available\" step is the problem. It will only work if the native code is available as an exported symbol.</p>",
        "id": 561588740,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764751409
    },
    {
        "content": "<ol>\n<li>\n<p>I was definitely ignorant of this dual compiled-code/interpreter structure. Thank you for clarifying that. Is there documentation I can read up on this ?</p>\n</li>\n<li>\n<p>On x86_64 Desktop, when I am editing in VSCode, is the Lean4 server doing dynamic code generation? Either via JIT or building a .so and doing dlopen?</p>\n</li>\n<li>\n<p>To the best of my knowledge (which is not very strongly held beliefs), wasm neither (1) supports JIT nor (2) supports dlopen. AFAIK, wasm blobs communicate via postmessage or sharedarraybuffer. Does this mean that technically, for the wasm build, we know, <strong>at compile time</strong> which fns have \"native version\", and which fns not? So <strong>in very wild theory hypothetical world</strong> for wasm32 builds, we could just hard code the jumps at compile time, and not have to export the fns. If this is true, is it also the case we're not doing this because it would heavily complicate / almost \"fork\" parts of the codebase, as the x86_64 and wasm32 would behave very differently for building/linking/calling fns?</p>\n</li>\n<li>\n<p>Purely out of curiosity, if we just went \"all interpreter, no native code\" how bad would the performance hit be? (10x? 100x?) I think the most common \"lean4 in Chrome\" use case is a basic editor + some toy problems (probably not even loading up all of Mathlib) for educational / demo purposes.</p>\n</li>\n</ol>\n<p>Thank you for taking your time to clear up my incorrect assumptions. I appreciate it. :-)</p>",
        "id": 561591341,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764752297
    },
    {
        "content": "<p>I'm not aware of any documentation beyond the module doc at <a href=\"https://github.com/leanprover/lean4/blob/0173444d24df9253d7947cfe82519e4a6caffd3a/src/library/ir_interpreter.cpp#L7\">https://github.com/leanprover/lean4/blob/0173444d24df9253d7947cfe82519e4a6caffd3a/src/library/ir_interpreter.cpp#L7</a>.</p>",
        "id": 561594090,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1764753156
    },
    {
        "content": "<blockquote>\n<p>Purely out of curiosity, if we just went \"all interpreter, no native code\" how bad would the performance hit be? (10x? 100x?) I think the most common \"lean4 in Chrome\" use case is a basic editor + some toy problems (probably not even loading up all of Mathlib) for educational / demo purposes.</p>\n</blockquote>\n<p>usually 10x</p>",
        "id": 561597707,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1764754284
    },
    {
        "content": "<p>Different question (but perhaps it hits same limitation).</p>\n<p>Instead of compiling the LeanREPL into wasm32, I have a program written in Lean (say InsertSort), and I want to compile this lean program to wasm32. Is this possible, or would this also hit the 100k export limit?</p>\n<p>My intuition is:</p>\n<ol>\n<li>lean will emit InsertSort.c</li>\n<li>we need to use emscriptsen and somehow link vs (1) Lean cpp runtime and (2) libraries the cpp runtime depends on (big number libraries + ...)</li>\n</ol>\n<p>Is there a tutorial for doing this somewhere? I want to do:<br>\ninput: InsertSort.lean<br>\noutput: some wasm module I can run in Chrome32 and call via JS</p>\n<p>Thanks!</p>\n<p>PS: If bundling lean runtime itself does not hit 100k limit, what hits the 100k limit in the LeanREPL case? Something like MathLib or something else ?</p>",
        "id": 561926381,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764866345
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260921\">Markus Himmel</span> <a href=\"#narrow/channel/113488-general/topic/what.20is.20lean.2Ejs/near/561574916\">said</a>:</p>\n<blockquote>\n<p>Sorry, that was a typo on my end. It's 100k. Here is an excerpt from one of the error messages we observed:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1070</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanruntest_ac_rfl</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">..........***</span><span class=\"n\">Failed</span><span class=\"w\">    </span><span class=\"mf\">1.95</span><span class=\"w\"> </span><span class=\"n\">sec</span>\n<span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">asynchronously</span><span class=\"w\"> </span><span class=\"n\">prepare</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CompileError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"bp\">.</span><span class=\"n\">instantiate</span><span class=\"o\">():</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100019</span><span class=\"w\"> </span><span class=\"n\">exceeds</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"bp\">@+</span><span class=\"mi\">279585</span>\n<span class=\"n\">Aborted</span><span class=\"o\">(</span><span class=\"n\">CompileError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"bp\">.</span><span class=\"n\">instantiate</span><span class=\"o\">():</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100019</span><span class=\"w\"> </span><span class=\"n\">exceeds</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"> </span><span class=\"bp\">@+</span><span class=\"mi\">279585</span><span class=\"o\">)</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">runner</span><span class=\"bp\">/</span><span class=\"n\">work</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">stage1</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Well in that case it was 100k previously, and a year ago it was bumped up to 1M<br>\n<a href=\"https://chromium.googlesource.com/v8/v8/+/285bfe195f7918f623ee6d0f138774ec003f2262%5E%21/#F0\">https://chromium.googlesource.com/v8/v8/+/285bfe195f7918f623ee6d0f138774ec003f2262%5E%21/#F0</a></p>\n<p>Does that mean wasm Lean is viable right now? (at least until Lean bypasses that increased limit)</p>",
        "id": 561987508,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764888257
    },
    {
        "content": "<p>A bit of forensics:</p>\n<p><a href=\"https://github.com/leanprover/lean4/pull/6424\">Here's the PR that disabled wasm</a>, changes first appeared on <code>[v4.16.0-rc1](https://github.com/leanprover/lean4/releases/tag/v4.16.0-rc1)</code></p>\n<p>The title is \"chore: temporarily disable Web Assembly build in CI\", but no description on the reason why it was done.</p>\n<p>I searched for a related CI failure (~same date as the PR above) and could find one that showed the \"Web Assembly\" step failing, <a href=\"https://github.com/leanprover/lean4/actions/runs/12427085269/job/34696418466\">but unfortunately the logs have expired.</a>, so I cannot tell exactly what went wrong.</p>\n<p><a href=\"/user_uploads/3121/8TZ2ONuygoNlu8CGgXjcbOWR/web-assembly-failure.png\">web-assembly-failure.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/8TZ2ONuygoNlu8CGgXjcbOWR/web-assembly-failure.png\" title=\"web-assembly-failure.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"3112x1896\" src=\"/user_uploads/thumbnail/3121/8TZ2ONuygoNlu8CGgXjcbOWR/web-assembly-failure.png/840x560.webp\"></a></div><p>The way to go here is probably to reinstate it in the CI and see what breaks in the PR's actions, and go from there.</p>",
        "id": 565442217,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1766754824
    },
    {
        "content": "<p>I could not verify, but others have claimed (and I believe them); at 4.15, the number of wasm exports exceeds 100k, which breaks something in wasm-ld.</p>\n<p>Are you able to run this build locally and get the wasm error? (I tried and could not. Still not sure if it is possible to replicate the CI process locally.)</p>",
        "id": 565443390,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1766755927
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001511\">@TongKe Xue</span> Apparently the limit was bumped from 100k to 1M (<a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/what.20is.20lean.2Ejs/near/561987508\">#general &gt; what is lean.js @ üí¨</a> )</p>\n<p>I'll try to reinstate the Web Assembly build first through the CI and see if I can replicate the error.<br>\nThis was the way wasm builds were built before, so I believe this is the shortest path to a solution (when compared with the ad-hoc builds from the emscripten.md file, which seems more obscure)</p>",
        "id": 565444843,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1766757197
    },
    {
        "content": "<ol>\n<li>I wish you the best. If I can be of help, let me know.</li>\n<li>I agree that \"ad-hoc builds from emscripten.md file\" is not the way to go. I was trying it here: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/reproducing.20lean4.20wasm32.20build.20of.20100k.20export.20error/with/562071134\">#general &gt; reproducing lean4 wasm32 build of 100k export error</a>  In private conversations, I pushed it to the part where it fails because it tries to link vs a 64-bit-gcc instead of 32-bit-gcc (the goal was: do a 32-bit x86 stage0; then use that for a 32-bit wasm stage 0). This is about where I gave up and decided to take a step back.</li>\n</ol>\n<p>If I were to try this again, I'd try to \"replicate CI environment locally\" -- so I think you're 100% on the right track. Good luck!</p>",
        "id": 565449786,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1766761266
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001511\">@TongKe Xue</span> update: I forked the project and debugged a lot, and finally managed to have successful build. </p>\n<p>The issue here is that the build is 602MB <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>, while the latest wasm build from 4.15.0 was 190MB.<br>\nI ended up disabling <code>-flto</code> (<a href=\"https://emscripten.org/docs/optimizing/Optimizing-Code.html#lto\">docs</a>) because the CI was terminating after 52 mins (RAM usage exceeding CI runner is likely the cause).</p>\n<p><a href=\"https://github.com/cauli/lean4/pull/1\">Here's the PR to my own forked repo (work in progress)</a><br>\n<a href=\"https://github.com/cauli/lean4/actions/runs/20604434866/job/59177037670?pr=1\">Here's the successful CI run</a><br>\n<a href=\"https://github.com/cauli/lean4/actions/runs/20604434866/artifacts/4993876983\">Here's the WASM build artifact (I haven't tested yet)</a></p>\n<p>I haven't hit the \"exports limit error\" during this build.</p>\n<p>Next steps:</p>\n<ul>\n<li>try this wasm build in a web project, to see if it can run in the browser</li>\n<li>try to reduce build size to the ~190 MB we had before</li>\n<li>submit the PR for review</li>\n</ul>",
        "id": 565832760,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767128174
    },
    {
        "content": "<p>The size of Lean code in core has tripled since that version so this build size increase does not really come as a surprise.</p>",
        "id": 565834375,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1767129279
    },
    {
        "content": "<p>Okay, I \"vibe-coded\" a throaway React app to run the WASM directly in the browser, the wasm files are actually 137MB + 89.5 MB.</p>\n<p>And it errored with <code>The Lean command-line driver can only run under Node.js. For the embeddable WASM library, see lean_wasm.cpp</code> (<a href=\"https://github.com/leanprover/lean4/blob/16ae74e98e33d3c672491229cab3dda6e67ec6c3/src/util/shell.cpp#L289\">source</a>)</p>\n<p>But the file <code>lean_wasm.cpp</code> doesn't seem to exist anymore, possibly Lean 3 era stuff. I would have to do some archeology to understand if a browser-embeddable version is viable.</p>\n<p>New info (for myself): The previous WASM builds were only targeting Node.js</p>",
        "id": 565834923,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767129711
    },
    {
        "content": "<p>I'm adapting the shell to use <code>NODEFS</code> for Node.js and Emscriptens <code>[MEMFS](https://emscripten.org/docs/porting/files/file_systems_overview.html#emscripten-file-system-architecture)</code> for browsers. This might work, and we won't need to build target.</p>\n<p>We'll probably need to lazy-load the .olean files as they are required, because the full lib is huge (244MB for all .olean files).</p>\n<p>A proof of concept could preload everything <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>, 137MB+89MB+244MB = ~470MB</p>\n<p>I'm doing all of this without input from the contributors of the main repo, but at this point it's mostly just curiosity.</p>",
        "id": 565837158,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767131712
    },
    {
        "content": "<p>Yeah, and with node.js you get</p>\n<blockquote>\n<p>failed to asynchronously prepare wasm: CompileError: WebAssembly.instantiate(): exports count of 201107 exceeds internal limit of 100000 @+226760</p>\n</blockquote>\n<p>So yes, the export count is a problem.</p>",
        "id": 565837420,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767131975
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> </p>\n<p>Node.js uses the <a href=\"https://nodejs.org/en/learn/getting-started/the-v8-javascript-engine\">v8 engine</a>, <a href=\"https://chromium-review.googlesource.com/c/v8/v8/+/6085575\">which was patched to increase the limit from 100K to 1M exports</a> end of 2024,  so I expect this problem to be gone in newer versions of Node </p>\n<p>(I need to match the versions of V8 &lt;&gt; Node.JS to see if it has already been released)</p>",
        "id": 565838065,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767132592
    },
    {
        "content": "<p>The change to v8 landed on v8-version <a href=\"https://github.com/v8/v8/releases/tag/14.5.75870136\">14.5.75870136</a> (<a href=\"https://github.com/v8/v8/commit/285bfe195f7918f623ee6d0f138774ec003f2262\">commit ref</a>)</p>\n<p><del>To check your node's v8 version you can run <code>node -p process.versions.v8</code></del><br>\n<del>Mine returns <code>12.9.202.28-node.14</code> (which doesn't have the fix, because I'm on node 14)</del><br>\nEDIT: the tags from <code>node -p process.versions.v8</code> do not necessarily match the v8 git ones</p>",
        "id": 565838429,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767132994
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001429\">@Cauli Ziani</span> : This looks really exciting. Let me know if (1) you get stuck or (2) you got it working end to end. It seems like you have strong momentum and it would be a distraction if I tried to jump in right now.</p>\n<p>Looking forward to see where you push this. Having Lean4 run in Chrome would be awesome!</p>",
        "id": 565839541,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1767134178
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001429\">@Cauli Ziani</span> I tested your wasm build artifact from Jan 4 with Node.js v25.2.1 (V8 14.1) and the wasm loads successfully. No more \"exports count exceeds internal limit\" error. </p>\n<p>However, I hit a filesystem issue on macOS. The EM_ASM block mounts <code>/home</code> and <code>/tmp</code>, then calls <code>FS.chdir(process.cwd())</code>. On macOS:</p>\n<ul>\n<li><code>/tmp</code> is a symlink to <code>/private/tmp</code>, so <code>process.cwd()</code> returns <code>/private/tmp/...</code></li>\n<li><code>/home</code> is empty (macOS uses <code>/Users</code> for home directories)</li>\n</ul>\n<p>I patched <code>lean.js</code> to add these mounts after the existing ones:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"k\">try</span><span class=\"p\">{</span><span class=\"nx\">FS</span><span class=\"p\">.</span><span class=\"nx\">mkdir</span><span class=\"p\">(</span><span class=\"s2\">\"/Users\"</span><span class=\"p\">);</span><span class=\"nx\">FS</span><span class=\"p\">.</span><span class=\"nx\">mount</span><span class=\"p\">(</span><span class=\"nx\">NODEFS</span><span class=\"p\">,{</span><span class=\"nx\">root</span><span class=\"o\">:</span><span class=\"s2\">\"/Users\"</span><span class=\"p\">},</span><span class=\"s2\">\"/Users\"</span><span class=\"p\">);}</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">){}</span>\n<span class=\"k\">try</span><span class=\"p\">{</span><span class=\"nx\">FS</span><span class=\"p\">.</span><span class=\"nx\">mkdir</span><span class=\"p\">(</span><span class=\"s2\">\"/private\"</span><span class=\"p\">);</span><span class=\"nx\">FS</span><span class=\"p\">.</span><span class=\"nx\">mkdir</span><span class=\"p\">(</span><span class=\"s2\">\"/private/tmp\"</span><span class=\"p\">);</span><span class=\"nx\">FS</span><span class=\"p\">.</span><span class=\"nx\">mount</span><span class=\"p\">(</span><span class=\"nx\">NODEFS</span><span class=\"p\">,{</span><span class=\"nx\">root</span><span class=\"o\">:</span><span class=\"s2\">\"/private/tmp\"</span><span class=\"p\">},</span><span class=\"s2\">\"/private/tmp\"</span><span class=\"p\">);}</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">){}</span>\n</code></pre></div>\n<p>With this fix, initialization gets further but crashes during <code>initialize_Lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">INIT</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">initialize_Std</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">done</span>\n<span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">INIT</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">About</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">initialize_Lean</span><span class=\"bp\">...</span>\n<span class=\"n\">RuntimeError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unreachable</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"bp\">-</span><span class=\"n\">function</span><span class=\"o\">[</span><span class=\"mi\">140491</span><span class=\"o\">]:</span><span class=\"mi\">0</span><span class=\"n\">x80d5f2d</span>\n</code></pre></div>",
        "id": 566266914,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767579902
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> thanks for testing, Kim! </p>\n<p>I am still debugging those \"unreachable\", I'm running on Chrome and can run commands like <code>--version</code> and <code>--help</code>.</p>\n<p>In what environment are you running the wasm? </p>\n<p>In my build, I'm trying to add support for browsers, and it uses <code>process.release.name</code> (node on node, undefined on browsers) and routes to the appropriate FS (NODEFS, MEMFS).</p>\n<p>If I try to compile some lean code (<code>lean --json /workspace/input.lean</code>), I get the same error as you.<br>\nHowever, if I \"warm up\" the binary by calling <code>lean --version</code> and then <code>lean --json /workspace/input.lean</code>, I get a bit further for some reason:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">initSearchPathInternal</span><span class=\"w\"> </span><span class=\"n\">called</span>\n<span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">initSearchPath</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanSysroot</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">initSearchPath</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">final</span><span class=\"w\"> </span><span class=\"n\">searchPath</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"o\">]</span>\n<span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">bounds</span>\n<span class=\"bp\">...</span>\n<span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Input</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"n\">bytes</span>\n<span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Input</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">content</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">run_shell_main</span><span class=\"w\"> </span><span class=\"n\">entered</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">building</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"n\">list</span>\n<span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DEBUG</span><span class=\"o\">:</span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Args</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">built</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">calling</span><span class=\"w\"> </span><span class=\"n\">lean_shell_main</span><span class=\"bp\">...</span>\n<span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">302</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">threw</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RuntimeError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">bounds</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x80e50da</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x80cebc6</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14de008</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14dec7e</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14ddf21</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Object</span><span class=\"bp\">.</span><span class=\"n\">ccall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">303458</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">runMain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"o\">:</span><span class=\"mi\">27</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">299</span><span class=\"o\">:</span><span class=\"mi\">33</span>\n<span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">308</span><span class=\"w\"> </span><span class=\"bp\">‚ùå</span><span class=\"w\"> </span><span class=\"n\">Unexpected</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RuntimeError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">bounds</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x80e50da</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x80cebc6</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14de008</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14dec7e</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">wasm</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"n\">x14ddf21</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Object</span><span class=\"bp\">.</span><span class=\"n\">ccall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">303458</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">runMain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"o\">:</span><span class=\"mi\">27</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">worker</span><span class=\"bp\">-</span><span class=\"n\">simple</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"o\">:</span><span class=\"mi\">299</span><span class=\"o\">:</span><span class=\"mi\">33</span>\n</code></pre></div>\n<p>The wasm errors are completely opaque (lean.wasm:0x80e50da), so it's a bit difficult to debug. <br>\nThe build takes 55min so I'm slowly and persistently iterating, adding more and more logs and  <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>\n<p>I'll upload my \"AI-slop demo\" to a github repo, it's definitely code that I'm not proud of but just so that we have a common ground. I'll even push the binaries from 4 Jan along with the .olean files</p>",
        "id": 566293709,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767600418
    },
    {
        "content": "<p>Here's the repo: <a href=\"https://github.com/cauli/lean4-wasm-in-browser\">https://github.com/cauli/lean4-wasm-in-browser</a> <br>\nIt's a React application, so you'll need to <code>npm i</code> <code>npm run dev</code> </p>\n<p>And to run it you also need to extract some files from the latest CI artifact from my fork (<a href=\"https://github.com/cauli/lean4/actions/workflows/ci.yml\">https://github.com/cauli/lean4/actions/workflows/ci.yml</a>) into the /public folder.  <br>\nIntroduction are up-to-date in the README</p>",
        "id": 566298026,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767601956
    },
    {
        "content": "<p>Demo looks like this (screenshot has call to <code>--help</code>)<br>\n<a href=\"/user_uploads/3121/0pa3q4mZIedSc7YJPfIuRcsn/demo.png\">demo.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/0pa3q4mZIedSc7YJPfIuRcsn/demo.png\" title=\"demo.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2706x1782\" src=\"/user_uploads/thumbnail/3121/0pa3q4mZIedSc7YJPfIuRcsn/demo.png/840x560.webp\"></a></div>",
        "id": 566298628,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1767602178
    },
    {
        "content": "<p>Managed to compile a program running wasm locally/browser, I'll take the win but everything is extremely slow and full of things to optimize:</p>\n<ul>\n<li>I had to disable <code>#eval</code> on wasm due to the size of the <code>.ir</code> files</li>\n<li>The process of loading the libraries into the WASM MEMFS and initiating it is so slow, and I'm loading locally 6000+ .oleans</li>\n<li>I am struggling to re-run the command on the same wasm module, so the slow-as-hell instantiation has to happen every time</li>\n<li>This probably only works on Chrome due to memory limits <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></li>\n</ul>\n<p><a href=\"/user_uploads/3121/Dg9hGKnO8DKq0SmyE54CEN3S/s.png\">s.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Dg9hGKnO8DKq0SmyE54CEN3S/s.png\" title=\"s.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"3002x1114\" src=\"/user_uploads/thumbnail/3121/Dg9hGKnO8DKq0SmyE54CEN3S/s.png/840x560.webp\"></a></div><p>All in all, a huge pain, but I might be able to optimize this further (reuse wasm, load only necessary libs, .tar.gz the necessary .oleans)</p>",
        "id": 567655617,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1768257511
    },
    {
        "content": "<p>If you fancy trying:</p>\n<ol>\n<li>clone <a href=\"https://github.com/cauli/lean4-wasm-in-browser\">https://github.com/cauli/lean4-wasm-in-browser</a> (mostly me hitting Opus 4.5 with a stick), npm i</li>\n<li>Download the latest wasm build from my lean4 fork (CI action):  <a href=\"https://github.com/cauli/lean4/actions/runs/20930232165/artifacts/5102608389\">https://github.com/cauli/lean4/actions/runs/20930232165/artifacts/5102608389</a></li>\n<li>Place <code>build-Web Assembly.zip</code> in /public/lean-wasm/</li>\n<li>run <code>bash ./script/create-lean-lib.sh</code>  (you might need zstd installed)</li>\n<li>npm run dev -&gt; <a href=\"https://localhost:5173/\">https://localhost:5173/</a> (it will load 6000 files one by one, 1GB, so I don't recommend putting that online just yet <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span>)</li>\n</ol>",
        "id": 567656344,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1768257968
    },
    {
        "content": "<blockquote>\n<p>clone¬†<a href=\"https://github.com/cauli/lean4-wasm-in-browser\">https://github.com/cauli/lean4-wasm-in-browser</a>¬†(mostly me hitting Opus 4.5 with a stick)</p>\n</blockquote>\n<p>Reminds me of this GBS quote: \"The reasonable man adapts himself to the world: the unreasonable one persists in trying to adapt the world to himself. Therefore all progress depends on the unreasonable man.\"</p>\n<p>As someone who gave up on reviving lean-on-wasm4; just wanted to say thanks for persisting when others (like myself) gave up. Cheers</p>",
        "id": 567656829,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1768258267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001511\">@TongKe Xue</span> thanks! But don't get tooo optimistic, it's unusable right now. But it's a start. If we manage to reuse the instantiated <code>wasm</code>, this will get much better</p>\n<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> the \"unreachable\" issues were due to function interfaces not matching! wasm is stricter about this (more than C++), the warnings we got in the build pipeline should actually be treated as errors . When wasm hit those function calls, it crashed.</p>",
        "id": 567657337,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1768258613
    },
    {
        "content": "<p>Maybe we just have to run this in --server mode, but in the browser? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 567658694,
        "sender_full_name": "Cauli Ziani",
        "timestamp": 1768259413
    },
    {
        "content": "<p>Hi any progress on this?</p>",
        "id": 574700596,
        "sender_full_name": "Marvin",
        "timestamp": 1771499119
    },
    {
        "content": "<p>What is the latest version of lean you have tested this on?</p>",
        "id": 574700659,
        "sender_full_name": "Marvin",
        "timestamp": 1771499137
    }
]