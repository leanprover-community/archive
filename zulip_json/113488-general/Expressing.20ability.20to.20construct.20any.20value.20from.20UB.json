[
    {
        "content": "<p>I am working on a project to formalise certain rewrite rules in an the integer subset of the LLVM IR, with poison to model UB. In the LLVM LangRef <a href=\"https://llvm.org/docs/LangRef.html#poison-values\">#poison-values</a>, it states that you can replace a possible poison value with any value for that type, even a different value in each different case. I am confused on how I would express this though, as I currently have (this is a minimal working example):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">LLVM-style integers with poison value.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">bits</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">poison</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">bits</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">poison</span><span class=\"w\"> </span><span class=\"n\">bitvec</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"bp\">.</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"o\">)</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Cases</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cases</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cases</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">poison</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">forge12</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>What could I possibly do here?</p>",
        "id": 538353894,
        "sender_full_name": "l1mey",
        "timestamp": 1757396076
    },
    {
        "content": "<p>Is this maybe related to <span class=\"user-mention\" data-user-id=\"122318\">@Tobias Grosser</span> 's LeanMLIR work? <span class=\"user-mention\" data-user-id=\"481133\">@Alex Keizer</span> might be able to help</p>",
        "id": 538358892,
        "sender_full_name": "William Sørensen",
        "timestamp": 1757399003
    },
    {
        "content": "<p>Not particularly related, just my own small project. I solved the problem though, I was thinking of rewrites completely wrong. A rewrite from <code>x</code> to <code>y</code> isn't an equivalence relation, it's more like a preorder. So you can have <code>poision ~&gt; 12</code>, but you can't coerce <code>12 ~&gt; poison</code>. Example below:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">`Refines x y` means the value `x` can be refined into the concrete value `y`.</span>\n<span class=\"sd\">This reads like an action: `refine x into y`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- A bitvector refines to itself. -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bv_refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Poison can be refined into any bitvector. -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">poison_forge</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"n\">poison</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">RefinesReversed</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">RefinesIff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">iN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">Refines</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" ~&gt; \"</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Refines</span>\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &lt;~ \"</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">RefinesReversed</span>\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &lt;~&gt; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">RefinesIff</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/3121/gCAm9lVQ9eOSZ7EQmw_7Lfj_/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/gCAm9lVQ9eOSZ7EQmw_7Lfj_/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1248x556\" src=\"/user_uploads/thumbnail/3121/gCAm9lVQ9eOSZ7EQmw_7Lfj_/image.png/840x560.webp\"></a></div>",
        "id": 538362570,
        "sender_full_name": "l1mey",
        "timestamp": 1757400880
    },
    {
        "content": "<p>Though, from here I've got a long road ahead making these definitions amenable to trivial proof.</p>",
        "id": 538362747,
        "sender_full_name": "l1mey",
        "timestamp": 1757400960
    },
    {
        "content": "<p>This is quote cool and good luck! I was planning on writing a compiler where one of the arguments for the compilation is that the source code is free of UB, meaning that if there is UB, and you have a compiled result you can just exfalso it, but i havent actually thought about that to any actual detail.</p>",
        "id": 538364935,
        "sender_full_name": "William Sørensen",
        "timestamp": 1757401834
    },
    {
        "content": "<p>but yeah would be cool to see where this project goes</p>",
        "id": 538364996,
        "sender_full_name": "William Sørensen",
        "timestamp": 1757401863
    },
    {
        "content": "<p>This definition is quite convenient. Here is a formal proof that compilers can rewrite <code>INT32_MAX + 1</code> to <code>12</code>:</p>\n<p><a href=\"/user_uploads/3121/4Gy9OSXsBlF_paBBneDhUIYh/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/4Gy9OSXsBlF_paBBneDhUIYh/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1100x420\" src=\"/user_uploads/thumbnail/3121/4Gy9OSXsBlF_paBBneDhUIYh/image.png/840x560.webp\"></a></div>",
        "id": 538371507,
        "sender_full_name": "l1mey",
        "timestamp": 1757404035
    },
    {
        "content": "<p>This is quite similar to how we model poison in LeanMLIR!</p>",
        "id": 538425753,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1757421052
    },
    {
        "content": "<p>Using this definition, I've come into issues with automated proof: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Converting.20goals.20to.20be.20bitblasted.20like.20BVDecide/with/539489812\">#general &gt; Converting goals to be bitblasted like BVDecide</a>. Maybe someone might be able to look at it?</p>",
        "id": 539491232,
        "sender_full_name": "l1mey",
        "timestamp": 1757924695
    }
]