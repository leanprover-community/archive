[
    {
        "content": "<p>I ran into a problem in Iris-Lean recently and I'm looking for a any ideas on how to structure the code better to fix it. Here is a minimized version of the problem:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyPointsTo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" ↦[\"</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\"] \"</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"c1\">-- example {γ : GName} : entails (5 ↦[γ] \"A\") := sorry</span>\n<span class=\"c1\">-- typeclass instance problem is stuck</span>\n<span class=\"c1\">--   ElemG ?m.6 F1</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Example2Hack</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span>\n\n<span class=\"c1\">-- Hack: Make typeclass synthesis infer GF and F from some piece of data present in the notation,</span>\n<span class=\"c1\">-- in this case GName.</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"bp\">.</span><span class=\"n\">checkSynthOrder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">HasPointsToF1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyPointsTo'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">HasPointsToF1</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" ↦[\"</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\"] \"</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">MyPointsTo'</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"o\">[</span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"A\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"c1\">-- No error</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Example2Hack</span>\n</code></pre></div>\n</div></div>\n<p>Basically, I want the <code>(5 ↦[γ] \"A\")</code> notation to refer to the <code>ElemG</code> and <code>Fraction</code> instances from the context, but Lean doesn't do this because <code>GF</code> and <code>F</code> are metavariables. In Rocq, the section variables for <code>GF</code> and <code>F</code> would be inserted into every definition in the section, meaning they are not metavariables, and the typeclass synthesis can proceed fine. I don't want to change my top-level notation to include <code>GF</code> and <code>F</code>. </p>\n<p>The hack I came up with above works fine for this example, but I've noticed it doesn't work so well when I need multiples of the same typeclass (in our case, <code>ElemG</code>'s). Is there a better way?</p>",
        "id": 572791287,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1770646580
    },
    {
        "content": "<p>Here's a hack:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyPointsTo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" ↦[\"</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\"] \"</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"n\">i₁</span><span class=\"w\"> </span><span class=\"n\">i₂</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"o\">[</span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"A\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"c1\">-- no more typeclass stuck problems</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n</code></pre></div>",
        "id": 572797148,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770647804
    },
    {
        "content": "<p>Now it works</p>",
        "id": 572797206,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770647815
    },
    {
        "content": "<p>Just force lean to use a specific typeclass instance (which you declare as a variable) explicitly</p>",
        "id": 572797389,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770647849
    },
    {
        "content": "<p>So one thing lean is annoying about is, inside notation, it considers <code>variable</code> declarations unhygienic. So  I temporarily disable <code>quotPrecheck</code> just for that notation, because I don't expect to get that wrong.</p>",
        "id": 572797783,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770647939
    },
    {
        "content": "<p>Ah interesting, thanks!</p>",
        "id": 572799204,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1770648202
    },
    {
        "content": "<p>another related dirty trick I use sometimes  is <code>simp [explicitInstanceName]</code> to get around these typeclass unification issues instead of <code>simp[TypeclassName.&lt;something&gt;]</code> (the <code>simp</code> is just illustrative). This is handy when there are multiple instances of the same typeclass or different typeclasses in the same hierarchy using the same notation (which happens a lot when you mix TCS and mathlib's order theory).</p>",
        "id": 572799948,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770648346
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"721721\">@Markus de Medeiros</span>  : Actually I think this specific instance of the problem has nothing to do with typeclass inference</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GFunctor</span><span class=\"o\">)</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledGFunctors</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IProp</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fraction</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">GF</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ElemG</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">))]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyPointsTo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" ↦[\"</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\"] \"</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">points_to</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">GF</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GName</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">entails</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"o\">[</span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"A\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"c1\">-- no more typeclass stuck problems</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Example2</span>\n</code></pre></div>",
        "id": 572803574,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770649059
    },
    {
        "content": "<p>It seems to be entirely a problem caused by name hygiene in <code>notation</code>. Otherwise how would inference succeed for <code>_</code> and <code>_</code> in the above example?</p>\n<p>EDIT : I think unnamed typeclass instances are being treated as metavars in the notation. Named typeclass variables are being inferred even if I only give an <code>_</code> where I want the instance. Try deleting <code>i₁ :</code> and my solution doesn't work.</p>",
        "id": 572803621,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770649070
    },
    {
        "content": "<p>I am mildly confused why adding a name to the instance matters, and would like to figure what's really happening beyond my guesswork. Time to call Batman. <br>\nCC : <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span></p>",
        "id": 572805853,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770649495
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/113488-general/topic/Section.20variables.20.2B.20typeclasses.20.2B.20notations/near/572797783\">said</a>:</p>\n<blockquote>\n<p>inside notation, it considers <code>variable</code> declarations unhygienic</p>\n</blockquote>\n<p>Which of course is exactly right in global notations. So the correct fix is to make them <code>local notation</code></p>",
        "id": 572810532,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1770650596
    },
    {
        "content": "<p>Interesting. The warning messages I have received so far suggest the <code>set_option quotPrecheck false</code> solution, so I never figured <code>local notation</code> would do the trick</p>",
        "id": 572812605,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770651002
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> : why does it make a difference whether or not I name the typeclass instance in my final example?</p>",
        "id": 572852451,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770660300
    },
    {
        "content": "<p>I don't see that on live</p>",
        "id": 572852884,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1770660406
    },
    {
        "content": "<p>I got an error when I removed the name i1</p>",
        "id": 572857233,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770661699
    },
    {
        "content": "<p>Can’t seem to get it now.</p>",
        "id": 572857547,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1770661786
    }
]