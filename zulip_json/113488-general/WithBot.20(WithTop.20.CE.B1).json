[
    {
        "content": "<p>There are two possible ways to endow a type with both a top and a bottom element: <code>WithBot (WithTop α)</code>, and <code>WithTop (WithBot α)</code>. I'd like to create a common definition <code>WithBotTop α</code> subsuming both of them. But I'm running into some quite large annoyances.</p>\n<p>My initial idea was to define this as an <code>abbrev</code>. This entirely breaks <code>to_dual</code>, unfortunately. We can set the dual of <code>WithBotTop α</code> to be itself, but then the inferred ≤ instance from <code>WithBot</code> will not be def-eq to its dual, and shenanigans ensue.</p>\n<p>If we choose to hide the definition behind a <code>def</code>, we run into the problem that the existing API on <code>WithBot</code> and <code>WithTop</code> is unusable. We'd have to re-prove these theorems from scratch. Which admittedly shouldn't be so hard, since we can use the def-eq with <code>WithBot (WithTop α)</code> to prove theorems, but then hide it from the public API.</p>\n<p>What's the correct course of action here?</p>",
        "id": 570300326,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769514916
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"690100\">@Ayhon</span> <span class=\"user-mention\" data-user-id=\"459699\">@Joël Riou</span></p>",
        "id": 570300471,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769514957
    },
    {
        "content": "<p>The open PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/33876\">#33876</a> takes a third approach, defining both <code>WithBotTop α = WithBot (WithTop α)</code> and <code>WithTopBot α = WithTop (WithBot α)</code>. This does make <code>to_dual</code> functional, but to me it seems like needless duplication; these two types should morally be the same.</p>",
        "id": 570300881,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769515085
    },
    {
        "content": "<p>Actually, here's an idea. Perhaps we could define the order isomorphisms <code>WithBotTop α ≃o WithBot (WithTop α)</code> and <code>WithBotTop α ≃o WithTop (WithBot α)</code>, and use them to transfer API in a <code>to_dual</code>-friendly manner?</p>",
        "id": 570301417,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769515251
    },
    {
        "content": "<p>Great initiative!</p>\n<p>I did something similar <a href=\"https://github.com/madvorak/duality/blob/main/Duality/ExtendedFields.lean\">https://github.com/madvorak/duality/blob/main/Duality/ExtendedFields.lean</a> but it is far from being sufficiently general for Mathlib.</p>",
        "id": 570308804,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1769517394
    },
    {
        "content": "<p>Would it be possible to change <code>to_dual</code> instead?</p>",
        "id": 570318462,
        "sender_full_name": "Ayhon",
        "timestamp": 1769520002
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570300881\">said</a>:</p>\n<blockquote>\n<p>The open PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/33876\">#33876</a> takes a third approach, defining both <code>WithBotTop α = WithBot (WithTop α)</code> and <code>WithTopBot α = WithTop (WithBot α)</code>. This does make <code>to_dual</code> functional, but to me it seems like needless duplication; these two types should morally be the same.</p>\n</blockquote>\n<p>Not exactly. My intend was <em>only</em> to introduce <code>WithBotTop</code> because <code>EReal</code> was defined in this way.</p>",
        "id": 570319891,
        "sender_full_name": "Joël Riou",
        "timestamp": 1769520422
    },
    {
        "content": "<p>An idle observation that may well not be helpful: one could imagine, instead of <code>WithBot</code> and <code>WithTop</code>, operators on α that add the bot or top <em>if they are not already present</em>.</p>",
        "id": 570749027,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769680476
    },
    {
        "content": "<p>Sure, but I'm not sure if we want that? We have legitimate uses for adding bottom/top elements to types that already have them, see e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.degree#doc\">docs#Polynomial.degree</a>.</p>",
        "id": 570763046,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769684154
    },
    {
        "content": "<p>Differentiability on manifolds takes a parameter in <code>WithTop ENat</code> :-) (infinity means infinitely-differentiable, top means analytic (i.e. has a power series, which is a stronger condition for real-valued functions).</p>",
        "id": 570772711,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769687210
    },
    {
        "content": "<p>I guess adding top and bottom elements if they don't already exist could make sense from the perspective of it being kind of like an order-theoretic closure (not sure what that would be called), but <code>WithTop</code> would probably be useful more often</p>",
        "id": 570918816,
        "sender_full_name": "Niels Voss",
        "timestamp": 1769731958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570300881\">said</a>:</p>\n<blockquote>\n<p>these two types should morally be the same.</p>\n</blockquote>\n<p>Don't they disagree on the value of bot + top?</p>",
        "id": 570921506,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769733939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570763046\">said</a>:</p>\n<blockquote>\n<p>Sure, but I'm not sure if we want that? We have legitimate uses for adding bottom/top elements to types that already have them, see e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.degree#doc\">docs#Polynomial.degree</a>.</p>\n</blockquote>\n<p>Yeah I think it has mostly only disadvantages in general.</p>",
        "id": 570961850,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769759938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570918816\">said</a>:</p>\n<blockquote>\n<p>I guess adding top and bottom elements if they don't already exist could make sense from the perspective of it being kind of like an order-theoretic closure (not sure what that would be called), but <code>WithTop</code> would probably be useful more often</p>\n</blockquote>\n<p>Yes that's what I meant really - sometimes WithTop is the top-closure but sometimes it isn't.</p>",
        "id": 570961979,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769759996
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570921506\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/570300881\">said</a>:</p>\n<blockquote>\n<p>these two types should morally be the same.</p>\n</blockquote>\n<p>Don't they disagree on the value of bot + top?</p>\n</blockquote>\n<p>Oh, yikes...</p>",
        "id": 571003137,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769772463
    },
    {
        "content": "<p>Does this mean we want both aliases to be available? Or do we just choose one and go with it?</p>",
        "id": 571003231,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1769772497
    },
    {
        "content": "<p>For <code>EReal</code>, the ship has sailed.</p>",
        "id": 571008062,
        "sender_full_name": "Joël Riou",
        "timestamp": 1769774096
    },
    {
        "content": "<p>IIRC I was responsible for EReal and there was some discussion of this issue at the time but I don't remember any compelling arguments for being careful about which order to choose.</p>",
        "id": 571009976,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769774656
    },
    {
        "content": "<p>we want <code>ENNReal.log (x * y) = ENNReal.log x + ENNReal.log y</code> to be unconditional</p>",
        "id": 571010587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769774847
    },
    {
        "content": "<p>so since <code>0 * ⊤ = 0</code> therefore <code>⊥ + ⊤ = ⊥</code></p>",
        "id": 571010709,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769774883
    },
    {
        "content": "<p>And I think <code>0 * ⊤ = 0</code> is motivated by measure theory (i.e. there really is a good reason for this choice, analysts want the integral of a function which is mostly 0 but takes the value infinity on a set with zero measure to be zero and not infinity) so this looks like a good argument for <code>⊥ + ⊤ = ⊥</code>.</p>",
        "id": 571024831,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769778857
    },
    {
        "content": "<p>I agree that <code>⊥ + ⊤ = ⊥ = ⊤ + ⊥</code> is the morally correct option.</p>",
        "id": 571031307,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1769780484
    },
    {
        "content": "<p>In fact the initial definition of EReal gave bot + top = top, and for precisely the reason given above I have refactored it some time ago (changing from WithTop (WithBot R)) to WithBot (WithTop R)).</p>",
        "id": 571031974,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1769780652
    },
    {
        "content": "<p>I can quite believe that in my original work I made a random choice; it was only this <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo>×</mo><mi mathvariant=\"normal\">∞</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">0\\times\\infty=0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">0</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord\">∞</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span> observation coming from measure theory which made me understand that sometimes there was a good answer to these junk-looking questions.</p>",
        "id": 571059103,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769786980
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/WithBot.20.28WithTop.20.CE.B1.29/near/571010587\">said</a>:</p>\n<blockquote>\n<p>we want <code>ENNReal.log (x * y) = ENNReal.log x + ENNReal.log y</code> to be unconditional</p>\n</blockquote>\n<p>Couldn't we also argue that we want <code>-(a + b) = -a + -b</code> to be unconditional?</p>",
        "id": 571093109,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769796121
    },
    {
        "content": "<p>(which would be satisfied by <code>⊥ + ⊤ = 0</code>)</p>",
        "id": 571093202,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769796145
    },
    {
        "content": "<p>I think that the conclusion is an absurd choice but it's a reasonable observation. Perhaps the difference is that (a) measure theory is giving us good conventions for ENNReal and log is a natural bijection between ENNReal and EReal but (b) Neg, whilst being a bijection from EReal to itself, is not the natural one (the natural one is id).</p>",
        "id": 571188153,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769858358
    }
]