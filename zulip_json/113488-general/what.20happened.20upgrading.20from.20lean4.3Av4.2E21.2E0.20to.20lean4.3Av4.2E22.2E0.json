[
    {
        "content": "<p>Hello, I know that, by defining my the <code>unsafe parallelFibonacci</code> I am \"driving on the dangerous fast lane\", but, in one way or another, by upgrading from  lean4:v4.21.0 to lean4:v4.22.0, my <code>#eval tasksSpawningFibonacci 24</code>, using <code>Task</code>, does not work any more. Note that in the attached video, 2^25  threads are spawned, which takes some time, but  <code>#eval tasksSpawningFibonacci 5</code>, also crashes with lean4:v4.22.0, so, I think it is not a stack size issue.</p>\n<p><a href=\"/user_uploads/3121/ZPDK92bAIRjPKRmCDXyto8rt/simplescreenrecorder-2025-09-08_22.48.30.mkv\">simplescreenrecorder-2025-09-08_22.48.30.mkv</a></p>",
        "id": 538314561,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757365334
    },
    {
        "content": "<p>Nothing in particular comes to mind, you'll have to provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>.</p>",
        "id": 538316306,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757366155
    },
    {
        "content": "<p>Henrik,</p>\n<p>uncomment the <code>#eval</code> when viewing it in the Lean playground</p>\n<p>you can also copy/paste (or download attachment) and run it locally with version 21</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Code listing</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Functional</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">asProgram</span><span class=\"o\">)</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Functorial</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenF</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Functorial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">andThenF</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &gt;-&gt; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">andThenF</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Sequential</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenP</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">andThenP</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &gt;=&gt; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">andThenP</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Creational</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">productSeq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">productSeq</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" &amp;&amp;&amp; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">productSeq</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Conditional</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sum</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"s2\">\" ||| \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bothPar</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bothPar</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" |&amp;| \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">bothPar</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">identity</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">let_</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"n\">αaβpγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">identity</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">αaβpγ</span>\n\n<span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">if_</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpb</span><span class=\"w\"> </span><span class=\"n\">t_apβ</span><span class=\"w\"> </span><span class=\"n\">f_apβ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">let_</span><span class=\"w\"> </span><span class=\"n\">αpb</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">        </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">          </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αab</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">αab</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">        </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">t_apβ</span><span class=\"w\"> </span><span class=\"bp\">|||</span><span class=\"w\"> </span><span class=\"n\">f_apβ</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dup</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">productPar</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"n\">αpγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dup</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"bp\">|&amp;|</span><span class=\"w\"> </span><span class=\"n\">αpγ</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" &amp;|&amp; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">productPar</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isZeroF</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isOneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">oneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusOneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusTwoF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiplyF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isZero</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">isZeroF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isOne</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">isOneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">one</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">oneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusOne</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">minusOneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusTwo</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">minusTwoF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">addF</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">if_</span><span class=\"w\"> </span><span class=\"n\">isZero</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">      </span><span class=\"n\">if_</span><span class=\"w\"> </span><span class=\"n\">isOne</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">minusOne</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;|&amp;</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">minusTwo</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">add</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FromComputationValuedFunction</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toComputationValuedFunction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Functional</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Functorial</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenF</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">βfγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfγ</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Creational</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">productSeq</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcγ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sequential</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenP</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">βfcγ</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foldSum</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">γfα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">βfα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">γfα</span><span class=\"w\"> </span><span class=\"n\">tc</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">tb</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfα</span><span class=\"w\"> </span><span class=\"n\">tb</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Conditional</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">γfγα</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfγα</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨</span><span class=\"n\">foldSum</span><span class=\"w\"> </span><span class=\"n\">γfγα</span><span class=\"w\"> </span><span class=\"n\">βfγα</span><span class=\"bp\">⟩</span>\n\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ufα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">async</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">bothPar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfcδ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcγ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span>\n<span class=\"w\">          </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">cγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfcδ</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span>\n<span class=\"w\">            </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">cδ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">cγ</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">cδ</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">pure</span>\n<span class=\"w\">  </span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">bind</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">spawn</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">TasksSpawningProgram</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">Task</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">materializeTasksSpawning</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">TasksSpawningProgram</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αftβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">αftβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">materializeTasksSpawning</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span>\n\n<span class=\"c1\">-- #eval tasksSpawningFibonacci 10 -- also try 24 (takes longer)</span>\n</code></pre></div>\n</div></div>",
        "id": 538402460,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757413682
    },
    {
        "content": "<p>Henrik, see attachment<br>\n<a href=\"/user_uploads/3121/n_uXac-C9lVufkvFbzZXi-YD/WME.lean\">WME.lean</a></p>",
        "id": 538403886,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757414031
    },
    {
        "content": "<p>First things first your definition is not <code>unsafe</code> if massaged sufficiently:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Functional</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">asProgram</span><span class=\"o\">)</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Functorial</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenF</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Functorial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">andThenF</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &gt;-&gt; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">andThenF</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Sequential</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenP</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">andThenP</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" &gt;=&gt; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">andThenP</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Creational</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">productSeq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">productSeq</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" &amp;&amp;&amp; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">productSeq</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Conditional</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sum</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"s2\">\" ||| \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sum</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bothPar</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bothPar</span><span class=\"o\">)</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" |&amp;| \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">bothPar</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">identity</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">let_</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"n\">αaβpγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">identity</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">αaβpγ</span>\n\n<span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">if_</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpb</span><span class=\"w\"> </span><span class=\"n\">t_apβ</span><span class=\"w\"> </span><span class=\"n\">f_apβ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">let_</span><span class=\"w\"> </span><span class=\"n\">αpb</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">        </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">          </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αab</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">αab</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">        </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">t_apβ</span><span class=\"w\"> </span><span class=\"bp\">|||</span><span class=\"w\"> </span><span class=\"n\">f_apβ</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dup</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">productPar</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"n\">αpγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dup</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">αpβ</span><span class=\"w\"> </span><span class=\"bp\">|&amp;|</span><span class=\"w\"> </span><span class=\"n\">αpγ</span>\n\n<span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"s2\">\" &amp;|&amp; \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">productPar</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isZeroF</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isOneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">oneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusOneF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusTwoF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiplyF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isZero</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">isZeroF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isOne</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">isOneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">one</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">oneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusOne</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">minusOneF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">minusTwo</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">minusTwoF</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"n\">addF</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Sequential</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Creational</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Conditional</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">]:</span>\n<span class=\"w\">  </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">if_</span><span class=\"w\"> </span><span class=\"n\">isZero</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">      </span><span class=\"n\">if_</span><span class=\"w\"> </span><span class=\"n\">isOne</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">minusOne</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;|&amp;</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">minusTwo</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">add</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FromComputationValuedFunction</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toComputationValuedFunction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toComputationValuedFunction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Functional</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Functorial</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenF</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">βfγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfγ</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Creational</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">productSeq</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcγ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sequential</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">andThenP</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">βfcγ</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foldSum</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">γfα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">βfα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">tc</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">γfα</span><span class=\"w\"> </span><span class=\"n\">tc</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">tb</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfα</span><span class=\"w\"> </span><span class=\"n\">tb</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Conditional</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">γfγα</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfγα</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨</span><span class=\"n\">foldSum</span><span class=\"w\"> </span><span class=\"n\">γfγα</span><span class=\"w\"> </span><span class=\"n\">βfγα</span><span class=\"bp\">⟩</span>\n\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ufα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">async</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Parallel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">bothPar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αfcγ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">βfcδ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">αfcγ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span>\n<span class=\"w\">          </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">cγ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">βfcδ</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span>\n<span class=\"w\">            </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">cδ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">cγ</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">cδ</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">pure</span>\n<span class=\"w\">  </span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">bind</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadAsync</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">spawn</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">TasksSpawningProgram</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">Task</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">materializeTasksSpawning</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">TasksSpawningProgram</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">αftβ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">αftβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">materializeTasksSpawning</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span>\n</code></pre></div>\n</div></div>",
        "id": 538408823,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757415831
    },
    {
        "content": "<p>Looking at the coredump of the crash it very much is a stack size issue.</p>",
        "id": 538409721,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757416126
    },
    {
        "content": "<p>With the version of your code without unsafe (for reference the diff is)</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code>141c141\n<span class=\"gd\">&lt; unsafe def parallelFibonacci</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt; partial def parallelFibonacci</span>\n146c146\n<span class=\"gd\">&lt;     [Parallel program] :</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;     [Parallel program] [Inhabited &lt;| program Nat Nat]:</span>\n157a158,160\n<span class=\"gi\">&gt; instance [Inhabited (computation β)] : Inhabited (FromComputationValuedFunction computation α β) where</span>\n<span class=\"gi\">&gt;   default := { toComputationValuedFunction := fun _ =&gt; default }</span>\n&gt;\n230,231c233\n<span class=\"gd\">&lt; unsafe def tasksSpawningFibonacci :=</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt; def tasksSpawningFibonacci :=</span>\n</code></pre></div>\n<p>The issue is that your <code>parallelFibonacci</code> attempts to establish a closure containing itself so that just loops (non tail recursively) forever.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isZero</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_1</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOne</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_2</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">CALL</span><span class=\"w\"> </span><span class=\"n\">HERE</span>\n<span class=\"w\">      </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pap</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">lam_0</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pap</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">lam_1</span><span class=\"w\"> </span><span class=\"n\">x_5</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_7</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pap</span><span class=\"w\"> </span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">._</span><span class=\"n\">lam_2</span><span class=\"w\"> </span><span class=\"n\">x_6</span><span class=\"w\"> </span><span class=\"n\">x_7</span><span class=\"w\"> </span><span class=\"n\">x_8</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">inc</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">if_</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_8</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_9</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">if_</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">parallelFibonacci</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">tasksSpawningFibonacci</span><span class=\"bp\">.</span><span class=\"n\">spec_0</span><span class=\"bp\">.</span><span class=\"n\">spec_8</span><span class=\"bp\">._</span><span class=\"n\">redArg</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"n\">x_10</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_11</span>\n</code></pre></div>\n<p>The code produced also looks quite similar on v4.21.0 and I get a similar crash there as well, curiously I do indeed not get a crash when I use the <code>unsafe</code> version. I suspect the compiler was holding back on some optimizations in the <code>unsafe</code> case in 21 and for that reason didn't optimize this? Either way it seems to me like this is broken.</p>",
        "id": 538412966,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757417181
    },
    {
        "content": "<p>Henrik,</p>\n<p>Thanks for your constructive comments.</p>\n<p><code>parallelFibonacci</code> is not a <em>program</em>, it is a <em>program specification</em>.</p>\n<p>The whole goal of my <code>PSBP</code> project<br>\n(Program Specification Based Programming)<br>\nis to separate program specifications from programs.</p>\n<p>A program is a materialization corresponding to <code>instance</code>s of the <code>class</code>es in terms of whose members a program specification is written.</p>\n<p>Compare this with the painting <br>\n\"Ceci n'est pas une pipe\" of René Magritte<br>\n(<a href=\"https://en.wikipedia.org/wiki/The_Treachery_of_Images\">https://en.wikipedia.org/wiki/The_Treachery_of_Images</a>). <br>\nThe paining is not a pipe.</p>\n<p>I understand that the type system of <code>Lean</code> cannot infer a type for <code>parallelFibonacci</code>. As I already +/- stated, I am <br>\n\"living on the dangerous fast lane\". <br>\n Anyway, <code>Lean (v21)</code> could evaluate <code>tasksSpawningFibonacci 10</code><br>\nfor the materialization of the <code>Task</code> based <code>instance</code>s of the <code>class</code>es involved.</p>\n<p>So what do you mean precisely with<br>\n\"Either way it seems to me like this is broken\"?</p>\n<p>I mean, what is <em>this</em> in that sentence? </p>\n<p>Do you mean that <code>Lean (v21)</code> should not be able to evaluate<br>\n<code>tasksSpawningFibonacci 10</code>, or do you mean that <code>Lean (v22)</code> should be able to evaluate <code>tasksSpawningFibonacci 10</code>?</p>",
        "id": 538456673,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757429354
    },
    {
        "content": "<p>I understand that imporant an goal of <code>Lean</code> is to be able to learn <code>Lean</code> what concepts like groups, rings, fields, categories etc. are all about and that <code>Lean</code> is this very demanding (but also very helpful) student that can review your proofs (but can also infer proofs for you). So my goal was to teach <code>Lean</code> what programs are all about. I understand that <code>Lean </code> cannot infer a type for a program specification, but that should, i.m.h.o. not prevent it from interpreting programs and/or generating executable code for programs. And, yes, badly written programs (not badly written program specifications) will, for example, end up looping forever.</p>",
        "id": 538459096,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757429991
    },
    {
        "content": "<blockquote>\n<p><code>parallelFibonacci</code> is not a <em>program</em>, it is a <em>program specification</em>.</p>\n</blockquote>\n<p>Yes it is a program, a program that allocates a lot of closures that eventually get evaluated when your task framework kicks in. Even if it might seem to you like you have some abstract notion of program specification going on this is not what the Lean compiler thinks about your program. If you want a specification and only that instead of this recursive closure allocator you would need to use an <code>inductive</code> for your program specification type.</p>\n<blockquote>\n<p>I understand that the type system of <code>Lean</code> cannot infer a type for <code>parallelFibonacci</code>. As I already +/- stated, I am \"living on the dangerous fast lane\".</p>\n</blockquote>\n<p>as I demonstrated in my snippet it is perfectly possible to write your Lean file without <code>unsafe</code>.</p>\n<blockquote>\n<p>\"Either way it seems to me like this is broken\"?<br>\nI mean, what is <em>this</em> in that sentence?</p>\n</blockquote>\n<p><code>parallelFibonacci</code> could always be compiled to an infinite non tail recursion that blows the stack and I am surprised that it ever worked at all.</p>",
        "id": 538461664,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757430650
    },
    {
        "content": "<p>Henrik,</p>\n<p>first of all, thx for all your replies</p>\n<p>FYI:</p>\n<p>I the past, I have written a (more elaborated) <br>\n\"Program Specification Based Programming\" library<br>\nin <code>Scala</code> and <code>Haskell</code>. </p>\n<p>I switched to <code>Lean</code> because of it's theorem proving capabilities. With the idea of writing an, agreed, somewhat opinionated,  programming course. </p>\n<p>The code of the course being a programming course for <code>Lean</code> itself.</p>\n<p>About:</p>\n<p>\"... you would need to use an inductive for your program specification type ...</p>\n<p>Will using code like below, using a structure, then solve my problem?</p>\n<p>BTW:</p>\n<p>I did not manage, yet, to use an inductive, maybe you can help?</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Code listing</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FromComputationValuedFunction</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toComputationValuedFunction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Functional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FromComputationValuedFunction</span><span class=\"w\"> </span><span class=\"n\">computation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">asProgram</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">αfβ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n</div></div>",
        "id": 538482260,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757436586
    },
    {
        "content": "<p>Hernik,</p>\n<p>About:</p>\n<p>... parallelFibonacci could always be compiled to an infinite<br>\nnon tail recursion that blows the stack ...</p>\n<ul>\n<li>could : yes</li>\n<li>should : no</li>\n</ul>\n<p>I mean, given the <code>instance</code> definitions that decrease the<br>\narguments of the two spawned <code>parallelFibonacci</code>'s, more<br>\nprecisely <code>n</code> to <code>n-1</code> and <code>n-2</code>, <code>Lean</code> could, maybe, be<br>\nclever enough to compile to code that does not blow the stack,<br>\n(apparently it did with <code>v21</code>) or, at least, offer a compiler option <br>\nto not do it.</p>\n<p>BTW:</p>\n<p>I have had no problems with the <code>unsafe</code> <em>sequential</em> <code>fibonacci</code>,<br>\n(both its <code>Active</code> and <code>Reactive</code> implementation). Only the<br>\n<code>Task</code> based implementation gave me problems.</p>",
        "id": 538492400,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757438971
    },
    {
        "content": "<blockquote>\n<p>I mean, given the <code>instance</code> definitions that decrease the<br>\narguments of the two spawned <code>parallelFibonacci</code>'s, more<br>\nprecisely <code>n</code> to <code>n-1</code> and <code>n-2</code></p>\n</blockquote>\n<p>This analysis is wrong. The Lean program <code>parallelFibonacci</code> simply calls itself infinitely deep non tail recursively. It doesn't matter what program it specifies, the semantics of Lean dictate that what you are doing is not okay. As I have explained above your program is also broken in both of the versions if it is written out properly without <code>unsafe</code> and instead using <code>partial</code>. As to why the compilation behavior of an <code>unsafe</code> definition changed between <code>4.21</code> and <code>4.22</code> I don't know but what it is doing now is not wrong.</p>\n<p>Note that a trick like you are doing here might work out trivially in a lazy language like Haskell because the closures there would not be evaluated eagerly. This is very much not the case in Lean. If you check the definition of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Applicative#doc\">docs#Applicative</a> in Lean you will observe that Lean explicitly introduces a <code>Unit -&gt; </code> thunk in the second part of the sequence in order to avoid evaluating it if it doesn't actually end up being called. You could try to do something similar with your sequencing mechanism.</p>",
        "id": 538790606,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1757576632
    },
    {
        "content": "<p>Hello, I found out in the source code that the difference has been introduced in the nightly build of 2026-06-21 in the file <code>CoreM.lean</code> at line <code>670</code>, setting the new code generator as default code generator to <code>true</code>. </p>\n<p>Anyway, I have no problems with my sequential <code>fibonacci</code> only with my <code>Task</code> based parallel <code>fibonacci</code>. So, maybe, it is related to <code>Task</code> code as well (<code>.cpp</code> code because most <code>.lean</code> code involved is <code>extern</code>).</p>\n<p>I have raised an issue :<br>\n<a href=\"https://github.com/leanprover/lean4/issues/10372\">https://github.com/leanprover/lean4/issues/10372</a></p>\n<p>hopefully it will be considered by the compiler guru's.</p>",
        "id": 539281778,
        "sender_full_name": "Luc Duponcheel",
        "timestamp": 1757779792
    },
    {
        "content": "<p>Impressive crystal ball you've got there!</p>",
        "id": 539282221,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1757780329
    }
]