[
    {
        "content": "<p>Is there a way to get the information \"this theorem currently (transitively) depends on <code>sorryAx</code>\" into the doc-gen output, i.e. the documentation website? I imagine something like a  <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span>  or <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span>  next to the name of the theorem.</p>\n<p>For mathlib this does not matter of course as it shall never have anything depending on <code>sorryAx</code>, but for a separate project I would like to have this and could not find any similar discussion.</p>",
        "id": 503360081,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741120797
    },
    {
        "content": "<p>Do you want it specifically for doc-gen, or having a linter that flags this would be enough?</p>",
        "id": 503361598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741121374
    },
    {
        "content": "<p>There was a previous discussion of flagging <code>Classical.choice</code>, but you can equally well flag any other axion, such as <code>sorryAx</code>.</p>",
        "id": 503361659,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741121401
    },
    {
        "content": "<p>The linter is here: <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/restricting.20axioms/near/501743343\">#lean4 &gt; restricting axioms @ ðŸ’¬</a>.</p>",
        "id": 503361853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741121468
    },
    {
        "content": "<p>Thanks, that linter might be useful too, but I am still interested in specifically doc-gen. My use case is that from a (non-Lean) math article I want to link to things in the doc-gen and there people should instantly be able to see whether this thing is already fully verified or not.</p>",
        "id": 503363509,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741122088
    },
    {
        "content": "<p>The linter can help maintain this in sync, for instance, the linter could emit a warning only of the doc-string does not contain \"Depends on <code>sorry</code>.\" as a substring.</p>",
        "id": 503363885,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741122242
    },
    {
        "content": "<p>But to make this fully automated would require a little more infrastructure.</p>",
        "id": 503363954,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741122259
    },
    {
        "content": "<p>Hm, okay. I want to avoid manually updating this information - if one finishes the last sorry in a proof this is still manageable for that theorem itself, but not for all stuff depending on it.</p>\n<p>In my experiment to get automated Lean cehcks into tex files here <a href=\"https://github.com/m4lvin/RepLeanTeX\">https://github.com/m4lvin/RepLeanTeX</a> I also used the <code>#print axioms</code> method, I was hoping something similar could be done with doc-gen.</p>\n<p>How much is \"more infrastructure\" here? I assume the doc-strings already get evaluated somehow for example to linkify identifiers in code. Would <a href=\"https://github.com/leanprover/doc-gen4/blob/main/DocGen4/Process/TheoremInfo.lean\"><code>DocGen4.Process.TheoremInfo</code></a> be the right place to start messing around with this if I ever feel like it?</p>",
        "id": 503371959,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741125295
    },
    {
        "content": "<p>Oh, I do not know about the doc-gen infrastructure.  I was more thinking of automating the adding/removing of a comment in the doc-string.</p>",
        "id": 503377127,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741127253
    },
    {
        "content": "<p>Since the linter gives you exact location where the comment is/isn't, you can build a small script on top of that that acts on the linter warning.</p>",
        "id": 503377254,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741127295
    },
    {
        "content": "<p>I am not saying that this is a principled way, but I have written a few \"automatic linter-guided modifications\" and they worked very well.</p>",
        "id": 503377340,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741127334
    },
    {
        "content": "<p>Does doc-gen4 currently indicate theorems which directly use <code>sorry</code>?</p>",
        "id": 503390168,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741133313
    },
    {
        "content": "<p>(I remember implementing this in Lean 3, but we never had the transitive version there)</p>",
        "id": 503390246,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741133356
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/can.20doc-gen4.20show.20sorry-dependency.3F/near/503390168\">said</a>:</p>\n<blockquote>\n<p>Does doc-gen4 currently indicate theorems which directly use <code>sorry</code>?</p>\n</blockquote>\n<p>As far as I can see, no. An example is <a href=\"https://m4lvin.github.io/lean4-pdl/docs/Pdl/Soundness.html#eProp2.c_help\">here</a> which includes a sorry <a href=\"https://github.com/m4lvin/lean4-pdl/blob/1a02ad72bff828206af5fa065c8d27b153c90b76/Pdl/Soundness.lean#L361\">here</a>.</p>",
        "id": 503442259,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741160390
    },
    {
        "content": "<p>Getting both pieces of information would be even nicer, e.g. a bold red sorry if it uses sorry directly, and a light orange one if transitively.</p>\n<p>I am surprised that for Lean 3 only the direct use was implemented, isn't that harder to do (because one needs to inspect the proof term I guess?) than the transitive check (as done by e.g. <code>#print axioms</code>)?</p>",
        "id": 503442591,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741160535
    },
    {
        "content": "<p>Related to this, I also found very useful the <code>#axiom_blame</code> tool made and discussed <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/.E2.9C.94.20Finding.20usages.20of.20.60sorry.60.20in.20external.20code/near/430475721\">here</a>. Now imagine the doc-gen output could even show where the sorry comes from :)</p>",
        "id": 503442837,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741160642
    },
    {
        "content": "<p>Maybe blueprint can do this?</p>",
        "id": 503549041,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741188565
    },
    {
        "content": "<p>I think we should just add this feature to doc-gen. <a href=\"https://github.com/leanprover-community/doc-gen/pull/149\">https://github.com/leanprover-community/doc-gen/pull/149</a> was the PR that added it to Lean 3.</p>",
        "id": 503559328,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741190618
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"422703\">Malvin Gattinger</span> <a href=\"#narrow/channel/113488-general/topic/can.20doc-gen4.20show.20sorry-dependency.3F/near/503442259\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/can.20doc-gen4.20show.20sorry-dependency.3F/near/503390168\">said</a>:</p>\n<blockquote>\n<p>Does doc-gen4 currently indicate theorems which directly use <code>sorry</code>?</p>\n</blockquote>\n<p>As far as I can see, no. An example is <a href=\"https://m4lvin.github.io/lean4-pdl/docs/Pdl/Soundness.html#eProp2.c_help\">here</a> which includes a sorry <a href=\"https://github.com/m4lvin/lean4-pdl/blob/1a02ad72bff828206af5fa065c8d27b153c90b76/Pdl/Soundness.lean#L361\">here</a>.</p>\n</blockquote>\n<p><a href=\"https://imperialcollegelondon.github.io/FLT/docs/FLT/Basic/Reductions.html#FLT.Wiles_Taylor_Wiles\">This example</a> <em>definitely</em> has a <code>sorry</code> but yes there seems to be no mention in doc-gen</p>",
        "id": 503593169,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741197831
    },
    {
        "content": "<p>Wait, <code>Wiles_Taylor_Wiles</code> has no sorry in its proof term as written there, right? It just depends on something that uses <code>sorry</code>. As far as I understand the code from the Lean 3 PR Eric linked to above, it only flagged things with an \"immediate\" <code>sorry</code>, and not things that transitively depend on something with <code>sorry</code>.</p>",
        "id": 503613713,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741202841
    },
    {
        "content": "<p>Yes, the proof itself has no sorry but it uses many things which have sorrys</p>",
        "id": 503624454,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741205855
    },
    {
        "content": "<p>Would someone like to create an issue at doc-gen4 to track this? </p>\n<p>I think this would be a great feature, and would encourage someone to implement it! :-)</p>",
        "id": 505257783,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741816132
    },
    {
        "content": "<p>I can try to write an issue, based on the discussion here. Is it okay to include both \"uses sorry directly\" and \"transitively depends on sorry\" in the same issue or should those be separate ones?</p>",
        "id": 505352042,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1741854533
    },
    {
        "content": "<p>Let's just have one issue.</p>",
        "id": 505371034,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741859339
    },
    {
        "content": "<p>I've added an issue now, and included some mock-ups how it could look like: <a href=\"https://github.com/leanprover/doc-gen4/issues/270\">https://github.com/leanprover/doc-gen4/issues/270</a></p>",
        "id": 507474461,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1742666443
    },
    {
        "content": "<p>I tried my luck looking into the doc-gen4 codebase to make this feature happen. Here is my attempt <a href=\"https://github.com/leanprover/doc-gen4/compare/main...m4lvin:doc-gen4:show-sorryAx\">https://github.com/leanprover/doc-gen4/compare/main...m4lvin:doc-gen4:show-sorryAx</a> with which <code>lake build</code> in doc-gen4 itself works fine, but for some reason <code>lake build DocGen4:docs</code> now takes really loooong. I have processes with <code>genCore Lean</code> and <code>genCore Std</code> that seem to take forever, whereas before it took less than 8 minutes. Is there something cached online normally that could take very long? Or is the place and way that I added <code>collectAxioms</code> too naive and leading to some sort of infinite loop? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> <br>\nThanks for any help and advice! (I also hope to make a PR of course, but first wanted to at least get it working locally.)</p>",
        "id": 541916507,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1759091016
    },
    {
        "content": "<p>You're running collectAxioms for every name seperately so you are going to run into a lot of overhead because if a name is used in <code>n</code> declarations it will be checked at least <code>n</code> times + all of the uses of those declarations and so on. You could try to add a cache here to stop revisiting the names over and over again but even then doing this will have significant computational impact as you can't cache results across modules given that they are worked in different processes.</p>",
        "id": 541916787,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1759091260
    },
    {
        "content": "<p>Right, that makes sense, thanks! I assume this is why in the Lean 3 version we also only had a marker for \"uses <code>sorry</code> directly\" and not for \"depends on <code>sorryAx</code>\"?</p>",
        "id": 541917087,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1759091615
    },
    {
        "content": "<p>I don't know, doc-gen3 was a completely different code base. If doc-gen was engineered to work in one process with multiple threads instead having a cache shared between these threads would very much be possible</p>",
        "id": 541917318,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1759091869
    },
    {
        "content": "<p>Putting aside the difficult isse of marking transitive dependency on sorry, I now managed to at least mark <em>direct</em> uses of sorry, see <a href=\"https://github.com/leanprover/doc-gen4/pull/319\">doc-gen4#319</a> and <a href=\"https://m4lvin.github.io/lean4-pdl/docs/Pdl/PartInterpolation.html#Cluster-tools\">this example what the result looks like</a>.</p>",
        "id": 542134996,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1759178127
    },
    {
        "content": "<p>Would it make sense for <code>proof_wanted</code> to appear similarly? That could be relevant to Mathlib. (I don't believe they appear in docs at all at the moment, so that is perhaps a prerequisite conversation).</p>",
        "id": 542146016,
        "sender_full_name": "Chris Henson",
        "timestamp": 1759182597
    },
    {
        "content": "<p>It seems indeed <code>proof_wanted</code> entries do not appear at all in the docs at the moment, I do not know how difficult it would be to make them appear. I also think they should not appear very similarly, given that a sorry-using statement can already be used but a proof_wanted cannot (so it would maybe also be misleading to make them appear in the search). On the other hand I guess making proof_wanted appear in the docs might prevent someone from reinventing its statement and name.</p>",
        "id": 542198351,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1759216348
    },
    {
        "content": "<p>I'm not familiar with doc-gen4 internals, but it might be awkward to include for a couple of reasons:</p>\n<ul>\n<li><code>proof_wanted</code> is defined in Batteries</li>\n<li>it elaborates using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.withoutModifyingEnv#doc\">docs#Lean.withoutModifyingEnv</a></li>\n</ul>",
        "id": 542203121,
        "sender_full_name": "Chris Henson",
        "timestamp": 1759217894
    },
    {
        "content": "<p>That makes it doubly impossible to add</p>",
        "id": 542219725,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1759222798
    }
]