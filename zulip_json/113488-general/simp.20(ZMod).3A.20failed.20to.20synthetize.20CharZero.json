[
    {
        "content": "<p>I have noticed that when I get a little complicated expressions into the argument of <code>ZMod</code> (even if hidden under a definition), <code>simp</code>, and related tools (<code>push_cast</code>, ...) become unusable due to a crash on <code>failed to synthesize CharZero (ZMod ...)</code>. MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">complicated</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"bp\">*</span><span class=\"mi\">6</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">    </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">valEmbedding</span><span class=\"w\"> </span><span class=\"bp\">∩</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Ico</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"bp\">.</span><span class=\"n\">unbotD</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">complicated</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"bp\">+</span><span class=\"mi\">3</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"c1\">-- note: replacing 3 -&gt; 2 works</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- crash</span>\n</code></pre></div>\n<p>Any ideas how to deal with it? Could I convince <code>simp</code> not to try to infer this?<br>\nAs a possible workaround, I also thought if I could replace the <code>complicated (c+3)</code> in the local context with some local variable in such a way that <code>simp</code> could not expand it... Would that be feasible?</p>",
        "id": 555364644,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763042855
    },
    {
        "content": "<p>There is no crash, just</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">CharZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">complicated</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)))</span>\n<span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`typeclass</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">20000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n</code></pre></div>",
        "id": 555366241,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1763043207
    },
    {
        "content": "<p>Ok, sorry if calling it a \"crash\" is a oversimplification, I thought it is an appropriate name for an error message instead of any reasonable outcome of the tactic... But I would like to know what to do with that.</p>",
        "id": 555367442,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763043462
    },
    {
        "content": "<p>turn off that simp lemma</p>",
        "id": 555367740,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763043528
    },
    {
        "content": "<p>Sounds good, how do I detect which one it is causing?</p>",
        "id": 555368389,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763043676
    },
    {
        "content": "<p>try <code>Nat.cast_inj</code></p>",
        "id": 555369053,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763043834
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast_inj</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">complicated</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"bp\">+</span><span class=\"mi\">3</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>still fails on the same</p>",
        "id": 555369748,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763043953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133339\">@Mirek Olšák</span> <code>set_option trace.Debug.Meta.Tactic.simp true</code> successfully found the offending simp lemma <code>Nat.cast_eq_zero</code></p>",
        "id": 555370523,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763044116
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/bWiF5SE9PBiv6w0dSM8n281N/debug_traces\">debug_traces</a><br>\nThanks, that is helpful. Could you just explain me how you navigated the debug trace? I can see 1101 lines, none of them mentioning <code>Nat.cast_eq_zero</code></p>",
        "id": 555373883,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763044760
    },
    {
        "content": "<p>Ok, it might be a version difference -- I can find the <code>Nat.cast_eq_zero</code> in the traces in live Lean.</p>",
        "id": 555377820,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1763045624
    },
    {
        "content": "<p>I just looked at the last one</p>",
        "id": 555381006,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763046322
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/simp.20.28ZMod.29.3A.20failed.20to.20synthetize.20CharZero\">#lean4 &gt; simp (ZMod): failed to synthetize CharZero</a> by <span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span>.</p>",
        "id": 555388110,
        "sender_full_name": "Notification Bot",
        "timestamp": 1763047903
    },
    {
        "content": "<p>didn't we have this problem before</p>",
        "id": 555388251,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763047935
    },
    {
        "content": "<p>I have an issue <a href=\"https://github.com/leanprover/lean4/pull/10414\">lean#10414</a> and a fix <a href=\"https://github.com/leanprover/lean4/pull/8883\">lean#8883</a> to fix the exponentially slow unification that causes your time-out. You can upvote the issue for it to get more attention :)</p>",
        "id": 555487421,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763082242
    },
    {
        "content": "<p>By the way, to investigate a time-out, the easiest way is to use <code>set_option trace.profiler true in</code> in front of the <code>simp</code>.</p>",
        "id": 555487509,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763082310
    }
]