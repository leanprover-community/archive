[
    {
        "content": "<p>This code raises no error in <code>v4.12.0</code>, but raises error in <code>v4.13.0-rc3</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">List.sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"n\">ns</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List.foldr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List.sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> tactic 'rfl' failed, the left-hand side</span>\n<span class=\"cm\">    List.foldr (fun x1 x2 =&gt; x1 + x2) 0</span>\n<span class=\"cm\">  is not definitionally equal to the right-hand side</span>\n<span class=\"cm\">    List.sum</span>\n<span class=\"cm\">  ⊢ List.foldr (fun x1 x2 =&gt; x1 + x2) 0 = List.sum -/</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">List.sumTR</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">l</span>\n<span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ns</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List.foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List.sumTR</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 474834853,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728051902
    },
    {
        "content": "<p>these work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">delta</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sumTR</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">delta</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sumTR</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sumTR</span><span class=\"bp\">.</span><span class=\"n\">aux</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>This style of proof is likely to be very brittle</p>",
        "id": 474835486,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728052085
    },
    {
        "content": "<p>what is <code>delta</code>?</p>",
        "id": 474835651,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728052134
    },
    {
        "content": "<p>it's a very low level tactic for unfolding definitions</p>",
        "id": 474835772,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728052167
    },
    {
        "content": "<p>how to avoid using <code>delta</code>?</p>",
        "id": 474835958,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728052221
    },
    {
        "content": "<p>prove it by induction</p>",
        "id": 474835982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728052230
    },
    {
        "content": "<blockquote>\n<p>This style of proof is likely to be very brittle</p>\n</blockquote>\n<p>Thank you.<br>\nOK, so you mean this <code>rfl</code> regression is not a bug?</p>",
        "id": 474836161,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728052286
    },
    {
        "content": "<p>I don't know about that, but this is a very abstraction breaking proof and it can break even with changes to internal details</p>",
        "id": 474836568,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728052398
    },
    {
        "content": "<p>anyoune knows if this is a bug?</p>",
        "id": 474873074,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728063758
    },
    {
        "content": "<p>I think this was changed in <a href=\"https://github.com/leanprover/lean4/pull/3772\">lean4#3772</a>. In other words, the previous behaviour was a bug (<code>Kernel.isDefEq</code> ignores transparency modes and its use as a performance optimisation caused too many things to be unfolded in some cases) and the current behaviour seems intentional.</p>",
        "id": 475242256,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1728289839
    },
    {
        "content": "<p>See also the discussion at <a href=\"#narrow/stream/113489-new-members/topic/.E2.9C.94.20Reflection.20Proofs.20for.20Simple.20Programs/near/459506623\">https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/.E2.9C.94.20Reflection.20Proofs.20for.20Simple.20Programs/near/459506623</a></p>",
        "id": 475245224,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1728290435
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"325367\">@Mauricio Collares</span> Thank you!</p>",
        "id": 475312042,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1728311666
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 475312063,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728311673
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/.E2.9C.94.20.60rfl.60.20regression.3F/near/474835982\">said</a>:</p>\n<blockquote>\n<p>prove it by induction</p>\n</blockquote>\n<p>Here's an example where <code>rfl</code> worked on lean v4.12.0, and now on 4.13.0-rc3 I needed to write a nontrivial induction proof:<br>\n<a href=\"https://github.com/dwrensha/compfiles/commit/f7407d8dee196eecea12e712f7d02532e47ed24e\">https://github.com/dwrensha/compfiles/commit/f7407d8dee196eecea12e712f7d02532e47ed24e</a></p>",
        "id": 475681307,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424565
    },
    {
        "content": "<p>I'd be curious to know of any better workarounds.</p>",
        "id": 475681371,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424600
    },
    {
        "content": "<p>It feels a bit silly that I can't easily just ask Lean to sum up these ~2000 numbers.</p>",
        "id": 475681427,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424637
    },
    {
        "content": "<p>(<code>native_decide</code> does work, but I'd prefer not to depend on that)</p>",
        "id": 475681704,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424771
    },
    {
        "content": "<p>And just <code>decide</code> is too slow?</p>",
        "id": 475681808,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728424810
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">recursion</span><span class=\"w\"> </span><span class=\"n\">depth</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n</code></pre></div>",
        "id": 475681905,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424842
    },
    {
        "content": "<p>Doing what exactly?</p>",
        "id": 475682077,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728424922
    },
    {
        "content": "<p>the goal is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1998</span><span class=\"w\"> </span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"bp\">↑↑</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 475682171,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424950
    },
    {
        "content": "<p>where the inner coerce is to Nat, and the outer one is to Int</p>",
        "id": 475682216,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728424972
    },
    {
        "content": "<p>With what imports etc. <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>",
        "id": 475682294,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728425013
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1998</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 475682669,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728425126
    },
    {
        "content": "<p>So there is certainly a runaway <code>whnf</code> call in this happening but I can't quite tell what's wrong on the spot, I need to sleep soon so probably won't get back to this for a bit.</p>",
        "id": 475683647,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728425417
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/113488-general/topic/.E2.9C.94.20.60rfl.60.20regression.3F/near/475681808\">said</a>:</p>\n<blockquote>\n<p>And just <code>decide</code> is too slow?</p>\n</blockquote>\n<p>For <code>Nat</code> and <code>Int</code> equalities, I'd expect <code>decide</code> would be likely slower than <code>rfl</code>, since it has to reduce both sides of the equality anyway, and it has some mild overhead from <code>Decidable</code>.</p>",
        "id": 475684150,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728425582
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ks</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ks</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">tmod</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">1998</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">tmod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>doesn't need mathlib</p>",
        "id": 475757055,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728454633
    }
]