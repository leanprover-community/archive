[
    {
        "content": "<p>Suppose I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>This much works fine: Lean recognizes that the instance <code>foo</code> exists and lets you write <code>Foo.β α</code> in the type of <code>inj'</code>.</p>\n<p>But, when you try to <em>make</em> a <code>Bar</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"c1\">-- failed to synthesize Foo PUnit</span>\n</code></pre></div>\n<p>Within the definition, the instance isn't visible.</p>\n<p>I imagine that this is an example of the more general difficulty with constructors, that there's no good way to directly make reuse field values in other fields without doing <code>let := ...; { ... }</code>. Nevertheless, it complicates the construction of complex structures, and I'd like to see what workarounds exist.</p>",
        "id": 531483744,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1753747434
    },
    {
        "content": "<p>It's a difficulty with function applications in general: just because you have explicitly provided an instance for an instance argument doesn't mean it should be made available as an instance to the later arguments.</p>\n<p>One could imagine there should be an exception here, but it seems like it makes more sense for <code>where</code> notation than <code>{...}</code> notation, and we want these to be consistent (<code>where</code> is pretty much a macro for <code>{...}</code>).</p>\n<p>A design idea that once crossed my mind though would be to have some syntax that means \"lift this field as a let\". For example, you might have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n</code></pre></div>\n<p>mean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">    </span><span class=\"n\">foo</span>\n<span class=\"w\">    </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 531484740,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753748029
    },
    {
        "content": "<p>However, there'd need to be some smarts here beyond a simple macro, since <code>foo</code> needs a type for it to be registered as a local instance.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">    </span><span class=\"n\">foo</span>\n<span class=\"w\">    </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 531484902,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753748125
    },
    {
        "content": "<p>One thing I came up with was changing the type of <code>inj'</code> to <code>[Foo α] → Foo.β α → α</code>, which basically does the trick of \"letting you define a field value as if another field value was in scope\" so long as you have the <code>attribute [instance]</code> on <code>Bar.foo</code>.</p>",
        "id": 531484940,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1753748158
    },
    {
        "content": "<p>The <code>let</code> type isn't the only complication with this. Then there's the question of \"what should have this <code>let</code> be in scope?\" The natural thing is all the remaining fields in the structure's field order, but that disagrees with what's visible in the source code (you're allowed to provide fields in any order you want, but they always elaborate in the structure's field order).</p>",
        "id": 531485099,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753748255
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/113488-general/topic/Instances.20in.20constructors/near/531484940\">said</a>:</p>\n<blockquote>\n<p>One thing I came up with was [...]</p>\n</blockquote>\n<p>Interesting trick, though doesn't that change the meaning so that <code>inj'</code> is no longer about just <code>foo</code>, but <em>any</em> <code>Foo</code> instance?</p>",
        "id": 531485317,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753748378
    },
    {
        "content": "<p>Right now, this is how we've expected people to introduce local instances:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">    </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>I think the syntaxes are aligned well enough that you can always transform <code>where $flds</code> to <code>:= { $flds }</code> and it will work. Last year <code>{ ... }</code> didn't support everything <code>where</code> did.</p>",
        "id": 531485531,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753748515
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/Instances.20in.20constructors/near/531484740\">said</a>:</p>\n<blockquote>\n<p>A design idea that once crossed my mind though would be to have some syntax that means \"lift this field as a let\". </p>\n</blockquote>\n<p>For the specific case of instances, it might be intuitive to just enable <code>[...]</code> in the body of the <code>where</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n</code></pre></div>\n<p>And then, since it's imitating <code>let foo := ...; { ... }</code> anyway, basically do the same sort of thing as <code>generalize</code>, hoisting both the given definition and everything it depends on to above the structure constructor and replacing values with references?</p>",
        "id": 531485645,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1753748588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/Instances.20in.20constructors/near/531485317\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/113488-general/topic/Instances.20in.20constructors/near/531484940\">said</a>:</p>\n<blockquote>\n<p>One thing I came up with was [...]</p>\n</blockquote>\n<p>Interesting trick, though doesn't that change the meaning so that <code>inj'</code> is no longer about just <code>foo</code>, but <em>any</em> <code>Foo</code> instance?</p>\n</blockquote>\n<p>Yes, this is definitely leaning on the \"we kind of want instances to be subsingletons\" expectation, and works best with <code>Prop</code>-valued classes.</p>\n<p>(... which this example isn't lol, but my original inspiring use case was)</p>",
        "id": 531485705,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1753748623
    },
    {
        "content": "<p>Square brackets don't seem to be any different from <code>let</code> with the ordering problem. Quick example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">PEmpty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PEmpty</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"bp\">⟩</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Would you be surprised that <code>foo</code> is an instance for <code>inj'</code>?</p>\n<p>Another example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Baz</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Baz</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqNat</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Would you be surprised that <code>eq</code> might not be able to use the <code>DecidableEq</code> instance? (If it did a full dependency analysis rather than elaborate fields in structure order, then this particular example would work, but there must be examples where the instance would appear first and you want it in a field that's written later, but some field dependency that might not be a dependency given the concrete values of the fields may prevent that. Seems counterintuitive, and I think it would make it more unpredictable.)</p>",
        "id": 531487383,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753749648
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/Instances.20in.20constructors/near/531487383\">said</a>:</p>\n<blockquote>\n<p>Would you be surprised that <code>foo</code> is an instance for <code>inj'</code>?</p>\n</blockquote>\n<p>Depends on how well it was documented :p . My suggestion is \"unconditionally hoist 'highlighted' fields\" (whether by <code>[..]</code> or <code>let</code> or otherwise) \"and all dependents all the way to the top, so that they are visible in all later fields\"; which could be surprising, but at least it would be consistent, and if the notation came with a hover-doc the surprise would be limited. (Also, the reason I'm focusing on <code>[..]</code> is that instances I feel have a special place here; while indeed you might be very surprised if a <em>variable</em> you define was visible 'before' its definition, I think that you'd be much less surprised if an <em>instance</em>, something intuitively kind of 'ambient'/'external' anyway, had the same behavior.)</p>\n<p>I also vaguely suspect that this is a sufficiently common use case that having an extra opt-in feature would be valuable even if it didn't work for all possible use cases, but that's something that would need to be justified with evidence.</p>",
        "id": 531488513,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1753750348
    }
]