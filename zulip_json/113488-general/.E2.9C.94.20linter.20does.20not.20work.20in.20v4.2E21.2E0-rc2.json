[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- LinterLib.lean の内容</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">CollectAxioms</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">DeclarationNames</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">「detectClassical」リンターは、`Classical.choice` 公理に依存する宣言に対して警告を発する。</span>\n<span class=\"sd\">デフォルト値は `true`</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">register_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">detectClassical</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">defValue</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"detectClassicalリンターを有効にする\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">DetectClassical</span>\n\n<span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">detectClassical</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">detectClassicalLinter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withSetOptionIn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"c1\">-- リンターが有効になっていなければ何もしない</span>\n<span class=\"w\">      </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">getLinterValue</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">detectClassical</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">return</span>\n\n<span class=\"w\">      </span><span class=\"c1\">-- どこかにエラーがあれば何もしない</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">messages</span><span class=\"bp\">.</span><span class=\"n\">hasErrors</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span>\n\n<span class=\"w\">      </span><span class=\"c1\">-- ユーザが定義した名前を取得する</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getNamesFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"bp\">|&gt;.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span><span class=\"o\">)</span>\n\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">constStx</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">constName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">constStx</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAxioms</span><span class=\"w\"> </span><span class=\"n\">constName</span>\n\n<span class=\"w\">        </span><span class=\"c1\">-- 公理に依存していなければスルーする</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span>\n\n<span class=\"w\">        </span><span class=\"c1\">-- 選択原理に依存していれば警告を出す</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"ss\">`Classical.choice</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">logLint</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">detectClassical</span><span class=\"w\"> </span><span class=\"n\">constStx</span>\n<span class=\"w\">            </span><span class=\"n\">m!</span><span class=\"s2\">\"'{constName}' depends on 'Classical.choice'.</span><span class=\"se\">\\n\\n</span><span class=\"s2\">All axioms: {axioms.toList}</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">addLinter</span><span class=\"w\"> </span><span class=\"n\">detectClassicalLinter</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">DetectClassical</span>\n</code></pre></div>",
        "id": 522329013,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749035185
    },
    {
        "content": "<p>The above code worked in v4.20.0, but it doesn't work in v4.20.0-rc2.<br>\nHow should I fix it?</p>",
        "id": 522329164,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749035231
    },
    {
        "content": "<p>I have not tried it, but I think that <code>getOptions</code> should become <code>Linter.getLinterOptions</code>, maybe?</p>",
        "id": 522329483,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1749035332
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Linter.getLinterOptions#doc\">docs#Lean.Linter.getLinterOptions</a></p>",
        "id": 522329576,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1749035362
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 522329875,
        "sender_full_name": "Notification Bot",
        "timestamp": 1749035454
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> Thank you!</p>",
        "id": 522329891,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1749035461
    },
    {
        "content": "<p>I wonder whether <code>getOptions</code> should have been deprecated in favour of <code>getLinterOptions</code>.  <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> what do you think?</p>",
        "id": 522330029,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1749035509
    },
    {
        "content": "<p>I am not sure: options are used in many more places than linters. And <code>getLinterOptions</code> requires more runtime access (namely the environment extensions) than <code>getOptions</code>.</p>",
        "id": 522334799,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1749037019
    },
    {
        "content": "<p>Fair enough!</p>",
        "id": 522335484,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1749037232
    }
]