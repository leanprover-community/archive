[
    {
        "content": "<p>I'm using a networked SSD on a cloud machine and <code>import Mathlib</code> takes 40 seconds for me (when I'm running 128 processes simultaneously on a big CPU machine, this timing goes up to 20 minutes). Is it expected?</p>\n<p>How can I profile <code>import Mathlib</code>?</p>\n<p>Is <code>import Mathlib</code> indeed I/O heavy?</p>\n<p>(in strace logs I can see that it always does a dozen of <code>stat</code>-calls before finding the correct <code>olean</code> and reading a few kilobytes from it)</p>\n<p>Is it possible to somehow place all of Mathlib into a zipball? (similar to Python zipimport / egg file) and make sure that Lean indexes its contents to avoid useless <code>stat</code>-calls?</p>\n<p>Thank you!</p>",
        "id": 513864617,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745413021
    },
    {
        "content": "<blockquote>\n<p>How can I profile <code>import Mathlib</code>?</p>\n</blockquote>\n<p>Probably most easily with a standard C/C++ profiler like samply or perf or intel vtune depending on what platform you're on and what tools you like</p>\n<blockquote>\n<p>Is <code>import Mathlib</code> indeed I/O heavy?</p>\n</blockquote>\n<p>It has to touch a couple of thousand files so certainly not cheap IO wise.</p>\n<blockquote>\n<p>(in strace logs I can see that it always does a dozen of <code>stat</code>-calls before finding the correct <code>olean</code> and reading a few kilobytes from it)</p>\n</blockquote>\n<p>Can you show one of those <code>stat</code> strides?</p>\n<blockquote>\n<p>Is it possible to somehow place all of Mathlib into a zipball? (similar to Python zipimport / egg file) and make sure that Lean indexes its contents to avoid useless <code>stat</code>-calls?</p>\n</blockquote>\n<p>not right now no</p>",
        "id": 513871012,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1745414566
    },
    {
        "content": "<p>\"reading a few kbytes\" is probably misleading because most reading is done invisibly through <code>mmap</code> - assuming your network FS supports it. I would highly doubt the stat calls are significant compared to the actual reading of data.</p>",
        "id": 513875408,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745415678
    },
    {
        "content": "<p>Looks as so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/batteries/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/batteries/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/Qq/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/Qq/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/aesop/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/aesop/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/proofwidgets/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/proofwidgets/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/Cli/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/Cli/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/importGraph/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/importGraph/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/REPL/.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/packages/REPL/.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/build/lib/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8408</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"././.lake/build/lib/Lake.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x7ffc739e8418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ENOENT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"o\">)</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"/home/verifier/.elan/toolchains/leanprover--lean4---v4.9.0-rc1/lib/lean/Lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">st_mode</span><span class=\"bp\">=</span><span class=\"n\">S_IFDIR</span><span class=\"bp\">|</span><span class=\"mi\">0755</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">st_size</span><span class=\"bp\">=</span><span class=\"mi\">4096</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"s2\">\"/home/verifier/.elan/toolchains/leanprover--lean4---v4.9.0-rc1/lib/lean/Lake/Toml/Grammar.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">st_mode</span><span class=\"bp\">=</span><span class=\"n\">S_IFREG</span><span class=\"bp\">|</span><span class=\"mi\">0644</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">st_size</span><span class=\"bp\">=</span><span class=\"mi\">853832</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"o\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/home/verifier/.elan/toolchains/leanprover--lean4---v4.9.0-rc1/lib/lean/Lake/Toml/Grammar.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">newfstatat</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">st_mode</span><span class=\"bp\">=</span><span class=\"n\">S_IFREG</span><span class=\"bp\">|</span><span class=\"mi\">0644</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">st_size</span><span class=\"bp\">=</span><span class=\"mi\">853832</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">AT_EMPTY_PATH</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">newfstatat</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">st_mode</span><span class=\"bp\">=</span><span class=\"n\">S_IFREG</span><span class=\"bp\">|</span><span class=\"mi\">0644</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">st_size</span><span class=\"bp\">=</span><span class=\"mi\">853832</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">AT_EMPTY_PATH</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">lseek</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">851968</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SEEK_SET</span><span class=\"o\">)</span><span class=\"w\">        </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">851968</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"err\">\\</span><span class=\"s2\">5</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">5</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">4</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0down</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0\"</span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1864</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1864</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">lseek</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">851968</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SEEK_SET</span><span class=\"o\">)</span><span class=\"w\">        </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">851968</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"err\">\\</span><span class=\"s2\">5</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">5</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">4</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0down</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0</span><span class=\"err\">\\</span><span class=\"s2\">0\"</span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1864</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">lseek</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SEEK_SET</span><span class=\"o\">)</span><span class=\"w\">             </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"olean</span><span class=\"err\">\\</span><span class=\"s2\">1be6c4894e0a6c542d56a6f4bb1\"</span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4096</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">openat</span><span class=\"o\">(</span><span class=\"n\">AT_FDCWD</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"/home/verifier/.elan/toolchains/leanprover--lean4---v4.9.0-rc1/lib/lean/Lake/Toml/Grammar.olean\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">mmap</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"n\">x3d3b5ae20000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">853832</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PROT_READ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MAP_PRIVATE</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x3d3b5ae20000</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">close</span><span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\">                          </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">lseek</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SEEK_SET</span><span class=\"o\">)</span><span class=\"w\">             </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"olean</span><span class=\"err\">\\</span><span class=\"s2\">1be6c4894e0a6c542d56a6f4bb1\"</span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">56</span>\n<span class=\"mi\">24664</span><span class=\"w\"> </span><span class=\"n\">close</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 513876541,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745415972
    },
    {
        "content": "<p>So can you confirm whether most time is spent before or after the last <code>mmap</code>?</p>",
        "id": 513879200,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745416654
    },
    {
        "content": "<p><code>import Mathlib</code> <code>strace</code> contains 87974 <code>stat</code> calls and 20179 <code>read</code> calls - quite a lot</p>\n<p>moving <code>mathlib4</code> to <code>/tmp</code> cuts time of <code>import Mathlib</code> from 42-seconds to 2 seconds</p>",
        "id": 513879562,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745416743
    },
    {
        "content": "<p>I haven't done any <code>perf</code> profiling yet - will see how to do this. But I confirm that lean imports mathlib very inefficiently/excessively in terms of number of I/O syscalls</p>\n<p>If you have any suggestions on how to measure with <code>perf</code> times of <code>stat</code> calls and <code>read</code> calls separately, I'll try it</p>",
        "id": 513880119,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745416870
    },
    {
        "content": "<p>You can ask strace to print timestamps</p>",
        "id": 513880947,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745417064
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/l7z5OKNJInqm7ZQm7EroIvJK/logs.zip\">logs.zip</a></p>\n<p>I did <code>strace -f -ttt -o log.txt ...</code> and <code>strace -f -r -o log.txt ...</code> to get the syscalls timestamps, attaching the outputs. Not sure if it's sufficient, but clearly I see 20x speedup when moving to <code>/tmp</code></p>",
        "id": 513893299,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745419999
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/Sfxgl8iLVmCCkS4ZE1-DSGtl/logs_ttt_T.zip\">logs_ttt_T.zip</a></p>\n<p>here are the logs (bad and good - for comparison) of <code>strace -f -ttt -T -o log.txt ...</code></p>",
        "id": 513900128,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745421556
    },
    {
        "content": "<p>Thanks, that does suggest the <code>stat</code>s are significant. Fortunately <a href=\"https://github.com/leanprover/lean4/pull/8024\">lean#8024</a> should eliminate most of them, would you be interested in testing the linked mathlib branch?</p>",
        "id": 513904887,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745422689
    },
    {
        "content": "<p>Unfortunately, I am still not very well versed in Lean toolchain. If you can advise how I can update the lean version in my mathlib4 install, I can try it</p>\n<p>I've followed the instructions in <a href=\"https://github.com/Goedel-LM/Goedel-Prover?tab=readme-ov-file#installation\">https://github.com/Goedel-LM/Goedel-Prover?tab=readme-ov-file#installation</a>: clone the fork in <a href=\"https://github.com/xinhjBrant/mathlib4\">https://github.com/xinhjBrant/mathlib4</a> ( <a href=\"https://github.com/xinhjBrant/mathlib4/tree/2f65ba7f1a9144b20c8e7358513548e317d26de1\">https://github.com/xinhjBrant/mathlib4/tree/2f65ba7f1a9144b20c8e7358513548e317d26de1</a> ) and then did <code>cd mathlib4 &amp;&amp; lake build</code>. If you could advise me how to upgrade the lean version to this linked lean4 PR (you did not link any mathlib4 branch, right?), I can try it and report.</p>\n<p>Thank you!</p>",
        "id": 513912966,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745424736
    },
    {
        "content": "<p>The mathlib branch is linked in a comment there: lean-pr-testing-8024. If you check that one out, you shouldn't need to do more than <code>lake build</code></p>",
        "id": 513913781,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745424991
    },
    {
        "content": "<p>Hmm</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"c1\">--recursive https://github.com/leanprover-community/mathlib4 --branch pr-testing-8024 --single-branch --depth 1</span>\n<span class=\"n\">Cloning</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">mathlib4'</span><span class=\"bp\">...</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">remote</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"bp\">-</span><span class=\"n\">testing</span><span class=\"bp\">-</span><span class=\"mi\">8024</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">clone</span>\n</code></pre></div>",
        "id": 513914597,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745425250
    },
    {
        "content": "<p>Your ocmmand has a typo, I think: it should be <code>lean-pr-testing-8024</code></p>",
        "id": 513915119,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745425421
    },
    {
        "content": "<p>Oopsie :) It now worked. It will now take me a few hours to build mathlib4. Will report later if there is still a large difference between running of ramdisk/local ssd and networked ssd</p>",
        "id": 513918241,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745426230
    },
    {
        "content": "<p>You should be able to just run <code>lake exe cache get</code> I would hope</p>",
        "id": 513918636,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1745426361
    },
    {
        "content": "<p>Instead of <code>lake build</code>?</p>",
        "id": 513919235,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745426581
    },
    {
        "content": "<p>Yes, it downloads the olean cache for your specific commit of mathlib if available (which it should be)</p>",
        "id": 513919373,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1745426635
    },
    {
        "content": "<p>(First run <code>lake exe cache get</code>, then <code>lake build</code> should be much faster --- in this case, almost instant since you didn't make any changes causing rebuilds.)</p>",
        "id": 513919976,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745426846
    },
    {
        "content": "<p>Tried it out. This PR made things worse: 65 seconds on networked SSD vs 3 seconds  on <code>/tmp</code></p>",
        "id": 513924382,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745428248
    },
    {
        "content": "<p>It now gives 150K <code>stat</code> calls:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">stat</span><span class=\"o\">(</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">log_bad</span><span class=\"bp\">.</span><span class=\"n\">txt</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"mi\">150912</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/3121/TRFTwedORVV0abgxk7lhKiwE/log_bad.txt.zip\">log_bad.txt.zip</a></p>",
        "id": 513926293,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745428857
    },
    {
        "content": "<p>Should I open a GitHub issue on this?</p>",
        "id": 513926368,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745428886
    },
    {
        "content": "<p>Could you leave a comment on the PR? That is the most likely place to fix this issue</p>",
        "id": 513940771,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745433417
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/113488-general/topic/Lean's.20I.2FO.20usage.20while.20using.20Mathlib/near/513904887\">said</a>:</p>\n<blockquote>\n<p>Fortunately <a href=\"https://github.com/leanprover/lean4/pull/8024\">lean#8024</a> should eliminate most of them, would you be interested in testing the linked mathlib branch?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/8024\">lean4#8024</a> does not yet have Lake integration.</p>",
        "id": 513950630,
        "sender_full_name": "Mac Malone",
        "timestamp": 1745437004
    },
    {
        "content": "<p>Is there a tracking issue I can follow to see what that integration will look like?</p>",
        "id": 513960729,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745440861
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I just added a comment on that PR</p>",
        "id": 513969917,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745444780
    },
    {
        "content": "<p>Thanks. Your comment that even 2s would be too costly for training purposes did strike me as odd because common wisdom in that space is to do all training (per machine) in a single process that loads the desired imports once.</p>",
        "id": 514020066,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745475079
    },
    {
        "content": "<p>Maybe you're right - for a single REPL process verifying multiple statements. But speeding up basic Lean imports (if possible) can speed-up basic verification of produced whole-proofs using just Lean (e.g. for Goedel-Pset, this is 1.8 million statements * e.g. 32 generations (or 256 generations))</p>\n<p>But it's not a blocker indeed (as can probably be sidetracked via REPL)</p>",
        "id": 514099683,
        "sender_full_name": "Vadim Kantorov",
        "timestamp": 1745495193
    }
]