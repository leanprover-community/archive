[
    {
        "content": "<p>I've noticed that sometimes <code>rw</code> succeeds in performing a rewriting, but <code>simp</code> fails, but I don't have a good understanding of why this happens.</p>\n<p>For instance, consider the following example.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">scalar_tac_simps</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val_ofNat</span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}{</span><span class=\"n\">inst</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">}{</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n<span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instOfNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">ofNat</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instOfNat</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"o\">(</span><span class=\"mi\">6</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val_ofNat</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>If I replace <code>rw</code> with <code>simp</code> in the <code>example</code>, <code>simp</code> reports a failure.</p>",
        "id": 510611019,
        "sender_full_name": "Ayhon",
        "timestamp": 1744018492
    },
    {
        "content": "<p>The problem is with your <code>OfNat.ofNat</code>, you should use the <code>ofNat()</code> syntax when making <code>@[simp]</code> theorems about <code>OfNat.ofNat</code> and they will actually apply</p>",
        "id": 510620801,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744020715
    },
    {
        "content": "<p>(read the docstring of <code>ofNat()</code> for a partial explanation)</p>",
        "id": 510620999,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744020766
    },
    {
        "content": "<p>Sorry, I'm not sure what you mean by <code>ofNat()</code>. Looking at the documentation of <code>OfNat</code> it only makes a reference to the macro <code>nat_lit</code>, but it doesn't seem possible to use it in my theorem <code>Fin.val_ofNat</code>.</p>",
        "id": 510632352,
        "sender_full_name": "Ayhon",
        "timestamp": 1744023790
    },
    {
        "content": "<p>Nevermind, found the macro you referred to in Mathlib.<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/blob/ce412ec13b32cf08820842e2ec234161d6dbd5d2/Mathlib/Tactic/OfNat.lean#L8\">https://github.com/leanprover-community/mathlib4/blob/ce412ec13b32cf08820842e2ec234161d6dbd5d2/Mathlib/Tactic/OfNat.lean#L8</a></p>",
        "id": 510634056,
        "sender_full_name": "Ayhon",
        "timestamp": 1744024193
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690100\">Ayhon</span> has marked this topic as resolved.</p>",
        "id": 510639235,
        "sender_full_name": "Notification Bot",
        "timestamp": 1744025474
    },
    {
        "content": "<p>For posteriority, what the <code>ofNat()</code> is doing is wrapping the call <code>OfNat.ofNat</code> with <code>no_index</code>, so that it plays nicely with <code>simp</code>, which was the issue I was encountering.</p>\n<p>The final version of the theorem I was working with was</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val_ofNat</span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]{</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n<span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ofNat</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instOfNat</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which is just a convenient way of writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">val_ofNat</span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]{</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n<span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">no_index</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instOfNat</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 510645977,
        "sender_full_name": "Ayhon",
        "timestamp": 1744027063
    },
    {
        "content": "<p>this <em>might</em> still have issues when the nat specifically is <code>1</code>? usually these lemmas have a <code>[n.AtLeastTwo]</code> assumption, although i'm not sure why...</p>",
        "id": 510683322,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744035108
    },
    {
        "content": "<p>This one specifically works because of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instOfNat#doc\">docs#Fin.instOfNat</a></p>",
        "id": 510684097,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744035251
    },
    {
        "content": "<p>Ping me if you want more in-depth explanations</p>",
        "id": 510684164,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744035266
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, I'd love a more in-depth explanation, but at your leissure. I am no longer blocked by this issue. </p>\n<p>What's the problem with <code>ofNat(1)</code>? Why is <code>AtLeastTwo</code> sometimes needed?</p>",
        "id": 510684839,
        "sender_full_name": "Ayhon",
        "timestamp": 1744035408
    },
    {
        "content": "<p>For a type with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NatCast#doc\">docs#NatCast</a>, there are separate instances for zero, one, and everything else.</p>",
        "id": 510701193,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744039233
    }
]