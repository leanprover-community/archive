[
    {
        "content": "<p>I am designing a custom tactic within which I invoke existing tactics. I wish to add a timeout to these tactics individually, such that if tactic A fails or times out within, say, 100000 heartbeats, then I try tactic B. Is there a way to create such a custom tactic?</p>\n<p>My current implementation is as shown below, but it seems to be buggy</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">salImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Helper function to run tactic with timeout</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">runWithTimeout</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"bp\">.</span><span class=\"n\">setNat</span><span class=\"w\"> </span><span class=\"ss\">`maxHeartbeats</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Try strategy 1: dsimp + grind</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"n\">runWithTimeout</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Try strategy 2: blaster</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">runWithTimeout</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">blaster</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 569972390,
        "sender_full_name": "Pranav cs22b015",
        "timestamp": 1769365516
    },
    {
        "content": "<p>Heartbeat timeouts cannot be caught with ordinary try catch statements (on purpose). You need to wrap your computation in <code>tryCatchRuntimeEx</code></p>",
        "id": 569973049,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1769366113
    },
    {
        "content": "<p>Thanks, have updated the code to this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">salImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Helper function to run tactic with timeout, fails if goals remain</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">runAndCheck</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">savedState</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">    </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"bp\">.</span><span class=\"n\">setNat</span><span class=\"w\"> </span><span class=\"ss\">`maxHeartbeats</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getGoals</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"sal: {name} succeeded\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">savedState</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"goals remain\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tac1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">blaster</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Try strategy 1: dsimp</span>\n<span class=\"w\">  </span><span class=\"n\">tryCatchRuntimeEx</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">runAndCheck</span><span class=\"w\"> </span><span class=\"n\">tac1</span><span class=\"w\"> </span><span class=\"s2\">\"Strategy 1 (dsimp &lt;;&gt; grind)\"</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Try strategy 2: blaster</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">runAndCheck</span><span class=\"w\"> </span><span class=\"n\">tac2</span><span class=\"w\"> </span><span class=\"s2\">\"Strategy 2 (blaster)\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But, this is still unreliable. It sometimes fails with the <code>(kernel) deterministic timeout</code> error, instead of trying out the next strategy. Any suggestions/fixes?</p>",
        "id": 570034036,
        "sender_full_name": "Pranav cs22b015",
        "timestamp": 1769416671
    }
]