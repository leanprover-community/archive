[
    {
        "content": "<blockquote>\n<p>chore(Data/Int/Defs): clear out Init/Data/Int/Basic <a href=\"https://github.com/leanprover-community/mathlib4/pull/14759\">#14759</a></p>\n</blockquote>\n<p>In this PR <code>lake build</code> just hangs, whereas <code>lake exe cache clean</code> aborts with a stack overflow...<br>\nWhat is going on?</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span></p>",
        "id": 451550603,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721062535
    },
    {
        "content": "<p>I think it's been a loop in the import graph when I've had those symptoms</p>",
        "id": 451573239,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721066043
    },
    {
        "content": "<p>Lake should be capable of detecting import loops afaik</p>",
        "id": 451573580,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721066107
    },
    {
        "content": "<p>\"should\" or \"is\"? :)</p>",
        "id": 451584175,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721067876
    },
    {
        "content": "<p>Looks like my diagnosis was correct</p>",
        "id": 451586591,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721068291
    },
    {
        "content": "<p>If not Lake, it wouldn't be too hard to upgrade <code>cache</code> to detect cyclic dependencies before blowing up the stack by keeping track of a <code>visited</code> data structure in the hashing routine</p>",
        "id": 451592400,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1721069287
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/113488-general/topic/lake.20stack.20overflow/near/451584175\">said</a>:</p>\n<blockquote>\n<p>\"should\" or \"is\"? :)</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">Lake</span><span class=\"bp\">/</span><span class=\"n\">Build</span><span class=\"bp\">/</span><span class=\"n\">Fetch</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"sd\">/-- A recursive build of a Lake build store that may encounter a cycle. -/</span>\n<span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">Lake</span><span class=\"bp\">/</span><span class=\"n\">Build</span><span class=\"bp\">/</span><span class=\"n\">Fetch</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"sd\">/-- Log build cycle and error. -/</span>\n<span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">Lake</span><span class=\"bp\">/</span><span class=\"n\">Build</span><span class=\"bp\">/</span><span class=\"n\">Fetch</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">buildCycleError</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cycle</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cycle</span><span class=\"w\"> </span><span class=\"n\">BuildKey</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">Lake</span><span class=\"bp\">/</span><span class=\"n\">Build</span><span class=\"bp\">/</span><span class=\"n\">Fetch</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"build cycle detected:</span><span class=\"se\">\\n</span><span class=\"s2\">{\"</span><span class=\"bp\">\\</span><span class=\"n\">n</span><span class=\"s2\">\".intercalate &lt;| cycle.map (s!\"</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"bp\">·</span><span class=\"o\">}</span><span class=\"s2\">\")}\"</span>\n</code></pre></div>\n<p>is</p>",
        "id": 451593817,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721069535
    },
    {
        "content": "<p>I wonder what Johan ran into, then</p>",
        "id": 451594272,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721069614
    },
    {
        "content": "<p>Does it catch a file importing itself directly?</p>",
        "id": 451594349,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1721069630
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> ?</p>",
        "id": 451594472,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1721069646
    },
    {
        "content": "<p>Yes, Lake does catch a file importing itself. There is even <a href=\"https://github.com/leanprover/lean4/blob/873ef2d894af80d8fc672e35f7e28bae314a1f6f/src/lake/tests/badImport/test.sh#L19\">a test</a> for that. Lake should be incapable of looping. However, it has been observed that a <code>lake build</code> of Mathlib can hang with improper imports (though this does not happen if smaller subsets of Mathlib with the bad import are built). I have yet to figure out why.</p>",
        "id": 451597089,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721070078
    },
    {
        "content": "<p>This example has given me some ideas, though, so I will take a look again.</p>",
        "id": 451598552,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721070322
    },
    {
        "content": "<p>Sadly, my idea did not bear fruit. :-(</p>",
        "id": 451672770,
        "sender_full_name": "Mac Malone",
        "timestamp": 1721100007
    }
]