[
    {
        "content": "<p>I am writing a macro that looks like the following, where I have some function <code>foo</code> that takes a proof and another argument:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">      </span><span class=\"n\">first</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">tactic_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg_1</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">tactic_2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg_2</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">tactic_3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg_3</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Now, <code>tactic_1</code> and <code>tactic_2</code> and so on all have some duplicated work; in particular they do a <code>simp</code> step at the beginning of the tactic, and this simplification is getting thrown away after each branch of the <code>first</code> if the branch fails. I'd like to factor this out and do the simplification one time without throwing away the results. In particular, I'd like to refactor this tactic to look like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">first</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tactic_1</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tactic_2</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tactic_3</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"w\">      </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg_n</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>Where the <code>arg_n</code> is chosen to match the tactic that was applied (e.g. <code>tactic_1</code> would result in <code>arg_1</code>, etc). This seems to require the ability to \"remember\" which tactic was chosen by <code>first</code>. Does anybody know if this is feasible at all?</p>",
        "id": 533111072,
        "sender_full_name": "Daniel Sainati",
        "timestamp": 1754489076
    },
    {
        "content": "<p>Can you do <code>apply foo; simp</code> and then write a <code>first</code> that operates on the two goals?</p>\n<p>For robustness, you could use named metavariables, like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">arg</span>\n<span class=\"n\">case'</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"n\">first</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">tactic_1</span>\n<span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">arg_1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">tactic_2</span>\n<span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">arg_2</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 533123640,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754492878
    },
    {
        "content": "<p>hmm, this seems like it should work, but for some reason Lean doesn't like it. To be a bit more specific, my <code>arg</code>s are not always just values, in particular the original tactic often looks something like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">tactic_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg_1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>which generates two subgoals, one for each of the <code>_</code>s. </p>\n<p>If I change this to be </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">arg</span>\n<span class=\"n\">case'</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">tactic_1</span>\n<span class=\"n\">case'</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">arg_1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>lean complains that <code>arg_1</code> does not match the type of the goal</p>",
        "id": 533143541,
        "sender_full_name": "Daniel Sainati",
        "timestamp": 1754498523
    },
    {
        "content": "<p>Two thoughts:</p>\n<ul>\n<li>Maybe you need <code>case' arg =&gt; apply arg_1</code> to come before <code>case pf =&gt; tactic_1</code>, since the tactic might be filling in metavariables in an incompatible way</li>\n<li>Maybe <code>refine arg_1 ?_ ?_</code> would work better, in case there are metavariables in the goal itself. The <code>refine</code> tactic is able to assign them, where <code>apply</code> avoids it.</li>\n</ul>",
        "id": 533147987,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754500130
    },
    {
        "content": "<p>It's hard to say much more without a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>",
        "id": 533148058,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754500155
    },
    {
        "content": "<p>Applying the <code>arg</code> case first worked! Thanks so much</p>",
        "id": 533153403,
        "sender_full_name": "Daniel Sainati",
        "timestamp": 1754502512
    }
]