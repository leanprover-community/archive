[
    {
        "content": "<p>Hi everyone! I'm trying to override the arithmetic operations on <code>Int32</code> with an addition that can fail on overflow. I've defined an instance of <code>HAdd Int32 Int32 (MyOption Int32)</code> where <code>MyOption</code> is a custom option monad. However, I cannot get the following to work :   </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"c1\">-- simplified for the example</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">low</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- error : type mismatch</span>\n</code></pre></div>\n<p>Is there a way to use types to guide inference, so I can have <code>+</code> be the normal plus when used without annotations, and my custom <code>HAdd</code> instance when used with annotation ?<br>\nSorry if a similar question was already answered somewhere, I could not find the answer reading the doc, and I'm still a Lean newbie.</p>",
        "id": 530847373,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1753476955
    },
    {
        "content": "<p>no, this is not supported</p>",
        "id": 530848046,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753477289
    },
    {
        "content": "<p>For this to work the output of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=HAdd#doc\">docs#HAdd</a> would have to be a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=semiOutParam#doc\">docs#semiOutParam</a></p>",
        "id": 530848157,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753477342
    },
    {
        "content": "<p>In the definition of <code>HAdd</code>, the result type is declared as an <code>outParam</code>. In other words, the result type needs to be uniquely determined by the input types. If this is not the case, weird stuff can occur. You might be able to solve this using a coercion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">some</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>You can even be very specific:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeDep</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 530848259,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753477385
    },
    {
        "content": "<p>Hum... Thank you for your answers! Alternatively, is there a way  to write <code>x + y</code> (using the <code>+</code> notation) but specify the instance I want to use ?</p>",
        "id": 530850852,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1753478634
    },
    {
        "content": "<p>No you can't use notation for this, you'd need <code>#check (@HAdd.hAdd _ _ _  instHAddInt32MyOption x y : MyOption Int32)</code>; but don't; this will likely cause issues later. Coercions are probably a better solution</p>",
        "id": 530852889,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753479695
    },
    {
        "content": "<p>Coercions don't really work here though</p>",
        "id": 530853507,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753480061
    },
    {
        "content": "<p>Ok, that's unfortunate. Indeed coercions won't work here because the  addition I want to define might return none. I've updated the code snippet of my original question to reflect that</p>",
        "id": 530853966,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1753480325
    },
    {
        "content": "<p>Just to clarify, this doesn't work?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"bp\">.</span><span class=\"n\">addInt32</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toInt</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toInt</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">toInt</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeDep</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyOption</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">addInt32</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>Then you could try scoped notation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">MyOption</span><span class=\"bp\">.</span><span class=\"n\">addInt32</span>\n</code></pre></div>\n<p>or just resort to function application</p>",
        "id": 530854578,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753480669
    },
    {
        "content": "<p>That looks terrible</p>",
        "id": 530854725,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753480758
    },
    {
        "content": "<p>Hmm you're right function application is probably your best solution</p>",
        "id": 530918749,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753521154
    },
    {
        "content": "<p>By function application, you mean dropping the notation ?</p>\n<p>I would be fine with overriding the usual meaning of <code>+</code> with my own, and using <code>Int32.add</code> everywhere else, but the issue I have is that theorems like <code>Int32.toBitVec_add</code> stops working (hence, breaking <code>bv_decide</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"n\">Int32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">41</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int32</span><span class=\"bp\">.</span><span class=\"n\">eq_iff_toBitVec_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"bp\">.</span><span class=\"n\">toBitVec_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">bv_decide</span>\n</code></pre></div>\n<p>(this worked without my custom instance and using <code>+</code>)</p>",
        "id": 531195847,
        "sender_full_name": "Clément Blaudeau",
        "timestamp": 1753643478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Typeclass.20inference.20and.20priority/near/530848157\">said</a>:</p>\n<blockquote>\n<p>For this to work the output of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=HAdd#doc\">docs#HAdd</a> would have to be a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=semiOutParam#doc\">docs#semiOutParam</a></p>\n</blockquote>\n<p>Even if it were a semiOutParam, it wouldn't work because <code>+</code> uses the <code>binop%</code> elaborator, and that assumes that <code>+</code> wants to be homogeneous, with some support for heterogeneity in the inputs, not outputs.</p>",
        "id": 531196639,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753643795
    }
]