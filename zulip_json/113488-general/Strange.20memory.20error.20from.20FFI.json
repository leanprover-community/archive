[
    {
        "content": "<p>Help needed!</p>\n<p>I was still working on a hashset/hashmap binding to lean: <a href=\"https://github.com/SchrodingerZhu/hashbrown4lean\">https://github.com/SchrodingerZhu/hashbrown4lean</a></p>\n<p>The idea was to check and ensure the exclusivity of an <code>lean_external_object</code> whenever a mutation happens. However, I run into segfault with this approach. I have reduced the code to an example that does nothing but check and ensure the exclusivity:</p>\n<p>In Rust,</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[no_mangle]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">lean_hashbrown_test</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">obj</span>: <span class=\"nc\">lean_obj_arg</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_hash</span>: <span class=\"kt\">u64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_target</span>: <span class=\"nc\">lean_obj_arg</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_eq_closure</span>: <span class=\"nc\">lean_obj_arg</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_hash_closure</span>: <span class=\"nc\">lean_obj_arg</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">lean_obj_res</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"test invoked\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">exlusive_hashset</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">obj</span>\n<span class=\"p\">}</span>\n<span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">exlusive_hashset</span><span class=\"p\">(</span><span class=\"n\">set</span>: <span class=\"nc\">lean_obj_arg</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">lean_obj_res</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">lean_is_exclusive</span><span class=\"p\">(</span><span class=\"n\">set</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"target is exclusive: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">set</span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"target is not exclusive: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">inner</span>: <span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get_data_from_external</span><span class=\"p\">(</span><span class=\"n\">set</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">cloned</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Box</span>::<span class=\"n\">into_raw</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">((</span><span class=\"o\">*</span><span class=\"n\">inner</span><span class=\"p\">).</span><span class=\"n\">clone</span><span class=\"p\">()));</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">new_set</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_external</span><span class=\"p\">(</span><span class=\"n\">HASHSET_CLASS</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">cloned</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">c_void</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"new set: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">new_set</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">inner</span><span class=\"p\">).</span><span class=\"n\">iter</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">lean_inc</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">as_ref</span><span class=\"p\">());</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"n\">lean_dec_ref</span><span class=\"p\">(</span><span class=\"n\">set</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">new_set</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>In lean:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">opaque</span> <span class=\"n\">HashSetPointed</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">NonemptyType</span>\n<span class=\"kd\">def</span> <span class=\"n\">HashSet</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">HashSetPointed</span> <span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Nonempty</span> <span class=\"o\">(</span><span class=\"n\">HashSet</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"n\">HashSetPointed</span> <span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kd\">@[extern \"lean_hashbrown_hashset_len\"]</span>\n<span class=\"n\">opaque</span> <span class=\"n\">HashSet.len</span> <span class=\"o\">:</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"bp\">→</span> <span class=\"bp\">@&amp;</span> <span class=\"n\">HashSet</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">USize</span>\n\n<span class=\"kd\">@[extern \"lean_hashbrown_hashset_create\"]</span>\n<span class=\"n\">opaque</span> <span class=\"n\">HashSet.mk</span> <span class=\"o\">:</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span> <span class=\"bp\">→</span> <span class=\"n\">HashSet</span> <span class=\"n\">α</span>\n\n<span class=\"kd\">@[extern \"lean_hashbrown_test\"]</span>\n<span class=\"kn\">private</span> <span class=\"n\">opaque</span> <span class=\"n\">HashSet.test</span> <span class=\"o\">:</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">}</span>\n  <span class=\"bp\">→</span> <span class=\"n\">HashSet</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">UInt64</span> <span class=\"bp\">→</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"bp\">@&amp;</span><span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">Bool</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"bp\">@&amp;</span><span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">UInt64</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">HashSet</span> <span class=\"n\">α</span>\n\n<span class=\"kd\">@[extern \"lean_hashbrown_register_hashset_class\"]</span>\n<span class=\"kn\">private</span> <span class=\"n\">opaque</span> <span class=\"n\">registerHashSetClass</span> <span class=\"o\">:</span> <span class=\"n\">IO</span> <span class=\"n\">PUnit</span>\n\n<span class=\"kd\">@[extern \"lean_hashbrown_register_hashset_iter_class\"]</span>\n<span class=\"kn\">private</span> <span class=\"n\">opaque</span> <span class=\"n\">registerHashSetIterClass</span> <span class=\"o\">:</span> <span class=\"n\">IO</span> <span class=\"n\">PUnit</span>\n\n<span class=\"kd\">@[init]</span>\n<span class=\"kn\">private</span> <span class=\"kd\">def</span> <span class=\"n\">initModule</span> <span class=\"o\">:</span> <span class=\"n\">IO</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n <span class=\"n\">registerHashSetClass</span>\n <span class=\"n\">registerHashSetIterClass</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">main</span> <span class=\"o\">:</span> <span class=\"n\">IO</span> <span class=\"n\">Unit</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n  <span class=\"k\">let</span> <span class=\"n\">set</span> <span class=\"o\">:</span> <span class=\"n\">HashSet</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"n\">HashSet.mk</span>\n  <span class=\"k\">let</span> <span class=\"n\">hash</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n  <span class=\"k\">let</span> <span class=\"n\">target</span> <span class=\"o\">:=</span> <span class=\"mi\">1</span>\n  <span class=\"k\">let</span> <span class=\"n\">check</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">x</span> <span class=\"bp\">==</span> <span class=\"mi\">1</span>\n  <span class=\"k\">let</span> <span class=\"n\">hashFn</span> <span class=\"o\">:=</span> <span class=\"bp\">λ</span> <span class=\"n\">x</span> <span class=\"bp\">=&gt;</span> <span class=\"mi\">1</span>\n  <span class=\"k\">let</span> <span class=\"n\">set</span> <span class=\"o\">:=</span> <span class=\"n\">set.test</span> <span class=\"n\">hash</span> <span class=\"n\">target</span> <span class=\"n\">check</span> <span class=\"n\">hashFn</span>\n  <span class=\"n\">IO.println</span> <span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"Hello, {set.len}!\"</span>\n</code></pre></div>\n<p>Yet, it still crashes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">❯</span>  <span class=\"bp\">./</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">swisstable</span>\n<span class=\"n\">lean_set_st_header</span><span class=\"o\">(</span><span class=\"mi\">0x7fe686cd6f38</span><span class=\"o\">,</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_set_st_header</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">128</span><span class=\"o\">:</span><span class=\"mi\">71</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_ctor</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">145</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_io_result_mk_ok</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">151</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_register_hashset_class</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">103</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">l___private_Main_0__initModule</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">initialize_Main</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">8</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">9</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">lean_set_st_header</span><span class=\"o\">(</span><span class=\"mi\">0x7fe686cd6f38</span><span class=\"o\">,</span> <span class=\"mi\">0</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_set_st_header</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">128</span><span class=\"o\">:</span><span class=\"mi\">71</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_ctor</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">145</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_io_result_mk_ok</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">151</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_register_hashset_iter_class</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">110</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">initialize_Main</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">8</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">lean_alloc_small_object</span><span class=\"o\">(</span><span class=\"n\">sz</span><span class=\"o\">:</span> <span class=\"mi\">24</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_small_object</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">163</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_external</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">177</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_hashset_create</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">52</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">initialize_Main</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">lean_set_st_header</span><span class=\"o\">(</span><span class=\"mi\">0x7fe686cd6f38</span><span class=\"o\">,</span> <span class=\"mi\">254</span><span class=\"o\">,</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_set_st_header</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">128</span><span class=\"o\">:</span><span class=\"mi\">71</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_external</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">178</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_hashset_create</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">52</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">initialize_Main</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">hashset_foreach</span><span class=\"o\">(</span><span class=\"mi\">0x5576de6423d0</span><span class=\"o\">,</span> <span class=\"mi\">0x7fe686cd6f20</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">set</span><span class=\"o\">::</span><span class=\"n\">hashset_foreach</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"o\">:</span><span class=\"mi\">53</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_mark_persistent</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">initialize_Main</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">lean_dec_ref</span><span class=\"o\">(</span><span class=\"mi\">0x7fe686cd6f20</span><span class=\"o\">),</span> <span class=\"n\">m_rc</span> <span class=\"bp\">=</span> <span class=\"mi\">1</span>\n<span class=\"n\">test</span> <span class=\"n\">invoked</span>\n<span class=\"n\">target</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">exclusive</span><span class=\"o\">:</span> <span class=\"mi\">0x7fe686cd6f38</span>\n<span class=\"n\">lean_alloc_small_object</span><span class=\"o\">(</span><span class=\"n\">sz</span><span class=\"o\">:</span> <span class=\"mi\">24</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_small_object</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">163</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_external</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">177</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">set</span><span class=\"o\">::</span><span class=\"n\">exlusive_hashset</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">139</span><span class=\"o\">:</span><span class=\"mi\">23</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_test</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">281</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">_lean_main</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">8</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">lean_set_st_header</span><span class=\"o\">(</span><span class=\"mi\">0x7fe686cd6f09</span><span class=\"o\">,</span> <span class=\"mi\">254</span><span class=\"o\">,</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n   <span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_set_st_header</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">128</span><span class=\"o\">:</span><span class=\"mi\">71</span>\n   <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">ffi</span><span class=\"o\">::</span><span class=\"n\">lean_alloc_external</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">178</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n   <span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown</span><span class=\"o\">::</span><span class=\"n\">set</span><span class=\"o\">::</span><span class=\"n\">exlusive_hashset</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">139</span><span class=\"o\">:</span><span class=\"mi\">23</span>\n   <span class=\"mi\">3</span><span class=\"o\">:</span> <span class=\"n\">lean_hashbrown_test</span>\n             <span class=\"n\">at</span> <span class=\"bp\">./</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">set.rs</span><span class=\"o\">:</span><span class=\"mi\">281</span><span class=\"o\">:</span><span class=\"mi\">15</span>\n   <span class=\"mi\">4</span><span class=\"o\">:</span> <span class=\"n\">_lean_main</span>\n   <span class=\"mi\">5</span><span class=\"o\">:</span> <span class=\"n\">main</span>\n   <span class=\"mi\">6</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_call_main</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">sysdeps</span><span class=\"bp\">/</span><span class=\"n\">nptl</span><span class=\"bp\">/</span><span class=\"n\">libc_start_call_main.h</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"o\">:</span><span class=\"mi\">16</span>\n   <span class=\"mi\">7</span><span class=\"o\">:</span> <span class=\"n\">__libc_start_main_impl</span>\n             <span class=\"n\">at</span> <span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">glibc</span><span class=\"bp\">/</span><span class=\"n\">csu</span><span class=\"bp\">/../</span><span class=\"n\">csu</span><span class=\"bp\">/</span><span class=\"n\">libc</span><span class=\"bp\">-</span><span class=\"n\">start.c</span><span class=\"o\">:</span><span class=\"mi\">360</span><span class=\"o\">:</span><span class=\"mi\">3</span>\n   <span class=\"mi\">8</span><span class=\"o\">:</span> <span class=\"n\">_start</span>\n\n<span class=\"n\">thread</span> <span class=\"bp\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"bp\">&gt;'</span> <span class=\"n\">panicked</span> <span class=\"n\">at</span> <span class=\"bp\">'</span><span class=\"n\">misaligned</span> <span class=\"n\">pointer</span> <span class=\"n\">dereference</span><span class=\"o\">:</span> <span class=\"n\">address</span> <span class=\"n\">must</span> <span class=\"n\">be</span> <span class=\"n\">a</span> <span class=\"n\">multiple</span> <span class=\"n\">of</span> <span class=\"mi\">0x4</span> <span class=\"n\">but</span> <span class=\"n\">is</span> <span class=\"mi\">0x7fe686cd6f09</span><span class=\"bp\">'</span><span class=\"o\">,</span> <span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">ffi.rs</span><span class=\"o\">:</span><span class=\"mi\">129</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n<span class=\"n\">note</span><span class=\"o\">:</span> <span class=\"n\">run</span> <span class=\"k\">with</span> <span class=\"bp\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"bp\">`</span> <span class=\"n\">environment</span> <span class=\"kd\">variable</span> <span class=\"n\">to</span> <span class=\"n\">display</span> <span class=\"n\">a</span> <span class=\"n\">backtrace</span>\n<span class=\"n\">thread</span> <span class=\"n\">caused</span> <span class=\"n\">non</span><span class=\"bp\">-</span><span class=\"n\">unwinding</span> <span class=\"n\">panic.</span> <span class=\"n\">aborting.</span>\n</code></pre></div>\n<p>Details are committed to the repo.</p>",
        "id": 384809441,
        "sender_full_name": "Schrodinger ZHU Yifan",
        "timestamp": 1692025323
    },
    {
        "content": "<p>Ok, I found the problem!</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"w\">                    </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lean_alloc_closure</span><span class=\"p\">((</span><span class=\"kt\">void</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">mark_persistent_fn</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">                    </span><span class=\"n\">lean_to_external</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">m_class</span><span class=\"o\">-&gt;</span><span class=\"n\">m_foreach</span><span class=\"p\">(</span><span class=\"n\">lean_to_external</span><span class=\"p\">(</span><span class=\"n\">o</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">m_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"p\">);</span>\n<span class=\"w\">                    </span><span class=\"n\">lean_dec</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">);</span>\n<span class=\"w\">                    </span><span class=\"k\">break</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>it is assumed that foreach accepts <code>@&amp; Fn</code>. I did not notice that and corrupted the heap.</p>",
        "id": 384814031,
        "sender_full_name": "Schrodinger ZHU Yifan",
        "timestamp": 1692026146
    }
]