[
    {
        "content": "<p>I'm trying to make a deriving handler for structures that will (among other things) generate an initializer, so it needs to create a <a href=\"https://lean-lang.org/doc/reference/latest/The-Type-System/Inductive-Types/#structure-constructors\">structure constructor</a> <code>{ a := foo, b := bar, }</code> etc. My attempt looks like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">deriveByteableOne</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">structName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StructureInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">initializerTerms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">fieldInfo</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">fieldInfo</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">initializerTerms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">initializerTerms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">structInstField</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">fieldInfo</span><span class=\"bp\">.</span><span class=\"n\">fieldName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foobarNotImportart</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyTypeClass</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">structName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">      </span><span class=\"n\">initializer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">initializerTerms</span><span class=\"o\">:</span><span class=\"n\">structInstField</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">default</span>\n</code></pre></div>\n<p>but it complains:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>overloaded, errors\n  38:78 application type mismatch\n    Parser.mkIdent fieldInfo.fieldName\n  argument\n    fieldInfo.fieldName\n  has type\n    Name : Type\n  but is expected to have type\n    SourceInfo : Type\n\n  type mismatch\n    Lean.mkIdent fieldInfo.fieldName\n  has type\n    Ident : Type\n  but is expected to have type\n    TSyntax `Lean.Parser.Term.structInstLVal : Type\n</code></pre></div>\n<p>but if I'm reading <a href=\"https://github.com/leanprover/lean4/blob/045d07d2349b9989278991fbcd79a6430032930d/src/Lean/Parser/Term.lean#L492-L494\">the source</a> correctly, <code>structInstLVal</code> can be an ident. What am I missing here?</p>",
        "id": 512202099,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744679902
    },
    {
        "content": "<p>Lol, I figured it out. After a careful re-read of <a href=\"https://lean-lang.org/doc/reference/latest/Notations-and-Macros/Macros/#quasiquotation\">https://lean-lang.org/doc/reference/latest/Notations-and-Macros/Macros/#quasiquotation</a> I realize I need to have <code>:ident</code> tacked on the end,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">structInstField</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">fieldInfo</span><span class=\"bp\">.</span><span class=\"n\">fieldName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foobarNotImportart</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">structInstField</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">fieldInfo</span><span class=\"bp\">.</span><span class=\"n\">fieldName</span><span class=\"o\">):</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foobarNotImportart</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 512202760,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744680282
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"898940\">Shelvacu</span> has marked this topic as resolved.</p>",
        "id": 512202769,
        "sender_full_name": "Notification Bot",
        "timestamp": 1744680294
    },
    {
        "content": "<p>curse of the question asker, always figuring it out right after I ask...</p>",
        "id": 512202810,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744680319
    }
]