[
    {
        "content": "<p>For some reason, <code>lake exe cache get</code> is off-late upgrading my toolchain. This is an issue because until now, if I did not like or want a toolchain upgrade, all I had to do was change the lean-toolchain file, and remove the manifest file and build folder. Calling <code>lake exe cache get</code> would simply get the mathlib cache of that toolchain.</p>",
        "id": 507101290,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518067
    },
    {
        "content": "<p>How do I compel <code>cache</code> to not update the toolchain</p>",
        "id": 507101343,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518084
    },
    {
        "content": "<p>These are the lines in the output of <code>lake exe cache get</code> show that cache is indeed updating the toolchain:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n</code></pre></div>",
        "id": 507101813,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518331
    },
    {
        "content": "<p>In a way that makes the <code>cache get</code> command redundant since, <code>lake update</code> does the same thing. I currently just want to get the cache for the toolchain I set.</p>",
        "id": 507101867,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518368
    },
    {
        "content": "<p>Can you point us to a repro? i.e. a commit of some repository where <code>lake exe cache get</code> has this behaviour?</p>",
        "id": 507101921,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742518410
    },
    {
        "content": "<p>clone equational theories.</p>",
        "id": 507101941,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518426
    },
    {
        "content": "<p>then try lake update and it will fail to build. Delete <code>./.lake</code>, <code>lake-manifest.json</code> and change <code>lean-toolchain</code> to <code>v4.14.0-rc3</code> ( which is what I want to revert to).</p>",
        "id": 507102063,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518474
    },
    {
        "content": "<p>run <code>lake exe cache get</code></p>",
        "id": 507102073,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518482
    },
    {
        "content": "<p>Oh, that is ancient. :-)</p>",
        "id": 507102241,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742518577
    },
    {
        "content": "<p>Yeah, but the non-updating behaviour has been around for at least a year if not more. Why would 4.14.0-rc3 be different?</p>",
        "id": 507102314,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518629
    },
    {
        "content": "<p>Here's a  partial command transcript:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Rf</span><span class=\"w\"> </span><span class=\"bp\">./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">nano</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc3</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">manifest</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"n\">rm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">manifest</span><span class=\"bp\">.</span><span class=\"n\">json'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">equational_theories</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">manifest</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">creating</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">scratch</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"n\">b489cdbe4bc57a6acdddb9a5dc5699acacdecdd'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checkdecls</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">PatrickMassot</span><span class=\"bp\">/</span><span class=\"n\">checkdecls</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n<span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 507102425,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742518684
    },
    {
        "content": "<p>Interestingly, if I don't try the whole update attempt (meaning I run <code>lake exe cache get</code> on a fresh clone from github), this update step doesn't happen</p>",
        "id": 507103229,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742519142
    },
    {
        "content": "<p>I don't think deleting the manifest is a supported workflow?</p>",
        "id": 507105147,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520326
    },
    {
        "content": "<p>Not deleting the manifest means that lake downloads the commits of the dependencies recorded in it</p>",
        "id": 507105249,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520370
    },
    {
        "content": "<p>Yes, that is how it is supposed to work</p>",
        "id": 507105282,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520393
    },
    {
        "content": "<p>which means when I am downgrading, the manifest will make lake download invalid versions</p>",
        "id": 507105318,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520413
    },
    {
        "content": "<p>lake update can downgrade too</p>",
        "id": 507105387,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520449
    },
    {
        "content": "<p>In any case \"delete manifest and ./.lake\" has been the default nuclear option if <code>lake cache</code> or <code>lake update</code> fails</p>",
        "id": 507105417,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520467
    },
    {
        "content": "<p>It has always worked well for me</p>",
        "id": 507105433,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520475
    },
    {
        "content": "<p>and deleting the manifest has not caused cache to automatically update toolchains in the past</p>",
        "id": 507105498,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520495
    },
    {
        "content": "<p>\"nukes have always worked for me, says user struggling with nuclear fallout\" is not the best stance...</p>",
        "id": 507105551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520528
    },
    {
        "content": "<p>point is, this behaviour has changed.</p>",
        "id": 507105586,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520550
    },
    {
        "content": "<p>What happens if you go back to a clean version and just change the mathlib tag in the lakefile, and do lake update?</p>",
        "id": 507105618,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520569
    },
    {
        "content": "<p>In this case, the last clean version was on toolchain v4.14.0-rc3</p>",
        "id": 507105798,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520643
    },
    {
        "content": "<p>So going back to that toolchain, the first step, is already the problem I am describing</p>",
        "id": 507105858,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520670
    },
    {
        "content": "<p>By \"clean\" I mean \"don't delete the manifest\"</p>",
        "id": 507105899,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520684
    },
    {
        "content": "<p>And also, don't edit the toolchain. Only edit the lakefile</p>",
        "id": 507106021,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520740
    },
    {
        "content": "<p><code>rror: ././.lake/packages/mathlib: revision not found 'v4.14.0-rc3'</code></p>",
        "id": 507106053,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520763
    },
    {
        "content": "<p>Ok, so pick a revision that exists</p>",
        "id": 507106079,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520779
    },
    {
        "content": "<p>You can either go though the mathlib history and pick a commit SHA, or pick something more stable like the non-rc version</p>",
        "id": 507106149,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520822
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Dependency</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"w\">  </span><span class=\"n\">Project</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n\n<span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">project's</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"n\">Mathlib's</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">achieved</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">copying</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">`././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/././</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span>\n<span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"ss\">`lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">project</span>\n<span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`cp</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/././</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>",
        "id": 507106170,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520833
    },
    {
        "content": "<p>Is that after picking a git rev that exists?</p>",
        "id": 507106315,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520901
    },
    {
        "content": "<p>This method also used to work btww</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507106021\">said</a>:</p>\n<blockquote>\n<p>And also, don't edit the toolchain. Only edit the lakefile</p>\n</blockquote>\n<p>Didn't edit the toolchain in the above. Only <code>lakefile.toml</code></p>",
        "id": 507106321,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520903
    },
    {
        "content": "<p>I don't think toml files existed in 4.13.0, though I'm not certain</p>",
        "id": 507106370,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520940
    },
    {
        "content": "<p>yes. That's where this must come from : <code> Mathlib uses leanprover/lean4:v4.17.0</code></p>",
        "id": 507106379,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520945
    },
    {
        "content": "<p>this is v4.17.0</p>",
        "id": 507106390,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742520955
    },
    {
        "content": "<p>So you wrote 4.17.0 in the toml?</p>",
        "id": 507106459,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742520975
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"equational_theories\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"equational_theories\"</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">leanOptions</span><span class=\"o\">]</span>\n<span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">unicode</span><span class=\"bp\">.</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"n\">relaxedAutoImplicit</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.17.0\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"checkdecls\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/PatrickMassot/checkdecls.git\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"«doc-gen4»\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover/doc-gen4\"</span>\n</code></pre></div>",
        "id": 507106497,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521000
    },
    {
        "content": "<p>I only changed the <code>rev</code> of <code>mathlib</code></p>",
        "id": 507106517,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521016
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507106021\">said</a>:</p>\n<blockquote>\n<p>And also, don't edit the toolchain. Only edit the lakefile</p>\n</blockquote>\n<p>I'll refine this suggestion to \"only edit the toolchain if lake tells you to\"</p>",
        "id": 507106550,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521038
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507106550\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507106021\">said</a>:</p>\n<blockquote>\n<p>And also, don't edit the toolchain. Only edit the lakefile</p>\n</blockquote>\n<p>I'll refine this suggestion to \"only edit the toolchain if lake tells you to\"</p>\n</blockquote>\n<p>Having  done that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">restarting</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">via</span><span class=\"w\"> </span><span class=\"n\">Elan</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">updated</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"bp\">-</span><span class=\"n\">to</span><span class=\"bp\">-</span><span class=\"n\">date</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">post</span><span class=\"bp\">-</span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">hooks</span>\n<span class=\"n\">Dependency</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"w\">  </span><span class=\"n\">Project</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n</code></pre></div>",
        "id": 507106872,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521214
    },
    {
        "content": "<p>Can you give the full list of commands you ran, from a clean state?</p>",
        "id": 507106930,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521250
    },
    {
        "content": "<p>that's difficult</p>",
        "id": 507106945,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521261
    },
    {
        "content": "<p>Well in that case, can you make a fresh clone of the repo and trigger the same issue?</p>",
        "id": 507107003,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521301
    },
    {
        "content": "<p>Yes. I am currently showing you this issue on such a clone</p>",
        "id": 507107071,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521328
    },
    {
        "content": "<p>It's fine for your commands to include <code># edit the lakefile with blah</code></p>",
        "id": 507107079,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521339
    },
    {
        "content": "<p>Why is it hard to tell us the list of commands you ran? This is <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>, but for the command line instead of Lean</p>",
        "id": 507107163,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521394
    },
    {
        "content": "<p>The sequence is as I described above:</p>\n<ol>\n<li>Clone equational theories.</li>\n<li>Make a branch if you like</li>\n<li>run <code>lake update</code></li>\n<li>run <code>lake build</code> and it will almost certainly fail<br>\n(more coming up)</li>\n</ol>",
        "id": 507107210,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521420
    },
    {
        "content": "<p>That sequence doesn't mention modifying the lakefile, but you did modify it</p>",
        "id": 507107309,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521453
    },
    {
        "content": "<p>Please wait</p>\n<ol start=\"5\">\n<li>change <code>lean-toolchain</code> to <code>4.14.0-rc3</code></li>\n</ol>",
        "id": 507107336,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521468
    },
    {
        "content": "<ol start=\"6\">\n<li>delete lake-manifest and ./.lake</li>\n<li>run <code>lake exe cache get</code></li>\n</ol>",
        "id": 507107374,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521493
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507102425\">said</a>:</p>\n<blockquote>\n<p>Here's a  partial command transcript:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Rf</span><span class=\"w\"> </span><span class=\"bp\">./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">nano</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc3</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">manifest</span><span class=\"bp\">.</span><span class=\"n\">json</span>\n<span class=\"n\">rm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">manifest</span><span class=\"bp\">.</span><span class=\"n\">json'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">equational_theories</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">manifest</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">creating</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">scratch</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"n\">b489cdbe4bc57a6acdddb9a5dc5699acacdecdd'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checkdecls</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">PatrickMassot</span><span class=\"bp\">/</span><span class=\"n\">checkdecls</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n<span class=\"bp\">...</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This brings us up to this point</p>",
        "id": 507107424,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521514
    },
    {
        "content": "<p>This sequence has gone wrong in step 4, you should rewind to step 2</p>",
        "id": 507107462,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521536
    },
    {
        "content": "<p>equational theories doesn't build on 4.18.0-rc1. That's an entirely different issue</p>",
        "id": 507107553,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521572
    },
    {
        "content": "<p>Yes, but that told you that step 3 was a mistake</p>",
        "id": 507107589,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521601
    },
    {
        "content": "<p>I am simply trying to get my local repo back to 4.14.0-rc3 which is the last toolchain it passed CI on</p>",
        "id": 507107591,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521602
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507107589\">said</a>:</p>\n<blockquote>\n<p>Yes, but that told you that step 3 was a mistake</p>\n</blockquote>\n<p>Yes, but at that stage <code>lean-toolchain</code> had already changed to <code>v4.18.0-rc1</code></p>",
        "id": 507107659,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521638
    },
    {
        "content": "<p>Great, so undo it</p>",
        "id": 507107697,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521651
    },
    {
        "content": "<p>And the cache had been dowloaded</p>",
        "id": 507107721,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521664
    },
    {
        "content": "<p>for v4.18.0-rc1</p>",
        "id": 507107732,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521669
    },
    {
        "content": "<p>And it is in undoing it that i first tried steps 5 to 7</p>",
        "id": 507107818,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521692
    },
    {
        "content": "<p><code>git reset --hard</code> is your undo button</p>",
        "id": 507107873,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521721
    },
    {
        "content": "<p>My undo solution was simpler. To clone the repo and checkout the relevant PR branch again</p>",
        "id": 507107944,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521749
    },
    {
        "content": "<p>Sure, whatever. Did you then edit the lakefile from that clean state?</p>",
        "id": 507107999,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521773
    },
    {
        "content": "<p>No, because that repository was already in v4.14.0-rc3</p>",
        "id": 507108043,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521797
    },
    {
        "content": "<p>there was no need to downgrade it</p>",
        "id": 507108108,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521817
    },
    {
        "content": "<p>What did you do instead of step 3 above?</p>",
        "id": 507108153,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521848
    },
    {
        "content": "<p>My question is, how do I go back to 4.14.0-rc3 after an update to 4.18.0 without making a fresh clone or git reset</p>",
        "id": 507108154,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521850
    },
    {
        "content": "<p>You can't, because the information that told you exactly what 4.14.0rc3 meant was in the manifest you deleted / overwrote</p>",
        "id": 507108232,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521894
    },
    {
        "content": "<p>Previously, cleaning the manifest and build folder and fixing lean-toolchain or mathlib's revision did the trick</p>",
        "id": 507108234,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521896
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507108232\">said</a>:</p>\n<blockquote>\n<p>You can't, because the information that told you exactly what 4.14.0rc3 meant was in the manifest you deleted / overwrote</p>\n</blockquote>\n<p>that manifest was already overwritten by lake update</p>",
        "id": 507108270,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521918
    },
    {
        "content": "<p>Yes, I attribute the overwriting to you because you ran <code>lake update</code></p>",
        "id": 507108353,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742521951
    },
    {
        "content": "<p>yes</p>",
        "id": 507108362,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521959
    },
    {
        "content": "<p>So how do I get it back to the revisions of dependencies for v4.14.0-rc3?</p>",
        "id": 507108386,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742521981
    },
    {
        "content": "<p><code>git checkout pr-commit -- lake-manifest.json</code></p>",
        "id": 507108406,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522000
    },
    {
        "content": "<p>It used to be that lake would correctly regenerate a deleted manifest according to the toolchain  in lean-toolchain</p>",
        "id": 507108432,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522020
    },
    {
        "content": "<p>It is impossible for it to regenerate the same one you started with</p>",
        "id": 507108500,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522043
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507108406\">said</a>:</p>\n<blockquote>\n<p><code>git checkout pr-commit -- lake-manifest.json</code></p>\n</blockquote>\n<p>why do I need to tinker with manifests and pick them in the first place when I am downgrading?</p>",
        "id": 507108577,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522100
    },
    {
        "content": "<p>Which version of mathlib are you expecting lake to pick?</p>",
        "id": 507108621,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522131
    },
    {
        "content": "<p>When generating a fresh manifest for <code>&lt;insert toolchain&gt;</code> lake used to be able to pick the correct revisions.</p>",
        "id": 507108625,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522133
    },
    {
        "content": "<p>I know this because I have used this trick several times.</p>",
        "id": 507108644,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522148
    },
    {
        "content": "<p>Are you sure? I think it only ever picked the <em>newest</em> revisions (for the branch specified in the lakefile)</p>",
        "id": 507108704,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522164
    },
    {
        "content": "<p>This is indistinguishable from the \"correct\" revision if you're on the latest version already</p>",
        "id": 507108842,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522253
    },
    {
        "content": "<p>I have downgraded toolchains before.</p>",
        "id": 507109018,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522345
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507108621\">said</a>:</p>\n<blockquote>\n<p>Which version of mathlib are you expecting lake to pick?</p>\n</blockquote>",
        "id": 507109071,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522377
    },
    {
        "content": "<p>the version in the rev parameter of mathlib in lakefile?</p>",
        "id": 507109104,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522397
    },
    {
        "content": "<p>Step 8. I changed the rev of mathlib to \"v4.14.0-rc3\". Ran <code>lake exe cache get</code>. The toolchain file was not modified.</p>",
        "id": 507109259,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522439
    },
    {
        "content": "<p>I took your advice and created a fresh clone</p>",
        "id": 507109368,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/113488-general/topic/Running.20lake.20cache.20without.20updating.20the.20lean.20toolchain/near/507109104\">said</a>:</p>\n<blockquote>\n<p>the version in the rev parameter of mathlib in lakefile?</p>\n</blockquote>\n<p>Which is \"main\", right?</p>",
        "id": 507109374,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522485
    },
    {
        "content": "<p>Just now</p>",
        "id": 507109379,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522486
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mi\">1614</span><span class=\"w\">  </span><span class=\"n\">gh</span><span class=\"w\"> </span><span class=\"n\">repo</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">teorth</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span>\n<span class=\"w\"> </span><span class=\"mi\">1615</span><span class=\"w\">  </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">equational_theories</span><span class=\"bp\">/</span>\n<span class=\"w\"> </span><span class=\"mi\">1616</span><span class=\"w\">  </span><span class=\"n\">nano</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">toml</span>\n<span class=\"w\"> </span><span class=\"mi\">1617</span><span class=\"w\">  </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">update</span>\n<span class=\"w\"> </span><span class=\"mi\">1618</span><span class=\"w\">  </span><span class=\"n\">history</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n</code></pre></div>",
        "id": 507109415,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522511
    },
    {
        "content": "<p>In 1616, I modified <code>lakefile.toml</code> to add <code>rev=v4.17.0</code> for mathlib</p>",
        "id": 507109524,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522559
    },
    {
        "content": "<p>This is the result:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Dependency</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"w\">  </span><span class=\"n\">Project</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n\n<span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">work</span><span class=\"w\"> </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">project's</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"n\">Mathlib's</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">achieved</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">copying</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">`././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/././</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span>\n<span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"ss\">`lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">project</span>\n<span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`cp</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/././</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"bp\">./</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>",
        "id": 507109552,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522579
    },
    {
        "content": "<p>Great, do what it told you and now you're done</p>",
        "id": 507109591,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522600
    },
    {
        "content": "<p>It worked to update to v4.17.0. But when I did the same to downgrade to v4.14.0, it failed</p>",
        "id": 507109857,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522762
    },
    {
        "content": "<p>Probably because the toml format didn't exist</p>",
        "id": 507109987,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522831
    },
    {
        "content": "<p>I recommend going back one at a time</p>",
        "id": 507109999,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522839
    },
    {
        "content": "<p>I am sure it did</p>",
        "id": 507110011,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522844
    },
    {
        "content": "<p>We have been using the toml file since before that toolchain</p>",
        "id": 507110029,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522856
    },
    {
        "content": "<p>The issue was, cache said I should run <code>lake update</code> to update the manifest</p>",
        "id": 507110132,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522909
    },
    {
        "content": "<p>So I ran <code>lake update</code></p>",
        "id": 507110149,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522918
    },
    {
        "content": "<p>Which decided that I need <code>v4.18.0-rc1</code></p>",
        "id": 507110166,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522932
    },
    {
        "content": "<p>back to square one.</p>",
        "id": 507110180,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522940
    },
    {
        "content": "<p>That sounds like your lakefile didn't pin something</p>",
        "id": 507110217,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742522961
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.14.0\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"checkdecls\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/PatrickMassot/checkdecls.git\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"«doc-gen4»\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover/doc-gen4\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"main\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_lib</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"equational_theories\"</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_exe</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"extract_implications\"</span>\n<span class=\"n\">root</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"scripts.extract_implications\"</span>\n<span class=\"n\">supportInterpreter</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_exe</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"export_equations\"</span>\n<span class=\"n\">root</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"scripts.export_equations\"</span>\n<span class=\"n\">supportInterpreter</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"o\">[[</span><span class=\"n\">lean_exe</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"generate_lifting_magma_family_counterexamples\"</span>\n<span class=\"n\">root</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"equational_theories.LiftingMagmaFamiliesCounterexamples\"</span>\n<span class=\"n\">supportInterpreter</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 507110288,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522996
    },
    {
        "content": "<p>It pinned mathlib</p>",
        "id": 507110291,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742522999
    },
    {
        "content": "<p>you'll need to specify explicit <code>rev</code>s for all dependencies</p>",
        "id": 507110359,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1742523017
    },
    {
        "content": "<p>You probably need to pin doc-gen too</p>",
        "id": 507110362,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742523019
    },
    {
        "content": "<p>Or only ask to update mathlib</p>",
        "id": 507110387,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742523031
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">mathlib</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n</code></pre></div>",
        "id": 507110469,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523082
    },
    {
        "content": "<p>This time I changed the <code>rev</code> of both mathlib and doc-gen. Something strange:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">nano</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">toml</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">nano</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">shreyas</span><span class=\"bp\">@</span><span class=\"n\">vonNeumann</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">Projects</span><span class=\"bp\">/</span><span class=\"n\">temporary</span><span class=\"bp\">/</span><span class=\"n\">equational_theories</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">update</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"n\">a8cd7afb471bb1fdd335118bf1e253a38a2af53'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1'</span>\n</code></pre></div>",
        "id": 507110671,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523190
    },
    {
        "content": "<p>both revs were set to v4.14.0</p>",
        "id": 507110692,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523204
    },
    {
        "content": "<p>but :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\">  </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n</code></pre></div>",
        "id": 507110732,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523234
    },
    {
        "content": "<p>which contradicts : <code>info: updating toolchain to 'leanprover/lean4:v4.15.0-rc1'</code></p>",
        "id": 507110807,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523265
    },
    {
        "content": "<p>I need to leave now, but it is clear that <code>lake</code> has some very confusing behaviour when trying to downgrade toolchains</p>",
        "id": 507110957,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1742523328
    }
]