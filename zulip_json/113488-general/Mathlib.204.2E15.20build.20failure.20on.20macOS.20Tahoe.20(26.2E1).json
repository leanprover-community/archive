[
    {
        "content": "<p>Decided to upgrade macOS from Sequoia (15.7) to Tahoe (26.1).</p>\n<p>Before the upgrade Mathlib 4.15 was able to compile fine on Sequoia (15.7). After the upgrade I am met with</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>.\n.\n.\n+<span class=\"w\"> </span><span class=\"nb\">pushd</span><span class=\"w\"> </span>mathlib4\n\n~/Code/KellyJDavis/kimina-lean-server/mathlib4<span class=\"w\"> </span>~/Code/KellyJDavis/kimina-lean-server\n+<span class=\"w\"> </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>v4.15.0\n\nHEAD<span class=\"w\"> </span>is<span class=\"w\"> </span>now<span class=\"w\"> </span>at<span class=\"w\"> </span>9837ca9<span class=\"w\"> </span>chore:<span class=\"w\"> </span>bot<span class=\"w\"> </span>validates<span class=\"w\"> </span>lean-toolchain<span class=\"w\"> </span>on<span class=\"w\"> </span>bump/v4.X.0<span class=\"w\"> </span>branches<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"c1\">#20478)</span>\n+<span class=\"w\"> </span><span class=\"s1\">'['</span><span class=\"w\"> </span><span class=\"nv\">mathlib4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>mathlib4<span class=\"w\"> </span><span class=\"s1\">']'</span>\n+<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\n**info:**<span class=\"w\"> </span>plausible:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/plausible\n**info:**<span class=\"w\"> </span>plausible:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'2c57364ef83406ea86d0f78ce3e342079a2fece5'</span>\n**info:**<span class=\"w\"> </span>LeanSearchClient:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/LeanSearchClient\n**info:**<span class=\"w\"> </span>LeanSearchClient:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'003ff459cdd85de551f4dcf95cdfeefe10f20531'</span>\n**info:**<span class=\"w\"> </span>importGraph:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/import-graph\n**info:**<span class=\"w\"> </span>importGraph:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'9a0b533c2fbd6195df067630be18e11e4349051c'</span>\n**info:**<span class=\"w\"> </span>proofwidgets:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/ProofWidgets4\n**info:**<span class=\"w\"> </span>proofwidgets:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'2b000e02d50394af68cfb4770a291113d94801b5'</span>\n**info:**<span class=\"w\"> </span>aesop:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/aesop\n**info:**<span class=\"w\"> </span>aesop:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'2689851f387bb2cef351e6825fe94a56a304ca13'</span>\n**info:**<span class=\"w\"> </span>Qq:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/quote4\n**info:**<span class=\"w\"> </span>Qq:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'f0c584bcb14c5adfb53079781eeea75b26ebbd32'</span>\n**info:**<span class=\"w\"> </span>batteries:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/batteries\n**info:**<span class=\"w\"> </span>batteries:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'e8dc5fc16c625fc4fe08f42d625523275ddbbb4b'</span>\n**info:**<span class=\"w\"> </span>Cli:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover/lean4-cli\n**info:**<span class=\"w\"> </span>Cli:<span class=\"w\"> </span>checking<span class=\"w\"> </span>out<span class=\"w\"> </span>revision<span class=\"w\"> </span><span class=\"s1\">'0c8ea32a15a4f74143e4e1e107ba2c412adb90fd'</span>\n\ndyld<span class=\"o\">[</span><span class=\"m\">47471</span><span class=\"o\">]</span>:<span class=\"w\"> </span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>/Users/kdavis/Code/KellyJDavis/kimina-lean-server/mathlib4/.lake/build/bin/cache\n\ndyld<span class=\"o\">[</span><span class=\"m\">47471</span><span class=\"o\">]</span>:<span class=\"w\"> </span>__DATA_CONST<span class=\"w\"> </span>segment<span class=\"w\"> </span>missing<span class=\"w\"> </span>SG_READ_ONLY<span class=\"w\"> </span>flag\n</code></pre></div>\n<p>It seems that macOS has become more strict with respect to __DATA_CONST sections, expecting them to be (as the name would suggest) immutable and be marked as such with SG_READ_ONLY.</p>\n<p>__DATA_CONST sections not marked as  SG_READ_ONLY seem to be is a result of  using LLVM/Clang but not always the Apple linker, for example using lld.</p>\n<p>What I did to get around this is introduce a bash function</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>ensure_apple_ld<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"k\">$(</span>uname<span class=\"w\"> </span>-s<span class=\"k\">)</span><span class=\"s2\">\"</span><span class=\"w\"> </span>!<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Darwin\"</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">return</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n\n<span class=\"w\">  </span><span class=\"nv\">APPLE_LD_PATH</span><span class=\"o\">=</span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span>-v<span class=\"w\"> </span>xcrun<span class=\"w\"> </span>&gt;/dev/null<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"nv\">APPLE_LD_PATH</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"k\">$(</span>xcrun<span class=\"w\"> </span>--find<span class=\"w\"> </span>ld<span class=\"w\"> </span><span class=\"m\">2</span>&gt;/dev/null<span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"k\">)</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n<span class=\"w\">  </span><span class=\"nv\">APPLE_LD_PATH</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"nv\">APPLE_LD_PATH</span><span class=\"k\">:-</span><span class=\"p\">/usr/bin/ld</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n\n<span class=\"w\">  </span><span class=\"c1\"># Ensure the linker we expose is the Apple ld64 (not lld).</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span>!<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"s2\">\"</span><span class=\"w\"> </span>-v<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>-qi<span class=\"w\"> </span><span class=\"s2\">\"apple\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"ERROR: Expected Apple ld64, but found </span><span class=\"k\">$(</span><span class=\"se\">\\\"</span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"se\">\\\"</span><span class=\"w\"> </span>-v<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>head<span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"k\">)</span><span class=\"s2\">\"</span><span class=\"w\"> </span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">2</span>\n<span class=\"w\">    </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Please install Xcode command line tools (xcode-select --install) to get ld64.\"</span><span class=\"w\"> </span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">2</span>\n<span class=\"w\">    </span><span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n\n<span class=\"w\">  </span><span class=\"c1\"># Prepend the Apple ld64 bin dir in case other setup steps override PATH (e.g., elan).</span>\n<span class=\"w\">  </span><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">PATH</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"k\">$(</span>dirname<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"s2\">\"</span><span class=\"k\">)</span><span class=\"s2\">:</span><span class=\"si\">${</span><span class=\"nv\">PATH</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">LD</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"nb\">export</span><span class=\"w\"> </span><span class=\"nv\">REAL_LD64</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Using Apple ld64 at </span><span class=\"nv\">$APPLE_LD_PATH</span><span class=\"s2\">\"</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>and called it at appropriate points in my build script.</p>\n<p>In addition I removed calls to <code>lake exe cache get</code> to prevent downloading improperly linked files. </p>\n<p>This seems to have worked, but could someone (<em>the powers that be</em>) re-link older, downloadable cached files with the Apple linker to prevent others from downloading them and facing this problem.</p>\n<p>PS: I need to be on Lean 4.15 as I'm working with a ML model trained on 4.15; so, upgrading wasn't an option.</p>",
        "id": 562899911,
        "sender_full_name": "Kelly Davis",
        "timestamp": 1765356707
    },
    {
        "content": "<p>I can reproduce on my mac (also on Tahoe 26.1): <code>git checkout v4.15.0</code> followed by <code>lake exe cache get</code> fails (with an error about RBMap), and <code>lake clean</code> then <code>lake exe cache get</code> fails again (with an error about <code>__DATA_CONST</code>). Checking out <code>master</code> puts everything back to normal.</p>",
        "id": 562906449,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765358428
    },
    {
        "content": "<p>If I hear the combination of:</p>\n<ul>\n<li>a second person needing v4.15.0</li>\n<li>and someone giving me a script that does everything needed, assuming I provide it with the cache upload key</li>\n</ul>\n<p>then I could do it. :-) Otherwise it seems that just zipping up the oleans that work for you and moving them around might be the simpler solution.</p>",
        "id": 562927549,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765364610
    },
    {
        "content": "<p>So basically a WONTFIX.</p>\n<p>What is the first version that starts to correctly use the Apple linker?</p>",
        "id": 562928128,
        "sender_full_name": "Kelly Davis",
        "timestamp": 1765364808
    },
    {
        "content": "<p>I created a script to test this and the first version, starting from 4.15, that works is 4.20.</p>\n<p>The script is should be placed in the <code>mathlib4</code> repo under <code>scripts/find-cache-readonly-fix.sh</code> and run as</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>bash<span class=\"w\"> </span>scripts/find-cache-readonly-fix.sh\n</code></pre></div>\n<p>The script itself is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"ch\">#!/usr/bin/env bash</span>\n\n<span class=\"c1\"># Find the first tag from v4.15.0 onward whose `lake exe cache get` does not</span>\n<span class=\"c1\"># fail with the \"__DATA_CONST segment missing SG_READ_ONLY flag\" error.</span>\n<span class=\"nb\">set</span><span class=\"w\"> </span>-euo<span class=\"w\"> </span>pipefail\n\n<span class=\"nv\">REPO_ROOT</span><span class=\"o\">=</span><span class=\"s2\">\"/Users/kdavis/Code/leanprover-community/mathlib4\"</span>\n<span class=\"nv\">START_TAG</span><span class=\"o\">=</span><span class=\"s2\">\"v4.15.0\"</span>\n<span class=\"nv\">TARGET_ERROR</span><span class=\"o\">=</span><span class=\"s2\">\"__DATA_CONST segment missing SG_READ_ONLY flag\"</span>\n\n<span class=\"c1\"># Allow overriding the log directory; otherwise use a temporary one.</span>\n<span class=\"nv\">WORK_DIR</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"nv\">WORK_DIR</span><span class=\"k\">:-$(</span>mktemp<span class=\"w\"> </span>-d<span class=\"w\"> </span>/tmp/mathlib-cache-check-XXXXXX<span class=\"k\">)</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\nmkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$WORK_DIR</span><span class=\"s2\">\"</span>\n\n<span class=\"nb\">cd</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$REPO_ROOT</span><span class=\"s2\">\"</span>\n\n<span class=\"c1\"># Remember the starting ref so we can restore it on exit.</span>\n<span class=\"nv\">original_ref</span><span class=\"o\">=</span><span class=\"k\">$(</span>git<span class=\"w\"> </span>rev-parse<span class=\"w\"> </span>--abbrev-ref<span class=\"w\"> </span>HEAD<span class=\"k\">)</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$original_ref</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s2\">\"HEAD\"</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"nv\">original_ref</span><span class=\"o\">=</span><span class=\"k\">$(</span>git<span class=\"w\"> </span>rev-parse<span class=\"w\"> </span>HEAD<span class=\"k\">)</span>\n<span class=\"k\">fi</span>\nrestore_original<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>-f<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$original_ref</span><span class=\"s2\">\"</span><span class=\"w\"> </span>&gt;/dev/null<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"nb\">true</span>\n<span class=\"o\">}</span>\n<span class=\"nb\">trap</span><span class=\"w\"> </span>restore_original<span class=\"w\"> </span>EXIT\n\n<span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Logs will be written under: </span><span class=\"nv\">$WORK_DIR</span><span class=\"s2\">\"</span>\n\nrun_attempt<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"nb\">local</span><span class=\"w\"> </span><span class=\"nv\">log_file</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$1</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get<span class=\"w\"> </span><span class=\"p\">&amp;</span>&gt;<span class=\"s2\">\"</span><span class=\"nv\">$log_file</span><span class=\"s2\">\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>-q<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$TARGET_ERROR</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$log_file</span><span class=\"s2\">\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\">   </span><span class=\"c1\"># command succeeded but printed the target error</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"c1\"># success and no target error</span>\n<span class=\"w\">    </span><span class=\"k\">fi</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>-q<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$TARGET_ERROR</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$log_file</span><span class=\"s2\">\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\">   </span><span class=\"c1\"># failure with the target error</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\">   </span><span class=\"c1\"># failure for another reason</span>\n<span class=\"w\">    </span><span class=\"k\">fi</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n<span class=\"o\">}</span>\n\n<span class=\"nv\">started</span><span class=\"o\">=</span><span class=\"m\">0</span>\n<span class=\"nv\">first_good_tag</span><span class=\"o\">=</span><span class=\"s2\">\"\"</span>\n<span class=\"nv\">first_good_log</span><span class=\"o\">=</span><span class=\"s2\">\"\"</span>\n<span class=\"nv\">first_good_attempt</span><span class=\"o\">=</span><span class=\"s2\">\"\"</span>\n\n<span class=\"k\">for</span><span class=\"w\"> </span>tag<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"k\">$(</span>git<span class=\"w\"> </span>tag<span class=\"w\"> </span>-l<span class=\"w\"> </span><span class=\"s1\">'v4.*'</span><span class=\"w\"> </span>--sort<span class=\"o\">=</span>version:refname<span class=\"k\">)</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"nv\">$started</span><span class=\"w\"> </span>-eq<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$START_TAG</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"k\">continue</span>\n<span class=\"w\">    </span><span class=\"nv\">started</span><span class=\"o\">=</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Checking </span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>--quiet<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span>\n\n<span class=\"w\">  </span><span class=\"nv\">tag_dir</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$WORK_DIR</span><span class=\"s2\">/</span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$tag_dir</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"nv\">first_log</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$tag_dir</span><span class=\"s2\">/first.log\"</span>\n<span class=\"w\">  </span><span class=\"nv\">second_log</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$tag_dir</span><span class=\"s2\">/second.log\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span>run_attempt<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$first_log</span><span class=\"s2\">\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_tag</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_log</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$first_log</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_attempt</span><span class=\"o\">=</span><span class=\"s2\">\"first\"</span>\n<span class=\"w\">    </span><span class=\"k\">break</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"nv\">status</span><span class=\"o\">=</span><span class=\"nv\">$?</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"nv\">$status</span><span class=\"w\"> </span>-eq<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"  first attempt hit target error (see </span><span class=\"nv\">$first_log</span><span class=\"s2\">)\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"  first attempt failed for another reason (see </span><span class=\"nv\">$first_log</span><span class=\"s2\">)\"</span>\n<span class=\"w\">    </span><span class=\"k\">fi</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n\n<span class=\"w\">  </span>lake<span class=\"w\"> </span>clean\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span>run_attempt<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$second_log</span><span class=\"s2\">\"</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_tag</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$tag</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_log</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"nv\">$second_log</span><span class=\"s2\">\"</span>\n<span class=\"w\">    </span><span class=\"nv\">first_good_attempt</span><span class=\"o\">=</span><span class=\"s2\">\"after clean\"</span>\n<span class=\"w\">    </span><span class=\"k\">break</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"nv\">status</span><span class=\"o\">=</span><span class=\"nv\">$?</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span><span class=\"nv\">$status</span><span class=\"w\"> </span>-eq<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"  second attempt hit target error (see </span><span class=\"nv\">$second_log</span><span class=\"s2\">)\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"  second attempt failed for another reason (see </span><span class=\"nv\">$second_log</span><span class=\"s2\">)\"</span>\n<span class=\"w\">    </span><span class=\"k\">fi</span>\n<span class=\"w\">  </span><span class=\"k\">fi</span>\n<span class=\"k\">done</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"nv\">$first_good_tag</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"o\">]]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"First tag without the target error: </span><span class=\"nv\">$first_good_tag</span><span class=\"s2\"> (</span><span class=\"nv\">$first_good_attempt</span><span class=\"s2\"> run)\"</span>\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"Log: </span><span class=\"nv\">$first_good_log</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"k\">else</span>\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"No tag from </span><span class=\"nv\">$START_TAG</span><span class=\"s2\"> onward avoided the target error.\"</span>\n<span class=\"w\">  </span><span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">1</span>\n<span class=\"k\">fi</span>\n</code></pre></div>",
        "id": 562953947,
        "sender_full_name": "Kelly Davis",
        "timestamp": 1765373096
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"900292\">@Kelly Davis</span>, I think saying this is a \"WONTFIX\" is maybe overstating it. No one has ever suggested that they provide support for old versions of Mathlib.</p>\n<p>I manage the releases of new versions of Lean, and coordinate making sure Mathlib works on each new stable release and release candidate. But anything older than that is a community project. (e.g. you! I can help get access to the keys.) We strongly recommend that people building AIs to interact with Lean work out how to adapt to new versions frequently.</p>\n<p>But I'm also really confused by your diagnosis above. (I didn't read closely.) How can the linker used affect the oleans? Those are cross-platform. I think actually what you want is to rebuild Lean v4.15.0, this is not actually a request about Mathlib at all?</p>",
        "id": 563080969,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765410378
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib.204.2E15.20build.20failure.20on.20macOS.20Tahoe.20.2826.2E1.29/near/563080969\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"900292\">Kelly Davis</span>, I think saying this is a \"WONTFIX\" is maybe overstating it. No one has ever suggested that they provide support for old versions of Mathlib.</p>\n</blockquote>\n<p>I guess I read (and maybe misread) your statement as a slightly snarky way of saying \"WONTFIX\". Sorry if this isn't the case.</p>\n<blockquote>\n<p>We strongly recommend that people building AIs to interact with Lean work out how to adapt to new versions frequently.</p>\n</blockquote>\n<p>Given current technology I don't think this is a realistic expectation.</p>\n<p>With the training times involved (e.g. 1-2 months) along with the cost of training (e.g. paying for 50-200 GPUs running full-time for 1-2 months), re-training a model for each Mathlib release is not something anyone can realistically be expected to do or would really want to do.</p>\n<p>Myself, I'm working on a personal project using existing open pre-trained models which are \"pinned\" to particular Mathlib versions. So the cost and time to retrain is completely out of the question.</p>\n<blockquote>\n<p>But I'm also really confused by your diagnosis above. (I didn't read closely.) How can the linker used affect the oleans? Those are cross-platform. I think actually what you want is to rebuild Lean v4.15.0, this is not actually a request about Mathlib at all?</p>\n</blockquote>\n<p>I don't want to re-build Lean 4.15.</p>\n<p>Since then, I've since gotten Mathlib4.15 and my REPL's[1][2] to work with a non-rebuilt Lean 4.15 on macOS 26.1, though it was a pain. (Initially I was researching how to rollback to macOS 15. It involves a full backup, disk wipe, and system reinstall <span aria-label=\"anguish\" class=\"emoji emoji-1f62b\" role=\"img\" title=\"anguish\">:anguish:</span> )</p>\n<p>For example, my \"solution\" for the REPL's I landed on the <strong><em>hack</em></strong> of renaming the __DATA_CONST sections to __DATA, i.e. in lakefile.lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">...</span>\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">ast</span><span class=\"bp\">-</span><span class=\"kn\">export</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Main</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Enables the use of the Lean interpreter by the executable (e.g.,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `runFrontend`) at the expense of increased binary size on Linux.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Remove this line if you do not need such functionality.</span>\n<span class=\"w\">  </span><span class=\"n\">supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Fix for macOS 26.1 + Lean 4.15-4.19-rc3: rename __DATA_CONST segment to avoid</span>\n<span class=\"w\">  </span><span class=\"c1\">-- \"dyld: __DATA_CONST segment missing SG_READ_ONLY flag\" error when linked with lld</span>\n<span class=\"w\">  </span><span class=\"n\">moreLinkArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-Wl,-rename_segment,__DATA_CONST,__DATA\"</span><span class=\"o\">]</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>These \"fixes\" are not yet in the GitHub repos I referenced.</p>\n<p>For Mathlib4.15 I build it as part of a <a href=\"https://github.com/KellyJDavis/kimina-lean-server\">kimina-lean-server</a> variant. </p>\n<p>In particular the fixed <a href=\"https://github.com/KellyJDavis/kimina-lean-server/blob/main/server/setup.sh\">setup script</a> so that it</p>\n<ol>\n<li>Uses the function <code>ensure_apple_ld()</code> I defined above to force use of the Apple linker</li>\n<li>Doesn't call <code>lake exe cache get</code> for macOS to force a local build</li>\n</ol>\n<p>Together these seem to work, i.e. if I don't do this I get the <code>_DATA_CONST segment missing SG_READ_ONLY flag</code> error occurring on</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>/Users/kdavis/Code/KellyJDavis/kimina-lean-server/mathlib4/.lake/build/bin/cache\n</code></pre></div>\n<p>which seems, as far as I can see, to be mathlib4 not Lean related. </p>\n<p>Upon such a failure, running <code>otool -l</code> on the  that <code>cache</code> file confirms what the failure indicates, the  <code>_DATA_CONST</code> segment is missing a <code>SG_READ_ONLY</code> flag. So it seems to me to be mathlib4 not Lean related.</p>\n<p>PS: I agree that oleans are platform agnostic, but something <em>is</em> afoot. You know far more about the toolchain than I do, or ever will. So maybe these hints help find the underlying problem. </p>\n<p>PPS: Again whatever the underlying  problem was, it went away in Mathlib 4.20 but was present from 4.15 until then, another hint.</p>\n<p>[1] <a href=\"https://github.com/leanprover-community/repl\">https://github.com/leanprover-community/repl</a><br>\n[2] <a href=\"https://github.com/KellyJDavis/ast_export\">https://github.com/KellyJDavis/ast_export</a></p>",
        "id": 563137959,
        "sender_full_name": "Kelly Davis",
        "timestamp": 1765445299
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"900292\">Kelly Davis</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib.204.2E15.20build.20failure.20on.20macOS.20Tahoe.20.2826.2E1.29/near/563137959\">said</a>:</p>\n<blockquote>\n<p>With the training times involved (e.g. 1-2 months) along with the cost of training (e.g. paying for 50-200 GPUs running full-time for 1-2 months), re-training a model for each Mathlib release is not something anyone can realistically be expected to do or would really want to do.</p>\n</blockquote>\n<p>So we have a real disconnect here between \"mathlib and lean aggressively move forwards, constantly adding new features (and theorems) and tweaking old ones, and currently make little attempt to be backwards compatible\" and \"it costs a huge amount of money for certain mathlb-using systems to keep up\". I think that moving backwards is a solution which is obviously not acceptable (for example I am not even allowed to downgrade my mac from 26.1; it is owned by my employers and it's part of the (electronically enforced) contract that I am always on the latest OS; my mac literally stops working if I don't upgrade), so perhaps one needs to think more creatively about how to move forwards? At least once a month mathlib bumps the version of Lean which it's using and this often involves merging a PR whose diff hopefully contains all the information an LLM would need about how to go from vX to vX+1. Could one create a system which attempts to bump code depending on mathlib and written by a machine trained on mathlib from one stable version of Lean to the next? This sounds like an interesting problem and also perhaps a feasible one.</p>",
        "id": 563147333,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1765447923
    },
    {
        "content": "<blockquote>\n<p>...my mac literally stops working if I don't upgrade...</p>\n</blockquote>\n<p>Wow they don't play around!</p>\n<p>Your idea seems feasible, but this only solves part of the problem. </p>\n<p>Assuming it works, this would generate a \"translator\" LLM that could translate, say, the training data for a \"prover\" LLM model, which say targets version N,  to new training data set which targets version N+1.</p>\n<p>The \"prover\" model targeting version N would still be targeting version N and need to be retrained for version N+1.</p>\n<p>For \"small\" deltas between version N and N+1 you might be able to get away with adding a \"translator\" LLM as a pre-processor and post-processor to a \"prover\" LLM.</p>\n<p>However, at some point you're simply going to have to \"bite-the-bullet\" and retrain the \"prover\" LLM. For example, it wouldn't be aware of definitions, theorems, tactics.... in Mathlib4 version N+1 but not in Mathlib version N; so it wouldn't be able to suggest/use them in the proofs it generates.</p>",
        "id": 563155793,
        "sender_full_name": "Kelly Davis",
        "timestamp": 1765450496
    }
]