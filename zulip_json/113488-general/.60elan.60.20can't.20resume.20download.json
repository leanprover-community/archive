[
    {
        "content": "<p>I'm trying to update lean toolchain on a somewhat unreliable connection and I'm not able to. It looks like when the connection is dropped <code>elan</code> will just wait indefinitely or error out, instead of trying to reconnect.</p>\n<p>Here, the progress got stuck, and I waited for 13 minutes and nothing happened:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">downloading</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">releases</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">lang</span><span class=\"bp\">.</span><span class=\"n\">org</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"mf\">4.28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">.</span><span class=\"n\">tar</span><span class=\"bp\">.</span><span class=\"n\">zst</span>\n<span class=\"n\">Total</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">128.8</span><span class=\"w\"> </span><span class=\"n\">MiB</span><span class=\"w\"> </span><span class=\"n\">Speed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">430.5</span><span class=\"w\"> </span><span class=\"n\">KiB</span><span class=\"bp\">/</span><span class=\"n\">s</span><span class=\"bp\">^</span><span class=\"n\">C</span>\n<span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\">                                                                                  </span><span class=\"bp\">✘</span><span class=\"w\"> </span><span class=\"n\">INT</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"n\">s</span>\n<span class=\"bp\">❯</span>\n</code></pre></div>\n<p>Here, I got an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">downloading</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">releases</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">lang</span><span class=\"bp\">.</span><span class=\"n\">org</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"mf\">4.28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">.</span><span class=\"n\">tar</span><span class=\"bp\">.</span><span class=\"n\">zst</span>\n<span class=\"n\">Total</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">131.8</span><span class=\"w\"> </span><span class=\"n\">MiB</span><span class=\"w\"> </span><span class=\"n\">Speed</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"mf\">3.2</span><span class=\"w\"> </span><span class=\"n\">MiB</span><span class=\"bp\">/</span><span class=\"n\">sError</span><span class=\"o\">(</span><span class=\"n\">Download</span><span class=\"o\">(</span><span class=\"n\">Msg</span><span class=\"o\">(</span><span class=\"s2\">\"error during download\"</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">next_error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Some</span><span class=\"o\">(</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">description</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Failure when receiving data from the peer\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">extra</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Some</span><span class=\"o\">(</span><span class=\"s2\">\"Recv failure: Connection reset by peer\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}),</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InternalBacktrace</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">})</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">releases</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">lang</span><span class=\"bp\">.</span><span class=\"n\">org</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"mf\">4.28</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"bp\">-</span><span class=\"n\">linux</span><span class=\"bp\">.</span><span class=\"n\">tar</span><span class=\"bp\">.</span><span class=\"n\">zst'</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"n\">vorkw04a0op2o3e_file'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">download</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">56</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Failure</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">receiving</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">peer</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Recv</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Connection</span><span class=\"w\"> </span><span class=\"n\">reset</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">peer</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"bp\">~/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\">                                                                                          </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"n\">s</span>\n<span class=\"bp\">❯</span>\n</code></pre></div>",
        "id": 572363501,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1770380732
    },
    {
        "content": "<p>Would be nice to know what portion of total size was downloaded too. I don't even know if my attempts were close to finish, or not. :(</p>",
        "id": 572363854,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1770380850
    },
    {
        "content": "<p>It should be approximately 500 MiB that are required. I'm not completely sure but I think recovering from an HTTP download having issues in the middle is quite a non trivial effort so I'm not too suprised things are like they are.</p>",
        "id": 572367352,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1770381893
    },
    {
        "content": "<p><a href=\"http://releases.lean-lang.org\">releases.lean-lang.org</a> is redirecting to Azure or GitHub or something right? I would bet it should support HTTP Range requests? You could try taking however big the file is and external to lake setting a Range header and downloading that file and seeing if you get the rest of the file</p>",
        "id": 572373295,
        "sender_full_name": "Julian Berman",
        "timestamp": 1770383669
    },
    {
        "content": "<p>It's not trivial, but we can use some library that already can do that. I think libcurl can recover from connection errors? Or maybe it's only <code>curl</code> shell command?</p>",
        "id": 572375971,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1770384506
    },
    {
        "content": "<p><code>elan</code> is rust using reqwest -- I'd hesistate to say \"trivial\" given I haven't done it in rust myself but I would hope it wouldn't be much more complicated of an experiment to modify <code>elan</code> to check for an existing file (and read its size) and if one exists to set a <code>Range</code> header with that size. Claude may be able to write that small patch -- but before that experiment I was just suggesting verifying whether that request gives the right remainder of the file. I can try that in a bit just interrupting a download and then retrieving the rest via httpie or whatever HTTP client.</p>",
        "id": 572377794,
        "sender_full_name": "Julian Berman",
        "timestamp": 1770385008
    },
    {
        "content": "<p>(As far as I know this is how any HTTP client, curl or otherwise, is doing file download resuming.)</p>",
        "id": 572377845,
        "sender_full_name": "Julian Berman",
        "timestamp": 1770385020
    },
    {
        "content": "<p>Before any PR, please check first whether this is already implemented and working in rustup</p>",
        "id": 572403487,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1770391246
    },
    {
        "content": "<p>Looks like the answer is yes: <a href=\"https://github.com/rust-lang/rustup/blob/b3fdca3c2a913cad6d7db55f37319eeb14e08117/src/download/mod.rs#L39\">https://github.com/rust-lang/rustup/blob/b3fdca3c2a913cad6d7db55f37319eeb14e08117/src/download/mod.rs#L39</a></p>",
        "id": 572429443,
        "sender_full_name": "Julian Berman",
        "timestamp": 1770398395
    },
    {
        "content": "<p>I think a PR bringing across the rustup functionality as verbatim as possible would probably be welcome?</p>",
        "id": 572737718,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770633731
    },
    {
        "content": "<p>Yeah I figured as much from Sebastian's comment but don't have time to do so at the moment -- <span class=\"user-mention\" data-user-id=\"870257\">@Jakub Nowak</span> not sure if you were planning to. If not I'll do it at some point down the line but unlikely in the next week or two.</p>",
        "id": 572755724,
        "sender_full_name": "Julian Berman",
        "timestamp": 1770638282
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/elan/pull/191\">https://github.com/leanprover/elan/pull/191</a></p>",
        "id": 573176528,
        "sender_full_name": "Kim Morrison :bot:",
        "timestamp": 1770769788
    }
]