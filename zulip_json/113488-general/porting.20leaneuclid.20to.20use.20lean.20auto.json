[
    {
        "content": "<p>I'm trying to port lean euclid to use lean-auto. Namely, I'm making a tactic <code>eauto</code> that wraps lean auto by passing all lemmas tagged with the specified <code>attribute tag</code>. For example <code>eauto euclid [*]</code> would call <code>auto</code> with all of the lemmas tagged with <code>@[euclid]</code>. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Auto</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">SystemE</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Attr</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Simp</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Auto</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eauto</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"eauto\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">autoinstr</span><span class=\"w\"> </span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">uord</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">InputHints</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">collectAllLemmas'</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">inputHints</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InputHints</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldInfos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Prep</span><span class=\"bp\">.</span><span class=\"n\">ConstUnfoldInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">defeqNames</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ngoalAndBinders</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">FVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The first `Array Lemma` are `Prop` lemmas</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The second `Array Lemma` are Inhabitation facts</span>\n<span class=\"w\">  </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Lemma</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Lemma</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Prep</span><span class=\"bp\">.</span><span class=\"n\">topoSortUnfolds</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">startTime</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">monoMsNow</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctxLemmas</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectLctxLemmas</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">lctxhyps</span><span class=\"w\"> </span><span class=\"n\">ngoalAndBinders</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctxLemmas</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">lctxLemmas</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:=</span><span class=\"n\">MetaM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldConstAndPreprocessLemma</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">traceLemmas</span><span class=\"w\"> </span><span class=\"ss\">`auto.printLemmas</span><span class=\"w\"> </span><span class=\"s2\">\"Lemmas collected from local context:\"</span><span class=\"w\"> </span><span class=\"n\">lctxLemmas</span>\n<span class=\"w\">  </span><span class=\"n\">checkDuplicatedFact</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">terms</span>\n<span class=\"w\">  </span><span class=\"n\">checkDuplicatedLemmaDB</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">lemdbs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">userLemmas</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUserLemmas</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">terms</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectHintDBLemmas</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">lemdbs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">userLemmas</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">userLemmas</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:=</span><span class=\"n\">MetaM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldConstAndPreprocessLemma</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">traceLemmas</span><span class=\"w\"> </span><span class=\"ss\">`auto.printLemmas</span><span class=\"w\"> </span><span class=\"s2\">\"Lemmas collected from user-provided terms:\"</span><span class=\"w\"> </span><span class=\"n\">userLemmas</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">defeqLemmas</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectDefeqLemmas</span><span class=\"w\"> </span><span class=\"n\">defeqNames</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">defeqLemmas</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">defeqLemmas</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:=</span><span class=\"n\">MetaM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldConstAndprepReduceDefeq</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">traceLemmas</span><span class=\"w\"> </span><span class=\"ss\">`auto.printLemmas</span><span class=\"w\"> </span><span class=\"s2\">\"Lemmas collected from user-provided defeq hints:\"</span><span class=\"w\"> </span><span class=\"n\">defeqLemmas</span>\n<span class=\"w\">  </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">tactic</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"Preprocessing took {(← IO.monoMsNow) - startTime}ms\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Inhabitation</span><span class=\"bp\">.</span><span class=\"n\">getInhFactsFromLCtx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:=</span><span class=\"n\">MetaM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldConstAndPreprocessLemma</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">traceLemmas</span><span class=\"w\"> </span><span class=\"ss\">`auto.printLemmas</span><span class=\"w\"> </span><span class=\"s2\">\"Inhabitation lemmas :\"</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lctxLemmas</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">userLemmas</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">defeqLemmas</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">eauto</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalEAuto</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">eauto</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eauto</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">instr</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">uords</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Suppose the goal is `∀ (x₁ x₂ ⋯ xₙ), G`</span>\n<span class=\"w\">  </span><span class=\"c1\">-- First, apply `intros` to put `x₁ x₂ ⋯ xₙ` into the local context,</span>\n<span class=\"w\">  </span><span class=\"c1\">--   now the goal is just `G`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goalBinders</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newGoal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nngoal</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newGoal</span><span class=\"bp\">.</span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Classical.byContradiction</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"{decl_name%} :: Unexpected result after applying Classical.byContradiction\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ngoal</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">absurd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">intro1</span><span class=\"w\"> </span><span class=\"n\">nngoal</span>\n<span class=\"w\">  </span><span class=\"n\">replaceMainGoal</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">absurd</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">instr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseInstr</span><span class=\"w\"> </span><span class=\"n\">instr</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">instr</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">attr</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">`euclid</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">euclidExtension</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">`diag</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">diagExtension</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">`metric</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">metricExtension</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">`super</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">superExtension</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"ss\">`transfer</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">transferExtension</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">euclidExtension</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHints</span><span class=\"w\"> </span><span class=\"n\">hints</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">inputHints</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">terms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"bp\">.</span><span class=\"n\">terms</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)}</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unfoldInfos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">defeqNames</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseUOrDs</span><span class=\"w\"> </span><span class=\"n\">uords</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lemmas</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAllLemmas'</span><span class=\"w\"> </span><span class=\"n\">inputHints</span><span class=\"w\"> </span><span class=\"n\">unfoldInfos</span><span class=\"w\"> </span><span class=\"n\">defeqNames</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goalBinders</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">ngoal</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declName?</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">getDeclName?</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">runAuto</span><span class=\"w\"> </span><span class=\"n\">declName?</span><span class=\"w\"> </span><span class=\"n\">lemmas</span><span class=\"w\"> </span><span class=\"n\">inhFacts</span>\n<span class=\"w\">      </span><span class=\"n\">absurd</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">proof</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">useSorry</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``sorryAx</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``False</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``false</span><span class=\"w\"> </span><span class=\"o\">[]]</span>\n<span class=\"w\">      </span><span class=\"n\">absurd</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">proof</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>\n<p>However, I'm getting significantly worse performance than the original LeanEuclid smt solver command. Is it possible that <code>Point</code> is defined as multiple different sorts in the generated <code>cvc5</code> smt query?</p>",
        "id": 515185463,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1745976140
    },
    {
        "content": "<p>for reference this is what some of my queries look like: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">set</span><span class=\"bp\">-</span><span class=\"n\">logic</span><span class=\"w\"> </span><span class=\"n\">ALL</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_15</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_14</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_3</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_5</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_2</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_5</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_21</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_2</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">declare</span><span class=\"bp\">-</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e!_0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">exTy_0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">exTy_1</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>It seems like the constants such as <code>Point</code> and <code>Circle</code> are showing up as their metavariable id's instead of their actual names. Does lean-smt have issues with handling constants?</p>",
        "id": 515185628,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1745976246
    },
    {
        "content": "<p>actually it seems that lean auto is unable to infer stuff about real numbers. You need to use the <code>smt</code> command for it to actually understand that the mathlib version of <code>Real</code> corresponds to the smt version</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">SystemE</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Smt</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"bp\">.</span><span class=\"n\">Real</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"bp\">.</span><span class=\"n\">Auto</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Book</span><span class=\"bp\">.</span><span class=\"n\">Prop02</span>\n\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">mono</span><span class=\"bp\">.</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"s2\">\"fol\"</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">mono</span><span class=\"bp\">.</span><span class=\"n\">ciInstDefEq</span><span class=\"bp\">.</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"s2\">\"reducible\"</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">mono</span><span class=\"bp\">.</span><span class=\"n\">termLikeDefEq</span><span class=\"bp\">.</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"s2\">\"reducible\"</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">auto</span><span class=\"bp\">.</span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rebind</span><span class=\"w\"> </span><span class=\"n\">Auto</span><span class=\"bp\">.</span><span class=\"n\">Native</span><span class=\"bp\">.</span><span class=\"n\">solverFunc</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"bp\">.</span><span class=\"n\">smtSolverFunc</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">womp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">    [smt] goal: False</span>\n\n<span class=\"cm\">[smt]</span>\n<span class=\"cm\">    query:</span>\n<span class=\"cm\">    (set-logic ALL)</span>\n<span class=\"cm\">    (declare-sort _exTy_0 0)</span>\n<span class=\"cm\">    (declare-const e!_3 _exTy_0)</span>\n<span class=\"cm\">    (declare-fun e!_0 (_exTy_0 _exTy_0) _exTy_0)</span>\n<span class=\"cm\">    (declare-const e!_1 _exTy_0)</span>\n<span class=\"cm\">    (declare-fun e!_2 (_exTy_0 _exTy_0) _exTy_0)</span>\n<span class=\"cm\">    (assert (distinct (e!_0 e!_1 e!_1) (e!_2 e!_3 e!_1)))</span>\n<span class=\"cm\">    (assert (not false))</span>\n<span class=\"cm\">    (check-sat)</span>\n\n<span class=\"cm\">[smt]</span>\n<span class=\"cm\">    error reason:</span>\n<span class=\"cm\">    cvc5.Error.error \"Expected unsat, got sat\"</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span>\n</code></pre></div>",
        "id": 515186866,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1745977089
    },
    {
        "content": "<p>is there anyway to include axioms and other constants as hints for the smt tactic?</p>",
        "id": 515186941,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1745977153
    },
    {
        "content": "<p>Currently, lean-smt has special support for the reals but lean-auto doesn't. Because of this, running <code>smt</code> on its own can yield a translation that involves smt reals, but running <code>auto</code> with lean-smt as a backend won't (because lean-auto's preprocessing procedure will get rid of reals before lean-smt has a chance to see them).</p>",
        "id": 515376343,
        "sender_full_name": "Josh Clune",
        "timestamp": 1746039056
    },
    {
        "content": "<p>Here's my attempt to get lean-smt command to support axioms tagged with <code>@[euclid]</code>: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Smt</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">SystemE</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Attr</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Smt</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"kn\">hiding</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"w\"> </span><span class=\"n\">Translate</span><span class=\"w\"> </span><span class=\"n\">Query</span><span class=\"w\"> </span><span class=\"n\">Reconstruct</span><span class=\"w\"> </span><span class=\"n\">Util</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">esmt</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"esmt\"</span><span class=\"w\"> </span><span class=\"n\">smtHints</span><span class=\"w\"> </span><span class=\"n\">smtTimeout</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">esmt</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalESmt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">euclidExtension</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hintExprs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHints</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Smt</span><span class=\"bp\">.</span><span class=\"n\">smt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getMainGoal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hintExprs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseTimeout</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">replaceMainGoal</span><span class=\"w\"> </span><span class=\"n\">mvs</span>\n</code></pre></div>\n<p>But I still get the following error when I try to run the tactic: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">  trying to define _uniq✝⁸⁴⁵⁻⁰ but it has no equational definition and is not a let-decl</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 515377971,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1746039631
    },
    {
        "content": "<p>any ideas what's going wrong?</p>",
        "id": 515378025,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1746039647
    },
    {
        "content": "<p>I'm not able to sit down properly and fully debug this at the moment, but off the cuff, it looks like in <code>hintExprs</code>, you're concatenating the list of decl types with the output of <code>parseHints</code>? But parseHints elaborates terms which are supposed to be proofs of relevant facts (not the fact itself). So I'm wondering if your current code is doing something analogous to creating a call like <code>by smt [1 + 1 = 2]</code></p>",
        "id": 515381794,
        "sender_full_name": "Josh Clune",
        "timestamp": 1746041023
    }
]