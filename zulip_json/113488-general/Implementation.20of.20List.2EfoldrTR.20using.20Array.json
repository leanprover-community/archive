[
    {
        "content": "<p>I was quite surprised to find out that the <a href=\"https://github.com/leanprover/lean4/blob/master/src/Init/Data/List/Impl.lean#L130\">implementation</a> of <code>List.foldr</code>'s <code>csimp</code> twin <code>List.foldrTR</code> uses <code>Array.foldr</code> under the hood:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">specialize</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foldrTR</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">init</span>\n</code></pre></div>\n<p>It looks like this was added relatively recently, in <a href=\"https://github.com/leanprover/lean4/commit/1a5d064d0825462b86dfd9a01c38efad108aed1b\">this commit</a>.</p>\n<p>This implementation looks like it will always use O(n) heap space to allocate the array, traversing the list once to do so and then walking back down the array to compute <code>Array.foldr</code>.</p>\n<p>I'd have expected it to be written as a reversal followed by a <code>foldl</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfoldrTR</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">init</span>\n</code></pre></div>\n<p>This version has two list traversals, since the \"backwards pass\" of foldl on the reversed list is done by chasing pointers instead of walking down a contiguous array; I'm not sure by how much this affects performance. An advantage would be that, in the case of a uniquely owned list, the FBIP optimization will apply to <code>List.reverse</code> and reuse the memory used for <code>l</code>.</p>\n<p>Why is the implementation of <code>foldrTR</code> written the way it is?</p>",
        "id": 523909519,
        "sender_full_name": "Simon Dima",
        "timestamp": 1749807733
    },
    {
        "content": "<p>My assumption is that allocating <code>Array</code>s and iterating through them is faster than allocating tons of <code>List</code>s. For one, using <code>Array</code> means you have a continous block of memory and you have the CPU cache to speed up the operation. Also, the amount of allocations you have to do for arrays is also then O(log n) and not O(n) like for lists.</p>",
        "id": 523914386,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749809629
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Implementation.20of.20List.2EfoldrTR.20using.20Array/near/523914386\">said</a>:</p>\n<blockquote>\n<p>My assumption is that allocating <code>Array</code>s and iterating through them is faster than allocating tons of <code>List</code>s.</p>\n</blockquote>\n<p>I benchmarked three ways of counting up to test this out:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- List.sum has a bug which causes the csimp List.foldr -&gt; List.foldrTR not to apply, which leads to stack overflows.</span>\n<span class=\"c1\">-- https://github.com/leanprover/lean4/issues/7750</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>The version with a left fold is unsurprisingly fastest, but on my system \"reverse-then-foldl\" ran faster than the version using a right fold csimped into array allocation!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">hyperfine</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"c1\">--warmup 5 -r 20 \"bin/list_sum 10000000\" \"bin/list_sum_rev 10000000\" \"bin/list_sum_foldr 10000000\"</span>\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">187.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">5.3</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">165.5</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">20.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">184.0</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">207.3</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">219.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">2.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">198.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">20.1</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">216.0</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">225.6</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">285.7</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">3.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">258.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">25.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">280.7</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">294.1</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Summary</span>\n<span class=\"w\">  </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"mi\">10000000</span><span class=\"w\"> </span><span class=\"n\">ran</span>\n<span class=\"w\">    </span><span class=\"mf\">1.17</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"mf\">0.04</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">    </span><span class=\"mf\">1.52</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n</code></pre></div>\n<p>Those performance gaps are quite large, and the results were very consistent on my machine (after disabling swap and making space in memory), so I'd expect you to be able to reproduce them. The question of whether this is an interesting use case to benchmark is of course another one, since here there is unique ownership.</p>",
        "id": 523957562,
        "sender_full_name": "Simon Dima",
        "timestamp": 1749824798
    },
    {
        "content": "<p>I modified the tested functions to keep a reference to the list in order to prevent FBIP reuse optimizations:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n</code></pre></div>\n<p>This made basically no difference to the runtime of <code>list_sum</code> (using <code>List.foldl</code>) and <code>list_sum_foldr</code> (using <code>List.foldrTR</code>), but the runtime of <code>list_sum_rev</code> increased a lot:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">hyperfine</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"c1\">--warmup 5 -r 20 \"bin/list_sum 10000000\" \"bin/list_sum_rev 10000000\" \"bin/list_sum_foldr 10000000\"</span>\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">186.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">7.3</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">164.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">20.6</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">181.8</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">216.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">351.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">8.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">309.5</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">39.1</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">343.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">373.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Benchmark</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">  </span><span class=\"n\">Time</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mean</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">):</span><span class=\"w\">     </span><span class=\"mf\">270.3</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\">   </span><span class=\"mf\">4.7</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">242.2</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">25.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"o\">):</span><span class=\"w\">   </span><span class=\"mf\">265.9</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"bp\">…</span><span class=\"w\"> </span><span class=\"mf\">287.4</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">runs</span>\n\n<span class=\"n\">Summary</span>\n<span class=\"w\">  </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum</span><span class=\"w\"> </span><span class=\"mi\">10000000</span><span class=\"w\"> </span><span class=\"n\">ran</span>\n<span class=\"w\">    </span><span class=\"mf\">1.45</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"mf\">0.06</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_foldr</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n<span class=\"w\">    </span><span class=\"mf\">1.88</span><span class=\"w\"> </span><span class=\"bp\">±</span><span class=\"w\"> </span><span class=\"mf\">0.09</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">list_sum_rev</span><span class=\"w\"> </span><span class=\"mi\">10000000</span>\n</code></pre></div>\n<p>The performance of <code>list_sum_rev</code> especially was quite sensitive to the other programs running, and it got a lot better once I closed additional memory-hungry programs. Without a proper benchmarking setup these numbers are mostly garbage, but it seems like the takeaway here is that \"reverse then foldl\" is better than \"convert to array then foldr\" when the list is unshared, but worse (and highly sensitive to the system load) when the list is shared.</p>",
        "id": 523963076,
        "sender_full_name": "Simon Dima",
        "timestamp": 1749826731
    },
    {
        "content": "<p>When I was looking into this I came to similar conclusions, but ended up blocked on the fact that there is no way in lean to branch on whether the input is shared or not (except using <code>dbgTraceIsShared</code> but this doesn't report its results to lean code). I tried to introduce a function to expose this functionality (<a href=\"https://github.com/leanprover/lean4/pull/1586\">lean4#1586</a>) but the PR was never merged.</p>",
        "id": 524932936,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750358022
    },
    {
        "content": "<p>I'm pretty sure the one with <code>Array</code> is actually faster if the memory is sufficiently fragmented so I don't see a reason to change this (even if we had a function to expose whether it is shared)</p>",
        "id": 524933110,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750358149
    },
    {
        "content": "<p>the reason the unshared case is fast is because it will just flip the linked list in place. This uses less memory but it's possible that if the list is very long and fragmented then the second pass will be just as slow as the first</p>",
        "id": 524933293,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750358256
    },
    {
        "content": "<p>Yeah right it's the difference between chase pointers twice / allocate an array and chase pointers once.</p>",
        "id": 524933848,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750358560
    }
]