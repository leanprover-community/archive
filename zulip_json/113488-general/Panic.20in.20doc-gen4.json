[
    {
        "content": "<p>FYI, the Mathlib docs are experiencing some panics while building: search for <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/18709541584/job/53354433191\">PANIC</a> here. This means we're missing some declarations. I'm looking into it right now.</p>\n<p>Update: this seems to be related to some of the recent cache issues. Hopefully this will pass in a moment.</p>",
        "id": 546409599,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761126089
    },
    {
        "content": "<p>(Also, the action appears to succeed despite the panics, we only noticed because the website started failing to build when <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Field#doc\">docs#Field</a> failed to appear in the list of declarations. We should fix the action so it actually fails upon failure...)</p>",
        "id": 546409926,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761126190
    },
    {
        "content": "<p>Hmm. On the Mathlib master branch, <code>#eval findDeclarationRanges? ``RatCast</code> returns <code>none</code>, even though it does return <code>some ...</code> if I try to run this in Batteries...</p>",
        "id": 546411951,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761126704
    },
    {
        "content": "<p>Ah, the missing Field is also the source of failure of the website PRs.</p>",
        "id": 546412471,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761126864
    },
    {
        "content": "<p>Ooh, is this because Batteries switched to the module system and now doc-gen4 can't access the declarations? If I link to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Classes/RatCast.html\">the file defining RatCast</a> we get an empty page.</p>",
        "id": 546412489,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761126869
    },
    {
        "content": "<p>For <code>#eval</code> in a <code>module</code> this is true. For docgen it depends on how the environment is set up, a bare <code>importModules</code> should give access to everything</p>",
        "id": 546412710,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1761126940
    },
    {
        "content": "<p>The relevant code in doc-gen4 is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">envOfImports</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- needed for modules which use syntax registered with `initialize add_parser_alias ..`</span>\n<span class=\"w\">  </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imports</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Import</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">leakEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 546412933,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761127002
    },
    {
        "content": "<p>Could something related to the module system also be an explanation for <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Build.20error.20in.20Tactic.20file/with/546407970\">#mathlib4 &gt; Build error in Tactic file</a>?</p>",
        "id": 546412962,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761127011
    },
    {
        "content": "<p>I guess <code>Import.mk · (importAll := true) true false</code> could be a fix here?</p>",
        "id": 546413418,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761127138
    },
    {
        "content": "<p>I made a branch in <code>mathlib4_docs</code> with that change, let's see how it goes... <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/18712722825\">https://github.com/leanprover-community/mathlib4_docs/actions/runs/18712722825</a></p>",
        "id": 546415093,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761127692
    },
    {
        "content": "<p>Aww, we're still getting panics :(</p>",
        "id": 546418238,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761128657
    },
    {
        "content": "<p>Yes, this is likely a cache failure as well</p>",
        "id": 546422282,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1761129826
    },
    {
        "content": "<p>You're right, removing <code>.lake/package/batteries/.lake</code> and building again does return ranges again.</p>",
        "id": 546430892,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761132151
    },
    {
        "content": "<p>The cache issues in mathlib master are now fixed (I think?), but I guess the docs won't work unless we make <code>mathlib4_docs</code> use an older version of <code>doc-gen4</code>?</p>\n<p>cf. the latest build errors which are from v4.25.0 changes, as far as I can tell: <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/18729477389/job/53422622333#step:9:49\">https://github.com/leanprover-community/mathlib4_docs/actions/runs/18729477389/job/53422622333#step:9:49</a></p>",
        "id": 546556889,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1761169860
    },
    {
        "content": "<p>Oh yes, that looks like a lean version mismatch.</p>",
        "id": 546556943,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1761169892
    },
    {
        "content": "<p>The latest builds of <code>mathlib4_docs</code> seem to have succeeded <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 546774884,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1761256807
    }
]