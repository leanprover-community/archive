[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"653351\">@Joseph Tooby-Smith</span> and I each have a repository about doing physics in Lean, albeit with some different focuses/goals. We've been talking about whether it would be best to make a combined one ... there's not much duplicated code/logic, but it would be nice if <em>eventually</em> they were somewhat integrated.</p>\n<p>One possibility that occurred to us would be having two separate lean projects in the same repository. I'm not entirely sure what I mean by this myself, but one thing would be just having multiple build targets in there. Initially they would probably be quite separate in terms of their dependencies, but then we can start to share stuff as we go. This would mean we also must synchronize bumps and so on, and I'm not sure how it would interact with (say) docgen or linter settings or downstream users being able to point at one or the other.</p>\n<p>Another option would be trying to have multiple lakefiles, two entirely separate Lean projects. I don't know if this is possible with the standard package management. Or we keep it as two separate repositories, like it is right now.</p>\n<p>Does anyone have perspectives on what the benefits/drawbacks of these would be?</p>",
        "id": 574522470,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1771425189
    },
    {
        "content": "<p>Keeping multiple separate Lakefiles in the same Git repo generally works quite well in my experience: if one project depends on the other and both live in the same repo you can reference the other project by local path instead of Git URL. (For example, DocGen is usually run by making a new project inside the existing repo, that depends on the original project + <code>doc-gen4</code>.)</p>",
        "id": 574523072,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1771425341
    },
    {
        "content": "<p>(I haven't had much experience with multiple libraries in the same lakefile, this seems like it might mean too much synchronization is required.)</p>",
        "id": 574523486,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1771425441
    },
    {
        "content": "<p>If it can be of any help, I have recently had similar needs and have managed to find a practical compromise (that works for me) by pasting project folders with their top-level .lean file in the top level of the repository I'm using and adding the folder to and adding the folder in the lakefile . In this way you don't need to change the imports in the pasted project's files. The only caveat is that the projects need to be under the same toolchain/lean/mathlib - I've found simpler to update the files rather than experimenting with different, more structured, set-ups...</p>",
        "id": 574525375,
        "sender_full_name": "Matteo Cipollina",
        "timestamp": 1771425906
    },
    {
        "content": "<p>Thanks for putting this question together Alex. <br>\nI think having it under the same <code>toolchain/lean/mathlib</code> is what ideally we want. </p>\n<p>I think the below covers all the options (with permutations of Project A and Project B). </p>\n<p><strong>Option 1</strong> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">shared</span><span class=\"w\"> </span><span class=\"n\">lakefile</span>\n</code></pre></div>\n<ul>\n<li>I'm not sure what such a lake file looks like</li>\n<li>I'm not sure how if someone could import ProjectA and not ProjectB for example. </li>\n</ul>\n<p><strong>Option 2</strong> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<ul>\n<li>I'm not sure how someone would import Project B in this case in a downstream project. </li>\n</ul>\n<p><strong>Option 3</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">/</span>\n<span class=\"w\">    </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">/</span>\n<span class=\"w\">    </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"w\">    </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"w\">    </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">lakefile</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n</code></pre></div>\n<ul>\n<li>disadvantage is that it would not get indexed by the Lean reservoir I think. </li>\n<li>Also not sure how one would import either Project A or ProjectB in a downstream lake file</li>\n</ul>\n<p><strong>Option 4</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">ProjectB</span><span class=\"bp\">/</span>\n<span class=\"bp\">│</span><span class=\"w\">       </span><span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">Files</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Project</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ProjectA</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">lakefile</span>\n</code></pre></div>\n<p>(edit: Needless folder removed)</p>\n<ul>\n<li>disadvantage here is that there is a lot of upfront work</li>\n</ul>",
        "id": 574532806,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771427610
    },
    {
        "content": "<p>How would the eventual integration work? Another target that both of these would have as a dependency?</p>",
        "id": 574537686,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771428836
    },
    {
        "content": "<p>That's one option. As a first step, having a shared \"Physics_ForMathlib\" project or something that at least lets us share our ForMathlib folders.</p>\n<p>Or you can do it \"backwards\": make a new project that depends on both, and gradually move files \"down\" to the shared project. I think this would kind of work with Option 1? This lets other contributors immediately start putting new files in the shared project, and then we gradually downstream code (starting with leaf files) into the shared project.</p>",
        "id": 574539427,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1771429245
    },
    {
        "content": "<blockquote>\n<p>Or you can do it \"backwards\": make a new project that depends on both, and gradually move files \"down\" to the shared project. I think this would kind of work with Option 1? This lets other contributors immediately start putting new files in the shared project, and then we gradually downstream code (starting with leaf files) into the shared project.</p>\n</blockquote>\n<p>I struggle to see how this would <em>not</em> end up with something that in the end is schematically different from Option 4. Given that, I don't think the two libraries share much overlap currently.</p>",
        "id": 574544451,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771430406
    },
    {
        "content": "<p>My guess (without knowing your specific situation) is that having three projects in three repositories would be the best organization.</p>",
        "id": 574545751,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1771430710
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"417654\">@Martin Dvořák</span> The reason we are thinking about combining is more of a social one rather than a technical. </p>\n<p>I think more broadly the options I gave above can be summarised into two broad approaches: </p>\n<ol>\n<li>Keep two separate Lean projects but put them in the same repo. (Option 1 -3) </li>\n<li>Combine the two Lean projects into a single Lean project with a single repo. (Option 4)</li>\n</ol>\n<p>IMO: The advantage of <code>1</code> is that it keeps the 'identity' of the two projects, but it is technically more difficult and more complicated for downstream users. The advantage of <code>2</code> is that is technically simpler and less complicated for downstream users (only one import etc), but it risks losing the 'identity' of one or both of the projects. I think this last point is something we could potentially mitigate against with careful documentation, Readme adjustments etc to make it clear the origin of the parts.</p>",
        "id": 574669435,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771488969
    },
    {
        "content": "<p>regarding your questions about importing in somwhere downstrean: iirk lake will always clone/download the entire repo but it has support to specify a subfolder where the Lean project lies to import from.</p>\n<p>Here are my thoughts:</p>\n<p>Option1: Just a regular lakefile with two default_target libraries. Downstream, you would \"require\" the entire project and then simply \"import Project A\"</p>\n<p>Option 2: looks a bit funky, but you could import B same way as in option (3). Don't see an advantage over (3) though...</p>\n<p>Option 3: you can require them with something like <code>require xy from git \"url...\" \"subfolderA\"</code></p>\n<p>Option 4: basically A is the only library and B is a part of it. can be an option if you want full integration.</p>\n<p>I think I'd recommend (1) if it's fine that they completely share the dependecies they require. Or (3) if you want to go be compnetely independent and don't care about being listed on reservoir (although don't know any recent features reservoir might have added)</p>",
        "id": 574686625,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1771494618
    },
    {
        "content": "<p>Many thanks <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span>, this is really helpful.  I think the only advantage Option 2 has over Option 3 is that there is a .lakefile in the top level directory, and would thus get indexed on the reservoir.  </p>\n<p>Out of Options 1-3, I agree that Option 1 seems like the best, and potentially better than Option 4.</p>",
        "id": 574690276,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771495875
    },
    {
        "content": "<p>Am I right in saying that in Option 1, ProjectA can depend on files in Project B AND ProjectB can depend on files in ProjectA. Further if you do e.g. <code>import ProjectB</code> downstream it will build all those files in ProjectB and precisely those needed in ProjectA.</p>",
        "id": 574690783,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771496044
    },
    {
        "content": "<p>Option 1 is sounding the best to me, too. I think that's essentially what I have with the little \"StatMech\" folder in QuantumInfo right now, but I wasn't aware that there could be multiple default targets! That's cool</p>",
        "id": 574738675,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1771510508
    },
    {
        "content": "<p>What is the consequence of a target being <del>the</del> a default? Is it (just) that <code>lake build</code> would build both?</p>",
        "id": 574744235,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1771511821
    },
    {
        "content": "<p>Yes, default only specifies what gets built with no specific target.</p>\n<p>I've used 1,2,3 and they all work smoothly.</p>",
        "id": 574795761,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1771525408
    },
    {
        "content": "<p>(But I suppose that depends on your expectations. Maybe that's a better starting place?)</p>",
        "id": 574796477,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1771525653
    },
    {
        "content": "<p>See also: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Multiple.20packages.20in.20the.20same.20repo.20.2B.20Resevoir.3F/with/569059510\">#general &gt; Multiple packages in the same repo + Resevoir?</a></p>",
        "id": 574839218,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1771543091
    },
    {
        "content": "<p>In <a href=\"https://github.com/b-mehta/Polychromatic\">https://github.com/b-mehta/Polychromatic</a> there are two separate lean projects with their own lakefiles, which seems to be a common way of working with Verso projects</p>",
        "id": 574865548,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1771562192
    }
]