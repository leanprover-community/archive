[
    {
        "content": "<p>I am learning about <code>PersistentEnvExtension</code>, but there is something that I do not understand.</p>\n<p>I created a new file that contains only the definition of a new <code>structure</code> and initializes the extension:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">AssertNotExist</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">isDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">givenName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n\n<span class=\"sd\">/-- Defines the `assertExistsExt` extension for adding an `Array` of `AssertExists`s</span>\n<span class=\"sd\">to the environment. -/</span>\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">assertExistsExt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PersistentEnvExtension</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerPersistentEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkInitial</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">    </span><span class=\"n\">addImportedFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">flatten</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">addEntryFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">push</span>\n<span class=\"w\">    </span><span class=\"n\">exportEntriesFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">AssertNotExist</span>\n</code></pre></div>\n<p>In a <em>separate</em> file, I define a function that modifies the environment, by adding an entry to the extension:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addDeclEntry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainModule</span>\n<span class=\"w\">  </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">assertExistsExt</span><span class=\"bp\">.</span><span class=\"n\">addEntry</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">      </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">isDecl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isDecl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">givenName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>This <code>addDeclEntry</code> is then used in some places in Mathlib.  I pushed this to <a href=\"https://github.com/leanprover-community/mathlib4/pull/15974\">#15974</a> and CI fails, e.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1521</span><span class=\"bp\">/</span><span class=\"mi\">4982</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">PrimeSeparator</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Qq</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.11.0-rc2/bin/lean -Dpp.unicode.fun=true -DautoImplicit=false -Dweak.linter.hashCommand=true -Dweak.linter.missingEnd=true -Dweak.linter.cdot=true -Dweak.linter.longLine=true -Dweak.linter.oldObtain=true -Dweak.linter.refine=true -Dweak.linter.setOption=true ././././Mathlib/Order/PrimeSeparator.lean -R ./././. -o ././.lake/build/lib/Mathlib/Order/PrimeSeparator.olean -i ././.lake/build/lib/Mathlib/Order/PrimeSeparator.ilean -c ././.lake/build/ir/Mathlib/Order/PrimeSeparator.c --json</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">137</span>\n</code></pre></div>\n<p>If I tried locally <code>lake build Mathlib.Order.PrimeSeparator</code> it also seems to hang, but if I open the file in VSCode, everything works.</p>\n<p>What am I doing wrong?</p>",
        "id": 463645416,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724145878
    },
    {
        "content": "<p>Actually, <code>lake build</code> just took a long time: it finished now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">PrimeSeparator</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>(It took quite a bit of time, though, to build just this file, as I had already build the imported files.)</p>",
        "id": 463646461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146054
    },
    {
        "content": "<p>It looks like you are writing a monstrous amount to the environment.</p>",
        "id": 463647447,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146281
    },
    {
        "content": "<p>The function is only used to add an entry every thing that the <code>assert_not_exists</code>/<code>assert_not_imported</code> is used.</p>",
        "id": 463647653,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146339
    },
    {
        "content": "<p>Is this really a lot?</p>",
        "id": 463647668,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146343
    },
    {
        "content": "<p>There are 427 uses of either in all of Mathlib.</p>",
        "id": 463647746,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146366
    },
    {
        "content": "<p>Though maybe I am misunderstanding how this works...</p>",
        "id": 463647872,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146391
    },
    {
        "content": "<p>No, that is not much at all in theory. But you must be capturing a lot more in implementation.</p>",
        "id": 463648064,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146430
    },
    {
        "content": "<p>It took my machine at 10x the normal amount of time to unpack the oleans with on the first 30% being present</p>",
        "id": 463648286,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146478
    },
    {
        "content": "<p>Ok, so you are saying that if I implemented this right, it should work, but, for some reason, I am adding much more stuff to the environment than what I think?</p>",
        "id": 463648468,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146524
    },
    {
        "content": "<p>That is my guess yes</p>",
        "id": 463648543,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146535
    },
    {
        "content": "<p>Is there some what to find out what it is that I am doing that is too much?</p>",
        "id": 463648654,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146554
    },
    {
        "content": "<p>Get the state after some asserts and see what it looks like</p>",
        "id": 463648828,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146584
    },
    {
        "content": "<p>Ok, note that <code>addDeclEntry</code> is the <em>only</em> entry point for the modifications that I do.</p>",
        "id": 463648893,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146617
    },
    {
        "content": "<p>This should narrow it down to</p>\n<ul>\n<li><code>addDeclEntry</code> adds too much;</li>\n<li><code>addDeclEntry</code> is used too much.</li>\n</ul>",
        "id": 463648956,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146644
    },
    {
        "content": "<p>It is probably in the modifications to <code>assert_not_exists</code> and <code>assert_not_imported</code> which call that but I haven't looked closely. <code>addEntry</code> looks reasonable to my eye but I can't be sure atm</p>",
        "id": 463649322,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724146746
    },
    {
        "content": "<p>This is how it is used in <code>assert_not_exists</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"assert_not_exists \"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverloadWithInfo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverloadWithInfo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">addDeclEntry</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">modifications</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 463649698,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146813
    },
    {
        "content": "<p>Ah, when I was going to paste the modifications in <code>assert_not_imported</code>, I realized that there are <code>if ... then</code> <em>not</em> <code>else</code> that I thought were <code>ite</code>s!!</p>",
        "id": 463649950,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146908
    },
    {
        "content": "<p>So, I think that I am accumulating all the times that <code>if</code> applies, when I thought that I was accumulating just the <code>else</code>s...</p>",
        "id": 463650072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724146940
    },
    {
        "content": "<p>I think I see the issue: your extension is a \"fork bomb\", it copies the entries from everything upstream and adds it to every file, resulting in exponential growth</p>",
        "id": 463650311,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147038
    },
    {
        "content": "<p>I am happy to believe that it is not correctly implemented, but would this show up already with just 427 increments?</p>",
        "id": 463650497,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147095
    },
    {
        "content": "<p><code>exportEntriesFn</code> is only supposed to produce entries from the <em>current</em> file, which is why most env extensions use a pair to separate stuff from the imports from stuff to export later</p>",
        "id": 463650551,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147115
    },
    {
        "content": "<p>Even with only 1 entry, as long as the import depth is enough it will get copied and pasted exponentially many times</p>",
        "id": 463650651,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147151
    },
    {
        "content": "<p>But then how is information passed down to all files?</p>",
        "id": 463650694,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147161
    },
    {
        "content": "<p>Wouldn't a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.SimplePersistentEnvExtension#doc\">docs#Lean.SimplePersistentEnvExtension</a> be enough here?</p>",
        "id": 463650884,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724147185
    },
    {
        "content": "<p>Oh, you are saying that the past entries get added to one another if there is an \"import diamond\"?</p>",
        "id": 463651114,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147223
    },
    {
        "content": "<p><code>addImportedFn</code> takes the entries from all upstream files and adds them to the current state, then <code>exportEntriesFn</code> records that as the state for the file, so if there is an entry in A and B imports A then it will copy A's entry, and if C imports B it will see two entries and copy those two, so if D imports C it will see 4 entries...</p>",
        "id": 463651290,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147256
    },
    {
        "content": "<p>I learned this when I set my <code>addImportedFn</code> to map to the empty constant. A simple extension manages the latter for you</p>",
        "id": 463651521,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724147336
    },
    {
        "content": "<p>Ok, so <code>exportedEntriesFn</code> should return the \"difference\" of what the file started with and what it ends up with (implemented probably as adding a <code>Bool</code> field, rather than what I said).</p>",
        "id": 463651607,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147368
    },
    {
        "content": "<p>Matt, thanks!  I will use a <code>SimplePersistentEnvExtension</code>.  Honestly, it looked correct, but since there was no documentation for it, I thought that I would use the one that had some docs...</p>",
        "id": 463651815,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147419
    },
    {
        "content": "<p>Also, thank you both for your help!  I now understand the issue and I think that I can get along with a solution!</p>",
        "id": 463651989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147454
    },
    {
        "content": "<p>The usual way it's implemented is that the state is a pair of some state for lookups combining everything so far (e.g. a hashmap of entries), and a <code>List</code> of entries that have been declared in the current file. The initial state from <code>addImportedFn</code> combines all the upstream stuff to produce the hashmap and initializes the list to <code>[]</code>, and <code>exportEntriesFn</code> ignores the hashmap and outputs the list as an array</p>",
        "id": 463652124,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147488
    },
    {
        "content": "<p>I believe that's exactly what <code>SimplePersistentEnvExtension</code> does, so if you don't need to modify that structure then you can use it directly</p>",
        "id": 463652392,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724147544
    },
    {
        "content": "<p>Ok, great!  I do not need to modify anything: I simply want to collect the information that some module/declaration was asserted not to exist somewhere and make sure that, once <code>Mathlib.lean</code> has been build, that the enviroment eventually contains the non-existing things.</p>",
        "id": 463653332,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147750
    },
    {
        "content": "<p>So, simply accumulating all the \"assertions\" (even with repetitions, given the total numbers) is good enough.</p>",
        "id": 463653540,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147793
    },
    {
        "content": "<p>Although, while I am at it, I may as well store the \"assertions\" in a <code>HashSet</code>, rather than an <code>Array</code>.</p>",
        "id": 463654002,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724147892
    },
    {
        "content": "<p>I think that's common practice but may not make much of a difference here</p>",
        "id": 463654262,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724147943
    },
    {
        "content": "<p>Since converting <code>Array</code>s into <code>HashSet</code>s is completely straightforward, I might as well do it.</p>",
        "id": 463654499,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724148000
    },
    {
        "content": "<p>For reference, here is the initialization of the attribute extension in core</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">attributeExtension</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AttributeExtension</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerPersistentEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">mkInitial</span><span class=\"w\">       </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AttributeExtension.mkInitial</span>\n<span class=\"w\">    </span><span class=\"n\">addImportedFn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AttributeExtension.addImported</span>\n<span class=\"w\">    </span><span class=\"n\">addEntryFn</span><span class=\"w\">      </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">addAttrEntry</span>\n<span class=\"w\">    </span><span class=\"n\">exportEntriesFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s.newEntries.reverse.toArray</span>\n<span class=\"w\">    </span><span class=\"n\">statsFn</span><span class=\"w\">         </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"s2\">\"number of local entries: \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">s.newEntries.length</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 463654849,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724148054
    },
    {
        "content": "<p>Does this look correct?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">assertExistsExt</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">SimplePersistentEnvExtension</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">AssertExists</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerSimplePersistentEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">addImportedFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">insertMany</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">    </span><span class=\"n\">addEntryFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">insert</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 463655543,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724148239
    },
    {
        "content": "<p>At least, with the change above, the time to build just the first \"broken\" file (with the imports already built) is very short:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">PrimeSeparator</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"bp\">.</span>\n\n<span class=\"n\">real</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">m1</span><span class=\"o\">,</span><span class=\"mi\">990</span><span class=\"n\">s</span>\n<span class=\"n\">user</span><span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"n\">m1</span><span class=\"o\">,</span><span class=\"mi\">502</span><span class=\"n\">s</span>\n<span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">m0</span><span class=\"o\">,</span><span class=\"mi\">352</span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 463656815,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724148685
    },
    {
        "content": "<p>CI at least was able to build mathlib with the definition above.  It also checked that all declarations and imports currently checked to not exist somewhere are in fact eventually present!  See the <code>check assertions</code> tab in <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10471754232/job/28999694961?pr=15974\">this CI run</a>.</p>",
        "id": 463691121,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724158090
    },
    {
        "content": "<p>I will prepare a cleaned up PR and will make sure to <code>!bench</code> it, to see how it performs.</p>",
        "id": 463691243,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724158116
    }
]