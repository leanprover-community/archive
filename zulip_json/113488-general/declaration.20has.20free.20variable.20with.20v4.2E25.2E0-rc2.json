[
    {
        "content": "<p>I got <code>(kernel) declaration has free variables 'insert._proof_2'</code> when upgrading to v4.25.0-rc2. Here is a minimized example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">versionString</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">SparseSet</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">dense</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">sparse</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"c1\">-- sparse_dense : ∀ i : Fin n, i &lt; count → sparse[dense[i.val].val] = i</span>\n<span class=\"w\">  </span><span class=\"c1\">-- le_count : count ≤ n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SparseSet</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SparseSet</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">count</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dense</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sparse</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">isLt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">dense'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dense</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">sparse_dense'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sparse</span><span class=\"o\">[</span><span class=\"n\">dense'</span><span class=\"o\">[</span><span class=\"n\">j</span><span class=\"o\">]]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dense'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sparse</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>It seems the nightly has already fixed the issue. Will the fix get backported to v4.25.0?</p>",
        "id": 547494092,
        "sender_full_name": "pandaman",
        "timestamp": 1761658211
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395416\">@pandaman</span>, could you try to identify which PR fixed your problem? Without that, there's nothing to backport.</p>",
        "id": 547612060,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761700138
    },
    {
        "content": "<p>Do we have pre-built compiler artifacts? I can try bisecting them.</p>",
        "id": 547624407,
        "sender_full_name": "pandaman",
        "timestamp": 1761709934
    },
    {
        "content": "<p>Yes, you can set the contents of <code>lean-toolchain</code> to e.g. <code>leanprover/lean4:nightly-2025-10-27</code>. These form a linear chain, so should be bisectable. (Although not out-of-the-box by <code>git bisect</code>.)</p>\n<p>For individual PRs, there is usually, but not always, a toolchain available of the form <code>leanprover/lean4-pr-releases:pr-release-10967</code>.</p>",
        "id": 547630220,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761714420
    },
    {
        "content": "<p>The issue was introduced by <code>leanprover/lean4:nightly-2025-10-03</code> and fixed by <code>leanprover/lean4:nightly-2025-10-25</code>. I haven't investigated which commit was the culprit.</p>\n<h2>Log</h2>\n<h3>Phase 1: Bisecting regression (2025-09-02 to 2025-10-10)</h3>\n<ul>\n<li>[x] leanprover/lean4:nightly-2025-09-02: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-09-21: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-09-30: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-10-02: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-10-03: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n<li>[x] leanprover/lean4:nightly-2025-10-05: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n<li>[x] leanprover/lean4:nightly-2025-10-10: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n</ul>\n<h3>Phase 2: Bisecting fix (2025-10-10 to 2025-10-27)</h3>\n<ul>\n<li>[x] leanprover/lean4:nightly-2025-10-18: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n<li>[x] leanprover/lean4:nightly-2025-10-22: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n<li>[x] leanprover/lean4:nightly-2025-10-24: Build failed with <code>(kernel) declaration has free variables 'insert._proof_2'</code></li>\n<li>[x] leanprover/lean4:nightly-2025-10-25: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-10-26: Build succeeded (sorry is ok)</li>\n<li>[x] leanprover/lean4:nightly-2025-10-27: Build succeeded (sorry is ok)</li>\n</ul>\n<h2>Result</h2>\n<p>Regression introduced on: <strong>2025-10-03</strong> (nightly-2025-10-03)<br>\nThe fix was introduced on: <strong>2025-10-25</strong> (nightly-2025-10-25)</p>",
        "id": 547736748,
        "sender_full_name": "pandaman",
        "timestamp": 1761749413
    },
    {
        "content": "<p>Commits in <code>2025-10-03</code>:</p>\n<ul>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/643da1ea1b39ea3df2def6196f6d076c53c3e442\">643da1e</a> test: disable flaky tests (<a href=\"https://github.com/leanprover/lean4/pull/10665\">lean4#10665</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/3d75c2ce2b18185342f018a8b36cb4635fb6d566\">3d75c2c</a> fix: eliminate potential source of inlay hint flakiness (<a href=\"https://github.com/leanprover/lean4/pull/10664\">lean4#10664</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/b979fa012ba9ba44284e4bc0c5d3081e806fde51\">b979fa0</a> fix: verso docstring {name} role suggestion overload (<a href=\"https://github.com/leanprover/lean4/pull/10663\">lean4#10663</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/288b7d2023bc1f95771cd3022144d707e7aca0f7\">288b7d2</a> chore: further cleanup from shaking <code>Init</code> (<a href=\"https://github.com/leanprover/lean4/pull/10658\">lean4#10658</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/5c707d936c9766d354e142e79d2f965af5ba07f2\">5c707d9</a> chore: rename <code>Stream</code> to <code>Std.Stream</code> (<a href=\"https://github.com/leanprover/lean4/pull/10645\">lean4#10645</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/5a2e46b0211ad353399b21af4be9edbe65c32b72\">5a2e46b</a> fix: equational theorem generation: avoid reducing at transparency all (<a href=\"https://github.com/leanprover/lean4/pull/10654\">lean4#10654</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/24c86fc05d5abeb147be04275fe6945d39f6b8c3\">24c86fc</a> fix: improve error message for <code>mstart</code> when goal is not a <code>Prop</code> (<a href=\"https://github.com/leanprover/lean4/pull/10650\">lean4#10650</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/d17160518c3dfb466a4c45c56621ab3922bf07bc\">d171605</a> chore: module system fixes and refinements from Mathlib porting (<a href=\"https://github.com/leanprover/lean4/pull/10643\">lean4#10643</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/89686fcd02391dac9acea007ba73287275006a81\">89686fc</a> refactor: replace <code>PRange shape α</code> with <code>Rcc α</code> and eight other types (<a href=\"https://github.com/leanprover/lean4/pull/10319\">lean4#10319</a>)</li>\n</ul>\n<p>Commits in <code>2025-10-25</code>:</p>\n<ul>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/d5ca0c7032fe18e5bbdb19600075e01677bca659\">d5ca0c7</a> fix: bug in <code>cutsat</code> model construction (<a href=\"https://github.com/leanprover/lean4/pull/10951\">lean4#10951</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/3c2ab0fefab9ca594117253d550862508c6d4eda\">3c2ab0f</a> feat: model-based theory combination tactic and action (<a href=\"https://github.com/leanprover/lean4/pull/10950\">lean4#10950</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/1643fd7532167d85f1a5f36d1c9b59e87e9038e6\">1643fd7</a> fix: <code>finish?</code> checks whether solver propagation steps are needed (<a href=\"https://github.com/leanprover/lean4/pull/10949\">lean4#10949</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/53442d48f54b0aaac6379e4506e6f9b65d78b9d1\">53442d4</a> feat: <code>finish?</code> produces partial tactic scripts with <code>sorry</code> (<a href=\"https://github.com/leanprover/lean4/pull/10948\">lean4#10948</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/96bace56fa6a33663f4fe08b2e589b64a0576d72\">96bace5</a> fix: run enableRealizationsForConst on sizeOf decls (<a href=\"https://github.com/leanprover/lean4/pull/10944\">lean4#10944</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/b0127e01e36ba5dc389c644a14e7a80f3310c768\">b0127e0</a> chore: final module system fixes and refinements for initial Mathlib porting (<a href=\"https://github.com/leanprover/lean4/pull/10869\">lean4#10869</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/e71d0abc7ddb2c9da37e91b88fd2be2a903601c7\">e71d0ab</a> test: test case for <a href=\"https://github.com/leanprover-community/mathlib4/pull/10775\">#10775</a> (<a href=\"https://github.com/leanprover/lean4/pull/10943\">lean4#10943</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/a6d50a61b35b73576f5c4ceac08789d9517f3079\">a6d50a6</a> fix: Meta.Closure: topologically sort abstracted vars (<a href=\"https://github.com/leanprover/lean4/pull/10926\">lean4#10926</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/dec007693a6a0e097623158a95642cc78cdff97f\">dec0076</a> chore: fix C++ warning (<a href=\"https://github.com/leanprover/lean4/pull/10922\">lean4#10922</a>)</li>\n<li><a href=\"https://github.com/leanprover/lean4-nightly/commit/11454985215b1c53f5d41c77b778c8c2cb498467\">1145498</a> fix: regression from ST redefinition (<a href=\"https://github.com/leanprover/lean4/pull/10940\">lean4#10940</a>)</li>\n</ul>\n<p>Out of those, <a href=\"https://github.com/leanprover/lean4/pull/10926\">lean4#10926</a> fixes <a href=\"https://github.com/leanprover/lean4/pull/10705\">lean4#10705</a>, which has a similar error message.</p>",
        "id": 547739326,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761749946
    },
    {
        "content": "<p>Yes, the error is fixed on <code>leanprover/lean4-pr-releases:pr-release-10926</code>. So <a href=\"https://github.com/leanprover/lean4/pull/10926\">lean4#10926</a> might be a candidate for backporting to the 4.25 branch.</p>",
        "id": 547740617,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761750190
    },
    {
        "content": "<p>I've added the backport-v4.25 label. A bot will hopefully do the rest now!</p>",
        "id": 547822315,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761776523
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 547825275,
        "sender_full_name": "pandaman",
        "timestamp": 1761778217
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/10954\">lean4#10954</a> might also be worth backporting</p>",
        "id": 548041759,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761862916
    }
]