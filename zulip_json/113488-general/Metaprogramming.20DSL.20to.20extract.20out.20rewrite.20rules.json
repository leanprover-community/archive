[
    {
        "content": "<p>I've been reading the Lean4 metaprogramming book and I'm stuck on a DSL I want to implement, which is for simple term rewriting. I can change the syntax if it makes parsing easier.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\">   </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inst</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Inst</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">sub</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Inst</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabIntoRewrite</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">rewrite</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``Inst.const</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"[rewrite| \"</span><span class=\"w\"> </span><span class=\"n\">syn</span><span class=\"o\">:</span><span class=\"n\">rewrite</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabIntoRewrite</span><span class=\"w\"> </span><span class=\"n\">syn</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rewrite</span><span class=\"bp\">|</span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">0</span>\n<span class=\"o\">}]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rewrite</span><span class=\"bp\">|</span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"o\">}]</span>\n</code></pre></div>\n<p>It would be nice if there was more resources on implementing complex macros like this, maybe it would be better to use a more complex function and not simple pattern matching. Though using an external tool to generate the rewrite rules might be fine also.</p>",
        "id": 538059540,
        "sender_full_name": "l1mey",
        "timestamp": 1757230082
    },
    {
        "content": "<p>Hmm this is currently a syntax error; is this more like what you want?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\">   </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"const \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"add \"</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"add \"</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\" %\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"sub \"</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"sub \"</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\" %\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rewrite</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"s2\">\"u\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\" = \"</span><span class=\"w\"> </span><span class=\"n\">rewrite</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">rewriteSeq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">withPosition</span><span class=\"o\">(</span><span class=\"n\">many</span><span class=\"o\">(</span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">colEq</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">colEq</span><span class=\"w\"> </span><span class=\"s2\">\"=&gt;\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">colEq</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"n\">ppDedent</span><span class=\"o\">(</span><span class=\"n\">ppLine</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[rewrite| \"</span><span class=\"w\"> </span><span class=\"n\">rewriteSeq</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rewrite</span><span class=\"bp\">|</span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">0</span>\n<span class=\"o\">}]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rewrite</span><span class=\"bp\">|</span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">%</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"o\">}]</span>\n</code></pre></div>",
        "id": 538065507,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757237016
    }
]