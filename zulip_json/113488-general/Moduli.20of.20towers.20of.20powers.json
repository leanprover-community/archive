[
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/How.20to.20formalize.20.22compute.20this.20expression.22.20exercises.3F/near/525224778\">said</a>:</p>\n<blockquote>\n<p>it seems like we don't have the simp lemma <code>Coprime a n -&gt; a^b%n = a^(b%Phi(n))%n</code></p>\n</blockquote>\n<p>Incidentally, I actually proved this while working on olympiad problems for Numina:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"c1\">-- Nat.ModEq.pow_totient for raw modulus</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mod_eq_of_modEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ModEq</span><span class=\"bp\">.</span><span class=\"n\">pow_totient</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hn</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_add_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_mod</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_add_mul_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">one_mul</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"n\">add_assoc</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_add_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">keq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">div_add_mod'</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">rle</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">mod_lt</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">    </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">totient_pos</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">    </span><span class=\"n\">linarith</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">keq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_add_mul_totient_mod_eq_one</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mod_mod</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 525224906,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750613854
    },
    {
        "content": "<p>Please PR!</p>",
        "id": 525224932,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750613885
    },
    {
        "content": "<p>(I was thinking that I should also write something that simplifies this in the case where <code>a</code> and <code>n</code> are not Coprime, and perhaps learn enough about simprocs to write one that could reduce a more general class of expressions of this type)</p>",
        "id": 525225139,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750614258
    },
    {
        "content": "<p>I would state it as <code>a ^ (φ n + b) % n = a^(φ n + b % φ n) % n</code>; and I would be more careful about tagging it with <code>simp</code> because by itself it's a loop and there has to be some way around this that I don't know yet</p>",
        "id": 525225470,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750614678
    },
    {
        "content": "<p>perhaps just something as simple as adding <code>(h : φ n &lt; b := by norm_num)</code> as hypothesis</p>",
        "id": 525225484,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750614706
    },
    {
        "content": "<p>update: nope, that doesn't work, don't really know how to make it work</p>",
        "id": 525225670,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750614874
    },
    {
        "content": "<p>Make it a simproc that only triggers when all values are numerals <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 525225734,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1750614977
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">Coprime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">totient</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">totient</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">fooa</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"c1\">-- yes!</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foob</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- nope</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">fooc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"c1\">-- nope</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_totient_mod'</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(attach to the code above)</p>",
        "id": 525225755,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750614996
    },
    {
        "content": "<p>what I'm thinking is something like this, but it doesn't work</p>",
        "id": 525225765,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615006
    },
    {
        "content": "<p>we need to teach norm_num or simp how to evaluate φ, for example</p>",
        "id": 525225774,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615016
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/113488-general/topic/How.20to.20formalize.20.22compute.20this.20expression.22.20exercises.3F/near/525225734\">said</a>:</p>\n<blockquote>\n<p>Make it a simproc that only triggers when all values are numerals <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>\n</blockquote>\n<p>that wouldn't work, i want to trigger it for <code>3 ^ 3 ^ 3 ^ 7625597484987 % 10 = 4</code></p>",
        "id": 525225819,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615061
    },
    {
        "content": "<p>do we need a custom bigpow tactic lol</p>",
        "id": 525225835,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615084
    },
    {
        "content": "<p>We already have <code>reduce_mod_char</code> which does modular fastexp</p>",
        "id": 525225847,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615104
    },
    {
        "content": "<p>does it work for my example?</p>",
        "id": 525225855,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615128
    },
    {
        "content": "<p>Probably not, but let's see</p>",
        "id": 525225866,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615142
    },
    {
        "content": "<p>(We seem to have gotten somewhat off-topic, I'm going to try migrating this thread to a new topic.)</p>",
        "id": 525225889,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750615187
    },
    {
        "content": "<p>16 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/How.20to.20formalize.20.22compute.20this.20expression.22.20exercises.3F/with/525189577\">#general &gt; How to formalize \"compute this expression\" exercises?</a> by <span class=\"user-mention silent\" data-user-id=\"282271\">Bolton Bailey</span>.</p>",
        "id": 525225921,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750615218
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">7625597484987</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">natCast_eq_natCast_iff'</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast_pow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast_ofNat</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- takes forever</span>\n<span class=\"w\">  </span><span class=\"n\">reduce_mod_char</span>\n</code></pre></div>",
        "id": 525225947,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615261
    },
    {
        "content": "<p>We could extend <code>reduce_mod_char</code> to recursively reduce the exponents too</p>",
        "id": 525226247,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615541
    },
    {
        "content": "<p>maybe we need to define something like <code>fpow : ZMod n -&gt; ZMod (φ n) -&gt; ZMod n</code> (but with special support to deal with cases when the base is not coprime to n)</p>",
        "id": 525226343,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615671
    },
    {
        "content": "<p>What would that do?</p>",
        "id": 525226365,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615704
    },
    {
        "content": "<p>but the auxiliary problem we have is this: can someone write a tactic to prove <code>12345 &lt; 3 ^ 3 ^ 3 ^ 7625597484987</code>?</p>",
        "id": 525226375,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615722
    },
    {
        "content": "<p>I feel like that's a separate problem</p>",
        "id": 525226410,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615771
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/525226365\">said</a>:</p>\n<blockquote>\n<p>What would that do?</p>\n</blockquote>\n<p>further reduce that to a more finite problem, so for example (using a+nZ to mean the element of Z/nZ), we would have <code>↑(3^100%10) = (3+10ℤ)^100 = (3+10ℤ)^(100+4ℤ)</code></p>",
        "id": 525226446,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615813
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/525226410\">said</a>:</p>\n<blockquote>\n<p>I feel like that's a separate problem</p>\n</blockquote>\n<p>it's really not, if the base is not coprime to n then it's only \"semiperiodic\"</p>",
        "id": 525226458,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615834
    },
    {
        "content": "<p>semiperiodic means a-&gt;b-&gt;c-&gt;b-&gt;c-&gt;b-&gt;c...</p>",
        "id": 525226463,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615846
    },
    {
        "content": "<p>like the decimal expansion of a rational number (is that a theorem? XD)</p>",
        "id": 525226478,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750615869
    },
    {
        "content": "<p>or the continued fraction of a root of a quadratic equation with integer coefficients (is that a theorem?)</p>",
        "id": 525226573,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750615991
    },
    {
        "content": "<p>A tactic for proving <code>_ &lt; _ ^ _ ^ ...</code> would probably work by repeatedly logging both sides</p>",
        "id": 525226630,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616088
    },
    {
        "content": "<p>using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.lt_pow_iff_log_lt#doc\">docs#Nat.lt_pow_iff_log_lt</a> or similar</p>",
        "id": 525226671,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616155
    },
    {
        "content": "<p>Are we assuming that the modulus is relatively small here?</p>",
        "id": 525226709,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616210
    },
    {
        "content": "<p>At the very least, we have to assume that we can compute <code>n, totient n, totient (totient n), ...</code> for about as many totients as there are exponents.</p>",
        "id": 525226765,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750616299
    },
    {
        "content": "<p>btw here is the 'manual' proof for reference:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"bp\">%</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pow_totient_mod</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">pow_totient_mod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">pow_totient_mod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">mod_one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(attach to the code at the top)</p>",
        "id": 525226822,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750616390
    },
    {
        "content": "<p>What method are we using to compute <code>totient n</code>? Can we get in a <code>@[csimp]</code> lemma for it?</p>",
        "id": 525226828,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616397
    },
    {
        "content": "<p>Well, totient computation requires factorizing the number at hand. So if the modulus turns out to have large prime factors, we have an issue.</p>",
        "id": 525226892,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750616471
    },
    {
        "content": "<p>it's about time we had a tactic to factorise numbers <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 525226929,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750616521
    },
    {
        "content": "<p>I'm not too familiar with <code>csimp</code>, is there some mechanism where we can tell it to give up if it takes too long to factorize?</p>",
        "id": 525227005,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750616629
    },
    {
        "content": "<p>I did some experiments before and found that out of all the candidate implementations this one was the fastest. Unfortunately it was also the hardest to prove stuff about and I was never able to show it equals <code>totient</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">fastTotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList</span><span class=\"bp\">.</span><span class=\"n\">foldl</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prev</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n</code></pre></div>",
        "id": 525227119,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616781
    },
    {
        "content": "<p>Actually, maybe it was the other one that was faster? I forgot. I'll have to experiment again.</p>",
        "id": 525227160,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750616837
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/525226929\">said</a>:</p>\n<blockquote>\n<p>it's about time we had a tactic to factorise numbers <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>\n</blockquote>\n<p>I think <code>simp</code> can do it? <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.primeFactorsList_ofNat#doc\">docs#Nat.primeFactorsList_ofNat</a></p>",
        "id": 525227415,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750617160
    },
    {
        "content": "<p>Yes, this one seems to have been the fastest:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">fastTotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList</span><span class=\"bp\">.</span><span class=\"n\">foldl</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prev</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n</code></pre></div>",
        "id": 525227416,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750617165
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/525224932\">said</a>:</p>\n<blockquote>\n<p>Please PR!</p>\n</blockquote>\n<p>I haven't had time to do the non-coprime case, but I PRed these lemmas just now <a href=\"https://github.com/leanprover-community/mathlib4/pull/26694\">#26694</a></p>",
        "id": 527051237,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751566330
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/525225470\">said</a>:</p>\n<blockquote>\n<p>I would state it as <code>a ^ (φ n + b) % n = a^(φ n + b % φ n) % n</code>; and I would be more careful about tagging it with <code>simp</code> because by itself it's a loop and there has to be some way around this that I don't know yet</p>\n</blockquote>\n<p>The thing that makes me nervous about using this approach to simplify <code>(b ^ e) % n</code> is: How do we determine, if <code>e</code> is itself a potentially complicated expression involving exponents, whether <code>n &lt; e</code>. This seems necessary so that we know whether to apply the lemma or just evaluate <code>b ^ e</code> normally, but I'm not sure how to do it without introducing a more complicated decision procedure.</p>\n<p>Might another approach be: Determine the factorization of <code>n</code>, use CRT to reduce the problem of computing <code>(b ^ e) % (p ^ a)</code> for all <code>p^a</code> in the factorization, reexpress <code>b = p^k * b'</code> and then evaluate <code>(p^k ^ e) % (p^a)</code> and <code>b' % (p ^ a)</code> separately?</p>",
        "id": 527055158,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751567928
    },
    {
        "content": "<p>I could write a tactic</p>",
        "id": 527055543,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568102
    },
    {
        "content": "<p>What I really want is for <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> and <span class=\"user-mention\" data-user-id=\"376152\">@Paul Lezeau</span> to publish more of their <a href=\"https://leanprover-community.github.io/blog/posts/simprocs-for-the-working-mathematician/\">simprocs for the working mathematician series</a> so we can make this a simproc <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 527056207,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751568357
    },
    {
        "content": "<p>A simproc might be challenging</p>",
        "id": 527056254,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568376
    },
    {
        "content": "<p>since you have to do it somewhat recursively</p>",
        "id": 527056290,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568388
    },
    {
        "content": "<p>Nevertheless, I think this feels more appropriate as a simproc, because I would like it to automatically happen when someone calls <code>simp</code> without anyone having to learn the name and scope of a new tactic.</p>",
        "id": 527056582,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751568504
    },
    {
        "content": "<p>It feels somewhat outside the scope of <code>simp</code></p>",
        "id": 527056698,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568562
    },
    {
        "content": "<p><code>simp</code> isn't for computing numeric expression, that's <code>norm_num</code></p>",
        "id": 527056796,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568605
    },
    {
        "content": "<p>And <code>norm_num</code> doesn't really work on this either, since you have to take into account a modulus</p>",
        "id": 527056840,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568625
    },
    {
        "content": "<p>Can simprocs be added to <code>norm_num</code>?</p>",
        "id": 527056886,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751568645
    },
    {
        "content": "<p><code>norm_num</code> calls <code>simp</code></p>",
        "id": 527056923,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568657
    },
    {
        "content": "<p>It's also extensible</p>",
        "id": 527056986,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568676
    },
    {
        "content": "<p>So you can register a \"norm_num extension\" to whatever operation you want</p>",
        "id": 527057020,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568694
    },
    {
        "content": "<p>For example in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26317\">#26317</a> I added one for <code>Nat.clog</code></p>",
        "id": 527057093,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568728
    },
    {
        "content": "<p>Right, ok, this norm_num extension thing sounds like the most-in-scope home for something like this.</p>",
        "id": 527057415,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751568850
    },
    {
        "content": "<p>But you don't get a modulus to work with</p>",
        "id": 527057445,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568867
    },
    {
        "content": "<p>Something like <code>reduce_mod_char</code> seems like a much better fit for this kind of simplification, but <code>reduce_mod_char</code> is kind of broken and just about the only thing it's good for is fast modexp</p>",
        "id": 527057540,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568907
    },
    {
        "content": "<p>Not sure what you mean, is it not possible to write a norm_num extension that does something like \"check if the term looks like (b ^ &lt;expression of literals&gt; % n) and use this approach if so\"?</p>",
        "id": 527057668,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751568958
    },
    {
        "content": "<p>It is <em>possible</em>, but I don't think it's a good idea</p>",
        "id": 527057719,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751568976
    },
    {
        "content": "<p><code>simp</code> goes bottom up anyways, so if you run <code>norm_num</code> you'll probably end up simplifying the inside first</p>",
        "id": 527057853,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751569039
    },
    {
        "content": "<p>But I wouldn't know since I haven't tried it</p>",
        "id": 527057899,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751569059
    },
    {
        "content": "<p>If I have an expression like this and I think \"I want to normalize this into an explicit number\", I think that the next thing I am likely to think is \"maybe this is something that <code>norm_num</code> does\" and try it.</p>\n<p>Frankly, looking at <code>reduce_mod_char</code> I am not sure why this exists as a separate tactic from norm num, couldn't the functionality of reduce_mod_char be folded into norm_num?</p>\n<blockquote>\n<p>bottom up</p>\n</blockquote>\n<p>I though there were ways to counteract this, like the little down-arrow version you see on reduceIte</p>",
        "id": 527058544,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1751569359
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"282271\">Bolton Bailey</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527058544\">said</a>:</p>\n<blockquote>\n<p>Frankly, looking at <code>reduce_mod_char</code> I am not sure why this exists as a separate tactic from norm num, couldn't the functionality of reduce_mod_char be folded into norm_num?</p>\n</blockquote>\n<p>According to some comments around the implementation for <code>reduce_mod_char</code>:</p>\n<blockquote>\n<p>This is not a <code>norm_num</code> plugin because it does not match on the syntax of <code>e</code>,<br>\nrather it matches on the type of <code>e</code>.</p>\n</blockquote>",
        "id": 527058942,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751569556
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"282271\">Bolton Bailey</span> <a href=\"#narrow/stream/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527056207\">said</a>:</p>\n<blockquote>\n<p>What I really want is for <span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> and <span class=\"user-mention silent\" data-user-id=\"376152\">Paul Lezeau</span> to publish more of their <a href=\"https://leanprover-community.github.io/blog/posts/simprocs-for-the-working-mathematician/\">simprocs for the working mathematician series</a> so we can make this a simproc <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>\n</blockquote>\n<p>Yaël and I have both been distracted with other stuff lately but the plan is to try and finish another one up over the current month or so!</p>",
        "id": 527059272,
        "sender_full_name": "Paul Lezeau",
        "timestamp": 1751569710
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527056290\">said</a>:</p>\n<blockquote>\n<p>since you have to do it somewhat recursively</p>\n</blockquote>\n<p>That's no issue <span aria-label=\"cowboy\" class=\"emoji emoji-1f920\" role=\"img\" title=\"cowboy\">:cowboy:</span></p>",
        "id": 527059377,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1751569767
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527059377\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527056290\">said</a>:</p>\n<blockquote>\n<p>since you have to do it somewhat recursively</p>\n</blockquote>\n<p>That's no issue <span aria-label=\"cowboy\" class=\"emoji emoji-1f920\" role=\"img\" title=\"cowboy\">:cowboy:</span></p>\n</blockquote>\n<p>Can you explain</p>",
        "id": 527059433,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751569795
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527057853\">said</a>:</p>\n<blockquote>\n<p><code>simp</code> goes bottom up anyways, so if you run <code>norm_num</code> you'll probably end up simplifying the inside first</p>\n</blockquote>\n<p>That is factually incorrect, or at least requires a few disclaimers</p>",
        "id": 527059490,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1751569818
    },
    {
        "content": "<p>I'll take a look at the code and see what it does</p>",
        "id": 527059649,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751569895
    },
    {
        "content": "<p>oh it does it twice?</p>",
        "id": 527059943,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751570052
    },
    {
        "content": "<p>oh there's pre and post norm_num extensions</p>",
        "id": 527060060,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751570106
    },
    {
        "content": "<p>that makes sense</p>",
        "id": 527060080,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751570114
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Moduli.20of.20towers.20of.20powers/near/527059433\">said</a>:</p>\n<blockquote>\n<p>Can you explain</p>\n</blockquote>\n<p>You can read the code of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=existsAndEq#doc\">docs#existsAndEq</a> or wait for Paul and I to publish the blogpost about it</p>",
        "id": 527123958,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1751614913
    }
]