[
    {
        "content": "<p>Can I run shake in CI in FLT somehow?</p>",
        "id": 514517702,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745657265
    },
    {
        "content": "<p>I think the reason I care is different to the reason that mathlib cares -- I just want to minimise the time it takes to build the docs in CI!</p>",
        "id": 514517764,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745657300
    },
    {
        "content": "<p>Try <code>lake exe shake FLT</code> locally to see if it works. In my experience it worked until very recently (in Toric) and now fails with a confusing error message about <code>././././scripts/noshake.json</code>.</p>",
        "id": 514517794,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745657337
    },
    {
        "content": "<p>Just put <code>{}</code> in that file and it works (at least it doesn't complain)</p>",
        "id": 514518211,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1745657710
    },
    {
        "content": "<p>I can confirm that running <code>lake exe shake FLT</code> I got a confusing error message about <code>scripts/noshake.json</code> (it's confusing because it says <code>Invalid config file '././././scripts/noshake.json'</code> but what it means is that the file is completely missing) and when I create the file with contents <code>{}</code> then I get what looks like helpful shaky stuff</p>",
        "id": 514520017,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659280
    },
    {
        "content": "<p>What I'm confused about is that circa 2-3 weeks ago <code>lake exe shake Toric</code> without a <code>scripts/noshake.json</code> gave me helpful shakey stuff already</p>",
        "id": 514520161,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745659383
    },
    {
        "content": "<p>That's progress for you!</p>",
        "id": 514520263,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659459
    },
    {
        "content": "<p>But shake is supposedly extremely stable <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 514520378,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745659565
    },
    {
        "content": "<p>First FLT error is a false positive -- I <code>import Mathlib.Analysis.Quaternion</code> because I want notation <code>ℍ</code> from that file, rather than any of the theorems :-) Is there some kind of shake wishlist or tracking issue? I can just announce that I don't want to shake this and then forget about it, but is this some kind of indication that mathlib should have a <code>Mathlib.Analysis.Quaternion.Notation</code> file or something? Is notation definitely out of scope for shake?</p>",
        "id": 514520417,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659607
    },
    {
        "content": "<p>shake doesn't detect uses of notation, and probably never will</p>",
        "id": 514520551,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745659696
    },
    {
        "content": "<p>If anything, creating notation-only files makes the issue worse!</p>",
        "id": 514520574,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745659727
    },
    {
        "content": "<p>oh yeah :-)</p>",
        "id": 514520584,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659738
    },
    {
        "content": "<p>Well at least it looks like I have something to put into <code>scripts/noshake.json</code>!</p>",
        "id": 514520608,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659774
    },
    {
        "content": "<p>wait -- can I not put a comment in a json file saying why I'm not shaking this import??</p>",
        "id": 514520746,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745659866
    },
    {
        "content": "<p>\"Comments are not permitted in JSON.\" <span aria-label=\"rofl\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rofl\">:rofl:</span> Oh well</p>",
        "id": 514520896,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745660000
    },
    {
        "content": "<p>Yeah, I'm afraid JSON is for interchange only, not reading or writing yourself :)</p>",
        "id": 514524160,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745662461
    },
    {
        "content": "<p>Is there a recommended way of keeping track of various reasons that shake was \"wrong\" about imports?</p>",
        "id": 514524215,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745662507
    },
    {
        "content": "<p>Or are these reasons all already known and wontfix and the idea is that having a noshake file which we can just forget about even if things change is the way we're supposed to be doing it?</p>",
        "id": 514524329,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745662565
    },
    {
        "content": "<p>I doubt it needs much explanation? You can always try removing the import and see what breaks</p>",
        "id": 514524338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745662569
    },
    {
        "content": "<p>I somehow have it in my head that these JSON files used to represent things that we were supposed to fix (modules without docstrings which the community hadn't yet written, linting errors which the community hadn't got around to dealing with etc etc) but here the file seems to indicate shortcomings in the system, which seems like a different thing</p>",
        "id": 514524515,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745662700
    },
    {
        "content": "<p>Right now I'm looking at a big JSON file called <code>nolints.json</code> and thinking \"I can make this smaller by adding a bunch of docstrings and that will make my project better\" but for the shake file the idea seems to be that I'm not striving to make it smaller?</p>",
        "id": 514524581,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745662769
    },
    {
        "content": "<p>I agree with your analysis. <code>noshake.json</code> is not expected to get smaller with time. shake is already optimal  for its level of complexity, and a new tool would need to be much more complicated to improve upon it.</p>",
        "id": 514526121,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745663979
    },
    {
        "content": "<p>OK, I'll get back to nolints :-)</p>",
        "id": 514526688,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745664405
    },
    {
        "content": "<p>My main motivation really is to stop people sneakily adding <code>import Mathlib</code> to the repo and thus doubling the amount of mathlib docs we have to build.</p>",
        "id": 514526819,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745664498
    },
    {
        "content": "<p>I have a step linting for this in Toric. Do you want it?</p>",
        "id": 514526997,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745664645
    },
    {
        "content": "<p>Here it is: <a href=\"https://github.com/YaelDillies/Toric/blob/master/.github/workflows/push_master.yml#L24-L27\">https://github.com/YaelDillies/Toric/blob/master/.github/workflows/push_master.yml#L24-L27</a></p>",
        "id": 514527107,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745664725
    },
    {
        "content": "<p>Is there a way I can do \"do all the things <code>lake exe shake FLT</code> suggests\" other than doing them manually?</p>",
        "id": 514530961,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745667914
    },
    {
        "content": "<p><code>lake exe shake --fix FLT</code>?</p>",
        "id": 514531150,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745668022
    },
    {
        "content": "<p>Now my project mostly builds but I want to add a couple more things to noshake. Is there an automatic way of saying \"I know shake is noisy right now but apply none of the suggestions you're making, instead add them all to noshake\"?</p>",
        "id": 514531623,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745668388
    },
    {
        "content": "<p>Yes, that's <code>lake exe shake --update FLT</code></p>",
        "id": 514531668,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745668439
    },
    {
        "content": "<p>I'm now trying to understand the remaining errors. Is it a known thing that a simp call can break if you remove an import which shake tells you to remove? More details: if I change the <code>simp</code> to a <code>simp only</code> then it explicitly uses a lemma in the (FLT, not mathlib) file which shake is telling me to remove. Is this a bug?</p>",
        "id": 514532920,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745669340
    },
    {
        "content": "<p>Another question. Shake tells me to change the import here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">gcongr</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">alias</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">GCongr</span><span class=\"bp\">.</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup_le</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup_le</span>\n</code></pre></div>\n<p>(that's the entire file) from <code>...Submodule.Basic</code> to <code>...Submodule.Defs</code> but <code>Submodule.toAddSubgroup_le</code> is defined in <code>Mathlib.Algebra.Module.Submodule.Basic</code>. So aliases are also problematic for shake?</p>\n<p>Is there a list of known issues?</p>",
        "id": 514533113,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745669482
    },
    {
        "content": "<p>(I know that it has problems with tactic imports)</p>",
        "id": 514533232,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745669542
    },
    {
        "content": "<p>Some of these are subtle: I removed an import of a random maths file and a proof broke and the fix was to import <code>Mathlib.Tactic.Have</code>! Somehow some of <code>have</code>'s syntax was missing. But I guess this is expected behaviour for me. The <code>simp</code> breakage was the only really surprising thing.</p>",
        "id": 514534135,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745670243
    },
    {
        "content": "<p>Mathlib.Tactic.Have defines stream-of-conscioudness have, which mathlib deprecates</p>",
        "id": 514534843,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745670766
    },
    {
        "content": "<p>The only other thing which looked like a bug to me was that in the file <code>FLT.Mathlib.GroupTheory.Index</code> which starts <code>import Mathlib.GroupTheory.Index</code> and then only contains notation, shake tells me</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">././././</span><span class=\"n\">FLT</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">Index</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Init</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">Index</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">Prelude</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and it was the occurrence of <code>Init</code> which surprised me.</p>",
        "id": 514534848,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745670770
    },
    {
        "content": "<p>Aah so in fact I shouldn't be importing <code>Mathlib.Tactic.Have</code> at all?</p>",
        "id": 514534882,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745670796
    },
    {
        "content": "<p>Mathlib has a syntax linter against that, you can add that to the FLT lakefile</p>",
        "id": 514534999,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745670869
    },
    {
        "content": "<p>I'm in the middle of something else but I'll add it to the linter tracking issue :-)</p>",
        "id": 514535079,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745670943
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/113488-general/topic/shake.20in.20non-mathlib.20projects/near/514520574\">said</a>:</p>\n<blockquote>\n<p>If anything, creating notation-only files makes the issue worse!</p>\n</blockquote>\n<p>Maybe syntax-only files should be added to the list of noshake files that shake <em>always</em> ignores, instead of ignoring them every single time in every file that imports them.</p>",
        "id": 514555913,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1745685864
    },
    {
        "content": "<p>Sure, that's an option too</p>",
        "id": 514556141,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745686014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/shake.20in.20non-mathlib.20projects/near/514526819\">said</a>:</p>\n<blockquote>\n<p>My main motivation really is to stop people sneakily adding <code>import Mathlib</code> to the repo and thus doubling the amount of mathlib docs we have to build.</p>\n</blockquote>\n<p>I agree with the feeling, but do be aware that:</p>\n<ul>\n<li>not importing all of mathlib means that the FLT docs will be incomplete. In practice, this seems to only be a problem when someone is working on something new importing things that haven't been imported in FLT previously.</li>\n<li>Since docs are cached with a key depending on <code>lake-manifest.json</code> only, the cost of building extra docs is only paid once every time you bump mathlib.</li>\n</ul>",
        "id": 514556246,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745686094
    },
    {
        "content": "<p>I don't really understand what you mean by the cost of extra docs. CI takes a long time precisely because it's building half of mathlib's docs every time, right?</p>",
        "id": 514557058,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745686698
    },
    {
        "content": "<p>If it does, then something is wrong! Documentation for mathlib is cached, and the cache is cleared only when you bump mathlib.</p>",
        "id": 514557150,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745686790
    },
    {
        "content": "<p>Something I have noticed is that it takes a long time to <em>replay</em> files that have already been built (ie whose docs have already been generated). It doesn't take as long as when building the files the first time, but still not as instantaneous as expected. This is something I've been wanting to investigate.</p>",
        "id": 514557294,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745686863
    },
    {
        "content": "<p>This discussion makes me wonder: why does <code>shake</code> not flag as unused the imports of deprecated modules?</p>",
        "id": 514562791,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1745690938
    },
    {
        "content": "<p>Maybe it is because <code>Shake</code> skips import-only modules, and deprecated modules count as \"import-only\", since they only contain a deprecation, which does not add declarations to the environment!</p>",
        "id": 514563542,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1745691574
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/113488-general/topic/shake.20in.20non-mathlib.20projects/near/514520378\">said</a>:</p>\n<blockquote>\n<p>But shake is supposedly extremely stable <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n</blockquote>\n<p>Note, I haven't touched shake in ~6 months</p>",
        "id": 514571330,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745697601
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/shake.20in.20non-mathlib.20projects/near/514524215\">said</a>:</p>\n<blockquote>\n<p>Is there a recommended way of keeping track of various reasons that shake was \"wrong\" about imports?</p>\n</blockquote>\n<p>you can put a comment on the <code>import</code> line in the downstream file, if it's a one-off. If it's a file which is always a false positive (e.g. a notation-only file) I would put the comment in that file</p>",
        "id": 514571479,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745697670
    },
    {
        "content": "<p>Perhaps a reasonable feature for <code>shake</code> would be to warn you if it proposed removing an import which has a comment on the same line.</p>",
        "id": 514741534,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745825984
    }
]