[
    {
        "content": "<p>While I am at it, this is another thing I noticed: In <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.PreservesPullback.iso_inv_fst_assoc#doc\">docs#CategoryTheory.Limits.PreservesPullback.iso_inv_fst_assoc</a>, note that there is no <code>Z✝</code> declared anywhere, but the <code>f</code> argument is printed as <code>f : X ⟶ Z✝</code>. The pretty-printer does something else:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Preserves</span><span class=\"bp\">.</span><span class=\"n\">Shapes</span><span class=\"bp\">.</span><span class=\"n\">Pullbacks</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">PreservesPullback</span><span class=\"bp\">.</span><span class=\"n\">iso_inv_fst_assoc</span>\n</code></pre></div>\n<p>prints the <code>f</code> argument correctly as <code>f : X ⟶ Z</code> and the second <code>Z</code> variable as <code>Z✝</code>.</p>",
        "id": 481964331,
        "sender_full_name": "Christian Merten",
        "timestamp": 1731422267
    },
    {
        "content": "<p>Oh ha ha, the <code>reassoc</code> attribute is introducing a new <code>Z</code> which hammers the <code>Z</code> already present in the statement of <code>PreservesPullback.iso_inv_fst</code>.</p>",
        "id": 481968850,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1731423545
    },
    {
        "content": "<p>Interesting, the <code>#check</code> command prints it correctly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">PreservesPullback</span><span class=\"bp\">.</span><span class=\"n\">iso_inv_fst_assoc</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PreservesLimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cospan</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Z</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"bp\">✝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">PreservesPullback</span><span class=\"bp\">.</span><span class=\"n\">iso</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pullback</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pullback</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>What is docgen doing instead? I had been under the impression it used this signature pretty printer.</p>",
        "id": 482009397,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731435451
    },
    {
        "content": "<p>(Oh, I should read your message in full. I changed the algorithm for how <code>#check</code> prints signatures this release and I suddenly was concerned that I broke it!)</p>",
        "id": 482009617,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731435525
    },
    {
        "content": "<p>It looks like doc-gen has <a href=\"https://github.com/leanprover/doc-gen4/blob/0334a151bc15184d31b7bb5782f568cae9f2c438/DocGen4/Process/NameInfo.lean#L18-L54\">it's own signature printer</a>. The bug is that the types of the arguments are pretty printed in the context where all the arguments have already been brought into scope. This means that it's following the normal Lean rules, where the <em>first</em> <code>Z</code> is now out-of-scope.</p>\n<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Maybe a fix would be to change the <code>name.hasMacroScopes</code> check to <code>name.hasMacroScopes || (&lt;- getLCtx).hasUserName name</code>? (Didn't check that this would work, but I know functions like this exist somewhere and are used in the signature delaborator at least.)</p>",
        "id": 482012151,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731436489
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/doc-gen4/pull/231\">https://github.com/leanprover/doc-gen4/pull/231</a> changes how signatures are pretty printed to use the same algorithm as the core signature pretty printer used by <code>#check</code>.</p>",
        "id": 482045531,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731448310
    },
    {
        "content": "<p>Merged the above PR, behavior is now the same as with #check <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 482119626,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1731488059
    }
]