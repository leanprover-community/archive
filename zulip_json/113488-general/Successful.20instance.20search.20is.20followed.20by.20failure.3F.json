[
    {
        "content": "<p>The following instance search first succeeds and then fails. Anyone has tips to figure out how to debug this? It works when I replace <code>class SubSig (siga sigb : Signature) where</code> with <code>class SubSig (siga sigb : outParam Signature) where</code>, but I'm not actually sure it is always the case <code>siga</code> and <code>sigb</code> are only inferred after the fact. Is this the right way to solve this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">myNamespace</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">arity</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"bp\">.</span><span class=\"n\">symbols</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sig</span><span class=\"bp\">.</span><span class=\"n\">arity</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚àò</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Alg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">sup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sig</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">SubSig</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">}</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SubSig</span><span class=\"w\"> </span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sigb</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‚ü®</span><span class=\"n\">SubSig</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">NatTySh</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nat</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">NatTyE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">NatTySh</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">‚ü©</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">NatVal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Alg</span><span class=\"w\"> </span><span class=\"n\">NatTyE</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">‚ü®.</span><span class=\"n\">nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_‚ü©</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">IArithExprSymbols</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SubSig</span><span class=\"w\"> </span><span class=\"n\">NatTyE</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">IArithExprSymbols</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">siga</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NatTyE</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ü®.</span><span class=\"n\">nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">nomatch</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">--succeeds</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IArithExprSymbols</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚ü®.</span><span class=\"n\">nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">nomatch</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ext</span><span class=\"w\"> </span><span class=\"n\">NatTyE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">sig</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"c1\">--succeeds</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IArithExprSymbols</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- tracing this line</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IArithExprSymbols</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">NatTySh</span><span class=\"bp\">.</span><span class=\"n\">nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">nomatch</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- doesn't work either, succeeds with `outParam` change</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">‚ñ∂ expected type (71:36-71:37)</span>\n<span class=\"cm\">sig : Signature</span>\n<span class=\"cm\">inst : SubSig NatTyE sig</span>\n<span class=\"cm\">‚ä¢ Ext ?m.6063 (W sig)</span>\n\n<span class=\"cm\">‚ñ∂ 71:29-71:37: error:</span>\n<span class=\"cm\">typeclass instance problem is stuck, it is often due to metavariables</span>\n<span class=\"cm\">  SubSig ?m.6063 sig</span>\n\n<span class=\"cm\">‚ñ∂ 71:10-71:38: information:</span>\n<span class=\"cm\">[Meta.synthInstance] üí•Ô∏è SubSig NatTyE ?m.6058 ‚ñº</span>\n<span class=\"cm\">  [] new goal SubSig NatTyE ?m.6058 ‚ñº</span>\n<span class=\"cm\">  [instances] #[@SubAlg.toSubSig, inst]</span>\n<span class=\"cm\">  [] üí•Ô∏è apply inst to SubSig NatTyE ?m.6058 ‚ñº</span>\n<span class=\"cm\">  [tryResolve] üí•Ô∏è SubSig NatTyE ?m.6058 ‚âü SubSig NatTyE sig</span>\n\n<span class=\"cm\">[Meta.synthInstance] üí•Ô∏è SubSig NatTyE ?m.6064 ‚ñº</span>\n<span class=\"cm\">  [] new goal SubSig NatTyE ?m.6064 ‚ñº</span>\n<span class=\"cm\">  [instances] #[@SubAlg.toSubSig, inst]</span>\n<span class=\"cm\">  [] üí•Ô∏è apply inst to SubSig NatTyE ?m.6064 ‚ñº</span>\n<span class=\"cm\">  [tryResolve] üí•Ô∏è SubSig NatTyE ?m.6064 ‚âü SubSig NatTyE sig</span>\n\n<span class=\"cm\">[Meta.synthInstance] ‚úÖÔ∏è SubSig NatTyE sig ‚ñº</span>\n<span class=\"cm\">  [] result inst (cached)</span>\n\n\n<span class=\"cm\">‚ñ∂ 71:29-71:37: information:</span>\n\n<span class=\"cm\">[Meta.synthInstance] üí•Ô∏è SubSig ?m.6063 ?m.6064 ‚ñº</span>\n<span class=\"cm\">  [] new goal SubSig ?m.6063 ?m.6064 ‚ñ∂</span>\n<span class=\"cm\">  [] üí•Ô∏è apply inst to SubSig ?m.6063 ?m.6064 ‚ñ∂</span>\n\n<span class=\"cm\">...</span>\n\n<span class=\"cm\">[Meta.synthInstance] üí•Ô∏è SubSig ?m.6063 sig ‚ñº</span>\n<span class=\"cm\">  [] new goal SubSig ?m.6063 sig ‚ñº</span>\n<span class=\"cm\">  [instances] #[@SubAlg.toSubSig, inst]</span>\n<span class=\"cm\">  [] üí•Ô∏è apply inst to SubSig ?m.6063 sig ‚ñº</span>\n<span class=\"cm\">  [tryResolve] üí•Ô∏è SubSig ?m.6063 sig ‚âü SubSig NatTyE sig</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489164194,
        "sender_full_name": "nrs",
        "timestamp": 1734334233
    },
    {
        "content": "<p>Can you add the imports to make your example work?</p>",
        "id": 489165774,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734334879
    },
    {
        "content": "<p>Sorry I should be used to doing this by now</p>",
        "id": 489166060,
        "sender_full_name": "nrs",
        "timestamp": 1734334988
    },
    {
        "content": "<p>done</p>",
        "id": 489166081,
        "sender_full_name": "nrs",
        "timestamp": 1734334993
    },
    {
        "content": "<p>I get a syntax error after your last line, your <code>(</code>s aren't closed</p>",
        "id": 489166316,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734335056
    },
    {
        "content": "<p>argh fixed my bad</p>",
        "id": 489166391,
        "sender_full_name": "nrs",
        "timestamp": 1734335081
    },
    {
        "content": "<p>I guess <code>(set_option trace.Meta.synthInstance true in inject _)</code> is needed to see the trace messages</p>",
        "id": 489166548,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734335143
    },
    {
        "content": "<p>I used <code>set_option trace.Meta.synthInstance true</code> at the top of the inductive declaration (didn't know you could literally <code>set_option</code> right inside a term, thanks!)</p>",
        "id": 489166715,
        "sender_full_name": "nrs",
        "timestamp": 1734335198
    },
    {
        "content": "<p>I think in the term it maybe doesn't show the thing you wanted to show (success followed by failure)</p>",
        "id": 489166885,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734335269
    },
    {
        "content": "<p>But your issue here is that typeclass synthesis is not allowed to populate metavariables, unless you mark them as <code>outParam</code> or <code>semiOutParam</code></p>",
        "id": 489167048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734335326
    },
    {
        "content": "<p>And you should think carefully about whether those are actually what you want, or if instead the caller should just have provided a type annotation</p>",
        "id": 489167102,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734335348
    },
    {
        "content": "<p>Hm right when I use <code>trace.Meta.synthInstance</code> directly inside the term there's only the failure, but at the top of the inductive it reports that on the same line there's a success before the failure</p>",
        "id": 489167487,
        "sender_full_name": "nrs",
        "timestamp": 1734335508
    },
    {
        "content": "<p>I'll be investigating <code>outParam</code> and <code>semiOutParam</code> more closely, thanks a lot for taking the time!!</p>",
        "id": 489167560,
        "sender_full_name": "nrs",
        "timestamp": 1734335526
    },
    {
        "content": "<p>Note that the indentation is currently broken for the trace output (<a href=\"https://github.com/leanprover/lean4/pull/6389\">lean4#6389</a>), which can make it hard to read</p>",
        "id": 489170912,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734336653
    },
    {
        "content": "<p>You can work around it by using <code>#guard_msgs in</code>, and then the version that gets copied into a comment has the correct indentation</p>",
        "id": 489171052,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734336709
    },
    {
        "content": "<p>Noted! very useful stuff, thanks a lot!</p>",
        "id": 489171602,
        "sender_full_name": "nrs",
        "timestamp": 1734336897
    }
]