[
    {
        "content": "<p>I'm trying to create a project that depends on the Lean-QuantumInfo project (<a href=\"https://github.com/Timeroot/Lean-QuantumInfo\">https://github.com/Timeroot/Lean-QuantumInfo</a>). As this project exists on toolchain version <code>v4.23.0-rc2</code>, I set my toolchain version similarly to <code>v4.23.0-rc2</code>. First, I tried putting the line <code>require quantumInfo from git \"https://github.com/Timeroot/Lean-QuantumInfo\"</code> in my <code>lakefile.lean</code>. However, when I cleared my build and cache and ran <code>lake update</code>, this checked out the wrong version of mathlib4 and caused the project to fail to build. I figured this might be because Lean-QuantumInfo only uses the line <code>require \"mathlib\" from git \"https://github.com/leanprover-community/mathlib4.git\"</code>, instead of specifying a commit. I cloned the repository and imported locally, having changed the desired commit to the tagged commit for the correct toolchain version. This checked out the correct commit of mathlib4, but fails to check out the correct versions of mathlib's dependencies, like <code>batteries</code>. How can I fix this issue?</p>",
        "id": 541109827,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758665876
    },
    {
        "content": "<p>You should have <em>only</em> that <code>require</code> in your lakefile, and not another one for <code>mathlib</code></p>",
        "id": 541110632,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758666311
    },
    {
        "content": "<p>I have only that <code>require</code>, the mathlib require is found in the lakefile for Lean-QuantumInfo.</p>",
        "id": 541111978,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758667050
    },
    {
        "content": "<p>Then what you described should just work. What was the build failure?</p>",
        "id": 541126421,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758676145
    },
    {
        "content": "<p>The build failure was coming about when I was trying to additionally import a second package, but I can isolate the issue to <code>lake update</code> failing to check out the correct versions of packages like <code>battery</code> when I just run that <code>require</code>. My terminal output after <code>lake update</code> begins with:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>info: quantumInfo: cloning https://github.com/Timeroot/Lean-QuantumInfo\ninfo: toolchain not updated; already up-to-date\ninfo: mathlib: cloning https://github.com/leanprover-community/mathlib4.git\ninfo: mathlib: checking out revision 'da03f176071431c7f212d8262d05aa422b269876'\ninfo: plausible: cloning https://github.com/leanprover-community/plausible\ninfo: plausible: checking out revision '240eddc1bb31420fbbc57fe5cc579435c2522493'\ninfo: LeanSearchClient: cloning https://github.com/leanprover-community/LeanSearchClient\ninfo: LeanSearchClient: checking out revision '99657ad92e23804e279f77ea6dbdeebaa1317b98'\ninfo: importGraph: cloning https://github.com/leanprover-community/import-graph\ninfo: importGraph: checking out revision 'dba7fbc707774d1ba830fd44d7f92a717e9bf57f'\ninfo: proofwidgets: cloning https://github.com/leanprover-community/ProofWidgets4\ninfo: proofwidgets: checking out revision '6e47cc88cfbf1601ab364e9a4de5f33f13401ff8'\ninfo: aesop: cloning https://github.com/leanprover-community/aesop\ninfo: aesop: checking out revision '3b779e9d1c73837a3764d516d81f942de391b6f0'\ninfo: Qq: cloning https://github.com/leanprover-community/quote4\ninfo: Qq: checking out revision 'f85ad59c9b60647ef736719c23edd4578f723806'\ninfo: batteries: cloning https://github.com/leanprover-community/batteries\ninfo: batteries: checking out revision 'a67fc66cd1ebc0855dc064a4be727798771c0f89'\ninfo: Cli: cloning https://github.com/mhuisi/lean4-cli\ninfo: Cli: checking out revision '6667b921594697980586296511fab6a359e802d1'\n</code></pre></div>\n<p>and I can see that the commit for <code>batteries</code> with that hash is <a href=\"https://github.com/leanprover-community/batteries/commit/a67fc66cd1ebc0855dc064a4be727798771c0f89\">this</a>, which you can see is tagged for <code>v4.24.0-rc1</code>.</p>",
        "id": 541127118,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758676846
    },
    {
        "content": "<p>You shouldn't need to require batteries, it will come transitively via mathlib.</p>",
        "id": 541131323,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758680627
    },
    {
        "content": "<p>Can you show us your lakefile or repo?</p>",
        "id": 541131363,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758680665
    },
    {
        "content": "<p>Sure, my lakefile which results in this code is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">ATP_Test</span><span class=\"bp\">»</span><span class=\"o\">{</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">quantumInfo</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/Timeroot/Lean-QuantumInfo\"</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">ATPTest</span>\n</code></pre></div>\n<p>As I said, I am only requiring a single import.</p>",
        "id": 541131642,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758680910
    },
    {
        "content": "<p>Is there a repo we can clone?</p>",
        "id": 541131888,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758681123
    },
    {
        "content": "<p>just made one, though as I haven't done anything substantial so far it consists of essentially just that lakefile, a lean-toolchain, and a basic file importing something from the dependency.</p>\n<p><a href=\"https://github.com/mehatamm/ATP_Test\">https://github.com/mehatamm/ATP_Test</a></p>",
        "id": 541132773,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758682160
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, cloning this repo and running <code>lake build</code>, we get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">quantumInfo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">Timeroot</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">-</span><span class=\"n\">QuantumInfo</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">quantumInfo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">69</span><span class=\"n\">adc042feceede68c6b3507f541c6c42731c1bf'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">da03f176071431c7f212d8262d05aa422b269876'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">plausible</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">plausible</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">plausible</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">240</span><span class=\"n\">eddc1bb31420fbbc57fe5cc579435c2522493'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LeanSearchClient</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">LeanSearchClient</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LeanSearchClient</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">99657</span><span class=\"n\">ad92e23804e279f77ea6dbdeebaa1317b98'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">importGraph</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"kn\">import</span><span class=\"bp\">-</span><span class=\"n\">graph</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">importGraph</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">dba7fbc707774d1ba830fd44d7f92a717e9bf57f'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">ProofWidgets4</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">6</span><span class=\"n\">e47cc88cfbf1601ab364e9a4de5f33f13401ff8'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cloning</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">aesop</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">git'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n</code></pre></div>\n<p>Didn't you make sure at some point that git errors actually propagated to the user? What are we meant to do here?</p>",
        "id": 541135207,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758684153
    },
    {
        "content": "<p>Despite this error, <code>lake exe cache get</code> and a second <code>lake build</code> succeeds. <span class=\"user-mention\" data-user-id=\"578326\">@Mattias Ehatamm</span>, does that agree with your experience?</p>",
        "id": 541135239,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758684194
    },
    {
        "content": "<p>Actually, attempting this again things seem to work fine. I guess the request to <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> for better error propagation still holds, but <span class=\"user-mention\" data-user-id=\"578326\">@Mattias Ehatamm</span>, could you describe steps to reproduce your problem?</p>",
        "id": 541135358,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758684325
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <code>-v</code> would produce more logs, but I believe the indication here is that this is a transient error. Regardless,  I do intend to improve the logging here.</p>",
        "id": 541135675,
        "sender_full_name": "Mac Malone",
        "timestamp": 1758684680
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/Importing.20project.20on.20past.20version.20of.20Lean.2E/near/541135358\">said</a>:</p>\n<blockquote>\n<p>Actually, attempting this again things seem to work fine. I guess the request to <span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> for better error propagation still holds, but <span class=\"user-mention silent\" data-user-id=\"578326\">Mattias Ehatamm</span>, could you describe steps to reproduce your problem?</p>\n</blockquote>\n<p>To reproduce my problem, clone the repository and run <code>lake update</code> to generate a <code>lake-manifest.json</code>. The command-line output will indicate that the incorrect commit of <code>batteries</code> has been checked out, and the <code>lake-manifest.json</code> agrees with the command-line output in indicating the wrong version. I was not claiming that this specific setup results in a build error, but I believed that the version error in my <code>lake-manifest.json</code> was leading to a build error when I tried to combine this with another package.</p>",
        "id": 541227082,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758719806
    },
    {
        "content": "<p>The reason it builds successfully here is that when running lake update immediately after cloning, lake appears to actually check out a different commit of <code>batteries</code> than it claims to or indicates in <code>lake-manifest.json</code>. Looking in <code>.lake\\packages\\batteries\\lean-toolchain</code> indicates that the version of <code>batteries</code> is <code>v4.23.0-rc2</code>, which wouldn't be the case if it had checked out the version it claimed to.</p>",
        "id": 541228574,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758720201
    },
    {
        "content": "<p>I talked to <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> at the office hours, we dealt with this issue. I was confused about tag history, and it turned out that the <code>batteries</code> commit that was logged was actually the correct version. My multiple dependencies issue was then resolved when I moved the import that required mathlib to the bottom of my lakefile instead of the top.</p>",
        "id": 541258342,
        "sender_full_name": "Mattias Ehatamm",
        "timestamp": 1758727683
    }
]