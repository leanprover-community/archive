[
    {
        "content": "<p>I want to package an offline version of mathlib4 docs. The file \"header-data.bmp\" is about 700MB which is huge. I've checked the html and js files, seems that none of them references \"header-data.bmp\" file. Is it safe to remove this file from packaging?</p>",
        "id": 502866299,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740926131
    },
    {
        "content": "<p>that file is not a bitmap btw, it's the search index (calling it .bmp makes browsers cache it better)</p>",
        "id": 502866415,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926204
    },
    {
        "content": "<p>it's what makes the search bar suggest results immediately as you type</p>",
        "id": 502866477,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926250
    },
    {
        "content": "<p>it's possible that things have changed in docgen since this file was introduced and now it is doing something else? I'm surprised it is not used</p>",
        "id": 502866592,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926314
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502866415\">said</a>:</p>\n<blockquote>\n<p>that file is not a bitmap btw, it's the search index (calling it .bmp makes browsers cache it better)</p>\n</blockquote>\n<p>Seems that it only uses \"declaration-data.bmp\".</p>",
        "id": 502866666,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740926387
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/qMAmvxDQlcYSqBl17WGiYPz5/screenshot.png\">screenshot.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/qMAmvxDQlcYSqBl17WGiYPz5/screenshot.png\" title=\"screenshot.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"655x721\" src=\"/user_uploads/thumbnail/3121/qMAmvxDQlcYSqBl17WGiYPz5/screenshot.png/840x560.webp\"></a></div>",
        "id": 502866981,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740926568
    },
    {
        "content": "<p>It was added <a href=\"https://github.com/leanprover/doc-gen4/commit/718b182a3122c7c638025399942f2a61da10005e\">in this commit</a> by <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> , perhaps he knows more about the purpose of this file</p>",
        "id": 502867199,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926713
    },
    {
        "content": "<p>but it seems the immediate answer to your question is yes, it's safe to remove, it's likely that the purpose of the file is either for nonstandard uses of docgen or otherwise unimplemented things</p>",
        "id": 502867330,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926809
    },
    {
        "content": "<p>It's said that \"Produce <code>header-data.bmp</code>, this allows embedding of doc-gen declarations into other pages and more.\".</p>",
        "id": 502867467,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740926913
    },
    {
        "content": "<p>But I think it's not practical if a webpage needs to download 700MB of data...</p>",
        "id": 502867521,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740926955
    },
    {
        "content": "<p>yeah, that's a ridiculously large payload</p>",
        "id": 502867533,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926975
    },
    {
        "content": "<p>how big is <code>declaration-data.bmp</code>?</p>",
        "id": 502867555,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740926999
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502867555\">said</a>:</p>\n<blockquote>\n<p>how big is <code>declaration-data.bmp</code>?</p>\n</blockquote>\n<p>40MB which is not that small.</p>",
        "id": 502867698,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740927105
    },
    {
        "content": "<p>It boggles the mind that just the names and links to declarations can take up this much space</p>",
        "id": 502867789,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927144
    },
    {
        "content": "<p>Oh, I think the reason the header-data is so large is because it has the pretty printed types of all the declarations too</p>",
        "id": 502868064,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927329
    },
    {
        "content": "<p>(pretty printed as html too)</p>",
        "id": 502868093,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927354
    },
    {
        "content": "<p>It was added so the top 100 list of <a href=\"http://leanprover-community.github.io\">leanprover-community.github.io</a> could be rendered at the request of Eric</p>",
        "id": 502868263,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927472
    },
    {
        "content": "<p>So there is basically some js or other kind of script somewhere in leanprover-community that requests this file from mathlib4_docs.</p>",
        "id": 502868365,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927518
    },
    {
        "content": "<p>Note furthermore that for this reason header-data.bmp is only generated on demand with the <code>docsHeader</code> facet and not for every doc-gen build that exists out there. One optimization that you could do is within the mathlib4_docs CI pre-filter it such that only the fields that are actually needed by the top 100 list are preserved, that should probably boil it down to a couple of kilobytes</p>",
        "id": 502868519,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927617
    },
    {
        "content": "<p>how does it actually get used?</p>",
        "id": 502868556,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927654
    },
    {
        "content": "<p>Do you mean this page <a href=\"https://leanprover-community.github.io/100.html\">https://leanprover-community.github.io/100.html</a> ? I assume that the file \"header-data.bmp\" is only used during the generation of that page (the build script finds corresponding contents in \"header-data.bmp\" and inserts them to that file).</p>",
        "id": 502868565,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740927661
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"366779\">Jz Pan</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502868565\">said</a>:</p>\n<blockquote>\n<p>Do you mean this page <a href=\"https://leanprover-community.github.io/100.html\">https://leanprover-community.github.io/100.html</a> ? I assume that the file \"header-data.bmp\" is only used during the generation of that page (the build script finds corresponding contents in \"header-data.bmp\" and inserts them to that file).</p>\n</blockquote>\n<p>Yes I mean that page and yes that is likely correct.</p>",
        "id": 502868597,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927690
    },
    {
        "content": "<p>is the code that uses it available in doc-gen itself or is it only in the leanprover-community website build?</p>",
        "id": 502868603,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927698
    },
    {
        "content": "<p>The latter</p>",
        "id": 502868618,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927711
    },
    {
        "content": "<p>I wonder whether doc-gen should instead provide this facility as some kind of HTML postprocessor to replace some embeds with nice looking html</p>",
        "id": 502868727,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927794
    },
    {
        "content": "<p>(assuming I understand the purpose of the feature correctly)</p>",
        "id": 502868753,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740927825
    },
    {
        "content": "<p>Yeah I read the <code>lake build Mathlib:docsHeader</code> in the build script <a href=\"https://github.com/leanprover-community/mathlib4_docs/blob/main/.github/workflows/docs.yaml\">https://github.com/leanprover-community/mathlib4_docs/blob/main/.github/workflows/docs.yaml</a> . Since my offline version of mathlib4 docs will not contain 100 and 1000 pages, I'll remove it from my build script.</p>",
        "id": 502868909,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740927943
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502868727\">said</a>:</p>\n<blockquote>\n<p>I wonder whether doc-gen should instead provide this facility as some kind of HTML postprocessor to replace some embeds with nice looking html</p>\n</blockquote>\n<p>I would like to avoid over engineering a feature that basically only has one consumer in this fashion if possible.</p>",
        "id": 502869003,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740927985
    },
    {
        "content": "<p>The relevant code seems to be <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/blob/e124d81b52e54fcb4b62434634a8901f04242deb/make_site.py#L294-L312\">here</a></p>",
        "id": 502869084,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928032
    },
    {
        "content": "<p>the data flow seems to be a bit weird here, it's downloading a big pre-generated file from github, I guess because the website build is running separately from the docgen build</p>",
        "id": 502869201,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928101
    },
    {
        "content": "<p><code>This is a slow operation</code> × 2</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"k\">if</span> <span class=\"n\">DOWNLOAD</span><span class=\"p\">:</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'Downloading header-data.json...'</span><span class=\"p\">)</span> <span class=\"c1\">#  This is a slow operation, so let's inform readers.</span>\n    <span class=\"c1\"># header-data.json contains information for every single declaration in mathlib</span>\n    <span class=\"c1\"># which has a generated documentation entry (e.g., skipping private declarations by default).</span>\n    <span class=\"c1\"># The resulting file is huge (several hundred MB), hence we use a small HACK:</span>\n    <span class=\"c1\"># doc-gen4 uploads this file as a .bmp file, so GitHub's servers will serve it in</span>\n    <span class=\"c1\"># compressed form. When downloading it locally, we save it (decompressed) with the correct extension.</span>\n    <span class=\"n\">download</span><span class=\"p\">(</span>\n        <span class=\"s1\">'https://leanprover-community.github.io/mathlib4_docs/declarations/header-data.bmp'</span><span class=\"p\">,</span>\n        <span class=\"n\">DATA</span><span class=\"o\">/</span><span class=\"s1\">'header-data.json'</span>\n    <span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'Downloaded.'</span><span class=\"p\">)</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">DATA</span><span class=\"o\">/</span><span class=\"s1\">'header-data.json'</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'Parsing header-data.json...'</span><span class=\"p\">)</span> <span class=\"c1\">#  This is a slow operation, so let's inform readers.</span>\n    <span class=\"k\">with</span> <span class=\"p\">(</span><span class=\"n\">DATA</span><span class=\"o\">/</span><span class=\"s1\">'header-data.json'</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"s1\">'r'</span><span class=\"p\">,</span> <span class=\"n\">encoding</span><span class=\"o\">=</span><span class=\"s1\">'utf-8'</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">h_file</span><span class=\"p\">:</span>\n        <span class=\"n\">header_data</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">h_file</span><span class=\"p\">)</span>\n    <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'Parsed.'</span><span class=\"p\">)</span>\n<span class=\"k\">else</span><span class=\"p\">:</span>\n    <span class=\"n\">header_data</span> <span class=\"o\">=</span> <span class=\"nb\">dict</span><span class=\"p\">()</span>\n</code></pre></div>",
        "id": 502869445,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740928260
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502868519\">said</a>:</p>\n<blockquote>\n<p>Note furthermore that for this reason header-data.bmp is only generated on demand with the <code>docsHeader</code> facet and not for every doc-gen build that exists out there. One optimization that you could do is within the mathlib4_docs CI pre-filter it such that only the fields that are actually needed by the top 100 list are preserved, that should probably boil it down to a couple of kilobytes</p>\n</blockquote>\n<p>can docsHeader be directed to only build this for a specified list of declarations?</p>",
        "id": 502869506,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928322
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502869201\">said</a>:</p>\n<blockquote>\n<p>the data flow seems to be a bit weird here, it's downloading a big pre-generated file from github, I guess because the website build is running separately from the docgen build</p>\n</blockquote>\n<p>And the data of 100 and 1000 themselves are also downloaded from docs page...</p>",
        "id": 502869564,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740928344
    },
    {
        "content": "<p>that seems better than generating everything and then filtering after</p>",
        "id": 502869577,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928358
    },
    {
        "content": "<p>Yes that could also be PRed to doc-gen</p>",
        "id": 502869597,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1740928374
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502869506\">said</a>:</p>\n<blockquote>\n<p>can docsHeader be directed to only build this for a specified list of declarations?</p>\n</blockquote>\n<p>That should be done in this build script <a href=\"https://github.com/leanprover-community/mathlib4_docs/blob/main/.github/workflows/docs.yaml\">https://github.com/leanprover-community/mathlib4_docs/blob/main/.github/workflows/docs.yaml</a> but not in doc-gen</p>\n<p>Namely, after running <code>lake build Mathlib:docsHeader</code> another script should be run to filter this file according to contents in 100 and 1000.</p>",
        "id": 502869731,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740928444
    },
    {
        "content": "<p>I think that was Henrik's suggestion. My suggestion was to build the filter list first and tell docgen to do the filtering rather than postprocessing the 700MB json to throw away almost all of it</p>",
        "id": 502869847,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928553
    },
    {
        "content": "<p>but that requires a docgen PR as Henrik points out</p>",
        "id": 502869905,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928575
    },
    {
        "content": "<p>both approaches would accomplish the task of not sending a gigabyte from the left hand to the right</p>",
        "id": 502869975,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1740928640
    },
    {
        "content": "<p>From that py script it seems that a full \"declaration-data.bmp\" is still needed since it contains some code calculation <code>num_thms</code> and <code>num_defns</code> and link things to mathlib4 docs pages. But seems that the full theorem statement is only used in 100 and 1000.</p>",
        "id": 502870141,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740928765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/Is.20.22header-data.2Ebmp.22.20useful.20in.20mathlib4.20docs.3F/near/502869975\">said</a>:</p>\n<blockquote>\n<p>both approaches would accomplish the task of not sending a gigabyte from the left hand to the right</p>\n</blockquote>\n<p>Given we do this (transfer a gigabyte) most of the time when a cache is invalidated for oleans, I'm not sure this is that valuable a place to spend time on</p>",
        "id": 502872249,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740930181
    }
]