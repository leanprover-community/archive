[
    {
        "content": "<p>Dear all,</p>\n<p>I have been learning how to use Lean4 for some time, currently without any particular objective. That's why I'm looking (with childlike joy) at individual areas of Mathlib that interest me at the moment.<br>\nSince I'm working on cryptography for embedded systems and hardware, elliptic curves are an obvious choice. That's why I'm currently trying to check simple properties of NIST curves (see e.g., [1] Hankerson, Menezes, Vanstone, Guide to Elliptic Curve Cryptography). Here is a first attempt:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">WeierstrassCurve</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">Point</span>\n\n<span class=\"c1\">-- Prime is taken from example 3.5 of [1]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">C29</span>\n<span class=\"c1\">-- Parameters for a tiny example curve (see example 3.5 of [1])</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"c1\">-- curve is in short Weierstrass form</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">short_curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsShortNF</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isShortNF_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- basepoint is located on curve</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equation</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">equation_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- and is not singular</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonsingular</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">                                             </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsingular_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">equation_iff</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">right</span>\n<span class=\"w\">    </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- Now lets check the order of the basepoint</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Point</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span>\n\n<span class=\"c1\">-- Create a monoid of points on the curve</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\">  </span><span class=\"c1\">-- It's unclear to me (Point.add doesn't work, but why?)</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add_assoc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">zero_add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">add_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">nsmul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">nsmul_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">nsmul_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base_order</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">addOrderOf</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">addOrderOf_eq_prime</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zero_def</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"c1\">-- In principle something like \"norm_num\" should work?</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Can someone please give me a hint? I think I'm doing something fundamentally wrong with the types for the Add and AddMonoid instances.</p>\n<p>Many thanks, Steffen</p>",
        "id": 529575799,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1752930877
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"726840\">@Steffen Reith</span> use <a href=\"https://github.com/leanprover-community/mathlib/wiki/Code-in-backticks\">#backticks</a> to format code</p>",
        "id": 529575946,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752931042
    },
    {
        "content": "<p>you should use the provided instances rather than defining your own addition</p>",
        "id": 529575999,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752931116
    },
    {
        "content": "<p>Dear Kenny,</p>\n<p>thank you for the fast response! Fixed the format of the code (sorry!). Which instances do you mean? If I remove the <strong>Add</strong> and <strong>AddMonoid</strong> then addOrderOf doesn't work at all (it seems that the addition of points isn't known to Lean, so i suspect that I miss some tricks with type-classes). Unfortunately, I haven't found any other examples where I can spy a little (or I'm just being too stupid ;-)</p>\n<p>Thanks,<br>\nSteffen</p>",
        "id": 529603931,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1752948349
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span><span class=\"bp\">‚ü©</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 529604569,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1752949142
    },
    {
        "content": "<p>or you could write </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n</code></pre></div>",
        "id": 529604609,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1752949189
    },
    {
        "content": "<p>Dear Junyan,</p>\n<p>thank you for your remarks! Now I can get rid of the Add /AddMonoid stuff</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">WeierstrassCurve</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">Point</span>\n\n<span class=\"c1\">-- Prime is taken from example 3.5 of [1]</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span>\n\n<span class=\"c1\">-- Parameters for a tiny example curve (see example 3.5 of [1])</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"c1\">-- curve is in short Weierstrass form</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">short_curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsShortNF</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isShortNF_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- basepoint is located on curve</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equation</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">equation_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- and is not singular</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonsingular</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">                                             </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsingular_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">equation_iff</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">right</span>\n<span class=\"w\">    </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- Now lets check the order of the basepoint</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Point</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base_order</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">addOrderOf</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">addOrderOf_eq_prime</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>It seems that abbrev p is enough. So p is marked \"reducible\" and the type-class mechanism works again (right?).  You additionally suggested \"<code>#synth AddCommGroup (Point curve)</code>\". This seems not to work.  It is not clear to me what #synth is good for.  So Lean seems to be a little stubborn to evaluate the smul (38 * basepoint' = 0), but you gave me a good starting point!</p>\n<p>Thanks,<br>\nSteffen</p>",
        "id": 529610138,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1752956092
    },
    {
        "content": "<p>You get an error message \"failed to synthesize ...\" with <code>#synth AddCommGroup (Point curve)</code> if you don't add the <code>Fact Prime</code> instance. Once you add the instance the synthesis works and you can use the AddCommGroup structure, in particular the addition; that's all I wanted to express.</p>\n<p>I think we need to make <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/AlgebraicGeometry/EllipticCurve/Affine/Point.html#WeierstrassCurve.Affine.Point.add\">WeierstrassCurve.Affine.Point.add</a> computable (by adding a DecidableEq assumption), and then <code>rfl</code> probably works. Or maybe we want a <code>norm_num</code> extension instead. Has this been done before? cc <span class=\"user-mention\" data-user-id=\"464700\">@David Ang</span> <br>\nIt seems you need <code>simp [basePoint']</code> in the last line to solve the goal that <code>basePoint'</code> isn't zero.</p>",
        "id": 529611083,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1752957224
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"726840\">@Steffen Reith</span> I've cleaned up your code a bit:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">WeierstrassCurve</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">Point</span>\n\n<span class=\"c1\">-- Prime is taken from example 3.5 of [1]</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span>\n\n<span class=\"c1\">-- Parameters for a tiny example curve (see example 3.5 of [1])</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"c1\">-- curve is in short Weierstrass form</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsShortNF</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isShortNF_iff</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"bp\">.</span><span class=\"n\">Point</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsingular_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">equation_iff</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">decide</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base_order</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">addOrderOf</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">addOrderOf_eq_prime</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">basepoint</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 529611292,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752957502
    },
    {
        "content": "<p>and yeah we probably need to hold Lean's hand to prove that 37P=0</p>",
        "id": 529611302,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752957517
    },
    {
        "content": "<p><code>rfl</code> still doesn't work after I made the AddCommGroup instance computable. I traced this to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Int/GCD.html#Nat.xgcdAux\">Nat.xgcdAux</a> (which is used in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ZMod.inv#doc\">docs#ZMod.inv</a>) being defined using well-founded recursion. See <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/opaque.20recursion.20definitions.20break.20mergeSort.20decidability/near/511916502\">#lean4 &gt; opaque recursion definitions break mergeSort decidability @ üí¨</a> ; it shouldn't be too hard to rewrite the function.</p>\n<p>I wonder whether Lean should mark everything produced by well-founded recursion <code>noncomputable</code>, since it blocks kernel computation. (<del>Is marking <code>WellFounded.fix</code> noncomputable enough?</del> it's already marked noncomputable)</p>",
        "id": 529617182,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1752966012
    },
    {
        "content": "<p>see also <a href=\"https://github.com/leanprover-community/mathlib4/pull/24514\">#24514</a></p>",
        "id": 529617432,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752966418
    },
    {
        "content": "<blockquote>\n<p>I made the AddCommGroup instance computable</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27299\">#27299</a></p>",
        "id": 529617464,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1752966455
    },
    {
        "content": "<p>Thanks! I've been wanting to change having noncomputable to having the decidable assumption, but hadn't had a chance.</p>",
        "id": 529636111,
        "sender_full_name": "David Ang",
        "timestamp": 1752994838
    },
    {
        "content": "<p>Hi Kenny,</p>\n<p>I really like your improvement! </p>\n<p>Some questions: We know </p>\n<p><code>WeierstrassCurve.IsShortNF.{u_1} {R : Type u_1} [CommRing R] (W : WeierstrassCurve R) : Prop</code></p>\n<p>Why did you do an <strong>instance</strong>  IsShortNF? I'm a little be confused about this usage of an proposition.  I agree it is elegant.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsingular_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">equation_iff</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">decide</span>\n</code></pre></div>\n<p>This is awesome!  You use the \"by\" to get the proof term for nonsingularity and &lt;| to add the third argument h of </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">WeierstrassCurve</span><span class=\"bp\">.</span><span class=\"n\">Affine</span><span class=\"bp\">.</span><span class=\"n\">Point</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">W'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">W'</span><span class=\"bp\">.</span><span class=\"n\">Nonsingular</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"n\">W'</span><span class=\"bp\">.</span><span class=\"n\">Point</span>\n</code></pre></div>\n<p>Yes, currying is nice.  <del>One difference: Im my solution the second \"sorry\" of the last theorem can be solved by \"simp\". In your solution this does not work.</del> This <code>sorry</code> can be removed by s<code>imp[basepoint]</code></p>\n<p>Best Steffen</p>",
        "id": 529675519,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1753003772
    },
    {
        "content": "<p>Dear Junyan,</p>\n<p>I would like to learn the background of your remark \"... produced by well-founded recursion noncomputable ... blocks kernel computation.\" Any pointers to literature for me?<br>\nThx</p>",
        "id": 529677515,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1753006207
    },
    {
        "content": "<p>Dear Aaron&amp;Junyan<br>\nthanks for the PRs! Do you think Lean will be able to work with \"real\" parameters? The point-multiplication will become massive.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Parameters for curve secp224r1</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">secp224r1_p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p224</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">secp224r1_a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">secp224r1_b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">xB4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p224</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">prime_p224</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ùîΩp224</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p224</span>\n</code></pre></div>\n<p>For the prime p224  (2 ^ 224 - 2 ^ 96 + 1) I have a Python-script, which computes a Pratt-certificate and some Lean-code to prove that p224 is prime.</p>",
        "id": 529677819,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1753006617
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"726840\">@Steffen Reith</span> use <a href=\"https://github.com/leanprover-community/mathlib/wiki/Code-in-backticks\">#backticks</a> for codes.</p>\n<p><code>instance</code> is used if and only if the resulting type is a <code>class</code>, which in this case it is. You can check by doing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">WeierstrassCurve</span><span class=\"bp\">.</span><span class=\"n\">IsShortNF</span><span class=\"w\"> </span><span class=\"c1\">-- class WeierstrassCurve.IsShortNF ...</span>\n</code></pre></div>\n<p>As for solving the last point by <code>simp</code>, you can still do that after <code>unfold basepoint</code>, but I would say using <code>simp</code> isn't the best solution. We should really use <code>decide</code> (after some more code has been implemented)</p>",
        "id": 529681848,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753011022
    },
    {
        "content": "<p><code>simp [basepoint]</code> also works, but I agree <code>decide</code> would be nice. What can I do to help?</p>",
        "id": 529687663,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1753017050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"726840\">Steffen Reith</span> <a href=\"#narrow/channel/113488-general/topic/Problems.20with.20elliptic.20curves/near/529687663\">said</a>:</p>\n<blockquote>\n<p>What can I do to help?</p>\n</blockquote>\n<p>not really anything, sorry, there's already a bunch of PR's being referenced above</p>",
        "id": 529688099,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753017576
    },
    {
        "content": "<p>The example works in <a href=\"https://github.com/leanprover-community/mathlib4/compare/master...alreadydone:mathlib4:EllipticCurveFiniteField?expand=1\">this branch</a> (in which I merged <a href=\"https://github.com/leanprover-community/mathlib4/pull/24514\">#24514</a>) with recursion depth 1606. Since Lean kernel trusts GMP library, it probably can handle much larger integers, but \"smul by doubling\" probably needs to be implemented.</p>",
        "id": 529910810,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753110372
    },
    {
        "content": "<p>I added </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n<span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"EllipticCurveFiniteField\"</span>\n</code></pre></div>\n<p>to my  <code>lakefile.toml</code> and I can see that I get the correct branch of mathlib. But <a href=\"https://github.com/leanprover-community/mathlib4/pull/24514\">#24514</a> doesn't seem to be merged in this branch (xgcd is not fueled). I'm probably doing something wrong.</p>",
        "id": 532306342,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1754054640
    },
    {
        "content": "<p>The branch <a href=\"https://github.com/alreadydone/mathlib4/tree/EllipticCurveFiniteField\">https://github.com/alreadydone/mathlib4/tree/EllipticCurveFiniteField</a> only exists in my fork, and I'm curious why you were able to get the correct branch from <code>leanprover-community</code> ...</p>",
        "id": 532309235,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1754055502
    },
    {
        "content": "<p>Now my lakefile looks like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"bp\">#</span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"bp\">#</span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/alreadydone/mathlib4\"</span>\n<span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"EllipticCurveFiniteField\"</span>\n</code></pre></div>\n<p>In  </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span>\n</code></pre></div>\n<p>have in  <code>.git/config</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">remote</span><span class=\"w\"> </span><span class=\"s2\">\"origin\"</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">url</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">alreadydone</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"w\">    </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">refs</span><span class=\"bp\">/</span><span class=\"n\">heads</span><span class=\"bp\">/*</span><span class=\"o\">:</span><span class=\"n\">refs</span><span class=\"bp\">/</span><span class=\"n\">remotes</span><span class=\"bp\">/</span><span class=\"n\">origin</span><span class=\"bp\">/*</span>\n</code></pre></div>\n<p>and  ```<br>\n git branch</p>\n<ul>\n<li>(HEAD detached at 7e1a2b8b1f)<br>\n  EllipticCurveFiniteField<br>\n  master</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code>\n</code></pre></div>",
        "id": 532319766,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1754058872
    },
    {
        "content": "<p>I would like to give a brief summary of the current status:</p>\n<p>The patch in the <code>EllipticCurveFiniteField</code> branch of  <code>https://github.com/alreadydone/mathlib4</code> solves the problems for curves with small parameters (taken from D. Hankerson, A. Menezes, S. Vanstone,  Guide to Elliptic Curve Cryptography, Springer, 2004, Example 3.5):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">ECCDEMO</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">WeierstrassCurve</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">Point</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">29</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Affine</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span>\n\n<span class=\"c1\">-- Parameters for a tiny example curve</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">20</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">ùîΩ29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C29</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"c1\">-- curve is in short Weierstrass form</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">short_curve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsShortNF</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isShortNF_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- basepoint is located on the curve</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equation</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">equation_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- and is not singular</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonsingular</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"w\"> </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">                                             </span><span class=\"n\">basepoint</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsingular_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">curve</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">equation_iff</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">right</span>\n<span class=\"w\">    </span><span class=\"n\">decide</span>\n\n<span class=\"c1\">-- Now lets check the order of the basepoint</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Point</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nonsingular_base</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">1606</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_base_order</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">addOrderOf</span><span class=\"w\"> </span><span class=\"n\">basePoint'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">addOrderOf_eq_prime</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">ECCDEMO</span>\n</code></pre></div>\n<p><strong>Please pay attention to the recursion depth!</strong> You have to add Junyan special mathlib4 to your project. Hence, add </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/alreadydone/mathlib4\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"638b227b3639da2d6f7280cd8d07958f5aa87dd2\"</span>\n</code></pre></div>\n<p>to your <code>lakefile.toml</code>. Moreover, make sure that you use the right toolchain and set <code>leanprover/lean4:v4.22.0-rc3</code> in <code>lean-toolchain</code>! </p>\n<p>Many thanks to Yunyan Xu for the great help! I will modify the example to include all NIST curves (may take some time) and post the result here again. </p>\n<p>Regards,<br>\nSteffen</p>",
        "id": 540667936,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1758471719
    },
    {
        "content": "<p>I'm combining the changes (including multiplication by doubling) into <a href=\"https://github.com/leanprover-community/mathlib4/pull/30185\">#30185</a>; once it's merged you wouldn't need to rely on my branch.</p>\n<p>With multiplication by doubling, <code>set_option maxRecDepth 1606</code> is no longer needed (178 is already enough, which is below default threshold).</p>",
        "id": 543049221,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1759542084
    },
    {
        "content": "<p>Sounds great! Thank you for all the work. Your implementation of ‚Äúadd-and-double‚Äù is interesting since correctness and implementation are mixed. Is there any kind of literature to learn more about this?</p>",
        "id": 544122169,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1760087799
    },
    {
        "content": "<p>Are you referring to the definition of <a href=\"https://github.com/leanprover-community/mathlib4/pull/30144/files#diff-d8e4040bd59682d2b831ebe9582155b1dfc7b237668fc6270497306a62bf19c9R76-R82\">binaryRecAux</a> or <code>binaryRec</code>? Their correctness is essentially the lemma <code>binaryRec_eq_of_ne_zero</code>, so I'd say the definition and correctness are separate. To prove that binaryRec computes scalar multiplication or exponentiation by natural numbers, the lemma <a href=\"https://github.com/leanprover-community/mathlib4/pull/30144/files#diff-b0633945066967f025793780617bc4bf036f0f076b498290a1db92acdb2b0f90R563\">npowRec_eq_npowBinRec</a> is key, which is again separate from the definition.</p>",
        "id": 544185430,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1760107077
    },
    {
        "content": "<p>For example this stuff: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">suppress_compilation</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">pow</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ComputableRepr</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">strongRec‚ÇÄ</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"n\">ofEq</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∏</span><span class=\"w\"> </span><span class=\"n\">pow_zero</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pow_half</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">even_or_odd</span><span class=\"bp\">.</span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">ofEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pow_half</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">pow_half</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">two_mul_div_two_of_even</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">two_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_add</span><span class=\"o\">])</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">ofEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pow_half</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">pow_half</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">two_mul_div_two_add_one_of_odd</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">two_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_one</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>To me it seems to be the classical \"repeated double and add\", but you mixed in some rewrites that proof the correctness. Right?</p>",
        "id": 545427801,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1760641525
    },
    {
        "content": "<p>You're probably referring to some <a href=\"https://gist.github.com/alreadydone/2dca4fde11fb2e9be7f8a10b59216b3f#file-polynomialreflection-lean-L211-L224\">old code</a> I sent to you in DM. In that case, yes, in order to construct a term of type <code>(p ^ n).ComputableRepr</code> I have to show <code>Computable.coeffs</code> indeed computes <code>p^n</code>. <br>\nBut I'm no longer using that code in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30185\">#30185</a>; I found that mathlib already contained <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=npowBinRec#doc\">docs#npowBinRec</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=nsmulBinRec#doc\">docs#nsmulBinRec</a>, so I'm now directly using them. I only reimplemented the dependency <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Nat/BinaryRec.html#Nat.binaryRec\">Nat.binaryRec</a> in order to make it computable (kernel reducible).</p>",
        "id": 545448911,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1760651212
    },
    {
        "content": "<p>Sorry,  I missed that!  </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">to_additive</span>\n<span class=\"n\">def</span><span class=\"w\"> </span><span class=\"n\">npowBinRec</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">npowBinRec</span><span class=\"bp\">.</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Auxiliary tail-recursive implementation for `npowBinRec`. -/</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"n\">nsmulBinRec</span><span class=\"bp\">.</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"sd\">/-- Auxiliary tail-recursive implementation for `nsmulBinRec`. -/</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">binaryRec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">bn</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"n\">bn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Ok, this code seems to be a typical ‚Äúrepeated square and multiply‚Äù for an arbitrary multiplicative monoid, and nsmulBinRec is the additive counterpart. What you did with ‚ÄúNat.binaryRec‚Äù is that you implemented the recursion principle used for them for natural numbers. Right? Hence, my next step is to read the diffs in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30185\">#30185</a>. This helped me a lot. Thanks!</p>",
        "id": 545503590,
        "sender_full_name": "Steffen Reith",
        "timestamp": 1760687114
    }
]