[
    {
        "content": "<p>I am trying to create a MWE of a very slow declaration on <code>bump/v4.12.0</code>.<br>\nAt the moment I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- a very slow version, to check that the decl still compiles, after minimization attempts</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">800000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">functorCategoryLinear</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linear</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">тед</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;</span><span class=\"n\">snip</span><span class=\"bp\">&gt;</span>\n\n\n<span class=\"c1\">-- another very slow version, to check that the decl is still slow, after minimization attempts</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: (deterministic) timeout at `whnf`, maximum number of heartbeats (200000) has been reached</span>\n<span class=\"sd\">Use `set_option maxHeartbeats &lt;num&gt;` to set the limit.</span>\n<span class=\"sd\">Additional diagnostic information may be available using the `set_option diagnostics true` command.</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">error: (deterministic) timeout at `whnf`, maximum number of heartbeats (200000) has been reached</span>\n<span class=\"sd\">Use `set_option maxHeartbeats &lt;num&gt;` to set the limit.</span>\n<span class=\"sd\">Additional diagnostic information may be available using the `set_option diagnostics true` command.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">functorCategoryLinear'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linear</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">тед</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;</span><span class=\"n\">snip</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>I would really like to have a command (a version of <code>count_heartbeats in</code>?) that would combine these two:</p>\n<ul>\n<li>check that the decl doesn't have errors</li>\n<li>check that it uses at least <code>x</code> heartbeats.</li>\n</ul>",
        "id": 463370328,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724064196
    },
    {
        "content": "<p><code>Mathlib.Util.Counthearbeats</code> has the components to put this together quickly, I think.</p>",
        "id": 463376943,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724066478
    },
    {
        "content": "<p>e.g. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Run a command, optionally restoring the original state, and report just the number of heartbeats.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabForHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n</code></pre></div>",
        "id": 463377011,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724066510
    }
]