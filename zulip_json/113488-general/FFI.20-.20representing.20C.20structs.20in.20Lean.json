[
    {
        "content": "<p>I'm currently hacking on this SDL3 bindings library (<a href=\"https://github.com/ValorZard/lean-sdl3\">https://github.com/ValorZard/lean-sdl3</a>) that <span class=\"user-mention\" data-user-id=\"802311\">@Oliver Dressler</span>  and <span class=\"user-mention\" data-user-id=\"950553\">@Srayan Jana</span>  have contributed to, trying to understand how it works and expand its functionality. At the moment, I'm trying to get the SDL3 webcam bindings working.</p>\n<p>I'm specifically trying to figure out how to best represent C SDL structures as types in Lean. I can see that the existing bindings are doing something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SDLWindow</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n</code></pre></div>\n<p>to create a Lean equivalent of a <code>SDL_Window</code> structure. But I'm not sure how to create a Lean structure that has fields equivalent to a C structure, and I don't see any examples of this in these existing bindings. I specifically want to be able to represent a <code>SDL_CameraSpec</code> in Lean as a Lean structure and get access to the various C integer fields on it.</p>",
        "id": 564370505,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766023836
    },
    {
        "content": "<p>If you want the C structure to also appear in the formalization, below is a brief example of how that could be done.  In the example, SDL types are represented by Lean external objects with the assumption that the proper external classes are registered in the C code (e.g., <code>g_pixelformat_external_class</code>).</p>\n<p>In general,  I should probably explain the example a bit more, but I do not have the time at the present.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Example Code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">SDL</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">Model</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span>\n<span class=\"w\">  </span><span class=\"n\">colorspace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span>\n<span class=\"w\">  </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">framerateNumerator</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">framerateDenominator</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">ofModel</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">    </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">toModel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">Model</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_format\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"bp\">.</span><span class=\"n\">toModel</span><span class=\"bp\">.</span><span class=\"n\">format</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_format(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  SDL_PixelFormat format = static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;format;</span>\n<span class=\"cm\">  return lean_alloc_external(g_pixelformat_external_class, format);</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_width\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"bp\">.</span><span class=\"n\">toModel</span><span class=\"bp\">.</span><span class=\"n\">width</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT int32_t sdl_camera_spec_width(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  return static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;width;</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n</div></div>",
        "id": 564372331,
        "sender_full_name": "Mac Malone",
        "timestamp": 1766025559
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/564372331\">said</a>:</p>\n<blockquote>\n<p>If you want the C structure to also appear in the formalization, below is a brief example of how that could be done.  In the example, SDL types are represented by Lean external objects with the assumption that the proper external classes are registered in the C code (e.g., <code>g_pixelformat_external_class</code>).</p>\n<p>In general,  I should probably explain the example a bit more, but I do not have the time at the present.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Example Code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">SDL</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">Model</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span>\n<span class=\"w\">  </span><span class=\"n\">colorspace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span>\n<span class=\"w\">  </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">framerateNumerator</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"w\">  </span><span class=\"n\">framerateDenominator</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">ofModel</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">    </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">toModel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">Model</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_format\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"bp\">.</span><span class=\"n\">toModel</span><span class=\"bp\">.</span><span class=\"n\">format</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_format(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  SDL_PixelFormat format = static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;format;</span>\n<span class=\"cm\">  return lean_alloc_external(g_pixelformat_external_class, format);</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_width\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"bp\">.</span><span class=\"n\">toModel</span><span class=\"bp\">.</span><span class=\"n\">width</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT int32_t sdl_camera_spec_width(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  return static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;width;</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p></div></div><br>\n</p>\n</blockquote>\n<p>yeah I think I need a bit more explanation to make sense of this, either that or this block of code as such doesn't work and I need to modify it some.</p>",
        "id": 564429369,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766055109
    },
    {
        "content": "<p>In particular, I'm not sure what you were getting at with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">ofModel</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">    </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">toModel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">Model</span>\n</code></pre></div>\n<p>I think this is just not syntactically correct? <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span></p>",
        "id": 565230963,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766539307
    },
    {
        "content": "<p>The code should elaborate without errors. Viewing it on <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a> shows no errors.</p>\n<p>To elaborate a bit on the example:</p>\n<ul>\n<li><code>PixelFormat</code> and <code>Colorspace</code> are like <code>SDLWindow</code>. They are essentially <code>opaque</code> types with the added property that they are know to be <code>Nonempty</code>. This property allows them to be safely used in the return types of <code>opaque</code> defintions.</li>\n<li><code>CameraSpec.Model</code> is Lean formalization (model) of the <a href=\"https://wiki.libsdl.org/SDL3/SDL_CameraSpec\"><code>SDL_CameraSpec</code></a> data structure. It is not meant to actually be used in compiled code, but rather enable Lean proofs about the <code>CameraSpec</code> type.</li>\n<li><code>CameraSpec</code> wraps the <code>CameraSpec.Model</code> into a FFI type amendable to compiled code. Like <code>PixelFormat</code> or <code>Colorspace</code>, this is the type one is meant to use in FFI definitions and should be represented at compile time through an actual <code>SDL_CameraSpec</code> wrapped in a Lean object via <code>lean_alloc_external()</code>. The constructor <code>ofModel</code> and the field <code>toModel</code> are marked <code>private</code> because they are not meant to be used in compiled code. They simply exist to further enable formalization of <code>CameraSpec</code>'s definitions.</li>\n<li><code>CameraSpec.format</code> and <code>CameraSpec.width</code> are example FFI definitions that have both a Lean formalization leveraging <code>toModel</code> and FFI implementation using the C data structure. This enables both proofs about and compiled uses of these fields.</li>\n</ul>\n<p>It was not (and is not) entirely clear to me if a Lean formalization of the C data structure was what you were looking for when you asked for \"a Lean structure that has fields equivalent to a C structure\". An alternative version of the example with an opaque <code>CameraSpec</code> would look like the following:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Opaque CameraSpec</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">SDL</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Colorspace</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">instNonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"bp\">.</span><span class=\"n\">nonemptyType</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_format\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_format(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  SDL_PixelFormat format = static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;format;</span>\n<span class=\"cm\">  return lean_alloc_external(g_pixelformat_external_class, format);</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_width\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int32</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT int32_t sdl_camera_spec_width(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  return static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;width;</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">```</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n</div></div>",
        "id": 565232156,
        "sender_full_name": "Mac Malone",
        "timestamp": 1766540667
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> ah, I was confused by the <code>::</code> syntax for the constructor, I see where that is documented now.</p>\n<p>To step back a bit, I'm generally interested in using Lean for software development, and in particular right now I'm trying to translate a C program that uses the SDL3 library into Lean, adding FFI bindings as  I find I need them.  In my C code,  I call <a href=\"https://wiki.libsdl.org/SDL3/SDL_GetCameraFormat\">https://wiki.libsdl.org/SDL3/SDL_GetCameraFormat</a> which fills in a <code>SDL_CameraSpec</code> pointer argument; I'm trying to translate this to a  lean function <code>SDL.getCameraFormat : @&amp; SDLCamera -&gt; SDLIO CameraSpec</code>, mimicking the C function signature. This means that I need to define the <code>CameraSpec</code> type in Lean, and since this is the lean equivalent of a semantically-meaningful C structure, it would be nice if I could access fields of the lean structure <code>CameraSpec</code> that are equivalent to the fields on the C <code>SDL_CameraSpec</code> struct. </p>\n<p>It looks like the approach you're suggesting is to manually define a <code>CType.Model</code>structure that I manually define the (lean) fields of to exactly correspond to the C struct's fields, and then define <code>CType</code> itself as a structure that has exactly one field to contain a <code>CType.Model</code>. Then, for every field access I care about, I need to write a C function with the signature  <code>lean_obj_res &lt;funcname&gt;(b_lean_obj)</code>, which is bound to a Lean function with the name of the field and the signature <code>@&amp; CType -&gt; &lt;field_type&gt;</code>. The C function casts <code>b_lean_obj_arg</code> as the C type (here, <code>SDL_CameraSpec*</code>), extracts the field, and packages it as a <code>lean_obj_res</code>.</p>\n<p>This is what is going on in your example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"sdl_camera_spec_format\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">CameraSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PixelFormat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">spec</span><span class=\"bp\">.</span><span class=\"n\">toModel</span><span class=\"bp\">.</span><span class=\"n\">format</span>\n<span class=\"c\">/-</span>\n\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_format(b_lean_obj_arg spec) {</span>\n<span class=\"cm\">  SDL_PixelFormat format = static_cast&lt;SDL_CameraSpec*&gt;(lean_get_external_data(spec))-&gt;format;</span>\n<span class=\"cm\">  return lean_alloc_external(g_pixelformat_external_class, format);</span>\n<span class=\"cm\">}</span>\n\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>What I'm still confused about is:<br>\n1) how does it make sense to define the body of <code>format</code> in Lean, if that function is decorated with <code>@[extern &lt;c_function&gt;]</code>, which I thought would provide the definition of the Lean function purely in C.<br>\n2) As a matter of style, should people writing Lean bindings to C libraries prefer to map every C type that someone would want to interact with in Lean to an opaque Lean type, or use this <code>CType.Model</code> approach where the <code>CType.Model</code> fields are defined in Lean to be analogous to the C struct's fields (but still using C code to actually do the field access)?</p>\n<p>Even though I'm still trying to get my head around this FFI code, I can tell that this is quite boilerplate-y to write. In the Rust ecosystem there are libraries like bindgen to automate some of this, and I wonder if anyone has been working on a Lean equivalent.</p>",
        "id": 565235041,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766543860
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565235041\">said</a>:</p>\n<blockquote>\n<p>What I'm still confused about is:<br>\n1) how does it make sense to define the body of <code>format</code> in Lean, if that function is decorated with <code>@[extern &lt;c_function&gt;]</code>, which I thought would provide the definition of the Lean function purely in C.<br>\n2) As a matter of style, should people writing Lean bindings to C libraries prefer to map every C type that someone would want to interact with in Lean to an opaque Lean type, or use this <code>CType.Model</code> approach where the <code>CType.Model</code> fields are defined in Lean to be analogous to the C struct's fields (but still using C code to actually do the field access)?</p>\n</blockquote>\n<p>An <code>opaque</code> definition in Lean has essentially no formally defined behavior. As a result, very little can be proved about it. Providing a Lean model for a definition alleviates this and allows neaningful reasoning about the code in Lean. However, this is contigent on parity between the Lean model and the FFI implementation. If the definitions don't match, then the proofs are meaningless. For example:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Model/FFI Mismatch Example</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"my_add\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_width(b_lean_obj_arg a, b_lean_obj_arg b) {</span>\n<span class=\"cm\">  return lean_box(0);</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- will print `0` even though it is proved to be 4</span>\n</code></pre></div>\n</div></div>",
        "id": 565235593,
        "sender_full_name": "Mac Malone",
        "timestamp": 1766544538
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565235041\">said</a>:</p>\n<blockquote>\n<p>Even though I'm still trying to get my head around this FFI code, I can tell that this is quite boilerplate-y to write. In the Rust ecosystem there are libraries like bindgen to automate some of this, and I wonder if anyone has been working on a Lean equivalent.</p>\n</blockquote>\n<p>Yes, the code is unfortunately very boilerplate. There are some user libraries that attempt to ease this burden in various ways, but I don't think any really mature solution exists in the ecosystem yet.</p>",
        "id": 565235682,
        "sender_full_name": "Mac Malone",
        "timestamp": 1766544641
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565235593\">said</a>:</p>\n<blockquote>\n<p>An <code>opaque</code> definition in Lean has essentially no formally defined behavior. As a result, very little can be proved about it. Providing a Lean model for a definition alleviates this and allows neaningful reasoning about the code in Lean. However, this is contigent on parity between the Lean model and the FFI implementation. If the definitions don't match, then the proofs are meaningless. For example:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Model/FFI Mismatch Example</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"my_add\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@&amp;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">```c++</span>\n<span class=\"cm\">extern \"C\" LEAN_EXPORT lean_obj_res sdl_camera_spec_width(b_lean_obj_arg a, b_lean_obj_arg b) {</span>\n<span class=\"cm\">  return lean_box(0);</span>\n<span class=\"cm\">}</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myAdd</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- will print `0` even though it is proved to be 4</span>\n</code></pre></div>\n<p></div></div><br>\n</p>\n</blockquote>\n<p>Ok so I guess the implication of this example is that it's possible to put the <code>@[extern]</code> attribute on any definition, and even if that definition has some lean code in it that the lean elaborator will use, at runtime the C code will be executed and the lean code will be completely ignored. So it's up to the programmer to make sure that the semantics of any C code in an extern function match any lean code in it (and also that <code>extern</code> directives are a place where Lean's correctness guarantees might fail)</p>\n<p>This would be a handy thing to mention explicitly in <a href=\"https://lean-lang.org/doc/reference/latest/Run-Time-Code/Foreign-Function-Interface/#Lean___Parser___Attr___extern\">https://lean-lang.org/doc/reference/latest/Run-Time-Code/Foreign-Function-Interface/#Lean___Parser___Attr___extern</a></p>",
        "id": 565238615,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766548396
    },
    {
        "content": "<p>huh I just discovered I had this document open in a tab: <a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b\">https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b</a> from <span class=\"user-mention\" data-user-id=\"463095\">@Yuri</span>  , which perhaps also sheds some light on these questions</p>",
        "id": 565247899,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766557523
    },
    {
        "content": "<p>Oh hello <span class=\"user-mention\" data-user-id=\"785542\">@Greg Shuflin</span> I’m glad to see my library has been useful in some way haha</p>",
        "id": 565260903,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567481
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"950553\">Srayan Jana</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565260903\">said</a>:</p>\n<blockquote>\n<p>Oh hello <span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> I’m glad to see my library has been useful in some way haha</p>\n</blockquote>\n<p>yeah it's definitely a good start towards making lean4 capable of doing graphical programming, which is a thing I personally (quixotically?) care about <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> plus a good onramp towards learning how lean4 ffi works</p>",
        "id": 565261018,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567561
    },
    {
        "content": "<p>I wonder if a way to do bindgen for C in Lean would be to end up writing a full formal definition of the C99 spec in Lean</p>",
        "id": 565261031,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567571
    },
    {
        "content": "<p>Also the main reason I stopped working in Lean FFI stuff is I found the experience on windows to be particularly painful with MSYS2 clang and whatnot</p>",
        "id": 565261088,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567607
    },
    {
        "content": "<p>it hasn't been too bad in linux</p>",
        "id": 565261099,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567617
    },
    {
        "content": "<p>actually, I have a question right this second</p>",
        "id": 565261121,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567629
    },
    {
        "content": "<p>Yeah you need to be careful when redistrubbng games with this, since not all the libraries will be linked properly</p>",
        "id": 565261174,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"950553\">Srayan Jana</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565261174\">said</a>:</p>\n<blockquote>\n<p>Yeah you need to be careful when redistrubbng games with this, since not all the libraries will be linked properly</p>\n</blockquote>\n<p>I installed lean via nix and that caused some linking issues, although I'm currently working around them</p>",
        "id": 565261245,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567701
    },
    {
        "content": "<p>anyway, here's my fork: <a href=\"https://code.everydayimshuflin.com/greg/lean-sdl3\">https://code.everydayimshuflin.com/greg/lean-sdl3</a></p>",
        "id": 565261256,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567707
    },
    {
        "content": "<p><a href=\"https://github.com/BRonen/sqlite-lean\">https://github.com/BRonen/sqlite-lean</a></p>",
        "id": 565261328,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567750
    },
    {
        "content": "<p>This readme has the most up to date research I have on lean and C ffi stuff</p>",
        "id": 565261360,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567767
    },
    {
        "content": "<p>Also you are going to want to join the SDL discord</p>",
        "id": 565261382,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567788
    },
    {
        "content": "<p>and in particular I'm owrking on adding SDL_CreateTexture. you only had SDL_CreateTextureFromSurface. the commit is <a href=\"https://code.everydayimshuflin.com/greg/lean-sdl3/commit/d1479f9db45b72c7188e4e2322871e12f0f5cbbc\">https://code.everydayimshuflin.com/greg/lean-sdl3/commit/d1479f9db45b72c7188e4e2322871e12f0f5cbbc</a></p>",
        "id": 565261418,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567806
    },
    {
        "content": "<p><a href=\"https://discord.gg/sdl-enthusiasts-405784877305298944\">https://discord.gg/sdl-enthusiasts-405784877305298944</a></p>",
        "id": 565261422,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567810
    },
    {
        "content": "<p>yeah I\"m a beginner to sdl too</p>",
        "id": 565261430,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766567813
    },
    {
        "content": "<p>Something I really wanted to do before losing motivation was adding SDL GPU supporg</p>",
        "id": 565261498,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567841
    },
    {
        "content": "<p><a href=\"https://github.com/TheSpydog/SDL_gpu_examples\">https://github.com/TheSpydog/SDL_gpu_examples</a><br>\nI wanted to port all of these to Lean at some poknf</p>",
        "id": 565261626,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766567910
    },
    {
        "content": "<p>anyway, I basically need to be able to get the <code>SDL_PixelFormat</code> out of the <a href=\"https://wiki.libsdl.org/SDL3/SDL_Surface\">https://wiki.libsdl.org/SDL3/SDL_Surface</a> struct, which I think you represented as an opaque type</p>",
        "id": 565261888,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568042
    },
    {
        "content": "<p>Yeah to be honest I was mostly copying and pasting a lot of stuff since I didn’t fully understand how the C FFI works, it’s mostly undocumented</p>",
        "id": 565261972,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568119
    },
    {
        "content": "<p>I DMed <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> a lot to ask for questions</p>",
        "id": 565261996,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568134
    },
    {
        "content": "<p>certainly it would be good if important details about the FFI could make it into public documentation, rather than having to ask a specific person</p>",
        "id": 565262143,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568247
    },
    {
        "content": "<p>Yeah that’s why I tried to write down everything I know on GitHub and in Zulip</p>",
        "id": 565262213,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568289
    },
    {
        "content": "<p>There was also this GitHub repository that was super helpfil</p>",
        "id": 565262242,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568306
    },
    {
        "content": "<p>do you ahve notes somewhere I can search for?</p>",
        "id": 565262246,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568310
    },
    {
        "content": "<p><a href=\"https://github.com/DSLstandard/Lean4-FFI-Programming-Tutorial-GLFW\">https://github.com/DSLstandard/Lean4-FFI-Programming-Tutorial-GLFW</a></p>",
        "id": 565262259,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568322
    },
    {
        "content": "<p>heh he says that <a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b\">https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b</a> supercedes his own, which I already found</p>",
        "id": 565262344,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568377
    },
    {
        "content": "<p><a href=\"#narrow/channel/113488-general/topic/Making.20SDL3.20bindings.20for.20Lean.204/with/541774356\">https://leanprover.zulipchat.com/#narrow/channel/113488-general/topic/Making.20SDL3.20bindings.20for.20Lean.204/with/541774356</a></p>",
        "id": 565262362,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568393
    },
    {
        "content": "<p><a href=\"#narrow/channel/113488-general/topic/SQLite.20bindings.20for.20Lean/\">https://leanprover.zulipchat.com/#narrow/channel/113488-general/topic/SQLite.20bindings.20for.20Lean/</a></p>",
        "id": 565262463,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568457
    },
    {
        "content": "<p>These two threads should contain most of my notes, but I’m pretty sure if you search my username up you can find more</p>",
        "id": 565262492,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568477
    },
    {
        "content": "<p>Unfortunately it seems that C FFI for lean is a pretty low priority for the Lean Team, there are a couple of issues I made on GitHub about it that are on the back butnwr</p>",
        "id": 565262619,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568558
    },
    {
        "content": "<p>understandable, it's not really the core use case</p>",
        "id": 565262656,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568580
    },
    {
        "content": "<p>The really big one is that the clang that Lean ships with is really weird, it strips out most of the standard library</p>",
        "id": 565262662,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568583
    },
    {
        "content": "<p>So you can’t actually compile most C code with it, like sqlite</p>",
        "id": 565262679,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568595
    },
    {
        "content": "<p>You have to download an external clang to compile and then link it</p>",
        "id": 565262727,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568613
    },
    {
        "content": "<p>honestly I'm more interested in getting rust FFI working reliably. I think at some point I might want to see if I can use the rust bindings to sdl as the thing that gets linked into lean, and put C code at an even further remove</p>",
        "id": 565262799,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766568664
    },
    {
        "content": "<p>That does not sound fun lol, good luck</p>",
        "id": 565262924,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1766568765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565247899\">said</a>:</p>\n<blockquote>\n<p>huh I just discovered I had this document open in a tab: <a href=\"https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b\">https://gist.github.com/ydewit/7ab62be1bd0fea5bd53b48d23914dd6b</a> from <span class=\"user-mention silent\" data-user-id=\"463095\">Yuri</span>  , which perhaps also sheds some light on these questions</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"785542\">@Greg Shuflin</span>, FYI, this document needs some revision due to a few FFI changes in Lean.</p>",
        "id": 565529504,
        "sender_full_name": "Yuri",
        "timestamp": 1766867842
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"463095\">@Yuri</span> do you know what changes offhand? also, it would probably be good if as much of this FFI information could live in the official lean FFI documentation</p>",
        "id": 565537346,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766880376
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565537346\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri</span> do you know what changes offhand? also, it would probably be good if as much of this FFI information could live in the official lean FFI documentation</p>\n</blockquote>\n<p>I’m on vacation and without my notebook, so I am of no help at this moment. I do know that we now have more primitive types and a couple (?) of small changes to some structure  representation.</p>\n<p>It seems to me that we need a core subset of C data types plus some types to provide a type safe representation for pointers, etc with some support for them directly in the code generator.</p>\n<p>In addition, a bindgen (roughly following what rust does) tool to auto generate Lean and C bindins based on existing C headers. With the blessed C subset we could reduce more of the C boilerplate and write them (and reuse them) in Lean.</p>\n<p>I do have an initial impl for this bindgen tool that at this point uses clang API to parse headers (that is where I learned most of what I know so far). Once I’m back, I will try to clean it up and share it here, if useful.</p>",
        "id": 565603210,
        "sender_full_name": "Yuri",
        "timestamp": 1766969092
    },
    {
        "content": "<p>But that says nothing about a transparent C representation for structs. Maybe this subset of C could allow us to write this getter/setters for structures in Lean (and automate that)?</p>",
        "id": 565603514,
        "sender_full_name": "Yuri",
        "timestamp": 1766969807
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565603210\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"785542\">Greg Shuflin</span> <a href=\"#narrow/channel/113488-general/topic/FFI.20-.20representing.20C.20structs.20in.20Lean/near/565537346\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri</span> do you know what changes offhand? also, it would probably be good if as much of this FFI information could live in the official lean FFI documentation</p>\n</blockquote>\n<p>I’m on vacation and without my notebook, so I am of no help at this moment. I do know that we now have more primitive types and a couple (?) of small changes to some structure  representation.</p>\n<p>It seems to me that we need a core subset of C data types plus some types to provide a type safe representation for pointers, etc with some support for them directly in the code generator.</p>\n</blockquote>\n<p>Something that I've been wondering about based on the SDL3 code is, what's the best way to work with a C <code>void*</code> arbitrary handle to something in Lean? I found myself bascially declaring an arbitrary opaque type that represents one particular use of a <code>void*</code> in SDL3 C code (e.g. a pixel buffer) - so effectively adding a bit more type safety to the C bindings based on my human knowledge of how some C struct member would probably be used.</p>\n<p>Another thing that's come to mind is C enums - the existing bindings were simply exposing (some) SDL3 C enums as <code>UInt32</code> and implementing lean functions that expect a <code>UInt32</code> argument. This works well enough, but it should be possible to translate a C enum into a Lean inductive type and map back the Lean representation to a C integer where it's being used in the underlying C functions.</p>\n<blockquote>\n<p>In addition, a bindgen (roughly following what rust does) tool to auto generate Lean and C bindins based on existing C headers. With the blessed C subset we could reduce more of the C boilerplate and write them (and reuse them) in Lean.</p>\n<p>I do have an initial impl for this bindgen tool that at this point uses clang API to parse headers (that is where I learned most of what I know so far). Once I’m back, I will try to clean it up and share it here, if useful.</p>\n</blockquote>\n<p>I would be very interested in seeing this code when you have a chance to make it publishable.</p>",
        "id": 565603557,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1766969894
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"785542\">@Greg Shuflin</span> you might be interested in this one issue i raised on github: <a href=\"https://github.com/leanprover/lean4/issues/10561\">https://github.com/leanprover/lean4/issues/10561</a></p>",
        "id": 565730298,
        "sender_full_name": "Srayan Jana",
        "timestamp": 1767051771
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"463095\">@Yuri</span> have you had a chance to clean up the bindgen tool proof-of-concept you were talking about?</p>",
        "id": 567900010,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1768363487
    }
]