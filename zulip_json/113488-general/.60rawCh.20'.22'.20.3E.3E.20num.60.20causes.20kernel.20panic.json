[
    {
        "content": "<p>Does anyone know why the parser <code>rawCh '\"' &gt;&gt; num</code> causes a kernel panic? Same thing happens if we replace <code>num</code> with <code>str</code>. How else can we make a parser that parses <code>\\x22</code>?</p>",
        "id": 484610014,
        "sender_full_name": "nrs",
        "timestamp": 1732661790
    },
    {
        "content": "<p>Could you post a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 485006857,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732844778
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/.60rawCh.20'.22'.20.3E.3E.20num.60.20causes.20kernel.20panic/near/485006857\">said</a>:</p>\n<blockquote>\n<p>Could you post a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">runParserWithEmptyInit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parserfn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkEmptyEnvironment</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ParserModuleContext</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserCache</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">initCacheForInput</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">emptyParserCache</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parseResult</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">parserfn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">emptyParserModuleContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getTokenTable</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">emptyParserState</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">parseResult</span><span class=\"bp\">.</span><span class=\"n\">stxStack</span><span class=\"bp\">.</span><span class=\"n\">toSubarray</span><span class=\"bp\">.</span><span class=\"n\">array</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">runParserWithEmptyInit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rawCh</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"s2\">\"' &gt;&gt; num).fn \"</span><span class=\"bp\">\\</span><span class=\"s2\">\"8\"</span>\n</code></pre></div>\n<p>Here you go!</p>",
        "id": 485007586,
        "sender_full_name": "nrs",
        "timestamp": 1732845391
    },
    {
        "content": "<p>for my purposes I managed to get by using <code>orelse</code></p>",
        "id": 485007631,
        "sender_full_name": "nrs",
        "timestamp": 1732845450
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"749978\">@nrs</span> As an aside, <code>initCacheForInput</code> should take the input as an argument. So, you should use <code>initCacheForInput input</code> instead of <code>initCacheForInput \"\"</code>.</p>",
        "id": 485035984,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732864972
    },
    {
        "content": "<p>In fact, testing reveals that appears to be the cause of the panic.</p>",
        "id": 485036939,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732865463
    },
    {
        "content": "<p>I would suggest the following refactor of your code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">runParserWithEmptyInit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parserfn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">mkEmptyEnvironment</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parseResult</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parserfn</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getTokenTable</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkParserState</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">parseResult</span><span class=\"bp\">.</span><span class=\"n\">stxStack</span><span class=\"bp\">.</span><span class=\"n\">toSubarray</span><span class=\"bp\">.</span><span class=\"n\">array</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">runParserWithEmptyInit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rawCh</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"s2\">\"' &gt;&gt; num).fn \"</span><span class=\"bp\">\\</span><span class=\"s2\">\"8\"</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 485037294,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732865642
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/.60rawCh.20'.22'.20.3E.3E.20num.60.20causes.20kernel.20panic/near/485035984\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"749978\">nrs</span> As an aside, <code>initCacheForInput</code> should take the input as an argument. So, you should use <code>initCacheForInput input</code> instead of <code>initCacheForInput \"\"</code>.</p>\n</blockquote>\n<p>ah I see! thank you very much for taking the time!!</p>",
        "id": 485121334,
        "sender_full_name": "nrs",
        "timestamp": 1732894270
    }
]