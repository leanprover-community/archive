[
    {
        "content": "<p>I'm watching a keynote by Jonathan Blow, in which he is demoing a program visualizer for all sorts of code quality metrics.</p>\n<p><a href=\"https://www.youtube.com/watch?v=IdpD5QIVOKQ&amp;t=1166s\">https://www.youtube.com/watch?v=IdpD5QIVOKQ&amp;t=1166s</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"IdpD5QIVOKQ\" href=\"https://www.youtube.com/watch?v=IdpD5QIVOKQ&amp;t=1166s\"><img src=\"https://uploads.zulipusercontent.net/967cbd7a7ef9c38eaa66f00dd9d79c9007726194/68747470733a2f2f692e7974696d672e636f6d2f76692f49647044355149564f4b512f6d7164656661756c742e6a7067\"></a></div><p>I think it would be really cool to have something like this for Lean code, and in particular Mathlib. We may not want the same metrics as he is using. But I can think of a whole bunch of metrics that would be useful in the Lean context.</p>",
        "id": 565413713,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766730946
    },
    {
        "content": "<p>If we can turn a Lean project into some kind of tree-like JSON object with nested subdirectories, modules, declarations with the numerical values that we're interested in attached to the declarations (or whatever we have as the child nodes), then from there it shouldn't be hard to build a similar interactive visualization using e.g. D3: <a href=\"https://observablehq.com/@d3/treemap/2\">https://observablehq.com/@d3/treemap/2</a></p>",
        "id": 565418490,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766734960
    },
    {
        "content": "<p>What is cool is that he can click on a node and it takes him to the source location. Sounds minor, but I think it massively changes how much one actually tweaks code, based on staring at the visualization.</p>",
        "id": 565429282,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744407
    },
    {
        "content": "<p>I would be interested in seeing various forms of tech debt visualised like this.</p>",
        "id": 565429318,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744448
    },
    {
        "content": "<p>The syntax of the commands does contain the location information, so there is certainly all that is needed for point-and-click to be available.</p>",
        "id": 565429331,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744461
    },
    {
        "content": "<p>But how do you then open in the correct editor window?</p>",
        "id": 565429370,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744490
    },
    {
        "content": "<p>I personally do not know, but <code>Ctrl-Click</code> takes you to places and this could use the same mechanism?</p>",
        "id": 565429407,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744530
    },
    {
        "content": "<p>Also, if it is some external program, then <code>code -r -g &lt;file_path&gt;:row:column</code> from the commandline does the right thing for me.  I imagine calling this from any external analyser would be easy to achieve?</p>",
        "id": 565429516,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744621
    },
    {
        "content": "<p>Aah, does that allow you to specify the exact VS code window? Or should people only ever have 1 window open anyway?</p>",
        "id": 565429577,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744688
    },
    {
        "content": "<p>I think that what is more important is figuring out what it is that we want to visualize: I am pretty sure that \"prettifying\" will not be the main technical point.</p>",
        "id": 565429582,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744693
    },
    {
        "content": "<p>I am not sure.  <code>code -r</code> means \"recycle the open VSCode\", but I do not know what happens if there are already multiple open sessions.</p>",
        "id": 565429616,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744734
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/program.20visualizer.20by.20Jonathan.20Blow/near/565429582\">said</a>:</p>\n<blockquote>\n<p>I think that what is more important is figuring out what it is that we want to visualize: I am pretty sure that \"prettifying\" will not be the main technical point.</p>\n</blockquote>\n<p>I would start with nolint.json, and other forms of tech debt.</p>",
        "id": 565429664,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744800
    },
    {
        "content": "<p>Right now, nolints are mostly un-documented functions, I think.</p>",
        "id": 565429698,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744844
    },
    {
        "content": "<p>One thing I like about these visualisations is that you can measure things on a gradient. Not just: this style is fine, that style is forbidden.<br>\nYou can see which files/dirs use very slow tactic calls. Or have superlong proofs. Or highly nested have-blocks.</p>",
        "id": 565429762,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744905
    },
    {
        "content": "<p>How about figuring out uses of <code>unfold</code> in a file that is not where the definition is created?</p>",
        "id": 565429803,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744944
    },
    {
        "content": "<p>Probably a lot of things wrt the module system can also be tracked and visualised</p>",
        "id": 565429812,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766744956
    },
    {
        "content": "<p>Ok, let's choose one simple example, and let's try to get it working!</p>",
        "id": 565429824,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744976
    },
    {
        "content": "<p>Once the first one is ready, adding others will be likely straightforward.</p>",
        "id": 565429848,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766744993
    },
    {
        "content": "<p>I have nothing to add to this conversation but it's a nice random bit of nostalgia + worlds colliding to see a Jonathan Blow talk on the Lean Zulip... I haven't seen this one but will have to give it a watch.</p>",
        "id": 565429980,
        "sender_full_name": "Julian Berman",
        "timestamp": 1766745090
    },
    {
        "content": "<p>I do not know about external visualisers, but maybe if someone does, then simply knowing what format we should output would be almost the whole issue.</p>",
        "id": 565429983,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745092
    },
    {
        "content": "<p>I was just reading this thread and working on it: <a href=\"https://lean-experiment.vercel.app/mathlib.html\">https://lean-experiment.vercel.app/mathlib.html</a> I was doing it on web but we could put in vscode in a webview or whatever. Right now I just set it up to count bytes and filecount in different files.</p>",
        "id": 565430026,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766745139
    },
    {
        "content": "<p>Wow, that's cool.</p>",
        "id": 565430384,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766745415
    },
    {
        "content": "<p>Already hooking into that example something like</p>\n<ul>\n<li>proof length</li>\n<li>number of tactic calls</li>\n<li>distribution of tactic uses</li>\n</ul>\n<p>would be very informative.</p>",
        "id": 565430461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745485
    },
    {
        "content": "<p>One reason I would like to have this external to VScode, is that you can then put it on a 2nd monitor. For some reason VScode doesn't like splitting a tab out onto a separate monitor.</p>",
        "id": 565430476,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766745496
    },
    {
        "content": "<p>Also, it would make it easier to connect to <img alt=\":neovim:\" class=\"emoji\" src=\"https://avatars.zulip.com/3121/emoji/images/6feb8e9e.png\" title=\"neovim\"> / <img alt=\":emacs:\" class=\"emoji\" src=\"https://avatars.zulip.com/3121/emoji/images/749cf72d.png\" title=\"emacs\"></p>",
        "id": 565430510,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766745522
    },
    {
        "content": "<p>The repo's at <a href=\"https://github.com/Andrewp2/lean-experiment\">https://github.com/Andrewp2/lean-experiment</a> btw, MIT license, I have it hosted on a vercel account (also there's some other stuff I'm working on the website, idk if we want to pull this out or w/e)</p>",
        "id": 565430545,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766745561
    },
    {
        "content": "<p>How about storing the syntax trees of all the commands into a file and then doing data analysis on that?</p>",
        "id": 565430603,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745588
    },
    {
        "content": "<p>The whole tree for all the commands might be way too much information, but maybe we can agree on filtering out some parts of the tree.</p>",
        "id": 565430673,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745643
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> How about this for an easy example: we show the file hierarchy, and the size of a node comes from its # loc. And then we color code according to number of porting notes in the file.</p>",
        "id": 565430931,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766745812
    },
    {
        "content": "<p>Ok, so basically, only the color coding is what is missing from the example above, right?</p>",
        "id": 565430995,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745852
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1004599\">@Andrew Peterson</span> how hard would it be to implement the color-coding?</p>",
        "id": 565431053,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745883
    },
    {
        "content": "<p>To first approximation, <code>porting notes</code> can be simply a regex count.</p>",
        "id": 565431099,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766745906
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> Should be pretty easy I think, as long as I can get the information in a json file or similar</p>",
        "id": 565431259,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766745995
    },
    {
        "content": "<p>Ok, so if you let me know an example format file, then I can produce the data.</p>",
        "id": 565431319,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766746027
    },
    {
        "content": "<p>Actually, when I read <code>porting notes</code>, I was thinking of <code>adaptation_note</code>s: the difference is that <code>adaptation_note</code>s are actual commands, while <code>porting notes</code> are comments.</p>",
        "id": 565431561,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766746191
    },
    {
        "content": "<p>This means that for <code>porting notes</code>, the count would only be a regex.</p>",
        "id": 565431581,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766746205
    },
    {
        "content": "<p><code>adaptation_note</code>s could be counted <em>exactly</em> through parsing, but <code>porting notes</code> do not have this status.</p>",
        "id": 565431643,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766746240
    },
    {
        "content": "<p>You may also find this interesting: <a href=\"https://gtoolkit.com/\">https://gtoolkit.com/</a><br>\nIt has treemap views as well.</p>",
        "id": 565431760,
        "sender_full_name": "suhr",
        "timestamp": 1766746299
    },
    {
        "content": "<p><a href=\"https://lean-experiment.vercel.app/mathlib.html\">https://lean-experiment.vercel.app/mathlib.html</a> ok i added porting notes, adptation_notes, and notes total.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">portingNoteRegex</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">porting</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"bp\">/</span><span class=\"n\">gi</span>\n<span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">adaptationNoteRegex</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/#</span><span class=\"n\">adaptation_note</span><span class=\"bp\">\\</span><span class=\"n\">b</span><span class=\"bp\">/</span><span class=\"n\">gi</span>\n</code></pre></div>",
        "id": 565432616,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766746914
    },
    {
        "content": "<p>Is <code>porting note</code> case-insensitive?  (It should be, I do not know if it is in the code above.)</p>",
        "id": 565432766,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747011
    },
    {
        "content": "<p>Yes, it's case-insensitive.</p>",
        "id": 565432818,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766747050
    },
    {
        "content": "<p>Sorry for the many requests, but would it be possible to filter out files that contain no matches?</p>",
        "id": 565432870,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747091
    },
    {
        "content": "<p>Or at least sort files based on the number of notes.</p>",
        "id": 565432921,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747132
    },
    {
        "content": "<p>Ok, if you refresh it should filter out files that contain no matches. Idk if you want it so you can have it filtered or un-filtered, I can add that option if you want. I also added a view for comment ratio, i.e. ratio of comments to code.</p>",
        "id": 565433471,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766747553
    },
    {
        "content": "<p>This looks great, thanks!</p>",
        "id": 565433514,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747602
    },
    {
        "content": "<p>I wonder if, to make this customizable, it would be reasonable to have your code generate its output reading an external file.</p>",
        "id": 565433541,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747632
    },
    {
        "content": "<p>And the external file would contain the metrics to be used.</p>",
        "id": 565433554,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747641
    },
    {
        "content": "<p>So, then we could produce all the metrics that we like and we could visualise them by just pointing your code to our files.</p>",
        "id": 565433584,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747668
    },
    {
        "content": "<p>For instance, for porting notes, the file could contain a list of paths and counts.</p>",
        "id": 565433634,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747705
    },
    {
        "content": "<p>json format was mentioned above, which would work and would probably be useful for more complicated metrics.</p>",
        "id": 565433659,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747735
    },
    {
        "content": "<p>It kinda already does that, I just have a build script running some regexes on a copy of mathlib i have locally that produces a JSON file, and then it visualizes that. So I think maybe I could modify it to do something like that</p>",
        "id": 565433669,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766747743
    },
    {
        "content": "<p>Ok, so if the URL of the json file could be an input, that would already be good!</p>",
        "id": 565433701,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747774
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/program.20visualizer.20by.20Jonathan.20Blow/near/565432870\">said</a>:</p>\n<blockquote>\n<p>Sorry for the many requests, but would it be possible to filter out files that contain no matches?</p>\n</blockquote>\n<p>Instead of filtering them out, I would like to use the colour coding for this. My reasoning is that it will make it much easier to compare various parts of the library, and conclude \"this corner is in a healthy state (wrt this metric), and that corner really needs some attention\"</p>",
        "id": 565433754,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766747835
    },
    {
        "content": "<p>This way, we can produce the json files by meta-programming and then the data-producing part and the data-visualising parts are cleanly separate.</p>",
        "id": 565433810,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766747878
    },
    {
        "content": "<p>Ok, I think I have it working. Actually some things seem a little strange but I'm still figuring it out. There's a schema on the page where you can upload your own JSON file, and then you can change the size and color of the treemap based on whatever properties you pick. it has an absolute and a relative coloring, so absolute is across the entire \"level\" you're looking at, while relative is relative to within a block, like relative within the \"Algebra\" block.</p>\n<p>The coloring is orange is low, blue is high, and black is specifically 0. I think actually I'll flip that around because blue is closer to black IMO.</p>",
        "id": 565435931,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766749614
    },
    {
        "content": "<p>Thanks!  I agree with your choice of flipping the colors!</p>",
        "id": 565436274,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766749964
    },
    {
        "content": "<p>I tried the <code>Entries</code> schema with your test file and it only uses <code>extra</code>, or, likely, I did not understand how to use it!</p>",
        "id": 565436324,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766750011
    },
    {
        "content": "<p>The <code>tree</code> schema appears to work as I would expect it, though.</p>",
        "id": 565436340,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766750025
    },
    {
        "content": "<p>Try clicking in once, I think it's just mistaken about where the root is</p>",
        "id": 565436349,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766750036
    },
    {
        "content": "<p>Ah, yes!  Clicking in and then Choosing the <code>Demo</code> dir fixes it!</p>",
        "id": 565436408,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766750090
    },
    {
        "content": "<p>Maybe, for the custom format, assuming that <code>Mathlib</code> is the root dir is not expected.</p>",
        "id": 565436439,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766750111
    },
    {
        "content": "<p>Yeah, I'll change that, and I also think there's something up with the relative coloring mode.</p>",
        "id": 565436539,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766750217
    },
    {
        "content": "<p>Thanks a lot!  Btw, this looks like it could be very useful!  We'll have to play with some more interesting custom data, though.</p>",
        "id": 565436587,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766750259
    },
    {
        "content": "<p>Ok I think I got that all fixed, I'm gonna head out for now</p>",
        "id": 565437696,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766751092
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> a while ago I wrote some code that might be useful: <a href=\"https://github.com/adamtopaz/lean_constant_data\">https://github.com/adamtopaz/lean_constant_data</a></p>",
        "id": 565441358,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1766754067
    },
    {
        "content": "<p>I haven’t read through the whole thread yet though</p>",
        "id": 565441387,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1766754093
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1004599\">@Andrew Peterson</span> 's <code>lean-experiment</code> site is cool! It'd be interesting to try and parse the output of <code>lake build -v</code> to visualize build timings as well. Then presumably we could get something like this added to radar (?). cc: <span class=\"user-mention\" data-user-id=\"421885\">@Joscha Mennicken</span> </p>\n<p>Declaration-level build timings would be even better too, but is there a way to <code>set_option trace.profiler true</code> in every file without actually adding it to the source?</p>",
        "id": 565447828,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766759643
    },
    {
        "content": "<p>You can set it as an option the lakefile</p>",
        "id": 565448771,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766760468
    },
    {
        "content": "<p>And Radar already does this for core: <a href=\"https://speed.lean-lang.org/lean4-out/b3b33e85d38317eca940e4a9653660e9f8b5682a/\">https://speed.lean-lang.org/lean4-out/b3b33e85d38317eca940e4a9653660e9f8b5682a/</a></p>",
        "id": 565448805,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1766760510
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1004599\">@Andrew Peterson</span> thanks for the rapid iteration!</p>\n<ol>\n<li>Do you have any idea how hard it would be to make this into a local web app, so that features like \"ctrl/shift/whatever clicking a node opens the file in VS code\" become feasible?</li>\n<li>Would it be possible to have further nesting? Atm it seems that all nodes go at most 2 levels deep. But on a sufficiently large screen, I can imagine have all ~7000 files of Mathlib in 1 huge treemap, organized according to the directory structure.</li>\n</ol>",
        "id": 565451298,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766762623
    },
    {
        "content": "<p>FWIW I believe any website can open a file in VSCode using <code>vscode://</code> urls (it just asks the user for confirmation)</p>",
        "id": 565452671,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766763679
    },
    {
        "content": "<p>Looking at <a href=\"https://code.visualstudio.com/docs/configure/command-line#_opening-vs-code-with-urls\">the help page on <code>vscode://</code> URLs</a>, wouldn't the webpage somehow need to know the path to my mathlib4 directory too?</p>",
        "id": 565458206,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766768915
    },
    {
        "content": "<p>Good point, but I believe it can link to trigger some functionality the Lean extension, so only the extension needs to know where your Mathlib is</p>",
        "id": 565458363,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766769067
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/113488-general/topic/program.20visualizer.20by.20Jonathan.20Blow/near/565451298\">said</a>:</p>\n<blockquote>\n<ol>\n<li>Do you have any idea how hard it would be to make this into a local web app, so that features like \"ctrl/shift/whatever clicking a node opens the file in VS code\" become feasible?</li>\n</ol>\n</blockquote>\n<p>It looks like it should be pretty easy to run locally with the <a href=\"https://vercel.com/docs/cli/dev\"><code>vercel dev</code></a> command -- you'd probably just have to modify the URLs to somehow get VSCode to open them.</p>",
        "id": 565458386,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766769087
    },
    {
        "content": "<p>Ah, I guess it wouldn't be hard to have a text form or something on the page where you could enter the path to your local mathlib4 directory, then the page could use that in its <code>vscode://</code> URLs</p>",
        "id": 565459436,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766770192
    },
    {
        "content": "<p>Or even Snir's approach? But I guess that would need functionality in the Lean 4 extension that's not there yet? So then the text form would be good for a v1</p>",
        "id": 565461598,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766772145
    },
    {
        "content": "<p>OK, I was able to get <code>vscode://</code> links working in <a href=\"https://github.com/Andrewp2/lean-experiment/pull/1\">https://github.com/Andrewp2/lean-experiment/pull/1</a> . (The correct command to get the app working locally is actually <code>npm run dev</code>) Only tested a little bit so there might be some weird behavior.</p>",
        "id": 565467203,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766778448
    },
    {
        "content": "<p>Andrew merged my PR so you should be able to test it now: <a href=\"https://lean-experiment.vercel.app/mathlib.html\">https://lean-experiment.vercel.app/mathlib.html</a></p>\n<p>I recommend opening your mathlib4 directory in VSCode before clicking links to files from the site. Also, both the browser and VSCode will ask for your permission to proceed so there's a little bit of pop-up overload, but it does seem to work for most files.</p>\n<p>There's a bug where some leaf rectangles don't link properly in VSCode: should be fixed in <a href=\"https://github.com/Andrewp2/lean-experiment/pull/2\">https://github.com/Andrewp2/lean-experiment/pull/2</a></p>",
        "id": 565472743,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766785050
    },
    {
        "content": "<p>Cool, I'll try to get that merged in. I'm working on a tauri version so it can run on desktop</p>",
        "id": 565472868,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766785198
    },
    {
        "content": "<p>Why Tauri rather than a VSCode extension?</p>",
        "id": 565473921,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766786461
    },
    {
        "content": "<p>It'll work with neovim/emacs, any editor if it's an external thing. But I could probably just do a vscode extension right after</p>",
        "id": 565474904,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766787889
    },
    {
        "content": "<p>In my experience, neovim/emacs users will refuse to download Electron/Tauri apps anyway</p>",
        "id": 565492612,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766816424
    },
    {
        "content": "<p>This is not true at all. I know dozens of neovim users and they all use a graphical web browser (except for blind people). With Electron there will be the reluctance to use of bloated slow software that has not much to do with neovim or emacs. But I don’t see any issue with using a Tauri app if there is something truly graphical to display.</p>",
        "id": 565501128,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1766828816
    },
    {
        "content": "<p>I don't think you can make the claim \"not true at all\" about a statement prefixed with \"in my experience\".<br>\nYou might have the opposite experience, but that shouldn't invalidate my own.<br>\nI will however contest that your experience might be biased as a neovim user, and point out that you equate \"Electron\" with \"bloated slow software\" which aligns with what I said.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/113488-general/topic/program.20visualizer.20by.20Jonathan.20Blow/near/565501128\">said</a>:</p>\n<blockquote>\n<p>I know dozens of neovim users and they all use a graphical web browser (except for blind people).</p>\n</blockquote>\n<p>I don't see how this is related, although in the case of a browser I'd expect a correlation between neovim/emcas and using Firefox over Chromium based browsers.</p>",
        "id": 565505664,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766834711
    },
    {
        "content": "<p>In any case, the more the merrier, just thought I'd mention the possibility</p>",
        "id": 565505694,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766834773
    },
    {
        "content": "<p>Very cool project! Small issue I noticed, when I hover on a top-level block (e.g. \"Algebra\") it says \"0 LOC 0 PORTING NOTES\", but I was expected to see the sum of all LOC and NOTES in its sub-rectangles.</p>\n<p><a href=\"/user_uploads/3121/5iRP05IW2MNqbMJOe15lNj4r/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/5iRP05IW2MNqbMJOe15lNj4r/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"406x342\" src=\"/user_uploads/thumbnail/3121/5iRP05IW2MNqbMJOe15lNj4r/image.png/840x560.webp\"></a></div>",
        "id": 565517452,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1766850966
    },
    {
        "content": "<p>Also from the Rust source in tauri, is the analysis entirely textually based?</p>",
        "id": 565517494,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1766851045
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"766285\">@Gavin Zhao</span> Just pushed a fix to that<br>\nYup, just regexes/string matching</p>",
        "id": 565526557,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766862946
    },
    {
        "content": "<p>So right now:<br>\nWe have the website<br>\nThere's a desktop/tauri version<br>\nAnd there's also a vscode extension. The VSCode extension just includes the treemap, not the rest of the website</p>\n<p>The desktop version and vscode extension aren't published on anything, they're just in the repo and working on my machine. I'm working on getting a version that has a text box where you can put a regex in and it'll rescan and do the coloring for that, but there are some performance issues relating to rescanning the entire repo that I'm trying to fix now. I tried having a version that watched the folder, but I got rid of that and replaced it with a \"rebuild\" button that recalculated the JSON. I think in the end, most of the information we want we can only get at compile time anyway, so that'll just be a static file reproduced during compilation.</p>\n<p>Right now everything is tied tightly to mathlib, just to get that working first before looking at other projects.</p>\n<p>Both the desktop and vscode extension don't have that awkward double pop-up thing.</p>",
        "id": 565532295,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766872101
    },
    {
        "content": "<p><a href=\"https://github.com/Andrewp2/lean-experiment/issues/10\">https://github.com/Andrewp2/lean-experiment/issues/10</a> I opened an issue to talk about what metrics to include. I'm a beginner in Lean, so I don't know what metrics we want to capture exactly, so if you have any good ideas I can look into it.</p>",
        "id": 565532396,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1766872274
    },
    {
        "content": "<p>I think more opportunities lie in semantic analysis using <code>InfoTree</code>s and friends.</p>",
        "id": 565542847,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1766888740
    },
    {
        "content": "<p>Type-checking time will be an intersting one too <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 565542886,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1766888798
    },
    {
        "content": "<p>I technically have an infotree exporter, but it would take like 12 hours to actually export all the infotrees from mathlib. I might be doing something really dumb, but I'll keep looking into it and see if there's a way to get a good amount of information in 15 minutes instead of 12 hours.</p>",
        "id": 565889381,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1767181435
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/KGtwC2oGcNwtA2UC4S4fJqTp/image.png\">image.png</a><br>\nIt took around 12 hours to run, but I got a snapshot of at least some information of all the infotrees. Unfortunately I've only tracked a few high level metrics for each file, the above image is showing size as \"Infotree nodes total\" and color as \"infotree widget items\".</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/KGtwC2oGcNwtA2UC4S4fJqTp/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2281x1755\" src=\"/user_uploads/thumbnail/3121/KGtwC2oGcNwtA2UC4S4fJqTp/image.png/840x560.webp\"></a></div><p>I think tomorrow I'll try another export, but this time export the literal infotree data instead of just a high-level summary. If anyone cares to look, I pushed the JSON files including the infotree_treemap.json that is showed in this view here.</p>\n<p>I think the reason why it's slow is just that InfoTrees have a ton of data. For example, Analysis/Asymptotics/Defs.lean has ~ 1400 lines, but nearly 150,000 InfoTree nodes. So assuming that holds across mathlib, there's approx 100 infotree nodes for each line of code.</p>",
        "id": 566146145,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1767443321
    },
    {
        "content": "<p>This is really, really cool! :) I have a wish list for what sorts of displays we could have, in case it's useful.</p>\n<p>I would love to go one step deeper visualization-wise. There are, I think, two sorts of things that could reasonably be \"atomic\":</p>\n<ul>\n<li>individual commands</li>\n<li>individual declarations</li>\n</ul>\n<p>Note that a command may correspond to between 0 and arbitrarily many declarations (but no declaration corresponds to multiple commands).</p>\n<p>We could further group declarations by type (e.g. <code>def</code>, <code>theorem</code>, <code>inductive</code>, <code>structure</code>, etc.—these have internal meaning beyond the syntax of the command itself). Arguably we ought to group <code>instance</code>s, even though this is not a declaration type per se.</p>\n<p>Attributes that can be used to color or size declarations include the expression size of the value (if they have one) and type, their visibility (<code>public</code>, <code>private</code>, <code>@[expose]</code>), other modifiers, attributes, terms, tactics, and notations used during elaboration of the declaration, and performance-related measurements, such as heartbeats used, profiling of things like instance synthesis, and elaboration time.</p>\n<p>Some of these performance measurements might be more easily associated with <em>commands</em>, so we'd want to think about the visualizations that would be available here!</p>\n<h3>Some more specific ideas</h3>\n<ul>\n<li>\n<p>Something that would be really cool, but of which I'm not sure of the feasibility: the ability to write a Loogle query, then show (either by color or size) the declarations (and/or modules which house them) which satisfy the query. E.g. the visualization could show me a map of all declarations which mention <code>Nat</code> in the type.</p>\n</li>\n<li>\n<p>It might be interesting to visualize the scopes and declaration dependencies in some visibility-aware way. The demo this is based off of colored declarations by whether they call out to other modules. For us, it could be interesting to see how big the imported and exported scopes are, and how they're used. E.g., within a module, we could show boxes for the number of publicly imported declarations, the number of privately imported decls (and the meta ones as well), boxes for each of the declarations, and color by visibility. (Ideally we could also turn off displaying the imported scopes when convenient.) Modules with many public imports and many public exposed declarations could then be identified as targets for module-system optimization. It's a bit difficult to know what to do for aggregation here, though...maybe the scale is just \"more public\"?</p>\n</li>\n<li>\n<p>For visualizing tactic use, we could indeed look at the infotrees—we're likely curious about what tactics the user has actually written, though, so we ought to cross-reference with the syntax trees. The infotrees are useful for associating tactics with parent declarations, though. And I can imagine that we might also want to \"count\" tactics that are used indirectly, e.g. via macro expansion or autoparams, which would only show up in the infotrees.</p>\n</li>\n</ul>\n<h3>Other thoughts</h3>\n<p>I don't know what the implementation limitations are, but I do agree with Johan's sentiment earlier that it would be really useful to be able to see everything at once. I'm not sure if it makes sense to only see two layers down all the time, since the resulting grouping mostly reflects less-relevant directory organization as opposed to the \"actual\" module leaves. We might be two layers from the bottom in one rectangle and 5 in another. Normalization mitigates this somewhat, but can drown out important signals from individual modules. Perhaps we could specify the number of layers from the <em>bottom</em> instead of the top? Also, maybe simply different aggregations, such as taking the max of values across modules, could help in specific cases?</p>\n<p>I'm also a little skeptical of the \"miscellaneous\" groupings in principle; it suggests some organization of the directory which is not really there, but blends in with the rest.</p>\n<p>However, I have no idea if this is simply a necessity for implementation! :)</p>",
        "id": 566173459,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767471409
    },
    {
        "content": "<p>So, I am thinking about what the lean side of the implementation here could look like, and what json it could emit! :) The implementation question I'd like to ask is how feasible it is to generalize the schema to have a structure like, e.g.,</p>\n<ul>\n<li>module<ul>\n<li>command*<ul>\n<li>declaration*</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>where, crucially, we would need the ability to special-case certain entries, and can have different views that take advantage of those special cases.</p>\n<p>For example, we might want to regard an <code>import</code> as a command, and associate with it the size of the imported scope, what modifiers it has (<code>public</code>/<code>meta</code>/<code>all</code>), and what module it points to. None of this data makes sense for other commands; a visualization that made use of these fields would have to ignore other non-import objects.</p>\n<p>So, is it reasonable to create a json file that has all of this data, then dynamically filter away the things we don't want? For instance, maybe we want to collapse the \"command\" level entirely and just view declarations. Would that be doable, or would we need to preprocess these to be separate if we want to be reasonably performant?</p>\n<p>Likewise, can we go in the other direction, and create more groupings? Let's say we want to show declarations, but group them into rectangles with different-colored borders depending on whether they're <code>def</code>s, <code>theorem</code>s, etc., which would (in this setup) be recorded in a field in the declaration json itself. Is grouping like this feasible to do on the web side, or would we need to embed this in the structure of the json from the outset?</p>\n<p>Anyway, very excited about this, and I'd be very happy to contribute! :)</p>",
        "id": 566173650,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767471580
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/113488-general/topic/program.20visualizer.20by.20Jonathan.20Blow/near/565501128\">said</a>:</p>\n<blockquote>\n<p>This is not true at all. I know dozens of neovim users and they all use a graphical web browser (except for blind people). With Electron there will be the reluctance to use of bloated slow software that has not much to do with neovim or emacs. But I don’t see any issue with using a Tauri app if there is something truly graphical to display.</p>\n</blockquote>\n<p>I typically use Neovim as my editor and I have no issue in principle with using a Tauri app. I'd much prefer it to a vscode plugin in fact because I don't use vscode.</p>",
        "id": 566214247,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1767523332
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/7lukfFBraul_LPWneInaK4HD/image.png\">image.png</a><br>\nOk, here's a version that gets rid of the 2-level thing so you can see all the leaf files at the same time. I had to change around the colors a little bit due to an issue with 1px size files and how borders work, so now if a value is exactly 0 it gets a light red/dark red color. This change enabled me to get rid of the Miscellaneous groupings, that was previously necessary to keep text from overlapping. Instead the text is now at the bottom. It also shows all the values associated with that leaf on hover.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/7lukfFBraul_LPWneInaK4HD/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2312x1978\" src=\"/user_uploads/thumbnail/3121/7lukfFBraul_LPWneInaK4HD/image.png/840x560.webp\"></a></div><p>I haven't heard of Loogle before, I'll have to take a look into it. The only major implementation limitation right now that I can think of is that on the website, the SVG and data has to be hosted somewhere, built during compilation, etc. If we're on the desktop/vscode extension and there's a local copy of mathlib then I can build new treemaps just right there on the client.</p>",
        "id": 566268567,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1767582008
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1004599\">@Andrew Peterson</span> This is really cool! Thanks so much!</p>\n<p>One tiny request: filename paths are in all caps. Do you think you could change that, so that it reflects the mixed-caps names faithfully.</p>",
        "id": 566297130,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1767601669
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> Done!</p>",
        "id": 566298615,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1767602172
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/BnuJunksJXTe1MgXHBcn-VOj/image.png\">image.png</a><br>\n<a href=\"/user_uploads/3121/DtM2LI04dfJ92wPmIxqhekv3/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/BnuJunksJXTe1MgXHBcn-VOj/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2337x1488\" src=\"/user_uploads/thumbnail/3121/BnuJunksJXTe1MgXHBcn-VOj/image.png/840x560.webp\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/3121/DtM2LI04dfJ92wPmIxqhekv3/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2313x1702\" src=\"/user_uploads/thumbnail/3121/DtM2LI04dfJ92wPmIxqhekv3/image.png/840x560.webp\"></a></div><p>Ok updates:</p>\n<p>I kept trying to export infotree data, but it kept blowing up no matter what I did, until I limited nodes by <code>expr.sizeWithoutSharing</code> to 50,000. Apparently at some points this can be over 3.3 GB inside a single string! I now have some summary metrics based on infotree metrics on my local machine. I haven't yet merged that data into the website but I could do that tomorrow. You can see the different metrics I've added so far in the screenshot.</p>\n<p>I took a quick look at Loogle's internals, it seems plausible to integrate something like that directly into the vscode extension, if not literally through the Loogle CLI then just by slinging some code around until it works.</p>\n<p>Just for fun, I made a 3d view of the treemap data formatted into the style of a city using Three.js as a part of <a href=\"https://genuary.art/\">Genuary</a>. I even integrated the Rapier physics engine, so you can actually run into buildings and can turn gravity on. The city only contains information on LOC right now. It would be cool if one day I could advance it far enough where you could walk into each building and see the lean proofs inside, perhaps even with some diagrams and portals you could walk through to other buildings.</p>",
        "id": 567387274,
        "sender_full_name": "Andrew Peterson",
        "timestamp": 1768134252
    },
    {
        "content": "<p>The mathlib metropolis!</p>",
        "id": 567388595,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768136003
    },
    {
        "content": "<p>The 3d view idea is insanely cool.</p>",
        "id": 567397753,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1768146207
    },
    {
        "content": "<p>Unless I’m misinterpreting, I think we should be able solve the InfoTree issue by handling them within lean, and only exporting from lean the metrics we care about! :)</p>",
        "id": 567406037,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768153894
    },
    {
        "content": "<p>This is a random thought but I wonder if we could incorporate this into radar somehow. <span class=\"user-mention\" data-user-id=\"421885\">@Joscha Mennicken</span> recently added radar’s benchmark suite to mathlib in <a href=\"https://github.com/leanprover-community/mathlib4/pull/33762\">#33762</a> and there are instructions there for how to add new metrics, so maybe being able to see these visualizations on each benchmarked commit wouldn’t be too hard to add?</p>",
        "id": 568262781,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768495500
    },
    {
        "content": "<p>Radar is focused on lean/mathlib performance, and only tracks per-module file size (in lines) and build instruction count. It sounds like you would want more per-file info in the visualizations, but those would probably not be worth the cost of tracking them in the benchmark suite.</p>\n<p>I think it makes sense for this kind of visualization to be a separate tool, though of course radar could link to visualizations like it already does for the lakeprof report.</p>",
        "id": 568265461,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1768496215
    }
]