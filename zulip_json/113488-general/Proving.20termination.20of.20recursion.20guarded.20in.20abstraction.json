[
    {
        "content": "<p>The following code works as expected. <code>increasing</code> terminates immediately on all calls without recursing at all, it simply constructs a new function. However, I don't know how to convince the termination checker of this.</p>\n<p>I also don't know how to prove that <code>LazyList</code> is inhabited without <code>.inhabited_proof</code></p>\n<p>Help would be appreciated.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">inhabited_proof</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inhabited_proof</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head'</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">inhabited_proof</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">unreachable!</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n\n<span class=\"c1\">-- example : (increasing |&gt;.head.snd |&gt;.head.fst) = 1 := rfl</span>\n<span class=\"c1\">-- #reduce increasing |&gt;.head.snd |&gt;.head.snd</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">increasing</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 1</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 2</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 3</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 4</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 5</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 6</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 7</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"c1\">-- 8</span>\n</code></pre></div>",
        "id": 526035483,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751012780
    },
    {
        "content": "<p>It's because the lazy list isn't inhabited without that constructor:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">mutual</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lazyList_not_inhabited'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">lazyList_not_inhabited</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lazyList_not_inhabited</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">lazyList_not_inhabited'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"kn\">end</span>\n</code></pre></div>\n<p>It expects you to be able to recurse by applying the function; but this is clearly non-terminating for <code>LazyList</code>, so contradiction</p>",
        "id": 526052131,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751019015
    },
    {
        "content": "<p>What you'd want is a coinductive; sadly these don't exist in Lean directly; but you can hack one together (which you can't prove things about but I don't think that's your goal):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">LazyListRef</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonemptyType</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyListRef</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">nonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyListRef</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‹_›⟩</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">headImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">headImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"c1\">-- just show that it's inhabited</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">nextImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">nextImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">nonempty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- just show that it's inhabited</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n\n<span class=\"c1\">-- example : (increasing |&gt;.head.snd |&gt;.head.fst) = 1 := rfl</span>\n<span class=\"c1\">-- #reduce increasing |&gt;.head.snd |&gt;.head.snd</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">increasing</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 1</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 2</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 3</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 4</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 5</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 6</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"c1\">-- 7</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">next</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"c1\">-- 8</span>\n</code></pre></div>",
        "id": 526055093,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751020165
    },
    {
        "content": "<blockquote>\n<p>It's because the lazy list isn't inhabited without that constructor:</p>\n</blockquote>\n<p>The proof using mutual structural recursion you provided is helpful for understanding. I am, however, confused about how the <code>#eval</code> can work without ever constructing the variant which proves the type is inhabited.</p>\n<p>Are proofs in Lean only capable of showing things which are true for all reduction orders even though lean has a particular one? If that's true I can see the argument that a recursion might infinitely reduce the inside of the returned function without ever actually returning.</p>\n<blockquote>\n<p>but you can hack one together</p>\n</blockquote>\n<p>I'm not sure I understand the advantage of the approach you describe with the <code>unsafe</code> and casting. You still have a <code>LazyList</code> with an extra variant.</p>",
        "id": 526136223,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751049523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526136223\">schrieb</a>:</p>\n<blockquote>\n<p>confused about how the <code>#eval</code> can work without ever constructing the variant which proves the type is inhabited.</p>\n</blockquote>\n<p>The restriction that every recursion has to end is only a restriction of the type system. The compiler (and thus <code>#eval</code>) doesn't care about whether your function terminates in the same way that pretty much every programming language allows you to have infinite loops in your program. It would only be problematic if the type system would know the definition of <code>increasing</code> because then it would cause a contradiction (infinite stack of <code>head</code>s). However, <code>partial</code> means that the type system doesn't know any more about the function than its type; for all it knows, the function could just immediately return <code>inhabited_proof</code>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526136223\">schrieb</a>:</p>\n<blockquote>\n<p>Are proofs in Lean only capable of showing things which are true for all reduction orders even though lean has a particular one?</p>\n</blockquote>\n<p>Functions in the type system should not be viewed as functions in the programming sense. Instead, you can imagine them as a big table that has an entry for every value. In particular <code>Unit → α</code> becomes meaningless then because that'd just correspond to a table with a single entry. And then we just have a rule that inductive types need to have a finite depth, so you can't have infinite <code>LazyList</code>s \"all the way down\".</p>\n<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526136223\">schrieb</a>:</p>\n<blockquote>\n<p>I'm not sure I understand the advantage of the approach you describe with the <code>unsafe</code> and casting.</p>\n</blockquote>\n<p>The approach here is similar to what <code>partial</code> does -- hide the definition from the type system. We are trying to mimic the definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>here but without the <code>unsafe</code> on increasing. So what we do is first establish the internal type <code>LazyListImpl</code> which is what the actual representation for <code>LazyList</code> should be. Then we use <code>opaque</code> to define a new type, <code>LazyListRef</code>, which is just some arbitrary nonempty type to please the type system. In the same sense, the definition of <code>LazyList</code> is only there to make the operations of <code>LazyList</code> consistent in the type system. The definitions <code>LazyList.headImpl</code> and <code>LazyList.nextImpl</code> are the \"real\" definitions of these functions, those that we want to use for <code>#eval</code>. We said <code>LazyListImpl</code> is supposed to be the runtime representation of <code>LazyList</code>, so we just use an unsafe cast to cast between them. Then the real functions <code>LazyList.head</code> and <code>LazyList.next</code> are again just there to please the type system, we just use <code>LazyList.headImpl</code> and <code>LazyList.nextImpl</code> under the hood (through <code>@[implemented_by]</code>). This makes it possible to use <code>LazyList</code> without <code>unsafe</code> but with the same computational behavior as the unsafe definition.</p>",
        "id": 526151409,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751057914
    },
    {
        "content": "<blockquote>\n<p>This makes it possible to use <code>LazyList</code> without <code>unsafe</code> but with the same computational behavior as the unsafe definition.</p>\n</blockquote>\n<p>Right. But the <code>increasing</code> function is still <code>partial</code> in your translation. What are you gaining by hiding the real definition of the type that you can't prove things about? The runtime behavior already matches what it should, so there's not need to complicate it with <code>unsafe</code>.</p>",
        "id": 526156255,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751061400
    },
    {
        "content": "<blockquote>\n<p>which you can't prove things about but I don't think that's your goal</p>\n</blockquote>\n<p>Actually my goal is to prove properties of the transition function without exposing the state in the type signature. That way these LazyLists can be composed without having to thread the internal state.</p>\n<p>I'm now trying to add a gas parameter and prove things about the function under the condition that the gas is sufficiently large. Do you have a better idea?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Gas</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">instance</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Gas</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eol</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">eol</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head'</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eol</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"ran out of gas for LazyList.head'\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Gas</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">gas</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">gas</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">eol</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">gas</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">gas</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idx</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">head'</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">GetElem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getElem</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">idx</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">increasing_incr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g_gt_n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"o\">:=</span><span class=\"bp\">⟨</span><span class=\"n\">g</span><span class=\"bp\">⟩</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"o\">:=</span><span class=\"bp\">⟨</span><span class=\"n\">g</span><span class=\"bp\">⟩</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">increasing</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"bp\">.</span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">increasing_eq_idx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"o\">:=</span><span class=\"bp\">⟨</span><span class=\"n\">g</span><span class=\"bp\">⟩</span><span class=\"o\">)[</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">admit</span>\n</code></pre></div>",
        "id": 526156654,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751061730
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526156255\">schrieb</a>:</p>\n<blockquote>\n<p>What are you gaining by hiding the real definition of the type that you can't prove things about?</p>\n</blockquote>\n<p>The only difference is that you don't need to consider the case for <code>inhabited_proof</code>. This might be a (small but still) performance improvement.</p>",
        "id": 526156721,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751061788
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526156654\">schrieb</a>:</p>\n<blockquote>\n<p>Actually my goal is to prove properties of the transition function without exposing the state in the type signature.</p>\n</blockquote>\n<p>Okay, then my question is: Do you <em>just</em> care about proofs or also computation? If you don't care about efficient runtime, just use <code>Nat → α</code>.</p>",
        "id": 526156853,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751061916
    },
    {
        "content": "<p>Runtime matters, but it doesn't need to be terribly fast. Just needs to run a few 1,000 or 100,000 iterations over several minutes (though the transition functions will be more complicated) for the \"simulation\".</p>\n<p>The goal with this is to see if it's possible to emulate <a href=\"https://hackage-content.haskell.org/package/clash-prelude-1.8.2/docs/Clash-Explicit-Signal.html#t:Signal\">Clash's Signal Type</a> to hide the coinductive state for easier composition while enabling proofs about its behavior. The hardware synthesizer won't really run the type, but special-case it to extract the transition function.</p>\n<blockquote>\n<p>just use <code>Nat → α</code>.</p>\n</blockquote>\n<p>I don't follow.</p>",
        "id": 526157138,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751062148
    },
    {
        "content": "<p>The <code>Nat → α</code> approach would be essentially defining a <code>LazyList</code> by its <code>get</code> function</p>",
        "id": 526157423,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751062368
    },
    {
        "content": "<p>That makes the runtime for iteration quadratic though</p>",
        "id": 526157447,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751062386
    },
    {
        "content": "<blockquote>\n<p>The <code>Nat → α</code> approach would be essentially defining a <code>LazyList</code> by its <code>get</code> function</p>\n</blockquote>\n<p>You mean define the function recursively? Like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">doubling</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">doubling</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<blockquote>\n<p>That makes the runtime for iteration quadratic though</p>\n</blockquote>\n<p>I know that <code>Thunks</code> exist.  Are they not usable for proofs?</p>",
        "id": 526157683,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751062595
    },
    {
        "content": "<p>Yeah I mean if you try to do something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sumOfFirstN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sumOfFirstN</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">sumOfFirstN</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and you define your <code>LazyList</code> using a recursive <code>Nat → α</code> function, you'd get quadratic runtime</p>",
        "id": 526157891,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751062754
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/stream/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526157683\">said</a>:</p>\n<blockquote>\n<p>I know that <code>Thunks</code> exist.  Are they not usable for proofs?</p>\n</blockquote>\n<p>They are usable in proofs, but unfortunately it doesn't make the runtime faster, since you are recomputing the thunk every time you call the function with a different input.</p>",
        "id": 526158000,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751062861
    },
    {
        "content": "<blockquote>\n<p>runtime for iteration quadratic</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>  That probably will be too much of a performance overhead.</p>\n<blockquote>\n<p>you are recomputing the thunk every time you call the function with a different input.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>  How are Thunks meant to be used and how does this differ?</p>",
        "id": 526158192,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751063040
    },
    {
        "content": "<p>Thunks work best when you use the same one over and over</p>",
        "id": 526158271,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751063107
    },
    {
        "content": "<p>Thunks are not cache, but if you have two references to the same thunk (as in same memory address) then you only need to evaluate once</p>",
        "id": 526158283,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751063124
    },
    {
        "content": "<p>But if you define something by repetition you necessarily construct something every time</p>",
        "id": 526158301,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751063145
    },
    {
        "content": "<p>Since no information is being carried between function calls you do need to recompute it</p>",
        "id": 526158329,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751063180
    },
    {
        "content": "<p>Sounds like the gas method is best then (assuming I'm not missing  something where it doesn't work)?</p>",
        "id": 526158407,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751063252
    },
    {
        "content": "<p>You could pass around a cache</p>",
        "id": 526158494,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751063335
    },
    {
        "content": "<p>So run everything in a monad with state of the cache and indexing function names + arguments to values?</p>",
        "id": 526158574,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751063414
    },
    {
        "content": "<p>Yeah that's basically what I'm suggesting</p>",
        "id": 526158608,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751063443
    },
    {
        "content": "<p>It worked for me for relatively small computations</p>",
        "id": 526158620,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751063460
    },
    {
        "content": "<p>It looks like I've either misunderstood the <code>Nat → α</code> approach or it also doesn't work with Lean's termination checker.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Signal</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">reset</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HMul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">HMul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hMul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signal</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">reverse</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">multiply_add</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- [0, 2, 4]</span>\n</code></pre></div>",
        "id": 526160840,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751065730
    },
    {
        "content": "<p>The way you've written it it's not terminating, even though it terminates on all inputs. I think you need to use some sort of corecursion.</p>",
        "id": 526161009,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751065919
    },
    {
        "content": "<blockquote>\n<p>The way you've written it it's not terminating, even though it terminates on all inputs.</p>\n</blockquote>\n<p>What? I thought the definition of terminating is termination on all inputs.</p>",
        "id": 526161042,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751065954
    },
    {
        "content": "<p>Ok if you unfold some stuff then you can prove it terminates, but you can't prove it terminating with the built-in termination facilities.</p>",
        "id": 526161085,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751066018
    },
    {
        "content": "<p>Ah.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signal2</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Signal2</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signal2</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Well if I have to unfold <code>register</code> then that definitely won't work as an approach. The whole idea with the <code>Signal</code> and <code>register</code> functions is to make the <code>Signal</code> definition private and only allow construction with <code>register</code> because only accessing the previous value (like <code>register</code> does) is actually hardware synthesizable.</p>\n<p>Is it possible to write a macro which desugars the unworking version into the second for the termination checker without making it easy for the user to use the desugared version?</p>",
        "id": 526161585,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751066543
    },
    {
        "content": "<p>Here's another definition similar to the one I defined before, except with a model implementation. There are some hacks though because the compiler gets a bit in the way.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\">Runtime implementation</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"bp\">.</span><span class=\"n\">fromGetter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fromGetter</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">irreducible</span><span class=\"kd\">]</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SeqType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">mkInternal</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">getInternal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SeqType</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\">Porting runtime implementation to `LazyList` using `unsafeCast`</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mkImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyListImpl</span><span class=\"bp\">.</span><span class=\"n\">fromGetter</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">getImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">LazyListImpl</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyConsImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyListImpl</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">headImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">always_inline</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">tailImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyListImpl</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\">Model implementations</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mkImpl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">irreducible</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mkInternal</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">getImpl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">irreducible</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">getInternal</span><span class=\"w\"> </span><span class=\"n\">l</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyConsImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyCons</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">head</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">())</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">headImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">tailImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get_mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">tail_mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">forall_iff_mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">with_unfolding_all</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">instCCPOPi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">FlatOrder</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">ofNonempty</span><span class=\"o\">))</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">rel</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"n\">rel_refl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_refl</span>\n<span class=\"w\">  </span><span class=\"n\">rel_trans</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_trans</span>\n<span class=\"w\">  </span><span class=\"n\">rel_antisymm</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">with_unfolding_all</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_antisymm</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">h'</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">csup</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CCPO</span><span class=\"bp\">.</span><span class=\"n\">csup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"n\">csup_spec</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">hc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">with_unfolding_all</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">csup_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">forall_iff_mk</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">chain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">forall_iff_mk</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">hc</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">partial_fixpoint_monotone</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">monotone_lazyCons</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyCons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"bp\">.</span><span class=\"n\">rel</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">lazyCons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">get_mk</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">split</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">refl</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyCons</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">partial_fixpoint</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"c1\">-- 2</span>\n</code></pre></div>",
        "id": 526161730,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751066700
    },
    {
        "content": "<p>This one uses <code>partial_fixpoint</code> for termination checking</p>",
        "id": 526161776,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751066750
    },
    {
        "content": "<p>I'm not familiar with <code>partial_fixpoint</code>. I see <a href=\"https://lean-lang.org/doc/reference/latest//////Definitions/Recursive-Definitions/#partial-fixpoint\">where</a> it is described in the reference, but I still am not quite sure what it means.</p>\n<p>Is there a more detailed explanation elsewhere?</p>",
        "id": 526162524,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751067422
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-eneral/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526161585\">said</a>:</p>\n<blockquote>\n<p>Well if I have to unfold <code>register</code> then that definitely won't work as an approach. The whole idea with the <code>Signal</code> and <code>register</code> functions is to make the <code>Signal</code> definition private and only allow construction with <code>register</code> because only accessing the previous value (like <code>register</code> does) is actually hardware synthesizable.</p>\n</blockquote>\n<p>That's why you need the corecursion!</p>",
        "id": 526162687,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751067577
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526162524\">schrieb</a>:</p>\n<blockquote>\n<p>I'm not familiar with <code>partial_fixpoint</code>. I see <a href=\"https://lean-lang.org/doc/reference/latest//////Definitions/Recursive-Definitions/#partial-fixpoint\">where</a> it is described in the reference, but I still am not quite sure what it means.</p>\n<p>Is there a more detailed explanation elsewhere?</p>\n</blockquote>\n<p><code>partial_fixpoint</code> is a recent addition that allows you to write possibly non-terminating functions that are (usually) tail-recursive. However, with the right theorems, you can extend it to other kinds of \"almost-tail-recursive\" functions: In this case it allows you to insert any amount of <code>lazyCons</code> and treat it as \"almost-tail-recursion\".</p>",
        "id": 526162861,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751067755
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526162687\">said</a>:</p>\n<blockquote>\n<p>That's why you need the corecursion!</p>\n</blockquote>\n<p>I'm not sure if you mean that Lean doesn't support this kind of construct or if you mean that I need to reformulate it somehow. In the latter case I'm don't know what you mean.</p>",
        "id": 526162915,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751067809
    },
    {
        "content": "<p>Having corecursion will allow you to write functions like <code>multiply_add</code> without unfolding <code>register</code></p>",
        "id": 526162952,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751067854
    },
    {
        "content": "<p>and you can prove they terminate</p>",
        "id": 526162957,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751067864
    },
    {
        "content": "<p>What is \"having corecursion\".</p>",
        "id": 526162977,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751067895
    },
    {
        "content": "<p>It means if you define a corecursor, all these things will happen</p>",
        "id": 526163024,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751067937
    },
    {
        "content": "<p>Corecursion is basically tail-recursion with a constructor application</p>",
        "id": 526163049,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751067970
    },
    {
        "content": "<p>though it might loop around to being computationally inefficient again</p>",
        "id": 526163060,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751067978
    },
    {
        "content": "<p>I feel like the approach with <code>partial_fixpoint</code> works really nicely here instead of defining a corecursor though</p>",
        "id": 526163090,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751068019
    },
    {
        "content": "<p>That probably works too, but I haven't tried it yet so I wouldn't know</p>",
        "id": 526163113,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751068051
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526163024\">said</a>:</p>\n<blockquote>\n<p>It means if you define a corecursor, all these things will happen</p>\n</blockquote>\n<p>I have very limited of understanding of corecursion. My fuzzy understanding is that it's what recursion looks like on the other side. I don't know what a corecursor is.</p>",
        "id": 526163165,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751068131
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526163090\">said</a>:</p>\n<blockquote>\n<p>I feel like the approach with <code>partial_fixpoint</code> works really nicely here instead of defining a corecursor though</p>\n</blockquote>\n<p>It's going to take me a bit to understand it.</p>",
        "id": 526163284,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751068306
    },
    {
        "content": "<p>Am I correct that annotating a function <code>f</code> with <code>partial_fixpoint</code> works by making the function partial and adding proof of equality between the opaque <code>f</code> and the original function definition which recursively contains <code>f</code>?</p>",
        "id": 526166582,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751072729
    },
    {
        "content": "<p>Yes, for certain definitions of \"partial\". Also, it doesn't make <code>f</code> an <code>opaque</code>, it only adds the <code>@[irreducible]</code> tag.</p>",
        "id": 526166690,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751072847
    },
    {
        "content": "<p>By makes the function partial I meant <code>partial def</code>.</p>\n<p>What's the difference between <code>opaque</code> and <code>@[irreducible]</code>?</p>\n<p>I see in the reference</p>\n<blockquote>\n<p><em>Opaque constants</em> are defined constants that are not subject to <a href=\"https://lean-lang.org/doc/reference/latest////////The-Type-System/#--tech-term-___-next\">δ-reduction</a> in the kernel.</p>\n</blockquote>\n<p>and </p>\n<blockquote>\n<p>Irreducible definitions are not unfolded at all during elaboration. Definitions can be made irreducible by applying the <code>irreducible</code> attribute.</p>\n</blockquote>\n<p>Which seem to be the same, since</p>\n<blockquote>\n<p>δ (delta) reduction: Replacing occurrences of <a href=\"https://lean-lang.org/doc/reference/latest////////The-Type-System/#--tech-term-defined-constants\">defined constants</a> by the definition's value</p>\n</blockquote>",
        "id": 526166835,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751073071
    },
    {
        "content": "<p>It does not make it <code>partial def</code></p>",
        "id": 526166846,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751073085
    },
    {
        "content": "<p>Irreducible definitions are not unfolded during elaboration (unless you force it), but they are unfolded during kernel checking</p>",
        "id": 526166873,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751073123
    },
    {
        "content": "<p>However <code>opaque</code> constants are not unfolded at all</p>",
        "id": 526166891,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751073141
    },
    {
        "content": "<p>The difference is that irreducible definition are \"please don't unfold me\" but you can still override it while opaque constants just can't be unfolded at all</p>",
        "id": 526166936,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751073210
    },
    {
        "content": "<p>Oh, I see. You prompted me to use <code>#print</code>. Now I see what's going on better. Thank you.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">@[irreducible] def Test.increasing.s : Nat → LazyList Nat :=</span>\n<span class=\"cm\">Lean.Order.fix (fun f n =&gt; LazyList.lazyCons n fun x =&gt; f (n + 1)) increasing.s._proof_6</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">increasing</span><span class=\"bp\">.</span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 526166997,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751073286
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- opaque f : Nat → Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>",
        "id": 526167063,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751073348
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> </p>\n<p>I'm trying to get this to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add_lists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">partial_fixpoint</span>\n</code></pre></div>\n<p>Defining addition on LazyLists to be elementwise:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>\n<p>Showing register was monotone was the same as <code>lazyCons</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"bp\">.</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">lazyCons</span><span class=\"w\"> </span><span class=\"n\">reset</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">partial_fixpoint_monotone</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">monotone_register</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">register</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lazyCons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">get_mk</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">split</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">refl</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>But showing that the addition is monotone has proved challenging. How exactly should I go about using <code>partial_fixpoint</code> on <code>add_lists</code>?</p>\n<h3>What I've tried so far</h3>\n<p>From what I can tell, using <code>partial_fixpoint</code> requires being able to show that the function is monotonic with respect to a <code>partialOrder</code> made by <code>CCPO.toPartialOrder</code>. It can't be any particular partial order, otherwise you could use <code>.rel x y := x = y</code> for everything. (<code>=</code> isn't a CCPO because there's no minimum as required by this provable theorem: <code>CCPO.exists_minimum [inst: CCPO α] : ∃ m, ∀ x, inst.toPartialOrder.rel m x</code>.)</p>\n<p>I have a theorem for <code>monotone hAdd</code> on <code>LazyList</code>s.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">partial_fixpoint_monotone</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">monotone_hadd</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">h_add_le_add</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b'</span><span class=\"o\">:</span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instHAddLazyList</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">hAdd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">.+.</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">get_mk</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h_add_le_add</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hg</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>but this is only with the <code>FlatOrder (Classical.ofNonempty)</code> ordering of <code>α</code> <code>β</code> <code>γ</code> and corresponding <code>LazyList</code>.</p>\n<p>I'd want to show that <code>Nat.add</code> is monotonic to be able to use addition on <code>LazyList</code>s with <code>partial_fixpoint</code>, but <code>Nat.add</code> is doesn't satisfy <code>h_add_le_add</code> with <code>FlatOrder 0</code> (by <code>h_add_le_add (0⊑2) (1⊑1) = 0 + 1 ⊑ 2 + 1</code> implies <code>1 ⊑ 3</code> implies <code>False</code>).</p>\n<p><code>Nat.le</code> does satisfy <code>h_add_le_add</code>, but I can't get the proof of <code>LazyList.monotone_hadd</code> to work with an arbitrary <code>partialOrder</code> for <code>α</code> <code>β</code> <code>γ</code>.</p>\n<p>I also have the above theorem with a more generic <code>CCPO LazyList</code> instance (syntactically identical to using <code>FlatOrder (Classical.ofNonempty)</code>) but it requires the type argument of the <code>LazyList</code> to have a <code>CCPO</code> instance. <code>Nat.le</code> can't have this instance because there's no valid supremum <code>csup</code> for the chain of all natural numbers <code>fun _ =&gt; True</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instCCPOPi</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">rel</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"n\">rel_refl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_refl</span>\n<span class=\"w\">  </span><span class=\"n\">rel_trans</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_trans</span>\n<span class=\"w\">  </span><span class=\"n\">rel_antisymm</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">rel_antisymm</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">h'</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">csup</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CCPO</span><span class=\"bp\">.</span><span class=\"n\">csup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"n\">csup_spec</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">hc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"bp\">.</span><span class=\"n\">csup_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">get_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">forall_iff_mk</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">chain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">forall_iff_mk</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">hc</span>\n<span class=\"o\">}</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">partial_fixpoint_monotone</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">monotone_hadd'</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CCPO</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">h_add_le_add</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b'</span><span class=\"o\">:</span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">⊑</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">monotone</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instHAddLazyList</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">hAdd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">.+.</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">get_mk</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h_add_le_add</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hg</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 526357132,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751275440
    },
    {
        "content": "<p>Try having <code>List (Option Nat)</code>, then you can make addition monotone</p>",
        "id": 526364952,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751278047
    },
    {
        "content": "<p>Alternatively, use an accumulator:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add_lists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">added</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"n\">added</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">added</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">partial_fixpoint</span>\n</code></pre></div>",
        "id": 526365265,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751278155
    },
    {
        "content": "<p>Sorry, what's your definition of <code>LazyList</code>?</p>",
        "id": 526365545,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751278245
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526161730\">schrieb</a>:</p>\n<blockquote>\n<p>Here's another definition similar to the one I defined before, except with a model implementation. There are some hacks though because the compiler gets a bit in the way.<br>\n...</p>\n</blockquote>\n<p>I assume this one?</p>",
        "id": 526378038,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751282764
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526364952\">said</a>:</p>\n<blockquote>\n<p>Try having <code>List (Option Nat)</code>, then you can make addition monotone</p>\n</blockquote>\n<p>Not sure what this means.</p>",
        "id": 526486925,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751317623
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526365265\">said</a>:</p>\n<blockquote>\n<p>Alternatively, use an accumulator:</p>\n</blockquote>\n<p>This typechecks. And continues for the multiply_accumulate example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LazyList</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">accumulated</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"n\">accumulated</span><span class=\"bp\">.</span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">accumulated</span><span class=\"bp\">.</span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">partial_fixpoint</span>\n</code></pre></div>\n<p>but this requires the user having access to the <code>tail</code> and <code>head</code> functions, which means they could apply the <code>tail</code> constructor multiple times and make an hardware unsythensizable design, which I'm trying to avoid. The goal is that in user code <code>LazyList</code> can only be constructed from a constant (<code>fun _ =&gt; c</code>), a use of the register function (<code>register reset next</code>), or as an applicative functor which can only map the <code>LazyList</code> elementwise.</p>\n<p>Am I to assume that you suggest this alternative because <code>+</code> can't be shown <code>monotone</code> in a <code>CCPO</code>?</p>",
        "id": 526487342,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751317833
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526365545\">said</a>:</p>\n<blockquote>\n<p>Sorry, what's your definition of <code>LazyList</code>?</p>\n</blockquote>\n<p>The model that <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>  described earlier.</p>",
        "id": 526487447,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751317901
    },
    {
        "content": "<p>Just asking, how are these lists supposed to be used? In particular how and when are they destructured?</p>",
        "id": 526487777,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751318065
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526487777\">said</a>:</p>\n<blockquote>\n<p>Just asking, how are these lists supposed to be used? In particular how and when are they destructured?</p>\n</blockquote>\n<p>The way this works is that the topmost function takes as input <code>LazyList input</code> and returns <code>LazyList output</code>. The built up list can only be inspected elementwise through the <code>&lt;*&gt;</code>, <code>&lt;$&gt;</code>, and some elementwise arithmetic (<code>+</code>, <code>*</code>, etc...) only.</p>",
        "id": 526488025,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751318189
    },
    {
        "content": "<p>Doesn't that mean that the contents of <code>LazyList</code> are never inspected though?</p>",
        "id": 526488221,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751318290
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526488221\">said</a>:</p>\n<blockquote>\n<p>Doesn't that mean that the contents of <code>LazyList</code> are never inspected though?</p>\n</blockquote>\n<p>In what sense? The goal is to build up an increasingly complicated transition function which can be synthesized to hardware. The values of the list can be observed to make a new list.</p>\n<p>The <code>multiply_accumulate</code> example is one instance of how they are intended to be used.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LazyList</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">partial_fixpoint</span><span class=\"w\"> </span><span class=\"c1\">-- though this doesn't typecheck</span>\n</code></pre></div>\n<p>This could be synthesized in hardware as a multiplication and addition of two input wire buses representing <code>x</code> and <code>y</code> to a state register outputting a wire bus from that register. Another hardware component can use this bus to generate its own output.</p>",
        "id": 526488474,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751318406
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 526488517,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751318427
    },
    {
        "content": "<p>For proving properties about these lists I would imagine a namespace that would make these constructors in scope to enable software only code and proof, similar to how <code>open Classical</code> enables non-constructive logic to be used in proof.</p>",
        "id": 526489139,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751318754
    },
    {
        "content": "<p>Hmm there is some complication involved here because <code>acc := (·+1) &lt;$&gt; acc</code> is clearly unsound but wrapping the right-hand side in <code>register</code> makes it sound again.</p>",
        "id": 526490109,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751319297
    },
    {
        "content": "<p>So there needs to be at least <em>some</em> distinction between these two cases</p>",
        "id": 526490146,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751319316
    },
    {
        "content": "<p>Write a corecursor, like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.corec#doc\">docs#Stream'.corec</a></p>",
        "id": 526490280,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751319397
    },
    {
        "content": "<p>That won't suffice though because we explicitly want to have access to the value we are defining within the right-hand side and apply transformations</p>",
        "id": 526490398,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751319472
    },
    {
        "content": "<p>Corecursors only work for tail-recursive right-hand sides</p>",
        "id": 526490476,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751319526
    },
    {
        "content": "<p>You also need a stream destructor</p>",
        "id": 526490535,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751319550
    },
    {
        "content": "<p>How would that help with the <code>multiply_accumulate</code> example?</p>",
        "id": 526490590,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751319588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526490109\">said</a>:</p>\n<blockquote>\n<p>Hmm there is some complication involved here because <code>acc := (·+1) &lt;$&gt; acc</code> is clearly unsound but wrapping the right-hand side in <code>register</code> makes it sound again.</p>\n</blockquote>\n<p>I just tried this in Clash </p>\n<div class=\"codehilite\" data-code-language=\"Haskell\"><pre><span></span><code><span class=\"nf\">invalid</span><span class=\"w\"> </span><span class=\"ow\">::</span><span class=\"w\"> </span><span class=\"kt\">Signal</span><span class=\"w\"> </span><span class=\"kt\">System</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Unsigned</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">)</span>\n<span class=\"nf\">invalid</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kr\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n</code></pre></div>\n<p>and surprisingly it just synthesized the invalid circuit. The hardware simulator (<a href=\"https://verilator.org/\">verilator</a>) does complain that the logic is circular.</p>\n<div class=\"codehilite\" data-code-language=\"systemverilog\"><pre><span></span><code><span class=\"cm\">/* AUTOMATICALLY GENERATED SYSTEMVERILOG-2005 SOURCE CODE.</span>\n<span class=\"cm\">** GENERATED BY CLASH 1.8.2. DO NOT MODIFY.</span>\n<span class=\"cm\">*/</span>\n<span class=\"no\">`default_nettype</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"no\">`timescale</span><span class=\"w\"> </span><span class=\"mf\">100f</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"mf\">100f</span><span class=\"n\">s</span>\n<span class=\"k\">module</span><span class=\"w\"> </span><span class=\"n\">invalid</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"w\"> </span><span class=\"c1\">// No inputs</span>\n\n<span class=\"w\">      </span><span class=\"c1\">// Outputs</span>\n<span class=\"w\">      </span><span class=\"k\">output</span><span class=\"w\"> </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">15</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">result</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">logic</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">15</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"p\">$</span><span class=\"n\">result_rec</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"p\">$</span><span class=\"n\">result_rec</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"p\">$</span><span class=\"n\">result_rec</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">16'd1</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"k\">assign</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"p\">$</span><span class=\"n\">result_rec</span><span class=\"p\">;</span>\n\n\n<span class=\"k\">endmodule</span>\n</code></pre></div>",
        "id": 526492170,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751320595
    },
    {
        "content": "<p>Running the Haskell code never terminates. So, at least for my initial goal of emulating Clash, it doesn't matter if this case typechecks or not. Though, I would guess it has to be rejected by Lean since it is logically invalid.</p>",
        "id": 526492667,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751320877
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526490280\">said</a>:</p>\n<blockquote>\n<p>Write a corecursor, like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.corec#doc\">docs#Stream'.corec</a></p>\n</blockquote>\n<p>Ah. I didn't know of this. I'll take a look.</p>",
        "id": 526493481,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751321349
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526490280\">said</a>:</p>\n<blockquote>\n<p>Write a corecursor, like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.corec#doc\">docs#Stream'.corec</a></p>\n</blockquote>\n<p>This works fine for the very simple case</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">increasing'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">corec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>but it's not clear to me how this would work when incorporating other state:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HMul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">HMul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hMul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Functor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Applicative</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">pure</span>\n<span class=\"w\">  </span><span class=\"n\">seq</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let f : Stream' (Nat -&gt; Nat -&gt; Nat) := Stream'.corec (id) (fun st =&gt; fun x y =&gt; st + x * y)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fapp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">?_</span>\n</code></pre></div>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526490535\">said</a>:</p>\n<blockquote>\n<p>You also need a stream destructor</p>\n</blockquote>\n<p>I don't know what this is and see no definition of it in <code>Mathlib.Data.Stream</code>.</p>",
        "id": 526505251,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751329564
    },
    {
        "content": "<p>A destructor means something like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.head#doc\">docs#Stream'.head</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.tail#doc\">docs#Stream'.tail</a></p>",
        "id": 526505415,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751329680
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526505415\">said</a>:</p>\n<blockquote>\n<p>A destructor means something like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.head#doc\">docs#Stream'.head</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream%27.tail#doc\">docs#Stream'.tail</a></p>\n</blockquote>\n<p>Ah. As I said earlier, it can't be the case that the user needs to use these functions directly, because then they could call them in hardware unsythesizable ways (calling .tail too many times).</p>\n<p>The <a href=\"https://research.utwente.nl/en/publications/digital-circuit-in-c%CE%BBash-functional-specifications-and-type-direc\">Digital Circuits in CλaSH: Functional Speciications and Type-Directed Synthesis</a> paper provides an even more subtle way to misuse these:</p>\n<div class=\"codehilite\" data-code-language=\"Haskell\"><pre><span></span><code><span class=\"nf\">delayInc</span>\n<span class=\"ow\">::</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"err\">→</span><span class=\"w\"> </span><span class=\"kt\">Signal</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"err\">→</span><span class=\"w\"> </span><span class=\"kt\">Signal</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delayInc</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"kt\">:</span><span class=\"err\">−</span><span class=\"w\"> </span><span class=\"n\">ss</span><span class=\"w\"> </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"ow\">=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"kt\">:</span><span class=\"err\">−</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"kt\">:</span><span class=\"err\">−</span><span class=\"w\"> </span><span class=\"n\">delayInc</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">ss</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/3121/-F_UWiiMj0-Z1Ccb5pDrJP_h/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/-F_UWiiMj0-Z1Ccb5pDrJP_h/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"681x277\" src=\"/user_uploads/thumbnail/3121/-F_UWiiMj0-Z1Ccb5pDrJP_h/image.png/840x560.webp\"></a></div>",
        "id": 526505720,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751329960
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> </p>\n<p>The goal here is to see if it is possible in Lean make a type like <code>Stream</code> where the only way to interact with it with certain \"blessed\" functions. These include <code>cons</code> (also called <code>register</code>), <code>pure</code>, <code>&lt;*&gt;</code>, <code>&lt;$&gt;</code>, but do not include arbitrary manipulation like <code>.tail</code>.</p>\n<p>It certainly seems possible if I allow manipulation to be <code>partial</code> (as evidenced by the original post), but the goal is to make theorems about this type.</p>",
        "id": 526506056,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751330246
    },
    {
        "content": "<p>How do you want to handle termination?</p>",
        "id": 526506120,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330310
    },
    {
        "content": "<p>I'm assuming you want to allow recursive definitions</p>",
        "id": 526506151,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330332
    },
    {
        "content": "<p>In what sense? I've written how I'd want this to work above, am I explaining something poorly?</p>",
        "id": 526506278,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751330385
    },
    {
        "content": "<p>For now I'll recommend the corecursor (although this is purely from the theorem proving side, I don't know how they perform in execution)</p>",
        "id": 526506461,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330510
    },
    {
        "content": "<p>The software simulation side of this terminates by only running the eventual function with something akin to Stream.take, which is only accessible in the special namespace I described here.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526489139\">said</a>:</p>\n<blockquote>\n<p>For proving properties about these lists I would imagine a namespace that would make these constructors in scope to enable software only code and proof, similar to how <code>open Classical</code> enables non-constructive logic to be used in proof.</p>\n</blockquote>",
        "id": 526506464,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751330511
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526506461\">said</a>:</p>\n<blockquote>\n<p>For now I'll recommend the corecursor (although this is purely from the theorem proving side, I don't know how they perform in execution)</p>\n</blockquote>\n<p>Ok, how would you write the multiply accumulate function using only <code>Stream.corec</code> but not <code>.head</code>, <code>.tail</code> or <code>Stream.get</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let f : Stream' (Nat -&gt; Nat -&gt; Nat) := Stream'.corec (id) (fun st =&gt; fun x y =&gt; st + x * y)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fapp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;*&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">?_</span>\n</code></pre></div>",
        "id": 526506655,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751330687
    },
    {
        "content": "<p>What do you want this function to do?</p>",
        "id": 526506767,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330781
    },
    {
        "content": "<p>oh I see</p>",
        "id": 526506799,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330812
    },
    {
        "content": "<p>You also probably want a stream fold function</p>",
        "id": 526506815,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751330825
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526506767\">said</a>:</p>\n<blockquote>\n<p>What do you want this function to do?</p>\n</blockquote>\n<p>this without the <code>partial</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reset</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">reset</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate''''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 526506894,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751330904
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526506815\">said</a>:</p>\n<blockquote>\n<p>You also probably want a stream fold function</p>\n</blockquote>\n<p>Ok... What's that? Something like this? <br>\n<code>def Stream'.fold (s: Stream' α) (f: α → β → α) (init: α): Stream' β → α</code></p>",
        "id": 526507110,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751331107
    },
    {
        "content": "<p>I guess what I really mean was a stream scan function</p>",
        "id": 526507161,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751331148
    },
    {
        "content": "<p>Fold doesn't really work with infinite streams</p>",
        "id": 526507178,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751331165
    },
    {
        "content": "<p>If you could write the type-signature or link to what you mean that would be helpful.</p>",
        "id": 526507210,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751331204
    },
    {
        "content": "<p>I feel like your choice to omit <code>head</code> and <code>tail</code> is leading to a lot of pain</p>",
        "id": 526507467,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751331427
    },
    {
        "content": "<p>It's not really a choice. It's a requirement for this to work to describe hardware. The alternative I already know will work is representing hardware as <code>input -&gt; StateM (output, state)</code>instead. The problem with that approach is that state is explicit and must be threaded by the user on composition.</p>",
        "id": 526507732,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751331682
    },
    {
        "content": "<p>If you allow <code>head</code> and <code>tail</code> then you get <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526505720\">this</a></p>",
        "id": 526507824,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751331757
    },
    {
        "content": "<p>What do you mean <code>StateM (output, state)</code>? I feel like this could be a good solution</p>",
        "id": 526508049,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751331952
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526508049\">said</a>:</p>\n<blockquote>\n<p>What do you mean <code>StateM (output, state)</code>? I feel like this could be a good solution</p>\n</blockquote>\n<p>Literally that. Represent coinduction as a function with explicit state input and output.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">res</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">res</span>\n</code></pre></div>\n<p>The reason I was interested in finding an alternative is that it's harder to make temporal guarantees when the user can just decide not to call the transition function.<br>\nIf the state was inaccessible you could write a delay function that guaranteed output after n transitions.</p>\n<p>If state is explicit like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delay1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">next</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delayN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">α</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">StateM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">res</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">shiftRight</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">res</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">out</span>\n</code></pre></div>\n<p>then you can't stop the user from just ... not calling the transition function.</p>",
        "id": 526508777,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332503
    },
    {
        "content": "<p>What do you mean \"transition function\"</p>",
        "id": 526508880,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332589
    },
    {
        "content": "<p>Finite state machine has a transition function.</p>",
        "id": 526508894,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332610
    },
    {
        "content": "<p>What part of the code corresponds to the transition function?</p>",
        "id": 526508927,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332635
    },
    {
        "content": "<p><code>delayN</code> is a transition function for a finite state machine which delays the input <code>n</code> transitions of <code>delayN</code>.</p>",
        "id": 526508949,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332658
    },
    {
        "content": "<p>There's a different transition function for every finite state machine.</p>",
        "id": 526508958,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332671
    },
    {
        "content": "<p>So your problem is that the user can decide to not use your code?</p>",
        "id": 526509004,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332712
    },
    {
        "content": "<p>Something in the future I'd want to try is representing a <code>Signal n</code> type which represents values in time, with a guarantee that the value is useful after a delay of <code>n</code>. This comes up in hardware a lot because of <a href=\"https://en.wikipedia.org/wiki/Instruction_pipelining\">pipelining</a>. For example a multiplication circuit might be output the result of the inputs after 3 transition delay.</p>",
        "id": 526509155,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332829
    },
    {
        "content": "<p>hmm</p>",
        "id": 526509181,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332846
    },
    {
        "content": "<p>my immediate reaction is \"build a monad\"</p>",
        "id": 526509209,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332863
    },
    {
        "content": "<p>but I guess it depends on what you mean by \"time\" and \"delay\"</p>",
        "id": 526509256,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332917
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526509209\">said</a>:</p>\n<blockquote>\n<p>my immediate reaction is \"build a monad\"</p>\n</blockquote>\n<p>Where? <code>StateM</code> <em>is</em> a monad. <code>Signal</code> <em>can't</em> be a monad. It has to be an <code>Applicative Functor</code>.</p>",
        "id": 526509281,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332936
    },
    {
        "content": "<p>ok, build an applicative functor then</p>",
        "id": 526509315,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526509315\">said</a>:</p>\n<blockquote>\n<p>ok, build an applicative functor then</p>\n</blockquote>\n<p>That's what this thread is. The problem with making it work without <code>partial</code> annotations.</p>",
        "id": 526509337,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751332981
    },
    {
        "content": "<p>what specifically is not working</p>",
        "id": 526509355,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751332999
    },
    {
        "content": "<blockquote>\n<p>without <code>partial</code> annotations.</p>\n</blockquote>",
        "id": 526509372,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751333016
    },
    {
        "content": "<p>explain what you did, what happened, and what you want to happen</p>",
        "id": 526509373,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333017
    },
    {
        "content": "<p>For your <code>multiply_accumulate</code> function, I have a solution</p>",
        "id": 526509478,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333091
    },
    {
        "content": "<p>Do you see the first post I made in this subject/thread? That's what I did. Then <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> helped make it non-partial using <code>partial_fixpoint</code> but this didn't work for the more complicated <code>multiply_accumulate</code>.</p>\n<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> Didn't answer, but I think the implication was that <code>+</code> can't be proven <code>monotone</code>.</p>",
        "id": 526509568,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751333173
    },
    {
        "content": "<p>sorry if I'm not being helpful right now I just want to understand your problem</p>",
        "id": 526509601,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333215
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526509478\">said</a>:</p>\n<blockquote>\n<p>For your <code>multiply_accumulate</code> function, I have a solution</p>\n</blockquote>\n<p>I'm interested.</p>",
        "id": 526509684,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751333266
    },
    {
        "content": "<p>I think it works it you have a <code>Stream'.comul</code> like this (are you still using <code>Stream'</code>?):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">comul</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 526510067,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333570
    },
    {
        "content": "<p>but I haven't tested it thouroughly</p>",
        "id": 526510077,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333578
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526509601\">said</a>:</p>\n<blockquote>\n<p>sorry if I'm not being helpful right now I just want to understand your problem</p>\n</blockquote>\n<p>There's something like 4 levels of difficulty to this business of representing changing values in time while hiding state.<br>\nFirst is a constant value. That's easy.<br>\nSecond is a value which changes only dependent on itself. That's what I got stuck on but seems to be solved with <code>partial_fixpoint</code> (I have proofs on the output of <code>increasing</code> that work).<br>\nThird, is a time-varying value dependent on other values. That's like <code>multiply_accumulate</code>.<br>\nFourth, is a function with multiple time-varying values which each depend on multiple other time-varying values. This would be something like a full processor.</p>",
        "id": 526510227,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751333685
    },
    {
        "content": "<p>interesting</p>",
        "id": 526510259,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333708
    },
    {
        "content": "<p>How does it work in real life? Maybe you can derive some inspiration.</p>",
        "id": 526510293,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751333731
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526510067\">said</a>:</p>\n<blockquote>\n<p>I think it works it you have a <code>Stream'.comul</code> like this (are you still using <code>Stream'</code>?):</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">comul</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I don't know how this should be used. It looks like equivalent to <code>fun s =&gt; s :: Stream'.tails s</code> but I don't see how that's helpful.</p>",
        "id": 526510728,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751334014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526510293\">said</a>:</p>\n<blockquote>\n<p>How does it work in real life? Maybe you can derive some inspiration.</p>\n</blockquote>\n<p>In case it wasn't clear, Clash already does this. It's <a href=\"https://hackage-content.haskell.org/package/clash-prelude-1.8.2/docs/Clash-Explicit-Signal.html#t:Signal\">Signal</a> type is what I'm trying to emulate. The problem is that (after translating Haskell lazyness to strict Lean as in the original post) Lean's termination checker is sad.</p>",
        "id": 526511011,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751334163
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"932169\">Easyoakland</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20termination.20of.20recursion.20guarded.20in.20abstraction/near/526507210\">said</a>:</p>\n<blockquote>\n<p>If you could write the type-signature or link to what you mean that would be helpful.</p>\n</blockquote>\n<p><code>Stream'.scanl {α β : Type*} (s : Stream' α) (f : β → α → β) (init : β) : Stream' β</code><br>\nI just realized this is a special case of<br>\n<code>Stream'.mapM {α β : Type*} {m : Type _ → Type _} [Monad m] (s : Stream' α) (f : α → m β) : m (Stream' β)</code></p>",
        "id": 526511110,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751334240
    },
    {
        "content": "<p>actually it looks like <code>Stream'.mapM</code> isn't implementable ignore what I said</p>",
        "id": 526512240,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751335153
    },
    {
        "content": "<p>This? If yes, I'll go back to my pending question: how would  you use this to implement <code>multiply_accumulate</code> without <code>partial def</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">scanl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">prev</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 526512358,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751335232
    },
    {
        "content": "<p><em>finally</em></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">scanl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 526512600,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751335438
    },
    {
        "content": "<p>I'll have to think about it. That might work. Kind of annoying we can't write regular equations.</p>\n<p>I think <code>scanl</code> can be implemented with an input bus for the first argument, a register for the current scan state which starts with the value of the third argument to scanl, and a combinatorial circuit for the second argument which takes the value of the state register and the input bus then writes the result to the state register.</p>",
        "id": 526513090,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751335870
    },
    {
        "content": "<p>For reference this is a tail-recursive version of scanl:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"bp\">.</span><span class=\"n\">scanl''</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Stream'</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">    </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">init</span>\n</code></pre></div>\n<p>and it looks like this is going to have the same issue with quadratic runtime as the stream at <code>n</code> requires calculating the input stream at each value <code>&lt;n</code>.</p>",
        "id": 526514469,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751337381
    },
    {
        "content": "<p>Yup. This is unusably slow.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">multiply_accumulate'''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"mi\">100</span>\n</code></pre></div>",
        "id": 526514812,
        "sender_full_name": "Easyoakland",
        "timestamp": 1751337739
    }
]