[
    {
        "content": "<p>This looks like a new change in 4.29.0-rc1, and its behavior puzzles me... for example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- set_option backward.isDefEq.respectTransparency false -- uncomment this to remove error below</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">--error</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sub_nonneg</span><span class=\"w\"> </span><span class=\"c1\">-- ok</span>\n</code></pre></div>\n<p>What is going on here?</p>",
        "id": 574421640,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771383181
    },
    {
        "content": "<p>Can you minimize this example? FRO prefers to have bug reports that don't use <code>Mathlib</code>.</p>",
        "id": 574422309,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771383734
    },
    {
        "content": "<p>Hmm not sure where to start... I think I'll need to extract the class hierarchy for <code>AddGroup</code> minimize there?</p>",
        "id": 574422942,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771384233
    },
    {
        "content": "<p>A quick note, adding an explicit type parameter makes it work again</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)]</span>\n</code></pre></div>",
        "id": 574423591,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771384821
    },
    {
        "content": "<p>or even just one regular parameter also works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span>\n</code></pre></div>",
        "id": 574423656,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771384882
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> Here is a Mathlib-less example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">--set_option backward.isDefEq.respectTransparency false</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sub_nonneg'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n</code></pre></div>\n<p>I suspect it is the part where <code>Add M</code> appeared twice in the hierarchy that caused the problem. I extracted this structure from mathlib</p>",
        "id": 574424519,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771385648
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> WDYT?</p>",
        "id": 574425695,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771386785
    },
    {
        "content": "<p>Note that when using the <code>set_option</code>, the unification is solved because unification finds a stuck metavariable that it then decides to synthesize a value of:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">stuckMVar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">stuck</span><span class=\"w\"> </span><span class=\"n\">MVar</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">inst</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>And if you don't use the <code>set_option</code>, this doesn't happen.</p>",
        "id": 574465075,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771407743
    },
    {
        "content": "<p>Aha, I figured out a solution. If you write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">allowUnsafeReducibility</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instance_reducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n</code></pre></div>\n<p>in your example, then it works.</p>",
        "id": 574466142,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771408089
    },
    {
        "content": "<p>What I don't understand here is why <code>Zero.zero</code> is not already <code>instance_reducible</code>. The point of <code>instance_reducible</code> transparency is so that instances and instance projections can be unfolded during instance unification (and this was the case before the new Lean version).</p>",
        "id": 574467449,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771408474
    },
    {
        "content": "<p>There are other failures under the same change that we cna collect here like <a href=\"#narrow/channel/287929-mathlib4/topic/fail.20to.20synth.20an.20easy.20instance/with/574495259\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/fail.20to.20synth.20an.20easy.20instance/with/574495259</a></p>\n<p>I also saw some different flavor of errors in my project. When I get time I can minimize them as well</p>",
        "id": 574516012,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771423505
    },
    {
        "content": "<p>I think there will be an announcement soon from the mathlib maintainers about this (there's been some discussion ongoing in the mathlib reviewers channel). I'm not a maintainer, but let me say that (a) the maintainers and the Lean core team are working urgently on this, and (b) your minimized example is very greatly appreciated by all involved.</p>",
        "id": 574524272,
        "sender_full_name": "David Loeffler",
        "timestamp": 1771425627
    },
    {
        "content": "<p>Here's another mathlib-free failure adapted from my <a href=\"https://arxiv.org/abs/2306.00617\">\"Multiple-inheritance hazards in dependently-typed algebraic hierarchies\" paper</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">add_monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">add_comm_monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">add_monoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">add_comm_monoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">toadd_comm_monoid</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">add_group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">add_monoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">add_comm_group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">add_group</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm_monoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">add_comm_group</span><span class=\"bp\">.</span><span class=\"n\">toadd_comm_monoid</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm_group</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ring</span><span class=\"bp\">.</span><span class=\"n\">toadd_comm_group</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm_monoid</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"o\">(</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">to_module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">semiring</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">neg_smul</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm_group</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">iR</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">neg_smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- ok</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">iR</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">add_group</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">neg_smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 574527135,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771426341
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/574527135\">said</a>:</p>\n<blockquote>\n<p>Here's another mathlib-free failure adapted from my <a href=\"https://arxiv.org/abs/2306.00617\">\"Multiple-inheritance hazards in dependently-typed algebraic hierarchies\" paper</a>:</p>\n</blockquote>\n<p>Is this \"another example of the same failure\", or \"a different failure mode\"? (Or is it hard to tell?)</p>",
        "id": 574528418,
        "sender_full_name": "David Loeffler",
        "timestamp": 1771426614
    },
    {
        "content": "<p>I haven't had a chance to look in any detail, but my guess is that this is the same failure mode (failure to handle commuting typeclass diamonds, not structure eta)</p>",
        "id": 574530413,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771427053
    },
    {
        "content": "<p>(the adaptations above are just to switch to the new <code>set_option</code> and remove things that no longer fail)</p>",
        "id": 574531159,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771427226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/574524272\">said</a>:</p>\n<blockquote>\n<p>I think there will be an announcement soon from the mathlib maintainers about this</p>\n</blockquote>\n<p>To this end, I would recommend not immediately resolving any non-trivial merge conflicts created by these new <code>set_option</code>s, just in case we end up making a decision in a day or so that renders this unecessary.</p>",
        "id": 574539277,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771429206
    },
    {
        "content": "<p>I think I understand a bit better now what is going on in <span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span>'s example.</p>\n<p>The unification algorithm decides whether to try to synthesize an instance metavariable by calling the function <code>getStuckMVar?</code>. This function searches for an instance metavariable in an expression by recursing into arguments of projection instances. In this case it is being called on <code>Zero.zero</code>, which contains a metavariable of type <code>AddMonoid' Int</code>. We want it to synthesize this metavariable with type class search, so that the unification can then succeed.</p>\n<p>The reason why this worked originally is that unification would unfold <code>Zero.zero</code> into the projection <code>.1</code>, and the call <code>getStuckMVar?</code> on that. Since <code>getStuckMVar?</code> does recurse into all projections, it does find the metavariable that we want it to find. But now, since <code>Zero.zero</code> isn't unfolded, <code>getStuckMVar?</code> doesn't find the required metavariable.</p>",
        "id": 574554331,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771432786
    },
    {
        "content": "<p>Just to be clear, this is a bug, right? Should we hold off on updating our projects until it's resolved?</p>",
        "id": 574598913,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1771447050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hern√°ndez</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/574598913\">said</a>:</p>\n<blockquote>\n<p>Just to be clear, this is a bug, right?</p>\n</blockquote>\n<p>Yes, there is a tentative fix at <a href=\"https://github.com/leanprover/lean4/pull/12564\">lean#12564</a></p>",
        "id": 574606348,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1771449831
    },
    {
        "content": "<p>I also have a local \"fix\" which makes <code>getStuckMVar?</code> more correct (such that it can recurse more effectively and report things that actually block reduction) and also removes quite a few <code>set_option backward.isDefEq.respectTransparency false in</code>s but there's unfortunately many mathlib adaptations necessary (I'm not done lol). One of the common adaptations is what I've dubbed \"CoeT explosion\". Here's an example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">inv_strictAntiOn</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p><code>inv_strictAntiOn</code> receives as a first parameter <code>?a ‚àà Set.Ioi 0</code> and we provide <code>0 &lt; a</code>. You might think here: Well it does the reduction and the unifies <code>?a := a</code> and everything is fine but no! You can see two defeq failures!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>turns out it reduces too much on the <code>Real</code> side and then doesn't know what to do with the <code>&lt;</code> from the <code>Set.Ioi</code> anymore because it's too generic. Now you might ask yourself: Why does it work then? Well, \"CoeT explosion\" it is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">CoeT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">CoeT</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">LT</span><span class=\"bp\">.</span><span class=\"n\">lt</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Ioi</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[</span><span class=\"n\">stuckMVar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">stuck</span><span class=\"w\"> </span><span class=\"n\">MVar</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">11</span>\n</code></pre></div>\n<p><code>CoeT</code> fails because of a <code>stuckMVar</code> (which we don't find with my patch) and thus the term elaboration gets <em>delayed</em> in a similar way to <code>by exact</code>. Thus, many fixes involved adding smileys or <code>by exact</code>s to influence elaboration order.</p>",
        "id": 574607411,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1771450221
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hern√°ndez</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/574598913\">said</a>:</p>\n<blockquote>\n<p>Just to be clear, this is a bug, right? Should we hold off on updating our projects until it's resolved?</p>\n</blockquote>\n<p>See the <a href=\"#narrow/channel/113486-announce/topic/releases.20of.20new.20Lean.20versions/near/574617729\">announcement</a> post about v4.29.0-rc1.</p>",
        "id": 574631395,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771463088
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/574539277\">said</a>:</p>\n<blockquote>\n<p>To this end, I would recommend not immediately resolving any non-trivial merge conflicts created by these new <code>set_option</code>s, just in case we end up making a decision in a day or so that renders this unecessary.</p>\n</blockquote>\n<p>Is this still the situation? </p>\n<p>I have several PR's that have dropped off the review queue because they picked up conflicts with the <code>isDefEq</code> workarounds. I'm wondering how long I should wait before merging latest master into them.</p>",
        "id": 575107557,
        "sender_full_name": "David Loeffler",
        "timestamp": 1771700709
    },
    {
        "content": "<p>I'm hoping to have an <code>rc2</code> out later today, but I wouldn't expect any changes to <code>respectTransparency</code> on Mathlib master until at least tomorrow.</p>",
        "id": 575199144,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771800599
    },
    {
        "content": "<p>(And there will still be <em>many</em> even after the rc2, so I would advise getting on with life and doing the merge conflict resolutions!)</p>",
        "id": 575199201,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771800631
    },
    {
        "content": "<p>Do you agree with my claim that more than half of these are issues with the feature itself, rather than mathlib abusing type aliases?</p>",
        "id": 575200366,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771801453
    },
    {
        "content": "<p>(I would expect us to get in a lot of justified trouble in Category theory, but all the algebra-related stuff seems like it is not to blame)</p>",
        "id": 575200397,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771801497
    },
    {
        "content": "<p>Okay, we are on <code>rc2</code> now. Looking forward to seeing <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>'s of remaining problems Mathlib is having.</p>",
        "id": 575511640,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771930606
    },
    {
        "content": "<p>Everyone is invited to continue investigating removing <code>set_option backward</code>s, and helping to construct concrete examples, without Mathlib imports, where it looks like further changes are required.</p>",
        "id": 575511883,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771930689
    },
    {
        "content": "<p>(I am running a script to see which <code>set_option backward</code>s can be removed without any changes, but I suspect that I got most of these already in the intervening nightly testings.)</p>",
        "id": 575512031,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771930735
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575200366\">said</a>:</p>\n<blockquote>\n<p>Do you agree with my claim that more than half of these are issues with the feature itself, rather than mathlib abusing type aliases?</p>\n</blockquote>\n<p>I'm not sure what \"half of these\" is referring to.</p>",
        "id": 575512425,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771930839
    },
    {
        "content": "<p>In particular, both Weiyi's and Eric's examples above work fine on <code>rc2</code>.</p>",
        "id": 575512886,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771930969
    },
    {
        "content": "<p>This lemma in mathlib doesn't depend on anything else in mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">ofFn_get</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofFn_succ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">congr</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ofFn_get</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>\n<p>It fails unless the <code>respectTransparency</code> option is false, and it fails even if the implicit argument <code>(f := (a :: l).get)</code> is provided to <code>ofFn_succ</code>.</p>",
        "id": 575547619,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771941436
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`rewrite</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">occurrence</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span>\n<span class=\"w\">  </span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>",
        "id": 575548083,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771941549
    },
    {
        "content": "<p>where the top <code>ofFn (a :: l).get</code> has type (upon hovering)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n</code></pre></div>\n<p>and the bottom one has type </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n</code></pre></div>",
        "id": 575548352,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771941611
    },
    {
        "content": "<p>I feel like this is intentional? After all, <code>(a :: l).length</code> doesn't obviously look like <code>_ + 1</code> so using this lemma there is technically defeq abuse; I guess that's one place where <code>backward.isDefEq.respectTransparency</code> actually makes sense to use.</p>",
        "id": 575553770,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1771942719
    },
    {
        "content": "<p>But we are trying to remove <code>respectTransparency</code>. The two terms are definitionally equal, so something must be done with <code>rw</code></p>",
        "id": 575554082,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771942798
    },
    {
        "content": "<p>If this is the intended new behavior, how would one fix the type mismatch in the expression? (A genuine question because I want to learn more technical skills in Lean)</p>",
        "id": 575554567,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771942897
    },
    {
        "content": "<p><code>simp only [length_cons]</code> fixes that (the whole goal is solved by <code>simp</code>, but that's not the point here I guess).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">ofFn_get</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">length_cons</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofFn_succ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">congr</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ofFn_get</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>",
        "id": 575555842,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771943183
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575554082\">said</a>:</p>\n<blockquote>\n<p>But we are trying to remove <code>respectTransparency</code>. The two terms are definitionally equal, so something must be done with <code>rw</code></p>\n</blockquote>\n<p><code>rw</code> operates at reducible transparency and <code>(a :: l).length</code> is not reducibly def-eq to <code>l.length + 1</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rfl` failed: The left-hand side</span>\n<span class=\"sd\">  (a :: l).length</span>\n<span class=\"sd\">is not definitionally equal to the right-hand side</span>\n<span class=\"sd\">  l.length + 1</span>\n\n<span class=\"sd\">Œ± : Type u</span>\n<span class=\"sd\">l : List Œ±</span>\n<span class=\"sd\">a : Œ±</span>\n<span class=\"sd\">‚ä¢ (a :: l).length = l.length + 1</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 575556435,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771943327
    },
    {
        "content": "<p>Ah, my mind overcomplicated it because I did not realize it was a mismatch in an implicit parameter. I thought it was a mismatch in a deeper type or something. Thanks!</p>",
        "id": 575556438,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771943328
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575556435\">said</a>:</p>\n<blockquote>\n<p><code>rw</code> operates at reducible transparency and <code>(a :: l).length</code> is not reducibly def-eq to <code>l.length + 1</code>:</p>\n</blockquote>\n<p>So what should be the course of action taken with <code>List.ofFn_get</code> and <code>respectTransparency</code>?</p>",
        "id": 575560536,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771944209
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">ofFn_get</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ofFn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>Or the old proof but <code>by simp</code> in the second branch of the pattern match.</p>",
        "id": 575562136,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771944535
    },
    {
        "content": "<p>From a cursory playaround most of the cases of <code>rw</code> failing when <code>respectTransparency</code> is removed come from mismatching instances. For example, in <code>powersetCard_empty_subsingleton</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">powersetCard_empty_subsingleton</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">powersetCard</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Subsingleton</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">mx</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">my</span>\n<span class=\"w\">  </span><span class=\"n\">simp_all</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">mem_coe</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mem_powersetCard</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">mx</span><span class=\"w\"> </span><span class=\"n\">my</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Subsingleton</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">mem_coe</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>We have the error message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`rewrite</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">occurrence</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">20</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">20</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">instMembership</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">powersetCard</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">23</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">22</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">powersetCard</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>How are we to fix these mismatching instances?</p>",
        "id": 575565028,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771945120
    },
    {
        "content": "<p>(The original proof is <code>simp [Set.Subsingleton, subset_empty]</code>)</p>",
        "id": 575565417,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771945195
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35718\">#35718</a> removes eight instances of the option. If you can remove some more, please add them as reviews to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35718\">#35718</a></p>",
        "id": 575566870,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771945498
    },
    {
        "content": "<p>If the instance mismatches indicate that our instance hierarchy is a mess, I don't know how we're going to fix that mess</p>",
        "id": 575568066,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771945760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575512425\">said</a>:</p>\n<blockquote>\n<p>I'm not sure what \"half of these\" is referring to.</p>\n</blockquote>\n<p>\"these\" referred to <code>backward.isDefEq.respectTransparency false</code> lines.</p>",
        "id": 575577199,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771947833
    },
    {
        "content": "<p>Reduced from <a href=\"https://github.com/leanprover-community/mathlib4/blob/0c08ce96d5d3380690ac7ca205fe21c06e049e3e/Mathlib/Algebra/AddConstMap/Basic.lean#L292\">https://github.com/leanprover-community/mathlib4/blob/0c08ce96d5d3380690ac7ca205fe21c06e049e3e/Mathlib/Algebra/AddConstMap/Basic.lean#L292</a></p>\n<p><a href=\"https://live.lean-lang.org/#codez=CYUwZgBA8gTqMBECuBDANhAFIRuAIC4IAVATwAcQIB9ASnyLIsvwF4AoCCbV1gYzRQDOAiAFliAQWDAsAcTolyVWgHcAFiBgh2EALbFKKKXTmAkwginz3AJYA7AQBcUNnhQDeuAgsYBfCAG1VOjFJaWwAXSCJI0xYeGR0Tlo8ZghVbgA3FBgrFAAjNApMOU8GJX9goxkw7hAADxQdUgK6TFswDQBJO0dnEHFhTArpGWpaFNabdpguhycXfqwhrFiNeIwR0ZYIXOJtZSt7VUpNYCQeK3yQAxtgSltZ3uEYMAwIAFo36ABpGvrG5oIEymMx68wGSw2ADo9AYjOM2p1unM+uCotIYnBVqh1qNqND9IZpMltrsOPtDscQKdzpdrrd7qCQE8XhwPhAAKIwGAAexgRBQPHsVh4EAABs80KKIGAUFYCsA8NxWEA\">https://live.lean-lang.org/#codez=CYUwZgBA8gTqMBECuBDANhAFIRuAIC4IAVATwAcQIB9ASnyLIsvwF4AoCCbV1gYzRQDOAiAFliAQWDAsAcTolyVWgHcAFiBgh2EALbFKKKXTmAkwginz3AJYA7AQBcUNnhQDeuAgsYBfCAG1VOjFJaWwAXSCJI0xYeGR0Tlo8ZghVbgA3FBgrFAAjNApMOU8GJX9goxkw7hAADxQdUgK6TFswDQBJO0dnEHFhTArpGWpaFNabdpguhycXfqwhrFiNeIwR0ZYIXOJtZSt7VUpNYCQeK3yQAxtgSltZ3uEYMAwIAFo36ABpGvrG5oIEymMx68wGSw2ADo9AYjOM2p1unM+uCotIYnBVqh1qNqND9IZpMltrsOPtDscQKdzpdrrd7qCQE8XhwPhAAKIwGAAexgRBQPHsVh4EAABs80KKIGAUFYCsA8NxWEA</a></p>",
        "id": 575633309,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771964258
    },
    {
        "content": "<p><a href=\"https://live.lean-lang.org/#codez=CYUwZgBA8gTqMBECuBDANhAFIRuAIC4IAVATwAcQIB9ASnyLIsvwF4AoCCbV1gYzRQDOAiAFliAQWDAsAcTolyVWgHcAFiBgh2EFFLpzASYQRDx7n0HCRAewB2VgJbTMcggsa0QADwAuIG8EsJPTk1DS0OAC8NK30zfiEISWAASRsAN1l5BiUIL19/QKTjCFDNbXt0/QgjGTiLYxgrJFJZV2yaXJ8/ANFbB2kZABpEqVSM2tYKgW8UGx4KAG9cNsVKAF8IAG1VfUbmzgBdXaaWzFh4ZHROWjxmCFVuNJQYexQAIzQKZyzV2k2ZPYtGQHbheFAAW1InzomAqYA0qWms3m4mEzkBxmo1AAdN4rNY7I4IHdYTZ4TBETM5iBUbIMWc4BpLhgZFicXiCf0WBA3sRtMp7N5VJRNMAkDx7B8QJRZsBKFMqfNhDAwBgIABadXQADSoM8EKhFAIpPJlORNLRAJOmPZViSY2JWDhCJsSOptPR1oZF1QLLZuLto0qtx5fI4AqFIpAYolUpl/nlrsVIGVqo4mogAFEYI0YEQUDxvPYeBAAAYqtCliBgFD2T7APDcVhAA\">https://live.lean-lang.org/#codez=CYUwZgBA8gTqMBECuBDANhAFIRuAIC4IAVATwAcQIB9ASnyLIsvwF4AoCCbV1gYzRQDOAiAFliAQWDAsAcTolyVWgHcAFiBgh2EFFLpzASYQRDx7n0HCRAewB2VgJbTMcggsa0QADwAuIG8EsJPTk1DS0OAC8NK30zfiEISWAASRsAN1l5BiUIL19/QKTjCFDNbXt0/QgjGTiLYxgrJFJZV2yaXJ8/ANFbB2kZABpEqVSM2tYKgW8UGx4KAG9cNsVKAF8IAG1VfUbmzgBdXaaWzFh4ZHROWjxmCFVuNJQYexQAIzQKZyzV2k2ZPYtGQHbheFAAW1InzomAqYA0qWms3m4mEzkBxmo1AAdN4rNY7I4IHdYTZ4TBETM5iBUbIMWc4BpLhgZFicXiCf0WBA3sRtMp7N5VJRNMAkDx7B8QJRZsBKFMqfNhDAwBgIABadXQADSoM8EKhFAIpPJlORNLRAJOmPZViSY2JWDhCJsSOptPR1oZF1QLLZuLto0qtx5fI4AqFIpAYolUpl/nlrsVIGVqo4mogAFEYI0YEQUDxvPYeBAAAYqtCliBgFD2T7APDcVhAA</a>  is slightly closer to the original</p>",
        "id": 575634905,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771964823
    },
    {
        "content": "<p>If you use <a href=\"https://github.com/leanprover-community/mathlib/wiki/Code-in-backticks\">#backticks</a> those links are generated automatically</p>",
        "id": 575637335,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771965667
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"869628\">Matthew Jasper</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575633309\">schrieb</a>:</p>\n<blockquote>\n<p>Reduced from <a href=\"https://github.com/leanprover-community/mathlib4/blob/0c08ce96d5d3380690ac7ca205fe21c06e049e3e/Mathlib/Algebra/AddConstMap/Basic.lean#L292\">https://github.com/leanprover-community/mathlib4/blob/0c08ce96d5d3380690ac7ca205fe21c06e049e3e/Mathlib/Algebra/AddConstMap/Basic.lean#L292</a></p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">my_add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- OK</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">my_add</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">my_add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- Error Tactic `rfl` failed:</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- OK</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toAddInv</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toAddInv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- Error Tactic `rfl` failed:</span>\n</code></pre></div>\n<p>(you can click the button in the top-right of the code blocks to go directly to live lean)</p>",
        "id": 575638773,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1771966212
    },
    {
        "content": "<p>Those statements look type incorrect to me</p>",
        "id": 575641660,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771967270
    },
    {
        "content": "<p>This is closer to what's in Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MyAdd</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"n\">G</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- OK</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddInv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">OrderDual</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toAddInv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- Error Tactic `rfl` failed:</span>\n</code></pre></div>",
        "id": 575643809,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771968082
    },
    {
        "content": "<p>I think that this can be fixed on the instance side</p>",
        "id": 575643869,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771968114
    },
    {
        "content": "<p>Yes, those instances are indeed slightly illegal, and it's fair game for Lean to tell us not to do what we do there</p>",
        "id": 575644055,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771968188
    },
    {
        "content": "<p>On latest mathlib, with <code>backward.isDefEq.respectTransparency true</code> the following fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">compHom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">compHom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>I am proposing a fix in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35739\">#35739</a>. Is this correct behaviour of the new mechanism and is this fix what we should be doing?</p>",
        "id": 575654541,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771972580
    },
    {
        "content": "<p><del>I think probably <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SMul.comp#doc\">docs#SMul.comp</a> should be marked instance_reducible</del> oh, it's already reducible?</p>",
        "id": 575658848,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771974814
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.compHom#doc\">docs#Algebra.compHom</a> should probably also switch from being an <code>abbrev</code> to <code>@[instance_reducible] def</code>, though this makes it less reducible not more reducible so would only help performance</p>",
        "id": 575658893,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771974846
    },
    {
        "content": "<p>So <code>__ := SMul.comp A f</code> does not work, but <code>__ := Module.compHom A f</code> works, I believe. Let's wait for CI to confirm it.</p>",
        "id": 575660202,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771975637
    },
    {
        "content": "<p>I'd like to test my projects against 4.29 rc2, but it looks like mathlib has not tagged a release yet. Should I expect that soon, or I need to rebuild mathlib on my own?</p>",
        "id": 575660400,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771975743
    },
    {
        "content": "<p>Actually I am not exactly sure why the cache didn't work... my lake-manifest shows mathlib is on the latest commit 2d6247196524215d9beb18820e09d6bd5537bf8e, which should have built with rc2 tool chain <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/lean-toolchain#L1\">https://github.com/leanprover-community/mathlib4/blob/master/lean-toolchain#L1</a>. And obviously I have updated my toolchain to rc2 as well</p>",
        "id": 575660627,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771975885
    },
    {
        "content": "<p>Is it expected that <code>rw</code> might now need more help inferring parameters? For example:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/Mathlib/Algebra/BigOperators/Group/Finset/Basic.lean b/Mathlib/Algebra/BigOperators/Group/Finset/Basic.lean</span>\n<span class=\"gh\">index ebc85333c27..7f1ffd32a6e 100644</span>\n<span class=\"gd\">--- a/Mathlib/Algebra/BigOperators/Group/Finset/Basic.lean</span>\n<span class=\"gi\">+++ b/Mathlib/Algebra/BigOperators/Group/Finset/Basic.lean</span>\n<span class=\"gu\">@@ -487,13 +487,12 @@ theorem prod_extend_by_one [DecidableEq Œπ] (s : Finset Œπ) (f : Œπ ‚Üí M) :</span>\n<span class=\"w\"> </span>    ‚àè i ‚àà s, (if i ‚àà s then f i else 1) = ‚àè i ‚àà s, f i :=\n<span class=\"w\"> </span>  (prod_congr rfl) fun _i hi =&gt; if_pos hi\n\n<span class=\"gd\">-set_option backward.isDefEq.respectTransparency false in</span>\n<span class=\"w\"> </span>/-- Also see `Finset.prod_ite_mem_eq` -/\n<span class=\"w\"> </span>@[to_additive /-- Also see `Finset.sum_ite_mem_eq` -/]\n<span class=\"w\"> </span>theorem prod_eq_prod_extend (f : s ‚Üí M) : ‚àè x, f x = ‚àè x ‚àà s, Subtype.val.extend f 1 x := by\n<span class=\"w\"> </span>  rw [univ_eq_attach, ‚Üê Finset.prod_attach s]\n<span class=\"w\"> </span>  congr with ‚ü®x, hx‚ü©\n<span class=\"gd\">-  rw [Subtype.val_injective.extend_apply]</span>\n<span class=\"gi\">+  rw [Subtype.val_injective.extend_apply f 1 ‚ü®x, hx‚ü©]</span>\n\n<span class=\"w\"> </span>@[to_additive]\n<span class=\"w\"> </span>theorem prod_bij_ne_one {s : Finset Œπ} {t : Finset Œ∫} {f : Œπ ‚Üí M} {g : Œ∫ ‚Üí M}\n</code></pre></div>",
        "id": 575667530,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771979996
    },
    {
        "content": "<p>I have got some more examples of breakage. This one I believe already existed in rc1 and isn't fixed in rc2. I am currently just posting \"reasonable use of Mathlib that breaks in my opinion\", and haven't minimized it without mathlib yet. I can help minimize after collecting all the examples</p>\n<p><strong>1. <del><code>SetLike.mem_coe</code> / <code>Multiset.mem_toFinset</code> / <code>Polynomial.mem_roots'</code> doesn't trigger in simp</del> <code>Multiset.mem_toFinset</code> simp_rw doesn't work (sometimes)</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Multiset</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">''</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toFinset</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÉ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">mem_image</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">mem_coe</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">mem_toFinset</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Multiset</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toFinset</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">mem_toFinset</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- this is fine</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 575669201,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771981231
    },
    {
        "content": "<p>hmm hold on, my original example of sub_nonneg is still broken?</p>\n<p><strong>2. Mathlib's <code>sub_nonneg</code> is still not very usable</strong><br>\nThis one is still not working</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- set_option backward.isDefEq.respectTransparency false -- uncomment this to remove error below</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">--error</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sub_nonneg</span><span class=\"w\"> </span><span class=\"c1\">-- ok</span>\n</code></pre></div>\n<p>But my previous mathlib-free example does start working, so something in between is still broken...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">--set_option backward.isDefEq.respectTransparency false</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddZero'</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sub_nonneg'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddMonoid'</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- This one works now</span>\n</code></pre></div>",
        "id": 575670266,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771981572
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_nonneg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"c1\">-- ok</span>\n</code></pre></div>",
        "id": 575671840,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771981881
    },
    {
        "content": "<p><strong>3. Submodule is not <code>Free</code></strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"c1\">-- It should go through this instance, but still error</span>\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_divisionRing</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>",
        "id": 575671856,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771981884
    },
    {
        "content": "<p><strong>4. Something about submodule used as a module is broken</strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚àô</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚ä§</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"cm\">  @Eq ‚Ñï (Module.finrank ?m.28 ‚Ü•p) 1</span>\n<span class=\"cm\">  in the target expression</span>\n<span class=\"cm\">  @Eq ‚Ñï (Module.finrank ‚Ñù ‚Ü•p) 1</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">finrank_eq_one_iff_of_nonzero</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚àô</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚ä§</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  failed to synthesize instance of type class</span>\n<span class=\"cm\">  Module ‚Ñù ‚Ü•p</span>\n<span class=\"cm\">  Even though I have just synthesized above</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">finrank_eq_one_iff_of_nonzero</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚àô</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚ä§</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">finrank_eq_one_iff_of_nonzero</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"c1\">-- This one is fine</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n</code></pre></div>",
        "id": 575674830,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771982845
    },
    {
        "content": "<p><strong>5. fail to rewrite with <code>Set.disjoint_singleton_right</code></strong></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"cm\">  @Disjoint (Set ?m.11) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot ?m.12</span>\n<span class=\"cm\">    {?m.13}</span>\n<span class=\"cm\">in the target expression</span>\n<span class=\"cm\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"cm\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n<span class=\"cm\">-/</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"cm\">  @Disjoint (Set ‚Ñï) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot s {a}</span>\n<span class=\"cm\">in the target expression</span>\n<span class=\"cm\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"cm\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n<span class=\"cm\">-/</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n</code></pre></div>",
        "id": 575675824,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771983466
    },
    {
        "content": "<p>These are all breakage in one of my project. Meanwhile rc1-&gt;rc2 did fix 4 breakage, so still a great progress!</p>\n<p>I have another project with even more problem, but that was written in my early days and is full of defeq abuse, so probably less valuable to investigate. Let me try working on minimizing these 5 examples instead</p>",
        "id": 575676140,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771983637
    },
    {
        "content": "<p>(I am editing my post above with more minimized examples)</p>",
        "id": 575677006,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771984116
    },
    {
        "content": "<p>1 might be that <code>SetLike.instMembership</code> and <code>Finset.instMembership</code> are not reducible def-eq</p>",
        "id": 575677460,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1771984400
    },
    {
        "content": "<p>5 reproduces with just <code>import Mathlib.Order.CompleteLattice.Defs</code></p>",
        "id": 575677463,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771984404
    },
    {
        "content": "<p>Updated 1. with a more focused example. Indeed something about <code>Multiset.mem_toFinset</code> doesn't work well</p>",
        "id": 575677887,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771984742
    },
    {
        "content": "<p>5 looks most likely to be a lean issue to me</p>",
        "id": 575677938,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771984775
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575577199\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575512425\">said</a>:</p>\n<blockquote>\n<p>I'm not sure what \"half of these\" is referring to.</p>\n</blockquote>\n<p>\"these\" referred to <code>backward.isDefEq.respectTransparency false</code> lines.</p>\n</blockquote>\n<p>Obviously...? Which \"half\"?</p>",
        "id": 575682293,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771987890
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575566870\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35718\">#35718</a> removes eight instances of the option. If you can remove some more, please add them as reviews to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35718\">#35718</a></p>\n</blockquote>\n<p>No need to add things, let's just have many PRs.</p>",
        "id": 575682330,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771987908
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575660400\">said</a>:</p>\n<blockquote>\n<p>I'd like to test my projects against 4.29 rc2, but it looks like mathlib has not tagged a release yet. Should I expect that soon, or I need to rebuild mathlib on my own?</p>\n</blockquote>\n<p>The tag is in place now.</p>\n<p><span class=\"user-mention\" data-user-id=\"873350\">@Weiyi Wang</span>, while I'm very pleased you're trying out <code>v4.29.0-rc2</code> in your projects, since you've already given us some great feedback, I do just want to point out to any interested bystanders that the current general advice remains the same: downstream projects should delay bumping their Mathlib dependency to <code>v4.29.0-rcK</code>, unless they are consciously signing up to help resolve this defeq issues! :-)</p>",
        "id": 575682719,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771988149
    },
    {
        "content": "<p>Yes, how do we solve these defeq issues?</p>",
        "id": 575682830,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771988222
    },
    {
        "content": "<p>The more you suffix your messages with :-) the <em>less</em> people will be willing to help, IMO</p>",
        "id": 575682893,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771988263
    },
    {
        "content": "<p>It would be great to get a minimization of 5. above and the sub_nonneg issue. So far I think these are the most likely to indicate underlying problems in lean4, while most of the rest above look like defeq abuse at a quick look.</p>",
        "id": 575682964,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771988315
    },
    {
        "content": "<p>I think 4 might be symptomatic of a place where Lean is behaving correctly but there is no easy solution without redesigning the SetLike machinery, but I'd be hesitant to investigate it before solving 5</p>",
        "id": 575683118,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771988408
    },
    {
        "content": "<p>I meant \"more than half of the additions of backwards compatibility flag set_options were the fault of Lean itself\"</p>",
        "id": 575683312,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771988493
    },
    {
        "content": "<p>Yes, but that's rather unhelpful without pointing to which half you mean. :-)</p>",
        "id": 575683425,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771988538
    },
    {
        "content": "<p>Which of my changes in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35718\">#35718</a> are good to go for now?</p>",
        "id": 575683610,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1771988629
    },
    {
        "content": "<p>re: 5, it's super useful if examples like this can be written as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ?m.11) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot ?m.12</span>\n<span class=\"sd\">    {?m.13}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot s {a}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n</code></pre></div>\n<p>(This is the \"advanced\" section of <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>. The idea that we always use <code>#guard_msgs</code> to capture messages, and just repeat statements with and without options rather than having comments instructing the reader to do something. It's essential that examples are machine checkable so we can use <a href=\"https://github.com/kim-em/lean-minimizer\"><code>lean-minimizer</code></a> to reduce them.)</p>",
        "id": 575683613,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771988630
    },
    {
        "content": "<p>Oops, I forgot my own instructions: and further one should use <code>set_option pp.mvars.anonymous true</code> to make those #guard_msgs stable!</p>",
        "id": 575684038,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771988865
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ?_) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot ?_ {?_}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot s {a}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) ChainCompletePartialOrder.instOfCompleteLattice.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n</code></pre></div>",
        "id": 575684246,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771989001
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575683425\">said</a>:</p>\n<blockquote>\n<p>Yes, but that's rather unhelpful without pointing to which half you mean. :-)</p>\n</blockquote>\n<p>My claim is \"of the X set_options we added, I expect an unspecified &gt;0.5x to become no-ops once the Lean issues in this thread are fixed\", with the intended meaning  \"resolving conflicts will become twice as easy if you wait\" and possibly \"these local options are causing more harm in churn than benefit\", though it's difficult for me to factor in the hidden cost of testing changes Lean if they were entirely removed on master, which I'm sure you have a clearer picture of</p>",
        "id": 575684418,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771989094
    },
    {
        "content": "<p>I could also see a strategy along the lines of \"keep a random 5% of files with the new behavior enabled until we track down all the low hanging fruit\", which would minimize the interference with open and new PRs, while still letting you track what breaks against the latest mathliv</p>",
        "id": 575684654,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771989237
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873350\">@Weiyi Wang</span>'s example 5 allows reducing the imports to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">BooleanAlgebra</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">OmegaCompletePartialOrder</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ?_) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot ?_ {?_}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) CompleteLattice.instOmegaCompletePartialOrder.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) Set.instDistribLattice.toSemilatticeInf.toPartialOrder Set.instBoundedOrder.toOrderBot s {a}</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  @Disjoint (Set ‚Ñï) CompleteLattice.instOmegaCompletePartialOrder.toPartialOrder</span>\n<span class=\"sd\">    CompleteBooleanAlgebra.toCompleteDistribLattice.toHeytingAlgebra.toOrderBot s {a}</span>\n\n<span class=\"sd\">s : Set ‚Ñï</span>\n<span class=\"sd\">a : ‚Ñï</span>\n<span class=\"sd\">ha : a ‚àâ s</span>\n<span class=\"sd\">‚ä¢ Disjoint s {a}</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n</code></pre></div>",
        "id": 575685517,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771989887
    },
    {
        "content": "<p>(note the error messages are slightly different, but I think this is same issue)</p>",
        "id": 575685551,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771989904
    },
    {
        "content": "<p>Reducing the imports anywhere below </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">BooleanAlgebra</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">OmegaCompletePartialOrder</span>\n</code></pre></div>\n<p>causes the problem to go away.</p>",
        "id": 575685617,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771989942
    },
    {
        "content": "<p>The difference at the <code>rw</code> is that with <code>respectTransparency false</code> we get </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">oint</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteLattice</span><span class=\"bp\">.</span><span class=\"n\">instOmegaCompletePartialOrder</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toSemilatticeInf</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toBoundedOrder</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toLE</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instLE</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instBotForall</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>while with <code>respectTransparency true</code> we get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteLattice</span><span class=\"bp\">.</span><span class=\"n\">instOmegaCompletePartialOrder</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toSemilatticeInf</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">CompleteBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toCompleteDistribLattice</span><span class=\"bp\">.</span><span class=\"n\">toBoundedOrder</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBoundedOrder</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toLE</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instLE</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instHeytingAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">instBotForall</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                            </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">                          </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">                          </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ä•</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">          </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">          </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toBot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instBooleanAlgebra</span><span class=\"bp\">.</span><span class=\"n\">toBot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚àÖ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 575687003,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991024
    },
    {
        "content": "<p>Does it mean that <code>Set</code> should become a <code>structure</code>?</p>",
        "id": 575687423,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771991385
    },
    {
        "content": "<p>I think it means:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"n\">set_hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span>\n</code></pre></div>",
        "id": 575687635,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991567
    },
    {
        "content": "<p>this at least solves the problem locally.</p>",
        "id": 575687646,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991574
    },
    {
        "content": "<p>But that is just a first guess, we need to explore a bit here.</p>",
        "id": 575687670,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991588
    },
    {
        "content": "<p>(and there may still need to be a lean fix here)</p>",
        "id": 575687686,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991602
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575687423\">said</a>:</p>\n<blockquote>\n<p>Does it mean that <code>Set</code> should become a <code>structure</code>?</p>\n</blockquote>\n<p>But replacing \"it\" with \"type hygiene\", I think I might agree with your statement! :-)</p>",
        "id": 575687738,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991654
    },
    {
        "content": "<p>I think this indicates we should pull the lattice structure through setOf?</p>",
        "id": 575687827,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771991741
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">allowUnsafeReducibility</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">implicit_reducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Set</span>\n</code></pre></div>\n<p>also solves the problem here.</p>",
        "id": 575687843,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991751
    },
    {
        "content": "<p>My provisional apologies for declaring this one as probably Lean's fault</p>",
        "id": 575687889,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771991800
    },
    {
        "content": "<p>Just for clarity, I am at this point satisfied that this issue is on the Mathlib side, and will hope that someone here can try out adding <code>setOf</code> in the right places?</p>",
        "id": 575687920,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991826
    },
    {
        "content": "<p>I am going to assume that this issue will come up again and again, and try to write a tactic combinator that runs something under <code>trace.Meta.isDefEq</code>, with and without <code>respectTransparency</code>, and gives a useful diff.</p>",
        "id": 575687994,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991908
    },
    {
        "content": "<p>(I think this is more effective use of my time than the actual Mathlib fixes for now.)</p>",
        "id": 575688016,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771991926
    },
    {
        "content": "<p>3 and 4 look like the same kind of the problem. For some reason, <code>Module</code> instance provided by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Submodule.module#doc\">docs#Submodule.module</a> is not found<br>\nFor example, if I do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c1\">--set_option backward.isDefEq.respectTransparency false in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_divisionRing</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>\n<p>This gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span>\n</code></pre></div>\n<p>But with old behavior, it is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">answer</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">module</span>\n</code></pre></div>",
        "id": 575690982,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771994200
    },
    {
        "content": "<p>On the line <code>[tryResolve] ‚ùåÔ∏è Module ‚Ñù ‚Ü•l ‚âü Module ?m.13 ‚Ü•?m.18</code>, <br>\nthe full type on the left is <code>@Module ‚Ñù (‚Ü•l) DivisionRing.toDivisionSemiring.toSemiring l.addCommGroup.toAddCommMonoid</code><br>\nthe full type on the right is <code>@Module ?m.13 ‚Ü•?m.19 ?m.20 (Submodule.addCommMonoid ?m.19) : Type (max ?u.1820 ?u.1822)</code></p>",
        "id": 575691161,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771994389
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">BooleanAlgebra</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">OmegaCompletePartialOrder</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">CheckDefEqAbuse</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">warning: check_defeq_abuse: tactic fails with `backward.isDefEq.respectTransparency true` but succeeds with `false`.</span>\n<span class=\"sd\">The following isDefEq checks are the root causes of the failure:</span>\n<span class=\"sd\">  ‚ùåÔ∏è (i : ‚Ñï) ‚Üí (fun a =&gt; Prop) i =?= Set ‚Ñï</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚àâ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Disjoint</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">check_defeq_abuse</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">disjoint_singleton_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n\n<span class=\"sd\">/-- info: check_defeq_abuse: tactic succeeds with `backward.isDefEq.respectTransparency true`. No abuse detected. -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">check_defeq_abuse</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 575691316,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771994546
    },
    {
        "content": "<p>I'll make a PR shortly!</p>",
        "id": 575691333,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771994568
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a></p>",
        "id": 575691451,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771994686
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575691161\">said</a>:</p>\n<blockquote>\n<p>On the line <code>[tryResolve] ‚ùåÔ∏è Module ‚Ñù ‚Ü•l ‚âü Module ?m.13 ‚Ü•?m.18</code>, <br>\nthe full type on the left is <code>@Module ‚Ñù (‚Ü•l) DivisionRing.toDivisionSemiring.toSemiring l.addCommGroup.toAddCommMonoid</code><br>\nthe full type on the right is <code>@Module ?m.13 ‚Ü•?m.19 ?m.20 (Submodule.addCommMonoid ?m.19) : Type (max ?u.1820 ?u.1822)</code></p>\n</blockquote>\n<p>In comparison, the full type for the happy case is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span>\n<span class=\"n\">left</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"bp\">.</span><span class=\"n\">toDivisionSemiring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span>\n<span class=\"n\">right</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommMonoid</span>\n</code></pre></div>\n<p>So I guess Semiring parameter and/or the AddCommMonoid are considered defeq abuse?</p>",
        "id": 575693446,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771996134
    },
    {
        "content": "<p>Well, somewhere in there there is some <code>def</code> being using that needs an <code>@[implicit_reducible]</code> attribute.</p>",
        "id": 575693560,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771996254
    },
    {
        "content": "<p>Do you mean <code>@[instance_reducible]</code>?</p>",
        "id": 575693610,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771996290
    },
    {
        "content": "<p>Oh, sorry, it has been renamed in <code>rc2</code>, although <code>instance_reducible</code> is still available as a synonym (not yet deprecated, oops).</p>",
        "id": 575693953,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771996635
    },
    {
        "content": "<p>Thanks, I've missed that.</p>",
        "id": 575694020,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771996700
    },
    {
        "content": "<p>BTW, could you please have a look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/35286\">#35286</a>? I've moved stuff that changes more than defeq abuse to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35351\">#35351</a></p>",
        "id": 575694106,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771996795
    },
    {
        "content": "<p>Borsed <a href=\"https://github.com/leanprover-community/mathlib4/pull/35351\">#35351</a></p>",
        "id": 575694295,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1771997005
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35286\">#35286</a> looks good to me</p>",
        "id": 575694301,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1771997011
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575691451\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a></p>\n</blockquote>\n<p>I'm adding some more features, including a command mode that helps with <code>instance</code> and <code>variables</code> problems. But I have to stop for this evening, so I'll mark the PR as draft until I get back to it.</p>",
        "id": 575694475,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771997198
    },
    {
        "content": "<p>In the meantime, in would be <em>incredibly</em> useful to have Mathlib free minimizations of the Set/Lattice problem, and the Module problem, so that we can leave these in place as test cases for <code>#check_defeq_abuse</code> even once the current underlying problems are solved.</p>",
        "id": 575694543,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771997247
    },
    {
        "content": "<p>(I am slowly learning reading the trace...)<br>\nThe defeq failure of 3./4. happens at the AddCommGroup / AddCommMonoid part<br>\n(<code>l : Submodule ‚Ñù V</code> in the following)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span>\n<span class=\"w\">                      </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                        </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddSemigroup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddMemClass</span><span class=\"bp\">.</span><span class=\"n\">toAddSemigroup</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toZero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZeroMemClass</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"o\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">zero_add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nsmul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nsmul_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">nsmul_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                              </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddSemigroup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddMemClass</span><span class=\"bp\">.</span><span class=\"n\">toAddSemigroup</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">toZero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ZeroMemClass</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zero_add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">nsmul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nsmul_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nsmul_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                  </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span>\n<span class=\"w\">                        </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                          </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">                  </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">addCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span>\n<span class=\"w\">                        </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                          </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoidClass</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ãØ</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 575694600,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771997309
    },
    {
        "content": "<p>It looks like also a SetLike behavior difference after all?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"o\">:</span>\n<span class=\"w\">                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">V</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span>\n<span class=\"w\">                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span>\n<span class=\"w\">                                    </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span>\n<span class=\"w\">                                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">happy</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"o\">:</span>\n<span class=\"w\">                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Ü•</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">V</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Mem</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">AddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">instSetLike</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">AddSubmonoid</span><span class=\"bp\">.</span><span class=\"n\">instSetLike</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubsemigroup</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubgroup</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toAddSubmonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                                            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">                                                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 575695419,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1771997960
    },
    {
        "content": "<p>I've created a branch with <code>structure Set</code>, then cherry-picked some of fixes to uncovered defeq abuses to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35752\">#35752</a> UPD: I'm fixing compile errors</p>",
        "id": 575701177,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772001964
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35752\">#35752</a> builds locally</p>",
        "id": 575706246,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772004872
    },
    {
        "content": "<p>The <code>Module</code> failures above are correctly detected by <code>#defeq_abuse</code>, which says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">warning: #defeq_abuse: command fails with `backward.isDefEq.respectTransparency true` but succeeds with `false`.</span>\n<span class=\"cm\">The following synthesis applications fail due to transparency:</span>\n<span class=\"cm\">  ‚ùåÔ∏è apply @Submodule.module to Module ‚Ñù ‚Ü•_fvar.1076</span>\n<span class=\"cm\">    ‚ùåÔ∏è l.toAddSubgroup =?= l.1</span>\n<span class=\"cm\">    ‚ùåÔ∏è l.toAddSubgroup =?= l.toAddSubmonoid</span>\n<span class=\"cm\">    ‚ùåÔ∏è l.toAddSubgroup.1 =?= l.1</span>\n<span class=\"cm\">    ‚ùåÔ∏è ‚Üël.toAddSubgroup =?= ‚Üël.toAddSubmonoid</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">defeq_abuse</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_divisionRing</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">l</span>\n</code></pre></div>\n<p>and indeed putting <code>@[implicit_reducible]</code> on <code>Submodule.toAddSubgroup</code> resolves the problem.</p>",
        "id": 575748939,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772018047
    },
    {
        "content": "<p>Is there some way we can identify quickly all of these \"pseudo parents\" in mathlib, and put <code>@[implicit_reducible]</code> on them all?</p>",
        "id": 575749069,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772018078
    },
    {
        "content": "<p>I guess we want a metaprogram that finds all <code>def toX : &lt;a class&gt;</code>?</p>",
        "id": 575749881,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772018323
    },
    {
        "content": "<p>Somewhat reduced version of 2.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Unbundled</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: `simp` made no progress</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  0 = ?a</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  0 = a ‚Üî a = a + a</span>\n\n<span class=\"sd\">a : ‚Ñ§</span>\n<span class=\"sd\">‚ä¢ 0 = a ‚Üî a = a + a</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: typeclass instance problem is stuck</span>\n<span class=\"sd\">  AddGroup ?_</span>\n\n<span class=\"sd\">Note: Lean will not try to resolve this typeclass instance problem because the type argument to `AddGroup` is a metavariable. This argument must be fully determined before Lean will try to resolve the typeclass.</span>\n\n<span class=\"sd\">Hint: Adding type annotations and supplying implicit arguments to functions can give Lean more information for typeclass resolution. For example, if you have a variable `x` that you intend to be a `Nat`, but Lean reports it as having an unresolved type like `?m`, replacing `x` with `(x : Nat)` can get typeclass resolution un-stuck.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 575750829,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1772018649
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575748939\">said</a>:</p>\n<blockquote>\n<p>indeed putting <code>@[implicit_reducible]</code> on <code>Submodule.toAddSubgroup</code> resolves the problem.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a>.</p>\n<p>I'm also running <code>scripts/rm_set_option.py</code> on that PR, and it is deleting many <code>set_option backward</code> from across Mathlib. (About 100 removed so far.)</p>",
        "id": 575755697,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772020309
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575694543\">said</a>:</p>\n<blockquote>\n<p>In the meantime, in would be <em>incredibly</em> useful to have Mathlib free minimizations of the Set/Lattice problem, and the Module problem, so that we can leave these in place as test cases for <code>#check_defeq_abuse</code> even once the current underlying problems are solved.</p>\n</blockquote>\n<p>Claude and I have found Mathlib free minimization of these two problems, and installed them as test cases in th <code>#defeq_abuse</code> tactic, at <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a>.</p>\n<p>This tactic seems <em>really</em> useful, and is a lovely example of Claude writing a metaprogram! It understood perfectly how to simultaneously read a <code>Meta.isDefEq</code> and <code>Meta.synthInstance</code> trace log, and reports the failing isDefEq checks immediately prior to the first divergence between the synthInstance traces with/without <code>respectTransparency</code>. This would have been a nightmare to do by hand, particularly because the logs are not very well structured objects, and we find ourselves string matching on emojis to find our way through them.</p>",
        "id": 575762258,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772022706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"869628\">Matthew Jasper</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575750829\">said</a>:</p>\n<blockquote>\n<p>Somewhat reduced version of 2.</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Unbundled</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Int</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: `simp` made no progress</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  0 = ?a</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  0 = a ‚Üî a = a + a</span>\n\n<span class=\"sd\">a : ‚Ñ§</span>\n<span class=\"sd\">‚ä¢ 0 = a ‚Üî a = a + a</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: typeclass instance problem is stuck</span>\n<span class=\"sd\">  AddGroup ?_</span>\n\n<span class=\"sd\">Note: Lean will not try to resolve this typeclass instance problem because the type argument to `AddGroup` is a metavariable. This argument must be fully determined before Lean will try to resolve the typeclass.</span>\n\n<span class=\"sd\">Hint: Adding type annotations and supplying implicit arguments to functions can give Lean more information for typeclass resolution. For example, if you have a variable `x` that you intend to be a `Nat`, but Lean reports it as having an unresolved type like `?m`, replacing `x` with `(x : Nat)` can get typeclass resolution un-stuck.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Thanks Jasper, this example is a good one. I'm not sure what the fix is yet! It comes down to a defeq failure between <code>0</code> from <code>Zero.zero</code> and <code>0</code> from <code>Int.oftNat</code>.</p>",
        "id": 575764374,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772023453
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575749881\">said</a>:</p>\n<blockquote>\n<p>I guess we want a metaprogram that finds all <code>def toX : &lt;a class&gt;</code>?</p>\n</blockquote>\n<p><a href=\"https://gist.github.com/kim-em/8f01bafd5e19c0d45c9e878a4c1deae5\">https://gist.github.com/kim-em/8f01bafd5e19c0d45c9e878a4c1deae5</a></p>\n<p>Spot checking, to me these all look like they need <code>@[implicit_reducible]</code>. But I haven't checked them all.</p>\n<p>It's probably simplest to do this check as a PR...?</p>",
        "id": 575765458,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772023890
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35765\">#35765</a></p>",
        "id": 575770091,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772025182
    },
    {
        "content": "<p>I'll have CI check that doesn't break anything, then measure how many <code>set_option backward</code> we can remove.</p>",
        "id": 575770237,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772025227
    },
    {
        "content": "<p>I wonder if it makes sense to add a new transparency setting specifically for instance synthesis. It seems to me like <code>implicit_reducible</code> is not really suited for instance synthesis. For example, do we really want to allow <code>Nat.add a b =?= a + b</code> during instance synthesis? While unifying implicit arguments? Sure. But when unifying instance types? I don't really think so. I'd argue that instance synthesis should really use something that can do a bit more than  <code>reducible</code> but maybe not unfold all instances (especially not those that involve defeq abuse). That would also allow being a bit more aggressive with <code>@[implicit_reducible]</code>, tagging <code>Matrix</code>, <code>OrderDual</code>, <code>Set</code>, <code>setOf</code>, etc. as <code>@[implicit_reducible]</code> without fearing that instances will be mixed up between them. In particular, we'd ideally ensure that all instances typecheck under <code>@[implicit_reducible]</code> (modulo proofs).</p>",
        "id": 575771084,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772025446
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575755697\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575748939\">said</a>:</p>\n<blockquote>\n<p>indeed putting <code>@[implicit_reducible]</code> on <code>Submodule.toAddSubgroup</code> resolves the problem.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a>.</p>\n<p>I'm also running <code>scripts/rm_set_option.py</code> on that PR, and it is deleting many <code>set_option backward</code> from across Mathlib. (About 100 removed so far.)</p>\n</blockquote>\n<p>This removes over 600 of the <code>set_option backward</code>, so I think we can say this is a good change! The run isn't quite finished, so I'll commit it tomorrow with the remainder.</p>",
        "id": 575776043,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772026718
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575762258\">said</a>:</p>\n<blockquote>\n<p>This tactic seems <em>really</em> useful, and is a lovely example of Claude writing a metaprogram! It understood perfectly how to simultaneously read a <code>Meta.isDefEq</code> and <code>Meta.synthInstance</code> trace log, and reports the failing isDefEq checks immediately prior to the first divergence between the synthInstance traces with/without <code>respectTransparency</code>. This would have been a nightmare to do by hand, particularly because the logs are not very well structured objects, and we find ourselves string matching on emojis to find our way through them.</p>\n</blockquote>\n<p>This sounds like one more great example of AI‚ÄØenshittification: instead of working on fixing the actual issue of logs not being very well structured, you avoid the issue and push technical debt down the road.</p>",
        "id": 575789953,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1772030338
    },
    {
        "content": "<p>I disagree with the assertion that the log is not well structured. I was learning to read it for the first time last night and was able to grasp the idea of it quickly. The real problem that blocked my initial investigation was 1. didn't know the option to turn on trace log (documentation issue) 2. had to manually compare the before/after log (which the new script is resolving)</p>",
        "id": 575791285,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1772030674
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"869628\">Matthew Jasper</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575750829\">said</a>:</p>\n<blockquote>\n<p>Somewhat reduced version of 2.</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- cut</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>With all of the dependencies removed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Zo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Zo</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">  </span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Sm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Zo</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sm</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Zo</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Zo</span><span class=\"bp\">.</span><span class=\"n\">zo</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">zo_eq_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Gr</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"bp\">.</span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: typeclass instance problem is stuck</span>\n<span class=\"sd\">  Gr ?m.10</span>\n\n<span class=\"sd\">Note: Lean will not try to resolve this typeclass instance problem because the type argument to `Gr` is a metavariable. This argument must be fully determined before Lean will try to resolve the typeclass.</span>\n\n<span class=\"sd\">Hint: Adding type annotations and supplying implicit arguments to functions can give Lean more information for typeclass resolution. For example, if you have a variable `x` that you intend to be a `Nat`, but Lean reports it as having an unresolved type like `?m`, replacing `x` with `(x : Nat)` can get typeclass resolution un-stuck.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"bp\">.</span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">zo_eq_iff</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Tactic `rewrite` failed: Did not find an occurrence of the pattern</span>\n<span class=\"sd\">  Num.fromNat 0 = ?a</span>\n<span class=\"sd\">in the target expression</span>\n<span class=\"sd\">  Num.fromNat 0 = a ‚Üî a = Gr.add a a</span>\n\n<span class=\"sd\">a : Int</span>\n<span class=\"sd\">‚ä¢ Num.fromNat 0 = a ‚Üî a = Gr.add a a</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"bp\">.</span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zo_eq_iff</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"bp\">.</span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">zo_eq_iff</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Num</span><span class=\"bp\">.</span><span class=\"n\">fromNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Gr</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zo_eq_iff</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 575807716,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1772034793
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575791285\">ha dicho</a>:</p>\n<blockquote>\n<p>I disagree with the assertion that the log is not well structured. I was learning to read it for the first time last night and was able to grasp the idea of it quickly. The real problem that blocked my initial investigation was 1. didn't know the option to turn on trace log (documentation issue) 2. had to manually compare the before/after log (which the new script is resolving)</p>\n</blockquote>\n<p>Maybe the correct claim is that the log is well-structured for humans but badly structured for our meta code?</p>",
        "id": 575861668,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1772050454
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hern√°ndez</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575861668\">said</a>:</p>\n<blockquote>\n<p>Maybe the correct claim is that the log is well-structured for humans but badly structured for our meta code?</p>\n</blockquote>\n<p>Yes, though I feel like this was clear from the context of discussing a tactic.</p>",
        "id": 575863260,
        "sender_full_name": "Chris Henson",
        "timestamp": 1772050988
    },
    {
        "content": "<p>Maybe it is because of my background, I didn't consider \"structured log for machine\" as a practical thing (I had this impression way before AI entered the picture) as I deal with unstructured log for job everyday</p>",
        "id": 575864824,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1772051500
    },
    {
        "content": "<p>The logic behind that is \"you have log because you expect the unexpected. If you somehow can make it structured to capture all information, then it is expected information and it shouldn't be log in the first place\"</p>",
        "id": 575865346,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1772051690
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35780\">#35780</a> is ready for review (drop <code>Membership</code> on <code>Finset</code>).</p>",
        "id": 575875948,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772055441
    },
    {
        "content": "<p>Should Membership.mem instead be made instance_reducible?</p>",
        "id": 575877348,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772056011
    },
    {
        "content": "<p>Why? Other <code>SetLike</code> types don't have <code>Membership</code> instances</p>",
        "id": 575879314,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772056813
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575789953\">said</a>:</p>\n<blockquote>\n<p>This sounds like one more great example of AI‚ÄØenshittification: instead of working on fixing the actual issue of logs not being very well structured, you avoid the issue and push technical debt down the road.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>, you are inappropriately jumping to conclusions here. Of course this discovery --- that it's hard to programmatically process these logs --- has bumped the priority of better trace logs, and I'm already thinking about it. That will of course take much longer to get right than a diagnostic script to help fix urgently problems in Mathlib, and it would be stupid to <em>wait</em> on better structured trace logs to get <code>#defeq_abuse</code> into users' hands.</p>",
        "id": 575885660,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772059202
    },
    {
        "content": "<blockquote>\n<p>chore: mark¬†<code>Submodule.toAddSubgroup</code>¬†<code>@[implicit_reducible]</code> <a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a></p>\n</blockquote>\n<p>Is ready to go. It removes ~700 occasions where we currently need <code>set_option backward.isDefEq.respectTransparency</code>. It then --- mysteriously --- requires three of these <em>added</em> in the test cases. But I think this is an improvement, and we'll of course investigate those additions later.</p>",
        "id": 575897929,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772064274
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575765458\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575749881\">said</a>:</p>\n<blockquote>\n<p>I guess we want a metaprogram that finds all <code>def toX : &lt;a class&gt;</code>?</p>\n</blockquote>\n<p><a href=\"https://gist.github.com/kim-em/8f01bafd5e19c0d45c9e878a4c1deae5\">https://gist.github.com/kim-em/8f01bafd5e19c0d45c9e878a4c1deae5</a></p>\n<p>Spot checking, to me these all look like they need <code>@[implicit_reducible]</code>. But I haven't checked them all.</p>\n<p>It's probably simplest to do this check as a PR...?</p>\n</blockquote>\n<p>I tried this, and somewhat mysteriously, despite adding <code>implicit_reducible</code> on <code>Submodule.toAddCommGroup</code> allowing us to remove ~700 <code>set_option backward</code>s, none of the other <code>toX : &lt;class&gt;</code> definitions receiving a <code>implicit_reducible</code> seem to make any difference! <span aria-label=\"woman shrugging\" class=\"emoji emoji-1f937-200d-2640\" role=\"img\" title=\"woman shrugging\">:woman_shrugging:</span> </p>\n<p>I'm pretty surprised by this.</p>",
        "id": 575899711,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772065204
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575749881\">said</a>:</p>\n<blockquote>\n<p>I guess we want a metaprogram that finds all <code>def toX : &lt;a class&gt;</code>?</p>\n</blockquote>\n<p>I'm confused by this claim, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddSubgroup#doc\">docs#AddSubgroup</a> is <em>not</em> a class</p>",
        "id": 575899839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772065290
    },
    {
        "content": "<p>I am really surprised that Massot, who once suspended me for talking trash in this Zulip, now does it himself</p>",
        "id": 575899908,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772065338
    },
    {
        "content": "<p>oh! I was confused. So indeed the <code>def toX : &lt;a class&gt;</code> was the wrong thing entirely.</p>",
        "id": 575899926,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772065348
    },
    {
        "content": "<p>Is there a pattern we should be looking for to automate the success of <a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a>?</p>",
        "id": 575899993,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772065391
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575899993\">said</a>:</p>\n<blockquote>\n<p>Is there a pattern we should be looking for to automate the success of <a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a>?</p>\n</blockquote>\n<p>Run your new command on everything, log the results and analyse them</p>",
        "id": 575900131,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772065463
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575899908\">said</a>:</p>\n<blockquote>\n<p>I am really surprised that Massot, who once suspended me for talking trash in this Zulip, now does it himself</p>\n</blockquote>\n<p>AI enshittification is a real thing, and a real thing to guard against. I'm glad Patrick raised the issue, because if we're failing somewhere to guard against it, it should be pointed out. But this wasn't such a place. :-)</p>",
        "id": 575900215,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772065507
    },
    {
        "content": "<p>BTW I'm trying myself adding to <code>Data.Set.Defs</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span>\n</code></pre></div>\n<p>and running <code>rm_set_option.py</code>. It has removed 65 <code>set_option</code>s so far</p>",
        "id": 575900331,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772065574
    },
    {
        "content": "<p><code>unif_hint</code> has no documentation</p>",
        "id": 575900370,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772065598
    },
    {
        "content": "<p>I don't think that we should normalize defeq abuse instead of getting rid of it.</p>",
        "id": 575901422,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772066072
    },
    {
        "content": "<p>Agreed, let's only use <code>unif_hint</code> \"in desperation\".</p>",
        "id": 575902186,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772066498
    },
    {
        "content": "<p>But it still points out where specific types of defeq abuses are</p>",
        "id": 575902248,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772066530
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 575902718,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772066833
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575789953\">said</a>:</p>\n<blockquote>\n<p>This sounds like one more great example of AI‚ÄØenshittification: instead of working on fixing the actual issue of logs not being very well structured, you avoid the issue and push technical debt down the road.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>, please see </p>\n<blockquote>\n<p>feat: add structured TraceResult to TraceData <a href=\"https://github.com/leanprover/lean4/pull/12698\">lean#12698</a><br>\nfeat: add Meta.synthInstance.apply trace class <a href=\"https://github.com/leanprover/lean4/pull/12699\">lean#12699</a></p>\n</blockquote>",
        "id": 575908829,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772068724
    },
    {
        "content": "<p>So far I am not finding a solution to Jasper's example besides </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÇ</span>\n</code></pre></div>\n<p>which I don't think it insane, despite mere minutes ago saying that I wanted to avoid <code>unif_hint</code> where possible. </p>\n<p>We could restrict this to just <code>n=0</code> (possibly also <code>n=1</code>) since these problems are all about <code>Zero</code>/<code>One</code>.</p>",
        "id": 575909696,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772068991
    },
    {
        "content": "<p>What does that hint mean? I'm not a huge fan of declaring <code>unif_hint</code> the solution before it has any docstring explaining how to use it!</p>",
        "id": 575909953,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772069105
    },
    {
        "content": "<p>This is a long thread; could you link back to the example you're referring to?</p>",
        "id": 575910057,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772069150
    },
    {
        "content": "<p>The best summary is maybe actually the test cases for <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a>.</p>",
        "id": 575910142,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772069187
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575670266\">#general &gt; backward.isDefEq.respectTransparency @ üí¨</a> , <a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575750829\">#general &gt; backward.isDefEq.respectTransparency @ üí¨</a>  and <a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575807716\">#general &gt; backward.isDefEq.respectTransparency @ üí¨</a></p>",
        "id": 575910252,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1772069235
    },
    {
        "content": "<p>I found a possible bug in your <code>#defeq_abuse</code>, at <code>Multiset.noncommFoldr_coe</code>. If I set <code>set_option backward.isDefEq.respectTransparency true in</code> on it, it errors, but running <code>#defeq_abuse in</code> on it gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">defeq_abuse</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">succeeds</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`backward.isDefEq.respectTransparency</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">abuse</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 575911640,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772069948
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/oHNd70ZuQ5zbxh7nT0G3SmPp/image.png\">image.png</a><br>\n<a href=\"/user_uploads/3121/pxJfchjix7Q3ItGEXheAqN78/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/oHNd70ZuQ5zbxh7nT0G3SmPp/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"928x306\" src=\"/user_uploads/thumbnail/3121/oHNd70ZuQ5zbxh7nT0G3SmPp/image.png/840x560.webp\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/3121/pxJfchjix7Q3ItGEXheAqN78/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"932x467\" src=\"/user_uploads/thumbnail/3121/pxJfchjix7Q3ItGEXheAqN78/image.png/840x560.webp\"></a></div>",
        "id": 575911877,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772070068
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575911640\">said</a>:</p>\n<blockquote>\n<p>I found a possible bug in your <code>#defeq_abuse</code>, at <code>Multiset.noncommFoldr_coe</code></p>\n</blockquote>\n<p>Thanks, taking a look now.</p>",
        "id": 575912967,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772070697
    },
    {
        "content": "<p>I just want to summarize the state of things here, please let me know if we're missing anything.</p>\n<ul>\n<li>Yury's PR \"chore: reduce defeq abuse <a href=\"https://github.com/leanprover-community/mathlib4/pull/35286\">#35286</a>\" is <code>awaiting-author</code> after some review comments from Kevin</li>\n<li>\"chore(scripts): make rm_set_option cache opt-in via --resume <a href=\"https://github.com/leanprover-community/mathlib4/pull/35763\">#35763</a>\" is a usability improvement waiting for review</li>\n<li>\"chore: mark Submodule.toAddSubgroup @[reducible] <a href=\"https://github.com/leanprover-community/mathlib4/pull/35761\">#35761</a>\" has gone through some review, is being benchmarked, but hopefully can be merged soon</li>\n<li>\"feat(Tactic): add #defeq_abuse tactic combinator <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a>\" needs review. I've tried to factor out the general code, and it will be improved by the lean PRs <a href=\"https://github.com/leanprover/lean4/pull/12698\">lean#12698</a> and <a href=\"https://github.com/leanprover/lean4/pull/12699\">lean#12699</a> but those will take a while to land. This contains test cases showing <code>#defeq_abuse</code> works on most of the examples above.</li>\n<li>We don't have ideas for <span class=\"user-mention\" data-user-id=\"869628\">@Matthew Jasper</span>'s example except trying a <code>unif_hint</code>, and we need to try that out to see what else it breaks.</li>\n<li>Jeremy has identified a potential problem with #defeq_abuse that I will look into.</li>\n<li>I would love others to try out #defeq_abuse and start solving problems it reports / telling me how it goes wrong.</li>\n<li>At present we don't have any concrete cases where a lean4 fix is required, except <em>possibly</em> the OfNat issue.</li>\n</ul>",
        "id": 575913456,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772071036
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>  and <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span>, if either of you could be tempted into looking at <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a> that would be super helpful. This tool doesn't need to be perfect, it just needs to get us through this <code>respectTransparency</code> refactor. But I'd like to get it into master asap so people can start working on the backlog.</p>",
        "id": 575913541,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772071106
    },
    {
        "content": "<p>Further possible false negatives for <code>#defeq_abuse</code> you may want to look into: <code>Equiv.piFinsetUnion_left</code>, <code>Equiv.piFinsetUnion_right</code>, <code>Finset.disjoint_coe</code></p>",
        "id": 575914109,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772071367
    },
    {
        "content": "<p>Aobout unification hints to remove some of those <code>set_option</code>, they were also mentioned <a href=\"#narrow/channel/287929-mathlib4/topic/Feature.20request.3A.20attribute.20dsimp-nf/with/575343365\">here</a> (and the discussion contains interesting explanations of how <code>unif_hint</code> works and what it does)  in the context of trying to find how we should approach category theory in mathlib with this new behavior of transparency.</p>",
        "id": 575925387,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1772077909
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"598052\">@Jeremy Tan</span> for your report about #defeq_abuse not detecting problems in <code>Finset.disjoint_coe</code>, etc.</p>\n<p>It was a subtle problem -- the command needs to turn off <code>Elab.async</code>, or the global <code>set_option backward false</code> option leaks through.</p>\n<p>It is fixed now on <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a>, so I would love to have more people test it out / review it / merge it.</p>",
        "id": 575943605,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772088421
    },
    {
        "content": "<p><code>Monoid.toOne</code>  doesn't have <code>implicit_reducible</code>. This seems likely to be a Lean bug, requiring a rc3.</p>",
        "id": 575957120,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772093686
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575913456\">said</a>:</p>\n<blockquote>\n<p>I just want to summarize the state of things here, please let me know if we're missing anything.</p>\n</blockquote>\n<p>Do you have an answer for this question I asked above?<br>\n<span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575654541\">said</a>:</p>\n<blockquote>\n<p>On latest mathlib, with <code>backward.isDefEq.respectTransparency true</code> the following fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">compHom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">compHom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>I am proposing a fix in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35739\">#35739</a>. Is this correct behaviour of the new mechanism and is this fix what we should be doing?</p>\n</blockquote>",
        "id": 575965907,
        "sender_full_name": "Christian Merten",
        "timestamp": 1772096198
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575909696\">schrieb</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÇ</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Please no, I don't want to get kernel errors like this one:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inst‚ÇÇ</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: (kernel) declaration type mismatch, '_example' has type</span>\n<span class=\"sd\">  OfNat.ofNat 0 = OfNat.ofNat 0</span>\n<span class=\"sd\">but it is expected to have type</span>\n<span class=\"sd\">  OfNat.ofNat 0 = OfNat.ofNat 0</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">3</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">eq_refl</span>\n</code></pre></div>\n<p>We should probably fix <a href=\"https://github.com/leanprover/lean4/pull/8982\">lean4#8982</a> before we consider adding unification hints.</p>",
        "id": 575992077,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772103170
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575957120\">said</a>:</p>\n<blockquote>\n<p><code>Monoid.toOne</code>  doesn't have <code>implicit_reducible</code>. This seems likely to be a Lean bug, requiring a rc3.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/12701\">lean#12701</a> I think will fix this, but I don't want to merge yet as I don't have the <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> I want...</p>",
        "id": 575999034,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772105338
    },
    {
        "content": "<p>I think that the OfNat issues come down to this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Zero'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero'</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero'</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instZoInt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero'</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">zero_rfl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero'</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rid</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rid</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: typeclass instance problem is stuck</span>\n<span class=\"sd\">  Zero' ?_</span>\n\n<span class=\"sd\">Note: Lean will not try to resolve this typeclass instance problem because the type argument to `Zero'` is a metavariable. This argument must be fully determined before Lean will try to resolve the typeclass.</span>\n\n<span class=\"sd\">Hint: Adding type annotations and supplying implicit arguments to functions can give Lean more information for typeclass resolution. For example, if you have a variable `x` that you intend to be a `Nat`, but Lean reports it as having an unresolved type like `?m`, replacing `x` with `(x : Nat)` can get typeclass resolution un-stuck.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">zero_rfl</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">zero_rfl</span>\n</code></pre></div>",
        "id": 576086318,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1772127788
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/575999034\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/12701\">lean#12701</a> I think will fix this,</p>\n</blockquote>\n<p>I'm a little puzzled by the big picture here; am I right in saying that <code>structure</code> parents are _more_ reducible than <code>instance</code> parents (assuming <code>reducible</code> is \"more reducible\" than <code>implicit_reducible</code>? Is this deliberate?</p>",
        "id": 576097788,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772131314
    },
    {
        "content": "<p>Sure, since we bump the transparency to <code>implicit_reducible</code> for class projections, we need to make sure that you can't reduce them under <code>reducible</code>, otherwise we get the following transitivity failure:<br>\n<code>(myInstance ..).projection =?= (MyClass.mk ... xyz ...).projection =?= xyz</code><br>\nbut not <code>(myInstance ..).projection =?= xyz</code> under reducible transparency</p>",
        "id": 576105123,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772133599
    },
    {
        "content": "<p>and \"bump the transparency\" means \"make less transparent\"?</p>",
        "id": 576106242,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772133947
    },
    {
        "content": "<p>Bump the transparency in the sense of use a transparency of <code>implicit_reducible</code> or higher (i.e. or <code>default</code> / <code>all</code> if you already have it)</p>",
        "id": 576107665,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772134384
    },
    {
        "content": "<p>Does higher mean \"more transparent\" or \"less transparent\"?</p>",
        "id": 576107846,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772134438
    },
    {
        "content": "<p>Higher meaning being able to unfold more</p>",
        "id": 576108047,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772134497
    },
    {
        "content": "<p>Here's an issue I ran into in <a href=\"https://github.com/leanprover-community/mathlib4/pull/34734\">#34734</a> where a coersion between two structures no longer works. It concerns two types that each take a <code>Lean.Level</code> as an implicit parameter, which came up in the context of Qq annotations. The issue seems to be that <code>Lean.Level.zero</code>, <code>Lean.levelZero</code> and <code>Lean.Level.ofNat (nat_lit 0)</code> are not defeq at reducible transparency.</p>\n<p>Here's a Mathlib- and Qq-free minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">testCoersion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®‚ü©</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> The coersion fails. It succeeds if you uncomment the set_option.  -/</span>\n<span class=\"c1\">-- set_option backward.isDefEq.respectTransparency false in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>A snippet from the defeq trace shows <code>Level.ofNat 0 =?= Level.zero</code> fails</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">testCoersion</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">              </span><span class=\"o\">[</span><span class=\"n\">onFailure</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n</code></pre></div>\n<p>And indeed adding the following lines makes the coersion work again.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">allowUnsafeReducibility</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">reducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">levelZero</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span>\n</code></pre></div>\n<p>Should those definitions be reducible? Or is there an important reason they're not?</p>\n<p>I suppose I'll note this issue is not strictly caused by the new changes: if you make <code>u</code> explicit, you'll get the same error on Mathlib stable. I just hadn't noticed this because of the old behaviour around implicit parameters.</p>",
        "id": 576131374,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1772143405
    },
    {
        "content": "<p>Should <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.levelZero#doc\">docs#Lean.levelZero</a> just be deleted?</p>",
        "id": 576131619,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772143501
    },
    {
        "content": "<p>The whole section of constructor duplicates around it seem pretty pointless to me</p>",
        "id": 576131807,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772143567
    },
    {
        "content": "<p>I admit I had the same thought, but I'm not familiar enough with the internals of Lean to make that call</p>",
        "id": 576132725,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1772143965
    },
    {
        "content": "<p>The original reason for these duplicate constructors, I think, is that the computed field feature didn't exists yet in its current form. So you really had to use these alternative constructors to make sure the computed field was set correctly. Reacall that e.g. <code>Lean.Expr</code> has 64 bits of additional information, 32 of which are just a hash, and some of the other bits are used to store e.g. <code>Expr.hasFVar</code>.</p>",
        "id": 576133806,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1772144485
    },
    {
        "content": "<p>Indeed, <code>Level.data</code> is such a computed field</p>",
        "id": 576133940,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772144561
    },
    {
        "content": "<p>I wonder if we should eventually deprecate them, since we don't need them anymore</p>",
        "id": 576135248,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772145101
    },
    {
        "content": "<p>but well, let's maybe not talk about that in this thread</p>",
        "id": 576135289,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772145124
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"585783\">@Arend Mellendijk</span>, for those.</p>\n<p>It's super (extra!) helpful if <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>'s use <code>#guard_msgs</code> to display the behaviour and the way it changes, e.g. as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">testCoersion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®‚ü©</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> The coersion fails. It succeeds if you uncomment the set_option.  -/</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Type mismatch</span>\n<span class=\"sd\">  b</span>\n<span class=\"sd\">has type</span>\n<span class=\"sd\">  B</span>\n<span class=\"sd\">but is expected to have type</span>\n<span class=\"sd\">  A</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: have this := sorry;</span>\n<span class=\"sd\">this : A</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: have this := { };</span>\n<span class=\"sd\">this : A</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">backward</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"bp\">.</span><span class=\"n\">respectTransparency</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c1\">-- [] ‚ùåÔ∏è apply testCoersion to Coe B A ‚ñº</span>\n<span class=\"c1\">--   [tryResolve] ‚ùåÔ∏è Coe B A ‚âü Coe B A ‚ñº</span>\n<span class=\"c1\">--     [isDefEq] ‚ùåÔ∏è Coe B A =?= Coe B A ‚ñº</span>\n<span class=\"c1\">--       [] ‚úÖÔ∏è B =?= B ‚ñ∂</span>\n<span class=\"c1\">--       [] ‚ùåÔ∏è A =?= A ‚ñº</span>\n<span class=\"c1\">--         [] ‚ùåÔ∏è 0 =?= Level.zero ‚ñº</span>\n<span class=\"c1\">--           [] ‚ùåÔ∏è Level.ofNat 0 =?= Level.zero ‚ñº</span>\n<span class=\"c1\">--             [onFailure] ‚ùåÔ∏è Level.ofNat 0 =?= Level.zero</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 576148353,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772151879
    },
    {
        "content": "<p>I would really really love to see <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a> merged asap. With this, we don't need to muck about reading the trace messages ourselves, we just get immediately:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">warning: #defeq_abuse: command fails with `backward.isDefEq.respectTransparency true` but succeeds with `false`.</span>\n<span class=\"sd\">The following synthesis applications fail due to transparency:</span>\n<span class=\"sd\">  ‚ùåÔ∏è apply testCoersion to Coe B A</span>\n<span class=\"sd\">    ‚ùåÔ∏è Level.ofNat 0 =?= Level.zero</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">info: have this := { };</span>\n<span class=\"sd\">this : A</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">defeq_abuse</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 576148529,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772152003
    },
    {
        "content": "<p>I'm trying out </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">allowUnsafeReducibility</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">implicit_reducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">levelZero</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span>\n</code></pre></div>\n<p>in <a href=\"https://github.com/leanprover/lean4/pull/12719\">lean4#12719</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/35832\">#35832</a>.</p>",
        "id": 576150368,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772153164
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576148529\">said</a>:</p>\n<blockquote>\n<p>I would really really love to see <a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a> merged asap</p>\n</blockquote>\n<p>Since you're a maintainer and you really want this in, why don't you just merge it yourself (after getting <a href=\"https://github.com/leanprover-community/mathlib4/pull/35833\">#35833</a> in)?</p>",
        "id": 576157155,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1772155107
    },
    {
        "content": "<p>From my understanding, a non-trivial PR created by a maintainer needs to be approved by a different maintainer.</p>",
        "id": 576159012,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1772155449
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35750\">#35750</a> is pretty bulky, in part because Claude has no qualms about repeating itself. :) This really obscures the logic and makes it difficult to review. I‚Äôve taken a first pass at cleaning up the first half of it at <a href=\"https://github.com/leanprover-community/mathlib4/pull/35833\">#35833</a> so we can better see what‚Äôs going on in the code, shaving ~60 lines off of the main file.</p>\n<p>I think if we reviewed this as an ordinary meta PR, even a high-value one, we‚Äôd be reviewing it for a little while.</p>\n<p>But maybe we shouldn‚Äôt review it as an ordinary meta PR. Meta PRs that contribute features which are intended to be user-facing should be carefully reviewed for proper behavior and maintainability, but ‚Äúproviding users with a new feature‚Äù doesn‚Äôt seem to me the motivating factor for this PR.</p>\n<p>The motivating factor is getting us through this breakage, and that has a different set of needs and constraints than an ordinary meta feature: very high value if some version of it is available <em>now</em>, without terrible consequences if it doesn‚Äôt work quite correctly or can‚Äôt be maintained in its current form (since its use is so restricted and single-purpose).</p>\n<p>I think there‚Äôs an argument for viewing this as something like an  ‚Äúadaptation tool‚Äù. It‚Äôs technical debt, but it helps Kim get their urgent work done, so this might be a time when it makes sense to take on technical debt.</p>\n<p>To make sure we‚Äôre clear to users about these different standards, we plaster neon signs in the module docs and hovers about how this is currently intended only for this sole purpose, may undergo breaking syntax and behavior changes in the future, and may not work as advertised. Then we clean it up after it‚Äôs in.</p>\n<p>I don‚Äôt like technical debt, but given the circumstances, I think it wouldn‚Äôt be an unreasonable course of action.</p>",
        "id": 576162776,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1772157615
    },
    {
        "content": "<p>If we're going this way, then I suggest making as much as possible private as a way to say \"this may break at any time\" without relying on a human reading a docstring. I'm not sure how much must stay public for the tactic to be usable.</p>",
        "id": 576163270,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772158009
    },
    {
        "content": "<p>I would love to have any sort of tool to diagnose this error, instead of randomly flailing around in the dark adding <code>set_option</code>. Anything is better than nothing.</p>",
        "id": 576164128,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1772158702
    },
    {
        "content": "<p>Yes, sorry, I should have talked about this above. In particular this is purely a diagnostic tool, which will never see a <code>#defeq_abuse</code> call committed to a branch or master outside the test file.</p>\n<p>So for review we need to check that it does not \"launch the nukes\" in some annoying way, and we need some basic behavioural tests: is this more often than not a time saver to diagnose problems?</p>",
        "id": 576164933,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772159386
    },
    {
        "content": "<p>I think there's also an element of deciding what our maintainence plan is if it breaks in a lean update; but I guess the answer is \"that will almost certainly become Kim's problem\"?</p>",
        "id": 576165056,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772159466
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/12701\">lean#12701</a> seems to result in the addition of 100 new <code>set_option backward</code> and the removal of another 400. So... net positive! And it seems more principled to have the grandparent projections have the same reducibility as normal structure projections (I am not attempting yet to get consistency here for mixed class/structure inheritance. My mind boggles, but we will have to return to this.) So it will land in an rc3, which unfortunately I won't be able to get to Mathlib until Monday.</p>",
        "id": 576165143,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772159524
    },
    {
        "content": "<blockquote>\n<p>I am not attempting yet to get consistency here for mixed class/structure inheritance</p>\n</blockquote>\n<p>Perhaps the easy answer here is to lint against this in mathlib in the first place</p>",
        "id": 576165215,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772159577
    },
    {
        "content": "<p>I guess the main thing this would break is <code>Algebra</code> which we would have to write as <code>algebraMap.toFun :=</code> instead of <code>toFun :=</code> or similar</p>",
        "id": 576165247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772159607
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576165056\">said</a>:</p>\n<blockquote>\n<p>I think there's also an element of deciding what our maintainence plan is if it breaks in a lean update; but I guess the answer is \"that will almost certainly become Kim's problem\"?</p>\n</blockquote>\n<p>The backup plan being \"Now that we are on Lean v4.67.0, Mathlib is so immaculately careful about defeq abuse, that this legacy tool can simply be deleted!\"... :-)</p>",
        "id": 576167255,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1772161080
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576164933\">said</a>:</p>\n<blockquote>\n<p>In particular this is purely a diagnostic tool, which will never see a <code>#defeq_abuse</code> call committed to a branch or master outside the test file.</p>\n</blockquote>\n<p>Just to make clear my reviewing/maintaining thoughts here:</p>\n<p>Even if no invocation of a diagnostic tool is ever committed to a branch or master, the tool still becomes part of the user interface surface, and people form expectations about it and how it works (without committing it anywhere).</p>\n<p>So, to respect those expectations and keep the user interface surface stable, an ordinary contribution of a diagnostic tool would still need to at least try to avoid breaking changes (e.g. settle on good syntax), be reviewed to behave correctly/meet current expectations, and have maintainable-enough code to preserve those expectations through time.</p>\n<p>But since this is no ordinary diagnostic tool...we \"get to\" avoid all that for now with some disclaimers :)</p>",
        "id": 576167666,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1772161339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576167255\">said</a>:</p>\n<blockquote>\n<p>\"Now that we are on Lean v4.67.0, Mathlib is so immaculately careful about defeq abuse, that this legacy tool can simply be deleted!\"... :-)</p>\n</blockquote>\n<p>I would be extremely surprised if the code remains unbroken for ~40 releases!</p>",
        "id": 576167858,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772161478
    },
    {
        "content": "<p>What about creating a new package in the Mathlib4 repo, next to <code>Mathlib</code>, <code>Archive</code>, etc...<br>\nWe call it <code>MathlibNightlyDevTools</code>.<br>\nIt is imported in the root of Mathlib by default, but we lint against any of those tools/commands/decls actually appearing in <code>Mathlib</code>.<br>\nThe review of new tools can follow the standards that Thomas outlined above.<br>\nAnd there is a very clear communication that \"if this code breaks during updates, we might just delete it... we don't promise any polish, or maintenance, or whatever\"</p>",
        "id": 576175471,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1772165825
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576164933\">said</a>:</p>\n<blockquote>\n<p>So for review [...] we need some basic behavioural tests: is this more often than not a time saver to diagnose problems?</p>\n</blockquote>\n<p>The endorsement from <span class=\"user-mention\" data-user-id=\"459227\">@Violeta Hern√°ndez</span> seems to suggest \"yes\". :) Given that we are including disclaimers, I am tempted to say we should experiment with this in the field! :)</p>",
        "id": 576178900,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1772167753
    },
    {
        "content": "<p>I haven't actually experimented with this new tool. But given that I just had to add 100 of these <code>set_option</code>s to my own repo, I'm certainly excited to try it out.</p>",
        "id": 576179024,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1772167811
    },
    {
        "content": "<p>I've made a final bare-bones review PR to the branch adding disclaimers, making some functionality private (and changing one private thing to public, but I believe the organization is better that way): <a href=\"https://github.com/leanprover-community/mathlib4/pull/35843\">#35843</a>.</p>",
        "id": 576179750,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1772168199
    },
    {
        "content": "<p><del>If there are no objections here shortly I'll maintainer delegate the PR. (Or a maintainer can leapfrog me. :) )</del> I've maintainer delegated the PR. I think it would be great to get <code>MathlibNightlyDevTools</code> going, and move this there...but after it's merged, given that the point of this unorthodoxy is the time sensitivity :)</p>",
        "id": 576179847,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1772168261
    },
    {
        "content": "<p>Delegated! <span aria-label=\"peace sign\" class=\"emoji emoji-270c\" role=\"img\" title=\"peace sign\">:peace_sign:</span></p>",
        "id": 576211564,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1772183703
    },
    {
        "content": "<p>I've finished looking at the ofNat issues. The bug here is that class projections are <code>semireducible</code> and are <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Meta/WHNF.lean#L794\">special cased</a> in the compiler to act like they're <code>implicit_reducible</code>, but it's not handled correctly everywhere. Specifically, <a href=\"https://github.com/leanprover/lean4/blob/70aa6bc81d0ca07f009b7af850b119f19e30a4eb/src/Lean/Meta/WHNF.lean#L369\">getStuckMVar?</a> is not normalizing the instance parameter to the projection function, even though it <a href=\"https://github.com/leanprover/lean4/blob/70aa6bc81d0ca07f009b7af850b119f19e30a4eb/src/Lean/Meta/WHNF.lean#L369\">does so</a> for actual projections. I think that there's two possible solutions: first, <code>getStuckMVar?</code>could be made consistent between projections and class projection functions:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/Lean/Meta/WHNF.lean b/src/Lean/Meta/WHNF.lean</span>\n<span class=\"gh\">index d05e0e694a..ba7959297b 100644</span>\n<span class=\"gd\">--- a/src/Lean/Meta/WHNF.lean</span>\n<span class=\"gi\">+++ b/src/Lean/Meta/WHNF.lean</span>\n<span class=\"gu\">@@ -350,3 +350,3 @@ mutual</span>\n<span class=\"w\"> </span>            if let some major := args[projInfo.numParams]? then\n<span class=\"gd\">-              if let some mvarId ‚Üê getStuckMVar? major then</span>\n<span class=\"gi\">+              if let some mvarId ‚Üê getStuckMVar? (‚Üê whnf major) then</span>\n<span class=\"w\"> </span>                return mvarId\n</code></pre></div>\n<p>Alternatively, class projection functions could be made <code>implicit_reducible</code>. This appears to work and should also allow removing <code>unfoldProjInstWhenInstances?</code> but I wasn't able to test that because it seems that the build process doesn't recompile <code>Init</code> with the new compiler.</p>\n<p>Note that <a href=\"https://github.com/leanprover/lean4/pull/12701\">lean#12701</a> is also required to fix the original Mathlib examples.</p>",
        "id": 576386467,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1772250785
    },
    {
        "content": "<p>So, if class projections are <code>semireducible</code>, and <code>semireducible</code> Type-valued definitions are bad, should be avoided etc., is the design of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Quiver#doc\">docs#Quiver</a> bad? Is the following \"defeq abuse\"?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">Quiver</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"bp\">.</span><span class=\"n\">Hom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Quiver</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">Hom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"bp\">.</span><span class=\"n\">Hom</span>\n<span class=\"c1\">-- is using `f.of` for `f : Quiver.Hom x y` abuse?</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">of</span>\n</code></pre></div>\n<p>I am of course asking because this kind of things is everywhere in Mathlib: morphisms in categories are almost always structures on which we use the field projections on terms of type <code>_ ‚ü∂ _</code>.<br>\nIf this is abuse, what could be fixes that do not involve refactoring the entirety of category theory? Marking <code>Quiver.Hom</code> as <code>implicit_reducible</code>?</p>",
        "id": 576403447,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1772267195
    },
    {
        "content": "<p>I think we tried making Quiver.Hom reducible in the past, and it didn't work because not every instance used that structure pattern</p>",
        "id": 576405700,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772269239
    },
    {
        "content": "<p>I would appreciate a review of <a href=\"https://github.com/leanprover-community/mathlib4/pull/35795\">#35795</a> (reduce defeq about <code>Set</code>)</p>",
        "id": 576406049,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772269538
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576405700\">said</a> in <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/with/576405700\"><a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/with/576406049\">#general &gt; backward.isDefEq.respectTransparency</a></a>:</p>\n<blockquote>\n<p>I think we tried making Quiver.Hom reducible in the past, and it didn't work because not every instance used that structure pattern</p>\n</blockquote>\n<p>Is this saying that we should be refactoring these instance to make sure their <code>Hom</code> is always a structure (maybe with just one field)?<br>\nWhat would be other unwanted consequences of marking it <code>implicit_reducible</code>?</p>",
        "id": 576408346,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1772271464
    },
    {
        "content": "<p>The next batch about <code>Set</code> defeq abuse: <a href=\"https://github.com/leanprover-community/mathlib4/pull/35885\">#35885</a> (probably, I haven't cherry-picked all the relevant parts of the diff; I'll do it in the morning)</p>",
        "id": 576408626,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1772271669
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"286014\">Robin Carlier</span> <a href=\"#narrow/channel/113488-general/topic/backward.2EisDefEq.2ErespectTransparency/near/576408346\">said</a>:</p>\n<blockquote>\n<p>Is this saying that we should be refactoring these instance to make sure their <code>Hom</code> is always a structure (maybe with just one field)?<br>\n</p>\n</blockquote>\n<p>Yes, and I think this is already a refactor we've been slowly executing</p>",
        "id": 576414604,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1772277164
    }
]