[
    {
        "content": "<p>I have recently been learning Lean4 via the excellent Game Server ( <a href=\"https://www.youtube.com/@TongKeXue/videos\">https://www.youtube.com/@TongKeXue/videos</a> ) and the excellent <a href=\"https://lean-lang.org/functional_programming_in_lean/\">https://lean-lang.org/functional_programming_in_lean/</a> .</p>\n<p>I am interested in understanding what needs to be modified at <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Compiler/IR/EmitC.lean\">https://github.com/leanprover/lean4/blob/master/src/Lean/Compiler/IR/EmitC.lean</a> to have Lean emit JS.</p>\n<p>The end goal being:</p>\n<ol>\n<li>write core JS logic in lean; emit JS code as something esbuild can process</li>\n<li>link lean-js-output w/ js libraries</li>\n<li>we can now do JS dev in dependently-typed lean</li>\n</ol>\n<p>My questions are:</p>\n<ol>\n<li>what are the general steps for adding a new backend (just for local dev) ?</li>\n<li>after <code>cp EmitC.lean EmitJS.lean</code>, what steps can I do to get a <code>*.js</code> output file (that contains C code) ?</li>\n<li>EmitC.lean is only 800 loc, so translation should not be too bad; are there any high level invariants / contracts I need to be aware of ?</li>\n</ol>\n<p>Thanks!</p>",
        "id": 560548772,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764235361
    },
    {
        "content": "<p>Note that it as a (very likely long) chain of 6 imports, so the 800 LOC is illusory:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">NameMangling</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"bp\">.</span><span class=\"n\">EmitUtil</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"bp\">.</span><span class=\"n\">NormIds</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"bp\">.</span><span class=\"n\">SimpCase</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">IR</span><span class=\"bp\">.</span><span class=\"n\">Boxing</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">ModPkgExt</span>\n</code></pre></div>",
        "id": 560566088,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1764240380
    },
    {
        "content": "<p>I'd try a different approach. I'd tackle it from the higher level by using Lean 4 more closely to how it's meant to be used, via metaprogramming.</p>",
        "id": 560567095,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1764240668
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/channel/113488-general/topic/adding.20a.20new.20backend.20.28JS.2C.20Elixir.29/near/560567095\">said</a>:</p>\n<blockquote>\n<p>I'd try a different approach. I'd tackle it from the higher level by using Lean 4 more closely to how it's meant to be used, via metaprogramming.</p>\n</blockquote>\n<p>I don't understand the idea you have in mind. Can you point me at documentation / sample code / tutorial that does what you have in mind ?</p>\n<p>Thanks!</p>",
        "id": 560635854,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764260922
    },
    {
        "content": "<p>In the past there was work to use emscripten to compile C to js, but it suffered from the sheer size of all the Olean files</p>",
        "id": 560637851,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1764261607
    },
    {
        "content": "<p>I am currently testing out a different approach of \"foobar.lean -&gt; foobar.c -&gt; manually link it via FFI (wasm in JS case)\"</p>\n<p>Currently, I have this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Hello, world!\"</span>\n\n<span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fatal</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span>\n<span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\">          </span><span class=\"bp\">^~~~~~~~~~~~~</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>What is the correct (i.e. not hardcoding) way to get the path for where lean.h is stored and the corresponding <a href=\"http://liblean.so\">liblean.so</a> we're going to have to link against?</p>",
        "id": 560640219,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764262357
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1001511\">TongKe Xue</span> <a href=\"#narrow/channel/113488-general/topic/adding.20a.20new.20backend.20.28JS.2C.20Elixir.29/near/560635854\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"451983\">Arthur Paulino</span> <a href=\"#narrow/channel/113488-general/topic/adding.20a.20new.20backend.20.28JS.2C.20Elixir.29/near/560567095\">said</a>:</p>\n<blockquote>\n<p>I'd try a different approach. I'd tackle it from the higher level by using Lean 4 more closely to how it's meant to be used, via metaprogramming.</p>\n</blockquote>\n<p>I don't understand the idea you have in mind. Can you point me at documentation / sample code / tutorial that does what you have in mind ?</p>\n<p>Thanks!</p>\n</blockquote>\n<p>Unfortunately I don't know any minimally well documented example of this. But here's a starter with a few hints:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#compile\"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Here we're in `CommandElabM`, which gives us access to the</span>\n<span class=\"w\">  </span><span class=\"c1\">-- current environment</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stt</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ConstMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stt</span><span class=\"bp\">.</span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span>\n<span class=\"w\">  </span><span class=\"c1\">-- You can ctrl+click on `Lean.ConstMap` above to inspect it.</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- `CommandElabM` also gives you access to `IO` so you can, for example, write</span>\n<span class=\"w\">  </span><span class=\"c1\">-- data to your file system. E.g., when writing some generated source on your</span>\n<span class=\"w\">  </span><span class=\"c1\">-- target language (JS or any other).</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- `n` allows you to get the corresponding `Lean.Name`, which can be used t</span>\n<span class=\"w\">  </span><span class=\"c1\">-- retrieve the target constant you want to compile</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"Not found in environment\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- You can also throw errors</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ConstantInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c1\">-- You can inspect `Lean.ConstantInfo` by ctrl+clicking on it</span>\n<span class=\"w\">    </span><span class=\"c1\">-- From here, you can do anything with `constant` and `constants` at hand</span>\n<span class=\"w\">    </span><span class=\"c1\">-- I'll just print a boolean that confirms it's a definition</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"bp\">.</span><span class=\"n\">isDefinition</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"bp\">#</span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">myMain</span>\n<span class=\"c1\">-- hi</span>\n<span class=\"c1\">-- true</span>\n</code></pre></div>\n<p>From the metaprogramming layer you have way more control than you'd have on highly processed code.</p>",
        "id": 560641280,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1764262760
    },
    {
        "content": "<ol>\n<li>Thank you for the minimal example.</li>\n<li>I have it running locally.</li>\n</ol>\n<p>The reason I was originally looking at the EmitC layer was that I was:</p>\n<ol>\n<li>I wanted to deal with something with all the proofs removed.</li>\n<li>Besides \"refcount 1 on shared structure == we can overwrite in place\", I thought the C -&gt; JS conversion would mainly be syntactical, i.e. changing C syntax to JS syntax. I've since realized this is probably false, as the emitted C code includes \"lean/lean.h\" and needs to be linked vs some \"lean runtime lib\", which JS does not have. (Unless we emscriptsen the C Lean runtime to wasm.)</li>\n</ol>\n<p>I'm looking at your approach above -- and please correct me if I'm wrong -- we're basically getting it at the AST level right? Which means (1) we need to remove the proof ourselves, (2) we need to run our own optimization passes [which I believe there are a few before emitting C].</p>\n<p>Again, I'm new to this codebase; please let me know if I'm getting things wrong. Thanks!</p>",
        "id": 560645516,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764264377
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1001511\">TongKe Xue</span> <a href=\"#narrow/channel/113488-general/topic/adding.20a.20new.20backend.20.28JS.2C.20Elixir.29/near/560645516\">said</a>:</p>\n<blockquote>\n<p>I'm looking at your approach above -- and please correct me if I'm wrong -- we're basically getting it at the AST level right? Which means (1) we need to remove the proof ourselves, (2) we need to run our own optimization passes [which I believe there are a few before emitting C].</p>\n</blockquote>\n<p>It's not as raw as an AST. It's already elaborated, with all meta variables filled. But you're right in thinking that you'd need to remove proofs manually and you'd need to implement your own optimizations.</p>\n<p>But there's no need to deal with C stuff, like linking etc. It's your compiler and you're in control.</p>",
        "id": 560647136,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1764264985
    },
    {
        "content": "<p>Two separate followups to this</p>\n<p>I can build a lean program 'manually' via</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">c</span>\n<span class=\"n\">clang</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"ss\">`lean</span><span class=\"w\"> </span><span class=\"c1\">--print-prefix`/include -L`lean --print-libdir` -lleanshared</span>\n</code></pre></div>\n<p>Two followups</p>\n<ol>\n<li>\n<p>is it possible to build this so the output is wasm32 instead of x86_64 ? I'm not trying to run entire lean4 server in Chrome/wasm32, I just want to run particular programs (written in lean4) in Chrome/wasm32</p>\n</li>\n<li>\n<p>is the generated x86_64 code multi thread safe? [i.e. I want to write it in an erlang/beam <a href=\"https://www.erlang.org/doc/system/nif.html\">https://www.erlang.org/doc/system/nif.html</a> , and call it from Elixir]</p>\n</li>\n</ol>\n<p>The end goal here is to have an app running in Chrome/wasm32 talking to an x86_64 linux server, and have it \"sorta\" verified in lean4. [i.e. we verify core logic in lean4, then make assumptions about websockets + included libraries]</p>\n<p>Thanks!</p>",
        "id": 560661471,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1764271832
    }
]