[
    {
        "content": "<p>this code did work in v4.24.0 but breaks  in v4.25.0-rc2</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Plausible</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Plausible</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"o\">)</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">shrink</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">shrink</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shrinkable</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">shrink</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">shrink</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">SampleableExt</span><span class=\"w\"> </span><span class=\"k\">in</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SampleableExt</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkSelfContained</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SampleableExt</span><span class=\"bp\">.</span><span class=\"n\">interpSample</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> (kernel) application type mismatch</span>\n<span class=\"cm\">  Arbitrary.arbitrary</span>\n<span class=\"cm\">argument has type</span>\n<span class=\"cm\">  Arbitrary (SampleableExt.proxy MyNat)</span>\n<span class=\"cm\">but function has type</span>\n<span class=\"cm\">  [self : Arbitrary MyNat] → Gen MyNat -/</span>\n<span class=\"bp\">#</span><span class=\"n\">sample</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n</code></pre></div>\n<p>How to fix this?</p>",
        "id": 546452619,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1761138279
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"116028\">@Cody Roux</span> seems likely to me that the recent refactoring broke this. Would you like to fix it + add a test or should I?</p>",
        "id": 546453805,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1761138560
    },
    {
        "content": "<p>If you have time to fix it, great! I'm actually not sure what's happening here; did I mess up the <code>mkSelfContained</code> too opaque or is the <code>SampleableExt</code> instance from <code>Arbitrary</code> wrong?</p>\n<p>As a side note: should we deprecate <code>mkSelfContained</code> in favor of directly defining <code>Arbitrary</code>? That way we encourage using <code>deriving</code> etc (which, I just noticed, is not included by default on <code>import Arbitrary</code>, also my bad)</p>",
        "id": 546456115,
        "sender_full_name": "Cody Roux",
        "timestamp": 1761139184
    },
    {
        "content": "<blockquote>\n<p>If you have time to fix it, great! I'm actually not sure what's happening here; did I mess up the <code>mkSelfContained</code> too opaque or is the <code>SampleableExt</code> instance from <code>Arbitrary</code> wrong?</p>\n</blockquote>\n<p>None of that, you just didn't update the <code>#sample</code> elaborator and we had no test for it, i'll fix it</p>",
        "id": 546460689,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1761140355
    },
    {
        "content": "<p>Oh whew</p>",
        "id": 546460813,
        "sender_full_name": "Cody Roux",
        "timestamp": 1761140381
    },
    {
        "content": "<p>Thanks, I can do it a bit later if you don't get to it</p>",
        "id": 546460875,
        "sender_full_name": "Cody Roux",
        "timestamp": 1761140396
    },
    {
        "content": "<p>Hm, when I try it in a local plausible checkout it very much does work though. Maybe this is because of the currently broken cache and just a transient issue</p>",
        "id": 546467565,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1761142031
    },
    {
        "content": "<p>Works for me too at the moment.</p>",
        "id": 546498802,
        "sender_full_name": "Cody Roux",
        "timestamp": 1761149350
    },
    {
        "content": "<p>As does (happily) <code>deriving Arbitrary</code></p>",
        "id": 546498948,
        "sender_full_name": "Cody Roux",
        "timestamp": 1761149400
    }
]