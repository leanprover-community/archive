[
    {
        "content": "<p>In our project FFL, we rely on GitHub Actions’ cache functionality. </p>\n<p>See: <a href=\"https://github.com/FormalizedFormalLogic/Foundation/blob/master/.github/workflows/ci.yml\">https://github.com/FormalizedFormalLogic/Foundation/blob/master/.github/workflows/ci.yml</a> <br>\nI note that we don't use lean-action because we build library, doc (by doc-gen), book (by verso) at once, the reusable action doesn't fit our desire.</p>\n<p>However, mainly due to the size of Mathlib, our cache grows to about 4 GB, and since GitHub’s total cache quota is 10 GB, we can effectively store only 2 or 3 cache entries, which makes the cache nearly useless in practice.</p>\n<p><a href=\"/user_uploads/3121/DEJbZr8b4-clO5O9jsPuYrxH/firefox_1lU79wrXht.png\">firefox_1lU79wrXht.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/DEJbZr8b4-clO5O9jsPuYrxH/firefox_1lU79wrXht.png\" title=\"firefox_1lU79wrXht.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1028x770\" src=\"/user_uploads/thumbnail/3121/DEJbZr8b4-clO5O9jsPuYrxH/firefox_1lU79wrXht.png/840x560.webp\"></a></div><p>To address this, I tried caching only <code>.lake/build</code>, and handling by <code>lake exe cache get</code> for mathlib's cache. Moreover, it seems that we don’t really need to cache <code>.lake/build/bin</code> either. <br>\nThere may be other directories that don’t actually need to be cached, so I’d like to reduce the cache as much as possible. (below <code>dust .lake --depth 2</code> in FFL/Foundation)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"mf\">3.4</span><span class=\"n\">M</span><span class=\"w\">     </span><span class=\"bp\">┌──</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">data</span><span class=\"w\">        </span><span class=\"bp\">│█░░░░░░░░░░</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">5.9</span><span class=\"n\">M</span><span class=\"w\">     </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\">             </span><span class=\"bp\">│█░░░░░░░░░░</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mi\">233</span><span class=\"n\">M</span><span class=\"w\">     </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ir</span><span class=\"w\">              </span><span class=\"bp\">│██░░░░░░░░░</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">3</span><span class=\"bp\">%</span>\n<span class=\"mi\">308</span><span class=\"n\">M</span><span class=\"w\">     </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">lib</span><span class=\"w\">             </span><span class=\"bp\">│██░░░░░░░░░</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"bp\">%</span>\n<span class=\"mf\">1.2</span><span class=\"n\">G</span><span class=\"w\">     </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"w\">             </span><span class=\"bp\">│████████░░░</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">  </span><span class=\"mi\">15</span><span class=\"bp\">%</span>\n<span class=\"mf\">1.8</span><span class=\"n\">G</span><span class=\"w\">   </span><span class=\"bp\">┌─┴</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\">             </span><span class=\"bp\">│███████████</span><span class=\"w\">                                       </span><span class=\"bp\">│</span><span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"bp\">%</span>\n<span class=\"mi\">376</span><span class=\"n\">K</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">┌──</span><span class=\"w\"> </span><span class=\"n\">BibtexQuery</span><span class=\"w\">     </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mi\">432</span><span class=\"n\">K</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Cli</span><span class=\"w\">             </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">1.8</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">MD4Lean</span><span class=\"w\">         </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">2.1</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">subverso</span><span class=\"w\">        </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">4.0</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"w\">        </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">5.7</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">LeanSearchClient</span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mf\">6.2</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">importGraph</span><span class=\"w\">     </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">plausible</span><span class=\"w\">       </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">UnicodeBasic</span><span class=\"w\">    </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\">              </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">verso</span><span class=\"w\">           </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"w\"> </span><span class=\"mi\">41</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"w\">    </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"bp\">%</span>\n<span class=\"mi\">154</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"w\">           </span><span class=\"bp\">│█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">2</span><span class=\"bp\">%</span>\n<span class=\"mi\">449</span><span class=\"n\">M</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">batteries</span><span class=\"w\">       </span><span class=\"bp\">│███░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"mi\">5</span><span class=\"bp\">%</span>\n<span class=\"mf\">5.7</span><span class=\"n\">G</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\">         </span><span class=\"bp\">│███████████████████████████████████░░░░</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">  </span><span class=\"mi\">69</span><span class=\"bp\">%</span>\n<span class=\"mf\">6.4</span><span class=\"n\">G</span><span class=\"w\">   </span><span class=\"bp\">├─┴</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"w\">          </span><span class=\"bp\">│███████████████████████████████████████</span><span class=\"w\">           </span><span class=\"bp\">│</span><span class=\"w\">  </span><span class=\"mi\">78</span><span class=\"bp\">%</span>\n<span class=\"mf\">8.2</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">┌─┴</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"w\">               </span><span class=\"bp\">│█████████████████████████████████████████████████</span><span class=\"w\"> </span><span class=\"bp\">│</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span>\n</code></pre></div>\n<p>Does this seem like a sound approach? If this is indeed a reasonable solution, then note that <code>lean-action</code> currently caches the entire <code>.lake</code> directory as well. Shouldn’t we revise that too?</p>",
        "id": 556688533,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1763302810
    },
    {
        "content": "<p>Not using a cache is not an option, currently, a full build without caching takes 50 minutes in GitHub Actions.</p>",
        "id": 556688781,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1763303061
    },
    {
        "content": "<p>Are you saying 50 minutes just for your own code?</p>",
        "id": 556688866,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1763303150
    },
    {
        "content": "<p>See repository's log, completing jobs in CI takes 50 minutes: in this case cache doesn't match.</p>\n<p><a href=\"https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19405054054\">https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19405054054</a></p>",
        "id": 556689031,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1763303301
    },
    {
        "content": "<p>I can only look briefly now but I'm a little confused why mathlib files are being built in the log here, even though you ran <code>lake exe cache get</code> in an earlier step: <a href=\"https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19405054054/job/55518313582#step:10:266\">https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19405054054/job/55518313582#step:10:266</a></p>\n<p>Are you modifying files in mathlib or one of its dependencies somehow?</p>",
        "id": 556689476,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763303734
    },
    {
        "content": "<p>Note that it's doing native compilation there, which is not currently cached</p>",
        "id": 556690016,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763304289
    },
    {
        "content": "<p>Our project needs to produce executables for the <em>Zoo</em> (see <a href=\"https://github.com/FormalizedFormalLogic/Foundation?tab=readme-ov-file#zoo\">https://github.com/FormalizedFormalLogic/Foundation?tab=readme-ov-file#zoo</a> ), the corresponding source code is located here: <a href=\"https://github.com/FormalizedFormalLogic/Foundation/tree/master/Zoo\">https://github.com/FormalizedFormalLogic/Foundation/tree/master/Zoo</a></p>\n<p>Files required to build these executables (I'm not sure <code>.o</code> files calls) are presumably not included in mathlib's cache, and thus cannot be obtained via <code>lake exe cache get</code>. For this reason, I suspect these files are being build in CI (this inference may be incorrect). Please refer to the \"Generate Propositional Zoo\" step in the following job: <a href=\"https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19286694824/job/55148901446\">https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19286694824/job/55148901446</a></p>\n<p>Anyway, the building <code>.o</code> files takes about 4-5 minutes, it's not essential the issue we're currently trying to address.</p>",
        "id": 556690103,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1763304316
    },
    {
        "content": "<p>I also remembered another issue to related this. An excessively large cache may exceed the disk space of GitHub Actions runners, and I have personally had to deal with exactly this problem.</p>\n<p>Please refer to the “Save project cache” step this job: <a href=\"https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19384312786/job/55468840547\">https://github.com/FormalizedFormalLogic/Foundation/actions/runs/19384312786/job/55468840547</a></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"w\"> </span>/usr/bin/tar<span class=\"w\"> </span>--posix<span class=\"w\"> </span>-cf<span class=\"w\"> </span>cache.tzst<span class=\"w\"> </span>--exclude<span class=\"w\"> </span>cache.tzst<span class=\"w\"> </span>-P<span class=\"w\"> </span>-C<span class=\"w\"> </span>/home/runner/work/Foundation/Foundation<span class=\"w\"> </span>--files-from<span class=\"w\"> </span>manifest.txt<span class=\"w\"> </span>--use-compress-program<span class=\"w\"> </span>zstdmt\nzstd:<span class=\"w\"> </span>error<span class=\"w\"> </span><span class=\"m\">70</span><span class=\"w\"> </span>:<span class=\"w\"> </span>Write<span class=\"w\"> </span>error<span class=\"w\"> </span>:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>write<span class=\"w\"> </span>block<span class=\"w\"> </span>:<span class=\"w\"> </span>No<span class=\"w\"> </span>space<span class=\"w\"> </span>left<span class=\"w\"> </span>on<span class=\"w\"> </span>device\n/usr/bin/tar:<span class=\"w\"> </span>cache.tzst:<span class=\"w\"> </span>Wrote<span class=\"w\"> </span>only<span class=\"w\"> </span><span class=\"m\">4096</span><span class=\"w\"> </span>of<span class=\"w\"> </span><span class=\"m\">10240</span><span class=\"w\"> </span>bytes\n/usr/bin/tar:<span class=\"w\"> </span>Child<span class=\"w\"> </span>returned<span class=\"w\"> </span>status<span class=\"w\"> </span><span class=\"m\">70</span>\n/usr/bin/tar:<span class=\"w\"> </span>Error<span class=\"w\"> </span>is<span class=\"w\"> </span>not<span class=\"w\"> </span>recoverable:<span class=\"w\"> </span>exiting<span class=\"w\"> </span>now\nWarning:<span class=\"w\"> </span>Failed<span class=\"w\"> </span>to<span class=\"w\"> </span>save:<span class=\"w\"> </span><span class=\"s2\">\"/usr/bin/tar\"</span><span class=\"w\"> </span>failed<span class=\"w\"> </span>with<span class=\"w\"> </span>error:<span class=\"w\"> </span>The<span class=\"w\"> </span>process<span class=\"w\"> </span><span class=\"s1\">'/usr/bin/tar'</span><span class=\"w\"> </span>failed<span class=\"w\"> </span>with<span class=\"w\"> </span><span class=\"nb\">exit</span><span class=\"w\"> </span>code<span class=\"w\"> </span><span class=\"m\">2</span>\nWarning:<span class=\"w\"> </span>Cache<span class=\"w\"> </span>save<span class=\"w\"> </span>failed.\n</code></pre></div>\n<p>As an ad-hoc workaround, I used <a href=\"https://github.com/BRAINSia/free-disk-space\">https://github.com/BRAINSia/free-disk-space</a> to free storage on the GH Actions Ubuntu runner. However, there is no guarantee that this problem will not occur in other repositories, especially projects using <code>lean-action</code>. Indeed, in our case, the issue suddenly appeered just two days ago (before this, caching seems to works well).</p>",
        "id": 556690675,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1763304872
    }
]