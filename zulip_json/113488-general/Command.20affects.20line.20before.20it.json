[
    {
        "content": "<p>In this example, there is an error on the variable declaration line (on <code>CompleteSpace E</code>) which seems to be induced by the line <em>after</em> it (locally erasing various instances).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">Dual</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">InnerProductSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CompleteSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">PseudoMetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toUniformSpace</span>\n<span class=\"w\">  </span><span class=\"n\">MetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toEMetricSpace</span>\n<span class=\"w\">  </span><span class=\"n\">PseudoMetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toPseudoEMetricSpace</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">toDual</span>\n</code></pre></div>",
        "id": 478289077,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729604687
    },
    {
        "content": "<p>I cannot minimize this today, but is this indeed a bug and is it known?</p>",
        "id": 478289209,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729604722
    },
    {
        "content": "<p>As you probably noticed, reducing the last line makes the error go away. It may be a small UX bug, but maybe qualifies as ‚Äúyou get to keep both pieces‚Äù if you write a <code>variable</code> declaration that becomes invalid later in the same file. I‚Äôd suggest to not bother reporting unless it turns out to be often cause confusion</p>",
        "id": 478302727,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1729608493
    },
    {
        "content": "<p>this is another manifestation of the late elaboration of <code>variable</code> lines, I think there is at least one issue open about it</p>",
        "id": 478916154,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729861874
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/113488-general/topic/Command.20affects.20line.20before.20it/near/478302727\">said</a>:</p>\n<blockquote>\n<p>reducing the last line makes the error go away.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> Do you mean if I change the <code>#check</code> line to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">toDual</span>\n</code></pre></div>\n<p>?  The error is still present.</p>",
        "id": 479563758,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730235315
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> I tried to find the related issues you mentioned, but didn't find them with the obvious searches -- maybe the underlying issue is not well-reflected in the keywords used when the issues were filed.)</p>",
        "id": 479564719,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730235704
    },
    {
        "content": "<p>Maybe Joachim meant \"removing\" instead of \"reduced\"?</p>\n<p>The underlying issue is that <code>variable</code> re-elaborates from scratch on each definition. So, it's like you did</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">PseudoMetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toUniformSpace</span>\n<span class=\"w\">  </span><span class=\"n\">MetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toEMetricSpace</span>\n<span class=\"w\">  </span><span class=\"n\">PseudoMetricSpace</span><span class=\"bp\">.</span><span class=\"n\">toPseudoEMetricSpace</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">InnerProductSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CompleteSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">toDual</span>\n</code></pre></div>\n<p>Because the instances are removed, elaboration of <code>#check</code> fails. The <code>variable</code> command makes the assumption \"if elaborating this binder now works, it will keep working\", but as you see, removing instances is a way to break this assumption.</p>",
        "id": 479566473,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730236456
    },
    {
        "content": "<p>Here's another example of the assumption failing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"c1\">-- x : Fin (sorryAx ‚Ñï true)</span>\n</code></pre></div>",
        "id": 479566657,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730236558
    },
    {
        "content": "<p>Thanks Kyle, that's a helpful example!  In particular, I see that the issue was \"blunter\" than I realised.  I had assumed that the error on <code>[CompleteSpace E]</code> triggered by the use of <code>InnerProductSpace.toDual</code> had something to do with the fact that <code>toDual</code> itself has arguments <code>[NormedAddCommGroup E] [InnerProductSpace ùïú E] [CompleteSpace E]</code>.  But that's not the case -- changing the <code>#check</code> line to anything at all, for example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n</code></pre></div>\n<p>gives the same error.</p>",
        "id": 479581366,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730244188
    }
]