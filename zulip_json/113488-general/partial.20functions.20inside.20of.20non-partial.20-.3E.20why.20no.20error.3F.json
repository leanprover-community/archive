[
    {
        "content": "<p>why lean allows to write </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tryUsePartial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">tryUsePartial</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n</code></pre></div>\n<p>why it doesnt throw error <code>You should make  \"tryUsePartial\" partial too</code> ?</p>\n<p>Idris2 doesnt allow to use non-total functions inside of total, thus forcing user to keep track of safe and not-safe functions</p>",
        "id": 522894218,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1749300941
    },
    {
        "content": "<p>All I can say is that Lean is not Idris2 and it does allow this. If you want to make it infectious you should use <code>unsafe def infiniteLoop</code>.</p>",
        "id": 522894819,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749301692
    },
    {
        "content": "<p><code>infiniteLoop</code> is \"total\" but it just has a bunch of garbage values you can't prove anything about</p>",
        "id": 522918995,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749330549
    },
    {
        "content": "<p>I'm not an expert, but afaik this is sound in type theory as the function type is inhabited as opposed to e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n</code></pre></div>\n<p>which has type <code>{Œ± : Type*} ‚ÜíŒ±</code>.</p>\n<p>If the above would type check, it would allow the existence of a bottom element. Instead it fails with a useful error message:</p>\n<p>failed to compile 'partial' definition 'loop', could not prove that the type {Œ± : Sort u_1} ‚Üí Œ± is nonempty.</p>",
        "id": 522919751,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1749331621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706442\">Niklas Halonen</span></p>\n<p>But it will compile with this </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n</code></pre></div>",
        "id": 563294106,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765492369
    },
    {
        "content": "<p>Recently, I tried to figure out a reasonable interpretation for partial functions here: <a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/possible.20semantics.20for.20partial.20functions/near/562681988\">#general &gt; possible semantics for partial functions @ üí¨</a> <br>\nJust a few basic notes:</p>\n<ul>\n<li>If we don't want to trust the compiler with <code>native_decide</code>, then</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>is a logically consistent interpretation of any partial function. The kernel cannot see inside a partial definition.</p>\n<ul>\n<li>If we want to trust the compiler (which I believe should be in principle consistent without unsafe <code>[implemented_by]</code>), then a partial function can be interpreted as a function that runs for at most 10^100 (any number bigger than any feasible computation) steps, and if doesn't terminate by then, it returns again arbitrary value given by the choice axiom.</li>\n<li>I believe better interpretations are plausible too, I ponder about it in the entire linked thread.</li>\n</ul>",
        "id": 563297985,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765494427
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/522918995\">said</a>:</p>\n<blockquote>\n<p><code>infiniteLoop</code> is \"total\" but it just has a bunch of garbage values you can't prove anything about</p>\n</blockquote>\n<p>Hm</p>\n<p><a href=\"https://kowainik.github.io/posts/totality\">https://kowainik.github.io/posts/totality</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">terminology</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">totality</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">ambiguous</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">programming</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"bp\">-</span><span class=\"n\">cases</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">places</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"n\">functions</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">terminate</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">others</span><span class=\"w\"> </span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">inputs</span><span class=\"bp\">‚Äô</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>Ok, ok, seems like in lean \"total\" didn't imply \"terminates\"<br>\nThough In idris2 \"total\" <a href=\"https://idris2.readthedocs.io/en/latest/tutorial/theorems.html\">does imply</a> \"terminates\", \"covering\" doesn't</p>\n<hr>\n<p>Therefore:</p>\n<p>IIUC <code>patritial def</code> and <code>def</code> in lean == \"covering\" from Idris2. \"partial\" from Idris2 (some inputs are not mapped) is possible only in unsafe.</p>\n<p>Therefore <br>\nMe <span aria-label=\"flag ukraine\" class=\"emoji emoji-1f1fa-1f1e6\" role=\"img\" title=\"flag ukraine\">:flag_ukraine:</span>: I completely don't understand what is partial in <code>partial def</code>.<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>: \"<code>partial def</code> doesn't cover all inputs(?) <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span>\"?<br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>: No, it does. <span aria-label=\"stop\" class=\"emoji emoji-1f91a\" role=\"img\" title=\"stop\">:stop:</span><br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>: \"<code>partial def</code> doesn't terminate!<span aria-label=\"light bulb\" class=\"emoji emoji-1f4a1\" role=\"img\" title=\"light bulb\">:light_bulb:</span>\". <br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:  But <code>def</code> doesn't terminate too if <code>partial def</code> is used inside of <code>def</code>! <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span><br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:  Then why we don't mark <code>def</code>s that use <code>partial def</code>s inside with <code>partial</code> too? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span><br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:  Indeed! That's what I talk about!<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:  So why no?<br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:   because <a href=\"#narrow/channel/270676-lean4/topic/panics.20in.20runtime/near/505023305\">\"lean is not Idris\"</a> (?)<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:   that is not an answer!<br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:   yes. Ok. I assume lean developers (when they were implementing lean) have found that half of lean code depends on functions that are <code>partial def</code>. So they were just lazy to mark all of them with <code>partial</code> too like this is done in lean<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:   ok, seems like explanation. But anyway, they could implement it as annotation (like<code>@[unsafe_disable_termination_check]</code>) instead of  <code>partial def</code>, bc in my understanding annotations should be something that doesn't propagate and declaration modifiers should be something that propagates<br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:  Indeed! Look</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- 1. safe / total</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"c1\">-- 2. noncomputable</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">noncomp_id</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"bp\">‚Äπ_‚Ä∫</span>\n\n<span class=\"c1\">-- 3. unsafe</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unsafe_id</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"c1\">-- 4. partial</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">partial_loop</span><span class=\"w\">   </span><span class=\"c1\">-- diverges</span>\n\n<span class=\"c1\">-- 5. nonrec</span>\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nr_calls_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">  </span><span class=\"c1\">-- ‚ùó can use def inside of nonrec def, but I think should not allow</span>\n<span class=\"c1\">--nonrec def nr_calls_noncomp [Nonempty Nat] : Nat := noncomp_id -- cannot use noncomputable def inside of nonrec def, good üëç</span>\n<span class=\"c1\">--nonrec def nr_calls_unsafe : Nat := unsafe_id 5 -- same</span>\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nr_calls_partial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span><span class=\"w\"> </span><span class=\"c1\">-- ‚ùó can use partial def inside of nonrec def, but I think should not allow</span>\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nr_calls_nonrec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">def_calls_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">def_calls_nonrec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"c1\">-- can use nonrec def inside of def, good, nonrec is subset of def , good üëç</span>\n<span class=\"c1\">--def def_calls_noncomp : Nat := noncomp_id   -- ERROR: uses noncomputable üëç</span>\n<span class=\"c1\">--def def_calls_unsafe : Nat := unsafe_id 5   -- ERROR: uses unsafe üëç</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">def_calls_partial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span><span class=\"w\"> </span><span class=\"c1\">-- ‚ùócan use partial def inside of def, bad üòû, def should be a subset of partial def , not vice versa</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">part_calls_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"c1\">--partial def part_calls_noncomp [Nonempty Nat] : Nat := noncomp_id -- error üëç</span>\n<span class=\"c1\">--partial def part_calls_unsafe : Nat := unsafe_id 5 -- error üëç</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">part_calls_partial</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">part_calls_nonrec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">us_calls_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"c1\">--unsafe def us_calls_nc [Nonempty Nat] : Nat := noncomp_id -- error üëç</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">us_calls_unsafe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">us_calls_nonrec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">us_calls_partial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nc_calls_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">safe_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nc_calls_noncomp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">noncomp_id</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nc_calls_nonrec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonrec_id</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"c1\">--noncomputable def nc_calls_unsafe : Nat := unsafe_id 5 -- error üëç yes, better not to make unsafe a subset of noncomputable, better leave them parallel as is üëç</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">nc_calls_partial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">partial_loop</span>\n</code></pre></div>\n<p><code>unsafe</code> and <code>uncomputable</code> do propagate, and <code>nonrec</code> and <code>partial</code> do not. Really inconsistent!<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:   also would be good to add <code>terminates def</code> modifier?<br>\nTortoise<span aria-label=\"turtle\" class=\"emoji emoji-1f422\" role=\"img\" title=\"turtle\">:turtle:</span>:  no, if proposal above was implemented (\"all modifiers should propagate\"), then ordinary <code>def</code> would mean \"terminates\"<br>\nAchilles<span aria-label=\"foot\" class=\"emoji emoji-1f9b6\" role=\"img\" title=\"foot\">:foot:</span>:   oh,  right<span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> thnx</p>\n<hr>\n<p>Piramid of modifiers , top - more constraints, bottom - less</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"bp\">/</span><span class=\"w\">   </span><span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\">     </span><span class=\"bp\">\\</span><span class=\"w\">  </span><span class=\"c1\">-- no recursion is allowed, all inputs map to outputs, of course terminates</span>\n<span class=\"w\">     </span><span class=\"bp\">/</span><span class=\"w\">         </span><span class=\"kn\">def</span><span class=\"w\">            </span><span class=\"bp\">\\</span><span class=\"w\"> </span><span class=\"c1\">-- recursion is allowed, all inputs map to outputs, terminates</span>\n<span class=\"w\">  </span><span class=\"bp\">/</span><span class=\"w\">     </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\">             </span><span class=\"bp\">\\</span><span class=\"w\"> </span><span class=\"c1\">-- recursion is allowed, all inputs map to outputs, may not terminate for some inputs</span>\n<span class=\"bp\">/</span><span class=\"w\">     </span><span class=\"n\">unsafe</span><span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">noncomputable</span><span class=\"w\">     </span><span class=\"bp\">\\</span>\n</code></pre></div>",
        "id": 563314662,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765506287
    },
    {
        "content": "<p>there are two different ways a function is used here</p>",
        "id": 563316854,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508490
    },
    {
        "content": "<p>there's what the function does from the type theory's point of view and there's what the function does from the compiler's point of view</p>",
        "id": 563316886,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508518
    },
    {
        "content": "<p>from the compiler's point of view the function is compiled into something that will do exactly what you wrote in the code, and this may include calling itself recursively in an infinite loop</p>",
        "id": 563316994,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508618
    },
    {
        "content": "<p>from the type theory's point of view the function immediately halts with an arbitrary value, and this is why you need to prove <code>Nonempty</code> (so we know an arbitrary value exists, and adding the function as a constant to the type theory is sound).</p>",
        "id": 563317047,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508662
    },
    {
        "content": "<p><code>partial</code> is a marker that tells the elaborator to handle the function in this special way, where the kernel sees an <code>opaque</code> containing an arbitrary value and the compiler sees the actual code</p>",
        "id": 563317172,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508728
    },
    {
        "content": "<p>so it's not infectious because even if you use a <code>partial</code> function inside another function that doesn't mean that this new function should be handled in the same way, where it becomes an opaque constant to the typechecker but the compiler compiles it normally</p>",
        "id": 563317256,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508808
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563314662\">said</a>:</p>\n<blockquote>\n<p><code>unsafe</code> and <code>uncomputable</code> do propagate, and <code>nonrec</code> and <code>partial</code> do not. Really inconsistent!</p>\n</blockquote>\n<p>The <code>nonrec</code> modifier just means that if you mention the name of the declaration inside itself it will not try to resolve it as a recursive call, and instead will looks for other declarations in the environment that could fit. I don't really associate it with termination.</p>",
        "id": 563317534,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765509069
    },
    {
        "content": "<p>by the way you can also combine modifiers and get stuff like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Classical</span>\n<span class=\"c1\">-- since we use the axiom `Classical.choice` to construct data, this must be marked noncomputable</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- since this is `nonrec`, `choice` resolves to `Classical.choice`</span>\n<span class=\"w\">  </span><span class=\"c1\">-- instead of a recursive call to `Foo.choice`</span>\n<span class=\"w\">  </span><span class=\"n\">choice</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 563317712,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765509215
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563314662\">said</a>:</p>\n<blockquote>\n<p><code>unsafe</code> and <code>uncomputable</code> do propagate, and <code>nonrec</code> and <code>partial</code> do not. Really inconsistent!</p>\n</blockquote>\n<p>There is a reason for this! The <code>nonrec def</code>s do not propagate because they both check in the kernel and generate code in the compiler. The <code>partial def</code>s also do not propagate for the same reason, even though the kernel is getting some opaque junk values it still typechecks. But <code>noncomputable def</code> has to propagate because that means the compiler won't generate code for it, so if you call it somewhere else the compiler won't be able to generate code for that call either. And <code>unsafe def</code> also propagates because the kernel doesn't check those declarations, so if you use it in a new declaration then if you try to get the kernel check that new declaration it will not know about it and throw an \"unknown constant\".</p>",
        "id": 563318383,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765509821
    },
    {
        "content": "<p>Also, termination checking is only really relevant for compiling functions for the kernel. The compiler just calls the function recursively. But when you send a term to the kernel, you can't do that, because then it will be a circular proof. So the termination checker has to eliminate out all the recursive calls, and sometimes it's not smart enough to do that automatically so you get an error.</p>",
        "id": 563318573,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765509989
    },
    {
        "content": "<p>Here's an example of how the type theory point of view and compiler point of view can come apart:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"c1\">-- we can prove foo is 37</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- but we can't evaluate it</span>\n<span class=\"c1\">-- #eval foo</span>\n</code></pre></div>",
        "id": 563528465,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765560643
    },
    {
        "content": "<p>behavior like this is why the <code>partial</code> keyword can be confusing for some people, I think... it can seem a bit unintuitive</p>\n<p>but it also illustrates why it wouldn't make sense for <code>partial</code> to propagate: <code>loop</code> doesn't halt and we can't prove anything about the value, but we <em>can</em> prove something about the value of <code>foo</code> even though it calls <code>loop</code></p>",
        "id": 563529120,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765560852
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563317534\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563314662\">said</a>:</p>\n<blockquote>\n<p><code>unsafe</code> and <code>uncomputable</code> do propagate, and <code>nonrec</code> and <code>partial</code> do not. Really inconsistent!</p>\n</blockquote>\n<p>The <code>nonrec</code> modifier just means that if you mention the name of the declaration inside itself it will not try to resolve it as a recursive call, and instead will looks for other declarations in the environment that could fit. I don't really associate it with termination.</p>\n</blockquote>\n<p>Really wish we could do away with <code>nonrec</code>, causes more confusion than it solves</p>",
        "id": 563546719,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1765567471
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hern√°ndez</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563546719\">said</a>:</p>\n<blockquote>\n<p>Really wish we could do away with <code>nonrec</code>, causes more confusion than it solves</p>\n</blockquote>\n<p>In book Godel Escher Bach there is distinction between Bloop (bounded loop, can use only <code>for i from 0 to 100</code> for example) and Floop (free loop, can use recursion)</p>\n<p>Basically iiuc bloop is same as \"my function doesn't use .rec axiom inside\"</p>\n<p>Therefore I think <code>nonrec</code> is useful</p>\n<hr>\n<p>Is <code>nonrec</code> == \"Bloop\"</p>\n<ol>\n<li>Can use recursivity? No <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </li>\n<li>Can use .rec? </li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooToNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>This type checks but this is not a recursive program. So, ok?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooDepth</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fooDepth</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- correctly doesn't type check</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooDepth'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">rec</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- type checks, though this is a recursive program. Maybe in future this will be disallowed?</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>Only nonrec/bloop can be called inside of nonrec/bloop</li>\n</ol>\n<p>No, this is allowed</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooDepth</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fooDepth</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fooDepth2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fooDepth</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Summary: ok, I am confused about usefulness of nonrec myself. It's not the \"only Bloop axioms are here\". </p>\n<p>Is it for kernel? \"Kernel cannot accept circular proofs\"? Then why can use <code>def</code> inside of <code>nonrec def</code>?</p>",
        "id": 563589846,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765597975
    },
    {
        "content": "<p>I can't say for sure but I thought that <code>nonrec</code> was sometimes used to prevent variable shadowing, where the name of the function is potentially shadowing another function with the same name</p>\n<p>for example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"c1\">-- removing `nonrec` causes a \"fail to show termination\" error</span>\n<span class=\"n\">nonrec</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 563590475,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765598759
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563589846\">said</a>:</p>\n<blockquote>\n<p>Summary: ok, I am confused about usefulness of nonrec myself. It's not the \"only Bloop axioms are here\". </p>\n</blockquote>\n<p>The only thing that <code>nonrec</code> does it that it removes the ability for that definition to reference itself. Then, for example, if you use the name of the definition inside its own body it will not try to interpret that as a recursive call. It does not however prevent you from doing recursion in a different way, for example calling another function which is itself recursive.</p>",
        "id": 563590902,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765599233
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563589846\">said</a>:</p>\n<blockquote>\n<p>Basically iiuc bloop is same as \"my function doesn't use .rec axiom inside\"</p>\n</blockquote>\n<p>Without the recursor you can't really define any nontrivial functions though</p>",
        "id": 563591185,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765599469
    },
    {
        "content": "<p>There are very similar differences between <code>let</code> and <code>letrec</code> in other languages, where <code>let</code> doesn't allow recursion (but you can still call other recursive functions, and in particular you can use functions defined by <code>letrec</code>). This keyword has nothing to do with restricting the program, but rather to prevent accidental recursion due to having the same name.</p>",
        "id": 563597213,
        "sender_full_name": "Trebor Huang",
        "timestamp": 1765606392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"380294\">Matt Diamond</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563528465\">said</a>:</p>\n<blockquote>\n<p>Here's an example of how the type theory point of view and compiler point of view can come apart:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"c1\">-- we can prove foo is 37</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- but we can't evaluate it</span>\n<span class=\"c1\">-- #eval foo</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Your example is superb. (And sad. Because aren't we lying? As <span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563317047\">said</a> \"from the type theory's point of view the function immediately halts with an arbitrary value\")</p>\n<p>How to fix it? Are there known or emerging advances in programming language theory which could help to join \"type theory point of view and compiler point of view\"</p>\n<p>Maybe monadic/effect-based tracking of partiality? Cannot have <code>partial def loop : N</code> but only <code>partial def loop : Partial N</code>?</p>",
        "id": 563648593,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765662872
    },
    {
        "content": "<p>What behavior would you like to see in this case? Would you prefer that we can't prove <code>foo = 37</code>?</p>",
        "id": 563649799,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765664336
    },
    {
        "content": "<p>I'm not sure why you say we're lying... <span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> didn't say that the function halts with a different arbitrary value each time, even when called with the same arguments</p>",
        "id": 563649861,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765664418
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563648593\">said</a>:</p>\n<blockquote>\n<p>(And sad. Because aren't we lying? As <span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563317047\">said</a> \"from the type theory's point of view the function immediately halts with an arbitrary value\")</p>\n</blockquote>\n<p>From the type theory point of view, <code>loop</code> is an arbitrary value of type <code>‚Ñï ‚Üí ‚Ñï</code>. And then <code>foo</code> is defined as <code>loop 37 - loop 37 + 37</code>. We can't show what value <code>loop 37</code> is, but that doesn't matter here, because no matter what value it has <code>loop 37 - loop 37</code> will be <code>0</code>, and this is a property of subtraction on the natural numbers. Then <code>foo = loop 37 - loop 37 + 37 = 0 + 37 = 37</code>. So I'm not sure where you think the lying is.</p>",
        "id": 563650171,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765664782
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"380294\">Matt Diamond</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563649799\">said</a>:</p>\n<blockquote>\n<p>What behavior would you like to see in this case? Would you prefer that we can't prove <code>foo = 37</code>?</p>\n</blockquote>\n<p>No, it should prove.</p>\n<p><code>Small infinity  - same small infinity + 37</code> equals <code>37</code></p>",
        "id": 563651216,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765666096
    },
    {
        "content": "<p>I don't know what you mean by \"small infinity\" but <code>loop 37</code> is not infinite (at least not in the type-theoretical sense)</p>",
        "id": 563651272,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765666191
    },
    {
        "content": "<p>perhaps what you're saying is that you'd like it to be infinite because it appears to be the \"output\" of an infinite loop?</p>",
        "id": 563651372,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765666324
    },
    {
        "content": "<p>you can't even prove <code>loop 37 ‚â† 0</code></p>",
        "id": 563651556,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765666652
    },
    {
        "content": "<p>it's completely arbitrary</p>",
        "id": 563651566,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765666662
    },
    {
        "content": "<p>but it's definitely a <strong>finite</strong> number</p>",
        "id": 563651589,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765666705
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563651589\">said</a>:</p>\n<blockquote>\n<p>but it's definitely a <strong>finite</strong> number</p>\n</blockquote>\n<p>Infinite loop results in finite number? In math? In our universe? Or just in lean? Wow,  that should be deep insight about our universe. Could You tell more?</p>",
        "id": 563652630,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765668316
    },
    {
        "content": "<p>I see why you might think that, but it's not like the output of an infinite loop must be the number of times it ran.</p>\n<p>What if the code was <code>loop n = -loop n</code>? Would that output positive infinity or negative infinity?<br>\nWhat if the code was <code>loop n = 1 / loop n</code>? Would that output zero? (Zero isn't infinite!)</p>",
        "id": 563652999,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765668970
    },
    {
        "content": "<p>Consider that the sum of <code>1 / n!</code> as n goes to infinity (an infinite process of addition) is ultimately a finite number: the constant <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi></mrow><annotation encoding=\"application/x-tex\">e</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">e</span></span></span></span></p>",
        "id": 563653060,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765669080
    },
    {
        "content": "<p>math is filled with instances where infinite processes have finite results when the result is evaluated \"at the limit\", so \"infinite loop results in finite number\" does happen often in math</p>",
        "id": 563653137,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765669175
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"813382\">Serhii Khoma (srghma)</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563652630\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563651589\">said</a>:</p>\n<blockquote>\n<p>but it's definitely a <strong>finite</strong> number</p>\n</blockquote>\n<p>Infinite loop results in finite number? In math? In our universe? Or just in lean? Wow,  that should be deep insight about our universe. Could You tell more?</p>\n</blockquote>\n<p>It's not anything deep. It's just that the function is <code>‚Ñï ‚Üí ‚Ñï</code>, so when you plug in <code>37 : ‚Ñï</code> the output has to be a <code>‚Ñï</code>, and all <code>‚Ñï</code>s are finite. There's no infinite processes going on here.</p>",
        "id": 563653243,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765669355
    },
    {
        "content": "<p>and it's definitely not evaluating any kind of infinite loop, or any loop at all</p>",
        "id": 563653327,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765669516
    },
    {
        "content": "<p>I think the fact that <code>partial</code> propagates also has to do with convenience. Usually, when writing <code>partial</code> functions, you'd expect the function to indeed terminate but you don't want to go through the work of adding termination proofs and preconditions and everything. So if you have some larger codebase and you've avoided calling partial functions until now but now you added a new function that you don't want to prove terminates and just use <code>partial</code>, you don't want to need to go through the entire codebase again adding <code>partial</code> to every function. So the compromise was just to make <code>partial</code> definitions opaque to proofs so you can't prove contradictory things with it, but also still make them exist as regular definitions so you can use them without needing to use <code>partial</code>.</p>",
        "id": 563653779,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765670349
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563653779\">said</a>:</p>\n<blockquote>\n<p>I think the fact that <code>partial</code> propagates </p>\n</blockquote>\n<p>You probably meant \"doesn't propagate\"</p>\n<blockquote>\n<p>you don't want to need to go through the entire codebase again adding partial to every function </p>\n</blockquote>\n<p>I want. I do want to separate wheat from chaff. Totally safe from maybe unsafe. Idris does this.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563653243\">said</a>:</p>\n<blockquote>\n<p>It's just that the function is <code>‚Ñï ‚Üí ‚Ñï</code>, so when you plug in <code>37 : ‚Ñï</code> the output has to be a <code>‚Ñï</code>, and all <code>‚Ñï</code>s are finite.</p>\n</blockquote>\n<p>So it's a lie. A lie that exists in lean only because our civilization is not developed enough and doesn't know how to type \"infinitely looping functions\". A lie that \"loop returns number\". If anything, it's more similar that it returns <code>Partial Nat</code> instead of <code>Nat</code> (<code>inductive Partial a = DidntTermate | DidTerminate a; def loop (n : Nat) : Partial Nat := loop (n + 1)</code>). This encoding too preserves the required <code>loop n should not be equal to -loop n</code> etc. But I don't know solution. I'm an amature.</p>",
        "id": 563654936,
        "sender_full_name": "Serhii Khoma (srghma)",
        "timestamp": 1765672085
    },
    {
        "content": "<p>personally I don't think the way Lean handles partial functions is related at all to the development of our civilization</p>",
        "id": 563655305,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765672691
    },
    {
        "content": "<p>though I'm sorry if the behavior of this software is causing you frustration... perhaps it's not ideal for your purposes</p>",
        "id": 563655425,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1765672910
    },
    {
        "content": "<p>well that's just how <code>partial</code> works</p>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/partial.20functions.20inside.20of.20non-partial.20-.3E.20why.20no.20error.3F/near/563317047\">said</a>:</p>\n<blockquote>\n<p>from the type theory's point of view the function immediately halts with an arbitrary value, and this is why you need to prove <code>Nonempty</code> (so we know an arbitrary value exists, and adding the function as a constant to the type theory is sound).</p>\n</blockquote>",
        "id": 563655870,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765673739
    },
    {
        "content": "<p>sort of a compromise where it's not <code>unsafe</code> but you can't prove anything nontrivial about it</p>",
        "id": 563655910,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765673813
    },
    {
        "content": "<p>I think you're implicitly expecting <code>partial</code> to be keeping track of the side effects (which should be infective unless handled explicitly) instead of a keyword for the logical soundness. We know using partial functions is logically sound, so it doesn't need to be infective. Using axioms though are not, so we have commands to print the axioms a definition uses, which is indeed infective.</p>",
        "id": 563656012,
        "sender_full_name": "Trebor Huang",
        "timestamp": 1765673929
    },
    {
        "content": "<p>To be fair, it's not too hard to find out whether a function depends on a partial function, you can use <code>#print opaques</code> for this purpose:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">PrintOpaques</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ohNo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ohNo</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">badDefinition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ohNo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"sd\">/-- info: 'badDefinition' depends on opaque or partial definitions: [ohNo] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">opaques</span><span class=\"w\"> </span><span class=\"n\">badDefinition</span>\n</code></pre></div>\n<p>And if you wanted, you could also add attributes and linters and whatnot for yourself that provide errors when you use a partial function</p>",
        "id": 563706350,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765738746
    },
    {
        "content": "<p>I think the better way to think of <code>partial</code> is not as a viral marker indicating a nontermination effect, as mentioned, but rather as a special kind of <code>opaque</code>. It is indicating that the body of the function is not provably equal to the function itself, and this property (of not equaling your body) is non-viral.</p>\n<p>In fact, now that I say it, I think it might actually make sense to make <code>partial def</code> an error and force people to write <code>partial opaque</code> instead, to make this explicit.</p>",
        "id": 563839218,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1765809172
    }
]