[
    {
        "content": "<p>I'm not sure why these should be semantically different, but they are? Unsure if I'm just really misunderstanding things. Could someone clarify why this works the way it does or if I'm holding it wrong?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">TypeError</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This does not work</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Results in bindings getting lost</span>\n<span class=\"w\">  </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/3121/Y_SYdj8s6OHJ4To6QsoXZhra/image.png\">image.png</a><br>\n(This is the bind that <code>locally'</code> desugars</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Y_SYdj8s6OHJ4To6QsoXZhra/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1134x304\" src=\"/user_uploads/thumbnail/3121/Y_SYdj8s6OHJ4To6QsoXZhra/image.png/840x560.webp\"></a></div>",
        "id": 571941284,
        "sender_full_name": "Aaron Eline",
        "timestamp": 1770218910
    },
    {
        "content": "<p>I wanted to try out the code on <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a> but cannot get it to compile. Do you have an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> with imports?</p>",
        "id": 571961108,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1770223607
    },
    {
        "content": "<p>Here is a mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This does not work</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Results in bindings getting lost</span>\n<span class=\"w\">  </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">some_computation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">higher</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">locally</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some_computation</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">higher'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">locally'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some_computation</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">top</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">higher</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">top'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">higher'</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">top</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">top'</span>\n</code></pre></div>",
        "id": 572039170,
        "sender_full_name": "Aaron Eline",
        "timestamp": 1770252429
    },
    {
        "content": "<p>Using <code>#print</code> you can see you got</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>where that <code>liftM</code> is probably causing trouble</p>",
        "id": 572047167,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770258044
    },
    {
        "content": "<p><code>liftM k</code> has type <code>ReaderT Nat M α</code></p>",
        "id": 572048251,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770258910
    },
    {
        "content": "<p>so you've added on an additional <code>Nat</code> reader state which is then immediately discarded by <code>liftM</code></p>",
        "id": 572048290,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770258932
    },
    {
        "content": "<p>Sure, but _why_, is the <code>do</code> notation behaving weird here? <code>ReaderT.run k (f e)</code> and <code>k (f e)</code> reduce to the same thing, so why is using inside <code>do</code> changing things?</p>",
        "id": 572051600,
        "sender_full_name": "Aaron Eline",
        "timestamp": 1770261681
    },
    {
        "content": "<p><code>k (f env)</code> has type <code>Option α</code> so it inserts a coercion and you get <code>liftM (k (f env))</code></p>",
        "id": 572052351,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770262229
    },
    {
        "content": "<p><code>k (f env) </code> is the one that produces the correct results?</p>",
        "id": 572052409,
        "sender_full_name": "Aaron Eline",
        "timestamp": 1770262267
    },
    {
        "content": "<p><code>ReaderT.run k (f e)</code> has an expected type <code>M α</code> so it elaborates the argument <code>k</code> with expected type <code>ReaderT Nat M α</code></p>",
        "id": 572052444,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770262290
    },
    {
        "content": "<p>so the coercion is inserted inside</p>",
        "id": 572052451,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770262297
    },
    {
        "content": "<p>this doesn't happen with <code>k (f env)</code> because the type of <code>k</code> doesn't have any holes in it so having an expected type doesn't change your elaboration</p>",
        "id": 572052511,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770262337
    },
    {
        "content": "<p>so it works if you elaborate <code>ReaderT.run k (f e)</code> without an expected type</p>",
        "id": 572052575,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770262374
    },
    {
        "content": "<p>Is the claim here that this is a type inference issue, then? Somehow inference is assuming <code>ReaderT.run</code> is running a different reader monad, which is inserted via coercion, rather than running the reader that it seems like it should be running? This seems like pretty unintuitive behavior</p>",
        "id": 572053372,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1770262827
    },
    {
        "content": "<p>If you write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">locally'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:)</span>\n</code></pre></div>\n<p>then it does what you expect</p>",
        "id": 572067997,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770271973
    },
    {
        "content": "<p>Otherwise the coercion gets inserted in the wrong place</p>",
        "id": 572068006,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770271982
    },
    {
        "content": "<p>At any rate, you're looking for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=withTheReader#doc\">docs#withTheReader</a> I think</p>",
        "id": 572068087,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770272038
    },
    {
        "content": "<p>I love that if you just write a little smiley face it works correctly! :)</p>\n<p>Do we think there's any hope of making this behavior more intuitive / less error-prone? I don't think the code that Aaron wrote was particularly arcane — an average user could totally run into this and write some pretty hard-to-find bugs. Would a change to the implicit arguments of <code>run</code> help? Or maybe some kind of warning on <code>do</code> elaboration? I realize that this behavior is consistent with the rest of Lean, so it's not a bug in that sense, but I would call this behavior \"incorrect\" from the perspective of most reasonable end-users</p>",
        "id": 572139196,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1770295789
    },
    {
        "content": "<p>One thing that I think would help is changing <code>ReaderT</code> (and stateT etc) to a structure along the lines of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>",
        "id": 572184807,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770306387
    },
    {
        "content": "<p>Chiming in that I did in fact find this behavior baffling, as someone who's relatively used to writing monadic code in ocaml/haskell. Took me a bit to find the workaround I did.</p>",
        "id": 572184824,
        "sender_full_name": "Aaron Eline",
        "timestamp": 1770306391
    },
    {
        "content": "<p>Maybe <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> knows if that change would result in worse compilation output</p>",
        "id": 572184978,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770306426
    },
    {
        "content": "<p>It shouldn't, no</p>",
        "id": 572187881,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1770306994
    },
    {
        "content": "<p>It would?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReaderTStruct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">trace: [Compiler.IR] [result]</span>\n<span class=\"sd\">    def testStruct._lam_0 (x_1 : @&amp; tobj) : tobj :=</span>\n<span class=\"sd\">      inc x_1;</span>\n<span class=\"sd\">      ret x_1</span>\n<span class=\"sd\">    def testStruct._lam_0._boxed (x_1 : tobj) : tobj :=</span>\n<span class=\"sd\">      let x_2 : tobj := testStruct._lam_0 x_1;</span>\n<span class=\"sd\">      dec x_1;</span>\n<span class=\"sd\">      ret x_2</span>\n<span class=\"sd\">[Compiler.IR] [result]</span>\n<span class=\"sd\">    def testStruct._closed_0 : obj :=</span>\n<span class=\"sd\">      let x_1 : obj := pap testStruct._lam_0._boxed;</span>\n<span class=\"sd\">      ret x_1</span>\n<span class=\"sd\">    def testStruct : obj :=</span>\n<span class=\"sd\">      let x_1 : obj := testStruct._closed_0;</span>\n<span class=\"sd\">      ret x_1</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testStruct</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReaderTStruct</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">trace: [Compiler.IR] [result]</span>\n<span class=\"sd\">    def test (x_1 : @&amp; tobj) : tobj :=</span>\n<span class=\"sd\">      inc x_1;</span>\n<span class=\"sd\">      ret x_1</span>\n<span class=\"sd\">    def test._boxed (x_1 : tobj) : tobj :=</span>\n<span class=\"sd\">      let x_2 : tobj := test x_1;</span>\n<span class=\"sd\">      dec x_1;</span>\n<span class=\"sd\">      ret x_2</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p><code>ReaderTStruct</code> forces the compiler to allocate a closure</p>",
        "id": 572188279,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1770307069
    },
    {
        "content": "<p>At least, with the current state of the compiler</p>",
        "id": 572188563,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1770307123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Weird.20issue.20with.20do.20notation.2Freader.20monad/near/572184807\">said</a>:</p>\n<blockquote>\n<p>One thing that I think would help is changing <code>ReaderT</code> (and stateT etc) to a structure along the lines of</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I'm not sure this would help?</p>",
        "id": 572266250,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770333351
    }
]