[
    {
        "content": "<p>Should I expect <code>lean-egg</code> to deal with induction? Consider the following example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- lean-toolchain is leanprover/lean4:v4.20.0-rc5</span>\n<span class=\"c1\">-- lean-egg is 0d83ada</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Egg</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"n\">nat_basket</span><span class=\"w\"> </span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">MyNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\">  </span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- a proof not using egg</span>\n<span class=\"w\">  </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_suc</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp_all!</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"o\">]</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  theorem MyNat.add_suc : ∀ {x y : MyNat}, x.add y.suc = (x.add y).suc :=</span>\n<span class=\"sd\">  fun {x y} =&gt;</span>\n<span class=\"sd\">    rec (of_eq_true (eq_self y.suc))</span>\n<span class=\"sd\">      (fun x' ih =&gt;</span>\n<span class=\"sd\">        of_eq_true (Eq.trans (congrArg (fun x =&gt; x.suc = (x'.add y).suc.suc) ih) (eq_self (x'.add y).suc.suc)))</span>\n<span class=\"sd\">      x</span>\n<span class=\"sd\">  -/</span>\n\n<span class=\"w\">  </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_suc_egg</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"n\">nat_basket</span>\n<span class=\"w\">  </span><span class=\"c1\">-- egg failed to prove the goal (saturated)</span>\n\n<span class=\"w\">  </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_suc_egg_2</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\">      </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"n\">nat_basket</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"n\">nat_basket</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- success, so clearly egg needs `MyNat.rec`</span>\n\n<span class=\"w\">  </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_suc_egg_3</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">egg</span><span class=\"w\"> </span><span class=\"n\">nat_basket</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- egg requires premises to be (proofs of) propositions or (non-propositional) definitions</span>\n</code></pre></div>\n<p>So the first problem I encounter is that the automatically generated recursors for inductive types are not accepted by <code>egg</code> because <code>motive</code> always has codomain <code>Sort u</code> rather than <code>Prop</code>.</p>",
        "id": 517974129,
        "sender_full_name": "Adam Layne",
        "timestamp": 1747201009
    },
    {
        "content": "<p>This can be fixed by defining a new term constraining the codomain to be <code>Prop</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myNatRec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Unfortunately, providing this to <code>egg</code> also gives <code>egg failed to prove the goal (saturated)</code>.</p>\n<p>I suppose the problem could be that <code>myNatRec</code> is not an equation.</p>",
        "id": 517975884,
        "sender_full_name": "Adam Layne",
        "timestamp": 1747202038
    },
    {
        "content": "<p>Most tactics cannot synthesize induction predicates and do not include induction in their search space. This kind of problem is exactly what Canonical was designed for.</p>",
        "id": 517986078,
        "sender_full_name": "Chase Norman",
        "timestamp": 1747206475
    },
    {
        "content": "<p>Yeah, this is not expected to work with lean-egg. You can think of the <code>egg</code> tactic more as something like <code>simp</code>.</p>",
        "id": 517991730,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1747208304
    },
    {
        "content": "<p>I'm not sure how the comment \"<code>clearly egg needs MyNat.rec</code>\" is meant, but just to clear up potential confusion: When you tag <code>add</code> with <code>@[egg nat_basket]</code>, this adds the following two rewrites to the egg basket:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span>\n<span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;=&gt;</span><span class=\"w\"> </span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>That is, egg doesn't know about <code>MyNat.rec</code>.</p>",
        "id": 517992708,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1747208628
    },
    {
        "content": "<p>When you use <code>myNatRec</code>, the problem is that <code>egg</code> can't prove the conditions of the induction principle. That is, <code>myNatRec</code> is turned into the following conditional rewrite:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">?</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">if</span>\n<span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">suc</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>... but <code>egg</code> can neither discover the motive <code>?p</code>, nor prove these conditions.</p>",
        "id": 517995344,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1747209491
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/113488-general/topic/lean-egg.20and.20induction/near/517992708\">said</a>:</p>\n<blockquote>\n<p>I'm not sure how the comment \"<code>clearly egg needs MyNat.rec</code>\" is meant</p>\n</blockquote>\n<p>I just mean that any proof of this theorem involves <code>MyNat.rec</code>.</p>",
        "id": 518089445,
        "sender_full_name": "Adam Layne",
        "timestamp": 1747234631
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"671363\">Adam Layne</span> has marked this topic as resolved.</p>",
        "id": 521398652,
        "sender_full_name": "Notification Bot",
        "timestamp": 1748658922
    }
]