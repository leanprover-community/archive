[
    {
        "content": "<p>I'm trying to make a dsl that piggy backs off of lean's do notation. I'm wondering how I can give it precendence just like do notation. Namely you can write <code>Id.run do ....</code> instead of <code>Id.run (do ...)</code>. Here is the code I have so far: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"c1\">-- Declare syntax categories for cSeq and cItem</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cSeq</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cItem</span>\n<span class=\"c1\">-- Syntax for C-style integer declaration (creates a mutable variable)</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cItem</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cItem</span><span class=\"w\"> </span><span class=\"c1\">-- for debugging purposes only (shouldn't need this once dsl is fully defined)</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cItem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cSeq</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cItem</span><span class=\"w\"> </span><span class=\"n\">cSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cSeq</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"c_do\"</span><span class=\"w\"> </span><span class=\"n\">cSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">cSeq</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">womp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I want to be able to write <code>Id.run c_do int x = 0; return 0</code></p>",
        "id": 504729827,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741662381
    },
    {
        "content": "<p>If you're willing to use <code>notation</code>, then I think this may do what you want:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"s2\">\"RUN \"</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">r</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">womp'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">RUN</span><span class=\"w\"> </span><span class=\"n\">c_do</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 504730595,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1741662907
    },
    {
        "content": "<p>how does <code>do</code> do it?</p>",
        "id": 504730627,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741662950
    },
    {
        "content": "<p>(the $ probably isn't necessary in the notation)</p>\n<blockquote>\n<p>how does <code>do</code> do it?</p>\n</blockquote>\n<p>Oh that's a good question, I have no idea! :)</p>",
        "id": 504730702,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1741662990
    },
    {
        "content": "<p>mb we need a wiz like <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span></p>",
        "id": 504730726,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741663012
    },
    {
        "content": "<p>actually ive switched more this approach </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"if\"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- unexpected token '='; expected ')'</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>can some one pls explain why <code>$x := $y</code> doesnt work as a doElem?</p>",
        "id": 504737544,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741666965
    },
    {
        "content": "<p>You should have precedences on the <code>syntax</code> declaration, just like in <code>notation</code></p>",
        "id": 504865625,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741704927
    },
    {
        "content": "<p>the invocation that will give you the same precedence as lean's <code>do</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"s2\">\"c_do\"</span><span class=\"w\"> </span><span class=\"n\">cSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>",
        "id": 504866568,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741705105
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"676310\">Frederick Pu</span> <a href=\"#narrow/channel/113488-general/topic/precendence.20for.20do.20style.20dsls/near/504737544\">said</a>:</p>\n<blockquote>\n<p>can some one pls explain why <code>$x := $y</code> doesnt work as a doElem?</p>\n</blockquote>\n<p>you need to give it a \"type\", <code>$x:ident</code>, because it's inferring <code>$x:doElem</code> which doesn't permit a <code>:=</code> after it</p>",
        "id": 504867253,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741705239
    },
    {
        "content": "<p>but it's alrady <code>$x:ident</code> in match statement. What's the reason for this?</p>",
        "id": 504870426,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741705910
    },
    {
        "content": "<p>That’s the golden rule of antiquotations: if Lean is unhappy, add a type annotation even if it looks obvious.</p>",
        "id": 504871791,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1741706195
    },
    {
        "content": "<p>They really don’t work like type annotations in ordinary Lean code.</p>",
        "id": 504871908,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1741706222
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"676310\">Frederick Pu</span> <a href=\"#narrow/channel/113488-general/topic/precendence.20for.20do.20style.20dsls/near/504870426\">said</a>:</p>\n<blockquote>\n<p>but it's alrady <code>$x:ident</code> in match statement. What's the reason for this?</p>\n</blockquote>\n<p>The parser runs before typechecking, so it does not have the ability to propagate the type information while still parsing the syntax inside the quotation</p>",
        "id": 504889446,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709493
    },
    {
        "content": "<p>but ident is a syntax category right?</p>",
        "id": 504889688,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741709533
    },
    {
        "content": "<p>yes but the fact that <code>x</code> is a binding for an ident in that context is typing information</p>",
        "id": 504889802,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709558
    },
    {
        "content": "<p>specifically, you can see that <code>x</code> has type <code>TSyntax ident</code> in the context</p>",
        "id": 504889967,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709592
    },
    {
        "content": "<p>when you use the syntax <code>$x</code>, this is ambiguous to the parser regarding what syntax class it is supposed to be acting like</p>",
        "id": 504890381,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709672
    },
    {
        "content": "<p>and it would need to know the type of <code>x</code> to get the answer right in all situations</p>",
        "id": 504890460,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709690
    },
    {
        "content": "<p>so instead it just has a heuristic which is wrong a good chunk of the time</p>",
        "id": 504890605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709717
    },
    {
        "content": "<p>in this case that heuristic guesses that <code>$x</code> is a doElem</p>",
        "id": 504890697,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709734
    },
    {
        "content": "<p>you override the heuristic by using the form <code>$x:cat</code> instead</p>",
        "id": 504890785,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709752
    },
    {
        "content": "<p>As Patrick says, it's not really a type annotation in the same sense as in regular lean code, because rather than using inference if you don't supply the type it uses a local heuristic (basically it looks at the first syntax category the current parser would consume at this point)</p>",
        "id": 504891381,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741709860
    },
    {
        "content": "<p>now im trying to make a macro for for loops. Any way to enforce that the first and second i is the same? </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"if\"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"for\"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"++\"</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"bp\">++</span><span class=\"o\">){</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 504896484,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741710873
    },
    {
        "content": "<p>i ended up fixing it like this: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"if\"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"for\"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"s2\">\"int\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"++\"</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">doElem</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"bp\">++</span><span class=\"o\">){</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"i's must match\"</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">womp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">){</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"bp\">++</span><span class=\"o\">){</span>\n<span class=\"w\">      </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">womp</span>\n</code></pre></div>\n<p>how do i make the linter error for unused variable apply all of the j's that occur in the for declaration?<br>\n<a href=\"/user_uploads/3121/uQXcsm9tJ3FZvMRr1pgb-K1E/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/uQXcsm9tJ3FZvMRr1pgb-K1E/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"662x300\" src=\"/user_uploads/thumbnail/3121/uQXcsm9tJ3FZvMRr1pgb-K1E/image.png/840x560.webp\"></a></div>",
        "id": 504910910,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741714737
    },
    {
        "content": "<p>it's easier to do that in an elab rather than a macro. In a macro you can fake it by having some spurious syntax that contains a use of the variable but elaborates to nothing, like <code>haveI := j; e</code> stuck before some subexpression</p>",
        "id": 504924346,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718431
    },
    {
        "content": "<p>can u give an example?</p>",
        "id": 504924493,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741718491
    },
    {
        "content": "<p>something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 504924785,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718563
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"bp\">++</span><span class=\"o\">){</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"i's must match\"</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span>\n<span class=\"cm\">      application type mismatch</span>\n<span class=\"cm\">        seq.raw</span>\n<span class=\"cm\">      argument</span>\n<span class=\"cm\">        seq</span>\n<span class=\"cm\">      has type</span>\n<span class=\"cm\">        TSyntax `Lean.Parser.Term.doSeq : Type</span>\n<span class=\"cm\">      but is expected to have type</span>\n<span class=\"cm\">        TSyntax `term : Type</span>\n<span class=\"cm\">      All Messages (4)</span>\n<span class=\"cm\">    -/</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 504925432,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741718732
    },
    {
        "content": "<p>semicolon?</p>",
        "id": 504925578,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718767
    },
    {
        "content": "<p>possibly also nested <code>do</code></p>",
        "id": 504925608,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718778
    },
    {
        "content": "<p>like <code>... do let := ($i1, $i2); do $seq</code></p>",
        "id": 504925656,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718793
    },
    {
        "content": "<p>what does the second <code>do</code> do?</p>",
        "id": 504925788,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741718826
    },
    {
        "content": "<p>it makes the doSeq into a doElem</p>",
        "id": 504925817,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741718840
    },
    {
        "content": "<p>now i get no linter errors at all</p>",
        "id": 504926113,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741718921
    },
    {
        "content": "<p>this works better:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"bp\">++</span><span class=\"o\">){</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"i's must match\"</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 504926626,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719078
    },
    {
        "content": "<p>i think the issue before is since all three <code>ident</code> are identical so the <code>ident</code> is actually getting used</p>",
        "id": 504926764,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719122
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/hJu4qNaAn1EilD6re162HYt6/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/hJu4qNaAn1EilD6re162HYt6/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"657x270\" src=\"/user_uploads/thumbnail/3121/hJu4qNaAn1EilD6re162HYt6/image.png/840x560.webp\"></a></div>",
        "id": 504927388,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719308
    },
    {
        "content": "<p>but that breaks the semantics tho</p>",
        "id": 504927748,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719419
    },
    {
        "content": "<p>oh, I thought you wanted to get no linter error because it is actually used twice</p>",
        "id": 504928723,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741719661
    },
    {
        "content": "<p>hmm i never thought about it like that</p>",
        "id": 504929032,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719737
    },
    {
        "content": "<p>what about this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"bp\">++</span><span class=\"o\">){</span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"i's must match\"</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">doElem</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range'</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 504929087,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719754
    },
    {
        "content": "<p>is the <code>x</code> that i use guaranteed to be a new variable?</p>",
        "id": 504929166,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719775
    },
    {
        "content": "<p>actually it doesnt work cause one of the idents gets shadowed</p>",
        "id": 504929344,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719822
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/4Ip-mi4w2RlqAej5lp2hnLvO/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/4Ip-mi4w2RlqAej5lp2hnLvO/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"697x252\" src=\"/user_uploads/thumbnail/3121/4Ip-mi4w2RlqAej5lp2hnLvO/image.png/840x560.webp\"></a></div>",
        "id": 504929560,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719867
    },
    {
        "content": "<p>wait if the idents are considered different then why does your original fix get rid of the linter errors?</p>",
        "id": 504930087,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741719992
    },
    {
        "content": "<p>or does the additional <code>let</code> just trick the linter?</p>",
        "id": 504930275,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741720058
    },
    {
        "content": "<p>no, it's not about the idents being different but about what they resolve to. The first <code>i</code> is used as the variable binder, so that's the definition site, and the other two are passed to a let that uses the variable, so those two act as uses of the variable (and e.g. you can ctrl-click on them and jump to the binder use)</p>",
        "id": 504952179,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741726050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"676310\">Frederick Pu</span> <a href=\"#narrow/channel/113488-general/topic/precendence.20for.20do.20style.20dsls/near/504929166\">said</a>:</p>\n<blockquote>\n<p>is the <code>x</code> that i use guaranteed to be a new variable?</p>\n</blockquote>\n<p>Yes</p>",
        "id": 504952211,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741726061
    },
    {
        "content": "<p>When you use <code>i1</code> and <code>i2</code> like that second example, they are not uses of the first variable but fresh binders, so ctrl-clicking on them will do nothing because they are all actually distinct binders, and uses inside the body will resolve to the last one since <code>let $i2</code> will shadow the <code>let $i</code> and <code>let $i1</code> binders</p>",
        "id": 504952564,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741726165
    },
    {
        "content": "<p>I'm not sure why the last <code>j</code> is white in the photo though, which indicates that it isn't being used as either a variable binding or a use site</p>",
        "id": 504952830,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741726248
    },
    {
        "content": "<p>There isn't that much magic going on in the first example. It's really just macro expanding to something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>and if you were to write that directly, the linter would validly say that the first <code>i</code> is not unused, and the two later occurrences of <code>i</code> would resolve to the first one. The macro is doing exactly the same thing, it's just that the literal spans of the three <code>i</code> identifiers is slightly different in the text</p>",
        "id": 504953396,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741726425
    },
    {
        "content": "<p>i think the third one being white was cause i deleted one of the lets</p>",
        "id": 504956434,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741727334
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/ecVV8j9gS7bJlkkXpwX-FA14/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ecVV8j9gS7bJlkkXpwX-FA14/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"625x298\" src=\"/user_uploads/thumbnail/3121/ecVV8j9gS7bJlkkXpwX-FA14/image.png/840x560.webp\"></a></div>",
        "id": 504956495,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741727355
    },
    {
        "content": "<p>also im not sure what u mean by binder</p>",
        "id": 504958646,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741728031
    },
    {
        "content": "<p>a binder is something that creates a new local variable which has meaning within some scope</p>",
        "id": 504963082,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741729443
    },
    {
        "content": "<p>In your for loop syntax, from the user's perspective, one would expect the first occurrence of <code>j</code> to be a binder and the other two to be a use</p>",
        "id": 504963175,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741729488
    },
    {
        "content": "<p>another way to illustrate the difference between binders and uses is that a binder will not be an error if you put a completely new word that has not been seen in the text before like <code>foobar1</code>, while if you use a new word in a use site it will be an unknown variable error</p>",
        "id": 504963460,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741729574
    },
    {
        "content": "<p>so how come the two additional uses of the identifier in the un elaborated macro are associated with the two uses in elaborated result?</p>",
        "id": 505030307,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741755847
    },
    {
        "content": "<p>that's what happens when you use <code>i1</code> in the macro and embed it in the result. <code>i1</code> is a <code>Syntax</code> object, and it contains data inside it about where in the source it came from, so that squiggles and hovers generated by the underlying expression eventually get back to the right span of text</p>",
        "id": 505080630,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741773359
    },
    {
        "content": "<p>if you used <code>($i1, $i1)</code> in the macro expansion instead of <code>($i1, $i2)</code>, then the source idenfifier corresponding to <code>i1</code> in the text (the <code>j</code> in <code>j &lt; n</code>) would get two type hovers which are the same, and the source identifier corresponding to <code>i2</code> (the <code>j</code> in <code>j++</code>) would not be colored like a variable and have no type hovers</p>",
        "id": 505081340,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741773499
    },
    {
        "content": "<p>also this is kinda unrelated but what is <code>Syntax</code>. and how does the macro elaboration pipeline look like. Are all the syntax parsers parsed first and then whole thing is elaborated?</p>",
        "id": 505227793,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741807058
    },
    {
        "content": "<p>A macro is basically a <code>Syntax -&gt; Syntax</code> function</p>",
        "id": 505229266,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807447
    },
    {
        "content": "<p>an elab is a <code>Syntax -&gt; Expr</code> function</p>",
        "id": 505229297,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807458
    },
    {
        "content": "<p><code>Syntax</code> is the type that the parser produces from the source text, it has information in it about which grammatical constructs are used and where in the file each thing came from</p>",
        "id": 505229458,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807515
    },
    {
        "content": "<p>so what order are all of the macros applied</p>",
        "id": 505229986,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741807675
    },
    {
        "content": "<p>At the top level you have a <code>command</code> syntax object, corresponding to something like a definition or theorem or inductive type declaration. The parser parsed the text expecting a command, and this results in an AST object, that is, <code>Syntax</code>. The head node of that syntax is a grammar constructor produced from a parser such as <code>Lean.Parser.Command.declaration</code> (as a name), and this is the key which is used to look up in a list of elabs and macros. If there are any macros registered for the head symbol then that macro is run and it repeats with the result. If it's an elab then that function is run (in the case of commands it is just executed for effects).</p>\n<p>An elab will be passed the input syntax, and will generally pattern match out parts of it and call <code>elabTerm</code> or other things on those AST subnodes in order to get e.g. the type and body of a declaration as <code>Expr</code>. This function in turn checks the head node, runs any macros, and otherwise runs an elab registered for that, which elaborates its subnodes and so on</p>",
        "id": 505230944,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807939
    },
    {
        "content": "<p>so the TLDR is that macros are run from the outside in</p>",
        "id": 505230983,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807956
    },
    {
        "content": "<p>and macros take precedence over elabs (but usually there is no overlap)</p>",
        "id": 505231034,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741807973
    },
    {
        "content": "<p>this is also described in <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/\">the other MIL book</a></p>",
        "id": 505231425,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741808084
    },
    {
        "content": "<p>so during the parser of the command syntax object does it call the parsers for other syntax categories. Or is the entire command syntax object parsed first?</p>",
        "id": 505233866,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741808796
    },
    {
        "content": "<p>the entire command is parsed before any macros/elabs are run</p>",
        "id": 505233947,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741808823
    },
    {
        "content": "<p>but parsing is indeed recursive, a parser for defs will call the parser for terms</p>",
        "id": 505234101,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741808867
    },
    {
        "content": "<p>parser declarations tell you both the head node of the generated syntax tree as well as being functions you call to produce the syntax when some other parser decides it wants to call this one</p>",
        "id": 505234403,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741808950
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Command.declaration#src\">src#Lean.Parser.Command.declaration</a> is a function which calls a bunch of other parsers in order to parse a node which is labeled <code> `Lean.Parser.Command.declaration</code></p>",
        "id": 505234627,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741809008
    },
    {
        "content": "<p>will a parser for term call parser for <code>doElem</code>?</p>",
        "id": 505235199,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741809197
    },
    {
        "content": "<p><code>term</code> is an extensible grammar category. These work by having an attribute which allow you to register new things into that grammar category and all of them are tried (by some longest match rule) to parse a term. One of the term parsers is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Term.do#src\">src#Lean.Parser.Term.do</a>, which parses <code>do</code> followed by a <code>doSeq</code>, which calls <code>doSeqIndent</code> which calls <code>doSeqItem</code> which calls <code>doElemParser</code> which is the extensible parser for <code>doElem</code>s.</p>",
        "id": 505235953,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741809439
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"676310\">@Frederick Pu</span> You might find it useful to read <a href=\"https://lean-lang.org/doc/reference/latest/find/?domain=Verso.Genre.Manual.section&amp;name=language-extension\">the manual section on extending Lean</a></p>",
        "id": 505245466,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1741812249
    },
    {
        "content": "<p>thx ill take a look</p>",
        "id": 505725397,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1741971682
    }
]