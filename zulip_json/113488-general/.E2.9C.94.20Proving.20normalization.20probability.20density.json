[
    {
        "content": "<p>While modelling a more complicated problem, I encountered the following simplified problem: how to prove that a custom density function is normalized to 1?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">ProbabilityMassFunction</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fintype</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">normalised_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PMF</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"n\">normalised_sums_one</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>The sorry statements are the locations where I keep getting stuck. How can I compute a simple sum like that? I cannot find any theorems to expand or evaluate these kind of sums.</p>",
        "id": 525749744,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750868657
    },
    {
        "content": "<p>Here is how I thought about doing one of the sorries.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">ProbabilityMassFunction</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fintype</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">×ˢ</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">pairs</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">univ_eq_allThing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">thing</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">all_things</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">thing</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">thing</span><span class=\"bp\">.</span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pairs</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">omega</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sum_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">univ_eq_allThing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_product</span><span class=\"o\">]</span>\n</code></pre></div>\n<p><code>Finset.univ</code> is the set containing all possible <code>Thing</code>. <code>sum_density</code> sums over every element in <code>Finset.univ</code>. In order to simplify <code>sum_density</code>, I need replace this abstract <code>Finset.univ</code> with a set whose elements I know.</p>\n<p>Every possible <code>Thing</code> is just all possible choices for <code>a</code> and <code>b</code>. So first I construct the explicit finset <code>all_things</code> and then I prove that <code>Finset.univ</code> is equal to <code>all_things</code>. </p>\n<p>Now, I can change from summing over this abstract <code>Finset.univ</code> to summing over this explicit set <code>all_things</code>. I was now left with a sum over elements in a cartesian product. I searched for \"Finset.sum, SProd.sprod\" in <a href=\"https://loogle.lean-lang.org/\">#loogle</a> and it gave me the result <code>Finset.sum_product</code> which finished it.</p>",
        "id": 525765544,
        "sender_full_name": "Eric Paul",
        "timestamp": 1750874853
    },
    {
        "content": "<p>Where did you exactly convert Finset.univ to all_things. I don’t see it appearing anywhere. Is it something like rusts Default?</p>",
        "id": 525786995,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750884197
    },
    {
        "content": "<p>what do you mean by \"convert\"? he wrote a theorem <code>univ_eq_allThing</code> which proves that <code>Finset.univ</code> is equal to <code>all_things</code></p>",
        "id": 525787702,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1750884459
    },
    {
        "content": "<p>I mean that I only see it appear in the theorem statement. And I don’t know lean enough to predict if will appear in the simp sequence on the bottom.</p>",
        "id": 525787914,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750884546
    },
    {
        "content": "<p>I would run the proof yourself and inspect what's going on. For example if you want to see what simp lemmas are being used, change <code>simp</code> to <code>simp?</code>.</p>",
        "id": 525788100,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1750884628
    },
    {
        "content": "<p>Okay thanks. Is it always necessary to state an explicit enumeration of the space and prove equivalence? Or can lean automatically expand finite subsets defined with a property?</p>",
        "id": 525792159,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750886318
    },
    {
        "content": "<p>The enumeration already exists (because of <code>deriving Fintype</code>) so you can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>You can find it with<br>\n<code>#reduce (Finset.univ : Finset Thing)</code>, so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">⟩</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 525822734,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750912307
    },
    {
        "content": "<p>Wow, I expected there to be a better way, but not so much better! That's great to know, thanks</p>",
        "id": 525825592,
        "sender_full_name": "Eric Paul",
        "timestamp": 1750915059
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"512030\">@Eric Paul</span>, thanks a lot for your help! Now, I have a different problem because the normalization requires the naturals to be converted to ENNReals.</p>\n<p>How do you compute that the normalization has sum 1: <code>HasSum norm_density 1</code>? I can share my trial but it is mostly a copy of what you have described. I cannot find the right theorem to prove HasSum. I tried <code>ENNReal.hasSum</code>, <code>Finset.hasSum</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">real_sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">univ_eq_allThing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_product</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">hasSum</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">density</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">real_sum</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"bp\">.</span><span class=\"n\">div_const</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"mi\">18</span>\n</code></pre></div>\n<p>There is one error and infinite recursion.</p>",
        "id": 525869010,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750932275
    },
    {
        "content": "<p>I think you should use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=hasSum_fintype#doc\">docs#hasSum_fintype</a></p>",
        "id": 525870668,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750932878
    },
    {
        "content": "<p>Then you distribute the division out</p>",
        "id": 525870818,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750932931
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Proving.20normalization.20probability.20density/near/525870668\">zei</a>:</p>\n<blockquote>\n<p>I think you should use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=hasSum_fintype#doc\">docs#hasSum_fintype</a></p>\n</blockquote>\n<p>The problem I have with that one is that it seems like it cannot unify the sum value:</p>\n<div class=\"codehilite\" data-code-language=\"Todotxt\"><pre><span></span><code>tactic 'apply' failed, could not unify the conclusion of `@hasSum_fintype`\n<span class=\"err\">  </span>HasSum ?f (∑ b, ?f b)\nwith the goal\n<span class=\"err\">  </span>HasSum density 18\n</code></pre></div>",
        "id": 525870993,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933005
    },
    {
        "content": "<p>Do you just want the normalized sum or do you want the sum as well</p>",
        "id": 525871095,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933052
    },
    {
        "content": "<p>If you just want the normalized sum then you can use <code>hasSum_fintype</code></p>",
        "id": 525871122,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933067
    },
    {
        "content": "<p>If you want the sum as well I would suggest doing it in the naturals and then casting to ENNReal</p>",
        "id": 525871172,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933089
    },
    {
        "content": "<p>Oh yes, it worked when i didnt substitute the raw sum value.</p>\n<p>Now I have an infinite recursion error in the proof evaluation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">real_sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">univ_eq_allThing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_product</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"bp\">.</span><span class=\"n\">div_const</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n</code></pre></div>\n<p>I am more interested in the normalized sum.</p>",
        "id": 525871252,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933121
    },
    {
        "content": "<p>Then you don't need to specify the value of the sum, you just need to know it is nonzero</p>",
        "id": 525871317,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933153
    },
    {
        "content": "<p>Sorry, <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>, simply removing the sum_density = 18 by sum_density \\neq 0 still results in recursion error.</p>",
        "id": 525871576,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933258
    },
    {
        "content": "<p>I think you're trying to unify <code>sum_density / sum_density</code> with <code>1</code> and Lean tries really really hard and gets stuck trying</p>",
        "id": 525871937,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933431
    },
    {
        "content": "<p>You need to do some rewrites</p>",
        "id": 525871980,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933449
    },
    {
        "content": "<p>So it is not possible to use <code>HasSum.div_const</code> right away?</p>",
        "id": 525872156,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933533
    },
    {
        "content": "<p>Yes, since <code>1</code> is not a division</p>",
        "id": 525872176,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933543
    },
    {
        "content": "<p>A rewrite of the sum in front of the final exact still gives recursion error. Strange. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">real_sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sum_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\">  </span><span class=\"n\">univ_eq_allThing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_product</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sum_density</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"bp\">.</span><span class=\"n\">div_const</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n</code></pre></div>",
        "id": 525872421,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933648
    },
    {
        "content": "<p>The problem is that <code>1</code> is not the same as <code>sum_density / sum_density</code>, and Lean tries really hard to make them the same and gets stuck</p>",
        "id": 525872613,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933724
    },
    {
        "content": "<p>So you need to either do something about the <code>1</code> or do something about the <code>sum_density / sum_density</code></p>",
        "id": 525872677,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933746
    },
    {
        "content": "<p>You mean <code>theorem normalised_sums_one : HasSum normalised_density (sum_density / sum_density)</code>?</p>",
        "id": 525872904,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933843
    },
    {
        "content": "<p>That works too I guess</p>",
        "id": 525872963,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933862
    },
    {
        "content": "<p>No it still recurses too much.</p>",
        "id": 525873016,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750933879
    },
    {
        "content": "<p>Hmm, maybe there's also another problem</p>",
        "id": 525873160,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933952
    },
    {
        "content": "<p>Oh, <code>ENNReal</code> isn't a division semiring</p>",
        "id": 525873208,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933979
    },
    {
        "content": "<p>So <code>HasSum.div_const</code> doesn't apply here</p>",
        "id": 525873234,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750933992
    },
    {
        "content": "<p>Is there a reason you want to use <code>ENNReal</code>?</p>",
        "id": 525873275,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750934014
    },
    {
        "content": "<p>Ah I was going to use it as a density function (PMF) for a probability measure.</p>",
        "id": 525873376,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750934060
    },
    {
        "content": "<p>I modified the functions to be Real:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">real_sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sum_density</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"o\">,</span><span class=\"w\">  </span><span class=\"n\">univ_eq_allThing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">all_things</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pairs</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_product</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">total_sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"c1\">-- rw [sum_density] at this</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"bp\">.</span><span class=\"n\">div_const</span><span class=\"w\"> </span><span class=\"n\">total_sum</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n</code></pre></div>\n<p>I does not recurse forever, but now the final step cannot complete. It can't identify sum_density/sum_density with 1</p>",
        "id": 525874081,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750934321
    },
    {
        "content": "<p>Yeah, you need to rewrite</p>",
        "id": 525874168,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750934355
    },
    {
        "content": "<p>Okay, you mean rewriting the goal, like 1 -&gt; sum / sum?</p>",
        "id": 525874336,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750934411
    },
    {
        "content": "<p>Yes</p>",
        "id": 525874376,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750934433
    },
    {
        "content": "<p>Okay thanks a lot! Now I just have to convert it into a measure</p>",
        "id": 525874618,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750934522
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"129795\">Max R</span> has marked this topic as resolved.</p>",
        "id": 525881223,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750936926
    },
    {
        "content": "<p>If you make <code>density</code> return <code>NNReal</code> then you can:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ne_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_eq_zero_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">forall_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">not_forall</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">density</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_div</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_self</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which scales a bit better if <code>Thing</code> e.g. had a million elements</p>",
        "id": 525917551,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750948077
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Proving.20normalization.20probability.20density/near/525917551\">zei</a>:</p>\n<blockquote>\n<p>If you make <code>density</code> return <code>NNReal</code> then you can:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ne_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_eq_zero_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">forall_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">not_forall</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">density</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_div</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_self</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which scales a bit better if <code>Thing</code> e.g. had a million elements</p>\n</blockquote>\n<p>Can you elaborate why this scales better?</p>",
        "id": 525925834,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1750950246
    },
    {
        "content": "<p>You don't have to evaluate the sum</p>",
        "id": 525931037,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750951687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Proving.20normalization.20probability.20density/near/525931037\">zei</a>:</p>\n<blockquote>\n<p>You don't have to evaluate the sum</p>\n</blockquote>\n<p>Thanks, the proof is not accepted by Lean, but I will try to fix it.</p>",
        "id": 526114648,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1751040398
    },
    {
        "content": "<p>Did you modify <code>density</code> to return <code>NNReal</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Fintype</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum_density</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Thing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">normalised_sums_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasSum</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">hasSum_fintype</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">normalised_density</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">sum_density</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">density</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ne_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_eq_zero_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_univ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">forall_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">not_forall</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">density</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_div</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_self</span><span class=\"w\"> </span><span class=\"n\">ne_zero</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 526163913,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751069008
    }
]