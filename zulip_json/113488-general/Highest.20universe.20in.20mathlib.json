[
    {
        "content": "<p>We all know we have infinitely many universes in Lean, and basically everything is universe-polymorphic in mathlib, but how many universes do we really need currently? That is, to which point can we squish down all universes in mathlib and still have everything typecheck? Kevin argued that <code>Type 1</code> was enough, but I suspect some constructions in category might something higher.</p>",
        "id": 265998823,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1640348924
    },
    {
        "content": "<p>Certainly <code>Type 2</code> will be good enough. I think that's what's needed for LTE.</p>",
        "id": 265998859,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1640348977
    },
    {
        "content": "<p>I must say I'm surprised we don't need anything higher!</p>",
        "id": 266004157,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1640354711
    },
    {
        "content": "<p>I'm not. If you're a set theorist then you think everything is a set so everything's in Type. Definitions like ordinals and the category of all sets/groups etc are called classes, and they're all in Type 1.</p>",
        "id": 266008657,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359411
    },
    {
        "content": "<p>Classically in mathematics you only deal with sets and classes</p>",
        "id": 266008672,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359435
    },
    {
        "content": "<p>Remember that historically mathematicians didn't even need sets! People like Gauss and Euler worked with terms and functions. Then Galois came along and said \"I think it would be helpful if we could identify the permutation group of +-sqrt(2) with the permutation group of +-sqrt(3) because I think I'm on to something\". It was only around then that we started needing to talk about some kind of holder type G for a collection of terms g. So in some sense before that we didn't even need Type. We just had concrete examples like the naturals, reals and complexes</p>",
        "id": 266008877,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359623
    },
    {
        "content": "<p>The push to develop abstract group theory and then abstract algebra and ideas like homomorphisms of groups are historically very recent. This is when people started to want to talk about maps between abstract types -- functions had of course existed for centuries before that but again only between concrete types such as the sine and cosine function on the reals</p>",
        "id": 266008976,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359734
    },
    {
        "content": "<p>So types became \"things\" and then set theory gave a name to the things, but Russell's paradox showed that you had to be careful so then we got things like ZFC and at that point mathematics was going on purely within Type.</p>",
        "id": 266009043,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359803
    },
    {
        "content": "<p>Then category theory and homological algebra and Grothendieck came along and then people wanted to start talking about abstract mathematical objects such as the category of all sets, which weren't even in Type. Grothendieck fixed this by adding an extra axiom to set theory to enable more than one universe of types, or of sets as he called them, and even then you don't need infinitely many, you just need to allow yourself to do the occasional universe bump. Hence Type 1</p>",
        "id": 266009175,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640359944
    },
    {
        "content": "<p>I've been curious about this question for a while, so I decided to answer it for real instead of theorizing.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">open</span> <span class=\"n\">tactic</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">inductive</span> <span class=\"n\">level_spec</span>\n<span class=\"bp\">|</span> <span class=\"n\">const</span> <span class=\"o\">:</span> <span class=\"n\">level</span> <span class=\"bp\">→</span> <span class=\"n\">level_spec</span>\n<span class=\"bp\">|</span> <span class=\"n\">parametric</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">name</span> <span class=\"bp\">→</span> <span class=\"n\">level</span> <span class=\"bp\">→</span> <span class=\"n\">level_spec</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">level.has_any_param</span> <span class=\"o\">:</span> <span class=\"n\">level</span> <span class=\"bp\">→</span> <span class=\"n\">bool</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.succ</span> <span class=\"n\">l</span><span class=\"o\">)</span>     <span class=\"o\">:=</span>  <span class=\"n\">l.has_any_param</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.max</span> <span class=\"n\">l₁</span> <span class=\"n\">l₂</span><span class=\"o\">)</span>  <span class=\"o\">:=</span>  <span class=\"n\">l₁.has_any_param</span> <span class=\"bp\">||</span>  <span class=\"n\">l₂.has_any_param</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.imax</span> <span class=\"n\">l₁</span> <span class=\"n\">l₂</span><span class=\"o\">)</span> <span class=\"o\">:=</span>  <span class=\"n\">l₁.has_any_param</span> <span class=\"bp\">||</span>  <span class=\"n\">l₂.has_any_param</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.param</span> <span class=\"n\">_</span><span class=\"o\">)</span>    <span class=\"o\">:=</span> <span class=\"n\">tt</span>\n<span class=\"bp\">|</span> <span class=\"n\">l</span>                  <span class=\"o\">:=</span> <span class=\"n\">ff</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">level.at_zero</span> <span class=\"o\">:</span> <span class=\"n\">level</span> <span class=\"bp\">→</span> <span class=\"n\">nat</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.succ</span> <span class=\"n\">l</span><span class=\"o\">)</span>     <span class=\"o\">:=</span> <span class=\"n\">l.at_zero</span> <span class=\"bp\">+</span> <span class=\"mi\">1</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.max</span> <span class=\"n\">l₁</span> <span class=\"n\">l₂</span><span class=\"o\">)</span>  <span class=\"o\">:=</span> <span class=\"n\">max</span> <span class=\"n\">l₁.at_zero</span> <span class=\"n\">l₂.at_zero</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level.imax</span> <span class=\"n\">l₁</span> <span class=\"n\">l₂</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"k\">let</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"n\">l₂.at_zero</span> <span class=\"k\">in</span> <span class=\"k\">if</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"mi\">0</span> <span class=\"k\">then</span> <span class=\"mi\">0</span> <span class=\"k\">else</span> <span class=\"n\">max</span> <span class=\"n\">l₁.at_zero</span> <span class=\"n\">n</span>\n<span class=\"bp\">|</span> <span class=\"n\">_</span>                  <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">level_spec.at_zero</span> <span class=\"o\">:</span> <span class=\"n\">level_spec</span> <span class=\"bp\">→</span> <span class=\"n\">nat</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.const</span> <span class=\"n\">l</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">l.at_zero</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.parametric</span> <span class=\"n\">_</span> <span class=\"n\">l</span><span class=\"o\">)</span>  <span class=\"o\">:=</span> <span class=\"n\">l.at_zero</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">mutual</span> <span class=\"kd\">def</span> <span class=\"n\">get_expr_level</span><span class=\"o\">,</span> <span class=\"n\">get_const_spec</span> <span class=\"o\">(</span><span class=\"n\">env</span> <span class=\"o\">:</span> <span class=\"n\">environment</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">r</span> <span class=\"o\">:</span> <span class=\"n\">ref</span> <span class=\"o\">(</span><span class=\"n\">name_map</span> <span class=\"n\">level_spec</span><span class=\"o\">))</span>\n<span class=\"k\">with</span> <span class=\"n\">get_expr_level</span> <span class=\"o\">:</span> <span class=\"n\">expr</span> <span class=\"bp\">→</span> <span class=\"n\">level</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"n\">level</span>\n<span class=\"bp\">|</span> <span class=\"n\">v</span> <span class=\"n\">l</span> <span class=\"o\">:=</span> <span class=\"n\">v.fold</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"n\">l</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">e</span> <span class=\"n\">_</span> <span class=\"n\">r</span><span class=\"o\">,</span> <span class=\"n\">r</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"bp\">λ</span> <span class=\"n\">l</span><span class=\"o\">,</span>\n  <span class=\"k\">match</span> <span class=\"n\">e</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"n\">expr.const</span> <span class=\"n\">n</span> <span class=\"n\">us</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n    <span class=\"n\">sp</span> <span class=\"bp\">←</span> <span class=\"n\">get_const_spec</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n    <span class=\"k\">match</span> <span class=\"n\">sp</span> <span class=\"k\">with</span>\n    <span class=\"bp\">|</span> <span class=\"n\">level_spec.const</span> <span class=\"n\">l'</span> <span class=\"o\">:=</span> <span class=\"n\">pure</span> <span class=\"bp\">$</span> <span class=\"n\">l.max</span> <span class=\"n\">l'</span>\n    <span class=\"bp\">|</span> <span class=\"n\">level_spec.parametric</span> <span class=\"n\">us'</span> <span class=\"n\">l'</span> <span class=\"o\">:=</span> <span class=\"n\">pure</span> <span class=\"bp\">$</span> <span class=\"n\">l.max</span> <span class=\"bp\">$</span> <span class=\"n\">l'.instantiate</span> <span class=\"o\">(</span><span class=\"n\">us'.zip</span> <span class=\"n\">us</span><span class=\"o\">)</span>\n    <span class=\"kd\">end</span>\n  <span class=\"bp\">|</span> <span class=\"n\">expr.sort</span> <span class=\"n\">l'</span> <span class=\"o\">:=</span> <span class=\"n\">pure</span> <span class=\"bp\">$</span> <span class=\"n\">l.max</span> <span class=\"n\">l'</span>\n  <span class=\"bp\">|</span> <span class=\"n\">_</span> <span class=\"o\">:=</span> <span class=\"n\">pure</span> <span class=\"n\">l</span>\n  <span class=\"kd\">end</span>\n<span class=\"k\">with</span> <span class=\"n\">get_const_spec</span> <span class=\"o\">:</span> <span class=\"n\">name</span> <span class=\"bp\">→</span> <span class=\"n\">tactic</span> <span class=\"n\">level_spec</span>\n<span class=\"bp\">|</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n  <span class=\"n\">m</span> <span class=\"bp\">←</span> <span class=\"n\">read_ref</span> <span class=\"n\">r</span><span class=\"o\">,</span>\n  <span class=\"k\">match</span> <span class=\"n\">m.find</span> <span class=\"n\">n</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"n\">some</span> <span class=\"n\">sp</span> <span class=\"o\">:=</span> <span class=\"n\">pure</span> <span class=\"n\">sp</span>\n  <span class=\"bp\">|</span> <span class=\"n\">none</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n    <span class=\"k\">let</span> <span class=\"n\">process_decl</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"o\">:</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">us</span> <span class=\"o\">:</span> <span class=\"n\">list</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">l</span> <span class=\"o\">:</span> <span class=\"n\">level</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">tactic</span> <span class=\"n\">level_spec</span> <span class=\"o\">:=</span> <span class=\"o\">(</span><span class=\"k\">do</span>\n      <span class=\"k\">let</span> <span class=\"n\">l</span> <span class=\"o\">:=</span> <span class=\"n\">l.normalize</span><span class=\"o\">,</span>\n      <span class=\"k\">let</span> <span class=\"n\">sp</span> <span class=\"o\">:=</span> <span class=\"k\">if</span> <span class=\"n\">l.has_any_param</span> <span class=\"k\">then</span> <span class=\"n\">level_spec.parametric</span> <span class=\"n\">us</span> <span class=\"n\">l</span> <span class=\"k\">else</span> <span class=\"n\">level_spec.const</span> <span class=\"n\">l</span><span class=\"o\">,</span>\n      <span class=\"n\">m</span> <span class=\"bp\">←</span> <span class=\"n\">read_ref</span> <span class=\"n\">r</span><span class=\"o\">,</span>\n      <span class=\"n\">write_ref</span> <span class=\"n\">r</span> <span class=\"o\">(</span><span class=\"n\">m.insert</span> <span class=\"n\">n</span> <span class=\"n\">sp</span><span class=\"o\">),</span>\n      <span class=\"n\">pure</span> <span class=\"n\">sp</span><span class=\"o\">),</span>\n    <span class=\"n\">d</span> <span class=\"bp\">←</span> <span class=\"n\">env.get</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n    <span class=\"k\">match</span> <span class=\"n\">d</span> <span class=\"k\">with</span>\n    <span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">declaration.defn</span> <span class=\"n\">n</span> <span class=\"n\">us</span> <span class=\"n\">t</span> <span class=\"n\">v</span> <span class=\"n\">_</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n      <span class=\"n\">get_expr_level</span> <span class=\"n\">t</span> <span class=\"n\">level.zero</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">get_expr_level</span> <span class=\"n\">v</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">process_decl</span> <span class=\"n\">n</span> <span class=\"n\">us</span>\n    <span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">declaration.thm</span> <span class=\"n\">n</span> <span class=\"n\">us</span> <span class=\"n\">t</span> <span class=\"n\">v</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n      <span class=\"n\">get_expr_level</span> <span class=\"n\">t</span> <span class=\"n\">level.zero</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">get_expr_level</span> <span class=\"n\">v.get</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">process_decl</span> <span class=\"n\">n</span> <span class=\"n\">us</span>\n    <span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">declaration.cnst</span> <span class=\"n\">n</span> <span class=\"n\">us</span> <span class=\"n\">t</span> <span class=\"n\">_</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">get_expr_level</span> <span class=\"n\">t</span> <span class=\"n\">level.zero</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">process_decl</span> <span class=\"n\">n</span> <span class=\"n\">us</span>\n    <span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">declaration.ax</span> <span class=\"n\">n</span> <span class=\"n\">us</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">get_expr_level</span> <span class=\"n\">t</span> <span class=\"n\">level.zero</span> <span class=\"bp\">&gt;&gt;=</span> <span class=\"n\">process_decl</span> <span class=\"n\">n</span> <span class=\"n\">us</span>\n    <span class=\"kd\">end</span>\n  <span class=\"kd\">end</span>\n\n<span class=\"kd\">run_cmd</span>\n  <span class=\"n\">using_new_ref</span> <span class=\"n\">mk_name_map</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">m</span><span class=\"o\">,</span> <span class=\"k\">do</span>\n  <span class=\"n\">env</span> <span class=\"bp\">←</span> <span class=\"n\">tactic.get_env</span><span class=\"o\">,</span>\n  <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"bp\">←</span> <span class=\"n\">env.fold</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"o\">(</span><span class=\"n\">name.anonymous</span><span class=\"o\">,</span> <span class=\"mi\">0</span><span class=\"o\">))</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">d</span> <span class=\"n\">r</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"k\">do</span>\n    <span class=\"n\">p</span> <span class=\"bp\">←</span> <span class=\"n\">r</span><span class=\"o\">,</span>\n    <span class=\"k\">let</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"n\">d.to_name</span><span class=\"o\">,</span>\n    <span class=\"n\">sp</span> <span class=\"bp\">←</span> <span class=\"n\">get_const_spec</span> <span class=\"n\">env</span> <span class=\"n\">m</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n    <span class=\"k\">let</span> <span class=\"n\">z</span> <span class=\"o\">:=</span> <span class=\"n\">sp.at_zero</span><span class=\"o\">,</span>\n    <span class=\"n\">pure</span> <span class=\"bp\">$</span> <span class=\"k\">if</span> <span class=\"n\">p.2</span> <span class=\"bp\">&lt;</span> <span class=\"n\">z</span> <span class=\"k\">then</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">z</span><span class=\"o\">)</span> <span class=\"k\">else</span> <span class=\"n\">p</span><span class=\"o\">),</span>\n  <span class=\"n\">trace</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">z</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 266021888,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640376607
    },
    {
        "content": "<p>For the core library, the output is <code>(sigma.mk.inj_eq, 3)</code>, which is to say, if you were to specialize every definition to every concrete universe, then the largest subterm of the form <code>Sort u</code> that appears in the hierarchy of definitions leading to <code>sigma.mk.inj_eq.{0, 0}</code> is <code>Sort 3</code>, aka <code>Type 2</code>. <code>sigma.mk.inj_eq</code> is the only definition that gets as high as <code>3</code>.</p>\n<p>For mathlib, the output is <code>(measure_theory.L1.set_to_L1_congr_left', 4)</code>, and I'm checking now to see if there are any others at height 4. So the official answer seems to be that you need <code>Type 3</code> to compile mathlib, or alternatively, mathlib can be translated to work in ZFC with 4 inaccessible cardinals.</p>",
        "id": 266021896,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640376620
    },
    {
        "content": "<p>It looks like there are a huge number of definitions at height 4 (and <code>measure_theory.L1.set_to_L1_congr_left'</code> is a random selection). I will look for minimal ones.</p>",
        "id": 266021966,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640376734
    },
    {
        "content": "<p>Just to be clear here -- if a random definition takes four types in, in universes u v w x, that doesn't artificially push the bound up to 4?</p>",
        "id": 266022673,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640377826
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib_docs/find/measure_theory.L1.set_to_L1_congr_left'\">docs#measure_theory.L1.set_to_L1_congr_left'</a></p>",
        "id": 266022682,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640377843
    },
    {
        "content": "<p>Here is the list of level 4 definitions that do not depend on any level 4 definitions (i.e. they are level 4 because they either directly use a large universe or reference a level 3 definition with a universe bump in the substitution):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">ordinal.omin._match_1</span>\n<span class=\"n\">nhds_is_measurably_generated</span>\n<span class=\"n\">finprod_mem_def</span>\n<span class=\"n\">finprod_eq_prod_of_mul_support_subset</span>\n<span class=\"n\">add_monoid_hom.map_finsum</span>\n<span class=\"n\">pSet.definable</span>\n<span class=\"n\">pSet.arity.equiv._main</span>\n<span class=\"n\">finprod_mem_univ</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.coproduct._proof_4</span>\n<span class=\"n\">finprod_mem_empty</span>\n<span class=\"n\">category_theory.types_glue._proof_1</span>\n<span class=\"n\">category_theory.types_glue._proof_2</span>\n<span class=\"n\">ordinal.lift.principal_seg._proof_1</span>\n<span class=\"n\">hahn_series.summable_family.hsum._proof_1</span>\n<span class=\"n\">smooth_partition_of_unity.mk</span>\n<span class=\"n\">partition_of_unity.mk</span>\n<span class=\"n\">bump_covering.to_pou_fun</span>\n<span class=\"n\">finprod_cond_nonneg</span>\n<span class=\"n\">finsum_eq_sum_of_support_subset</span>\n<span class=\"n\">partition_of_unity.sum_eq_one'</span>\n<span class=\"n\">partition_of_unity.sum_le_one'</span>\n<span class=\"n\">smooth_partition_of_unity.sum_eq_one'</span>\n<span class=\"n\">partition_of_unity.sum_nonneg</span>\n<span class=\"n\">smooth_partition_of_unity.sum_le_one'</span>\n<span class=\"n\">finsum_mem_def</span>\n<span class=\"n\">finsum_mem_univ</span>\n<span class=\"n\">finsum_mem_congr</span>\n<span class=\"n\">algebraic_geometry.Scheme.basic_open_is_open_immersion</span>\n<span class=\"n\">uchange</span>\n<span class=\"n\">finsum_mem_induction</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.has_coequalizer.image_basic_open._proof_2</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.has_coequalizer.image_basic_open._proof_4</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.has_coequalizer.image_basic_open._proof_8</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.has_coequalizer.coequalizer_π_app_is_local_ring_hom</span>\n<span class=\"n\">finsum_mem_empty</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.is_open_immersion.forget_preserves_pullback_of_left</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.coproduct._proof_3</span>\n<span class=\"n\">category_theory.subcanonical_types_grothendieck_topology</span>\n<span class=\"n\">algebraic_geometry.PresheafedSpace.is_open_immersion.to_LocallyRingedSpace._proof_4</span>\n<span class=\"n\">algebraic_geometry.LocallyRingedSpace.coequalizer._proof_3</span>\n<span class=\"n\">classical.all_definable._main._proof_1</span>\n<span class=\"n\">finsum_mem_zero</span>\n<span class=\"n\">monoid_hom.map_finprod</span>\n<span class=\"n\">pSet.embed._match_1</span>\n<span class=\"n\">finprod_mem_induction</span>\n<span class=\"n\">classical.all_definable._main._proof_2</span>\n<span class=\"n\">at_bot_is_measurably_generated</span>\n<span class=\"n\">ordinal.typein_iso._match_1</span>\n<span class=\"n\">ordinal.typein_iso._proof_1</span>\n<span class=\"n\">pSet.arity.equiv._main._meta_aux</span>\n<span class=\"n\">finsum_dmem</span>\n<span class=\"n\">finprod_mem_one</span>\n<span class=\"n\">finprod_mem_congr</span>\n<span class=\"n\">category_theory.flat_iff_Lan_flat</span>\n<span class=\"n\">finprod_dmem</span>\n<span class=\"n\">at_top_is_measurably_generated</span>\n</code></pre></div>",
        "id": 266022683,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640377846
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> No, having lots of universe parameters does not bump the level, but instantiating those parameters (directly or indirectly) with a <code>u+1</code> somewhere does</p>",
        "id": 266022699,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640377899
    },
    {
        "content": "<p><code>measure_theory.L1.set_to_L1_congr_left'</code> just looks to me like some random technical lemma in measure theory that has nothing to do with universes</p>",
        "id": 266022747,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640377952
    },
    {
        "content": "<p>The new list is probably more useful</p>",
        "id": 266022759,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640377978
    },
    {
        "content": "<p>How the hack can something like <code>finsum_mem_empty</code> need a nontrivial amount of universes?</p>",
        "id": 266022788,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1640378040
    },
    {
        "content": "<p>One thing that is a bit dicey about any calculation like this is that if you just chop off the universe hierarchy, then not every term has a type. Right now, the program is asserting for every definition that its type and value have to be typecheckable; perhaps it would be better to skip the type for definitions and theorems</p>",
        "id": 266022798,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640378042
    },
    {
        "content": "<p><code>finprod_mem_empty</code> needs four universes? I still don't think I understand the question :-)</p>",
        "id": 266022841,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378071
    },
    {
        "content": "<p><code>finsum_mem_empty.{u_1, u_4}</code> has max universe <code>max (u_1+4) (u_4+2)</code></p>",
        "id": 266023002,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640378319
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib_docs/find/finsum_mem_empty\">docs#finsum_mem_empty</a></p>",
        "id": 266023016,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1640378357
    },
    {
        "content": "<p>lol what is going on</p>",
        "id": 266023092,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378452
    },
    {
        "content": "<p>Wow! Thanks, Mario.</p>",
        "id": 266023111,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1640378505
    },
    {
        "content": "<ul>\n<li><code>finsum_mem_empty.{u_1 u_4}</code> has max universe <code>max (u_1+4) (u_4+2)</code> because it uses <code>finsum.{u_4 u_1+1}</code></li>\n<li><code>finsum.{u_1 u_2}</code> has max universe <code>max (u_1+2) (u_2+3)</code>, still not sure where this is coming from, I will make a program to unravel it</li>\n</ul>",
        "id": 266023156,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640378565
    },
    {
        "content": "<p>lol I wrote <code>finprod_mem_empty</code></p>",
        "id": 266023323,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378811
    },
    {
        "content": "<p>oh! Oh so the issue is <code>finsum</code>, not my lemma</p>",
        "id": 266023338,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378840
    },
    {
        "content": "<p>You're in the highest universe, Kevin!</p>",
        "id": 266023342,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1640378843
    },
    {
        "content": "<p>golly, I apparently wrote <code>finprod</code> too</p>",
        "id": 266023412,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378920
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/Highest.20universe.20in.20mathlib/near/266023156\">said</a>:</p>\n<blockquote>\n<p>still not sure where this is coming from, I will make a program to unravel it</p>\n</blockquote>\n<p>The answer is Kevin <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 266023433,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1640378958
    },
    {
        "content": "<p>I'm pretty sure that other people told me what to write in that definition :-)</p>",
        "id": 266023441,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640378979
    },
    {
        "content": "<p>What is all this plift stuff?</p>",
        "id": 266023502,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640379039
    },
    {
        "content": "<p>Here's the program for outputting the level of a definition and its direct dependencies:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">level_spec.level</span> <span class=\"o\">:</span> <span class=\"n\">level_spec</span> <span class=\"bp\">→</span> <span class=\"n\">level</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.const</span> <span class=\"n\">l</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"n\">l</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.parametric</span> <span class=\"n\">_</span> <span class=\"n\">l</span><span class=\"o\">)</span>  <span class=\"o\">:=</span> <span class=\"n\">l</span>\n\n<span class=\"kd\">meta</span> <span class=\"kd\">def</span> <span class=\"n\">level_spec.args</span> <span class=\"o\">:</span> <span class=\"n\">level_spec</span> <span class=\"bp\">→</span> <span class=\"n\">list</span> <span class=\"n\">name</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.const</span> <span class=\"n\">l</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"o\">[]</span>\n<span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">level_spec.parametric</span> <span class=\"n\">us</span> <span class=\"n\">_</span><span class=\"o\">)</span>  <span class=\"o\">:=</span> <span class=\"n\">us</span>\n\n<span class=\"kd\">set_option</span> <span class=\"n\">pp.all</span> <span class=\"n\">true</span>\n<span class=\"kd\">run_cmd</span>\n  <span class=\"n\">using_new_ref</span> <span class=\"n\">mk_name_map</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">m</span><span class=\"o\">,</span> <span class=\"k\">do</span>\n  <span class=\"n\">env</span> <span class=\"bp\">←</span> <span class=\"n\">tactic.get_env</span><span class=\"o\">,</span>\n  <span class=\"k\">let</span> <span class=\"n\">n</span> <span class=\"o\">:=</span> <span class=\"bp\">`</span><span class=\"n\">finsum</span><span class=\"o\">,</span>\n  <span class=\"n\">l</span> <span class=\"bp\">←</span> <span class=\"n\">get_const_spec</span> <span class=\"n\">env</span> <span class=\"n\">m</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n  <span class=\"n\">trace</span> <span class=\"o\">(</span><span class=\"n\">l.args</span><span class=\"o\">,</span> <span class=\"n\">l.level</span><span class=\"o\">),</span>\n  <span class=\"n\">d</span> <span class=\"bp\">←</span> <span class=\"n\">env.get</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n  <span class=\"k\">let</span> <span class=\"n\">map</span> <span class=\"o\">:=</span> <span class=\"n\">d.value.fold</span> <span class=\"n\">mk_name_set</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">e</span> <span class=\"n\">_</span> <span class=\"n\">m</span><span class=\"o\">,</span>\n    <span class=\"k\">if</span> <span class=\"n\">e.is_constant</span> <span class=\"k\">then</span> <span class=\"n\">m.insert</span> <span class=\"n\">e.const_name</span> <span class=\"k\">else</span> <span class=\"n\">m</span><span class=\"o\">,</span>\n  <span class=\"n\">map.fold</span> <span class=\"o\">(</span><span class=\"n\">pure</span> <span class=\"o\">())</span> <span class=\"bp\">$</span> <span class=\"bp\">λ</span> <span class=\"n\">n</span> <span class=\"n\">r</span><span class=\"o\">,</span> <span class=\"k\">do</span>\n    <span class=\"n\">r</span><span class=\"o\">,</span>\n    <span class=\"n\">l</span> <span class=\"bp\">←</span> <span class=\"n\">get_const_spec</span> <span class=\"n\">env</span> <span class=\"n\">m</span> <span class=\"n\">n</span><span class=\"o\">,</span>\n    <span class=\"n\">trace</span> <span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span> <span class=\"n\">l.args</span><span class=\"o\">,</span> <span class=\"n\">l.level</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 266023654,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379254
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/Highest.20universe.20in.20mathlib/near/266022841\">said</a>:</p>\n<blockquote>\n<p><code>finprod_mem_empty</code> needs four universes? I still don't think I understand the question :-)</p>\n</blockquote>\n<p>I don't think I understand most of these examples either ... is it possible that many of them are just \"mistakes\"?  People mis-using universes when writing the lemma/definition?</p>",
        "id": 266023749,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1640379472
    },
    {
        "content": "<ul>\n<li><code>finsum_mem_empty.{u_1 u_4}</code> has max universe <code>max (u_1+4) (u_4+2)</code> because it uses <code>finsum.{u_4 u_1+1}</code></li>\n<li><code>finsum.{u_1 u_2}</code> has max universe <code>max (u_1+2) (u_2+3)</code>, because it uses <code>set.finite.to_finset.{u_2}</code></li>\n<li><code>set.finite.to_finset.{u}</code> has max universe <code>u+3</code>, because it uses <code>set.finite.fintype.{u}</code></li>\n<li><code>set.finite.fintype.{u}</code> has max universe <code>u+3</code>, because it uses <code>set.has_coe_to_sort.{u}</code></li>\n<li><code>set.has_coe_to_sort.{u}</code> has max universe <code>u+3</code>, because it uses <code>has_coe_to_sort.mk.{(max (u+1) 1) u+2}</code></li>\n<li><code>has_coe_to_sort.mk.{u v}</code> has max universe <code>max u (v+1)</code>, because its type uses <code>out_param.{v+1}</code></li>\n<li><code>out_param.{u}</code> has max universe <code>u</code>, because it mentions <code>Sort u</code></li>\n</ul>",
        "id": 266023832,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379598
    },
    {
        "content": "<p>It seems that the index types alpha,beta,iota are allowed to be <code>Sort</code>s however <code>finset</code> takes a <code>Type</code>, that's what all the plift nonsense is all about.</p>",
        "id": 266023921,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640379626
    },
    {
        "content": "<p>I don't think that anything like that is going to cause spurious universe bumps</p>",
        "id": 266023943,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379661
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">set.has_coe_to_sort.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"n\">has</span> <span class=\"n\">max</span> <span class=\"kd\">universe</span> <span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">3</span><span class=\"o\">,</span> <span class=\"n\">because</span> <span class=\"n\">it</span> <span class=\"n\">uses</span> <span class=\"n\">has_coe_to_sort.mk.</span><span class=\"o\">{(</span><span class=\"n\">max</span> <span class=\"o\">(</span><span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"mi\">1</span><span class=\"o\">)</span> <span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>lol what is this?</p>",
        "id": 266023956,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640379674
    },
    {
        "content": "<p>whether the indexing starts at 0 or 1 for a given universe variable doesn't really matter</p>",
        "id": 266023958,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379678
    },
    {
        "content": "<p>yeah that one is a bit surprising</p>",
        "id": 266023963,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379698
    },
    {
        "content": "<p>but you can see it clearly in the pp.all</p>",
        "id": 266023968,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379718
    },
    {
        "content": "<p>Note that in the <code>has_coe_to_sort.mk</code> step, I'm actually looking at the <em>type</em> of the definition rather than the value (since it's a constructor). Looking at types can cause universe bumps, since <code>Type u : Type (u+1)</code> - if you insist that the type be well formed for the value to be then you will get no upper bound</p>",
        "id": 266024163,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640379972
    },
    {
        "content": "<p>Here's another way to look at the derivation:</p>\n<ul>\n<li><code>finsum_mem_empty.{0 0}</code> uses <code>finsum.{0 1}</code></li>\n<li><code>finsum.{0 1}</code> uses <code>set.finite.to_finset.{1}</code></li>\n<li><code>set.finite.to_finset.{1}</code> uses <code>set.finite.fintype.{1}</code></li>\n<li><code>set.finite.fintype.{1}</code> uses <code>set.has_coe_to_sort.{1}</code></li>\n<li><code>set.has_coe_to_sort.{1}</code> uses <code>has_coe_to_sort.mk.{2 3}</code></li>\n<li><code>has_coe_to_sort.mk.{2 3}</code> uses <code>out_param.{4}</code></li>\n<li><code>out_param.{4}</code> contains <code>Sort 4</code></li>\n</ul>\n<p>The last two examples might help to understand what's happening:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">finsum_mem_empty.</span><span class=\"o\">{</span><span class=\"mi\">0</span> <span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">finsum.</span><span class=\"o\">{</span><span class=\"mi\">0</span> <span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">set.finite.to_finset.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">set.finite.fintype.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">set.has_coe_to_sort.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">has_coe_to_sort.mk.</span><span class=\"o\">{</span><span class=\"mi\">2</span> <span class=\"mi\">3</span><span class=\"o\">}</span>\n<span class=\"c1\">-- has_coe_to_sort.mk.{2 3} : Π {a : Type 1} {S : out_param.{4} (Type 2)}, (a → S) → has_coe_to_sort.{2 3} a S</span>\n<span class=\"k\">#check</span> <span class=\"bp\">@</span><span class=\"n\">out_param.</span><span class=\"o\">{</span><span class=\"mi\">4</span><span class=\"o\">}</span>\n<span class=\"c1\">-- out_param.{4} : Type 3 → Type 3</span>\n</code></pre></div>\n<p><code>out_param</code> is just an identity function, but in order to apply the identity function to <code>Type 2</code> you need a <code>Type 3</code> to write the type of the argument</p>",
        "id": 266024592,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640380687
    },
    {
        "content": "<p>If the uses of <code>set.has_coe_to_sort</code> were replaced by <code>subtype</code>, would this get rid of the +3 universe bump?</p>",
        "id": 266024621,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1640380786
    },
    {
        "content": "<p>here's a simplified example how you can get lots of bumping without really doing anything weird</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"bp\">@</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">id</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"mi\">3</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"mi\">2</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"kt\">Type</span> <span class=\"mi\">1</span><span class=\"o\">))</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"n\">true</span>\n</code></pre></div>",
        "id": 266024694,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640380881
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> Yes, you have to eliminate the uses of <code>set.has_coe_to_sort</code> in dependents as well, but this version drops the level of <code>set.finite.fintype</code> from u+3 to u+1:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span> <span class=\"n\">set.finite'</span> <span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">set</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span> <span class=\"n\">intro</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">subtype</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"bp\">→</span> <span class=\"n\">set.finite'</span>\n\n<span class=\"kd\">lemma</span> <span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"n\">set.finite_def'</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"n\">set.finite'</span> <span class=\"n\">s</span> <span class=\"bp\">↔</span> <span class=\"n\">nonempty</span> <span class=\"o\">(</span><span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">subtype</span> <span class=\"n\">s</span><span class=\"o\">))</span> <span class=\"o\">:=</span> <span class=\"o\">⟨</span><span class=\"bp\">λ</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">⟩,</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">⟩,</span> <span class=\"bp\">λ</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">⟩,</span> <span class=\"o\">⟨</span><span class=\"n\">h</span><span class=\"o\">⟩⟩</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"n\">set.finite.fintype'</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">set</span> <span class=\"n\">α</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">set.finite'</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">fintype</span> <span class=\"o\">(</span><span class=\"n\">subtype</span> <span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">:=</span>\n<span class=\"n\">classical.choice</span> <span class=\"bp\">$</span> <span class=\"n\">set.finite_def'.1</span> <span class=\"n\">h</span>\n</code></pre></div>",
        "id": 266025023,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640381378
    },
    {
        "content": "<p>Hmm, maybe <code>set.has_coe_to_sort</code> should be considered harmful ...</p>",
        "id": 266025137,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1640381491
    },
    {
        "content": "<p>Probably a better approach for determining the real axiomatic strength of mathlib would be to allow for higher universes that don't support inductive types at all. As long as you only use them in <code>id</code> applications like this that might be sufficient.</p>",
        "id": 266025197,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640381608
    },
    {
        "content": "<p>Looking at this some more, <code>finsum.{0 1} :  Π {M α : Type}, ...</code> which looks normal, but it references</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">set.finite.to_finset.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"o\">:</span> <span class=\"bp\">Π</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"mi\">1</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">s</span> <span class=\"o\">:</span> <span class=\"n\">set</span> <span class=\"n\">α</span><span class=\"o\">},</span> <span class=\"n\">s.finite</span> <span class=\"bp\">→</span> <span class=\"n\">finset</span> <span class=\"n\">α</span>\n</code></pre></div>\n<p>which seems gratuitous (why are we dealing with sets of elements in Type 1?). I suspect the reason is <code>plift : Sort u -&gt; Type u</code>. Perhaps we should try changing that to <code>plift : Sort u -&gt; Sort (max u 1)</code> and see what breaks</p>",
        "id": 266027209,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640384593
    },
    {
        "content": "<p>Oh, that won't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[irreducible]</span> <span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">finsum</span> <span class=\"o\">{</span><span class=\"n\">M</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span> <span class=\"n\">u</span><span class=\"o\">}</span> <span class=\"o\">{</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Sort</span> <span class=\"n\">v</span><span class=\"o\">}</span> <span class=\"o\">[</span><span class=\"n\">add_comm_monoid</span> <span class=\"n\">M</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">M</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">M</span> <span class=\"o\">:=</span>\n<span class=\"k\">if</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">finite</span> <span class=\"o\">(</span><span class=\"n\">support</span> <span class=\"o\">(</span><span class=\"n\">f</span> <span class=\"bp\">∘</span> <span class=\"n\">plift.down</span><span class=\"o\">))</span> <span class=\"k\">then</span> <span class=\"bp\">∑</span> <span class=\"n\">i</span> <span class=\"k\">in</span> <span class=\"n\">h.to_finset</span><span class=\"o\">,</span> <span class=\"n\">f</span> <span class=\"n\">i.down</span> <span class=\"k\">else</span> <span class=\"mi\">0</span>\n</code></pre></div>\n<p>Here <code>support (f ∘ plift.down)</code> is needed because <code>support</code> takes a <code>Type u'</code>, and if you had a variant of <code>plift</code> returning <code>Sort (max v 1)</code> then it wouldn't unify with <code>Type u'</code> because <code>u' + 1 = max v 1</code> does not have a solution for <code>u'</code> in level arithmetic</p>",
        "id": 266027340,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1640384769
    },
    {
        "content": "<p>try <code>induction v</code>? ;-)</p>",
        "id": 266028993,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640386925
    },
    {
        "content": "<p>Whose idea was it to sum over Props anyway?</p>",
        "id": 266029011,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640386958
    },
    {
        "content": "<p>It was my idea</p>",
        "id": 266034940,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1640395714
    },
    {
        "content": "<p>This way you can write <code>\\sum^f n &lt; 5, n</code></p>",
        "id": 266034960,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1640395789
    },
    {
        "content": "<p>We need pfinsum :-)</p>",
        "id": 266035141,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640396045
    },
    {
        "content": "<p>Why? You won't get nice notation if you don't use the same <code>def</code> for sums over <code>n : nat</code> and <code>hn : n &lt; 5</code>.</p>",
        "id": 266036956,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1640399314
    },
    {
        "content": "<p>Do you really care about universe bump here?</p>",
        "id": 266036962,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1640399336
    },
    {
        "content": "<p>For me, I find <code>∑ᶠ n &lt; 5, n</code> more important than avoiding universe bumps.</p>",
        "id": 266041913,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1640408131
    },
    {
        "content": "<p>I have heard of people who believe in the Axiom of Choice up to some aleph-n (n = 2 or 3 I think?). I haven't heard of anyone who doesn't believe in at most 3 inaccessible cardinals. So I'm curious why we care</p>",
        "id": 266071843,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1640459899
    },
    {
        "content": "<p>Because I tell ZFC people that obviously it all works in ZFC?</p>",
        "id": 266076291,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1640467538
    },
    {
        "content": "<p>I recently gave a talk at Big Proof about this topic, so I may as well resuscitate the meta program so we can run it on modern mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LevelSpec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Level</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\">     </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">l₁</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l₁</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"bp\">.</span><span class=\"n\">atZero</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">l₁</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">l₁</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\">           </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GetConstSpec</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">visited</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">levels</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameMap</span><span class=\"w\"> </span><span class=\"n\">LevelSpec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">StateRefT</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">IO</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getExprLevel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameMap</span><span class=\"w\"> </span><span class=\"n\">LevelSpec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">runST</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">forEach</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">us</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">findD</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">([],</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkLevelMax'</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">l'</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">us'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkLevelMax'</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"bp\">.</span><span class=\"n\">instantiateParams</span><span class=\"w\"> </span><span class=\"n\">us'</span><span class=\"w\"> </span><span class=\"n\">us</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkLevelMax'</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">l'</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ensureConstSpec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">visited</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">visited</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">visited</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">unreachable!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">value?</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">getUsedConstants</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ensureConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">levels</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getExprLevel</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">normalize</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">hasParam</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">levelParams</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">([],</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">levels</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">levels</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">LevelSpec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">ensureConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">levels</span><span class=\"bp\">.</span><span class=\"n\">find!</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">explainDefinition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{n}.{l.1}: {l.2}</span><span class=\"se\">\\n</span><span class=\"s2\">====\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"unknown\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">value?</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">getUsedConstants</span><span class=\"bp\">.</span><span class=\"n\">qsort</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">{n}.{l.1}: {l.2}\"</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">msg</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">explainDefinition</span><span class=\"w\"> </span><span class=\"ss\">``Int.noConfusionType.withCtorType</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getMinimalDefinitionsAbove</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">isUnsafe</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">isPartial</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">atZero</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"unknown\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">getUsedConstantsAsSet</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">value?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">foldConsts</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">atZero</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"bp\">.</span><span class=\"n\">qsort</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">lt</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{← (← getMinimalDefinitionsAbove 3).mapM mkConstWithLevelParams}\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getMaximalDefinitions</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">isUnsafe</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">isPartial</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstSpec</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">atZero</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">n</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"bp\">.</span><span class=\"n\">qsort</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{← getMaximalDefinitions}\"</span>\n</code></pre></div>",
        "id": 524798526,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750291136
    },
    {
        "content": "<p>That says the highest universe in Lean is 2, and the highest in Mathlib is 3 for me, with many of the things achieving 3 being about condensed sets</p>",
        "id": 524799157,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1750291593
    },
    {
        "content": "<p>To my surprise, the number on mathlib has <em>decreased</em> to 3 since I ran this test 4 years ago. To take the example of <code>finsum_mem_empty</code> which was previously the poster child of a level 4 definition, it is now just level 1 with the following trace:</p>\n<ul>\n<li><code>finsum_mem_empty.[u_1, u_5]: u_1+1</code></li>\n<li><code>finsum.[u_7, u_8]: u_7+1</code></li>\n<li><code>wrapped._@.Mathlib.Algebra.BigOperators.Finprod._hyg.33.[u_7, u_8]: u_8+1</code></li>\n<li><code>definition._@.Mathlib.Algebra.BigOperators.Finprod._hyg.33.[u_2, u_4]: u_2+1</code></li>\n<li><code>Set.Finite.toFinset.[u]: u+1</code></li>\n<li><code>Set.Elem.[u]: u+1</code> <span aria-label=\"exclamation\" class=\"emoji emoji-2757\" role=\"img\" title=\"exclamation\">:exclamation:</span> </li>\n<li><code>Set.[u]: u+1</code></li>\n</ul>\n<p>The <code>Set.Elem</code> line replaces the previous use of <code>set.has_toe_to_sort</code> which was responsible for a +2 bump; it is now only a +1 bump because coercions in lean 4 are eagerly unfolded.</p>",
        "id": 524799569,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750292008
    },
    {
        "content": "<p>Here is the list of minimal level 3 definitions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">CondensedSet</span>\n<span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">univ</span>\n<span class=\"n\">CommRingCat</span><span class=\"bp\">.</span><span class=\"n\">moduleCatExtendScalarsPseudofunctor</span>\n<span class=\"n\">CommRingCat</span><span class=\"bp\">.</span><span class=\"n\">moduleCatRestrictScalarsPseudofunctor</span>\n<span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">univ</span>\n<span class=\"n\">PartialFun</span><span class=\"bp\">.</span><span class=\"n\">instInhabited</span>\n<span class=\"n\">RingCat</span><span class=\"bp\">.</span><span class=\"n\">moduleCatRestrictScalarsPseudofunctor</span>\n<span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">lt_univ</span><span class=\"bp\">.</span><span class=\"n\">match_1_1</span>\n<span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">lt_univ'</span><span class=\"bp\">.</span><span class=\"n\">match_1_1</span>\n<span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">lt_univ'</span><span class=\"bp\">.</span><span class=\"n\">match_1_3</span>\n<span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Cat</span><span class=\"bp\">.</span><span class=\"n\">instInhabited</span>\n<span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Quiv</span><span class=\"bp\">.</span><span class=\"n\">instInhabited</span>\n</code></pre></div>",
        "id": 524800052,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750292594
    },
    {
        "content": "<p>I am pleased to see that they actually have something to do with universes now</p>",
        "id": 524800067,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750292620
    },
    {
        "content": "<p>and a derivation for <code>CondensedSet</code>:</p>\n<ul>\n<li><code>CondensedSet.{0}</code> uses <code>CategoryTheory.types.{1}</code></li>\n<li><code>CategoryTheory.types.{1}</code> uses <code>CategoryTheory.LargeCategory.{1}</code></li>\n<li><code>CategoryTheory.LargeCategory.{1}</code> uses <code>Type 2</code> aka <code>Sort 3</code></li>\n</ul>",
        "id": 524800858,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750293428
    },
    {
        "content": "<p>actually the type of <code>CondensedSet.{0}</code> is already <code>Type 2</code></p>",
        "id": 524800883,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750293466
    },
    {
        "content": "<p><code>Cardinal.univ</code> is the existence of a \"small\" inaccessible, so I think level 3 definitions correspond to things that should require 1 inaccessible on top of ZFC. Level 2 definitions seem to be roughly ZFC level</p>",
        "id": 524801048,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750293670
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524801048\">said</a>:</p>\n<blockquote>\n<p><code>Cardinal.univ</code> is the existence of a \"small\" inaccessible, so I think level 3 definitions correspond to things that should require 1 inaccessible on top of ZFC. Level 2 definitions seem to be roughly ZFC level</p>\n</blockquote>\n<p>What do you mean by a small inaccessible specifically?</p>",
        "id": 524803986,
        "sender_full_name": "James E Hanson",
        "timestamp": 1750297022
    },
    {
        "content": "<p>Indeed, <code>CommRingCat.moduleCatExtendScalarsPseudofunctor</code> (and the similar names including \"pseudofunctor\") is a quite big object: it is the pseudofunctor which sends a commutative ring <code>R : Type u</code> to the category of modules over <code>R</code> (which is itself a large category).</p>",
        "id": 524869105,
        "sender_full_name": "Joël Riou",
        "timestamp": 1750334147
    },
    {
        "content": "<p>I wonder if it would be more interesting to see the list of declaration whose value/proof term has higher universe than the ones mentioned in the type/statement.</p>",
        "id": 524869891,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1750334439
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> that's what this list is</p>",
        "id": 524897216,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750342989
    },
    {
        "content": "<p>the full list of level 3 definitions is longer, this is just the ones that are minimal in the dependency order, meaning that all direct dependencies are level 2 or lower</p>",
        "id": 524897319,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750343022
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"904624\">James E Hanson</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524803986\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524801048\">said</a>:</p>\n<blockquote>\n<p><code>Cardinal.univ</code> is the existence of a \"small\" inaccessible, so I think level 3 definitions correspond to things that should require 1 inaccessible on top of ZFC. Level 2 definitions seem to be roughly ZFC level</p>\n</blockquote>\n<p>What do you mean by a small inaccessible specifically?</p>\n</blockquote>\n<p>It asserts that an object which is inaccessible is an element of another type (not a universe), so I'm not sure how you would be able to model that without real inaccessibles. That is, if you have <code>Cardinal</code> alone then you can argue that this is a proper class in ZFC land, but if you define <code>Cardinal.univ := |Cardinal|</code> and assert <code>Cardinal.univ : Cardinal</code> now you've asserted that this inaccessible thing is itself an element of a set so it has to be a small (i.e. \"real\") inaccessible</p>",
        "id": 524897870,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750343204
    },
    {
        "content": "<p>It's possible that you can still argue that this isn't <em>really</em> using inaccessibles by saying that this higher structure is just formal stuff and the universe so constructed is very deficient, but so far I haven't found an analysis good enough to do that</p>",
        "id": 524898264,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750343343
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524869891\">said</a>:</p>\n<blockquote>\n<p>I wonder if it would be more interesting to see the list of declaration whose value/proof term has higher universe than the ones mentioned in the type/statement.</p>\n</blockquote>\n<p>Oh, I realize I misinterpreted this question. I agree that looking at types is a bit sketchy, because it obviously leads to universe bumping in some situations. The problem is that it's not clear how to analyze axiomatic definitions (like inductive types and constructors) without looking at the types, since they have no definition to inspect</p>",
        "id": 524899226,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750343664
    },
    {
        "content": "<p>The test is easy enough to perform though. Removing the type checking for definitions, theorems, and opaques but leaving it for inductives and axioms actually reduces the max level in mathlib to 2, and the list of level 2 definitions is entirely composed of higher order class definitions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Alternative</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AlternativeMonad</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Applicative</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bifunctor</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bind</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bitraversable</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Class</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CompHausLike</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">CondensedMod</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CondensedSet</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ContextFreeGrammar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">EquivFunctor</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Functor</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Locale</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Monad</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadCont</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">MonadFinally</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadShareCommon</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonomialOrder</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MvPFunctor</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pure</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">QPF</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Seq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SeqLeft</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SeqRight</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Traversable</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">small_type</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Aesop</span><span class=\"bp\">.</span><span class=\"n\">MonadStats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Bicategory</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Bundled</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Category</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">CategoryStruct</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Groupoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Mat_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Computability</span><span class=\"bp\">.</span><span class=\"n\">Encoding</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">Computability</span><span class=\"bp\">.</span><span class=\"n\">FinEncoding</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Condensed</span><span class=\"bp\">.</span><span class=\"n\">instHasLimitsOfSizeModuleCat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CondensedMod</span><span class=\"bp\">.</span><span class=\"n\">instHasLimitsOfSizeModuleCat</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadError</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadQuotation</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadRecDepth</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadRef</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadRuntimeException</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadWithOptions</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PartialFun</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Plausible</span><span class=\"bp\">.</span><span class=\"n\">SampleableExt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">MonadTraverser</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">PGame</span><span class=\"bp\">.</span><span class=\"n\">ListShort</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">PGame</span><span class=\"bp\">.</span><span class=\"n\">Short</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">LCNF</span><span class=\"bp\">.</span><span class=\"n\">MonadScope</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Compiler</span><span class=\"bp\">.</span><span class=\"n\">LCNF</span><span class=\"bp\">.</span><span class=\"n\">TraverseFVar</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">Selectable</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 524900143,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750343996
    },
    {
        "content": "<p>I tried to answer Andrew's question on my own (I think it was asking something a bit different), and I am getting confused by <code>Expr.foldM</code> -- it only returns the direct subterms, not all deep subterms of the term, right? Is then <code>getExprLevel</code> really searching through the entire term?</p>",
        "id": 524904311,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750345370
    },
    {
        "content": "<p>btw, I thought the question was: For each constant calculate two numbers:</p>\n<ol>\n<li>Maximal universe used both in type and value</li>\n<li>Maximal universe used in type only</li>\n</ol>\n<p>Find the maximum difference (1) - (2).</p>",
        "id": 524905085,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750345631
    },
    {
        "content": "<p>the difference can't be more than 1 I think</p>",
        "id": 524906351,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750346068
    },
    {
        "content": "<p>In principle it can -- it is possible to state the consistency of ZFC &amp; 42 inaccessibles only using finite structures (safely within Type 0) but then you need more then 42 universes to prove it. Of course we expect such things not happening much in practice but would be nice to know.</p>",
        "id": 524906732,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750346208
    },
    {
        "content": "<p>oh, wait I misread 2, I thought you meant value only</p>",
        "id": 524906826,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750346247
    },
    {
        "content": "<p>I'm doing tests with value and value + type</p>",
        "id": 524906867,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750346266
    },
    {
        "content": "<p>type only is not very relevant, since I'm trying to figure out what it takes to do the proof (what it takes to write the statement is accounted for in the definitions involved in the statement anyway)</p>",
        "id": 524907035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750346340
    },
    {
        "content": "<p>To me, constructing a term of type <code>Sort 3</code> of course involves 3 universes, and this isn’t really doing anything fishy. But if there is a result that is statable in <code>Sort 3</code> but the proof involves <code>Sort 5</code> then something weird is going on and I would consider this as “using two extra universes”</p>",
        "id": 524907642,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1750346568
    },
    {
        "content": "<p>My philosophical take is that I don't really care about highly abstract objects that are using high universes, and about their interpretations. I have a statement that I understand as a set-theorist, such as FLT, and I want to be able to tell (after Kevin succeeds), if I will have a ZFC proof of it, or not. Only the occurrence of these \"weird abstract objects\" inside proofs / objects that should be ZFC-understandable forces me to give them an interpretation (depending on how they are used). So it would be nice to see some examples of this happening.</p>",
        "id": 524908069,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750346726
    },
    {
        "content": "<p>Maybe someone needs to formalise McLarty's paper that derived functor cohomology of a topos (from SGA) is do-able in higher-order arithmetic.</p>",
        "id": 524924294,
        "sender_full_name": "David Michael Roberts",
        "timestamp": 1750353288
    },
    {
        "content": "<p>I am fine with ZFC, no need to push it to arithmetic so far :-). But no problem, I can imagine there are some points in mathematical proofs that require large universes but can be circumvented. Looking up the largest difference (value-universe) minus (type-universe) could expose such moments that deserve attention. Perhaps sometimes, the universe reduction could be automated, sometimes it requires manual care.</p>",
        "id": 524925929,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750354123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Olšák</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524904311\">said</a>:</p>\n<blockquote>\n<p>I tried to answer Andrew's question on my own (I think it was asking something a bit different), and I am getting confused by <code>Expr.foldM</code> -- it only returns the direct subterms, not all deep subterms of the term, right? Is then <code>getExprLevel</code> really searching through the entire term?</p>\n</blockquote>\n<p>You're right, this was a bug, I've fixed it above. Unfortunately it now takes a lot longer, and I haven't run it on mathlib yet. The maximum universe used in lean is now reported as 3, with almost all of the level 3 definitions being generated functions from the <code>Int.noConfusionType.withCtorType</code> family:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">noConfusionType</span><span class=\"bp\">.</span><span class=\"n\">withCtorType</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">ctorIdx</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">bif</span><span class=\"w\"> </span><span class=\"n\">ctorIdx</span><span class=\"bp\">.</span><span class=\"n\">blt</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>",
        "id": 524929062,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750355952
    },
    {
        "content": "<p>the reason this is level 3 is because it uses <code>cond.{3}</code> because the type of the two arms of the <code>bif</code> are <code>Type 1 : Type 2</code></p>",
        "id": 524929610,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750356177
    },
    {
        "content": "<p>and the reason the arms are in <code>Type 1</code> instead of <code>Type</code> is because of the use of <code>PUnit.{2}</code> for no apparent reason</p>",
        "id": 524929791,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750356273
    },
    {
        "content": "<p>Results from mathlib (it takes about 15 minutes): Highest universe is 5 now! Here are the winners:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">instCartesianClosedCondensedSet</span>\n<span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">lift_lt_univ</span>\n<span class=\"n\">CondensedMod</span><span class=\"bp\">.</span><span class=\"n\">epi_iff_locallySurjective_on_compHaus</span>\n<span class=\"n\">CondensedMod</span><span class=\"bp\">.</span><span class=\"n\">epi_iff_surjective_on_stonean</span>\n<span class=\"n\">CondensedSet</span><span class=\"bp\">.</span><span class=\"n\">epi_iff_locallySurjective_on_compHaus</span>\n<span class=\"n\">CondensedSet</span><span class=\"bp\">.</span><span class=\"n\">epi_iff_surjective_on_stonean</span>\n<span class=\"n\">ENat</span><span class=\"bp\">.</span><span class=\"n\">card_plift</span>\n<span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">card_plift</span>\n<span class=\"n\">PSet</span><span class=\"bp\">.</span><span class=\"n\">rank_eq_wfRank</span>\n<span class=\"n\">PartENat</span><span class=\"bp\">.</span><span class=\"n\">card_plift</span>\n<span class=\"n\">ZFSet</span><span class=\"bp\">.</span><span class=\"n\">rank_eq_wfRank</span>\n<span class=\"n\">CondensedMod</span><span class=\"bp\">.</span><span class=\"n\">LocallyConstant</span><span class=\"bp\">.</span><span class=\"n\">instIsIsoCondensedSetMapForgetAppCondensedModuleCatCounitDiscreteUnderlyingAdjObjFunctor</span>\n</code></pre></div>",
        "id": 524933864,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750358571
    },
    {
        "content": "<p>So, is it always one more than the Lean version?</p>",
        "id": 524935353,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750359399
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524929791\">schrieb</a>:</p>\n<blockquote>\n<p>and the reason the arms are in <code>Type 1</code> instead of <code>Type</code> is because of the use of <code>PUnit.{2}</code> for no apparent reason</p>\n</blockquote>\n<p>I wrote that code recently (<a href=\"https://github.com/leanprover/lean4/pull/8037\">https://github.com/leanprover/lean4/pull/8037</a>), and I put in the PUnit here to get all the various branches or <code>withCtorType</code> to the same universe level. Maybe this isn't actually needed? It was in my testing. Or maybe I'm just off by one?</p>",
        "id": 524936436,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750360064
    },
    {
        "content": "<p>I think you are off by one</p>",
        "id": 524936464,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750360093
    },
    {
        "content": "<p>You could also use ULift to ensure they have the same level</p>",
        "id": 524936501,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750360117
    },
    {
        "content": "<p>PR welcome in that case!</p>",
        "id": 524936521,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750360126
    },
    {
        "content": "<p>Here's a traceback for <code>instCartesianClosedCondensedSet</code>:</p>\n<ul>\n<li><code>instCartesianClosedCondensedSet.{0}</code> uses</li>\n<li><code>CategoryTheory.instCartesianClosedFunctorType_1.{0, 1}</code> uses</li>\n<li><code>CategoryTheory.cartesianClosedFunctorToTypes.{0, 1, 1}</code> uses</li>\n<li><code>CategoryTheory.instCartesianClosedFunctorType.{1}</code> uses</li>\n<li><code>CategoryTheory.instCartesianClosedFunctorType._proof_1.{1}</code> uses</li>\n<li><code>CategoryTheory.Presheaf.isLeftAdjoint_of_preservesColimits.{1,1,2}</code> uses</li>\n<li><code>CategoryTheory.Presheaf.instIsLeftKanExtensionFunctorOppositeTypeIdCompYonedaOfPreservesColimitsOfSizeOfHasPointwiseLeftKanExtension.{1,1,2}</code> uses</li>\n<li><code>CategoryTheory.Presheaf.isLeftKanExtension_of_preservesColimits.{1,1,2}</code> uses</li>\n<li><code>CategoryTheory.Presheaf.isLeftKanExtension_along_yoneda_iff.{1,1,2}</code> uses</li>\n<li><code>CategoryTheory.Presheaf.preservesColimitsOfSize_leftKanExtension.{1,1,1,2,1}</code> uses</li>\n<li><code>CategoryTheory.Functor.instIsLeftKanExtensionLeftKanExtensionLeftKanExtensionUnit.{1,2,2,1,1,1}</code> uses</li>\n<li><code>CategoryTheory.Limits.initialIsInitial.{2,2}</code> uses</li>\n<li><code>CategoryTheory.Limits.initialIsInitial._proof_2.{2,2}</code> uses</li>\n<li><code>CategoryTheory.Limits.colimit.hom_ext.{0,0,2,2}</code> uses</li>\n<li><code>CategoryTheory.Limits.IsColimit.hom_ext.{0,2,0,2}</code> uses</li>\n<li><code>eq_of_heq.{4}</code> uses</li>\n<li><code>rfl.{5}</code> uses</li>\n<li><code>Eq.refl.{5}</code> uses</li>\n<li><code>Eq.{5}</code> uses <code>Sort 5</code></li>\n</ul>",
        "id": 524936583,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750360159
    },
    {
        "content": "<p>I tried ULift but it worked less good when I tried. Don't remember the details, though. Maybe Max vs imax or so</p>",
        "id": 524936597,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750360168
    },
    {
        "content": "<p>I was surprised by the <code>CategoryTheory.Limits.IsColimit.hom_ext</code> line; it seems this is the consequence of using <code>congr</code> to rewrite the statement including an instance <code>inst : (CategoryTheory.Category.{2, 2} C : Type 3)</code>. And <code>eq_of_heq</code> has a proof that actually involves a universe bump because it uses equality of types while proving something about equality of values</p>",
        "id": 524938132,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750361249
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> How does <code>congr! 3; exact funext w</code> do in that proof? I think <code>congr!</code> might avoid the type equality proofs, but I'm not sure.</p>",
        "id": 524939778,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750362280
    },
    {
        "content": "<p>I think it is the same</p>",
        "id": 524939826,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750362301
    },
    {
        "content": "<p>the problem is that the congruence lemma for <code>IsColimit.desc</code> involves all the arguments, even though we aren't rewriting the parameters like the category instance</p>",
        "id": 524939922,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750362347
    },
    {
        "content": "<p>and these are proved in a roundabout way using <code>eq_of_heq HEq.rfl</code> which itself involves an unnecessary bump</p>",
        "id": 524940000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750362392
    },
    {
        "content": "<p>oh no you are right, <code>congr!</code> produces a proof term without the bump</p>",
        "id": 524940387,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750362627
    },
    {
        "content": "<p>I was investigating why relatively innocent-looking <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Int/Linear.html#Int.Linear.Poly.denote%27_go_eq_denote\"><code>Int.Linear.Poly.denote'_go_eq_denote</code></a> (from Lean core) has maximal recursive universe level 3, Turns out that <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/AC.html#Lean.Data.AC.Variable\"><code>Lean.Data.AC.Variable</code></a> could have been defined to have <code>Sort (max 1 u)</code> instead of <code>Type u</code>.</p>\n<ul>\n<li>Would it be possible to define <code>Lean.Data.AC.Variable</code> as <code>Sort (max 1 u)</code> in the library? Is is desired?  I was not able to keep <code>Lean.Data.AC.Context</code> as <code>Type u</code> then (and  I am not certain of the purpose of <code>Lean.Data.AC</code>).</li>\n<li>Could the analysis tool detect such universe lifts? I guess it might be non-trivial to get through the <code>PLift</code> (unless explicitly stated).</li>\n</ul>",
        "id": 525163822,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750517930
    },
    {
        "content": "<p>can you just remove the type ascription on that structure?</p>",
        "id": 525163944,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750518033
    },
    {
        "content": "<p>all of these are lean internals, and the ones involved in writing tactic code don't matter. This one does matter I think since <code>Int.Linear.Poly</code> theorems are generated by omega</p>",
        "id": 525164007,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750518103
    },
    {
        "content": "<p>Yes, the trouble is with later putting <code>Variable</code>s into a <code>List</code>. Somehow, <code>List</code>s do not like to carry objects of type <code>Sort (max 1 u)</code></p>",
        "id": 525164017,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750518113
    },
    {
        "content": "<p>Yes, since <code>List</code> takes a <code>Type u</code> as argument you can only put <code>Type _</code> into a list</p>",
        "id": 525164042,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750518158
    },
    {
        "content": "<p>You can write <code>α : Type u</code> instead of <code>α : Sort u</code>, which I think solves the awkward universe lift</p>",
        "id": 525164061,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750518187
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/525164042\">said</a>:</p>\n<blockquote>\n<p>Yes, since <code>List</code> takes a <code>Type u</code> as argument you can only put <code>Type _</code> into a list</p>\n</blockquote>\n<p>That's why we need inaccessible cardinals : <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 525164093,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750518222
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/525164061\">said</a>:</p>\n<blockquote>\n<p>You can write <code>α : Type u</code> instead of <code>α : Sort u</code>, which I think solves the awkward universe lift</p>\n</blockquote>\n<p>Yes, that is an option, I am not sure if <code>Variable</code> ever wants to get <code>Sort 0</code> as a parameter, perhaps not.</p>",
        "id": 525164133,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750518272
    },
    {
        "content": "<p>are you saying you don't do linear arithmetic over the vector space of proofs of a proposition?</p>",
        "id": 525164181,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750518313
    },
    {
        "content": "<p>What is wrong with Boolean algebras? Apparently</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">explainDefinition</span><span class=\"w\"> </span><span class=\"ss\">``compl_compl</span><span class=\"w\">  </span><span class=\"c1\">-- compl_compl.[u]: u+3</span>\n<span class=\"c1\">-- ...</span>\n<span class=\"c1\">-- BooleanAlgebra.toBiheytingAlgebra.[u]: u+3</span>\n<span class=\"c1\">-- ...</span>\n</code></pre></div>\n<p>Can you share the code that produces the trace<br>\n<span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524936583\">said</a>:</p>\n<blockquote>\n<ul>\n<li><code>instCartesianClosedCondensedSet.{0}</code> uses</li>\n<li><code>CategoryTheory.instCartesianClosedFunctorType_1.{0, 1}</code> uses</li>\n<li><code>CategoryTheory.cartesianClosedFunctorToTypes.{0, 1, 1}</code> uses<br>\n...</li>\n</ul>\n</blockquote>\n<p>By the way, I tried to understand where <code>Nat.card_plift</code> uses universe level 5. Part of the story is that to calculate <code>Nat.card_plift</code>, we first calculate the <code>Cardinal</code> in the appropriate universe, and then convert it first to <code>ENat</code>, and then <code>Nat</code>. The conversion itself has relatively tame universe levels but then we are \"for fun\" proving that it is an order &amp; additive &amp; multiplicative homomorphism which sometimes causes universe bumps, and one of them is the mentioned <code>BooleanAlgebra</code> thing.</p>",
        "id": 525208784,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750592555
    },
    {
        "content": "<p>After further investigation, the excessive universe levels in boolean algebras boil down to our good old friend <code>Lean.Data.AC.Variable</code>. Perhaps I should really edit Lean Core...</p>",
        "id": 525234400,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750627571
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Olšák</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/525208784\">said</a>:</p>\n<blockquote>\n<p>Can you share the code that produces the trace</p>\n</blockquote>\n<p>I'm afraid I used a sophisticated neural network for that (using biological materials), it's a bit hard to reproduce</p>",
        "id": 525234497,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750627749
    },
    {
        "content": "<p>no problem, I will implement some AI to replace it then</p>",
        "id": 525234586,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750627913
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Nat.card_plift.[u_3]: u_3+5\n====\nNat.card.[u_3+1]-&gt;u_3+5\nNat.card_congr.[u_3+1, u_3]-&gt;u_3+5\n\nNat.card.[u_3]: u_3+4\n====\nCardinal.toNat.[u_3]-&gt;u_3+4\n\nCardinal.toNat.[u_1]: u_1+4\n====\nCardinal.toENat.[u_1]-&gt;u_1+4\n\nCardinal.toENat.[u]: u+4\n====\nCardinal.toENat.proof_2.[u]-&gt;u+4\nCardinal.toENat.proof_3.[u]-&gt;u+4\nCardinal.toENat.proof_4.[u]-&gt;u+4\n\nCardinal.toENat.proof_2.[u_1]: u_1+4\n====\nCardinal.canLiftCardinalNat.[u_1]-&gt;u_1+4\nCardinal.one_le_iff_ne_zero.[u_1]-&gt;u_1+4\nCardinal.toENatAux_eq_top.[u_1]-&gt;u_1+4\nCardinal.toENatAux_eq_zero.[u_1]-&gt;u_1+4\n\nCardinal.canLiftCardinalNat.[u_1]: u_1+4\n====\nCardinal.lt_aleph0.[u_1]-&gt;u_1+4\n\nCardinal.lt_aleph0.[u_1]: u_1+4\n====\nCardinal.nat_lt_aleph0.[u_1]-&gt;u_1+4\n\nCardinal.nat_lt_aleph0.[u]: u+4\n====\nCardinal.instSuccOrder.[u]-&gt;u+4\nCardinal.nat_succ.[u]-&gt;u+4\n\nCardinal.instSuccOrder.[u_1]: u_1+4\n====\nCardinal.instConditionallyCompleteLinearOrderBot.[u_1]-&gt;u_1+4\nCardinal.instWellFoundedLT.[u_1]-&gt;u_1+4\n\nCardinal.instConditionallyCompleteLinearOrderBot.[u_1]: u_1+4\n====\nCardinal.instWellFoundedLT.[u_1]-&gt;u_1+4\nWellFoundedLT.conditionallyCompleteLinearOrderBot.[u_1+1]-&gt;u_1+4\n\nCardinal.instWellFoundedLT.[u]: u+4\n====\nCardinal.lt_wf.[u]-&gt;u+4\n\nCardinal.lt_wf.[u]: u+4\n====\nFunction.Embedding.min_injective.[u+1, u]-&gt;u+4\n\nFunction.Embedding.min_injective.[u, v]: max (u+3) (v+3)\n====\nzorn_subset.[max u v]-&gt;(max u v)+3\nMaximal.eq_of_subset.[max u v]-&gt;max 3 ((max u v)+2)\nSet.instIsReflSubset.[max u v]-&gt;(max u v)+3\nSet.subset_sUnion_of_mem.[max u v]-&gt;max 3 ((max u v)+2)\n\nzorn_subset.[u_1]: u_1+3\n====\nzorn_le₀.[u_1]-&gt;u_1+3\nSet.instCompleteAtomicBooleanAlgebra.[u_1]-&gt;max 3 (u_1+2)\n\nzorn_le₀.[u_1]: u_1+3\n====\nzorn_le.[u_1]-&gt;u_1+3\n\nzorn_le.[u_1]: u_1+3\n====\nexists_maximal_of_chains_bounded.[u_1]-&gt;u_1+3\n\nexists_maximal_of_chains_bounded.[u_1]: u_1+3\n====\nmaxChain_spec.[u_1]-&gt;u_1+3\n\nmaxChain_spec.[u_1]: u_1+3\n====\nSuccChain.[u_1]-&gt;u_1+3\nSuperChain.[u_1]-&gt;u_1+3\nChainClosure.isChain.[u_1]-&gt;u_1+3\nChainClosure.succ_fixpoint_iff.[u_1]-&gt;u_1+3\nIsChain.superChain_succChain.[u_1]-&gt;u_1+3\nSet.instHasSSubset.[u_1]-&gt;u_1+3\nSet.instIsIrreflSSubset.[u_1]-&gt;u_1+3\nmaxChain_spec.match_1.[u_1]-&gt;u_1+3\n\nSuccChain.[u_1]: u_1+3\n====\nSuperChain.[u_1]-&gt;u_1+3\n\nSuperChain.[u_1]: u_1+3\n====\nSet.instHasSSubset.[u_1]-&gt;u_1+3\n\nSet.instHasSSubset.[u]: u+3\n====\nBooleanAlgebra.toBiheytingAlgebra.[u]-&gt;u+3\nSet.instBooleanAlgebra.[u]-&gt;max 3 (u+2)\n\nBooleanAlgebra.toBiheytingAlgebra.[u]: u+3\n====\nGeneralizedBooleanAlgebra.toGeneralizedCoheytingAlgebra.[u]-&gt;u+3\nBooleanAlgebra.toBiheytingAlgebra.proof_3.[u]-&gt;u+3\n\nGeneralizedBooleanAlgebra.toGeneralizedCoheytingAlgebra.[u]: u+3\n====\nGeneralizedBooleanAlgebra.toGeneralizedCoheytingAlgebra.proof_2.[u]-&gt;u+3\n\nGeneralizedBooleanAlgebra.toGeneralizedCoheytingAlgebra.proof_2.[u_1]: u_1+3\n====\ninf_sdiff_self_left.[u_1]-&gt;u_1+3\ninf_sdiff_self_right.[u_1]-&gt;u_1+3\n_private.Mathlib.Order.BooleanAlgebra.0.sdiff_sup_self'.[u_1]-&gt;u_1+3\nLean.Data.AC.Context.eq_of_norm.[u_1+1]-&gt;u_1+3\n\ninf_sdiff_self_left.[u]: u+3\n====\ninf_sdiff_self_right.[u]-&gt;u+3\n\ninf_sdiff_self_right.[u]: u+3\n====\nsdiff_inf_sdiff.[u]-&gt;u+3\n\nsdiff_inf_sdiff.[u]: u+3\n====\nLean.Data.AC.Context.eq_of_norm.[u+1]-&gt;u+3\n\nLean.Data.AC.Context.eq_of_norm.[u_1]: max (u_1+2) (imax (max 1 u_1) u_1)\n====\ninstDecidableEqNat.[]-&gt;2\ninstDecidableEqNat.[]-&gt;2\nList.instBEq.[0]-&gt;2\nList.instBEq.[0]-&gt;2\nList.instLawfulBEq.[0]-&gt;2\nNat.instLawfulBEq.[]-&gt;2\nLean.Data.AC.eval.[u_1, u_1+1]-&gt;max (max 2 (u_1+1)) (imax (max 1 u_1) u_1)\nLean.Data.AC.eval.[u_1, u_1+1]-&gt;max (max 2 (u_1+1)) (imax (max 1 u_1) u_1)\nLean.Data.AC.evalList.[u_1, u_1+1]-&gt;max (max 2 (u_1+1)) (imax (max 1 u_1) u_1)\nLean.Data.AC.instContextInformationContext.[u_1]-&gt;u_1+2\nLean.Data.AC.instContextInformationContext.[u_1]-&gt;u_1+2\nLean.Data.AC.instEvalInformationContext.[u_1]-&gt;u_1+2\nLean.Data.AC.instEvalInformationContext.[u_1]-&gt;u_1+2\nLean.Data.AC.norm.[u_1+1]-&gt;max 2 (u_1+1)\nLean.Data.AC.norm.[u_1+1]-&gt;max 2 (u_1+1)\nLean.Data.AC.Context.eval_norm.[u_1]-&gt;max (u_1+2) (imax (max 1 u_1) u_1)\n\ninstDecidableEqNat.[]: 2\n====\nNat.decEq.[]-&gt;2\n\nNat.decEq.[]: 2\n====\nNat.beq.[]-&gt;2\nNat.eq_of_beq_eq_true.[]-&gt;2\nNat.ne_of_beq_eq_false.[]-&gt;2\n\nNat.beq.[]: 2\n====\nNat.below.[1]-&gt;2\nNat.brecOn.[1]-&gt;2\n\nNat.below.[u]: max 2 (u+1)\n====\nNat.rec.[(max 1 u)+1]-&gt;(max 1 u)+1\n\nNat.rec.[u]: max 1 u\n====\nNat.[]-&gt;1\nNat.succ.[]-&gt;1\nNat.zero.[]-&gt;1\n\nNat.[]: 1\n====\n</code></pre></div>",
        "id": 525236965,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750631296
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524936464\">schrieb</a>:</p>\n<blockquote>\n<p>I think you are off by one</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/8972\">https://github.com/leanprover/lean4/pull/8972</a>. Will wait for the mathlib ci infrastructure to work again before merging, in case that uncovers issues with this.</p>",
        "id": 525472549,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750755822
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/524936501\">schrieb</a>:</p>\n<blockquote>\n<p>You could also use ULift to ensure they have the same level</p>\n</blockquote>\n<p>Tried that as well, and it wasn’t a drop-in replacement, as <code>ULift</code> lifts two <code>Type</code>s to their max. </p>\n<p>If I generalize <code>ULift</code> to wrap a <code>Sort</code> instead:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">- structure ULift.{r, s} (α : Type s) : Type (max s r) where</span>\n<span class=\"gi\">+ structure ULift.{r, s} (α : Sort s) : Sort (max s (r+1)) where</span>\n</code></pre></div>\n<p>and also avoid my construction for inductive props (which don’t have interesting <code>noConfusionTypes</code> anyways), then I can use <code>ULift</code>.</p>\n<p>Furthermore, because <code>PUnit u → …</code> involves <code>imax</code> but <code>ULift</code> involves <code>max</code> this fixes <a href=\"https://github.com/leanprover/lean4/pull/8962\">lean4#8962</a>, although probably doesn’t solve all issues of that kind while level equality checking is incomplete.</p>\n<p>This ULift generalization looks harmless and backwards compatible as long as the second level parameter is inferred (which the docstring for ULift points out as an explicit feature of that parameter order). Do you see a problem with that generalization?</p>",
        "id": 525528693,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750774392
    },
    {
        "content": "<p>I think <code>ULift</code> is better than using <code>PUnit -&gt;</code> here, because the latter introduces an <code>imax</code> you probably want to avoid</p>",
        "id": 525528900,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750774443
    },
    {
        "content": "<p>I suggested a change to your version to use <code>Sort max s r 1</code> instead, but this will change the indexing for downstream uses</p>",
        "id": 525529101,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750774495
    },
    {
        "content": "<p>maybe it would be better to take your version of <code>ULift</code> and make mine <code>PULift</code></p>",
        "id": 525529654,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750774657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/525529101\">schrieb</a>:</p>\n<blockquote>\n<p>but this will change the indexing for downstream uses</p>\n</blockquote>\n<p>What do you mean with indexing? Explicit instantiation of the <code>r</code> parameter?</p>",
        "id": 525530525,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750774914
    },
    {
        "content": "<p>yes</p>",
        "id": 525530603,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750774931
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PULift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">down</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>\n<p>I assume</p>",
        "id": 525530741,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750774970
    },
    {
        "content": "<p>incidentally, this also subsumes <code>PLift</code></p>",
        "id": 525530951,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750775021
    },
    {
        "content": "<p>and if we can get people away from <code>PLift.{u}</code> that will prevent some more spurious universe bumps</p>",
        "id": 525531063,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750775051
    },
    {
        "content": "<p>(<code>PLift.{0}</code> is fine, but also subsumed if we have these new things)</p>",
        "id": 525531147,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750775074
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Highest.20universe.20in.20mathlib/near/525530951\">schrieb</a>:</p>\n<blockquote>\n<p>incidentally, this also subsumes <code>PLift</code></p>\n</blockquote>\n<p>Either variant subsumes PLift, right?</p>",
        "id": 525531539,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750775179
    },
    {
        "content": "<p>yes</p>",
        "id": 525531611,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750775196
    },
    {
        "content": "<p>Put the variant that breaks less code up at PR <a href=\"https://github.com/leanprover/lean4/pull/8975\">https://github.com/leanprover/lean4/pull/8975</a></p>",
        "id": 525534542,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1750776043
    },
    {
        "content": "<p>Another typical reason for an unnecessary extra universe is the default way how recursion is done using <code>below</code> and <code>brecOn</code>. Compare</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">lowLevGet?</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">getFromTail?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">getFromTail?</span><span class=\"w\"> </span><span class=\"n\">n'</span>\n<span class=\"w\">  </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">recursGet?</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">::</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">recursGet?</span><span class=\"w\"> </span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"n\">t</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">explainDefinition</span><span class=\"w\"> </span><span class=\"ss\">``lowLevGet?</span><span class=\"w\">  </span><span class=\"c1\">-- lowLevGet?.[u]: u+1</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">explainDefinition</span><span class=\"w\"> </span><span class=\"ss\">``recursGet?</span><span class=\"w\">  </span><span class=\"c1\">-- recursGet?.[u]: u+2</span>\n</code></pre></div>\n<p>But I suppose here the analysis tool should probably detect that the motive didn't need to be recursively defined...</p>",
        "id": 525596582,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1750799755
    }
]