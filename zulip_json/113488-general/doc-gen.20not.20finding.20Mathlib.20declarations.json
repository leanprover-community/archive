[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> do you understand why searching for <code>CategoryTheory.LaxMonoidalFunctor</code> on <a href=\"https://emilyriehl.github.io/infinity-cosmos/docs\">https://emilyriehl.github.io/infinity-cosmos/docs</a> finds nothing despite the existence of <a href=\"https://emilyriehl.github.io/infinity-cosmos/docs/Mathlib/CategoryTheory/Monoidal/Functor.html#CategoryTheory.LaxMonoidalFunctor\">https://emilyriehl.github.io/infinity-cosmos/docs/Mathlib/CategoryTheory/Monoidal/Functor.html#CategoryTheory.LaxMonoidalFunctor</a>? It looks like the index does not contain Mathlib stuff.</p>",
        "id": 473131377,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727449369
    },
    {
        "content": "<p>Note this is the documentation of a project depending on Mathlib, and this declaration is in Mathlib.</p>",
        "id": 473131531,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727449416
    },
    {
        "content": "<p>Not obvious to me at first glance no</p>",
        "id": 473132131,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727449574
    },
    {
        "content": "<p>Does <code>lake build</code> in your project build <code>CategoryTheory.LaxMonoidalFunctor</code>?</p>",
        "id": 473132152,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727449580
    },
    {
        "content": "<p>I'll think about it</p>",
        "id": 473132154,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727449581
    },
    {
        "content": "<p>doc-gen only builds the files that are imported by your library</p>",
        "id": 473132186,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727449594
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/doc-gen.20not.20finding.20Mathlib.20declarations/near/473132152\">said</a>:</p>\n<blockquote>\n<p>Does <code>lake build</code> in your project build <code>CategoryTheory.LaxMonoidalFunctor</code>?</p>\n</blockquote>\n<p>Well yes otherwise the docs page wouldn't exist</p>",
        "id": 473132223,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727449606
    },
    {
        "content": "<p>Oh sorry, I misread the second link</p>",
        "id": 473132295,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727449627
    },
    {
        "content": "<p>Ah yeah, so I have noticed the same bug in APAP. It's unclear to me where it comes from</p>",
        "id": 473132411,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727449669
    },
    {
        "content": "<p>It would be nice to understand this because it causes issues for blueprints which refer to Mathlib declarations.</p>",
        "id": 473132827,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727449801
    },
    {
        "content": "<p>Very interested to know the answer to this one! </p>\n<p>It would be crucial to allow Mathlib declarations in blueprint dependency graphs. The workaround for me has always been to have a local Project/Mathlib folder but it's very far from convenient.</p>",
        "id": 473132908,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1727449812
    },
    {
        "content": "<p>I'm a bit surprised this happens at all given that it just works for mathlibs own deps</p>",
        "id": 473133063,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727449867
    },
    {
        "content": "<p>Okay I can give a few insights into this. I tried to just build the docs locally and I noticed :</p>\n<ol>\n<li>The important one: Everything just works when built locally, I can lookup <code>LaxMonoidalFunctor</code> and <code>Quiver</code> and whatever else in the search bar and it finds things, so this is not doc-gen's fault, it is the fault of whatever it is that is talking to doc-gen.</li>\n<li>If you check the declaration data storage in the javascript in the browser for the hosted version you can indeed observer that the mathlib parts are missing. That means that when this command is run in your build: <a href=\"https://github.com/leanprover/doc-gen4/blob/main/lakefile.lean#L223\">https://github.com/leanprover/doc-gen4/blob/main/lakefile.lean#L223</a> this code here: <a href=\"https://github.com/leanprover/doc-gen4/blob/1b0072fea2aa6a0ef8ef8b506ec5223b184cb4d0/DocGen4/Output.lean#L139-L157\">https://github.com/leanprover/doc-gen4/blob/1b0072fea2aa6a0ef8ef8b506ec5223b184cb4d0/DocGen4/Output.lean#L139-L157</a> does not find the mathlib declaration-data files anymore and thus fails to index them. Why they are not there I cannot tell you as they are evidently president when just building locally. I know that blueprint does some caching for doc builds? My conjecture for this would be that you are not caching enough.</li>\n<li>I did observe one notable thing which is that in <code>InfinityCosmos.ForMathlib.AlgebraicTopology.HomotopyCat</code> there seem to exist 5 declarations that trip doc-gen up to the point where it panics, congrats, nobody has managed to produce a Lean file that does this in a long time^^ I'll fix that but it is evidently not at fault here as the code is still working</li>\n</ol>",
        "id": 473157458,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727455367
    },
    {
        "content": "<p>Okay the panic is because you are doing something that I thought is impossible. This code here:<br>\n<a href=\"https://github.com/emilyriehl/infinity-cosmos/blob/main/InfinityCosmos/ForMathlib/AlgebraicTopology/HomotopyCat.lean#L430C48-L430C61\">https://github.com/emilyriehl/infinity-cosmos/blob/main/InfinityCosmos/ForMathlib/AlgebraicTopology/HomotopyCat.lean#L430C48-L430C61</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Δ</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"bp\">.</span><span class=\"n\">op</span><span class=\"bp\">.</span><span class=\"n\">fullyFaithful</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Δ</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">op</span><span class=\"bp\">.</span><span class=\"n\">FullyFaithful</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">FullyFaithful</span><span class=\"bp\">.</span><span class=\"n\">ofFullyFaithful</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">op</span>\n</code></pre></div>\n<p>declares an instance of <code>FullyFaithful</code> but <code>FullyFaithful</code> is a <code>structure</code> not a <code>class</code>: <a href=\"https://github.com/leanprover-community/mathlib4/blob/4da4503a07ff4172bedf40581927cd691573d512/Mathlib/CategoryTheory/Functor/FullyFaithful.lean#L121-L125\">https://github.com/leanprover-community/mathlib4/blob/4da4503a07ff4172bedf40581927cd691573d512/Mathlib/CategoryTheory/Functor/FullyFaithful.lean#L121-L125</a>. I had thought that Lean would reject such an <code>instance</code> outright. <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> is this a bug or intended?</p>",
        "id": 473159334,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727455919
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/113488-general/topic/doc-gen.20not.20finding.20Mathlib.20declarations/near/473157458\">said</a>:</p>\n<blockquote>\n<p>Okay I can give a few insights into this. I tried to just build the docs locally and I noticed :</p>\n<ol>\n<li>The important one: Everything just works, I can lookup <code>LaxMonoidalFunctor</code> and <code>Quiver</code> and whatever else in the search bar and it finds things, so this is not doc-gen's fault, it is the fault of whatever it is that is talking to doc-gen.</li>\n</ol>\n</blockquote>\n<p>Really? On <a href=\"https://emilyriehl.github.io/infinity-cosmos/docs/\">https://emilyriehl.github.io/infinity-cosmos/docs/</a>? It certainly doesn’t work here.</p>",
        "id": 473175833,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727460329
    },
    {
        "content": "<p>Yes check 2.</p>",
        "id": 473175941,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727460349
    },
    {
        "content": "<p>Patrick, I think you missed the key phrase before Henrik's (1): \"... build the docs <em>locally</em> ...\"</p>",
        "id": 473182403,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727461637
    },
    {
        "content": "<p>Oh I’m sorry, I read too quickly.</p>",
        "id": 473183249,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727461883
    },
    {
        "content": "<p>Fixed it by caching <code>.lake/build/doc/declarations/declaration-data-InfinityCosmos*</code>.</p>",
        "id": 473219659,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1727474138
    },
    {
        "content": "<p>Coming from <a href=\"https://github.com/PatrickMassot/leanblueprint/pull/47\">PatrickMassot/leanblueprint#47</a> where Patrick asked if there was a motivation for the line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">!.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">/</span><span class=\"n\">declarations</span><span class=\"bp\">/</span><span class=\"n\">declaration</span><span class=\"bp\">-</span><span class=\"n\">data</span><span class=\"bp\">-</span><span class=\"o\">{</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">lib_name</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"o\">}</span><span class=\"bp\">*</span>\n</code></pre></div>\n<p>I can recall that the motivation was to only cache the declaration data for Mathlib and its deps, but rebuild for the project itself every time to prevent stale cache, because rebuilding Mathlib docs is time-consuming and not worth it if Mathlib is not bumped, but the project itself is relatively small, and it's more important to ensure it's up-to-date without cache hassles.</p>\n<p>I don't know how it ends up causing this issue.</p>",
        "id": 473413029,
        "sender_full_name": "Utensil Song",
        "timestamp": 1727586378
    },
    {
        "content": "<p>Thanks Utensil. So I am still confused by this issue. I’d like to merge a fix that both actually fixes the issue and is explainable. I am afraid that the fixing effect that Pietro is observing may be random and not reproducible.</p>",
        "id": 473435919,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727605419
    },
    {
        "content": "<p>The reason behind the change I made was primarily based on point 2 of <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>’s comment <a href=\"#narrow/stream/113488-general/topic/doc-gen.20not.20finding.20Mathlib.20declarations/near/473157458\">here</a>.</p>",
        "id": 473441856,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1727610377
    },
    {
        "content": "<p>The link does not seem to work.</p>",
        "id": 473441981,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727610498
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/113488-general/topic/doc-gen.20not.20finding.20Mathlib.20declarations/near/473157458\">said</a>:</p>\n<blockquote>\n<p>Okay I can give a few insights into this. I tried to just build the docs locally and I noticed :</p>\n<ol>\n<li>The important one: Everything just works when built locally, I can lookup <code>LaxMonoidalFunctor</code> and <code>Quiver</code> and whatever else in the search bar and it finds things, so this is not doc-gen's fault, it is the fault of whatever it is that is talking to doc-gen.</li>\n<li>If you check the declaration data storage in the javascript in the browser for the hosted version you can indeed observer that the mathlib parts are missing. That means that when this command is run in your build: <a href=\"https://github.com/leanprover/doc-gen4/blob/main/lakefile.lean#L223\">https://github.com/leanprover/doc-gen4/blob/main/lakefile.lean#L223</a> this code here: <a href=\"https://github.com/leanprover/doc-gen4/blob/1b0072fea2aa6a0ef8ef8b506ec5223b184cb4d0/DocGen4/Output.lean#L139-L157\">https://github.com/leanprover/doc-gen4/blob/1b0072fea2aa6a0ef8ef8b506ec5223b184cb4d0/DocGen4/Output.lean#L139-L157</a> does not find the mathlib declaration-data files anymore and thus fails to index them. Why they are not there I cannot tell you as they are evidently president when just building locally. I know that blueprint does some caching for doc builds? My conjecture for this would be that you are not caching enough.</li>\n<li>I did observe one notable thing which is that in <code>InfinityCosmos.ForMathlib.AlgebraicTopology.HomotopyCat</code> there seem to exist 5 declarations that trip doc-gen up to the point where it panics, congrats, nobody has managed to produce a Lean file that does this in a long time^^ I'll fix that but it is evidently not at fault here as the code is still working</li>\n</ol>\n</blockquote>\n<p>Here.</p>",
        "id": 473443561,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1727611905
    },
    {
        "content": "<p>I'm baffled by how could having a cached declaration data for <code>InfinityCosmos*</code> would help to solve the issue of declaration data of Mathlib.</p>",
        "id": 473444427,
        "sender_full_name": "Utensil Song",
        "timestamp": 1727612661
    },
    {
        "content": "<p>(I agree)</p>",
        "id": 473444439,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1727612695
    },
    {
        "content": "<p>Yes, this is precisely why I’m asking.</p>",
        "id": 473449661,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1727616796
    }
]