[
    {
        "content": "<p>I notice that <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.FS.createDir\">https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.FS.createDir</a> (and similar IO methods that  are closely wrapping some POSIX filesystem function) return <code>IO Unit</code>, and will throw an exception if something causes the IO operation to fail:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">➤</span><span class=\"w\"> </span><span class=\"n\">bat</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">System</span>\n<span class=\"w\">   </span><span class=\"mi\">2</span>\n<span class=\"w\">   </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"w\">   </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Creating /tmp/testdir\"</span>\n<span class=\"w\">   </span><span class=\"mi\">5</span><span class=\"w\">   </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">createDir</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"bp\">.</span><span class=\"n\">mkFilePath</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"/tmp\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"testdir\"</span><span class=\"o\">]</span>\n\n<span class=\"bp\">➤</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--run test.lean</span>\n<span class=\"n\">Creating</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">testdir</span>\n\n<span class=\"bp\">➤</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--run test.lean</span>\n<span class=\"n\">Creating</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">testdir</span>\n<span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">tmp</span><span class=\"bp\">/</span><span class=\"n\">testdir</span>\n</code></pre></div>\n<p>There does exist an IOError type <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IOError.html\">https://leanprover-community.github.io/mathlib4_docs/Init/System/IOError.html</a> , but it seems like nothing is using it? Is there a reason why the <code>IO.FS</code> functions don't use this type? Is there something I can do intelligently now to try to handle this uncaught exception in lean code without crashing the program?</p>",
        "id": 493812562,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736931887
    },
    {
        "content": "<p>Also, what does this <code>@&amp;</code> syntax in <a href=\"https://github.com/leanprover/lean4/blob/128a1e6b0a82718382f9c39c79be44ff3284547c/src/Init/System/IO.lean#L444-L444\">https://github.com/leanprover/lean4/blob/128a1e6b0a82718382f9c39c79be44ff3284547c/src/Init/System/IO.lean#L444-L444</a> do?</p>",
        "id": 493813211,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736932108
    },
    {
        "content": "<p>Lean does not have exceptions in the classical Java sense, the <code>IO</code> monad handles error handling and  returns <code>IO.Error</code> if an error happens so what you are asking for here is already happening. You can e.g. use the <code>try</code>/<code>catch</code> syntax to work with these errors. </p>\n<p>The <code>@&amp;</code> syntax is relevant for reference counting when doing FFI, it tells the system to not increment the ref counter before calling that function, thus amounting to something like a \"borrow\" of the object.</p>",
        "id": 493814083,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736932396
    },
    {
        "content": "<p>I tried asking Claude to explain it:</p>\n<p>My question</p>\n<blockquote>\n<p>I have an unrelated question. I'm trying to understand this line of code:<br>\n<code>@[extern \"lean_io_create_dir\"] opaque createDir : @&amp; FilePath → IO Unit</code></p>\n<p>I know this is code that calls out to a foreign function written in C - but what does the @&amp; syntax mean?</p>\n</blockquote>\n<p>And claude's response:</p>\n<blockquote>\n<p>The @&amp; syntax in Lean indicates that a parameter is \"borrowed\" - this is a concept related to memory management and performance optimization. Let me break this down step by step:</p>\n<p>In Lean's memory model, parameters can be passed in different ways that affect how they're handled under the hood. The @&amp; annotation tells the compiler that we want to borrow the parameter rather than take ownership of it or make a copy.</p>\n<p>Think of it like lending a book to someone. When you borrow a book:</p>\n<div class=\"codehilite\"><pre><span></span><code>You can read it and use it\nYou can&#39;t modify it or keep it permanently\nThe original owner retains ownership\nIt&#39;s more efficient than making a copy of the whole book\n</code></pre></div>\n\n<p>In your specific example:</p>\n<p>lean</p>\n<p>@[extern \"lean_io_create_dir\"] opaque createDir : @&amp; FilePath → IO Unit</p>\n<p>The @&amp; before FilePath means that createDir will borrow the filepath parameter temporarily while it creates the directory, but won't take ownership of it or modify it. This is particularly useful for foreign function interfaces (FFI) like this one because:</p>\n<div class=\"codehilite\"><pre><span></span><code>It reduces unnecessary copying of data between Lean and C\nIt guarantees to the C code that the filepath parameter will remain valid during the function call\nIt helps the Lean compiler optimize the code better\n</code></pre></div>\n\n<p>To make this more concrete, here's a comparison showing why borrowing can be important:</p>\n<p>lean</p>\n<p>-- Without borrowing, this might need to copy the filepath<br>\ndef createDirectory (path : FilePath) : IO Unit := ...</p>\n<p>-- With borrowing, we can use the filepath directly without copying<br>\ndef createDirectory (@&amp; path : FilePath) : IO Unit := ...</p>\n<p>It's similar to Rust's borrowing system, if you're familiar with that, though Lean's version is somewhat simpler. Just as Rust uses &amp; to indicate borrowing, Lean uses @&amp; to indicate that a parameter is borrowed.</p>\n<p>Would you like me to elaborate on any part of this, or would you like to explore how borrowing interacts with other features of Lean's type system?</p>\n</blockquote>\n<p>I'm curious if there are any important gaps in what the AI told me</p>",
        "id": 493814280,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736932468
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/113488-general/topic/IO.20error.20type/near/493814083\">said</a>:</p>\n<blockquote>\n<p>Lean does not have exceptions in the classical Java sense, the <code>IO</code> monad handles error handling and  returns <code>IO.Error</code> if an error happens so what you are asking for here is already happening. You can e.g. use the <code>try</code>/<code>catch</code> syntax to work with these errors. </p>\n</blockquote>\n<p>Ah okay, I'm used to a rust-style API where the equivalent IO functions return an explicit <code>Result&lt;(), IOError&gt;</code> value and you use Rust's normal <code>Result</code>-handling syntax.</p>",
        "id": 493814809,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736932631
    },
    {
        "content": "<p>That <code>Result</code> is roughly equivalent to the <code>IO</code> monad modulo additional tricks that you need to do for functional programming, I recommend reading up on monads if you are not familiar.</p>",
        "id": 493815421,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736932808
    },
    {
        "content": "<p>I'm familiar with monads <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> I'm just super-used to the rust way of describing monadic types and have to get used to the haskell-ish way again</p>",
        "id": 493815751,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736932935
    },
    {
        "content": "<p>ah okay the <code>IO</code> type is an alias for <code>EIO IO.Error</code>, which is itself an alias for some more complicated monad stack</p>",
        "id": 493816265,
        "sender_full_name": "Greg Shuflin",
        "timestamp": 1736933099
    }
]