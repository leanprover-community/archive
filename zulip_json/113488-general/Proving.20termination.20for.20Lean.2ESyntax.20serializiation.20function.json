[
    {
        "content": "<p>Hi, </p>\n<p>I am currently working on writing code that serializes Lean.Syntax in the compiler (if someone else has done this, please let me know), I am new to proof assistants but have prior fp experience. I am trying to figure out how to prove termination for the following function, I am honestly completely lost:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">serializeSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"atom\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"value\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">rawVal</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">preresolved</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"ident\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"value\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"rawValue\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">rawVal</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"preresolved\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">preresolved</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">serializePreresolved</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">serializedArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">serializeSyntax</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"node\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"kind\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"args\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"n\">serializedArgs</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_wf</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- i have no idea how to prove this</span>\n</code></pre></div>\n<p>Here is the whole file for those who are interested:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Json</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">FromToJson</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span><span class=\"bp\">.</span><span class=\"n\">original</span><span class=\"w\"> </span><span class=\"n\">leading</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">tailPos</span><span class=\"w\"> </span><span class=\"n\">trailing</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"leading\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">leading</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"pos\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">byteIdx</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"tailPos\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">tailPos</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"trailing\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">trailing</span><span class=\"bp\">.</span><span class=\"n\">byteIdx</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span><span class=\"bp\">.</span><span class=\"n\">synthetic</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"n\">tailPos</span><span class=\"w\"> </span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"pos\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">byteIdx</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"tailPos\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">tailPos</span><span class=\"bp\">.</span><span class=\"n\">byteIdx</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"canonical\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"n\">canonical</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">serializePreresolved</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"bp\">.</span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"s2\">\"namespace\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">ns</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"bp\">.</span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">fields</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"decl\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"fields\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fields</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">serializeSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"atom\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"value\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">rawVal</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">preresolved</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"ident\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"value\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"rawValue\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">rawVal</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"preresolved\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">preresolved</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">serializePreresolved</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">serializedArgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">serializeSyntax</span>\n<span class=\"w\">    </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">mkObj</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"type\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"s2\">\"node\"</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"kind\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"args\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"n\">serializedArgs</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"info\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">serializeSourceInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_wf</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- i have no idea how to prove this</span>\n</code></pre></div>",
        "id": 471155053,
        "sender_full_name": "Rohan Ganapavarapu",
        "timestamp": 1726630449
    },
    {
        "content": "<p>In your application, do you need to reason about that program? Else just slap <code>partial</code> on it (<code>partial def …</code>) on it and be done with it :-)</p>",
        "id": 471212959,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1726651784
    },
    {
        "content": "<p>Also, just curious, does <code>deriving instance Lean.ToJson, Lean.FromJson for Lean.Syntax.Preresolved, String.Pos, Substring, Lean.SourceInfo, Lean.Syntax, Lean.TSyntax</code> do what you need, or do you need to use custom json?</p>\n<p>Also, to <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>, would serializing directly to oleans work for you, or do you need the interchange capabilities of json? If the former, you could simply use <code>pickle</code> and <code>withUnpickle</code> (<a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Util/Pickle.html#pickle\">docs</a>), and this would probably be more robust than handling json. :) (I'm <em>pretty</em> sure Lean.Syntax doesn't contain any closures, but I haven't checked.)</p>",
        "id": 471350766,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726694655
    },
    {
        "content": "<p>Hmm, actually, the derived json instances don't behave the way I'd hoped. While the <code>ToJson</code> instance seems alright (at least at first glance), it doesn't behave nicely with the corresponding <code>FromJson</code> instance; for example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">FromJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">SourceInfo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"c1\">-- error: no inductive constructor matched</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"bp\">.</span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">FromJson</span><span class=\"bp\">.</span><span class=\"n\">fromJson?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{x' == x.raw}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{s}</span><span class=\"se\">\\n\\n</span><span class=\"s2\">{json}\"</span>\n</code></pre></div>",
        "id": 471352339,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1726695395
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/stream/113488-general/topic/Proving.20termination.20for.20Lean.2ESyntax.20serializiation.20function/near/471212959\">said</a>:</p>\n<blockquote>\n<p>In your application, do you need to reason about that program? Else just slap <code>partial</code> on it (<code>partial def …</code>) on it and be done with it :-)</p>\n</blockquote>\n<p>Thanks. I have no idea how I didn't know about that... <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 471352947,
        "sender_full_name": "Rohan Ganapavarapu",
        "timestamp": 1726695688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/stream/113488-general/topic/Proving.20termination.20for.20Lean.2ESyntax.20serializiation.20function/near/471350766\">said</a>:</p>\n<blockquote>\n<p>Also, just curious, does <code>deriving instance Lean.ToJson, Lean.FromJson for Lean.Syntax.Preresolved, String.Pos, Substring, Lean.SourceInfo, Lean.Syntax, Lean.TSyntax</code> do what you need, or do you need to use custom json?</p>\n<p>Also, to <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>, would serializing directly to oleans work for you, or do you need the interchange capabilities of json? If the former, you could simply use <code>pickle</code> and <code>withUnpickle</code> (<a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Util/Pickle.html#pickle\">docs</a>), and this would probably be more robust than handling json. :) (I'm <em>pretty</em> sure Lean.Syntax doesn't contain any closures, but I haven't checked.)</p>\n</blockquote>\n<p>I am trying to write a tokenizer for lean for use in a transformer model (ML),  I don't think a binary format would be preferable. </p>\n<p>I didn't know about Lean.ToJson and FromJson, sort of happy it doesn't work so my code doesn't go to waste.</p>",
        "id": 471353760,
        "sender_full_name": "Rohan Ganapavarapu",
        "timestamp": 1726696089
    }
]