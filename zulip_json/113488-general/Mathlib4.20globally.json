[
    {
        "content": "<p>How can i install mathlib4 globally, so that any lean file can source it? I've read some topics about it, but remained unclear on how to do it in more recent versions.</p>",
        "id": 510744150,
        "sender_full_name": "Vinicius de Lima",
        "timestamp": 1744051993
    },
    {
        "content": "<p>It's (still) not an officially supported configuration, but you can use symlinks to make it work</p>",
        "id": 510749206,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744053601
    },
    {
        "content": "<p>This question doesn't quite make sense to me. What do you mean by \"any Lean file\"? A lean file cannot really work unless it's in a Lean project (together with configuration files which say which version of Lean to use with the file) and the if the project has mathlib as a dependency then the config files will say exactly which commit of mathlib (and mathlib has many commits per day) should be being used in the project. So the file has to be in a project and the project has to know which version of mathlib to use. You could override this by manually ensuring that each project always uses the same version of mathlib (which will force you to use the same version of lean which will stop you from updating the project as lean evolves) and then doing some trickery with symlinks in <code>.lake/packages/mathlib</code> I guess?</p>",
        "id": 510749315,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744053638
    },
    {
        "content": "<p>(I autocorrected the request to <span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> 's last sentence. Agreed that you still need to have a project to put your files in, but symlinks let you have multiple projects that share a mathlib and that you can only upgrade in lock step)</p>",
        "id": 510750050,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744053861
    },
    {
        "content": "<p>When i made this question i was thinking about the C++ standard library, that you can import from wherever you want, or if you have the absolute path to the file you could still import it.</p>\n<p>But, thanks for clarifying. So, just to summarize, for importing the same installation of mathlib in every project,  i should creake a <code>lakefile.toml</code> requiring mathlib and symlink my original installation <code>.lake/packages/mathlib</code>?</p>\n<p>Appreciate the help! :D</p>",
        "id": 510752470,
        "sender_full_name": "Vinicius de Lima",
        "timestamp": 1744054659
    },
    {
        "content": "<p>There is no such thing as a global installation of mathlib. But you can make multiple projects, notice that the contents of <code>.lake/packages/mathlib</code> is suspiciously similar between them, and symlink one to the other or both to a location of your choosing.</p>",
        "id": 510752800,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744054797
    },
    {
        "content": "<p>This will occasionally cause problems where lake in one project will stomp on the internal files expected by lake in the other project. It mostly works but there is no warranty</p>",
        "id": 510753004,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744054873
    },
    {
        "content": "<p>You can also use a local path to require mathlib instead of a git url.</p>",
        "id": 510758672,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744056637
    },
    {
        "content": "<p>Is there an open issue for this? I feel like you might have opened one before <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span></p>",
        "id": 510761803,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744057900
    },
    {
        "content": "<p>There's ongoing work on having a local \"source registry\" (offline reservoir), as I understand it</p>",
        "id": 510761930,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744057954
    },
    {
        "content": "<p>I don’t remember opening such an issue. The thing that was crucial for me was not to be able to use the same Mathlib for several project (since this seems very rarely useful). What is crucial for teaching is to be able to have Mathlib in a shared folder that students can’t write to.</p>",
        "id": 510762024,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744057999
    },
    {
        "content": "<p>And this works modulo the fact that you currently need to specify all transitive dependencies in your lakefile, which is a bit painful.</p>",
        "id": 510762086,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058028
    },
    {
        "content": "<p>If you use a reservoir specifier instead of a git url, you can specify the path in addition</p>",
        "id": 510762229,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744058076
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/stream/113488-general/topic/Mathlib4.20globally/near/510762086\">said</a>:</p>\n<blockquote>\n<p>And this works modulo the fact that you currently need to specify all transitive dependencies in your lakefile, which is a bit painful.</p>\n</blockquote>\n<p>If you control the local mathlib copy anyway, you can modify its lakefile instead, rather than putting everything in the student lakefile.</p>",
        "id": 510762344,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744058126
    },
    {
        "content": "<p>My requirements in the lakefile currently look like</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/mathlib\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.15.0-patch1\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"aesop\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/aesop\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"batteries\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/batteries\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Cli\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/Cli\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"importGraph\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/importGraph/\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"LeanSearchClient\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/LeanSearchClient/\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"plausible\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/plausible\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"proofwidgets\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/proofwidgets/\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Qq\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/Qq\"</span>\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"verbose\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/doc_enseignants/massot/verbose\"</span>\n</code></pre></div>",
        "id": 510762405,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058151
    },
    {
        "content": "<p>I think it would be very useful to have a global install which is a soup of versioned files like what cache does</p>",
        "id": 510762433,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744058161
    },
    {
        "content": "<p>It’s true I could also modify the Mathlib lakefile.</p>",
        "id": 510762486,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058167
    },
    {
        "content": "<p>But students never see the lakefile content anyway.</p>",
        "id": 510762504,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058177
    },
    {
        "content": "<p>I can see the possibility of having a global dump of stuff making storage issues worse though if it isn't aggressively GC'd</p>",
        "id": 510762897,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744058353
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib4.20globally/near/510762504\">said</a>:</p>\n<blockquote>\n<p>But students never see the lakefile content anyway.</p>\n</blockquote>\n<p>I guess this depends on the students and the course. If you have a small number of students who might want to publish their class project at the end, then having a lakefile that's minimally different from upstream is probably a good thing. But if you're teaching basics then indeed it would be pointless.</p>",
        "id": 510763083,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744058416
    },
    {
        "content": "<p>There are no projects. It’s all about doing exercises that are ready made.</p>",
        "id": 510763220,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058476
    },
    {
        "content": "<p>And it’s using Verbose Lean, which is not exactly “minimally different from upstream”.</p>",
        "id": 510763381,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058543
    },
    {
        "content": "<p>I’m talking about <a href=\"https://github.com/PatrickMassot/proofs_with_lean/\">https://github.com/PatrickMassot/proofs_with_lean/</a></p>",
        "id": 510763566,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744058632
    },
    {
        "content": "<p>For reference, the combined version I was referring to above I think would be something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"git#v4.15.0\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/mathlib\"</span>\n</code></pre></div>\n<p>though perhaps <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> can confirm</p>",
        "id": 510765110,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744059243
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Ah, that will just always use the path. Lake does not currently support mutiple sources.</p>",
        "id": 510765782,
        "sender_full_name": "Mac Malone",
        "timestamp": 1744059547
    },
    {
        "content": "<p>But you can backspace the path at least to get the normal behavior, so it's only a one-line diff?</p>",
        "id": 510765851,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744059582
    },
    {
        "content": "<p>Is there a roadmap / tracking issue for the \"source replacement\" feature? I'd like to be able to check the status without having to ping you :)</p>",
        "id": 510765949,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744059614
    },
    {
        "content": "<p>True. Also, using <code>rev</code>  works just as well:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.15.0\"</span>\n<span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"/opt/lean/lib/mathlib\"</span>\n</code></pre></div>",
        "id": 510766044,
        "sender_full_name": "Mac Malone",
        "timestamp": 1744059657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib4.20globally/near/510765949\">said</a>:</p>\n<blockquote>\n<p>Is there a roadmap / tracking issue for the \"source replacement\" feature? I'd like to be able to check the status without having to ping you :)</p>\n</blockquote>\n<p>The basic system is already implemented as <code>--packages</code> (<a href=\"https://github.com/leanprover/lean4/pull/6411\">lean4#6411</a>).  Did you mean something more?</p>",
        "id": 510766629,
        "sender_full_name": "Mac Malone",
        "timestamp": 1744059919
    },
    {
        "content": "<p>When I have more time to dedicate to that area, I do hope to implement a user-wide version of the same thing (and eventually standardize the Reservoir index format as an even better replacment). Lake will be getting a user-local cache this quarter, so adding <code>package-overrides.json</code> as well to the user-wide Lake configuration should hopefully be easy to squeeze in.</p>",
        "id": 510767081,
        "sender_full_name": "Mac Malone",
        "timestamp": 1744060083
    },
    {
        "content": "<p>I guess adding <code>.lake/package-overrides.json</code> to a course repo would be sufficient then, and no changes to lakefiles would be needed?</p>",
        "id": 510768518,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744060622
    },
    {
        "content": "<p>(I had indeed forgotten the PR you linked above, despite the fact that I commented on it)</p>",
        "id": 510768570,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744060652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/Mathlib4.20globally/near/510762897\">said</a>:</p>\n<blockquote>\n<p>I can see the possibility of having a global dump of stuff making storage issues worse though if it isn't aggressively GC'd</p>\n</blockquote>\n<p>Like an opam switch?</p>",
        "id": 510770128,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744061306
    },
    {
        "content": "<p>opam switches are very manual, I'm not a fan</p>",
        "id": 510772574,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744062312
    },
    {
        "content": "<p>you have to actively manage your installation and this is a recipe for disaster with users who are learning the ropes</p>",
        "id": 510772699,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744062364
    },
    {
        "content": "<p>Right. Another question : Couldn’t mathlib be installed with the toolchain somehow?</p>",
        "id": 510773022,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744062519
    },
    {
        "content": "<p>And then just linked to projects by lake?</p>",
        "id": 510773127,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744062542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib4.20globally/near/510762433\">said</a>:</p>\n<blockquote>\n<p>I think it would be very useful to have a global install which is a soup of versioned files like what cache does</p>\n</blockquote>\n<p>You may be happy to learn that is what I am working on this quarter. :-)</p>",
        "id": 510773261,
        "sender_full_name": "Mac Malone",
        "timestamp": 1744062611
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/Mathlib4.20globally/near/510772574\">said</a>:</p>\n<blockquote>\n<p>opam switches are very manual, I'm not a fan</p>\n</blockquote>\n<p>True, but opam can list all installed switches which can be deleted at will. Further if a project is still using a switch that was “deleted “, then opam re creates that switch as I recall</p>",
        "id": 510773618,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744062787
    },
    {
        "content": "<p>Not too dissimilar to what elan does with toolchains (as far as installing and deleting them goes). Of course opam switches go further by also installing packages centrally with the switch</p>",
        "id": 510773759,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744062849
    },
    {
        "content": "<p>yes, this is basically like elan toolchains. I think people will have to be actively cleaning them up much more often, esp. mathlib contributors since there is a new mathlib every day</p>",
        "id": 510774008,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744062976
    },
    {
        "content": "<p>How does Nix do garbage collection?</p>",
        "id": 510774068,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063008
    },
    {
        "content": "<p>Couldn’t we tack that on?</p>",
        "id": 510774085,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063018
    },
    {
        "content": "<p>I think you could do something with reference counting</p>",
        "id": 510774123,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744063037
    },
    {
        "content": "<p>Okay, but we could also have more aggressive deletion policies</p>",
        "id": 510775701,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063772
    },
    {
        "content": "<p>And when necessary lake would just get a deleted toolchain re installed (maybe marking it as “don’t remove” until it wants to use that toolchain and removing the marking if the project’s toolchain is updated)</p>",
        "id": 510775850,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063838
    },
    {
        "content": "<p>Mark and sweep garbage collection</p>",
        "id": 510775916,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063888
    },
    {
        "content": "<p>Slightly better, when a project is created or built with lake, some metadata is added to or deleted from the toolchain folder about the directory of the project that is using that toolchain. The GC just checks this list of folders and if none of them exist anymore, then it deletes the toolchain.</p>",
        "id": 510776116,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744063990
    },
    {
        "content": "<p>I think that's also just reference counting</p>",
        "id": 510777037,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744064453
    },
    {
        "content": "<p>Do you mean this link? <a href=\"https://leanprover-community.github.io/mathlib-manual/html-multi/Guides/Shared-Mathlib-Installation/#Mathlib-Manual--Guides--Shared-Mathlib-Installation\">https://leanprover-community.github.io/mathlib-manual/html-multi/Guides/Shared-Mathlib-Installation/#Mathlib-Manual--Guides--Shared-Mathlib-Installation</a></p>",
        "id": 510837057,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744087844
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"366779\">Jz Pan</span> <a href=\"#narrow/channel/113488-general/topic/Mathlib4.20globally/near/510837057\">said</a>:</p>\n<blockquote>\n<p>Do you mean this link? <a href=\"https://leanprover-community.github.io/mathlib-manual/html-multi/Guides/Shared-Mathlib-Installation/#Mathlib-Manual--Guides--Shared-Mathlib-Installation\">https://leanprover-community.github.io/mathlib-manual/html-multi/Guides/Shared-Mathlib-Installation/#Mathlib-Manual--Guides--Shared-Mathlib-Installation</a></p>\n</blockquote>\n<p>This is a workaround. I'd like it to be the default way lake + elan manage mathilib dependencies (currently only lake is involved).</p>",
        "id": 510908492,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1744112377
    }
]