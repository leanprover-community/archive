[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394803\">@Jared green</span> We are planning to release Canonical this Spring!</p>",
        "id": 492006545,
        "sender_full_name": "Chase Norman",
        "timestamp": 1736118645
    },
    {
        "content": "<p>Spring in which hemisphere? :)</p>",
        "id": 492007361,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736119480
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> What is Canonical?</p>",
        "id": 492011215,
        "sender_full_name": "Jason Rute",
        "timestamp": 1736123199
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"115715\">@Jason Rute</span> <a href=\"https://chasenorman.com\">chasenorman.com</a> It's an automated theorem prover for dependent type theory. If you recall, it was the big goal I was discussing at IPAM Machine Assisted Proofs.</p>",
        "id": 492238328,
        "sender_full_name": "Chase Norman",
        "timestamp": 1736222098
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> will it eventually be a lean tactic (either native or through a hammer-like interface or through a plugin)?  How does it compare to Duper in both scope and capabilities?  What applications will it shine on?  How does it handle many available premises or many applicable premises?  Does it need a premise/lemma selector for real-world applications?  It works by application, right?  So does/will it use the Lean discrimination tree for the <code>apply?</code> tactic, or does it have it’s own data structures?</p>",
        "id": 492302722,
        "sender_full_name": "Jason Rute",
        "timestamp": 1736253881
    },
    {
        "content": "<p>Also <span class=\"user-mention\" data-user-id=\"372571\">@Victor Maia</span> says his tool can be used for proof synthesis in Lean (or Kind, his theorem prover).  So maybe it is a competitor to Duper or Canonical.  <a href=\"https://x.com/victortaelin/status/1876579350382096745?s=46\">https://x.com/victortaelin/status/1876579350382096745?s=46</a></p>",
        "id": 492319845,
        "sender_full_name": "Jason Rute",
        "timestamp": 1736260097
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"115715\">@Jason Rute</span> Canonical will be a Lean tactic on Day 1, through a hammer-like interface. Canonical is a sound and complete proof search for dependent type theory, and generates terms--not tactic based proofs. </p>\n<p>Canonical has no knowledge of theories like equality, natural numbers, or classical logic. It receives this information directly from Lean's internal representation. Canonical is made for higher-order reasoning where you intend to have a short proof term as a witness; think synthesizing motives for (generalized) induction or other axiom schema, working with user-written (indexed) inductive types, program synthesis by specification or examples, proof minimization, non-Prop types like isomorphisms and typeclasses, generating multiple witnesses of a given type, etc. </p>\n<p>This is in contrast to Duper, which is strong at inhabiting Prop types for problems that translate into a first-order logic, and can handle large numbers of premises and well-understood theories like equality and LEM. Duper is intended to close goals where you don't really care what is generated. Canonical replaces itself with an exact proof term upon completion and does not stay in your code. </p>\n<p>To facilitate millions of steps per second and a complete search procedure, Canonical has its own internal representation and outputs a complete term without interacting with Lean.</p>",
        "id": 492396534,
        "sender_full_name": "Chase Norman",
        "timestamp": 1736287814
    },
    {
        "content": "<p>That sounds nice</p>",
        "id": 492847663,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1736469023
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>  can we get a more precise time frame for the availability of Canonical?</p>",
        "id": 502377424,
        "sender_full_name": "Jared green",
        "timestamp": 1740690491
    },
    {
        "content": "<p>I have found <code>suggest_premises</code>  tactic is added in Lean. <br>\nany related?</p>",
        "id": 504241656,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741415388
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394803\">@Jared green</span> April</p>",
        "id": 504257901,
        "sender_full_name": "Chase Norman",
        "timestamp": 1741426816
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>  where your page says Canonical only generates canonical forms, how is that defined? how do you assure that?</p>",
        "id": 504459188,
        "sender_full_name": "Jared green",
        "timestamp": 1741574561
    },
    {
        "content": "<p>IIUC it normalizes things at parse time</p>",
        "id": 504708479,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1741650053
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394803\">@Jared green</span>  <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> In general it does <em>not</em> require normalization at parse time. Canonical cannot place a lambda inside an application (by construction), cannot place a constructor in the major argument of a recursor/projection (hard-coded), and always places as many lambdas as is required to be eta-long (by construction, nontrivial). In this sense it only searches canonical forms. The internal representation of Canonical is BNEL, but can support beta unreduced forms using let definitions.</p>",
        "id": 504709006,
        "sender_full_name": "Chase Norman",
        "timestamp": 1741650334
    },
    {
        "content": "<p>You can choose which definitions Canonical can use, so canonicity with respect to delta reduction is at the user’s discretion.</p>",
        "id": 504709236,
        "sender_full_name": "Chase Norman",
        "timestamp": 1741650461
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> can we get a more precise release time for Canonical?</p>",
        "id": 509303731,
        "sender_full_name": "Jared green",
        "timestamp": 1743456242
    },
    {
        "content": "<p>For those on this thread that have been waiting for quite some time, I want to inform you that Canonical is \"released.\" The tactic, source code, arXiv paper, and demo videos are on my website <a href=\"https://chasenorman.com\">https://chasenorman.com</a>. I have spent much of the past month battling build and link issues, and these are still ongoing. I'm choosing not to make a big announcement on this Zulip and elsewhere yet, because:</p>\n<ol>\n<li><a href=\"https://github.com/leanprover/lean4/issues/7917\">precompileModules is broken on the latest version of MacOS.</a></li>\n<li><a href=\"https://github.com/chasenorman/CanonicalLean/issues/1\"><code>lake build</code> and VSCode builds expect dynlibs to be in different places.</a></li>\n<li>I am struggling to get <code>buildArchive</code> to download from a github release, so I am not currently packaging dynlibs for Intel Macs or Linux on Arm. </li>\n<li>The <code>dynlibs</code> feature intended to directly support the linking of dynamic libraries has not been released yet (coming with <code>v4.19.0</code>).</li>\n<li>Users that attempt to reset their build by deleting the Canonical package directory will find that it is not compiled upon redownloading.</li>\n<li>There are miscellaneous build issues even for some users meeting the system requirements, such as <code>undefined symbol: lean_alloc_small</code> on Ubuntu, <code>missing symbols</code> and <code>ld64.lld: error: library not found for -lcanonical</code> on MacOS.</li>\n<li>Windows users require extra installation instructions to ensure that the <code>canonical.dll</code> is linked.  </li>\n</ol>\n<p>In short, I want to make sure that users have an easy time installing Canonical, and Lean's dynlib functionality is still being developed.</p>",
        "id": 512980236,
        "sender_full_name": "Chase Norman",
        "timestamp": 1744957806
    },
    {
        "content": "<p>I also encountered a build issue, which seems to be different from those above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">initializer</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">initialize_canonical'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">134</span>\n</code></pre></div>\n<p>For me, this reproduces by checking out <a href=\"https://github.com/leanprover-community/mathlib4/tree/canonical\">branch#canonical</a> of Mathlib and typing <code>lake build</code>.</p>",
        "id": 513236396,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745123214
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I think on 4.19 they are revamping the “plugin” system. Perhaps trying this on 4.18 will avoid this particular error.</p>",
        "id": 513237589,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745124075
    },
    {
        "content": "<p>Thanks, I've rebased <a href=\"https://github.com/leanprover-community/mathlib4/tree/canonical\">branch#canonical</a> on the <code>v4.18.0</code> tag of Mathlib, and now get the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">library</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dlopen</span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">kim</span><span class=\"bp\">/</span><span class=\"n\">projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"mi\">4</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Canonical</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Canonical</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0009</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Library</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">loaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">loader_path</span><span class=\"bp\">/</span><span class=\"n\">libcanonical</span><span class=\"bp\">.</span><span class=\"n\">dylib</span>\n<span class=\"w\">  </span><span class=\"n\">Referenced</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"mi\">4</span><span class=\"n\">C4C4429</span><span class=\"bp\">-</span><span class=\"mi\">5555</span><span class=\"bp\">-</span><span class=\"mi\">3144</span><span class=\"bp\">-</span><span class=\"n\">A1EB</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"n\">D39C1A645EE</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">kim</span><span class=\"bp\">/</span><span class=\"n\">projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"mi\">4</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Canonical</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Canonical</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">built</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">macOS</span><span class=\"w\"> </span><span class=\"mf\">99.0</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">newer</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">OS</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Reason</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tried</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">kim</span><span class=\"bp\">/</span><span class=\"n\">projects</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"mi\">4</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Canonical</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">libcanonical</span><span class=\"bp\">.</span><span class=\"n\">dylib'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 513248373,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745133756
    },
    {
        "content": "<p>Is this on lake build or via VSCode?</p>",
        "id": 513249571,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745134878
    },
    {
        "content": "<p>And I apologize for this. It really should be one-click; I hope it’s clear why I am waiting</p>",
        "id": 513249753,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745135044
    },
    {
        "content": "<p>Just <code>lake build</code>! Somehow in VSCode it seems to work!</p>\n<p>Also, I get multiple</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Canonical</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">repository</span><span class=\"w\"> </span><span class=\"bp\">'././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Canonical'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">changes</span>\n</code></pre></div>\n<p>warnings.</p>",
        "id": 513255073,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745139817
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346696\">Chase Norman</span> <a href=\"#narrow/channel/113488-general/topic/Duper.20and.20Program.20Synthesis/near/513249753\">said</a>:</p>\n<blockquote>\n<p>And I apologize for this. It really should be one-click; I hope it’s clear why I am waiting</p>\n</blockquote>\n<p>No worries -- I'm looking forward to getting to try it out, and I appreciate the effort to make things one-click for users.</p>",
        "id": 513255092,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745139841
    },
    {
        "content": "<p>I'm trying it out in VSCode a bit. Can I suggest that when you find a proof and show the info message, you also discharge the goal with sorry, so as to avoid a red squiggly (which nearly obscures the blue squiggly!)</p>",
        "id": 513255548,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745140230
    },
    {
        "content": "<p>Do you have other publicly available examples besides those from NNG? I'm having a bit of trouble finding interesting examples where it succeeds. So far my efforts have only got</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n</code></pre></div>\n<p>(and even there, the proof terms for the 2nd and 3rd are unnecessarily large, but I guess that comes with the territory.)</p>\n<p>I have a list of negative examples I could post if you're interested (here or elsewhere).</p>",
        "id": 513256671,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745141249
    },
    {
        "content": "<p>Perhaps you would be interested in the Examples section of the <a href=\"https://arxiv.org/abs/2504.06239\">Canonical for Automated Theorem Proving in Lean</a> paper</p>",
        "id": 513297819,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745175601
    },
    {
        "content": "<p>It can be difficult to tell whether there exists a short proof term for a statement or not, and I hope Canonical can be a useful tool to determine this. Since Canonical has no native support for natural numbers, the performance on the NNG is more indicative of reasoning about the foundations of any axiomatic system (indeed, you can replace all instances of Nat with a custom MyNat in the NNG and get the same results). </p>\n<p>My next formalization project might be to formalize the properties of the type theory of Canonical. This will involve custom inductive types and foundational proofs by induction on them. I expect Canonical to do quite well there, just as in NNG.</p>",
        "id": 513298332,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745176015
    },
    {
        "content": "<p>I tried to run Canonical locally both in a new lake project and in the cloned version of that mathlib branch, but in both cases I met the error <code>error loading library, libcanonical.so: cannot open shared object file: No such file or directory</code>. (when using both VSCode and <code>lake build</code>) Is there some way I could deal with this?</p>\n<p>The system information is as below (I don't really know what some of these entries mean, just copied them from system information, hopefully it's useful):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">System</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Kernel</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">6.8</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"mi\">51</span><span class=\"bp\">-</span><span class=\"n\">generic</span><span class=\"w\"> </span><span class=\"n\">arch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">gcc</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">13.3</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"n\">clocksource</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tsc</span>\n<span class=\"w\">  </span><span class=\"n\">Desktop</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cinnamon</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">6.4</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GTK</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">3.24</span><span class=\"bp\">.</span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"n\">wm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Muffin</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">6.4</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">vt</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">dm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LightDM</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">1.30</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"w\">    </span><span class=\"n\">Distro</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linux</span><span class=\"w\"> </span><span class=\"n\">Mint</span><span class=\"w\"> </span><span class=\"mf\">22.1</span><span class=\"w\"> </span><span class=\"n\">Xia</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ubuntu</span><span class=\"w\"> </span><span class=\"mf\">24.04</span><span class=\"w\"> </span><span class=\"n\">noble</span>\n<span class=\"n\">Machine</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"kt\">Type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Laptop</span><span class=\"w\"> </span><span class=\"n\">System</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LENOVO</span><span class=\"w\"> </span><span class=\"n\">product</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"n\">N5</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ThinkBook</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">G5</span><span class=\"w\"> </span><span class=\"n\">IRX</span><span class=\"w\"> </span><span class=\"n\">serial</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">superuser</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">Chassis</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ThinkBook</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">G5</span><span class=\"w\"> </span><span class=\"n\">IRX</span><span class=\"w\"> </span><span class=\"n\">serial</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">superuser</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">Mobo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LENOVO</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LNVNB161216</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SDK0T76479</span><span class=\"w\"> </span><span class=\"n\">WIN</span><span class=\"w\"> </span><span class=\"n\">serial</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">superuser</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">part</span><span class=\"bp\">-</span><span class=\"n\">nu</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LENOVO_MT_21N5_BU_idea_FM_ThinkBook</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">G5</span><span class=\"w\"> </span><span class=\"n\">IRX</span><span class=\"w\"> </span><span class=\"n\">uuid</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">superuser</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">UEFI</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LENOVO</span>\n<span class=\"w\">    </span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P5CN26WW</span><span class=\"w\"> </span><span class=\"n\">date</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">09</span><span class=\"bp\">/</span><span class=\"mi\">03</span><span class=\"bp\">/</span><span class=\"mi\">2024</span>\n<span class=\"n\">CPU</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"bp\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">8</span><span class=\"bp\">-</span><span class=\"n\">mt</span><span class=\"bp\">/</span><span class=\"mi\">16</span><span class=\"bp\">-</span><span class=\"n\">st</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Intel</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"w\"> </span><span class=\"n\">i9</span><span class=\"bp\">-</span><span class=\"mi\">14900</span><span class=\"n\">HX</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MST</span><span class=\"w\"> </span><span class=\"n\">AMCP</span><span class=\"w\"> </span><span class=\"n\">smt</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">enabled</span>\n<span class=\"w\">    </span><span class=\"n\">arch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Raptor</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">rev</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">2.1</span><span class=\"w\"> </span><span class=\"n\">MiB</span><span class=\"w\"> </span><span class=\"n\">L2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">MiB</span><span class=\"w\"> </span><span class=\"n\">L3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">MiB</span>\n<span class=\"w\">  </span><span class=\"n\">Speed</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MHz</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">avg</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1981</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">5600</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"bp\">/</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"bp\">/</span><span class=\"mi\">5600</span><span class=\"o\">:</span><span class=\"mi\">5800</span><span class=\"o\">:</span><span class=\"mi\">4100</span><span class=\"w\"> </span><span class=\"n\">cores</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1230</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2974</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3010</span>\n<span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">5600</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3628</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4600</span>\n<span class=\"w\">    </span><span class=\"mi\">16</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4002</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1542</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3371</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3572</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3232</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1837</span>\n<span class=\"w\">    </span><span class=\"mi\">27</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3088</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4102</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">800</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1745</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3065</span><span class=\"w\"> </span><span class=\"n\">bogomips</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">154828</span>\n<span class=\"w\">  </span><span class=\"n\">Flags</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">avx</span><span class=\"w\"> </span><span class=\"n\">avx2</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"n\">lm</span><span class=\"w\"> </span><span class=\"n\">nx</span><span class=\"w\"> </span><span class=\"n\">pae</span><span class=\"w\"> </span><span class=\"n\">sse</span><span class=\"w\"> </span><span class=\"n\">sse2</span><span class=\"w\"> </span><span class=\"n\">sse3</span><span class=\"w\"> </span><span class=\"n\">sse4_1</span><span class=\"w\"> </span><span class=\"n\">sse4_2</span><span class=\"w\"> </span><span class=\"n\">ssse3</span><span class=\"w\"> </span><span class=\"n\">vmx</span>\n</code></pre></div>",
        "id": 513350679,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745217528
    },
    {
        "content": "<p>I’ve tested on something similar with Ubuntu x86. I assume your .lake/packages/Canonical/.lake/build/lib folder has <a href=\"http://libcanonical.so\">libcanonical.so</a>, so it’s a linker issue.</p>",
        "id": 513351075,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745217775
    },
    {
        "content": "<p>Yes. The file is actually under the path you described.</p>",
        "id": 513351629,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745218112
    },
    {
        "content": "<p>So is there currently a way to fix this? (Or should I wait until the error is fixed properly?) Thanks!</p>",
        "id": 513351787,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745218205
    },
    {
        "content": "<p>I feel that this would need further investigation to resolve; there’s not a clear fix</p>",
        "id": 513351896,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745218295
    },
    {
        "content": "<p>OK, Thanks for the reply! Then I'll just wait for a while and see if this error can be fixed. But anyway, I'm still looking forward to having a try!</p>",
        "id": 513352159,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745218447
    },
    {
        "content": "<p>Out of curiosity, did you get this error from <code>lake build</code> or VSCode? According to <a href=\"https://github.com/chasenorman/CanonicalLean/issues/1\">https://github.com/chasenorman/CanonicalLean/issues/1</a>, Canonical currently only works when built and run from VSCode, due to an issue with loader_path. This is a different error than what you are getting, so it's probably not the issue, but it's worth checking.</p>",
        "id": 513359362,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745222243
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 513394513,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745239559
    },
    {
        "content": "<p>He says both (I take it with the same error). And @loader_path is a MacOS thing. Regardless, Canonical is meant to be used primarily through the VSCode plugin, so I tested with that in mind.</p>",
        "id": 513413648,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745247092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/113488-general/topic/Duper.20and.20Program.20Synthesis/near/513359362\">said</a>:</p>\n<blockquote>\n<p>Out of curiosity, did you get this error from <code>lake build</code> or VSCode? According to <a href=\"https://github.com/chasenorman/CanonicalLean/issues/1\">https://github.com/chasenorman/CanonicalLean/issues/1</a>, Canonical currently only works when built and run from VSCode, due to an issue with loader_path. This is a different error than what you are getting, so it's probably not the issue, but it's worth checking.</p>\n</blockquote>\n<p>Yeah, actually I tried both of these methods, and unfortunately, none worked. But anyway, I guess I'll just wait until a fix of that problem has been found. By the way, should I also submit a detailed description in an issue to that repository? <span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> (Since you said you've met the same error, I wonder if submitting an issue is still necessary/recommended)</p>\n<p>Edit: I also met the <code>undefined symbol: lean_alloc_small</code> error.</p>",
        "id": 513505208,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745291044
    },
    {
        "content": "<blockquote>\n<p>He says both (I take it with the same error). And @loader_path is a MacOS thing. Regardless, Canonical is meant to be used primarily through the VSCode plugin, so I tested with that in mind.</p>\n</blockquote>\n<p>It makes sense that you would focus on VSCode, though it's clearly not ideal that <code>lake build</code> always fails in a repository with canonical installed.</p>",
        "id": 513528790,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745304180
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"750070\">@Wang Jingting</span> that <code>lean_alloc_small</code> error is much better than the earlier one. I specifically checked that the <code>linux-x86_64</code> build of Lean has <code>lean_alloc_small</code> in the <code>libleanshared.so</code>. It seems like this depends on the specific installation of Linux, but I still find it hard to imagine that Lean wouldn’t be linking this very necessary primitive.</p>",
        "id": 513531731,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745305309
    },
    {
        "content": "<p>You can verify my work by running <code>nm -D --defined-only ~/.elan/toolchains/leanprover--lean4---v4.18.0/lib/lean/libleanshared.so | grep lean_alloc_small</code></p>",
        "id": 513532903,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745305731
    },
    {
        "content": "<p>I guess I could add a linker argument to force this library to be linked.</p>",
        "id": 513533605,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745305995
    },
    {
        "content": "<p>This symbol vanished in 4.19.0 so might there be some Lean version confusion?</p>",
        "id": 513535247,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745306607
    },
    {
        "content": "<p>Oh, what should I use instead?</p>",
        "id": 513535327,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745306633
    },
    {
        "content": "<p><code>lean_alloc_small_object</code> is the one Lean itself calls</p>",
        "id": 513535567,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745306710
    },
    {
        "content": "<p>But if code compiled against 4.18 is run against 4.19, there must be some more fundamental issue</p>",
        "id": 513535692,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745306761
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346696\">Chase Norman</span> <a href=\"#narrow/channel/113488-general/topic/Duper.20and.20Program.20Synthesis/near/513531731\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"750070\">Wang Jingting</span> that <code>lean_alloc_small</code> error is much better than the earlier one. I specifically checked that the <code>linux-x86_64</code> build of Lean has <code>lean_alloc_small</code> in the <code>libleanshared.so</code>. It seems like this depends on the specific installation of Linux, but I still find it hard to imagine that Lean wouldn’t be linking this very necessary primitive.</p>\n</blockquote>\n<p>I remember that the first time the <code>lean_alloc_small</code> error didn't show up on my first attempt, but then I don't know why, but sometimes lake automatically update the lean-toolchain to <code>v4.19.0-rc3</code> and this starts to appear. So maybe this isn't much to worry if it's only a version problem, I guess I can solve the version problem anyway.</p>",
        "id": 513539773,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745307973
    },
    {
        "content": "<p>It is in fact a version problem</p>",
        "id": 513539932,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745308021
    },
    {
        "content": "<p>Thanks. I'll try to first fix this easier problem locally.</p>\n<p>Edit: Hooray! I don't know exactly what is happening, but things start to work on my laptop now!</p>",
        "id": 513540167,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745308084
    },
    {
        "content": "<p>49 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Duper.20and.20Program.20Synthesis/with/490999345\">#general &gt; Duper and Program Synthesis</a> by <span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span>.</p>",
        "id": 513565844,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745315481
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/513256671\">said</a>:</p>\n<blockquote>\n<p>Do you have other publicly available examples besides those from NNG? I'm having a bit of trouble finding interesting examples where it succeeds. So far my efforts have only got</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n</code></pre></div>\n<p>(and even there, the proof terms for the 2nd and 3rd are unnecessarily large, but I guess that comes with the territory.)</p>\n<p>I have a list of negative examples I could post if you're interested (here or elsewhere).</p>\n</blockquote>\n<p>It seems that the second and third example doesn't work on my computer? The first one returned a result, but the second and third one both returned <code>no proof found</code>, even after I raised the time limit to a larger number.</p>",
        "id": 513615868,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1745329788
    },
    {
        "content": "<p>I changed my <code>lean-toolchain</code> file to <code>leanprover/lean4:v4.18.0</code> and <code>canonical</code> started to work, but then <code>import Mathlib</code> failed because of the version change. I don't know how to downgrade Mathlib to v4.18.0. Whenever I run <code>lake update mathlib</code>, lake always changes the toolchain file back to v4.19.0-rc3 for me...</p>\n<p>I think the idea of proving things only from first principles of the language is really cool!</p>\n<p>The fact that <code>canonical</code> can find the Cantor diagonal proof on its own is also cool.</p>\n<p>I ran these tests:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Canonical</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical  -- Timeout. Here is my proof:</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\">  </span><span class=\"c1\">-- 1 = 2. Goal: False</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True.intro</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\">  </span><span class=\"c1\">-- (h1 : P 2) after substitution. Now P 2 is False</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- exact Exists.intro 0 (Eq.refl 0)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical 10  -- It finds this proof:</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span>\n<span class=\"w\">    </span><span class=\"n\">Exists.intro</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Eq.rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Nat.rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"n\">n.succ</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Nat.zero.mul</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span><span class=\"o\">)))</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- exact Exists.intro 1 (Eq.refl 1)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical 10  -- It finds this proof:</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span>\n<span class=\"w\">    </span><span class=\"n\">Exists.intro</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Eq.rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Eq.rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a.mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat.zero.succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span><span class=\"o\">))</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Nat.rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"n\">Nat.zero.succ</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat.zero.mul</span><span class=\"w\"> </span><span class=\"n\">Nat.zero</span><span class=\"o\">))))</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical 10  -- Timeout. Here is my proof:</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Exists.intro</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq.refl</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span>\n</code></pre></div>\n<p><code>canonical</code> failed to prove <code>1 ≠ 2</code>, but I think this is reansonable because the actual mechanism in Lean is pretty complicated.</p>\n<p>It succeeded in proving <code>∃ x, x * x = 0</code> and <code>∃ x, x * x = 1</code>, but the proof seems to have some redundant parts. Running <code>Eq.rec</code> to do substitution is not necessary here. We only need <code>Eq.refl</code> to prove <code>0*0=0</code> and <code>1*1=1</code>. The whole <code>Eq.rec</code> block from <code>canonical</code> has type <code>0*0=0, 1*1=1</code>, so they should be replaced with <code>refl</code>. <code>canonical</code> failed on <code>∃ x, x * x = 4</code>.</p>\n<p>I also tried <code>import Mathlib.Tactic</code> and replacing <code>canonical</code> with <code>aesop</code>. Aesop also failed the <code>∃ x, x * x = 4</code> test and succeeded in proving <code>∃ x, x * x = 0</code> and <code>∃ x, x * x = 1</code>, so I think <code>canonical</code> achieved similar performance to <code>aesop</code> with less domain-specific knowledge.</p>\n<p>Maybe manually optimizing for <code>Eq</code> in canonical will make the search faster. For example when a new search node requires a proof of <code>a = b</code>, always try <code>Eq.refl</code> by definitional equality first.</p>",
        "id": 514019785,
        "sender_full_name": "Deming Xu",
        "timestamp": 1745474938
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"740877\">@Deming Xu</span> it's possible to say which version of mathlib you want in the config file of your project. Do you have a <code>lakefile.lean</code>  or a <code>lakefile.toml</code>?</p>",
        "id": 514041181,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745481675
    },
    {
        "content": "<p>Once you change that file, <code>lake update mathlib</code> will \"update\" mathlib to the commit or branch or tag specified in the config file.</p>",
        "id": 514041937,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745481770
    },
    {
        "content": "<p>(It would be great to document these dependency pinning instructions at <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency\">https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency</a>)</p>",
        "id": 514043472,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1745481982
    },
    {
        "content": "<p>Yes sorry I told Johan I would update those instructions two weeks ago, but it slipped off the radar <span aria-label=\"sweat\" class=\"emoji emoji-1f613\" role=\"img\" title=\"sweat\">:sweat:</span></p>",
        "id": 514077601,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745489564
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"740877\">Deming Xu</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/514019785\">said</a>:</p>\n<blockquote>\n<p>Maybe manually optimizing for <code>Eq</code> in canonical will make the search faster. For example when a new search node requires a proof of <code>a = b</code>, always try <code>Eq.refl</code> by definitional equality first.</p>\n</blockquote>\n<p>This could be reasonable in some contexts, but in others an equality may be provable by a 'heavy rfl' which you do not want to use because it will take the kernel ages to compute through it. A slider which tells a proof search procedure how 'heavy' of a rfl is considered acceptable seems like the most flexible control for this.</p>",
        "id": 514248842,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1745540364
    },
    {
        "content": "<p>It worked. Thank you!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">lean_proj</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span>\n<span class=\"w\">  </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"v4.18.0\"</span>\n\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">Canonical</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span>\n<span class=\"w\">  </span><span class=\"s2\">\"https://github.com/chasenorman/CanonicalLean.git\"</span>\n</code></pre></div>\n<p>I did these things:</p>\n<ul>\n<li>Change my <code>lean-toolchain</code> file to <code>leanprover/lean4:v4.18.0</code></li>\n<li>Add the <code>@ \"v4.18.0\"</code> to the <code>require mathlib</code> line in my <code>lakefile.lean</code></li>\n<li>Delete the <code>.lake</code> folder and the <code>lake-manifest.json</code> file</li>\n<li>Run <code>lake update mathlib</code></li>\n<li>Run <code>Reload Window</code> in VSCode</li>\n</ul>\n<p>I thought the <code>lean-toolchain</code> file controlled the toolchain version, but it seems like mathlib determines it instead.</p>",
        "id": 514260132,
        "sender_full_name": "Deming Xu",
        "timestamp": 1745547679
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"740877\">@Deming Xu</span> In short, Canonical does as you say, preferring Eq.refl to Eq.rec where possible. However, there are some complexities here due to definitional equality. Canonical decides to work on the goal <code>x * x = 0</code> before the goal <code>x : Nat</code>, and since <code>x * x</code> does not definitionally reduce to <code>0</code>, <code>Eq.refl</code> fails in the default setting.</p>",
        "id": 514264795,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745550714
    },
    {
        "content": "<p>This is what the <code>+synth</code> flag is for, but it is currently an unstable feature.</p>",
        "id": 514264934,
        "sender_full_name": "Chase Norman",
        "timestamp": 1745550804
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"740877\">Deming Xu</span> <a href=\"#narrow/stream/113488-general/topic/Canonical/near/514260132\">said</a>:</p>\n<blockquote>\n<p>I thought the <code>lean-toolchain</code> file controlled the toolchain version, but it seems like mathlib determines it instead.</p>\n</blockquote>\n<p>lean-toolchain does control the toolchain version! The subtlety is that <code>lake update</code> will modify it if the updated dependencies all agree on some later toolchain.</p>",
        "id": 514335546,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745573570
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/513255548\">said</a>:</p>\n<blockquote>\n<p>I'm trying it out in VSCode a bit. Can I suggest that when you find a proof and show the info message, you also discharge the goal with sorry, so as to avoid a red squiggly (which nearly obscures the blue squiggly!)</p>\n</blockquote>\n<p>I have implemented this on the latest <code>4.19.0</code> version of CanonicalLean.</p>",
        "id": 515835731,
        "sender_full_name": "Chase Norman",
        "timestamp": 1746241493
    },
    {
        "content": "<p>Is there any hope to use <code>canonical</code> to prove</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">continuous_function_at</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sequence_tendsto</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">continuous_function_at</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hu</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sequence_tendsto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">sequence_tendsto</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">ε_pos</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">ε_pos</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elim</span>\n<span class=\"w\">   </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">δ_pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hδ</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hu</span><span class=\"w\"> </span><span class=\"n\">δ</span><span class=\"w\"> </span><span class=\"n\">δ_pos</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">elim</span>\n<span class=\"w\">     </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ge</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">hδ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ge</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>This is the example that I always use in talks when I want to show a proof that simply uses logic and two definitions without any lemma. I was not able to prove any part of it using canonical, even the last subterm (starting with <code>fun n n_ge</code>) that <code>solve_by_elim</code> or <code>tauto</code> find immediately.</p>",
        "id": 515921735,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1746289627
    },
    {
        "content": "<p>I will see to it that Canonical solves this instance, it is well within scope. I just need to make sure that we properly encode the notions in this proof. Would you mind submitting a “Performance Bug” GitHub issue on <a href=\"https://github.com/chasenorman/CanonicalLean\">https://github.com/chasenorman/CanonicalLean</a></p>",
        "id": 515924211,
        "sender_full_name": "Chase Norman",
        "timestamp": 1746290795
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"210574\">Patrick Massot</span></p>",
        "id": 515924238,
        "sender_full_name": "Chase Norman",
        "timestamp": 1746290808
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> could you say something about what additional encoding will be necessary? Maybe this would be helpful for users learning what is (currently) in scope.</p>",
        "id": 516000350,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1746341827
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>  <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> In general, <code>whnf</code> with <code>TransparencyMode.instances</code> is able to eliminate instances from the problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">whnf'</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instHAdd</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">instAdd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"c1\">-- Real.add✝ x x</span>\n</code></pre></div>\n<p>Unfortunately this does not happen for the absolute value (unless a lower transparency level is set):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">whnf'</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">abs</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">lattice</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">instAddGroup</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"c1\">-- @abs Real Real.lattice Real.instAddGroup x</span>\n</code></pre></div>\n<p>If we don't get a translation that reduces to <code>Real.sup✝</code>, we end up bringing in <code>abs, max, SemilatticeSup.toMax, SemilatticeSup.sup, Real.instSemilatticeSup, inferInstance, Lattice.toSemilatticeSup, Real.lattice, DistribLattice.toLattice, Real.instMax</code> and all of the types of the associated fields, cascading recursively. So, I don't think this is an issue of \"certain problems work and others don't\" but rather the need for a more robust way of handling typeclass instances, perhaps with <code>lean-auto</code>.</p>",
        "id": 516054559,
        "sender_full_name": "Chase Norman",
        "timestamp": 1746383066
    },
    {
        "content": "<p>I gave this a try and found a small bug (please lmk if there is a better place for bug reports). Using canonical, I am given the following proof:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">isEven</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">isEven</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">isEven</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span>\n<span class=\"w\">    </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">        </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">.</span><span class=\"n\">succ</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n_1</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>But Lean doesn't accept this proof, on the final instance of n_ih I get the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">n_ih</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">444</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">444</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n_1</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>Interestingly, if I replace the final n_ih with \"by exact n_ih\" the proof does work so it seems to me that Canonical just expects Lean to do more beta-reduction than it does by default. I'm using Lean 4.20.0-rc3 (and the associated Canonical version)</p>",
        "id": 516665074,
        "sender_full_name": "Jacob Loader",
        "timestamp": 1746621720
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"722013\">@Jacob Loader</span> Yes, usually strategically adding <code>by exact</code> in some places fixes these roundtripping issues. The term is a valid Lean term, but there are no guarantees when it comes to pretty printing. I received a <a href=\"https://github.com/chasenorman/CanonicalLean/issues/4\">GitHub issue for this</a>, but I think it will require working with the FRO.</p>",
        "id": 516727833,
        "sender_full_name": "Chase Norman",
        "timestamp": 1746637466
    },
    {
        "content": "<p>can you give us a way to add heuristics of our own to guide Canonical's search (that is, if current depth + f (node) &gt; (max depth) then backtrack)? also expose functions like the list of hole types and the nearest complete term(with or without matching type to the goal) for this purpose?</p>",
        "id": 517636678,
        "sender_full_name": "Jared green",
        "timestamp": 1747076510
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394803\">@Jared green</span> Our heuristics file can be found <a href=\"https://github.com/chasenorman/Canonical/blob/main/crates/canonical-core/src/heuristic.rs\">at this link</a>. Much of the information you mention is available (although, it might not be computationally efficient to obtain every step). We are definitely looking for improvements to our heuristics, as they are still quite simple.</p>",
        "id": 517644224,
        "sender_full_name": "Chase Norman",
        "timestamp": 1747078582
    },
    {
        "content": "<p>Also, please share any problems Canonical takes long on, so it can improve. This is what the Performance Bug issue template on the <a href=\"https://github.com/chasenorman/CanonicalLean\">CanonicalLean repository</a> is for.</p>",
        "id": 517648384,
        "sender_full_name": "Chase Norman",
        "timestamp": 1747079778
    },
    {
        "content": "<p>i was thinking of using it to do symbolic regression on things like images(the heuristic would be a function of the distance from the nearest term matching the type to a target value)</p>",
        "id": 517650177,
        "sender_full_name": "Jared green",
        "timestamp": 1747080245
    },
    {
        "content": "<p>Hey, I'm new to lean and I can't figure out how to install Canonical.<br>\nI'm using vscode on windows<br>\nwhat are the steps to set it up?</p>",
        "id": 518825081,
        "sender_full_name": "Villfuk 02",
        "timestamp": 1747492975
    },
    {
        "content": "<p>When you start a project, there should be a <code>lakefile.toml</code> in the main directory. Add the following lines:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Canonical\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"chasenorman\"</span>\n</code></pre></div>\n<p>After you save, you should run <code>lake update Canonical</code> in the terminal.</p>",
        "id": 518825783,
        "sender_full_name": "Chase Norman",
        "timestamp": 1747493545
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"917460\">@Villfuk 02</span></p>",
        "id": 518825803,
        "sender_full_name": "Chase Norman",
        "timestamp": 1747493566
    },
    {
        "content": "<p>The <strong>first structure editor for Lean</strong> was added with the v4.20.0 release of Canonical. </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"800x583\" src=\"/user_uploads/thumbnail/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif/840x560-anim.webp\"></a></div><p>Prove theorems, implement functions, and construct objects just by clicking.</p>",
        "id": 522451293,
        "sender_full_name": "Chase Norman",
        "timestamp": 1749071059
    },
    {
        "content": "<p>This could be interesting for the <em>Lean for Teaching</em> channel, too. Seems like it would be useful for teaching things like recursors.</p>",
        "id": 522588869,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1749129220
    },
    {
        "content": "<p>The Lean for teaching channel is specifically not about teaching Lean, it’s about teaching using Lean.</p>",
        "id": 522640066,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1749144340
    },
    {
        "content": "<p>Yeah, I'm thinking of courses that use Lean to teach type theory.</p>",
        "id": 522650349,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1749148738
    },
    {
        "content": "<p>I've been wondering—could Canonical (or similar tools) eventually evolve into a constrained decoding platform for Lean, supporting the training of \"first-principle-based\" proof models?</p>\n<p><a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/DeepSeek-Prover.20V2/near/516109729\">https://leanprover.zulipchat.com/#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/DeepSeek-Prover.20V2/near/516109729</a></p>\n<p>As discussed in this thread, I think it's worth exploring whether we can train a mathematical model that doesn't rely on LLMs or human mathematical knowledge, but only on proof verification and first principles.</p>\n<p>So far, in this direction, I’ve found this paper:<br>\n<a href=\"https://arxiv.org/html/2407.00695\">https://arxiv.org/html/2407.00695</a></p>\n<p>Their approach is based on constrained decoding in a custom proof language:</p>\n<ul>\n<li>\n<p>Traditional LLMs repeatedly predict the next “token” of a piece of text (context/chat history). By repeating this process, the model can generate complete text one token at a time.</p>\n</li>\n<li>\n<p>When predicting the next token, the model outputs a probability distribution over all possible tokens in the vocabulary.</p>\n</li>\n<li>\n<p>In constrained decoding, the text being generated has a well-defined “valid syntax.” If a predicted token would violate that syntax, we forcibly set its probability to zero.</p>\n</li>\n<li>\n<p>For example, when generating JSON, after <code>{\"name\": \"John Doe\", \"age\":</code>, the next token can’t be <code>,</code> or <code>}</code>, but <code>88</code>or <code>\"hi\"</code> would be valid. So we set the probability of <code>,</code> and <code>}</code> to zero and renormalize the remaining probabilities. To my knowledge, current generation engines like SGLang and vLLM already support constrained outputs like valid JSON or outputs conforming to regex patterns.</p>\n</li>\n</ul>\n<p><a href=\"user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif\">https://leanprover.zulipchat.com/user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif\" title=\"https://leanprover.zulipchat.com/user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif\"><img src=\"user_uploads/3121/vkcqBUt2nVTuTTIlYlBpQiJJ/refinement.gif\"></a></div><p><a href=\"#narrow/channel/113488-general/topic/Canonical/near/522451293\">https://leanprover.zulipchat.com/#narrow/channel/113488-general/topic/Canonical/near/522451293</a><br>\nI think this approach is applicable to Lean. A few days ago, when I saw canonical's “structure editor,” I realized it’s actually a form of constrained decoding. Each hole in a partially written proof has a list of valid symbols that can be inserted—so we’re only allowed to pick a “next token” from this list.</p>\n<ul>\n<li>\n<p>If there are no more holes, the proof is complete.</p>\n</li>\n<li>\n<p>If a hole has no valid candidates, the proof attempt has failed.</p>\n</li>\n</ul>\n<p>If we can programmatically interact with this interface in Python, we could train a model to predict the “next token”—or you might say, the next proof search step. (Via supervised learning, we could train the model to predict tokens that match actual Lean code closely. More advanced approaches might also be possible.)</p>\n<p>But in reality, very few people seem to have explored constrained decoding in Lean.</p>\n<p>(Some tactic-tree search approaches in earlier papers might count as a kind of constrained decoding, but since “writing a tactic line” is much more complex than “filling in a token,” these tactic searches couldn’t provide helpful “valid next token” lists. This makes it difficult to train non-LLM, first-principles-based models, because they don’t get useful signals early in training.)</p>\n<p>Canonical seems to be the software closest to enabling constrained decoding for Lean. It might be able to evolve into a platform that reduces the amount of code needed for such experiments—maybe allowing a lot more people to get started.</p>\n<hr>\n<h3>The main challenges are:</h3>\n<ol>\n<li>\n<p>Implementing a constrained decoding checker inside Lean is very complex and time-consuming.</p>\n</li>\n<li>\n<p>Training a model from scratch on a new task type requires more parameter tuning, debugging, and model design—harder than simply using an LLM with built-in knowledge.</p>\n</li>\n<li>\n<p>The set of valid tokens depends on which lemmas you allow in your proof. So you need a lemma selector.</p>\n</li>\n<li>\n<p>The resulting model won’t be as flexible or general-purpose as an LLM.</p>\n</li>\n</ol>\n<hr>\n<h3>But if someone manages to train a true “first-principles” model, there could be major benefits:</h3>\n<ol>\n<li>\n<p>Just as different data types (images, audio, text, graphs) need different neural network designs (CNN/RNN/Transformers/GNN; autoregressive/diffusion), a model designed specifically for “constrained proof search” rather than text generation might be more efficient—smaller, faster, cheaper.</p>\n</li>\n<li>\n<p>The model’s architecture could reveal fundamental differences between proofs and natural language.</p>\n</li>\n<li>\n<p>Since it doesn’t rely on natural language priors, it might explore stranger mathematics or more obscure domains more effectively.</p>\n</li>\n</ol>",
        "id": 524240114,
        "sender_full_name": "David Xu",
        "timestamp": 1750075284
    },
    {
        "content": "<p>Rwkv and other state based models is good choice for this because it has rnn style forward pass with a very fast backward past. So you don't need to recompute the entire context when doing tree search</p>",
        "id": 524267182,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750083284
    },
    {
        "content": "<p>You can watch my video on how and why I think this should be done here: <a href=\"https://youtu.be/aOSScvKEwVU?feature=shared\">https://youtu.be/aOSScvKEwVU?feature=shared</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"aOSScvKEwVU\" href=\"https://youtu.be/aOSScvKEwVU?feature=shared\"><img src=\"https://uploads.zulipusercontent.net/b31a13d61b0a2040c6fe3d0f112dae8e4f2e116e/68747470733a2f2f692e7974696d672e636f6d2f76692f614f535363764b457756552f6d7164656661756c742e6a7067\"></a></div><p>Also, Gabriel Poesia is a (upcoming) collaborator of mine.</p>",
        "id": 524276134,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750086026
    },
    {
        "content": "<p>Nothing would need to be written in Lean. Canonical is a Rust program</p>",
        "id": 524278503,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750086735
    },
    {
        "content": "<p>How does <code>linarith</code> and other computer algebra tactics fit into canonical. It seems that proofs involving complex inequalities and stuff would be quicker to search in aesop.</p>",
        "id": 525816078,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750906431
    },
    {
        "content": "<p>For now, if a theorem does not have a short proof term, canonical isn’t the right tool. Theory reasoning, like linear algebra solving, is an interesting potential future direction, though.</p>",
        "id": 525816182,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750906564
    },
    {
        "content": "<p>so does canonical have the same search procedure as aesop but with a simpler IR which make it faster?</p>",
        "id": 525882762,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750937477
    },
    {
        "content": "<p>Can canonical handle indexed inductive types? I was curious if the sorry in <a href=\"https://live.lean-lang.org/#codez=FAOwhgtgpgzgDmAxlABAIQJbgE4E8Aq2UUwwA9ALQXACSIAJgK6IAuGAbqvWC2Ci7jioAZgHtsKPgCMsYPPyKoYAaygAbKC1EgAdMACCKFes3aUGGJJQycuBcRQB3DCwAWoxixTswaxrAAaFEYYKHp+URQiOCJQkC83JRZsZhZGIhRRYX5XVGTiPQoyYCwmVg5UAGVVDS0QJ1yiYBQUAB8UDTBsgC4UapM6lCoUfAB5ABFRqKhwaAiUAAMQDDUFgH5mtvN4qGxwNRRe/tqzQCTCPprTevPjq9JKChHBVCzt+gxkS1fOzi/svmMJ3qRRKDFSFQuA20ABkoF06PQoAAPQ6QoEoc74Z6bdpZWFdVG3Or44QI5Foq46TrCHGZYSw4ReADeGkZUQwAHNXF4jpc6gBfFAACgw9CRDJ5FOJcNJDHJrJYAEpDpsWi0iTCZWSUUKNbosCxdvsOlA2dhOdzFbSsgAlC3MhXsrmSvWCkViu3Owl8zXwuUo83O5XdVVqvUk7XCvU6A1G3wms32q3kYZYoR0t4fWAZ2N7eMgUSIv5WQFXIbFUrgzhS7R0Q15tSR3lQ65PITW2X140s01eQPcwXNoF1uON/1Rn36nYNhN9pMdiUoHuJr1Dq5u0Xi3velsR8cK4Oh9WTkcNyO6ycx6fGx39pUdz3cpe3+07oEbj2vtfSv2IgNJlU1TDE9r18c9o1zG9tzvZMHjbF5slKLNizAEA7ALREMwBSdy1BMo2GrPUADlCygJsa1bNMSBaXF6RlN8rhIxFI2jakO1PbsX2dQcjwopiyPHC8WyvLt4y4y0F23Zc51XCiPy3Nlv20fjIwPQCgL40jwMvSCxOg+caLpR8HX02TXWFTdjIYuoVPHGD1KA4itMEiDQIOcT7xTR4AGFtBgZJUisBZwy1f0FhQYRsFECAgqc5iwtwxFshC39kR0LRbL/JdLCUkB5Os31ZSymBD0cydMvJHKAF5NggHhEFccwxScFxXFpFKirSvF6KqgA+TT4r/HRuq6drJz3IburZTdFz60M4oEya6LZISgQmtKMucrKZt7K1DI67VhuEKzLNfOaypbCqkSOqzVqudbrs2wbyVOoN7ioAxrFkeR8lQZw3G8Xx/EsfzxDCSQvB+WBCgrMFymrElxh4MBCAcIVAEbgVEqODCiMXg2lqWFHw/FQXp0ZxxHkdR1BMdYmVaV0g5pKdAdhQVJHeFRSneGplBMbUoU7w5vhem5lHFD5lmlQctUxd5zG7rqETR1nKW9pQRFzXYLAORQG0oBid7HgAcU0HJUCi0QvGJ/wsJQDjfGF6mdES00UDlxQdA5TQADUgagfQWEjJkYEFJlMd6Kj+VDIVfq5mUnYlzGSos5rcoeowcYjmqWjqlgGvsKAgk3Fq3FpD2CkJm2i4oh6jpJFA+sBkny4TqnPcZ1WAH0ggO/16+3Ha2XO2W255z3vZYP2ScD1TB7FCVW66ROCk7rupd78bQqWk7Py9EeWgrqAvd9/3Z7s19Xu5I3PpsOQ7Dj/7GurkGtCIcIeGsK3GqhyxUPCTuGFobABBJWeGqAABijA1BqBXqgDGWNng4z1HjKiBN6JCmrqicmqIoEwLgZLOmo1DKd2ZneN0WCybqyAkKdmyNcHQNge3Bw/Ndq8UFvaYWDD8HMJpmrGWLQ8FMPHiwicwlO4eWTElFAQi4HpVEEfJcEd4JhxynJGOcdeiyN4ZLFOosx7i1EdVWq9VGqP1arSbRIjj5V39o3fqR8qT0WrpYxhci16qzvPY0MjjO60N7PIo+yoOHOkCQY6msFhimwSLkKIogrbN1tq8PgDthGGOPq7bIVj0knynmfIO44Q5h2UVHDREstFuJ0cnYJJdcpXUztgw4OcUB5wLr9YuzUn6uJ4dYpxBJq6b0ultLqdECRNxcYZbJztO5YPXj3Aai0RmpPsYk6iWwpkdzcigdejp5kLUOlNLwQ8vAHxkZU3pk9p7+HPllR0xzulpOmVsuZG8FkHOOpfPeT5TkbIKJc/JkYvFXxYKQRIYMYq/OPloI+Xd/kzwKVlIpSjEFCGjjQzRZyenpN0TUtOtdt6VVKmqX6YTl68NyVcgOCKXrNWaUBElcLrnUpRJueR9TuhVWsLgTYMBxB4GAEAA\">this example</a> is the kind of thing canonical could solve.</p>",
        "id": 525893161,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1750940984
    },
    {
        "content": "<p>Here's a proof.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree_getValueAtIndex</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SkeletonLeafIndex</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree</span><span class=\"bp\">.</span><span class=\"n\">getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"bp\">.</span><span class=\"n\">toNodeIndex</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SkeletonLeafIndex</span><span class=\"bp\">.</span><span class=\"n\">ofLeaf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SkeletonLeafIndex</span><span class=\"bp\">.</span><span class=\"n\">ofLeft</span><span class=\"w\"> </span><span class=\"n\">idxLeft</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree_getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">idxLeft</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SkeletonLeafIndex</span><span class=\"bp\">.</span><span class=\"n\">ofRight</span><span class=\"w\"> </span><span class=\"n\">idxRight</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree_getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">idxRight</span>\n</code></pre></div>\n<p>Canonical has rich support for indexed inductive types, but it has trouble ruling out absurd patterns. If you open an induction over <code>tree, idx</code> (I'm not actually sure how to do this, I did it with <code>match</code> and manually writing the recursive call) then each of the cases is trivial. Sorry if this answer is unsatisfying.</p>",
        "id": 525951008,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750958737
    },
    {
        "content": "<p>Note that the proof term for this (despite appearances) is very long, as the compiler has to argue those absurd patterns and termination.</p>",
        "id": 525951145,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750958802
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346696\">Chase Norman</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/525951008\">said</a>:</p>\n<blockquote>\n<p>If you open an induction over <code>tree, idx</code> (I'm not actually sure how to do this, I did it with <code>match</code> and manually writing the recursive call) then each of the cases is trivial.</p>\n</blockquote>\n<p>It's actually just an induction over <code>tree</code> that also happens to match on the <code>idx</code></p>",
        "id": 525951388,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750958896
    },
    {
        "content": "<p>For me, I still have to case on the idx.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree_getValueAtIndex</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FullDataTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SkeletonLeafIndex</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">toLeafDataTree</span><span class=\"bp\">.</span><span class=\"n\">getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">getValueAtIndex</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"bp\">.</span><span class=\"n\">toNodeIndex</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofLeaf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">canonical</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"n\">ihLeft</span><span class=\"w\"> </span><span class=\"n\">ihRight</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofLeft</span><span class=\"w\"> </span><span class=\"n\">idxLeft</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">canonical</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofRight</span><span class=\"w\"> </span><span class=\"n\">idxRight</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">canonical</span>\n</code></pre></div>\n<p>But Canonical can easily fill in the trivial cases from here.</p>",
        "id": 525951854,
        "sender_full_name": "Chase Norman",
        "timestamp": 1750959066
    },
    {
        "content": "<p><strong>Canonical v4.21.0 can use <code>simp</code>!</strong> <br>\nCanonical now uses <code>simp</code> lemmas, equation compiler lemmas, and the provided premises to construct <code>simp only</code> and <code>simpa only</code> calls at various points in the proof. This makes Canonical much more powerful. </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ZwjBd_g7c0BiBdXTkTQIRHFT/canonical-simp.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"654x444\" src=\"/user_uploads/thumbnail/3121/ZwjBd_g7c0BiBdXTkTQIRHFT/canonical-simp.gif/840x560-anim.webp\"></a></div><p>Which tactics should Canonical incorporate next?</p>",
        "id": 526480225,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751314452
    },
    {
        "content": "<p>rw?</p>",
        "id": 526481674,
        "sender_full_name": "Jared green",
        "timestamp": 1751315124
    },
    {
        "content": "<p>nth_rewrite?</p>",
        "id": 526481823,
        "sender_full_name": "Jared green",
        "timestamp": 1751315209
    },
    {
        "content": "<p>what's the general approach to incorporating custom tactics into canonical? Does canonical return the search state to lean after a certain search depth? or are lean tactics treated as opaque canonical rules. I think if this can be done generally for <code>linarith, linear_combination</code> and <code>omega</code> and other atomic proof automation tactics this could be a very strong candidate for replacing aesop</p>",
        "id": 526493987,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751321662
    },
    {
        "content": "<blockquote>\n<p>which tactics should Canonical incorporate next?</p>\n</blockquote>\n<p>omega!</p>",
        "id": 526496322,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1751323151
    },
    {
        "content": "<p>canonical does not build the entire search space all at once, only maintaining the branch it is on at a time, returning the successful ones.</p>",
        "id": 526521284,
        "sender_full_name": "Jared green",
        "timestamp": 1751343051
    },
    {
        "content": "<p>Canonical does its reasoning entirely without interacting with Lean, even when generating simp invocations. Canonical can now perform reasoning modulo definitional reduction rules. </p>\n<p>The tactic converts the Lean definitional equalities, simp lemmas, and other equality lemmas into definitional reduction rules. These define an equivalence relation among terms and Canonical only has to reason about the quotient. So, in a way, simp is pervasively applied everywhere. To convince the Lean kernel, the tactic inserts simp calls.</p>",
        "id": 526649838,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751389027
    },
    {
        "content": "<p>You can see how much easier it is for Canonical to prove things in the presence of definitional reductions using the +refine UI. Canonical doesn’t have to choose to use simp or what to use it on, it’s all inherent in the search.</p>",
        "id": 526650096,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751389132
    },
    {
        "content": "<p>how well does it handle non-directed defeqs?</p>",
        "id": 526650324,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751389202
    },
    {
        "content": "<p>you might be able to use at least some grind lemmas the same way you use simp lemmas</p>",
        "id": 526650401,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751389231
    },
    {
        "content": "<p>I think I would need e-graphs for that. It appears that type theories that use e-graphs for definitional equality are not well studied.</p>",
        "id": 526650647,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751389316
    },
    {
        "content": "<p>But my performance budget is pretty tight. The routine for definitional reduction is invoked about a hundred million times per second</p>",
        "id": 526650816,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751389390
    },
    {
        "content": "<p>what about non-definitional equality?(is that even a thing?)</p>",
        "id": 526814458,
        "sender_full_name": "Jared green",
        "timestamp": 1751466230
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394803\">@Jared green</span> the equations I’m talking about are arbitrary (terminating) rewrite rules. They are not generally definitional in Lean, but they become definitional in Canonical’s theory.</p>",
        "id": 526816816,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751466851
    },
    {
        "content": "<p>how about breadth first case splitting with clause learning?</p>",
        "id": 526837297,
        "sender_full_name": "Jared green",
        "timestamp": 1751472658
    },
    {
        "content": "<p>(i know, nobody has implemented that yet, but it can be done)</p>",
        "id": 526837697,
        "sender_full_name": "Jared green",
        "timestamp": 1751472734
    },
    {
        "content": "<p>I’ve thought for some time about what the constructive DTT analogue of clause learning would be, but I’m still not sure. If any formal methods people want to work with me on this, reach out.</p>",
        "id": 526839459,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751473359
    },
    {
        "content": "<p>what is your best guess currently?</p>",
        "id": 526842138,
        "sender_full_name": "Jared green",
        "timestamp": 1751474330
    },
    {
        "content": "<p>Well, if you have a type theory judgment that is falsified, you can consider the conflict set to be the metavariables that were involved in reaching that failure state. You can propagate this to behave similarly to CDCL, but I've found that it doesn't work very well in practice. This is because most branches are infinite and do not get entirely falsified.</p>\n<p>The alternative would be define some propositional notion of conflict, like attempting to prove both a statement and its negation for each metavariable representing a proposition. If the negation ends up being proven, you can somehow eliminate similar goals from being attempted in the future. This is all very nebulous, though.</p>",
        "id": 526878634,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751490178
    },
    {
        "content": "<p>i didnt think conflict finding would be done on every single branch either</p>",
        "id": 526885180,
        "sender_full_name": "Jared green",
        "timestamp": 1751493227
    },
    {
        "content": "<p>how long is canonical worth running now anyway?</p>",
        "id": 527246170,
        "sender_full_name": "Jared green",
        "timestamp": 1751680678
    },
    {
        "content": "<p>Most statements that are not solved within one second are as a result of the translation process, rather than the Canonical solver (i.e. the desired proof term is not in the search space). Significant improvements to the fidelity of the Lean embedding/encoding are planned, perhaps rectifying this.</p>",
        "id": 527251351,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751687864
    },
    {
        "content": "<p>what translation? i thought it was a deep embedding.</p>",
        "id": 527284067,
        "sender_full_name": "Jared green",
        "timestamp": 1751724602
    },
    {
        "content": "<p>i thought the reason it would only be worth running 1 second was because the success rate drops off for longer runtimes, so a better version would have a longer horizon.</p>",
        "id": 527285380,
        "sender_full_name": "Jared green",
        "timestamp": 1751725962
    },
    {
        "content": "<p>The embedding is quite shallow. Translation improvements generally intend to expose more of the problem at a more shallow level.</p>",
        "id": 527285725,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751726331
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346696\">Chase Norman</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/526650647\">said</a>:</p>\n<blockquote>\n<p>I think I would need e-graphs for that. It appears that type theories that use e-graphs for definitional equality are not well studied.</p>\n</blockquote>\n<p>just curious, do you think it would make sense to connect this with (lean-)egg for stuff like this? or not really because it would be too much for your comptational budget (i.e. is this what you meant with that)?</p>",
        "id": 532558314,
        "sender_full_name": "Andrés Goens",
        "timestamp": 1754228628
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315434\">@Andrés Goens</span> I think using e-graphs is promising, and I have an idea for how to develop this further. However, I'm not sure if off-the-shelf e-graph implementations will work. </p>\n<p>Canonical relies on the ability to perform definitional equality checks on terms that contain metavariables. Definitional equality should only query as many head symbols as is necessary to falsify the equality. If one of these head symbols is a metavariable, the algorithm needs to pause and wait until it is assigned, at which point the algorithm resumes.</p>\n<p>I am interested in talking about this more, perhaps in DMs.</p>",
        "id": 532561601,
        "sender_full_name": "Chase Norman",
        "timestamp": 1754230715
    },
    {
        "content": "<p><strong>Canonical v4.22.0 has support for typeclass instances!</strong><br>\nPowered by the new <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Monomorphize.20Tactic\"><code>monomorphize</code></a>  tactic, Canonical can now solve a range of goals involving typeclass instances. Also, the Lean tactic has been rewritten from scratch. Enjoy!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Canonical</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"c1\">-- Monomorphized premise</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical [add_comm]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"mi\">2</span>\n\n<span class=\"c1\">-- Monomorphized simp lemma</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical [mul_assoc]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_assoc</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">))</span>\n\n<span class=\"c1\">-- Monomorphized operation (notice `+`!)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- by canonical</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span>\n<span class=\"w\">    </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">injEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_add</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">n_ih</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"c1\">-- synthInstance</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical [not_finite]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">not_finite</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n\n<span class=\"c1\">-- Instance in local context</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical [default]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">default</span>\n\n<span class=\"c1\">-- Synthesis during reconstruction</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Hashable</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical [HashSet.empty]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">HashSet</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n\n<span class=\"c1\">-- Creating instances</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- canonical</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 534724460,
        "sender_full_name": "Chase Norman",
        "timestamp": 1755301427
    },
    {
        "content": "<p>Did you make any progress on <a href=\"https://github.com/chasenorman/CanonicalLean/issues/10\">https://github.com/chasenorman/CanonicalLean/issues/10</a>?</p>",
        "id": 534746791,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1755330628
    },
    {
        "content": "<p>One more feature will be necessary to solve it</p>",
        "id": 534783119,
        "sender_full_name": "Chase Norman",
        "timestamp": 1755376387
    },
    {
        "content": "<p>In case you need extra motivation: from August 21st to September 5th I’ll have three opportunities to show this example in propaganda talks (in Hangzhou, Hanoi and Paris). I’d love to end the demo by turning the whole proof into <code>by canonical</code>.</p>",
        "id": 534784633,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1755378537
    },
    {
        "content": "<p>So it shall be.</p>",
        "id": 534802910,
        "sender_full_name": "Chase Norman",
        "timestamp": 1755408920
    },
    {
        "content": "<p>what is this missing feature?</p>",
        "id": 534824561,
        "sender_full_name": "Jared green",
        "timestamp": 1755438217
    },
    {
        "content": "<p>Projecting out of structure types is a forward reasoning step, and Canonical only performs backward reasoning. So, we are changing the encoding of structure types. More details to follow</p>",
        "id": 535244379,
        "sender_full_name": "Chase Norman",
        "timestamp": 1755669972
    },
    {
        "content": "<p>I want to highlight that Canonical now solves an example <a href=\"#narrow/channel/113488-general/topic/Canonical/near/514019785\">posted</a> by <span class=\"user-mention\" data-user-id=\"740877\">@David Xu</span>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Canonical</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- by canonical</span>\n<span class=\"w\">  </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">injEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_add</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I previously <a href=\"#narrow/channel/113488-general/topic/Canonical/near/514264795\">explained the failure</a>, but subsequently found a way to have Canonical consider the possibility that a definitional reduction will take place.</p>",
        "id": 538098556,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757271313
    },
    {
        "content": "<p>Note it also proves that continuous functions are sequentially continuous as described in <a href=\"https://github.com/chasenorman/CanonicalLean/issues/10\">https://github.com/chasenorman/CanonicalLean/issues/10</a>.</p>",
        "id": 538101700,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1757275009
    },
    {
        "content": "<p>Canonical now applies <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Destruct.20Tactic/with/538032110\">destruct</a> pervasively, allowing much stronger reasoning about structure types and existential quantifiers. Here is the proof <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> mentioned:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">continuous_function_at</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hu</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sequence_tendsto</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">sequence_tendsto</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- by canonical</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">    </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hu</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">a_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hu</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">a_1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 538228811,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757338600
    },
    {
        "content": "<p>maybe a dumb question here and also maybe completely out of scope of canonical, but would it be possible to have some kind automated conversion from term proof to tactic proof so that generated proof read easier for people not familiar with term syntax?</p>",
        "id": 538310418,
        "sender_full_name": "Alfredo Moreira-Rosa",
        "timestamp": 1757363561
    },
    {
        "content": "<p>It would be possible to write code that works in some cases. Tactics are independent metaprograms that can execute arbitrary code (and change from version to version), so there is no analytical inverse. Terms are fixed in meaning and are conceptually a lot simpler—just functions, applications, and variables. This is what allows us to search for them and be assured that the proof is correct. Anyways, this could be a project for someone that knows the tactics in Lean better than I do.</p>",
        "id": 538316769,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757366390
    },
    {
        "content": "<p>Also, presumably terms are preferred for non-propositions.</p>",
        "id": 538316906,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757366462
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> </p>\n<p>Would it be possible to make it optional to turn off canonical’s suggestion of terms? Sometimes all that’s needed is to simply close the goal with by canonical, and the explicit display of the proof term isn’t important.</p>",
        "id": 538317479,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1757366762
    },
    {
        "content": "<p>I could add a <code>canonical!</code> tactic that does this. But you’d assume the risk of non-deterministic output/success, and calling expensive Rust FFI with each compilation.</p>",
        "id": 538319033,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757367553
    },
    {
        "content": "<p>maybe the proof term could be cached and ffi is only called again if the cached proof term fails to discharge the goal</p>",
        "id": 538320465,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1757368370
    },
    {
        "content": "<p>Unfortunately there's no caching mechanism available, as far as I understand. By the time you realise a cache is invalid, it's potentially hard for the user to work out how to fix it</p>",
        "id": 538327836,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757373398
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Canonical</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">PremiseSelection</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PremiseSelection</span>\n<span class=\"n\">set_premise_selector</span>\n<span class=\"w\">  </span><span class=\"n\">Cloud</span><span class=\"bp\">.</span><span class=\"n\">premiseSelector</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">mepoSelector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">useRarity</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- by canonical +premises</span>\n<span class=\"w\">  </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_one</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_eq_of_lt</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>Canonical also has support for Lean's premise selection API</p>",
        "id": 538546028,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757460061
    },
    {
        "content": "<p>Nice work! I think this is the first public integration with the premise selection API.</p>\n<p>(I would love to tune the parameters in MePo, which currently are just copied from the Isabelle implementation.)</p>",
        "id": 538559120,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757472025
    },
    {
        "content": "<p>And we <em>really</em> need more backends available to everyone.</p>",
        "id": 538559140,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757472045
    },
    {
        "content": "<p>Canonical <strong><code>v4.23.0</code></strong> and <strong><code>v4.24.0-rc1</code></strong> are available now. By popular demand, Canonical will start supporting release candidate versions. This is also in preparation for <strong>ITP 2025</strong>—I look forward to meeting some of you there.</p>",
        "id": 539573070,
        "sender_full_name": "Chase Norman",
        "timestamp": 1757946147
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span> what are the dependencies of the Canonical lean library? (e.g. python, rust, etc)? What happens if they are not available? (I'm happy to investigate myself, but if you have ready answers that's easier. :-)</p>",
        "id": 547170424,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761524990
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> There are no dependencies. Canonical is precompiled for Mac, Linux, and Windows and runs without Rust installed.</p>",
        "id": 547170610,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761525176
    },
    {
        "content": "<p>Lovely. :-)</p>",
        "id": 547170628,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761525193
    },
    {
        "content": "<p>I'm investigating what it takes to add it as a Mathlib <code>require</code>.</p>",
        "id": 547170641,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761525208
    },
    {
        "content": "<p>We will need to merge <a href=\"https://github.com/leanprover-community/mathlib4/pull/30952\">#30952</a> first to allow <code>lake exe cache</code> integration.</p>",
        "id": 547170670,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761525236
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>, pinging you here as you asked about progress on this front.)</p>",
        "id": 547170686,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761525256
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/30953\">#30953</a> is the current experiment. It won't pass CI or provide cached oleans until (at least) we have <a href=\"https://github.com/leanprover-community/mathlib4/pull/30844\">#30844</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/30952\">#30952</a> merged, but it appears to work fine locally.</p>\n<p>If anyone would like to check it out and confirm that <code>lake build &amp;&amp; lake test</code> works for them that would be helpful signal.</p>",
        "id": 547171507,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761526089
    },
    {
        "content": "<p>However there are separate problems in CI.</p>\n<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>, could you take a look at <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/18826299417/job/53709575129?pr=30953#step:20:31\">https://github.com/leanprover-community/mathlib4/actions/runs/18826299417/job/53709575129?pr=30953#step:20:31</a> and tell me if you have a guess as to what is going wrong?</p>",
        "id": 547171532,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761526118
    },
    {
        "content": "<p>Ah, this is (I think) just that we need to merge <a href=\"https://github.com/leanprover-community/mathlib4/pull/30952\">#30952</a> first.</p>",
        "id": 547171698,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761526305
    },
    {
        "content": "<p>I'll pause here until we have some CI-savvy maintainers available. :-)</p>",
        "id": 547171729,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761526341
    },
    {
        "content": "<p>Okay, those PRs are merged, but CI for <a href=\"https://github.com/leanprover-community/mathlib4/pull/30953\">#30953</a> is still <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/18858574878/job/53812097342?pr=30953\">failing</a>.</p>\n<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>, if I start with a fresh checkout, at what step is the <code>.so</code> file actually been retrieved? </p>\n<p>In our current CI setup, it's only during <code>lake env</code> and <code>lake exe cache get</code> that the build has network access.</p>",
        "id": 547389305,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761608897
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> It is when Canonical is pulled from GitHub</p>",
        "id": 547389385,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761608963
    },
    {
        "content": "<p>I see that on the <code>canonical</code> branch, if I <code>rm -rf .lake</code>, then <code>lake env</code> creates <code>lake/packages/Canonical/.lake</code>, but not <code>.lake/packages/Canonical/.lake/build/lib/libCanonical.so</code>.</p>",
        "id": 547389425,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761608986
    },
    {
        "content": "<p>For some reason it is not deciding to pull the precompiled version</p>",
        "id": 547389507,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761609049
    },
    {
        "content": "<p>So it isn't necessarily pulled at the same time as <code>.lake/packages/Canonical/Canonical.lean</code> appears.</p>",
        "id": 547389514,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761609054
    },
    {
        "content": "<p>Okay, can I hand this over to you to investigate?</p>",
        "id": 547389546,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761609083
    },
    {
        "content": "<p>Any ideas on this one, <span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>?</p>",
        "id": 553773990,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1762324286
    },
    {
        "content": "<p>We might need to rope <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> into this. I’ve added an extraDepTargets line to the lakefile to try to force the archive to be pulled, but for some reason it does not do so when there is already a lake-manifest.json present.</p>",
        "id": 553781447,
        "sender_full_name": "Chase Norman",
        "timestamp": 1762327752
    },
    {
        "content": "<p>In Mathlib, I feel the proper time to pull any build-related data from the network is during <code>lake exe cache get</code>. So I would suggest doing something similar to the current <a href=\"https://github.com/leanprover-community/mathlib4/blob/02e0109714ce89123b739c02822a7c17bb791fc1/Cache/Requests.lean#L433-L434\">ProofWidgets special case</a> for Canonical.</p>",
        "id": 553782092,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762328024
    },
    {
        "content": "<p>I haven't thought about this for a while now, but I am not excited about that special case existing. It is clearly not scalable to special-case every package that relies on binary artifacts that are not easily compilable on the downstream user's machine. How far away are we from having a mode of <code>require</code> that <em>enforces</em> that prebuilt release data is downloaded in Lake?</p>",
        "id": 553958347,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1762375213
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒</span> Under normal circumstances, the right place for downlaoding build data in Lake is in <code>lake build</code>. It is a limitation of Mathlib's current cache (and CI) structure that this is done in cache.</p>",
        "id": 553958890,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762375439
    },
    {
        "content": "<p>Special casing in Mathlib seems unavoidable anyway, as being explicit about what should be downloaded is desirable for security reasons.</p>",
        "id": 553959049,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762375503
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/553958890\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"128280\">𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒</span> Under normal circumstances, the right place for downlaoding build data in Lake is in <code>lake build</code>. It is a limitation of Mathlib's current cache (and CI) structure that this is done in cache.</p>\n</blockquote>\n<p>Hm, then maybe a better question would be: is mathlib forever going to be doing strange things that make it not-just-a-normal-package, or is there a path towards adding whatever is needed to make <code>cache</code> work well for <em>any</em> package into Lake?</p>",
        "id": 553959828,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1762375822
    },
    {
        "content": "<p>The hope is that Mathlib will eventually be implemntedable via a <code>lakefile.toml</code> and cache will be integrated with <code>lake</code> and together these can be used to solve the current cache and security challenges.</p>",
        "id": 553960114,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762375938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/113488-general/topic/Canonical/near/553959049\">said</a>:</p>\n<blockquote>\n<p>Special casing in Mathlib seems unavoidable anyway, as being explicit about what should be downloaded is desirable for security reasons.</p>\n</blockquote>\n<p>Do you mean that allowing a package to fetch prebuilt artifacts is putting more trust on it than just <code>require</code>ing it? That doesn't seem right, given that lakefiles (and Lean modules) can run arbitrary code.</p>",
        "id": 553960132,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1762375945
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> could we write a version of this special case that is generic over archive name and repo? Essentially, ProofWidgets and Canonical could copy their release info from the lakefile into this function and it would perform the install during cache get?</p>",
        "id": 553960896,
        "sender_full_name": "Chase Norman",
        "timestamp": 1762376171
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"128280\">𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒</span> The difference is that some lake actionas are only run on code from  master vs with the pull request. My understanding is that the network code only runs under the master. <code>lake build</code>, inversely, runs with respect to the PR and without network access.</p>",
        "id": 553961484,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762376411
    },
    {
        "content": "<p>Does lake build have to run without network? Is this the security issue?</p>",
        "id": 553961615,
        "sender_full_name": "Chase Norman",
        "timestamp": 1762376461
    },
    {
        "content": "<p>Yes, that is the decision as of now (as I understand).</p>",
        "id": 553961731,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762376516
    }
]