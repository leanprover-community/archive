[
    {
        "content": "<p>Goal:</p>\n<p>I'm trying to dump all of Lean &amp; MathLib and see if it verifies under <a href=\"https://github.com/ammkrn/nanoda_lib\">https://github.com/ammkrn/nanoda_lib</a></p>\n<p>What I've figured out so far. I need</p>\n<ol>\n<li>Create empty project, add to lakefile.toml:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">require</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>somehow install lean4export</li>\n<li>run <code>lake exe Lean4Export Lean ; lake exe Lean4Export MathLib</code></li>\n</ol>\n<p>Basic Question: How do I install this custom lean4export from <a href=\"https://github.com/ammkrn/lean4export/tree/format2024\">https://github.com/ammkrn/lean4export/tree/format2024</a> ? (Not seeing any Makefile, cargo.toml, CMake, ... ).</p>\n<p>Thanks!</p>",
        "id": 562600474,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765256494
    },
    {
        "content": "<p>Can you explain why you are interested in that fork and that branch?</p>",
        "id": 562614930,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765265937
    },
    {
        "content": "<p>Happy to, let me know if there is flaw in logic / I should be using something else:</p>\n<ol>\n<li>\n<p>I am interested in testing out how well the Rust impl of the Lean Kernel works, namely <a href=\"https://github.com/ammkrn/nanoda_lib\">https://github.com/ammkrn/nanoda_lib</a></p>\n</li>\n<li>\n<p>Quoting the README of the nanoda_lib repo:</p>\n</li>\n</ol>\n<blockquote>\n<p>Export files can be created with <a href=\"https://github.com/ammkrn/lean4export/tree/format2024\">lean4export</a>. The format in the linked fork is expected by this type checker, and is under review for inclusion upstream. The link will be updated if/when the changes are merged.</p>\n</blockquote>\n<p>My interpretation of the above is: nanoda_lib does not read \"standard Lean4Export\"; nanoda_lib reads a \"slightly modified Lean4Export\", pointed to by <a href=\"https://github.com/ammkrn/lean4export/tree/format2024\">https://github.com/ammkrn/lean4export/tree/format2024</a></p>\n<p>This is all guess work on my part, as I don't have an end to end working chain, so I don't know if all the intermediate logic is sound.</p>",
        "id": 562616114,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765266481
    },
    {
        "content": "<p>I'm now wondering if this code is broken</p>\n<p>With regular 'lean4export', I can export Mathlib no problem (but output was only 2.7G, surprising as I read online it is supposed to be 8-10G)</p>\n<p>With the ammkm lean4export, when I try to export Mathlib, I get an error of:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Export</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">108</span><span class=\"o\">:</span><span class=\"mi\">53</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">e</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Expr</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">application</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">ck</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">updateLet!</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Export</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">108</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">580</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">485</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Export</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>\n<p>It is almost as if some Lean.Expr type got changed from 2024 until now, where some \"Expr\" became a \"Bool -&gt; Expr\"</p>",
        "id": 562663055,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765280900
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">nanoda_lib</span><span class=\"o\">]</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"c1\">-- config_file</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`dev</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.04</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"ss\">`target</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">nanoda_bin</span><span class=\"w\"> </span><span class=\"n\">config_file</span><span class=\"bp\">`</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">main'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">107299</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">parser</span><span class=\"bp\">.</span><span class=\"n\">rs</span><span class=\"o\">:</span><span class=\"mi\">487</span><span class=\"o\">:</span><span class=\"mi\">13</span><span class=\"o\">:</span>\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">declares</span><span class=\"w\"> </span><span class=\"n\">unpermitted</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"s2\">\"Lean.ofReduceNat\"</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`RUST_BACKTRACE</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n</code></pre></div>\n<p>I think this basically works now; it runs for multiple seconds and then complains about unpermitted axiom; which seems to imply exporting + parsing is working</p>",
        "id": 562667215,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765282112
    },
    {
        "content": "<p>I'm not in front of Lean at the moment but I'm pretty sure you no longer need the custom lean4export now with nanoda. The changes have been merged into the regular lean4export.</p>\n<p>I'd suggest just installing that and trying it.</p>",
        "id": 562669460,
        "sender_full_name": "Julian Berman",
        "timestamp": 1765282808
    },
    {
        "content": "<p>I'll add it to my todo list. At the moment, I'm already running nanoda_lib on the export of the Lean main library. (Slower than exporting). Waiting to see what it outputs.</p>",
        "id": 562670048,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765282975
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"c1\">-- config_file</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`dev</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.04</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"ss\">`target</span><span class=\"bp\">/</span><span class=\"n\">debug</span><span class=\"bp\">/</span><span class=\"n\">nanoda_bin</span><span class=\"w\"> </span><span class=\"n\">config_file</span><span class=\"bp\">`</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">main'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">107505</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">tc</span><span class=\"bp\">.</span><span class=\"n\">rs</span><span class=\"o\">:</span><span class=\"mi\">797</span><span class=\"o\">:</span><span class=\"mi\">71</span><span class=\"o\">:</span>\n<span class=\"n\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">def_eq</span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`RUST_BACKTRACE</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n</code></pre></div>\n<p>hmm, this failed; I'm going to have to modify nanoda_lib so it prints out a bit more helpful msgs :-)</p>",
        "id": 562670987,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765283247
    },
    {
        "content": "<p>(I'm probably running nanoda_lib wrong); so far, nanoda_lib is slower than I expected.</p>\n<p>I thought the low level kernel did not do much, and I expected it to run at maybe 10x or 100x the time of <code>cat</code>; i.e. a straight through linear reading of the file &amp; some direct type checks.</p>",
        "id": 562671696,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765283453
    },
    {
        "content": "<p>I just tried using the leanprover/lean4export (instead of the ammk/lean4export).</p>\n<p>Running nanoda_lib, it immediately fails an assertion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"c1\">--release -- config_file</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"ss\">`release</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">optimized</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.03</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"ss\">`target</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">nanoda_bin</span><span class=\"w\"> </span><span class=\"n\">config_file</span><span class=\"bp\">`</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">main'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">138127</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">/</span><span class=\"n\">parser</span><span class=\"bp\">.</span><span class=\"n\">rs</span><span class=\"o\">:</span><span class=\"mi\">299</span><span class=\"o\">:</span><span class=\"mi\">9</span><span class=\"o\">:</span>\n<span class=\"n\">assertion</span><span class=\"w\"> </span><span class=\"ss\">`left</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"w\">  </span><span class=\"n\">left</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18610</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18597</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`RUST_BACKTRACE</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n</code></pre></div>\n<p>(almost as it a parsing error &amp; it misinterpreted the first things it parsed)</p>",
        "id": 562673153,
        "sender_full_name": "TongKe Xue",
        "timestamp": 1765283908
    }
]