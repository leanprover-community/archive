[
    {
        "content": "<p>I'm trying to piggy back off of the lean parser to parse the generated draft suggesstion of a language model. I created a custom syntax category but when I run the categoryParser it throws an error: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"sd\">/-- Custom syntax: \"have &lt;name&gt; : &lt;term&gt; := sorry\\nclear &lt;names&gt;*\" -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">haveClearTac</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"have\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"s2\">\"clear\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"sd\">/-- Example of parsing a string into syntax manually. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"w\"> </span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`haveClearTac</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"not working\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry</span><span class=\"se\">\\n</span><span class=\"s2\">clear h x\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Parsed syntax:</span><span class=\"se\">\\n</span><span class=\"s2\">{stx.prettyPrint}\"</span>\n</code></pre></div>\n<p>can someone give me some pointers as to what I am doing wrong?</p>",
        "id": 546559044,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171127
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"676310\">@Frederick Pu</span> instead of printing <code>\"not working\"</code>, I replaced it with the error generated <code>e</code>, which made it clearer what went wrong:</p>\n<p><code>&lt;input&gt;:1:0: unknown parser category 'haveClearTac'</code></p>",
        "id": 546559766,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761171567
    },
    {
        "content": "<p>when i change it to `tactic i get \"expected tactic\"</p>",
        "id": 546559823,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171597
    },
    {
        "content": "<p>so i moved the parser definition into a seperate file <code>Basic.lean</code> and it seems the strong is parsing fine in the parser mode `(tactic | ...) but when i run parsercategory it's faililng: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">UtmLeannotes</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseTacticSeq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"w\"> </span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"c1\">-- works fine</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseTacticSeq</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry clear h x\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Parsed syntax:</span><span class=\"se\">\\n</span><span class=\"s2\">{stx.prettyPrint}\"</span>\n<span class=\"c1\">-- &lt;input&gt;:1:0: expected tactic</span>\n</code></pre></div>",
        "id": 546560240,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171819
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"676310\">@Frederick Pu</span> presumably it's because your environment just imports Init so it doesn't know about a lot of things</p>",
        "id": 546560288,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761171853
    },
    {
        "content": "<p>because for example changing the category to <code>term</code> and the input to <code>0</code> works</p>",
        "id": 546560304,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761171864
    },
    {
        "content": "<p>wdym input to 0?</p>",
        "id": 546560339,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171885
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"sd\">/-- Custom syntax: \"have &lt;name&gt; : &lt;term&gt; := sorry\\nclear &lt;names&gt;*\" -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">haveClearTac</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"have\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"s2\">\"clear\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"sd\">/-- Example of parsing a string into syntax manually. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"w\"> </span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"s2\">\"0\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Parsed syntax:</span><span class=\"se\">\\n</span><span class=\"s2\">{stx.prettyPrint}\"</span>\n</code></pre></div>",
        "id": 546560368,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761171900
    },
    {
        "content": "<p>this feels like an <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> problem, why are you using the IO monad in the first place?</p>",
        "id": 546560410,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761171918
    },
    {
        "content": "<p>so i can elab a string directly</p>",
        "id": 546560492,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171962
    },
    {
        "content": "<p>since im getting a string as input</p>",
        "id": 546560505,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761171968
    },
    {
        "content": "<p>oh i think with the importModules it's only importing Init anyway to get the entire lean enviorment?</p>",
        "id": 546560617,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172025
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"676310\">Frederick Pu</span> <a href=\"#narrow/channel/113488-general/topic/piggy.20back.20off.20of.20the.20lean4.20parser/near/546560492\">said</a>:</p>\n<blockquote>\n<p>so i can elab a string directly</p>\n</blockquote>\n<p>I'm asking why IO (instead of other more powerful monads), not why monad</p>",
        "id": 546560965,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761172232
    },
    {
        "content": "<p>what's a more powerful monad than io?</p>",
        "id": 546561016,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172257
    },
    {
        "content": "<p>MetaM?</p>",
        "id": 546561023,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172262
    },
    {
        "content": "<p>how would i be able to test my code then?</p>",
        "id": 546561036,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172270
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"sd\">/-- Custom syntax: \"have &lt;name&gt; : &lt;term&gt; := sorry\\nclear &lt;names&gt;*\" -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">haveClearTac</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"have\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"s2\">\"clear\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"sd\">/-- Example of parsing a string into syntax manually. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry</span><span class=\"se\">\\n</span><span class=\"s2\">clear h x\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Parsed syntax:</span><span class=\"se\">\\n</span><span class=\"s2\">{stx.prettyPrint}\"</span>\n</code></pre></div>",
        "id": 546561181,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761172371
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"676310\">Frederick Pu</span> <a href=\"#narrow/channel/113488-general/topic/piggy.20back.20off.20of.20the.20lean4.20parser/near/546561036\">said</a>:</p>\n<blockquote>\n<p>how would i be able to test my code then?</p>\n</blockquote>\n<p>i'm a bit confused, what are the limitations you're facing with MetaM?</p>",
        "id": 546561286,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761172444
    },
    {
        "content": "<p>i didnt know that you could just eval a MetaM</p>",
        "id": 546561317,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172461
    },
    {
        "content": "<p>im guessing it just does runMetaM with an empty context under the hood</p>",
        "id": 546561355,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172484
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"bar\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">67</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">bar</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 546561672,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761172702
    },
    {
        "content": "<p>you can even eval a TermElabM</p>",
        "id": 546561677,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761172706
    },
    {
        "content": "<p>any where i can check out where teh reprs are implemented</p>",
        "id": 546561774,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172761
    },
    {
        "content": "<p>oh nvm it's in CommandElabM so ig all of the monads can lift into it anyways</p>",
        "id": 546561870,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761172827
    },
    {
        "content": "<p>do you happen to know how to unquote the syntax eg: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Extract ident and type term using pattern-matching quasiquotes -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">..;</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>",
        "id": 546562538,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173275
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"676310\">@Frederick Pu</span> not entirely sure what your question means, but i've just tried to fix the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Extract ident and type term using pattern-matching quasiquotes -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>",
        "id": 546562856,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173447
    },
    {
        "content": "<p>not sure what exactly you want this unquoting to do</p>",
        "id": 546562868,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761173455
    },
    {
        "content": "<p>ah ig i just didnt know what the antiquote pattern was for ident*</p>",
        "id": 546562950,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173496
    },
    {
        "content": "<p>yeah it's just the same as when you declared it, i.e. <code>$ids:ident*</code>, but</p>\n<ol>\n<li>you need to turn <code>+</code> to <code>*</code>,</li>\n<li>and you use <code>ids.getElems</code> to get the array</li>\n</ol>\n<p>(i wish there were more metaprogramming documentation, i doubt these two facts are documented anywhere)</p>",
        "id": 546563032,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173551
    },
    {
        "content": "<p>i cant seem to get ids.getElems to work</p>",
        "id": 546563173,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173633
    },
    {
        "content": "<p>huh looks like it's an array already there</p>",
        "id": 546563287,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173717
    },
    {
        "content": "<p>so you don't need the getElems</p>",
        "id": 546563306,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173724
    },
    {
        "content": "<p>aha, you only need getElems when you have a separator</p>",
        "id": 546563366,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173749
    },
    {
        "content": "<p>oh nice!</p>",
        "id": 546563392,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173758
    },
    {
        "content": "<p>what's the difference between TSyntax and Syntax? does it just contain additional metadata about terms?</p>",
        "id": 546563442,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173781
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKinds</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">ks</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n<span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKinds</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">ks</span>\n</code></pre></div>",
        "id": 546563494,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173818
    },
    {
        "content": "<p>it tags the syntax with the kind, i.e. the <code> `(tactic| </code> in your example</p>",
        "id": 546563536,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173846
    },
    {
        "content": "<p>so it's like a very light type signature for the Syntax?</p>",
        "id": 546563557,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173862
    },
    {
        "content": "<p>yeah</p>",
        "id": 546563564,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761173868
    },
    {
        "content": "<p>kinda like which category you're in?</p>",
        "id": 546563572,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173872
    },
    {
        "content": "<p>also is it possible to parser but stop at the first valid occurance of </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Custom syntax: \"have &lt;name&gt; : &lt;term&gt; := &lt;term&gt;\\nclear &lt;names&gt;* &lt;tactic&gt;*\" -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">haveClearTac</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"have\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">ppLine</span>\n<span class=\"w\">  </span><span class=\"s2\">\"clear\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n</code></pre></div>\n<p>that is if you have <code>have n : term := sorry\\nclear none\\njunkvalues</code> it will parse it correctly?</p>",
        "id": 546563666,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761173954
    },
    {
        "content": "<p>i'm actually confused here already, why are you redefining an existing syntax</p>",
        "id": 546563772,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174011
    },
    {
        "content": "<p>we have an llm that's drafting in that format and sometimes it doesnt stop after the first clear properly and keeps going and makes multiple junk value drafts</p>",
        "id": 546563846,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174061
    },
    {
        "content": "<p>what if you tell the llm to stop after the first clear</p>",
        "id": 546563990,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174159
    },
    {
        "content": "<p>i don't see what the point of redefining syntax is</p>",
        "id": 546564024,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174183
    },
    {
        "content": "<p>if you want to parse string to syntax or whatever that's fine, you still don't have to redefine an existing syntax</p>",
        "id": 546564047,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174195
    },
    {
        "content": "<p>Or first clear with no indentation</p>",
        "id": 546564079,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174232
    },
    {
        "content": "<p>Yeee that would prob be better</p>",
        "id": 546564104,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174251
    },
    {
        "content": "<p>I was just having a bit of a brain damage moment</p>",
        "id": 546564124,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174265
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span>\n<span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 546564339,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174397
    },
    {
        "content": "<p>So I just use the tacticSeq category</p>",
        "id": 546564426,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174426
    },
    {
        "content": "<p>still, i feel like the better thing is to tell the llm what you want instead of filtering its output by hand</p>",
        "id": 546564610,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761174494
    },
    {
        "content": "<p>We're fine-tuning bfs prover so tool call format is apparently a no no</p>",
        "id": 546564659,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174527
    },
    {
        "content": "<p>I don't really mind doing this since we need to run a parser anyways to get abln expr For the draft type</p>",
        "id": 546564931,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761174722
    },
    {
        "content": "<p>now im getting the following error: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"sd\">/-- Example of parsing a string into syntax manually. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`tacticSeq</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">TSyntaxArray</span>\n<span class=\"sd\">/-- Extract ident and type term using pattern-matching quasiquotes -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"sd\">/-- Check if a `Syntax` is a `haveClearTac` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isHaveClearTac</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`haveClearTac</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tacticSeq</span><span class=\"bp\">|</span>\n<span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry</span><span class=\"se\">\\n</span><span class=\"s2\">clear h x\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isHaveClearTac</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"✅ This is a haveClearTac!\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"❌ Not a haveClearTac.\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- &lt;input&gt;:1:0: unknown parser category 'tacticSeq'</span>\n</code></pre></div>",
        "id": 546566285,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761175689
    },
    {
        "content": "<p>Try running parser category <code>tactic</code></p>",
        "id": 546567430,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761176369
    },
    {
        "content": "<p>but that wont work since the input string is now a tacticSeq</p>",
        "id": 546567513,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176445
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113488-general/topic/piggy.20back.20off.20of.20the.20lean4.20parser/near/546567430\">said</a>:</p>\n<blockquote>\n<p>Try running parser category <code>tactic</code></p>\n</blockquote>\n<p>it interprets it as one tactic instead of two</p>",
        "id": 546567548,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761176471
    },
    {
        "content": "<p>hacky solution here, what if you just split on newlines and parse each line separately</p>",
        "id": 546567580,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761176498
    },
    {
        "content": "<p>or just do low level searching of the string literals <code>have</code> and <code>clear</code></p>",
        "id": 546567598,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761176514
    },
    {
        "content": "<p>you can have statements as prop valued letE's inside of the draft type</p>",
        "id": 546567632,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176540
    },
    {
        "content": "<p>i think this is good enough tho thanks: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"sd\">/-- Example of parsing a string into syntax manually. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">TSyntaxArray</span>\n<span class=\"sd\">/-- Extract ident and type term using pattern-matching quasiquotes -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ty</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseHaveClear</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry</span><span class=\"se\">\\n</span><span class=\"s2\">clear h x\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">extractIdentAndTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 546567675,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176576
    },
    {
        "content": "<p>we could probably assume that the first line starting with clear is the clear line</p>",
        "id": 546567704,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176602
    },
    {
        "content": "<p>and that would also work</p>",
        "id": 546567714,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176607
    },
    {
        "content": "<p>it seems like the parser tacticSeq was defined without the category which is why it complains that there is no such category</p>",
        "id": 546568091,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761176899
    },
    {
        "content": "<p>that's so weird lol</p>",
        "id": 546568116,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176920
    },
    {
        "content": "<p>how does that even work</p>",
        "id": 546568120,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176924
    },
    {
        "content": "<p>is it like a one that's only used internally for tactic?</p>",
        "id": 546568129,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1761176936
    },
    {
        "content": "<p>If you out a tactic seq in parens it becomes a tactic</p>",
        "id": 546568373,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761177140
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"676310\">@Frederick Pu</span> i figured out how to run the parser directly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">ParseCommand</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"have h : Nat := sorry</span><span class=\"se\">\\n</span><span class=\"s2\">clear h x\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GuardExceptions</span><span class=\"bp\">.</span><span class=\"n\">captureException</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">tacticSeq</span><span class=\"bp\">.</span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"n\">str</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{stx}\"</span>\n</code></pre></div>",
        "id": 546568664,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761177353
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> maybe we should upstream <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Util/ParseCommand.html#Mathlib.GuardExceptions.captureException\">Mathlib.GuardExceptions.captureException</a> to core?</p>",
        "id": 546568774,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761177424
    },
    {
        "content": "<p>Maybe! I'm probably not the right person to ask though.</p>",
        "id": 546568918,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1761177520
    },
    {
        "content": "<p>who should i ask?</p>",
        "id": 546569016,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761177574
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> maybe?</p>",
        "id": 546569033,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761177585
    }
]