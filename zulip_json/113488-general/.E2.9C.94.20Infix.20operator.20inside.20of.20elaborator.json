[
    {
        "content": "<p>I was playing around creating some syntax for <code>defmagma</code>, where the idea is that <code>defmagma with foo =&gt; \"+\"</code> creates a class <code>«Magma_+_»</code> with a single closed operator <code>foo</code> together with a <code>infixl</code> declaration:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1001</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_».</span><span class=\"n\">op</span>\n</code></pre></div>\n<p>The utility of this might seem dubious, but I would like to understand why the <code>infixl</code> declaration isn't working. This is my first time using <code>CommandElab</code>, so apologies in advance!</p>\n<p>I have posted the code below, and the <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAGQKYEMB2AoDExLY1fAUQBsUAjOAYQhBHQBMsBnATzRhQA84AKNFCCRwAXAF44DJADNgaJAFkUAc3oBKDHDgAiKdPqqU2nQHdgMABbHgUjjrhiAfPeYwoouAGNa9NEwwAAgDa3nSMAPpIZJR6cooq9AC6GHpwURQAIjJxSoYeNGF+pBQYAD5wAAa8egb0cGaWcAAkOABygkgiNnjwTs04SFAoMNAAyqwg5BAkIq5Qag7ODBCacCRI8J5kzMztQqISzACE2gDVufThAN4DQyNQ45PTAHTKG6NucsoAvuEA3dpniM9khVutNttmABJBgHOAgADWMJ6XkhILBG1RKB2WS2cEACYSrLRVIlaLE7ZpbbHQ2G8BQeAAqrFwCxMFkGoLJXL4TV4bQ6CxEcHpgCTCYVwMUKDRc6VrTFyWRcXEkAmVXgK4BcGYAdgADHwwFBgNBzKw4QBGXW680LYwAansfV5VJ2MLUz15/KEall6XIBV8sJdzGVqz9AcYcA1SqQWzKcHCizgligEBMAFU0MwAK5gSCwJAMcYcbgsDbhHAwY34ACO2YgMAAClBY+zPAi4NIUCRmKCagkUPVzBY4Dgk9o7doMABiTxtjvnAfhO3/LByVzoTzCGBIVweReGZf/ODteBsjmrMfiE/DZ4oBj+AC0j6jaEVOv1vENxqNMDN18tXUACZbTgB1jD6A9LhXP5nhwLBZ3nOAoJQI9YLHABWOAAGYZznWMOywh1sKAA\">here</a> is the link to Lean Web version. When attempting to use <code>infixl</code> declaration from the elaborator, specifically at the last line <code>#check 5 + 3</code>, I get this error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">constant</span>\n<span class=\"w\">  </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_»</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>But if I uncomment the bare <code>infixl</code> declaration with higher priority (as to shadow the one from the elaborator), then it works. I don't know what I can do to fix the one from the elaborator.</p>\n<p>Additionally, I was told by Lean that my elaborator required having <code>set_option quotPrecheck false</code>, I think that is because of <code>($(opName) : M → M → M)</code>, but if it due to some other silly mistake, I would appreciate any pointers.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defineMagma</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"defmagma\"</span><span class=\"w\"> </span><span class=\"s2\">\"with\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" =&gt; \"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">defineMagma</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabDefineMagma</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">defmagma</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">opName</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">operatorSymbol</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">className</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"«Magma_{operatorSymbol.getString}_»\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">classId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">className</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">classDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">      </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">classId</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">opName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">infixDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1001</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">classId</span><span class=\"o\">)</span><span class=\"bp\">.$</span><span class=\"o\">(</span><span class=\"n\">opName</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">classDecl</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">infixDecl</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"n\">defmagma</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_»</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_»</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span>\n\n<span class=\"c1\">-- infixl:70 (priority := 1002) \" + \" =&gt; «Magma_+_».op</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_».</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 518397548,
        "sender_full_name": "Mathias Sven",
        "timestamp": 1747342044
    },
    {
        "content": "<p>The issue is that there's a difference between identifiers and dot notation. The <code>$(classId).$(opName)</code> is creating dot notation, hence the error about \"invalid field notation\"!</p>\n<p>What you need to do instead is make the single qualified identifier.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">defineMagma</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"s2\">\"defmagma\"</span><span class=\"w\"> </span><span class=\"s2\">\"with\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" =&gt; \"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">defineMagma</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabDefineMagma</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">defmagma</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">opName</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">operatorSymbol</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">className</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Magma_{operatorSymbol.getString}_\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">classId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">className</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">classDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">      </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">classId</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">opName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">qualifiedOpName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">className</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">opName</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">infixDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">infixl</span><span class=\"o\">:</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1001</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">qualifiedOpName</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mkNullNode</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">classDecl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">infixDecl</span><span class=\"o\">]</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"n\">defmagma</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_»</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_»</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Magma_</span><span class=\"bp\">+_».</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>(The <code>mkNullNode #[classDecl, infixDecl]</code> is not part of the fix. Just showing how you can elaborate multiple commands with <code>elabCommand</code>. You can also put all the commands into the syntax quotation.)</p>",
        "id": 518399002,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1747342664
    },
    {
        "content": "<p>Ah, that makes sense since the notation is overloaded, inside the elaborator I have to explicitly say that I just want a quantified identifier. That also seems to have got rid of the need for <code>set_option quotPrecheck false</code>. Thank you for the tip on <code>elabCommand &lt;|</code> as well.</p>\n<p>While I was looking around Zulip I also realized this should have gone into the <code>new members</code> channel, will do so in the future.</p>",
        "id": 518400437,
        "sender_full_name": "Mathias Sven",
        "timestamp": 1747343251
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"896430\">Mathias Sven</span> has marked this topic as resolved.</p>",
        "id": 518400472,
        "sender_full_name": "Notification Bot",
        "timestamp": 1747343269
    },
    {
        "content": "<p>The <code>quotPrecheck</code> failure was because there was dot notation, and there's no quotation precheck handler for dot notation.</p>\n<p>(I think this question is fine here, but feel free to ask future questions in <a class=\"stream\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members\">#new members</a> until you're comfortable with the Zulip.)</p>",
        "id": 518409242,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1747347262
    }
]