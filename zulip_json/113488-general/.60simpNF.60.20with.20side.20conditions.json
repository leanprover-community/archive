[
    {
        "content": "<p>It seems like the <code>simpNF</code> linter doesn't correctly take into account side conditions of simp lemmas. So it will give false positives on lemmas with higher priority, if those lemmas have a side condition that can't be found by unification.</p>\n<p>For example: we currently silence <code>simpNF</code> on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subgroup.mem_map_iff_mem#doc\">docs#Subgroup.mem_map_iff_mem</a>. Indeed, if we run the following code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Function.Injective</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subgroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">K.map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"bp\">?</span>\n</code></pre></div>\n<p>then we see that <code>mem_map_iff_mem</code> is not applied but <code>mem_map</code> is. Looking at the output of <code>trace.Meta.Tactic.simp</code> it becomes clear that <code>mem_map_iff_mem</code> is tried, but the <code>Injective ⇑f</code> hypothesis isn't discharged.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">discharge</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mem_map_iff_mem</span><span class=\"w\"> </span><span class=\"n\">discharge</span><span class=\"w\"> </span><span class=\"bp\">❌️</span>\n<span class=\"w\">      </span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"bp\">⇑</span><span class=\"n\">f</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">rewrite</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mem_map</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">K</span>\n<span class=\"w\">    </span><span class=\"bp\">==&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>But replace <code>simp</code> with <code>simp_all</code> and everything works suddenly.</p>\n<p>I think this can be solved by having <code>simpNF</code> check for these side conditions and call <code>simp_all</code> instead of <code>simp</code> in that case.</p>",
        "id": 507280019,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1742564351
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.02klzzwxh.3A0000.03.20with.20side.20conditions\">#mathlib4 &gt; <code>simpNF</code> with side conditions</a> by <span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span>.</p>",
        "id": 507280763,
        "sender_full_name": "Notification Bot",
        "timestamp": 1742564530
    },
    {
        "content": "<p>This seems related to but different from <a href=\"https://github.com/leanprover-community/batteries/pull/365\">batteries#365</a>. In that issue, <code>simpNF</code> fails outright, while here it does work (but gives the wrong lemma high priority).</p>",
        "id": 507321470,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1742575124
    },
    {
        "content": "<p>I went through all <code>nolint simpNF</code>s and added annotations to all that are caused by side conditions: <a href=\"https://github.com/leanprover-community/mathlib4/pull/23201\">#23201</a></p>",
        "id": 507323877,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1742575782
    }
]