[
    {
        "content": "<p>Hello,</p>\n<p>I'm trying to implement a minimal <a href=\"https://github.com/getkyo/kyo\">Kyo</a> kernel to later try help formalizing it.</p>\n<p>Flavio Brasil (Kyo's author) kindly provided a gist containing a minimal kernel in Scala3 so I've been studying it and trying to implement it in Lean.</p>\n<p>I currently have a very minimal implementation following Flavio's micro-kernel. Currently my proof of concept doesn't even work, it's currently almost a 1-to-1 mapping from Scala to Lean (except from some workarounds given the difference between Scala3 types and Lean)  but I'm pretty happy with how the Lean code is getting shaped, but now I'm here to ask for some help involving type inference in Lean4.  Once I get the prototype to run correctly, the most interesting work will be in trying to prove termination for kyo's effect handling.</p>\n<p>The following is a link to my current code - pasted it into lean4web  for sharing -:<br>\n<a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=HYQwtgpgzgDiDGEAEBpAngewFBaUkARgQE4QBuSAKiAOZIBcAvEgDIQjAB0AcuBDngAmEAGZIAgsWIYA7g2aU0MZAEZcSAJbBBAV3gAXDWWSTpMzmADWSABQBJYDB376VJcgC0APjfKAlLYA8s5OLr6ePor+DBJSsgJIwmIAChDaWjScABLsgvKxZupaugZGyKnpwHQyABYQpOoAPkjAGMDIrhWCGU1I8G1QMV0Z2blI3kjDVeM+UzTqoJCwCOVp3VXqeFpQ+hyIMQ41hBr6EHlz+YAX5K3tgJfkCUKi+DDK2kNrGTOTH9MTc5tIZo3CAAGiQg0YPigAOa/WAgxA4LBUAATEhIX0BvgkAASZ6vPKDVEPcYeJAAZT4SAwymIIH0GGISBEjKQMFIBM+ohEEAMgwZSH0dSQABsNDtOACPGStEhSFAIGACCK9sgMGJyfAQCqAOSDLSnYgK0ptQXuaF4LbAEQaAAexHoAFYAAxIABESAAZO70T44RbLVobfana6Pd6PRiQC81uo1t9KvMito9IZjEgAKIiHkGWwANVcGGcyRAdLA4QCNmSheLpfACfWNACtXq/DwzWSOlItjIrjzfnUAHppRSdLB44iyNqdMgAAbiWf4N6I0hgEBaT5wwzAHT0jSm2cAIS+WZEi48g965LHBKQAG9xEhDzX9CWy+EAL62XY0VzUJu2FooSuOIlZbq4x4TKevL6EgeaTAOCx8Ms+zQQYAJBnaDouj6AA8PoYmh+gkkkSBWDkIB5DYBYVrY1YNiMFGCAETBwUg+FVl6SCcMCA6Wpo1pYaGeEET45G5CSI7iM4GBroY8CYvU8D7sAzLSOWs7wfh5KAEEEi4Cpp7G2OSgCBBFxul+LOkr8aRMgaMIql3jRRavnW5ZRBAX53qZFI6S+b71nMX59kZulfFpxlmd6FkwpMXbIBQGKdt2ZCxde45vLBGhINYGLpbeWW2IA3cBILavpIHZDm2NYtp+HxgbwrswD7N5Zm6Z0Pw0MFSAAMIYMg1GhTplYRTYPnRcNLHMJclVpPcUpktJDJyRoCn9EpKlqbJSCGdpXFzDxbQQPpGA7RF5JWQCpGgHEchOf5bmfve5IPe+QUxOd+2dYd7ThaFsXJQl5WA0gqX8c0+XxoVuU+JDmWaLYIg6KpZUYjdZjVaVdUYY1qrPR1ibdX1A2fd6B28fmoVTUg1ylmY802U8IgqvoACy0YAngd7JGZyR+dStZvZ1H6c/eeZmXm/MuQF7nuCL/F4DY3J9mZ+E85WIgq+FOlGXz9V4H2OscTz+3DfIotyfANRINyFUnDUosdvFoPlWIYMKxDN5QwjMOjhleSFTYSMo67LPszAmO1cyiGM2Ia4wKL3OvYFwuJ+LcFS4L9YefLCtK9mWtqxrWsTJL+sfUbkzmwrooQLBIA6LaJc+JLRk/R0zDB6VwPO0HWOi8z9Lhzb2b4I3pJj2VdQijAgyrhg6bk0dcZvERODqPAKpQIMWQcIIIr1MZuynEgAAaSAAJp/u4lantfyhICozZ1A0/E/n+tAAkc2gH645LHxEM+XwbAXxPNmAIEx/70mQAAdczNmBIixoBwH2LvH+9QSRTmIBoQgB9E5ZGTuWA6TFc78STgLVyQtCaJ3PqA+CUDTiEM/CRJ4xBkYMLbHnb++96iuDQTwpkHCgGgMGvhLI+1sY13zjmMIEVxFk3LorHY0C/4APLq4MaACkBwP7LrauCsRQYBpCPGR4IAGixbK/GuoojER2kTBEKYiJG2GUYwikaiYiaOgdouCAQ1b6Jrpba23IYJ2yFKLds3EQaJR8JwEGNhXGglBooy0zROBwyouIJgp9KzPkYBfAIP4fa+giYGMQAB9VwRTmDcIPsQTgRShRpFKfxA+sEbDtBkBwsEnTTzU1qfUTgAyzHeOypYFplpDHGN6aPTpHCJkQBFAqCZeB0le0yrQBGQdkbUnKlMux1gMABESSkvAhowBaD3G0cpBA0C2BCQYZEHiRwADE7Cn1ZhmKpdQFSChkKdUsNAdCQGAPoIkNQiwijyAQZAwh4CkBAFAT4Ap2TkDSLBG4HhzmXMMG0UpcKEVIqqDcu5UBGTEDQAAbnBOSu5I5KCBAACKBFcOyBe9lkDkA5c1ZAQp6Q2OMQS9gCpoRXVYewgBB9t6ixsAMh0SB+F1KQAAVWACcYRlMnEKJSdIxxCqJGiz1ckQ1zAbBsOAEI2Ve86lMDlQEW2Ng6oWGjMyHZqMfC2k4FAbQCR4yKoweoUiThuw2F7L4j6bdgT5Dic7d2pEoDrMEInei0tHrvTvLQuCTCc4yrCP+SsTcz6VksK4UBpddbqLYv41iaz/aCm7uMhIpE7B5HvoAjy+R7KBqeH1RqMQO0TAHZEdw+Qu5lXKeVW0OB4zoGwOvJBKFkCMsVNgPANI0ioEwE2p44gCCMnaV82irFTCyAsNYGwvadiZkrJe2CGYwAwH0GgeqC6UEmD3cQYi/EsE4OVMgO8GYs0UJlk9chqaqGNhFmKsQRTWKzmXWADAnBd37pYWIEQ64RT3LiPKjMLEq22BQ5+69ATLQJrrSApg97H3PsFJs+o0gmRdxsJUzMD6n0BEhKUkcQpxRIBIHsa2fHkYIqtrg5ARLULsbuUcQYrQBJHAICcDgYLuNkjeR8w9Y5PgifYGJv9ABCJAL9kD/J0FC/jvLhRstpIKGoGQwQEGcHZvjZmLOkAAI46A0N2LlDl9jqjYgKGFCnjinCTdYmlUg0Akm2E1fYcqYj+qZKq9VgHqNPtsBmW0iBH2ZgIzYIjd6AgKIqiZ0WsHmA/lFsMxJCMJ2sQSQAsEwbkB4my7l/QnAGOsg0DHS0pFzX3ILgVorJHSsaI6xAPLgHdHVsYKLZLnBzUcKlYMRL0jnURym4+zgGBLD9fjEV6dbwEPYCAA\">Kyo.lean</a></p>\n<p>Note: My lean code tries to use the same conventions and operators as Scala3's Kyo.<br>\nSo it might be easier to understand if you know a bit about Kyo on Scala.<br>\nFor example, <code>V &lt; H &amp; P</code> is a computation of value <code>V</code> after <code>H &amp; P</code> effects have been handled. <code>H &amp; P</code> is currently just a list of <code>Pending</code> effects, a naive replacement of Scala3 intersection types.</p>\n<p>The problem in my current code (line 90 is red on the type of a suspended value) seems to involve the following data types:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Effect</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">V</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Pending</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Suspend</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tag</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cont</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Effect</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Handler</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Eff</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">tag</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tag</span>\n<span class=\"w\">    </span><span class=\"n\">handle</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Eff</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">Ã—</span><span class=\"w\"> </span><span class=\"n\">Eff</span>\n</code></pre></div>\n<p><code>Handler.handle</code> is the function that takes a world state,  a previously suspended value <code>A</code> and the continuation <code>B -&gt; V &lt; P</code> as given to <code>Effect.Suspend</code> and produces a new state and remaining effect. (At the very bottom there's an Abort effect trying to showcase usage)</p>\n<p>Now, the issue (line 90), to me seems to be that currently my code is not able to infer that I want the types <code>A</code> and <code>B</code> from <code>Effect.Suspend</code> to match <code>X</code> and <code>Y</code> as given to <code>Handler</code>.</p>\n<p>Even when I'm explicitly providing the types at line 88 for <code>Kyo.Effect.Suspend (A:=X)</code> and also the types for <code>Handler</code> are given explicitly.</p>\n<p>However the Lean inspector shows that there are two different <code>X</code> types. I'm not sure where the second one arises from.  The variable <code>i</code>,  the <code>input</code> value given to <code>Suspend</code>, is unable to unify it's type.</p>\n<p>If anyone more well versed than me in how might Lean introduce implicit types, and has any pointer on how to solve my issue, I really would appreciate your help.</p>",
        "id": 498437723,
        "sender_full_name": "Victor Borja",
        "timestamp": 1738967694
    },
    {
        "content": "<p>You could try using <code>set_option autoImplicit false</code> to avoid implicit variables altogether</p>",
        "id": 498473951,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1738995421
    },
    {
        "content": "<blockquote>\n<p>Now, the issue (line 90), to me seems to be that currently my code is not able to infer that I want the types <code>A</code> and <code>B</code> from <code>Effect.Suspend</code> to match <code>X</code> and <code>Y</code> as given to <code>Handler</code>.</p>\n</blockquote>\n<p>But you're not allowed to do that. A pattern match has to handle all cases, so what is happening is that you're introducing a new <code>X</code> and <code>Y</code> instead of forcing <code>A</code> and <code>B</code> to the existing <code>X</code> and <code>Y</code>.</p>",
        "id": 498482259,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739003589
    },
    {
        "content": "<p><code>outParam</code> also doesn't do anything on <code>inductive</code> so likely this part is an incorrect translation of the Scala type</p>",
        "id": 498482373,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739003716
    },
    {
        "content": "<p>Replying to self, -while also trying to be more helpful to others- as to why you cant match on a type given to a constructor (as opposed to a type given to a type-constructor as for example Option). </p>\n<p><a href=\"/user_uploads/3121/RplJC326tIEIS5Mv_ToC-Shy/Screenshot-2025-02-09-070938.png\">type parameter on constructor will introduce a new type variable</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/RplJC326tIEIS5Mv_ToC-Shy/Screenshot-2025-02-09-070938.png\" title=\"type parameter on constructor will introduce a new type variable\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1040x314\" src=\"/user_uploads/thumbnail/3121/RplJC326tIEIS5Mv_ToC-Shy/Screenshot-2025-02-09-070938.png/840x560.webp\"></a></div><p>It would be nice to be able to write something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- b is a Nat</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- b is anything but a Nat</span>\n</code></pre></div>\n<p>Update: The following seems to have no problem:</p>\n<p><a href=\"/user_uploads/3121/xSRoqHY72zsqgar3HdCfKhJ9/Screenshot-2025-02-09-115039.png\">matching on foo</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/xSRoqHY72zsqgar3HdCfKhJ9/Screenshot-2025-02-09-115039.png\" title=\"matching on foo\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"545x157\" src=\"/user_uploads/thumbnail/3121/xSRoqHY72zsqgar3HdCfKhJ9/Screenshot-2025-02-09-115039.png/840x560.webp\"></a></div>",
        "id": 498599319,
        "sender_full_name": "Victor Borja",
        "timestamp": 1739107061
    },
    {
        "content": "<p>Ok, now after the previous insights, I'm trying the following:</p>\n<p><a href=\"/user_uploads/3121/Yu-5jRQKU9j2FjDJrg8qO70N/Screenshot-2025-02-09-120153.png\">Screenshot 2025-02-09 120153.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Yu-5jRQKU9j2FjDJrg8qO70N/Screenshot-2025-02-09-120153.png\" title=\"Screenshot 2025-02-09 120153.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1324x418\" src=\"/user_uploads/thumbnail/3121/Yu-5jRQKU9j2FjDJrg8qO70N/Screenshot-2025-02-09-120153.png/840x560.webp\"></a></div><p>How could I implement <code>head</code> for a heterogeneous list in Lean4 ?</p>",
        "id": 498620582,
        "sender_full_name": "Victor Borja",
        "timestamp": 1739124276
    },
    {
        "content": "<blockquote>\n<p>How could I implement <code>head</code> for a heterogeneous list in Lean4 ?</p>\n</blockquote>\n<p>There's an example of an <code>HList</code> on <a href=\"https://github.com/leanprover/lean4/blob/bcde913a96bbd8868cde45c10bb21b25af63f9a2/doc/examples/deBruijn.lean#L23\">examples/deBruijn.lean</a>, hope that helps :)</p>",
        "id": 498623170,
        "sender_full_name": "Victor Borja",
        "timestamp": 1739126442
    }
]