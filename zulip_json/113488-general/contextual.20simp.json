[
    {
        "content": "<p>I find the simp config option <code>(config := {contextual := true})</code> incredibly helpful. In my experience, there are very few times when turning it on makes my proof worse in any way, except for the fact that it's so much to type and read. </p>\n<ol>\n<li>Is it possible to have a local config setting in my file so that every simp call automatically has that option turned on?</li>\n<li>Should this option be turned on by default in simp?</li>\n</ol>",
        "id": 474038278,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727789316
    },
    {
        "content": "<p>Here's a quick example of the kind of thing it can be used for:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">thing</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">thing</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>with the option turned off, <code>simp [thing]</code> can't close the goal, but once it's open <code>simp</code> can look at the context in which <code>f x = g x</code> is meant to be proved, and use hypotheses there to help</p>",
        "id": 474039708,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727789660
    },
    {
        "content": "<p>At least nice syntax (<code>simp contextual  …</code>) would be nice. Whenever I see <code>(config := …)</code> it feels like we are in reaching into the guts of the machine, warranty broken, get to keep both pieces territory, and I hope that <code>contextual</code> is more user-facing than that.</p>",
        "id": 474040339,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1727789833
    },
    {
        "content": "<p>I'd go further and ask for <code>simp!</code> to mean that! My rough mnemonic for <code>!</code> is \"try a bit harder\", which feels pretty similar to what <code>contextual</code> is doing here</p>",
        "id": 474040702,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727789935
    },
    {
        "content": "<p>Hmm, if there are many different ways a tactic could go harder, like here (less limits! more unfolding! contextual! decide!) then <code>simp!</code> is probably no a good UI choice.</p>",
        "id": 474041342,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1727790094
    },
    {
        "content": "<p>With my Isabelle background I also wonder why it isn’t simply the default. Probably performance, or simply backward compat? Or does it sometimes maybe break?</p>",
        "id": 474041408,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1727790112
    },
    {
        "content": "<p>Fair point about <code>simp!</code>. But I also wonder why it isn't the default...</p>",
        "id": 474041755,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727790196
    },
    {
        "content": "<p>I think caching is harder with contextual on.</p>",
        "id": 474110612,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1727810485
    },
    {
        "content": "<p>I also find <code>contextual</code> the most useful simp configuration, and use it regularly. That said, I don't use it <em>that</em> often, so if it's a bit slower, I think we should not turn it on by default.<br>\nI think a useful experiment would be to build Mathlib with this option turned on by default.<br>\nIf we don't turn it on by default, I would also appreciate a shorter syntax</p>",
        "id": 474121877,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727814608
    },
    {
        "content": "<p>Yes, running this experiment sounds incredibly valuable. How can I turn the option on by default in order to try this? (Or rather, how can I do so in a way that CI can benchmark it rather than me rebuilding Lean + mathlib)</p>",
        "id": 474122021,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727814664
    },
    {
        "content": "<p>Maybe override the <code>simp</code> syntax and elaborate it to a call with the <code>contextual</code> option turned on. Hopefully there are not too many nonterminal simps that now break (or terminal simps that break due to nonconfluence).</p>",
        "id": 474123443,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727815154
    },
    {
        "content": "<p>I'm not exactly sure how to do this if the user also specifies a config option and you have to combine options (then it might be tricky as a purely syntax-level manipulation). This should be doable, but I don't know exactly how. <br>\nOne option is to not override those simp calls, and then it can be done by an easy macro.</p>",
        "id": 474123773,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727815291
    },
    {
        "content": "<p>Or open a draft PR against lean4, changing the actual default, and then play with the adaption branch</p>",
        "id": 474127734,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1727816758
    },
    {
        "content": "<p>Both of these sound doable but I'm not sure I'm smart enough to figure either one out on my own</p>",
        "id": 474129205,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727817343
    },
    {
        "content": "<p>There's a chance that the next Lean release will have <code>simp +contextual</code> syntax and some support for composable config updates. We've been discussing enabling such notation for every tactic that uses <code>Lean.Parser.Tactic.config</code>, with some varying thoughts on what the syntax would be.</p>\n<p>I've been thinking syntax like <code>simp +contextual -zeta (etaStruct := .none) (maxSteps := 22222)</code>, where <code>+contextual</code> is shorthand for <code>(contextual := true)</code>.</p>",
        "id": 474130230,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727817859
    },
    {
        "content": "<p>Does composable config updates mean chaining <code>+contextual -zeta</code> in the way you did, or having local config settings in a file, or something else? In any case this syntax is nicer already!</p>",
        "id": 474130375,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1727817944
    },
    {
        "content": "<p>Composability means you would be able to make a macro that takes <code>my_great_tactic $config</code> to <code>simp +contextual $config</code>, maybe with a little bit of extra syntax.</p>",
        "id": 474130770,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727818090
    },
    {
        "content": "<p>This is a partial implementation of the macro:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">my_simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"simp\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- cfg:(config)?</span>\n<span class=\"w\">  </span><span class=\"n\">dis</span><span class=\"o\">:(</span><span class=\"n\">discharger</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:(</span><span class=\"s2\">\" [\"</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">simpStar</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">simpErase</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">simpLemma</span><span class=\"o\">),</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"w\">  </span><span class=\"n\">loc</span><span class=\"o\">:(</span><span class=\"n\">location</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">dis</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">loc</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>Currently the <code>args</code> argument is ignored in this macro. Maybe one of the metaprogramming wizards can help me with also applying the <code>simp</code> to <code>$(args)?</code>, which doesn't work because that is not an atomic syntax.<br>\nI would also be interested to see the implementation with an uncommented <code>$cfg</code> and adding the extra configuration option on the right-hand side. I tried to do that once before with a different tactic, but didn't succeed.</p>\n<p>(I do not let the macro apply for <code>simp only</code> since it seems bad to turn <code>contextual</code> on in that case).</p>",
        "id": 474249284,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1727862839
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/contextual.20simp/near/474130230\">said</a>:</p>\n<blockquote>\n<p>There's a chance that the next Lean release will have <code>simp +contextual</code> syntax and some support for composable config updates. We've been discussing enabling such notation for every tactic that uses <code>Lean.Parser.Tactic.config</code>, with some varying thoughts on what the syntax would be.</p>\n<p>I've been thinking syntax like <code>simp +contextual -zeta (etaStruct := .none) (maxSteps := 22222)</code>, where <code>+contextual</code> is shorthand for <code>(contextual := true)</code>.</p>\n</blockquote>\n<p>I've been playing with this recently, and I really like it. Thanks!</p>",
        "id": 481787693,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731351248
    },
    {
        "content": "<p>By the way, here's how you can define \"Bhavik's simp\":</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_simp_like_tactic</span><span class=\"w\"> </span><span class=\"n\">bhavikSimp</span><span class=\"w\"> </span><span class=\"s2\">\"bsimp \"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">bsimp</span>\n</code></pre></div>",
        "id": 481831590,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731369334
    },
    {
        "content": "<p>Thanks! Have added this to my list of mehtaprogramming tricks :)</p>",
        "id": 481835346,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1731371054
    },
    {
        "content": "<p>i seem to recall that now you can also write <code>simp +contextual</code></p>",
        "id": 481942654,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1731416434
    },
    {
        "content": "<p>and apparently, this also works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_simp_like_tactic</span><span class=\"w\"> </span><span class=\"n\">bhavikSimp</span><span class=\"w\"> </span><span class=\"s2\">\"bsimp \"</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">contextual</span>\n</code></pre></div>",
        "id": 481942896,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1731416502
    }
]