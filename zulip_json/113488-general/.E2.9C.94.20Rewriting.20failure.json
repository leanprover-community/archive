[
    {
        "content": "<p>I am trying to rewrite using the following lemma</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">naturality</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"o\">‚¶É</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">‚¶Ñ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ùü≠</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n<p>in the goal</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"bp\">‚úù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∑</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">Œº'</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∑</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">Œº'</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">‚úù</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∑</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">)</span>\n<span class=\"w\">   </span><span class=\"bp\">^^^^^^^^^^^^^^</span><span class=\"w\"> </span><span class=\"n\">here</span>\n</code></pre></div>\n<p>but Lean complains that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"mi\">ùü≠</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">Œ∑</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">Y</span>\n</code></pre></div>\n<p>even though the following lemma is marked <code>simp</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">id_map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ùü≠</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>How do I convince Lean to simplify the lemma before trying to use it for rewriting?</p>",
        "id": 504614327,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741619831
    },
    {
        "content": "<p>(The code is <a href=\"https://github.com/ncfavier/mathlib4/blob/9d53df8c54ecb7980ff45fb843e964cfbbd80403/Mathlib/CategoryTheory/Monoidal/Monad.lean#L37\">here</a>)</p>",
        "id": 504615849,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741620141
    },
    {
        "content": "<p>does <code>rw [‚Üê id_map f, M.Œ∑.naturality]</code> work?</p>",
        "id": 504616448,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741620274
    },
    {
        "content": "<p>Yes. I was hoping to avoid that. It also rewrites another occurrence of <code>f</code> that I don't want to rewrite, but I suppose I can control that.</p>",
        "id": 504616955,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741620373
    },
    {
        "content": "<p>you can just rewrite it back</p>",
        "id": 504617036,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741620392
    },
    {
        "content": "<p>if it's really bad, you can also use <code>nth_rewrite</code> or <code>rw (occs := _)</code></p>",
        "id": 504617198,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741620425
    },
    {
        "content": "<p>Ah, the answer is <code>erw</code>.</p>",
        "id": 504621764,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741621406
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385845\">Na√Øm Camille Favier</span> has marked this topic as resolved.</p>",
        "id": 504621798,
        "sender_full_name": "Notification Bot",
        "timestamp": 1741621417
    },
    {
        "content": "<p>No no, erw is not the answer</p>",
        "id": 504626439,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741622335
    },
    {
        "content": "<p>indeed, <code>erw</code> is considered technical debt in mathlib</p>",
        "id": 504628875,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741622759
    },
    {
        "content": "<p>Is there a better answer?</p>",
        "id": 504629193,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741622824
    },
    {
        "content": "<p>It's a bit strange for a rewriting tactic not to consider terms up to definitional equality, at least.</p>",
        "id": 504629837,
        "sender_full_name": "Na√Øm Camille Favier",
        "timestamp": 1741622948
    },
    {
        "content": "<p>the opposite, actually: it's strange for a rewriting tactic to consider terms up to anything other than syntactical equality</p>",
        "id": 504630051,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741622995
    },
    {
        "content": "<p>Edward, I think you should be a lot more careful with that kind of message. Many people who formalize a lot <em>lot</em> more than you disagree with your strangeness assessment. The SSReflect rewriting tactic is very different here.</p>",
        "id": 504636378,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1741624338
    },
    {
        "content": "<p>my point is that if it does something more than syntax substitution, it's not rewriting</p>",
        "id": 504638400,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741624912
    },
    {
        "content": "<p>My point is that people like Georges Gonthier are more qualified than you or me to decide what should be called rewriting. We may like what Lean does but still refrain from this kind of bold general claim about what should be called rewriting.</p>",
        "id": 504639560,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1741625249
    }
]