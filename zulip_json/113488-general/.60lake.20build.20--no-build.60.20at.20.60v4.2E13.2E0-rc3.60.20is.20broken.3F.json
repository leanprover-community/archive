[
    {
        "content": "<p>I'm <a href=\"https://github.com/FR-vdash-bot/Algorithm/pull/44\">updating toolchain</a>, but <code>lake exe shake</code> is incorrectly saying <code>There are out of date oleans.</code>. <code>lake build --no-build</code> says nothing.</p>",
        "id": 474875999,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1728065001
    },
    {
        "content": "<p>does <code>lake build --no-build</code> return an error code?</p>",
        "id": 474877735,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728065830
    },
    {
        "content": "<p>I talked about this issue with <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> on wednesday, I'm not sure if the fix ended up in rc3. There was a change that made no-op builds no longer no-ops, so even after <code>lake build</code>, <code>lake build --no-build</code> would still report an error</p>",
        "id": 474878038,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728065992
    },
    {
        "content": "<p>Yes, then I will disable <code>shake</code> in CI. Hopefully this could be fixed in the future.</p>",
        "id": 474929965,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1728090883
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/.60lake.20build.20--no-build.60.20at.20.60v4.2E13.2E0-rc3.60.20is.20broken.3F/near/474878038\">said</a>:</p>\n<blockquote>\n<p>I talked about this issue with <span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> on wednesday, I'm not sure if the fix ended up in rc3. There was a change that made no-op builds no longer no-ops, so even after <code>lake build</code>, <code>lake build --no-build</code> would still report an error</p>\n</blockquote>\n<p>That issue should be fixed in the RC. A no-op build is should still pass <code>lake build --no-build</code>  under the same circumstances as before.</p>",
        "id": 475004584,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728152378
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Note that <span class=\"user-mention\" data-user-id=\"455791\">@Yuyang Zhao</span> does not report <code>lake build ---no-build</code> failing so this sounds like a different issue.</p>",
        "id": 475004755,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728152466
    },
    {
        "content": "<p>it's unclear. I'm very sure that the only way shake can give that particular error message is if <code>lake build --no-build</code> returns an error code</p>",
        "id": 475004829,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728152514
    },
    {
        "content": "<p>which RC are you referring to?</p>",
        "id": 475004921,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728152553
    },
    {
        "content": "<p>RC1/RC3 (they are the same)</p>",
        "id": 475005046,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728152634
    },
    {
        "content": "<p>I tried replicating <span class=\"user-mention\" data-user-id=\"455791\">@Yuyang Zhao</span> 's build, but I hit a different error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"c1\">--wfail -KCI</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">845</span><span class=\"bp\">/</span><span class=\"mi\">881</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">algorithm</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">.</span><span class=\"n\">o</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">clang</span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">cpp</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">.</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">cpp</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.13.0-rc3/include -fPIC</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">included</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"bp\">././</span><span class=\"n\">cpp</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span>\n<span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">mario</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.13.0-rc3/include/lean/lean.h:14:10: fatal error: 'atomic' file not found</span>\n<span class=\"w\">   </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">atomic</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\">          </span><span class=\"bp\">^~~~~~~~</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"bp\">.</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">clang</span><span class=\"bp\">++'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">algorithm</span><span class=\"bp\">/</span><span class=\"n\">ffi</span><span class=\"bp\">.</span><span class=\"n\">o</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>",
        "id": 475005286,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728152815
    },
    {
        "content": "<p>I commented out the FFI stuff since it's irrelevant, and managed to reproduce the shake failure</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">shake</span><span class=\"w\"> </span><span class=\"c1\">--gh-style</span>\n<span class=\"n\">There</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">date</span><span class=\"w\"> </span><span class=\"n\">oleans</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Run</span><span class=\"w\"> </span><span class=\"ss\">`lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">first</span>\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"c1\">--no-build</span>\n<span class=\"bp\">⣿</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">?/?</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Computing</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">jobs</span><span class=\"bp\">⏎</span>\n<span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">status</span>\n<span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 475005612,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728153033
    },
    {
        "content": "<p><code>lake build --verbose</code> has a lot of things in it (mostly replays), but the relevant part is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">846</span><span class=\"bp\">/</span><span class=\"mi\">876</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Optional</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Fetching</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">»</span><span class=\"o\">:</span><span class=\"n\">optBarrel</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">.</span><span class=\"n\">barrel</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">reservoir</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">lang</span><span class=\"bp\">.</span><span class=\"n\">org</span><span class=\"bp\">/</span><span class=\"n\">api</span><span class=\"bp\">/</span><span class=\"n\">v1</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">/</span><span class=\"n\">barrel?rev</span><span class=\"bp\">=</span><span class=\"n\">ccb4e97ffb7ad0f9b1852e9669d5e2922f984175</span><span class=\"bp\">&amp;</span><span class=\"n\">toolchain</span><span class=\"bp\">=</span><span class=\"n\">leanprover</span><span class=\"bp\">%</span><span class=\"mi\">2</span><span class=\"n\">Flean4</span><span class=\"bp\">%</span><span class=\"mi\">3</span><span class=\"n\">Av4</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">-</span><span class=\"n\">Reservoir</span><span class=\"bp\">-</span><span class=\"n\">Api</span><span class=\"bp\">-</span><span class=\"n\">Version</span><span class=\"o\">:</span><span class=\"mf\">1.0</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">-</span><span class=\"n\">Lake</span><span class=\"bp\">-</span><span class=\"n\">Registry</span><span class=\"bp\">-</span><span class=\"n\">Api</span><span class=\"bp\">-</span><span class=\"n\">Version</span><span class=\"o\">:</span><span class=\"mf\">0.1</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">curl</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">22</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">requested</span><span class=\"w\"> </span><span class=\"n\">URL</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">404</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">curl'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">22</span>\n<span class=\"n\">ℹ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">847</span><span class=\"bp\">/</span><span class=\"mi\">876</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Ran</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">»</span><span class=\"o\">:</span><span class=\"n\">extraDep</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">building</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"n\">Reservoir</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"bp\">'«</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">»</span><span class=\"o\">:</span><span class=\"n\">optBarrel'</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">details</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 475005786,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728153173
    },
    {
        "content": "<p>(note <code>Ran</code> not <code>Replayed</code>)</p>",
        "id": 475005817,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728153208
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17453\">#17453</a> lets you turn off the <code>lake build --no-build</code> check in shake, so that you don't have to turn it off (cc: <span class=\"user-mention\" data-user-id=\"455791\">@Yuyang Zhao</span> )</p>",
        "id": 475006656,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728153658
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> The problem here is that whole build is not finished yet, right ? (e.g., <code>doc-gen4</code> has not yet been built.)</p>",
        "id": 475008428,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728154611
    },
    {
        "content": "<p>no?</p>",
        "id": 475008490,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154636
    },
    {
        "content": "<p>Did you run a full <code>lake build</code> before this?</p>",
        "id": 475008505,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728154646
    },
    {
        "content": "<p><code>lake build</code> completed successfully at least</p>",
        "id": 475008509,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154648
    },
    {
        "content": "<p>yes, several times</p>",
        "id": 475008518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154654
    },
    {
        "content": "<p>every time I run it I get the output I showed</p>",
        "id": 475008606,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154684
    },
    {
        "content": "<p>Oh. Does <code>.lake/packages/doc-gen4/.lake/build</code> exist?</p>",
        "id": 475008693,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728154731
    },
    {
        "content": "<p>no:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">al</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span>\n<span class=\"n\">total</span><span class=\"w\"> </span><span class=\"mf\">1.2</span><span class=\"n\">M</span>\n<span class=\"bp\">-</span><span class=\"n\">rw</span><span class=\"bp\">-</span><span class=\"n\">rw</span><span class=\"bp\">-</span><span class=\"n\">r</span><span class=\"c1\">-- 1 mario mario 1.2M Oct  5 20:24 lakefile.olean</span>\n<span class=\"bp\">-</span><span class=\"n\">rw</span><span class=\"bp\">-</span><span class=\"n\">rw</span><span class=\"bp\">-</span><span class=\"n\">r</span><span class=\"c1\">-- 1 mario mario  153 Oct  5 20:24 lakefile.olean.trace</span>\n</code></pre></div>",
        "id": 475008774,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154799
    },
    {
        "content": "<p>so I guess the liar here is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 475008944,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154876
    },
    {
        "content": "<p>If I do <code>lake build doc-gen4</code> then stuff happens</p>",
        "id": 475008993,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154921
    },
    {
        "content": "<p>and after that <code>.lake/packages/doc-gen4/.lake/build</code> exists, and <code>lake build --no-build</code> does not give an error</p>",
        "id": 475009084,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728154967
    },
    {
        "content": "<p>Okay, I see the bug here. It is actually an old issue I had discussed with you. Namely, Lake builds the package-level targets for package and its dependencies (of which the cache is one) even if no targets in one of those dependencies are built. Lake needs to be more careful here and only build the package-level dependencies of packages with a built target.</p>",
        "id": 475009225,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728155045
    },
    {
        "content": "<p>Fortunately, this particular case of this error should resolve itself when doc-gen4 is built on the latest toolchain tomorrow.</p>",
        "id": 475009831,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728155363
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Would you mind making an GitHub issue for this bug?</p>",
        "id": 475119800,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728236571
    },
    {
        "content": "<p>I am not sure if this is the same issue, but it seems that <em>all</em> mathlib PRs fail to download cache, since they run</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"c1\">--no-build Mathlib.Init &amp;&amp; lake exe cache get || echo \"No cache for 'Mathlib.Init' available\"</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"c1\">--no-build Mathlib.Init</span>\n</code></pre></div>\n<p>always fails.</p>\n<p>Pinging <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> since he may be able to help!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 475276720,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728301163
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> That is likely the same underlying issue. However, since there is now a doc-gen4 cache, it is probably failing on a diiferent package (and I would be curious to learn which one).</p>",
        "id": 475296846,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728307503
    },
    {
        "content": "<p>I am not sure how to find out what package is causing problems for mathlib, but lean4checker mentions <code>Cli</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lean4checker<span class=\"w\"> </span>found<span class=\"w\"> </span>a<span class=\"w\"> </span>problem<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>Main\nuncaught<span class=\"w\"> </span>exception:<span class=\"w\"> </span>unknown<span class=\"w\"> </span>module<span class=\"w\"> </span>prefix<span class=\"w\"> </span><span class=\"s1\">'Cli'</span>\n\nNo<span class=\"w\"> </span>directory<span class=\"w\"> </span><span class=\"s1\">'Cli'</span><span class=\"w\"> </span>or<span class=\"w\"> </span>file<span class=\"w\"> </span><span class=\"s1\">'Cli.olean'</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>the<span class=\"w\"> </span>search<span class=\"w\"> </span>path<span class=\"w\"> </span>entries:\n././.lake/packages/batteries/.lake/build/lib\n././.lake/packages/Qq/.lake/build/lib\n././.lake/packages/aesop/.lake/build/lib\n././.lake/packages/proofwidgets/.lake/build/lib\n././.lake/packages/Cli/.lake/build/lib\n././.lake/packages/importGraph/.lake/build/lib\n././.lake/packages/LeanSearchClient/.lake/build/lib\n././.lake/build/lib\n/home/lean/.elan/toolchains/leanprover--lean4---v4.13.0-rc3/lib/lean\n/home/lean/.elan/toolchains/leanprover--lean4---v4.13.0-rc3/lib/lean\n</code></pre></div>",
        "id": 475297431,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728307674
    },
    {
        "content": "<p>(This could also be mixing different issues, though: I do not have a clear idea of what is failing and what is not.)</p>",
        "id": 475297595,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728307716
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> That seems like a different issue.</p>",
        "id": 475306706,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728310181
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/113488-general/topic/.60lake.20build.20--no-build.60.20at.20.60v4.2E13.2E0-rc3.60.20is.20broken.3F/near/475119800\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> Would you mind making an GitHub issue for this bug?</p>\n</blockquote>\n<p>I filed the original issue as <a href=\"https://github.com/leanprover/lean4/pull/5633\">lean4#5633</a>.</p>",
        "id": 475318895,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728313558
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> Do you have an example of where this new issue is appearing? You seemed to temporarily fixed the \"get cache\" issues (by always fetching the whole cache), so I am a bit confused as to the context of this new one.</p>",
        "id": 475320842,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728314131
    },
    {
        "content": "<p>I'm on mobile now, but I think that all CI runs for <a href=\"https://github.com/leanprover-community/mathlib4/pull/17485\">#17485</a> show this behaviour in the <code>get cache</code> step.</p>",
        "id": 475348538,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728321136
    },
    {
        "content": "<p>The <code>lake exe cache get Mathlib.Init</code> seems to work, but the subsequent <code>lake build --no-build</code> step fails and hence CI falls back to a \"pure\" <code>lake build</code>, rather than getting the rest of the cache.</p>",
        "id": 475348746,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728321232
    },
    {
        "content": "<p>I might be available in a couple of hours for further comments, but today has been a bit hectic.</p>",
        "id": 475348857,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728321269
    },
    {
        "content": "<p>I am back at a computer and with no students/teaching!</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/11210293525/job/31156931679\">This CI run</a>, for instance, shows that the <code>get cache</code> step successfully downloads  the cache for <code>Mathlib.Init</code>, decompresses 19 files and reports <code>Completed successfully</code>.</p>\n<p>However, the final part of the step is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>build<span class=\"w\"> </span>--no-build<span class=\"w\"> </span>Mathlib.Init<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get<span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"No cache for 'Mathlib.Init' available\"</span>\n</code></pre></div>\n<p>and it reports <code>No cache for 'Mathlib.Init' available</code>.</p>",
        "id": 475375667,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728329008
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> Ah, sorry, that is what I was referring to as the old issue. I presumed you fixed it for now with <a href=\"https://github.com/leanprover-community/mathlib4/pull/17490\">mathlib4#17490</a> and mathlib4!17491. I filed this issue as <a href=\"https://github.com/leanprover/lean4/pull/5633\">lean4#5633</a> and have a fix pending in <a href=\"https://github.com/leanprover/lean4/pull/5641\">lean4#5641</a>. However, a new RC with the fix will not be released until at least next week.</p>\n<p>The example I was looking for was in regards to the lean4checker issue. However, I believe I found the failing workflow with the error <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/11206411655\">here</a>.</p>",
        "id": 475416672,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728342138
    },
    {
        "content": "<p>Ok, sorry for the confusion!  I do not really understand what the issue is, so I simply \"choked\" the <code>lake build --no-build</code> step.  I am glad that this will be solved!</p>",
        "id": 475416850,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728342239
    },
    {
        "content": "<p>The workflow you found for <code>lean4checker</code> is indeed the one that has failed yesterday for the first time.  I have the impression that there is, among other issues, a missing tag for v4.13 that is confusing CI.</p>",
        "id": 475416992,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728342296
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> I bump the lean4checker repo to <code>v4.13.0-rc3</code> and added the tag, but I am not confident that will ifx the issue. But I have also yet to figure out what's causing it.</p>",
        "id": 475417215,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728342381
    },
    {
        "content": "<p>No worries: that workflow runs on a schedule, once a day in about 1-2 hours.  I guess that soon we will know if the bump and tag will help!</p>",
        "id": 475417382,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728342457
    },
    {
        "content": "<p>I have found the problem. lean4checker is checking importGraph (whose Reservoir cache Lake successfully fetched), but the Cli oleans are missing so the check fails. The Cli oleans are missing because importGraph requires Cli via a Git, rather than a Reservoir, dependency, so Lake does not have enough information to fetch its cache.  </p>\n<p>The importGraph oleans are fetched by Lake due to the bug above, so that fix will fix this. There also a number of ways to potentially solve this in the meantime:</p>\n<ol>\n<li>Ensure the oleans of packages Mathlib does not want not lean4checker to check are not present before running the checker (e.g.., <code>rm -rf .lake/packages/importGraph/.lake/lib</code>) .</li>\n<li>Inversely, ensure that all of Mathlib's dependencies are built before running the checker (e.g., <code>lake build @Cli</code>)</li>\n<li>Change <code>importGraph</code> to use a Reservoir <code>require</code> for Cli (i.e., since it is using TOML, add <code>scope = \"leanprover\"</code>).</li>\n</ol>\n<p>I would be inclined to go with (1), as it is the simplest, future-proof solution. However, if the goal is actually to check <code>importGraph</code> as well, then (2) is better. I presume it is not, as I do not believe it was built previously before running the checker.</p>",
        "id": 475421398,
        "sender_full_name": "Mac Malone",
        "timestamp": 1728344127
    },
    {
        "content": "<p>I am also happy to go with (1).  Besides, the <code>lean4checker</code> workflow has been running successfully every day since May (and was running successfully on every CI run before that).  I would be very surprised if mathlib managed to sneak through something that would break while waiting for this fix!</p>",
        "id": 475422080,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728344364
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span> as I think that he may also be a maintainer of ImportGraph.</p>",
        "id": 475422507,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728344460
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/113488-general/topic/.60lake.20build.20--no-build.60.20at.20.60v4.2E13.2E0-rc3.60.20is.20broken.3F/near/475421398\">said</a>:</p>\n<blockquote>\n<ol start=\"3\">\n<li>Change <code>importGraph</code> to use a Reservoir <code>require</code> for Cli (i.e., since it is using TOML, add <code>scope = \"leanprover\"</code>).</li>\n</ol>\n</blockquote>\n<p>I guess I should do this update anyways? I'll be on the computer in an hour and can push that shortly.</p>",
        "id": 475519938,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1728380098
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17536\">#17536</a></p>",
        "id": 475532493,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1728384414
    }
]