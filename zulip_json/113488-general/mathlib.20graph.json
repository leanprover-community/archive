[
    {
        "content": "<p>What is the best way to get the directed graph of all mathlib declarations (as nodes) and their direct dependencies (as edges)? I know this will be a massive dataset, but I think it should still be manageable? (Probably hard to visualize though.)</p>",
        "id": 468982925,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725943636
    },
    {
        "content": "<p>You want the edges to be just the \"covering relations\", right?  I've been wanting something like this as well, but at the moment I do not think that there is a single command that does this.</p>",
        "id": 468987027,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725945165
    },
    {
        "content": "<p>Yup, if <code>lemma foo</code> mentions <code>def bar</code> in its proof term, then there should be an edge <code>foo -&gt; bar</code>.</p>",
        "id": 468991238,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725947284
    },
    {
        "content": "<p>Ah, that is different from what I thought.  I often want the smallest set of edges whose transitive closure is the full graph, while you want the full graph, I believe.</p>",
        "id": 468991342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725947388
    },
    {
        "content": "<p>(For me a \"covering relation\" is an edge that cannot be replaced by a path of length at least two.)</p>",
        "id": 468991491,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725947455
    },
    {
        "content": "<p>I have an experiment computing the \"longest\" declaration and I wanted to improve it to finding \"maximal\" declarations, but a naive approach did not work.  So I think that you are right that it should be doable, but you probably need to know what you are doing!</p>",
        "id": 468991892,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725947731
    },
    {
        "content": "<p>Once I'm back at a computer, I can send you the links to the experiments that I made.</p>",
        "id": 468991936,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725947753
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>, I recently implemented this for the gray shading in <code>lake exe graph</code>.</p>\n<p>See <code>def Name.transitivelyUsedConstants (n : Name) : CoreM NameSet := do</code> in <code>import-graph</code>.</p>",
        "id": 468994609,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725949114
    },
    {
        "content": "<p>There's existing code in <code>import-graph</code> for doing transitive reduction given <code>Name -&gt; NameSet</code> function, currently used where the names are modules. But the same code should work when the names are delcarations, to giving the covering graph that <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> wants.</p>",
        "id": 468994734,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725949194
    },
    {
        "content": "<p>i.e. <code>transitiveReduction</code></p>",
        "id": 468994890,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725949262
    },
    {
        "content": "<p>Aah, right. I don't want the transitive reduction. Or maybe I also want that, at a later stage.</p>",
        "id": 468996128,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725949771
    },
    {
        "content": "<p>I was experimenting with this before. Here's the code I used to construct the <code>HashMap</code> of all mathlib constants with their proof term (or type if it doesn't have a definition, e.g. an axiom or inductive):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isBadDecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cinfo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ConstantInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">cinfo</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">thmInfo</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">opaqueInfo</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">isUnsafe</span>\n<span class=\"w\">    </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">isPartial</span>\n<span class=\"w\">    </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isInternalDetail</span>\n<span class=\"w\">    </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isAuxRecursor</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isNoConfusion</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">allDependencies</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">map₁</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isBadDecl</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">value?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">foldConsts</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isBadDecl</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">find!</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">arr</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">arr</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">map</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">consts</span>\n</code></pre></div>\n<p>In particular, the function <code>Expr.foldConsts</code> is what I used to get the constants from an expression.</p>",
        "id": 469013535,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725953887
    },
    {
        "content": "<p>This doesn't do transitive dependency?</p>",
        "id": 469017226,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725954743
    },
    {
        "content": "<p>And if constants appear multiple times they will be repeated.</p>",
        "id": 469017257,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725954754
    },
    {
        "content": "<p>Better to use the functions in <code>import-graph</code>.</p>",
        "id": 469017348,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725954785
    },
    {
        "content": "<p>I actually don't want transitive dependencies.</p>",
        "id": 469017687,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725954856
    },
    {
        "content": "<p>Btw <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> if you have some code doing what you want, I think it would be very helpful if you shared that and we can see what can be integrated in <code>import-graph</code>. That sounds like API that would be useful to have!</p>",
        "id": 469018833,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725955114
    },
    {
        "content": "<p>Atm I don't have any code (-;</p>",
        "id": 469020075,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725955403
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/113488-general/topic/mathlib.20graph/near/469017687\">said</a>:</p>\n<blockquote>\n<p>I actually don't want transitive dependencies.</p>\n</blockquote>\n<p>Ah, you said above you didn't want <em>transitive reduction</em>. We're way ahead of you. :-)</p>",
        "id": 469020556,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725955510
    },
    {
        "content": "<p>Even not wanting transitive dependencies you should still use <code>import-graph</code>, just because it uses <code>NameMap</code> and <code>NameSet</code> which will be more efficient.</p>",
        "id": 469020668,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725955536
    },
    {
        "content": "<p>Right, I want neither. I want the raw data first. Some graph theorists asked me for it, and they want to do their graph theory magic on the raw data.</p>",
        "id": 469020819,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725955566
    },
    {
        "content": "<p>Raw data means just looking at the constants that appear in the <code>Expr</code> for the declaration?</p>",
        "id": 469021191,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955668
    },
    {
        "content": "<p>Yep, deduplicating should be fine. But not transitive closures or reductions.</p>",
        "id": 469021444,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725955742
    },
    {
        "content": "<p>So, for each <code>Expr</code>, you recurse and extract all <code>Name</code>s from all the <code>.const</code>s that you see and then for each declaration you do that for the <code>value</code>, if it exists and for the <code>type</code> otherwise.  Does this sound right?</p>",
        "id": 469022004,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955901
    },
    {
        "content": "<p>I certainly remember doing this and failing to make it in any way efficient!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 469022155,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955928
    },
    {
        "content": "<p>Expr.foldConsts already does the deduplication. It is implemented by checking pointer equality, making it more efficient.</p>",
        "id": 469023439,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1725956126
    },
    {
        "content": "<p>What I think would be very useful to have is the partial order on <code>Name</code>s that works on <code>Name</code>s that are module names or declaration names.</p>",
        "id": 469025855,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725956713
    },
    {
        "content": "<p>Maybe it is there now, but I am pretty sure that it was not available a few weeks ago.</p>",
        "id": 469025956,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725956749
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> didn’t I send you such a graph a little while ago?</p>",
        "id": 469736131,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726162122
    },
    {
        "content": "<p>This code will generate a 351M file (at least with the version of mathlib I have) in less than one minute:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.FS.Handle.mk</span><span class=\"w\"> </span><span class=\"s2\">\"output\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">write</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env.constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">n.isBlackListed</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">continue</span><span class=\"w\"> </span><span class=\"c1\">-- or some other filter?</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">c.getUsedConstantsAsSet</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">d.isBlackListed</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">      </span><span class=\"n\">handle.putStrLn</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{n} {d}\"</span>\n<span class=\"w\">      </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"Found {counter} connections\"</span>\n</code></pre></div>\n<p>That file is too big to upload to zulip unfortunately.</p>",
        "id": 469738347,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726162793
    },
    {
        "content": "<p>(Note that this doesn't even do anything multithreaded, so it's very naive, but it's still reasonably fast)</p>",
        "id": 469739768,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163083
    },
    {
        "content": "<p>I don't think simply ignoring blacklisted nodes is the correct thing to do in this context, as that removes some transitive connections</p>",
        "id": 469740945,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726163242
    },
    {
        "content": "<p>ok...</p>",
        "id": 469741175,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163282
    },
    {
        "content": "<p>running it now without the filter...</p>",
        "id": 469741620,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163348
    },
    {
        "content": "<p>done. Result is now 912M, still under 2 mins</p>",
        "id": 469741868,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163391
    },
    {
        "content": "<p>If you want to run it yoruself:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.FS.Handle.mk</span><span class=\"w\"> </span><span class=\"s2\">\"output\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">write</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env.constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">--if ← n.isBlackListed then continue -- or some other filter?</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">c.getUsedConstantsAsSet</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"c1\">--if ← d.isBlackListed then continue</span>\n<span class=\"w\">      </span><span class=\"n\">handle.putStrLn</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{n} {d}\"</span>\n<span class=\"w\">      </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"Found {counter} connections\"</span>\n</code></pre></div>",
        "id": 469742186,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163430
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/stream/113488-general/topic/mathlib.20graph/near/469736131\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> didn’t I send you such a graph a little while ago?</p>\n</blockquote>\n<p>Possibly, my brain is a bit like a colender sometimes...</p>",
        "id": 469743656,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726163688
    },
    {
        "content": "<p>BTW, if you want to run this, I recommend doing the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO.FS.Handle.mk</span><span class=\"w\"> </span><span class=\"s2\">\"output\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">write</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env.constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">--if ← n.isBlackListed then continue -- or some other filter?</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">c.getUsedConstantsAsSet</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"c1\">--if ← d.isBlackListed then continue</span>\n<span class=\"w\">      </span><span class=\"n\">handle.putStrLn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Json.mkObj</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"s2\">\"src\"</span><span class=\"o\">,</span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),(</span><span class=\"s2\">\"dep\"</span><span class=\"o\">,</span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">compress</span>\n<span class=\"w\">      </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">counter</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"Found {counter} connections\"</span>\n</code></pre></div>\n<p>just because processing the lines in the file and parsing them as JSON is easier this way. This makes it quite easy to get the data into python for example.</p>",
        "id": 469744634,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726163862
    },
    {
        "content": "<p>Ok, and now I should figure out how to run a single Lean file again to pipe the output to a json file.</p>",
        "id": 469745704,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726164009
    },
    {
        "content": "<p>you can just run this in your editor. It will produce a file called \"output\" with json objects on each line.</p>",
        "id": 469745986,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726164054
    },
    {
        "content": "<p>you know what... I'll upload the output to my google drive and give you the link so you can just download it without running the file</p>",
        "id": 469746308,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726164110
    },
    {
        "content": "<p>oh, I can run it myself, but either is fine</p>",
        "id": 469746616,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726164157
    },
    {
        "content": "<p>(if anyone wants the file, feel free to DM me)</p>",
        "id": 469746959,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726164219
    },
    {
        "content": "<p>I like writing json lines like this because it's then real easy to process this with python as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n<span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"s2\">\"output\"</span><span class=\"p\">,</span><span class=\"s1\">'r'</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n    <span class=\"k\">for</span> <span class=\"n\">l</span> <span class=\"ow\">in</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n        <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">))</span>\n</code></pre></div>",
        "id": 469747822,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726164405
    },
    {
        "content": "<p>This version seems to include decls like <code>UInt32.reduceOfNat._lambda_1._cstage2</code>, it seems</p>",
        "id": 469747985,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1726164452
    },
    {
        "content": "<p>yeah, because I was told not to filter out blacklisted names :)</p>",
        "id": 469748038,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1726164470
    },
    {
        "content": "<p><a href=\"https://github.com/reaslab/jixia\">https://github.com/reaslab/jixia</a> can already do that, generating both the type dependencies and value dependencies in its \"symbol\" plugin.</p>",
        "id": 469852372,
        "sender_full_name": "Tony Beta Lambda",
        "timestamp": 1726203836
    },
    {
        "content": "<p><a href=\"https://github.com/semorrison/lean-training-data\">https://github.com/semorrison/lean-training-data</a></p>\n<p>There is a \"premises\" Lean file in this repo:</p>\n<p>premises: For each declaration imported in a target file (e.g. Mathlib), list all of its direct dependencies (i.e. constants referenced from its type or proof). Constants appearing in explicit arguments are prefixed *, and constants used by the simplifier are prefixed s.</p>",
        "id": 470061366,
        "sender_full_name": "Deming Xu",
        "timestamp": 1726268247
    }
]