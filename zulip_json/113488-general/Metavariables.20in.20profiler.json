[
    {
        "content": "<p>Is there a way of seeing the unassigned metavariables at each step in <code>trace.profiler</code>? I would like to see when each metavariable first appears and also when it is assigned.</p>",
        "id": 478377024,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729636309
    },
    {
        "content": "<p>Maybe you would have luck with <code>set_option pp.instantiateMVars false</code>?</p>",
        "id": 478377868,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729636853
    },
    {
        "content": "<p>Thanks for the suggestion -- I have now set this option but I can't actually see any change, what does it do?</p>",
        "id": 478380517,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729638539
    },
    {
        "content": "<p>I think I misunderstood what you were asking. This makes mvars pretty print as mvars without substitution of their values, which could help if there were expressions that you knew had mvars only assigned later.</p>",
        "id": 478381883,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729639425
    },
    {
        "content": "<p>I think I might be able to track the metavariables by hand if I could navigate the profiler output more easily.  Is there a way of getting the profiler output as (say) a JSON?</p>",
        "id": 478596576,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729724433
    },
    {
        "content": "<p>For example, I noticed in <a href=\"#narrow/channel/287929-mathlib4/topic/Adic.20completion.20is.20slow/near/449909888\">this message</a> that debugging involved generating the following tree:<br>\n<a href=\"https://profiler.firefox.com/public/dp8e227v3hcwan5655zcjy9eqymawghrwkq90y8/calltree/?globalTrackOrder=0&amp;thread=0&amp;timelineType=category&amp;v=10\">https://profiler.firefox.com/public/dp8e227v3hcwan5655zcjy9eqymawghrwkq90y8/calltree/?globalTrackOrder=0&amp;thread=0&amp;timelineType=category&amp;v=10</a><br>\nHow do I make one of these for myself?</p>",
        "id": 478596977,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729724678
    },
    {
        "content": "<p>Ah: Now I discovered <code>set_option trace.profiler.output \"/tmp/out.json\"</code> from <a href=\"#narrow/channel/270676-lean4/topic/Using.20the.20Firefox.20profiler.20dashboard.20for.20trace.2Eprofiler\">this thread</a>.  But this doesn't seem to export the full profiling information.  For example, a step like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.002270</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">✅️</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℂ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃ₗᵢ⋆</span><span class=\"o\">[</span><span class=\"n\">ℂ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℂ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5180</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">SL</span><span class=\"o\">[</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5189</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃ₛₗᵢ</span><span class=\"o\">[</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5508</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5503</span>\n</code></pre></div>\n<p>will be summarized to <code>Meta.isDefEq</code>.  Is there a way of getting the full information in the output?</p>",
        "id": 478602787,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729728221
    },
    {
        "content": "<p>More stream-of-consciousness: I discovered <code>set_option trace.profiler.output.pp true</code>, which provides all the output information I wanted, but now I would love to have this <em>less</em> verbose.  Is it possible to modify the pretty-printing settings for the profiler output?  (For example, is there a way to set <code>pp.universes false</code> in the profiler output?)</p>",
        "id": 478605970,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729730535
    },
    {
        "content": "<p>I believe it should work if you set all these options on the command line, that's how the export is intended to be used</p>",
        "id": 478635045,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1729747767
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Is this the right syntax?  I tried this and it didn't eliminate pretty-printing of universes.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>env<span class=\"w\"> </span>lean<span class=\"w\"> </span>-Dtrace.profiler<span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"w\"> </span>-Dtrace.profiler.output<span class=\"o\">=</span><span class=\"s2\">\"profile.json\"</span><span class=\"w\"> </span>-Dtrace.profiler.output.pp<span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"w\"> </span>-Dtrace.profiler.threshold<span class=\"o\">=</span><span class=\"m\">1</span><span class=\"w\"> </span>-Dpp.universes<span class=\"o\">=</span><span class=\"nb\">false</span><span class=\"w\"> </span>MyFile.lean\n</code></pre></div>",
        "id": 478727072,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729779094
    },
    {
        "content": "<p>I didn't know about <code>set_option trace.profiler.output \"/tmp/out.json\"</code> but when I've wanted to dump traces to a file I've just added the appropriate <code>set_option</code>s to the file and then <code>lake build &lt;path.to.file&gt; &gt; traceoutput.txt</code> on the command line. Apologies if you're well aware of this option!</p>",
        "id": 478772209,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729793019
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> That's pretty clever and I didn't think of doing that!  But it doesn't give JSON output, right?  Just an implicit tree structure based on tabs.</p>",
        "id": 478787279,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1729799092
    },
    {
        "content": "<p>Yes unfortunately it's just a text file. I don't know what JSON is, I just read it manually usually.</p>",
        "id": 478806230,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729807579
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> I think what is happening is that <code>output.pp</code> does not use the pretty printer at all but always prints the bare structure of the term, could you confirm there's no notations etc. at all? If so, could you open an issue?</p>",
        "id": 478871978,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1729846642
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> You're missing out! <a href=\"https://youtu.be/T0M5WpnuneE?si=6sABAh1pmWVqP4B0&amp;t=1400\">https://youtu.be/T0M5WpnuneE?si=6sABAh1pmWVqP4B0&amp;t=1400</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"T0M5WpnuneE\" href=\"https://youtu.be/T0M5WpnuneE?si=6sABAh1pmWVqP4B0&amp;t=1400\"><img src=\"https://uploads.zulipusercontent.net/a2f90435cac2f788886d90bf5b6f810da92fd2e9/68747470733a2f2f692e7974696d672e636f6d2f76692f54304d3557706e756e65452f64656661756c742e6a7067\"></a></div>",
        "id": 478873236,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1729847010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/113488-general/topic/Metavariables.20in.20profiler/near/478871978\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> I think what is happening is that <code>output.pp</code> does not use the pretty printer at all but always prints the bare structure of the term, could you confirm there's no notations etc. at all? If so, could you open an issue?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Here is a typical line of the profile.json output on the following test input:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"ℤ\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">add_pos_of_nonneg_of_pos</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_one</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>\"Elab.step: Lean.Parser.Term.app: expected type: LT.lt.{0} Int Int.instLTInt (OfNat.ofNat.{0} Int 0 (instOfNat 0)) (HAdd.hAdd.{0, 0, 0} Int Int Int (instHAdd.{0} Int Int.instAdd) _uniq.1362 (OfNat.ofNat.{0} Int 1 (instOfNat 1))), term\\n(Term.app `Int.add_pos_of_nonneg_of_pos [`h `Int.zero_lt_one])\"\n</code></pre></div>\n<p>(So it is certainly not using the default pp options.). This is unchanged if I explicitly set certain pp options (which I think are default):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>env<span class=\"w\"> </span>lean<span class=\"w\"> </span>-Dtrace.profiler<span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"w\"> </span>-Dtrace.profiler.output<span class=\"o\">=</span><span class=\"s2\">\"profile.json\"</span><span class=\"w\"> </span>-Dtrace.profiler.output.pp<span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"w\"> </span>-Dtrace.profiler.threshold<span class=\"o\">=</span><span class=\"m\">0</span><span class=\"w\">  </span>-Dpp.notation<span class=\"o\">=</span><span class=\"nb\">true</span><span class=\"w\"> </span>-Dpp.universes<span class=\"o\">=</span><span class=\"nb\">false</span><span class=\"w\"> </span>FileName.lean\n</code></pre></div>\n<p>Does this confirm what you suspected?  If so I'll open the issue.</p>",
        "id": 479278286,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730122818
    },
    {
        "content": "<p>It does, thanks!</p>",
        "id": 479309302,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730131304
    },
    {
        "content": "<p>OK, filed at <a href=\"https://github.com/leanprover/lean4/pull/5872\">lean4#5872</a>.</p>",
        "id": 479341146,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730141740
    }
]