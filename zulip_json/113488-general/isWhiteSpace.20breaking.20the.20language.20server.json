[
    {
        "content": "<p>This is my first attempt to implement the Haskell <code>words</code> in Lean. I would like to avoid the <code>partial</code>, but it was not clear if I could prove termination. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">dropWhile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">)</span>\n<span class=\"w\">   </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">asString</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n</code></pre></div>\n<p>It works as expected</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"s2\">\" hello world  \"</span><span class=\"w\">  </span><span class=\"c1\">-- [\"hello\", \"world\"]</span>\n</code></pre></div>\n<p>but the correct implementation should split the string at any whitespace character, not only a single space. But when I replace <code>(· ≠ ' ')</code> with <code>(fun x =&gt; ¬ x.isWhitespace)</code> the Lean Language Server <strong>crashes</strong>!</p>\n<p>Any idea?</p>",
        "id": 452451739,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721342744
    },
    {
        "content": "<p>What version of Lean are you on?</p>",
        "id": 452452395,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721343194
    },
    {
        "content": "<p>Here (on 4.10.0-rc2) that replacement works fine</p>",
        "id": 452452409,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721343205
    },
    {
        "content": "<p>Seems to work in the playground too: <a href=\"https://live.lean-lang.org/#code=partial%20def%20words%20(s%20%3A%20String)%20%3A%20List%20String%20%3A%3D%0A%20let%20rec%20aux%20(s%20%3A%20List%20Char)%20%3A%20List%20(List%20Char)%20%3A%3D%0A%20%20%20let%20rs%20%3A%3D%20s.dropWhile%20(fun%20x%20%3D%3E%20x.isWhitespace)%0A%20%20%20if%20rs%20%3D%3D%20%5B%5D%0A%20%20%20then%20%5B%5D%0A%20%20%20else%20let%20(p%2C%20r)%20%3A%3D%20rs.span%20(fun%20x%20%3D%3E%20%C2%AC%20x.isWhitespace)%0A%20%20%20%20%20%20%20%20p%20%3A%3A%20(aux%20r)%0A%20List.map%20List.asString%20%24%20aux%20s.toList%0A%0A%23check%20words\">https://live.lean-lang.org/#code=partial%20def%20words%20(s%20%3A%20String)%20%3A%20List%20String%20%3A%3D%0A%20let%20rec%20aux%20(s%20%3A%20List%20Char)%20%3A%20List%20(List%20Char)%20%3A%3D%0A%20%20%20let%20rs%20%3A%3D%20s.dropWhile%20(fun%20x%20%3D%3E%20x.isWhitespace)%0A%20%20%20if%20rs%20%3D%3D%20%5B%5D%0A%20%20%20then%20%5B%5D%0A%20%20%20else%20let%20(p%2C%20r)%20%3A%3D%20rs.span%20(fun%20x%20%3D%3E%20%C2%AC%20x.isWhitespace)%0A%20%20%20%20%20%20%20%20p%20%3A%3A%20(aux%20r)%0A%20List.map%20List.asString%20%24%20aux%20s.toList%0A%0A%23check%20words</a></p>",
        "id": 452452519,
        "sender_full_name": "Julian Berman",
        "timestamp": 1721343273
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span>\n<span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.9</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"bp\">-</span><span class=\"n\">apple</span><span class=\"bp\">-</span><span class=\"n\">darwin23</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"n\">f9843a4a5fe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Release</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 452452605,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721343335
    },
    {
        "content": "<p>How can I change to 4.9.0 in the <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a> to confirm the error in version 4.9.0?  What is the easier way to upgrade to Lean 4.10.0-rc2? Do I need to manually edit the lean-toolchain?</p>",
        "id": 452453455,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721343825
    },
    {
        "content": "<p>Same error after updating to Lean 4.10.0-rc2</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">uname</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span>\n<span class=\"n\">Darwin</span><span class=\"w\"> </span><span class=\"n\">tranco</span><span class=\"bp\">.</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"mf\">23.5</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"n\">Darwin</span><span class=\"w\"> </span><span class=\"n\">Kernel</span><span class=\"w\"> </span><span class=\"n\">Version</span><span class=\"w\"> </span><span class=\"mf\">23.5</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Wed</span><span class=\"w\"> </span><span class=\"n\">May</span><span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">:</span><span class=\"mi\">12</span><span class=\"o\">:</span><span class=\"mi\">58</span><span class=\"w\"> </span><span class=\"n\">PDT</span><span class=\"w\"> </span><span class=\"mi\">2024</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"o\">:</span><span class=\"n\">xnu</span><span class=\"bp\">-</span><span class=\"mf\">10063.121</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"bp\">~</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"n\">RELEASE_ARM64_T6000</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span>\n<span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"bp\">-</span><span class=\"n\">apple</span><span class=\"bp\">-</span><span class=\"n\">darwin23</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">702</span><span class=\"n\">c31b80712</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Release</span><span class=\"o\">)</span>\n\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span>\n\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"k\">show</span>\n<span class=\"n\">installed</span><span class=\"w\"> </span><span class=\"n\">toolchains</span>\n<span class=\"c1\">--------------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">nightly</span><span class=\"bp\">-</span><span class=\"mi\">2023</span><span class=\"bp\">-</span><span class=\"mi\">12</span><span class=\"bp\">-</span><span class=\"mi\">31</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">stable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span>\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n\n<span class=\"n\">active</span><span class=\"w\"> </span><span class=\"n\">toolchain</span>\n<span class=\"c1\">----------------</span>\n\n<span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"o\">:</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">overridden</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">ar</span><span class=\"bp\">/</span><span class=\"n\">r</span><span class=\"bp\">/</span><span class=\"n\">emap</span><span class=\"bp\">-</span><span class=\"mi\">20242</span><span class=\"bp\">-</span><span class=\"n\">nlp</span><span class=\"bp\">/</span><span class=\"n\">cs</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain'</span><span class=\"o\">)</span>\n<span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">4.10</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"bp\">-</span><span class=\"n\">apple</span><span class=\"bp\">-</span><span class=\"n\">darwin23</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">702</span><span class=\"n\">c31b80712</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Release</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 452453729,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721344004
    },
    {
        "content": "<p>I am curious! Maybe the <code>partial</code> is causing the crash because it is not protecting some mysterious behavior?  The code below works. Note that the only change was to replace <code>s.dropWhile (· = ' ')</code> with <code>s.dropWhile (fun x =&gt; x.isWhitespace)</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">dropWhile</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">   </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">r</span>\n<span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">asString</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n</code></pre></div>\n<p>I am still uncomfortable with the <code>partial</code>! Any advice on how to prove the termination would be welcome!</p>",
        "id": 452462322,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721348407
    },
    {
        "content": "<p>I'm not at a computer, but an alternative approach to what you are doing is to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.splitOn#doc\">docs#String.splitOn</a> first and then filter out empty lists from the output.</p>",
        "id": 452470719,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721354784
    },
    {
        "content": "<p>Btw, I think that String.dropWhile takes a function to <code>Bool</code> as an argument, so I would probably use <code>(\\. == ' ')</code> instead of the Prop-valued <code>=</code>.</p>",
        "id": 452470916,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721354968
    },
    {
        "content": "<p>The last version does not use <code>( \\. = ' ')</code> but  <code>Stgring.isWhitespace</code>! But I got your point, thank you! </p>\n<p>I used the <code>String.split</code> method, so I can still split by all whitespace characters and not only spaces. Thank you for pointing this out to me. Indeed, the code is much simpler and more efficient.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Nevertheless, the crash of the server is still unexpected!</p>",
        "id": 452471882,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721355643
    },
    {
        "content": "<p>I also can't reproduce the crash with the steps you described. </p>\n<p>Note that not all crashes are necessarily the fault of the language server. If you are running faulty code in the language server (e.g. something that causes a stack overflow), then the process for that file that the faulty code is run in will crash. <br>\nIt will show you an error of the form \"The Lean Server has stopped processing this file.\" and the next edit you make to the file will automatically attempt to restart the process for that file. If one of your edits fixes the problem, it restarts just fine.</p>\n<p>By the way, your code is also causing a stack overflow as soon as you use a non-space whitespace character, which is probably the issue you are seeing here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">dropWhile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">)</span>\n<span class=\"w\">   </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">asString</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">libc++abi: terminating due to uncaught exception of type lean::throwable: deep recursion was detected at 'interpreter' (potential solution: increase stack space in your system)</span>\n<span class=\"cm\">interpreter stacktrace:</span>\n<span class=\"cm\">#1 words.aux._lambda_1</span>\n<span class=\"cm\">#2 words.aux._lambda_1._boxed</span>\n<span class=\"cm\">#3 List.dropWhile._rarg</span>\n<span class=\"cm\">#4 words.aux</span>\n<span class=\"cm\">...</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">words</span><span class=\"w\"> </span><span class=\"s2\">\"Hello World</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n</code></pre></div>",
        "id": 452507952,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1721374558
    },
    {
        "content": "<p>Yes, later yesterday, I found the bug that was probably producing a stack overflow. As you said, the presence of a whitespace character that is not space would make the code loop forever.  But I didn't get this error above. Could you let me know where you saw this error?  My screen is below. I didn't see <code>libc++abi: terminating due to...</code></p>\n<p><a href=\"/user_uploads/3121/hKnZuxEne6rL_iiJmWvoMVP_/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/hKnZuxEne6rL_iiJmWvoMVP_/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/hKnZuxEne6rL_iiJmWvoMVP_/image.png\"></a></div><p>The code has a bug, and I fixed it. <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>'s idea is actually much simpler anyway.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">   </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">dropWhile</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">   </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">   </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">r</span>\n<span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">asString</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">words₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The remaining questions for me are:</p>\n<ol>\n<li>Is the crash normal -- in a sense of unavoidable if a function does not terminate -- or would it be avoided if the function was not declared <code>partial</code>? Well, the crash was caused by a non-termination, right? So, proof of termination would probably reveal the bug, right?</li>\n<li>How to prove termination?! This is an interesting case. If I remove the <code>partial</code>, Lean will report the message below. Lean could not detect that the first argument <code>s</code> changes in the recursive call. This makes sense. If <code>s.dropWhile f</code> does not change <code>s</code> and <code>s.span (not ∘ f)</code> can't split the string, an infinite loop will happen. Somehow, I need to show Lean that <code>∀ c ∈ S, f c ∨ ¬ f c</code>. The principle of excluded middle! </li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">termination</span><span class=\"w\"> </span><span class=\"n\">for</span>\n<span class=\"w\">  </span><span class=\"n\">words₁</span><span class=\"bp\">.</span><span class=\"n\">aux</span>\n<span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">errors</span>\n<span class=\"n\">structural</span><span class=\"w\"> </span><span class=\"n\">recursion</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"o\">:</span>\n\n<span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">structural</span><span class=\"w\"> </span><span class=\"n\">recursion</span>\n<span class=\"w\">  </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">unchanged</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">recursive</span><span class=\"w\"> </span><span class=\"n\">calls</span>\n\n<span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">structural</span><span class=\"w\"> </span><span class=\"n\">recursion</span>\n<span class=\"w\">  </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">eliminate</span><span class=\"w\"> </span><span class=\"n\">recursive</span><span class=\"w\"> </span><span class=\"n\">application</span>\n<span class=\"w\">    </span><span class=\"n\">words₁</span><span class=\"bp\">.</span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">r</span>\n</code></pre></div>",
        "id": 452567741,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721394899
    },
    {
        "content": "<p>You can find more detailed output in the troubleshooting output (forall menu in the top right &gt; Troubleshooting: Show Output)</p>",
        "id": 452568089,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1721395025
    },
    {
        "content": "<p>Specifically, when the error occurs, you get two notifications:<br>\n<a href=\"/user_uploads/3121/_6H--9ckTfm0c8jVcX9e9y-U/image.png\">image.png</a><br>\nThe button in the bottom one takes you to the troubleshooting output as well.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/_6H--9ckTfm0c8jVcX9e9y-U/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/_6H--9ckTfm0c8jVcX9e9y-U/image.png\"></a></div><p>VS Code can sometimes decide to hide these notifications if they have not been acted upon for too long or if there are too many notifications, but you can always display all notifications by clicking the notification bell in the bottom right.<br>\n<a href=\"/user_uploads/3121/_Ol9PlvXHe5DlSljdUeo7Jmq/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/_Ol9PlvXHe5DlSljdUeo7Jmq/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/_Ol9PlvXHe5DlSljdUeo7Jmq/image.png\"></a></div>",
        "id": 452568653,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1721395227
    },
    {
        "content": "<p>I found the menu and the notification icon on the top bottom right! Thank you.</p>",
        "id": 452568978,
        "sender_full_name": "Alexandre Rademaker",
        "timestamp": 1721395343
    }
]