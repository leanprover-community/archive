[
    {
        "content": "<p>The last hour of the train journey from mainland Europe back to London is famous for its poor WiFi. From the moment you enter the Channel Tunnel (the undersea part of the journey) until arrival in central London you spend most of your time either in very long tunnels or in parts of the UK which have poor mobile reception. Basically you're offline for an hour.</p>\n<p>I just did this journey. I was working on a project which depended on mathlib and I was working on two branches of this project which depended on two different versions of mathlib because there had been a very recent mathlib bump. I had all of the websites open which I needed and I had mathlib cache for both branches -- I was prepared. Five minutes into the hour of no connectivity I had finished working on <code>main</code> and wanted to switch to the second branch <code>kenny-lemma-80-statement</code> to review a PR. All the mathlib oleans were present on my computer, and I was happy to build the project files on my local machine. But my plan was foiled:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR ClassFieldTheory % # pre-tunnel preparations\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % git checkout kenny-lemma-80-statement\nSwitched to branch 'kenny-lemma-80-statement'\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % lake exe cache get\ninfo: mathlib: checking out revision '0a052585de2cfc95e94c373033fe24df36ca7c0e'\ninfo: aesop: checking out revision '1da2f2d2945f8740802cc38c48d2ce6723ef6154'\ninfo: batteries: checking out revision '5da171049c81931a2110303c9d547f5ab2955b06'\nCurrent branch: HEAD\nUsing cache (Azure) from origin: leanprover-community/mathlib4\nNo files to download\nDecompressing 7442 file(s)\nUnpacked in 5126 ms\nCompleted successfully!\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % git checkout main\nSwitched to branch 'main'\nYour branch is up to date with 'origin/main'.\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % lake exe cache get\ninfo: mathlib: checking out revision 'e551247794a13557744c7c61cf10625fb940db09'\ninfo: aesop: checking out revision 'ca519018e8bdc34d7bb4ecf0c8d39634a8c15300'\ninfo: batteries: checking out revision 'dd3edb3aa6b4de87f96f2c3998881ef95ba24ed7'\nCurrent branch: HEAD\nUsing cache (Azure) from origin: leanprover-community/mathlib4\nNo files to download\nDecompressing 7456 file(s)\nUnpacked in 5034 ms\nCompleted successfully!\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % # enter Channel tunnel\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % # finish working on `main`\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % git checkout kenny-lemma-80-statement\nSwitched to branch 'kenny-lemma-80-statement'\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % lake exe cache get\nerror: external command 'git' exited with code 128\nbuzzard@IC-HWDXTW69VR ClassFieldTheory % # gaargh\nbuzzard@IC-HWDXTW69VR ClassFieldTheory %\n</code></pre></div>\n<p>I am 99.9% sure that my computer, even without internet access, is in theory capable of doing exactly what I want to do at this point, which is to just look at which version of mathlib (and whatever else) I want using the project's <code>lake-manifest.json</code>, check out those branches (which certainly exist locally), and then get oleans from local cache (which also definitely exist). But in practice I had no idea how to do this so I lost an hour of work (although I did compose this message so all was not lost; hello from under the sea, by the way). Is there some hack whereby I can get around this? This has also happened to me on other occasions but today it was particularly annoying because I lost an hour.</p>",
        "id": 553939931,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762368921
    },
    {
        "content": "<p>What about <code>lake exe unpack</code>? Does that do anything?</p>",
        "id": 553946328,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762371157
    },
    {
        "content": "<p>My experience with this is that <code>lake</code> itself wants internet access somehow. So while <code>lake exe cache unpack</code> does not download cache, it might still fail without internet.</p>",
        "id": 553947126,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1762371411
    },
    {
        "content": "<p>I can simulate my undersea adventures on my laptop by switching WiFi off:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">buzzard</span><span class=\"bp\">@</span><span class=\"n\">IC</span><span class=\"bp\">-</span><span class=\"n\">HWDXTW69VR</span><span class=\"w\"> </span><span class=\"n\">ClassFieldTheory</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">unpack</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">git'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n<span class=\"n\">buzzard</span><span class=\"bp\">@</span><span class=\"n\">IC</span><span class=\"bp\">-</span><span class=\"n\">HWDXTW69VR</span><span class=\"w\"> </span><span class=\"n\">ClassFieldTheory</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">unpack</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">git'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">128</span>\n<span class=\"n\">buzzard</span><span class=\"bp\">@</span><span class=\"n\">IC</span><span class=\"bp\">-</span><span class=\"n\">HWDXTW69VR</span><span class=\"w\"> </span><span class=\"n\">ClassFieldTheory</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n</code></pre></div>",
        "id": 553947463,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762371527
    },
    {
        "content": "<p>I guess this is a side effect of writing all our tooling in lean</p>",
        "id": 553947537,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762371558
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20cache.20get.20failure.20with.20no.20internet/near/553947537\">said</a>:</p>\n<blockquote>\n<p>I guess this is a side effect of writing all our tooling in lean</p>\n</blockquote>\n<p>That shouldn't be an issue. Lake (or any other build tool) relies on internet connectivity whenever a project has non-local dependencies. The same would happen with Python+Pip, Rust+Cargo, Node+Npm etc.</p>\n<p>Now, Lake trying to access the internet for an operation that doesn't need it is strange. <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> do you know if that issue happens before or after the <code>Cache</code> binary is built?</p>",
        "id": 553948472,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1762371896
    },
    {
        "content": "<p>Definitely before, from the logs</p>",
        "id": 553950239,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762372510
    },
    {
        "content": "<p>And I mean that you generally wouldn't need to rebuild a rust tool when switching between branches that have a different version of mathlib</p>",
        "id": 553950515,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762372609
    },
    {
        "content": "<p>Even when the version of mathlib changes, <code>Cache</code> should not be rebuilt because it doesn't have mathlib as a dependency. What I'm hinting at is that diversifying the language is a tangential workaround. The ideal solution would allow per-subpackage dependencies, like Cargo accepts subcrates with self-contained <code>Cargo.toml</code> files.</p>",
        "id": 553951459,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1762372893
    },
    {
        "content": "<p>In other words, I would advocate in favor of a \"more expressive Lake\" solution rather than a \"less Lean\" solution</p>",
        "id": 553952219,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1762373135
    },
    {
        "content": "<p>Oh, I'm not advocating for anything</p>",
        "id": 553953192,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762373401
    },
    {
        "content": "<p>Is someone who understands what's going on (so, not me!) able to turn this advocating into something which could be raised on <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a> ? I didn't post there because I thought my question might be too mathlib-specific but of course I had no idea about what was actually going on.</p>",
        "id": 553960143,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762375950
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> is this something that's already in your mind/roadmap?</p>",
        "id": 553968772,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1762379261
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"451983\">@Arthur Paulino</span> I am not 100% sure what went wrong here.  I think the prpblem is this:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20cache.20get.20failure.20with.20no.20internet/near/553939931\">said</a>:</p>\n<blockquote>\n<p>check out those branches (which certainly exist locally)</p>\n</blockquote>\n<p>This is not a safe assumption. Lake does not really make any guarantees on what tags or branches are availble offline in its checkout. That is, it does not promise to maintain previously checkout references (and there are performance reasons why this can be undesirable).  As currenlty implemented, the branch probably does exist, but lake always performs a fetch before attempting a checkout, so it unfortunately does not matter. I am hesistent to fix this and make this a supported feature for the aformentioned reasons.</p>",
        "id": 553970174,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762379904
    },
    {
        "content": "<p>Independently, one thing what would definitely be good to improve here is Lake's error messages.</p>",
        "id": 553970268,
        "sender_full_name": "Mac Malone",
        "timestamp": 1762379949
    },
    {
        "content": "<p>Even if there's no guarantees, if I'm offline, I'd like lake to make a best effort at doing its job. If it fails, it fails, but it seems silly to me to block me if there's no need to</p>",
        "id": 554021530,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762415044
    },
    {
        "content": "<p>What I'm proposing is along the lines of there should be no checkout because <code>Cache</code> doesn't have dependencies. Right now Lake assumes it does because mathlib does.</p>",
        "id": 554054896,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1762425559
    },
    {
        "content": "<p>Yes let me be clear, I am not suggesting that lake has to be changed, I am asking what the hack is which will enable me to change branches on the london subway and get cache.</p>",
        "id": 554138054,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762446953
    },
    {
        "content": "<p>Kevin when you do this do you know before your train hits the tunnel that you have these N branches and you want to be able to look at all N of them and move back and forth? I.e. you know ahead of time which branches you want to look at?</p>",
        "id": 554139120,
        "sender_full_name": "Julian Berman",
        "timestamp": 1762447236
    },
    {
        "content": "<p>If so maybe your hack is \"use git work trees when this happens, and have N work trees you set up and run <code>lake exe cache get</code> in in each one before you dive underwater\"</p>",
        "id": 554139305,
        "sender_full_name": "Julian Berman",
        "timestamp": 1762447284
    },
    {
        "content": "<p>I guess in this particular case I did know, and I also knew that I had got this timeout error before with no internet on my mac, but I incorrectly conjectured that my recent experience with Microsoft Defender might have fixed this problem too.</p>",
        "id": 554140770,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762447682
    },
    {
        "content": "<p>Is that helpful to try then? Maybe you want to try <code>git worktree add kenny-lemma-80-statement</code> and <code>lake exe cache get</code> in that directory ahead of time, and do that for each branch you want locally available offline, and then rather than switching branches now you just end up with one folder per branch</p>",
        "id": 554148646,
        "sender_full_name": "Julian Berman",
        "timestamp": 1762449769
    },
    {
        "content": "<p>(Undoubtedly this is doable from within VSCode as well if you prefer that.)</p>",
        "id": 554148736,
        "sender_full_name": "Julian Berman",
        "timestamp": 1762449798
    },
    {
        "content": "<p>Just ran into this, <code>lake exe cache get</code> didn't with offline, <code>lake build</code> doesn't work either so I don't think it's specifically a cache problem</p>",
        "id": 554483942,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762609567
    },
    {
        "content": "<p>Kevin, if you just want a hack, and because your shiny new computer has plenty of space, just have multiple copies of Mathlib (like, literally multiple folders) with each checked out to the appropriate branch and having the correct cache already unpacked.</p>\n<p>This is a stupid hack, but it will prevent you from losing an hour next time.</p>",
        "id": 554484740,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762610429
    },
    {
        "content": "<p>(That's the same hack as worktrees, the only advantage of the latter is they do \"copy + checkout branch\" in one step, and also they track all the copies you have made via <code>git worktree list</code>)</p>",
        "id": 554485344,
        "sender_full_name": "Julian Berman",
        "timestamp": 1762610981
    }
]