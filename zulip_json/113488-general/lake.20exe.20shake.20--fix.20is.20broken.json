[
    {
        "content": "<p>It doesn't really work still. <code>lake exe shake --fix</code> in Toric returns a list of suggestions, but doesn't apply the import deletions. Funnily enough, it <em>does</em> apply the import additions!</p>",
        "id": 517188334,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1746824929
    },
    {
        "content": "<p>I can confirm -- I just ran into this in FLT and whilst additions worked fine, I had to remove imports from 12 files manually after the fallout of some mathlib file splitting. Which repo should I open an issue against?</p>",
        "id": 517258762,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746883829
    },
    {
        "content": "<p>shake is currently in mathlib</p>",
        "id": 517260528,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1746885355
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24743\">#24743</a></p>",
        "id": 517261227,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746885930
    },
    {
        "content": "<p>I have an impression that <code>lake exe shake --fix</code> doesn't remove any <code>import</code>s. It adds imports it shows in the log but doesn't remove them.</p>",
        "id": 517332803,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746946530
    },
    {
        "content": "<p>See <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Running.20lake.20exe.20shake.20in.20projects.20depending.20on.20mathlib/with/425709454\">#general &gt; Running lake exe shake in projects depending on mathlib</a></p>",
        "id": 517332866,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1746946565
    },
    {
        "content": "<p>I see the same in Mathlib.</p>",
        "id": 517332899,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746946610
    },
    {
        "content": "<p>Marking this one as resolved so that we discuss this in 1 thread.</p>",
        "id": 517332928,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746946641
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> has marked this topic as resolved.</p>",
        "id": 517332932,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746946645
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> has marked this topic as unresolved.</p>",
        "id": 517333022,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746946708
    },
    {
        "content": "<p>To other readers: the few messages above mean that I resolved this thread, then Yael unresolved it and moved relevant messages from the other thread here.</p>",
        "id": 517333142,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746946828
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/24743\">#24743</a></p>",
        "id": 517342037,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746954599
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, unfortunately after your fix <code>shake</code> is now <em>too</em> aggressive, and removes more imports than desired.</p>",
        "id": 518253348,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747301850
    },
    {
        "content": "<p>I didn't change the behavior of shake, it is as aggressive as it has always been</p>",
        "id": 518295337,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747313856
    },
    {
        "content": "<p>Do you mean that it is not correctly identifying imports that it claims to want to remove?</p>",
        "id": 518295671,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747313927
    },
    {
        "content": "<p>The issue was that the syntax of <code>import</code> changed due to Sebastian's work on the module system, and I think it has changed twice in quick succession (<code>import private</code> became <code>private import</code>), so you may have run into some intermediate state</p>",
        "id": 518295925,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747313989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20shake.20--fix.20is.20broken/near/518295925\">said</a>:</p>\n<blockquote>\n<p><code>import private</code> became <code>private import</code></p>\n</blockquote>\n<p><code>import private</code> became <code>import all</code>; <code>private import</code> is a separate feature.</p>",
        "id": 518340588,
        "sender_full_name": "Mac Malone",
        "timestamp": 1747323856
    },
    {
        "content": "<p>well either way the grammar changed twice</p>",
        "id": 518340724,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747323890
    },
    {
        "content": "<p>It looked to me that when it found an import to delete, it was deleting <em>more</em> than just that import. (Perhaps all following imports? I didn't look closely.)</p>",
        "id": 518452746,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747372348
    },
    {
        "content": "<p>Do you remember where this happened?</p>",
        "id": 518453957,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747373045
    },
    {
        "content": "<p>It was on nightly-testing, see 3f35133e04a0206d158ecb9642003b6b94b23720</p>",
        "id": 518492849,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747386631
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>shake<span class=\"w\"> </span>--fix\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"n\">changes</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">made</span><span class=\"w\"> </span><span class=\"n\">automatically</span><span class=\"o\">:</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Part</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Notation</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"o\">]</span>\n<span class=\"n\">Successfully</span><span class=\"w\"> </span><span class=\"n\">applied</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">suggestions</span><span class=\"bp\">.</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>git<span class=\"w\"> </span>diff\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git Mathlib/Data/Part.lean Mathlib/Data/Part.lean</span>\n<span class=\"gh\">index 3d156636ef5..5273adad838 100644</span>\n<span class=\"gd\">--- Mathlib/Data/Part.lean</span>\n<span class=\"gi\">+++ Mathlib/Data/Part.lean</span>\n<span class=\"gu\">@@ -4,8 +4,6 @@ Released under Apache 2.0 license as described in the file LICENSE.</span>\n<span class=\"w\"> </span>Authors: Mario Carneiro, Jeremy Avigad, Simon Hudon\n<span class=\"w\"> </span>-/\n<span class=\"w\"> </span>import Mathlib.Algebra.Notation.Defs\n<span class=\"gd\">-import Mathlib.Data.Set.Subsingleton</span>\n<span class=\"gd\">-import Mathlib.Logic.Equiv.Defs</span>\n\n<span class=\"w\"> </span>/-!\n<span class=\"w\"> </span># Partial values of a type\n</code></pre></div>",
        "id": 518511503,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747392293
    },
    {
        "content": "<p>That certainly doesn't look right</p>",
        "id": 518511834,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747392372
    },
    {
        "content": "<p>Yes, \"1 suggestions\" should clearly be \"1 suggestion\" ;-)</p>",
        "id": 518517246,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747394034
    },
    {
        "content": "<p>Just to be clear, my clever-clever comment above isn't supposed to detract from the fact that <code>lake exe shake --fix</code> is now the most broken it has ever been, it now deletes random imports instead of the right ones</p>",
        "id": 519436897,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747761022
    },
    {
        "content": "<p>May I bump this issue on top of <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>'s radar? <code>lake exe shake --fix</code> currently misapplies the suggestions: When trying to delete import B in the following, it instead deletes imports C and D</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">D</span>\n</code></pre></div>",
        "id": 519436988,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747761051
    },
    {
        "content": "<p>This makes it basically unusable <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 519437040,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747761068
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20shake.20--fix.20is.20broken/near/518340724\">said</a>:</p>\n<blockquote>\n<p>well either way the grammar changed twice</p>\n</blockquote>\n<p>As I suspected, the issue is that the syntax changed yet again (3rd time's the charm?). To emphasize, this is not the same bug as <a href=\"https://github.com/leanprover-community/mathlib4/pull/24743\">#24743</a>, it was fixed and then it was broken again in that time window</p>",
        "id": 519447708,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747764816
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25054\">#25054</a></p>",
        "id": 519448257,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747765008
    },
    {
        "content": "<p>What are the new syntax features for <code>import</code>?</p>",
        "id": 519457887,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747768508
    },
    {
        "content": "<p>it now has both <code>private</code> and <code>all</code></p>",
        "id": 519458003,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768558
    },
    {
        "content": "<p><code>private import all Foo</code> is syntactically correct</p>",
        "id": 519458094,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768579
    },
    {
        "content": "<p>don't ask me what it does</p>",
        "id": 519458105,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768585
    },
    {
        "content": "<p>I added a self-test so the next time sebastian has a bright idea I won't get a call at 3am</p>",
        "id": 519458231,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768639
    },
    {
        "content": "<p>...figuratively speaking <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 519458296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768666
    },
    {
        "content": "<p>I would guess <code>private</code> means \"downstream files don't see this\" and all overrides that in imported files</p>",
        "id": 519458311,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747768672
    },
    {
        "content": "<p>no, <code>private import</code> is more like <code>open private</code> from batteries, it means you get to see internal details from a <code>module</code></p>",
        "id": 519458418,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768705
    },
    {
        "content": "<p>IIRC</p>",
        "id": 519458448,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747768718
    },
    {
        "content": "<p>This just went from bors r+ to merged in 7 minutes. This is surprisingly fast?</p>",
        "id": 519462035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747770108
    },
    {
        "content": "<p>CI is fast on changes that don't require recompiling mathlib <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 519463943,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1747770885
    },
    {
        "content": "<p>I thought linting put a lower bound on simple changes</p>",
        "id": 519464017,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747770916
    },
    {
        "content": "<p>has it really become so fast that it can be done in 2.5 minutes or are the expensive things like simp confluence not running anymore?</p>",
        "id": 519464102,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747770961
    },
    {
        "content": "<p>well you didn't mark anything <code>@[simp]</code></p>",
        "id": 519466341,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747771812
    },
    {
        "content": "<p>We don't cache lint checks</p>",
        "id": 519466467,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747771868
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20shake.20--fix.20is.20broken/near/519458311\">said</a>:</p>\n<blockquote>\n<p>I would guess <code>private</code> means \"downstream files don't see this\" and all overrides that in imported files</p>\n</blockquote>\n<p>You are right. From the source (<code>isExported = !private</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Import</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">module</span><span class=\"w\">        </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- `import all`; whether to import and expose all data saved by the module. -/</span>\n<span class=\"w\">  </span><span class=\"n\">importAll</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Whether to activate this import when the current module itself is imported. -/</span>\n<span class=\"w\">  </span><span class=\"n\">isExported</span><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ToJson</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">FromJson</span>\n</code></pre></div>",
        "id": 519467856,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747772457
    },
    {
        "content": "<p>maybe the idea for this is \"you only need the tactics when compiling the file, not after\"?</p>",
        "id": 519470332,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1747773525
    },
    {
        "content": "<p>I think it is also meant to include actual definitions and theorems used in setting up an API that isn't meant to be unfolded</p>",
        "id": 519485021,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747780533
    },
    {
        "content": "<p>the key goal is to claw back the idea that lean imports are transitive</p>",
        "id": 519485056,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747780560
    },
    {
        "content": "<p>hopefully eventually this may mean that you will not need to even load most of the thousands of files in the dependency tree because most of them are only used as dependencies of dependencies and nothing about them is visible to you</p>",
        "id": 519485189,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747780634
    },
    {
        "content": "<p>We should discuss whether we want to use this feature in mathlib, but not in this thread.</p>",
        "id": 519485770,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747781032
    },
    {
        "content": "<p>well, much like <code>grind</code>, it's waiting for the FRO to actually officially announce it and open up at least a call for testing</p>",
        "id": 519524754,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747805143
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20shake.20--fix.20is.20broken/near/519447708\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/lake.20exe.20shake.20--fix.20is.20broken/near/518340724\">said</a>:</p>\n<blockquote>\n<p>well either way the grammar changed twice</p>\n</blockquote>\n<p>As I suspected, the issue is that the syntax changed yet again (3rd time's the charm?). To emphasize, this is not the same bug as <a href=\"https://github.com/leanprover-community/mathlib4/pull/24743\">#24743</a>, it was fixed and then it was broken again in that time window</p>\n</blockquote>\n<p>Third time was apparently not the charm: <a href=\"https://github.com/leanprover/lean4/pull/8598\">lean4#8598</a> will break shake again once it percolates through the system. At least this time shake will break at compile time so <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> will have to ping me about it</p>",
        "id": 522448169,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749069881
    },
    {
        "content": "<p>If it's any consolation, <code>lean --deps-json</code> also can't quite parse its imports correctly: <a href=\"https://github.com/leanprover/lean4/pull/9111\">lean4#9111</a></p>",
        "id": 526464160,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751308863
    }
]